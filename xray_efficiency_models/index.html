<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>X-ray models - Mass2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "X-ray models";
        var mkdocs_page_input_path = "xray_efficiency_models.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Mass2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../docstrings/">Docstrings</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../filtering/">Optimal filtering</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fluorescence/">Fluorescence lines</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../line_fitting/">Line fitting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../hci_lines_from_asd/">HCI lines</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">X-ray models</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#motivation">Motivation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#filterstack-class-and-subclass-functions-with-premade-efficiency-models">FilterStack class and subclass functions with premade efficiency models</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../LJHfiles/">LJH file format</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tests/">Testing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mass2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">X-ray models</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="detector-x-ray-efficiency-models">Detector X-ray Efficiency Models</h1>
<p>This module requires the <code>xraydb</code> python package. It should be included in the <code>mass2</code> installation. Otherwise, you should be able to install with <code>pip install xraydb</code>.</p>
<h2 id="motivation">Motivation</h2>
<p>For many analyses, it is important to estimate a x-ray spectrum as it would be seen from the source rather than as it would be measured with a set of detectors. This can be important, for example, when trying to determine line intensity ratios of two lines separated in energy space. Here, we attempt to model the effects that would cause the measured spectrum to be different from the true spectrum, such as energy dependent losses in transmission due to IR blocking filters and vacuum windows. Energy-dependent absorber efficiency can also be modeled.</p>
<h2 id="filterstack-class-and-subclass-functions-with-premade-efficiency-models"><code>FilterStack</code> class and subclass functions with premade efficiency models</h2>
<p>Here, we import the <code>mass2.efficiency_models</code> module and demonstrate the functionality with some of the premade efficiency models.
Generally, these premade models are put in place for TES instruments with well known absorber and filter stack compositions.
To demonstrate, we work with the 'EBIT 2018' model, which models the TES spectrometer setup at the NIST EBIT, as it was commissioned in 2018.
This model includes a ~1um thick absorber, 3 ~100nm thick Al IR blocking filters, and LEX HT vacuum windows for both the TES and EBIT vacuums.
We begin by importing <code>efficiency_models</code> and examining the EBIT efficiency model components.</p>
<p>We can see that the model is made of many submodels (aka components) and that all the parameters have uncertainties.
The EBIT system was particularly well characterized, so the uncertainties are fairly low.
The presence of uncertainties requires some special handling in a few places, these docs will show some examples.</p>
<pre><code class="language-python">  import mass2
  import mass2.materials  # you have to explicitly import mass2.materials
  import numpy as np
  import pylab as plt
  from uncertainties import unumpy as unp  # useful for working with arrays with uncertainties aka uarray
  from uncertainties import ufloat

  EBIT_model = mass2.materials.filterstack_models['EBIT 2018']
  print(EBIT_model)
</code></pre>
<pre><code class="language-text">&lt;class 'mass2.materials.efficiency_models.FilterStack'&gt;(
Electroplated Au Absorber: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Au 0.00186+/-0.00006 g/cm^2, fill_fraction=1.000+/-0, absorber=True)
50mK Filter: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Al (3.04+/-0.06)e-05 g/cm^2, Al 1.27e-06 g/cm^2, O 1.13e-06 g/cm^2, fill_fraction=1.000+/-0, absorber=False)
3K Filter: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Al (2.93+/-0.06)e-05 g/cm^2, Al 1.27e-06 g/cm^2, O 1.13e-06 g/cm^2, fill_fraction=1.000+/-0, absorber=False)
50K Filter: &lt;class 'mass2.materials.efficiency_models.FilterStack'&gt;(
Al Film: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Al (2.77+/-0.06)e-05 g/cm^2, Al 1.27e-06 g/cm^2, O 1.13e-06 g/cm^2, fill_fraction=1.000+/-0, absorber=False)
Ni Mesh: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Ni 0.0134+/-0.0018 g/cm^2, fill_fraction=0.170+/-0.010, absorber=False)
)
Luxel Window TES: &lt;class 'mass2.materials.efficiency_models.FilterStack'&gt;(
LEX_HT Film: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(C (6.70+/-0.20)e-05 g/cm^2, H (2.60+/-0.08)e-06 g/cm^2, N (7.20+/-0.22)e-06 g/cm^2, O (1.70+/-0.05)e-05 g/cm^2, Al (1.70+/-0.05)e-05 g/cm^2, fill_fraction=1.000+/-0, absorber=False)
LEX_HT Mesh: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Fe 0.0564+/-0.0011 g/cm^2, Cr 0.0152+/-0.0003 g/cm^2, Ni 0.00720+/-0.00014 g/cm^2, Mn 0.000800+/-0.000016 g/cm^2, Si 0.000400+/-0.000008 g/cm^2, fill_fraction=0.190+/-0.010, absorber=False)
)
Luxel Window EBIT: &lt;class 'mass2.materials.efficiency_models.FilterStack'&gt;(
LEX_HT Film: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(C (6.70+/-0.20)e-05 g/cm^2, H (2.60+/-0.08)e-06 g/cm^2, N (7.20+/-0.22)e-06 g/cm^2, O (1.70+/-0.05)e-05 g/cm^2, Al (1.70+/-0.05)e-05 g/cm^2, fill_fraction=1.000+/-0, absorber=False)
LEX_HT Mesh: &lt;class 'mass2.materials.efficiency_models.Filter'&gt;(Fe 0.0564+/-0.0011 g/cm^2, Cr 0.0152+/-0.0003 g/cm^2, Ni 0.00720+/-0.00014 g/cm^2, Mn 0.000800+/-0.000016 g/cm^2, Si 0.000400+/-0.000008 g/cm^2, fill_fraction=0.190+/-0.010, absorber=False)
)
)
</code></pre>
<p>Next, we examine the function <code>get_efficiency(xray_energies_eV)</code>, which is an method of <code>FilterStack</code>. This can be called for the entire filter stack or for individual components in the filter stack. As an example, we look at the efficiency of the EBIT 2018 filter stack and the 50K filter component between 2ekV and 10 keV, at 1 keV steps.</p>
<pre><code class="language-python">  sparse_xray_energies_eV = np.arange(2000, 10000, 1000)
  stack_efficiency = EBIT_model.get_efficiency(sparse_xray_energies_eV)
  stack_efficiency_uncertain = EBIT_model.get_efficiency(sparse_xray_energies_eV, uncertain=True) # you have to opt into getting uncertainties out
  filter50K_efficiency = EBIT_model.components[3].get_efficiency(sparse_xray_energies_eV)

  print(&quot;stack efficiencies&quot;)
  print([f&quot;{x}&quot; for x in stack_efficiency_uncertain]) # this is a hack to get uarrays to print with auto chosen number of sig figs
  print(stack_efficiency) # this is a hack to get uarrays to print with auto chosen number of sig figs
  print(unp.nominal_values(stack_efficiency)) # you can easily strip uncertainties, see uncertains package docs for more info

  print(&quot;filter50K efficiencies&quot;)
  print(filter50K_efficiency) # if you want to remove the uncertainties, eg for plotting
</code></pre>
<pre><code class="language-text">stack efficiencies
['0.335+/-0.008', '0.472+/-0.010', '0.456+/-0.010', '0.383+/-0.010', '0.307+/-0.009', '0.242+/-0.007', '0.191+/-0.006', '0.136+/-0.005']
[0.33535662 0.4719283  0.45559501 0.38309458 0.30687859 0.24201976
 0.19141294 0.13581482]
[0.33535662 0.4719283  0.45559501 0.38309458 0.30687859 0.24201976
 0.19141294 0.13581482]
filter50K efficiencies
[0.77672107 0.81107679 0.8233861  0.84072724 0.86670307 0.89357999
 0.9163624  0.83360284]
 ```

Here, we use the function `plot_efficiency(xray_energies_eV, ax)` to plot the efficiencies.
`ax` defaults to None, but it can be used to plot the efficiencies on a user provided axis.
Just like `get_efficiency`, `plot_efficiency` works with `FilterStack` and its subclasses.
Testing with energy range 100 to 20,000 eV, 1 eV steps.

```python
  xray_energies_eV = np.arange(100,20000,10)
  EBIT_model.plot_efficiency(xray_energies_eV)
  EBIT_model.components[3].plot_efficiency(xray_energies_eV)
  # plt.savefig(&quot;img/filter_50K_efficiency.png&quot;);plt.close()
  # plt.savefig(&quot;img/EBIT_efficiency.png&quot;);plt.close()
</code></pre>
<!-- TODO: make embedded images work
 .. image:: img/EBIT_efficiency.png
  :width: 40%

.. image:: img/filter_50K_efficiency.png
  :width: 40% -->

<h1 id="creating-your-own-custom-filter-stack-model-using-filterstack-objects">Creating your own custom filter stack model using <code>FilterStack</code> objects</h1>
<p>Now we will explore creating custom <code>FilterStack</code> objects and building up your very own filter stack model.
First, we will create a general <code>FilterStack</code> object, representing a stack of filters.
We will then populate this object with filters, which take the form of the various <code>FilterStack</code> object subclasses, such as <code>Film</code>,
or even other <code>FilterStack</code> objects to create more complicated filters with multiple components.
The <code>add</code> argument can be used to add a premade <code>FilterStack</code> object as a component of a different <code>FilterStack</code> object.
We will start by adding some simple <code>Film</code> objects to the filter stack.
This class requires a the <code>name</code> and <code>material</code> arguments, and the optical depth can be specified by passing in either
<code>area_density_g_per_cm2</code> or <code>thickness_nm</code> (but not both).
By default, most <code>FilterStack</code> objects use the bulk density of a material to calculate the optical depth when the <code>thickness_nm</code> is used,
but a custom density can be specified with the <code>density_g_per_cm3</code> argument.
In addition, a meshed style filter can be modelled using the <code>fill_fraction</code> argument.
Finally, most <code>FilterStack</code> subclasses can use the <code>absorber</code> argument (default False), which will cause the object to return absorption,
instead of transmittance, as the efficiency.</p>
<p>All numerical arguments can be passed with our without uncertainties. If you don't have at least one number with specified uncertainty in
a particular Film, the code will add a ±100% uncertainty on that component. This way, hopefully you will notice that your uncertainty is higher than you expect, and double check the inputs. Read up on the <code>uncertainties</code> package for more info about how it works.</p>
<pre><code class="language-python">  custom_model = mass2.materials.FilterStack(name='My Filter Stack')
  custom_model.add_filter(name='My Bi Absorber', material='Bi', thickness_nm=ufloat(4.0e3, .1e3), absorber=True)
  custom_model.add_filter(name='My Al 50mK Filter', material='Al', thickness_nm=ufloat(100.0, 10))
  custom_model.add_filter(name='My Si 3K Filter', material='Si', thickness_nm=ufloat(500.0, 2))
  custom_filter = mass2.materials.FilterStack(name='My meshed 50K Filter')
  custom_filter.add_filter(name='Al Film', material='Al', thickness_nm=ufloat(100.0, 10))
  custom_filter.add_filter(name='Ni Mesh', material='Ni', thickness_nm=ufloat(10.0e3, .1e3), fill_fraction=ufloat(0.2, 0.01))
  custom_model.add(custom_filter)

  custom_model.plot_efficiency(xray_energies_eV)
</code></pre>
<!-- plt.savefig("img/custom_filter_stack.png");plt.close() -->

<p>There are also some premade filter classes for filters that commonly show up in our instrument filter stacks.
At the moment, the FilterStack subclasses listed below are implemented:
- <code>AlFilmWithOxide</code> - models a typical IR blocking filter with native oxide layers, which can be important for thin filters.
- <code>AlFilmWithPolymer</code> - models a similar IR blocking filter, but with increased structural support from a polymer backing.
- <code>LEX_HT</code> - models LEX_HT vacuum windows, which contain a polymer backed Al film and stainless steel mesh.
Usage examples and efficiency curves of these classes are shown below.</p>
<pre><code class="language-python">  premade_filter_stack = mass2.materials.FilterStack(name='A Stack of Premade Filters')
  f1 = mass2.materials.AlFilmWithOxide(name='My Oxidized Al Filter', Al_thickness_nm=50.0)
  f2 = mass2.materials.AlFilmWithPolymer(name='My Polymer Backed Al Filter', Al_thickness_nm=100.0, polymer_thickness_nm=200.0)
  f3 = mass2.materials.LEX_HT(name=&quot;My LEX HT Filter&quot;)
  premade_filter_stack.add(f1)
  premade_filter_stack.add(f2)
  premade_filter_stack.add(f3)
  low_xray_energies_eV = np.arange(100,3000,5)
  premade_filter_stack.plot_efficiency(low_xray_energies_eV)
</code></pre>
<!-- plt.savefig("img/premade_stack.png");plt.close() -->

<!-- .. image:: img/premade_stack.png
  :width: 40%

.. image:: img/custom_filter_stack.png
  :width: 40% -->

<!--
  # will fail tests if any figs are open
  if (n := len(plt.get_fignums())) != 0:
      print(f"{n} figs left open") -->
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../hci_lines_from_asd/" class="btn btn-neutral float-left" title="HCI lines"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../LJHfiles/" class="btn btn-neutral float-right" title="LJH file format">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../hci_lines_from_asd/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../LJHfiles/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
