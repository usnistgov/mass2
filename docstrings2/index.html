<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://usnistgov.github.io/mass2/docstrings2/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Other docstrings - Mass2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Other docstrings";
        var mkdocs_page_input_path = "docstrings2.md";
        var mkdocs_page_url = "/mass2/docstrings2/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Mass2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting_started/">Getting started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../demo_plot/">Demo plot</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../filtering/">Optimal filtering</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Fluorescence lines</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../fluorescence/">Atomic fluorescence</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../line_fitting/">Line fitting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hci_lines_from_asd/">Highly-charge ion lines</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../xray_efficiency_models/">X-ray efficiency models</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Digging deeper</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../LJHfiles/">LJH file format</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docstrings/">Core docstrings</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Other docstrings</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#calibration">Calibration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#energy-tofrom-pulse-heights">Energy to/from pulse heights</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.energy_calibration">energy_calibration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.energy_calibration.Curvetypes">Curvetypes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration">EnergyCalibration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.ismonotonic">ismonotonic</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.npts">npts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.__str__">__str__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.copy">copy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.energy2dedph">energy2dedph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.energy2ph_exact">energy2ph_exact</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.energy2uncertainty">energy2uncertainty</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.load_from_hdf5">load_from_hdf5</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.name2ph">name2ph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.ph2dedph">ph2dedph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.ph2energy">ph2energy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.plotgain">plotgain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.plotinvgain">plotinvgain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.plotloggain">plotloggain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibration.save_to_hdf5">save_to_hdf5</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker">EnergyCalibrationMaker</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.npts">npts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.add_cal_point">add_cal_point</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.drop_one_errors">drop_one_errors</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.heuristic_samplepoints">heuristic_samplepoints</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.init">init</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration">make_calibration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_gain">make_calibration_gain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_invgain">make_calibration_invgain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_linear">make_calibration_linear</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_loggain">make_calibration_loggain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_loglog">make_calibration_loglog</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.remove_cal_point_energy">remove_cal_point_energy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.remove_cal_point_name">remove_cal_point_name</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker.remove_cal_point_prefix">remove_cal_point_prefix</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#fluorescence-line-shapes">Fluorescence line shapes</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.fluorescence_lines">fluorescence_lines</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.AmplitudeType">AmplitudeType</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.LineshapeReference">LineshapeReference</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.LineshapeReference.__str__">__str__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.LineshapeReference.load">load</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine">SpectralLine</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.cumulative_amplitudes">cumulative_amplitudes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.lorentz_amplitude">lorentz_amplitude</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.lorentzian_integral_intensity">lorentzian_integral_intensity</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.normalized_lorentzian_integral_intensity">normalized_lorentzian_integral_intensity</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.peak_energy">peak_energy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.reference">reference</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.shortname">shortname</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.addline">addline</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.components">components</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.fitter">fitter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.minimum_fwhm">minimum_fwhm</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.model">model</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.pdf">pdf</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.plot_like_reference">plot_like_reference</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.quick_monochromatic_line">quick_monochromatic_line</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.SpectralLine.rvs">rvs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.LineEnergies">LineEnergies</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.fluorescence_lines.plot_all_spectra">plot_all_spectra</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.line_models">line_models</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.line_models.CompositeMLEModel">CompositeMLEModel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.CompositeMLEModel.__add__">__add__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.CompositeMLEModel.__mul__">__mul__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.CompositeMLEModel.__sub__">__sub__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.CompositeMLEModel.__truediv__">__truediv__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.GenericLineModel.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.GenericLineModel.guess">guess</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.line_models.LineModelResult">LineModelResult</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.LineModelResult.plotm">plotm</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.LineModelResult.set_label_hints">set_label_hints</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel">MLEModel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel.__add__">__add__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel.__mul__">__mul__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel.__sub__">__sub__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel.__truediv__">__truediv__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.line_models.MLEModel.fit">fit</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#calibration-algorithms">Calibration algorithms</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms">algorithms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.FailedToGetModelException">FailedToGetModelException</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.build_fit_ranges">build_fit_ranges</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.build_fit_ranges_ph">build_fit_ranges_ph</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.find_local_maxima">find_local_maxima</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.find_opt_assignment">find_opt_assignment</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.get_model">get_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.line_names_and_energies">line_names_and_energies</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.multifit">multifit</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.algorithms.singlefit">singlefit</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#highly-charged-ions">Highly charged ions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_lines">hci_lines</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_lines.NIST_ASD">NIST_ASD</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.hci_lines.NIST_ASD.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.hci_lines.NIST_ASD.getAvailableElements">getAvailableElements</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.hci_lines.NIST_ASD.getAvailableLevels">getAvailableLevels</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.hci_lines.NIST_ASD.getAvailableSpectralCharges">getAvailableSpectralCharges</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.hci_lines.NIST_ASD.getSingleLevel">getSingleLevel</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_lines.add_H_like_lines_from_asd">add_H_like_lines_from_asd</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_lines.add_He_like_lines_from_asd">add_He_like_lines_from_asd</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_lines.add_hci_line">add_hci_line</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models">hci_models</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models.add_bg_model">add_bg_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models.initialize_HLike_2P_model">initialize_HLike_2P_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models.initialize_HeLike_complex_model">initialize_HeLike_complex_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models.initialize_hci_composite_model">initialize_hci_composite_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models.initialize_hci_line_model">initialize_hci_line_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.hci_models.models">models</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#bookkeeping">Bookkeeping</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.import_asd">import_asd</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.import_asd.parseLine">parseLine</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.import_asd.write_asd_pickle">write_asd_pickle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.nist_xray_database">nist_xray_database</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayDBFile">NISTXrayDBFile</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayDBFile.__getitem__">__getitem__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayDBFile.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayDBFile.get_lines_by_type">get_lines_by_type</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayLine">NISTXrayLine</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayLine.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayLine.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.calibration.nist_xray_database.NISTXrayLine.__str__">__str__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.nist_xray_database.plot_line_energies">plot_line_energies</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.calibration.nist_xray_database.plot_line_uncertainties">plot_line_uncertainties</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#materials-transmission">Materials transmission</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models">efficiency_models</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models.Filter">Filter</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.Filter.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.Filter.get_efficiency">get_efficiency</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.Filter.newfilter">newfilter</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack">FilterStack</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack.add">add</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack.add_filter">add_filter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack.get_efficiency">get_efficiency</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.materials.efficiency_models.FilterStack.plot_efficiency">plot_efficiency</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models.AlFilmWithOxide">AlFilmWithOxide</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models.AlFilmWithPolymer">AlFilmWithPolymer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models.LEX_HT">LEX_HT</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.materials.efficiency_models.get_filter_stacks_dict">get_filter_stacks_dict</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#math-and-statistics-functions">Math and statistics functions</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#entropy">Entropy</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy">entropy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_KL_divergence">laplace_KL_divergence</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_cross_entropy">laplace_cross_entropy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_cross_entropy_approx">laplace_cross_entropy_approx</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_cross_entropy_arrays">laplace_cross_entropy_arrays</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_entropy">laplace_entropy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_entropy_approx">laplace_entropy_approx</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.entropy.laplace_entropy_array">laplace_entropy_array</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#fitting">Fitting</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.fitting">fitting</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.fitting.fit_kink_model">fit_kink_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.fitting.kink_model">kink_model</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interpolation">Interpolation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate">interpolate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate.CubicSpline">CubicSpline</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.CubicSpline.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.CubicSpline.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.CubicSpline.variance">variance</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate.GPRSpline">GPRSpline</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.GPRSpline.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.GPRSpline.best_sigmaf">best_sigmaf</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.GPRSpline.covariance">covariance</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.GPRSpline.variance">variance</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate.NaturalBsplineBasis">NaturalBsplineBasis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.NaturalBsplineBasis.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.NaturalBsplineBasis.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.NaturalBsplineBasis.expand_coeff">expand_coeff</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.NaturalBsplineBasis.values_matrix">values_matrix</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSpline">SmoothingSpline</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSpline.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSpline.__eval">__eval</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSpline.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSpline.smooth">smooth</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSplineLog">SmoothingSplineLog</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSplineLog.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.interpolate.SmoothingSplineLog.__init__">__init__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.interpolate.k_spline">k_spline</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#power-spectra">Power spectra</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum">power_spectrum</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum">PowerSpectrum</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.addDataSegment">addDataSegment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.addLongData">addLongData</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.autocorrelation">autocorrelation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.copy">copy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.frequencies">frequencies</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrum.spectrum">spectrum</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrumOverlap">PowerSpectrumOverlap</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrumOverlap.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrumOverlap.addDataSegment">addDataSegment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.mathstat.power_spectrum.PowerSpectrumOverlap.addLongData">addLongData</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.bartlett">bartlett</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.computeSpectrum">computeSpectrum</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.demo">demo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.hamming">hamming</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.hann">hann</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.power_spectrum.welch">welch</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#robust-statistics">Robust statistics</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust">robust</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.Qscale">Qscale</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.bisquare_weighted_mean">bisquare_weighted_mean</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.high_median">high_median</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.huber_weighted_mean">huber_weighted_mean</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.median_abs_dev">median_abs_dev</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.shorth_range">shorth_range</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.mathstat.robust.trimean">trimean</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">Testing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mass2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Digging deeper</li>
      <li class="breadcrumb-item active">Other docstrings</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="automatic-documentation-generated-from-docstrings">Automatic documentation generated from docstrings</h1>
<p>This page is auto-generated from the docstrings of functions, methods, classes, and modules. Each lowest-level module in Mass2 (i.e., each python file) that you want documented and indexed for searching should be listed in this <code>docstrings2.md</code> file. The exception are the <a href="../docstrings/">Core docstrings</a> for the <code>mass2.core</code> docstrings.</p>
<h2 id="calibration">Calibration</h2>
<h3 id="energy-tofrom-pulse-heights">Energy to/from pulse heights</h3>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.energy_calibration"></a>
<div class="doc doc-contents first">
<p>Objects to assist with calibration from pulse heights to absolute energies.</p>
<p>Created on May 16, 2011
Completely redesigned January 2025</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.energy_calibration.Curvetypes">
<code>Curvetypes</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>
<p>Enumerate the types of calibration curves supported by Mass2.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Curvetypes</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Enumerate the types of calibration curves supported by Mass2."""</span>

    <span class="n">LINEAR</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LINEAR_PLUS_ZERO</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LOGLOG</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">GAIN</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">INVGAIN</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">LOGGAIN</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration">
<code>EnergyCalibration</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An energy calibration object that can convert pulse heights to (estimated) energies.</p>
<p>Subclasses implement the math of either exact or approximating calibration curves.
Methods allow you to convert between pulse heights and energies, estimate energy uncertainties,
and estimate pulse heights for lines whose names are know, or estimate the cal curve slope.
Methods allow you to plot the calibration curve with its anchor points.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="EnergyCalibration


  
      dataclass
   (mass2.calibration.energy_calibration.EnergyCalibration)" href="#mass2.calibration.energy_calibration.EnergyCalibration">EnergyCalibration</a></code>
              –
              <div class="doc-md-description">
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>If there is not at least one anchor point.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An energy calibration object that can convert pulse heights to (estimated) energies.</span>

<span class="sd">    Subclasses implement the math of either exact or approximating calibration curves.</span>
<span class="sd">    Methods allow you to convert between pulse heights and energies, estimate energy uncertainties,</span>
<span class="sd">    and estimate pulse heights for lines whose names are know, or estimate the cal curve slope.</span>
<span class="sd">    Methods allow you to plot the calibration curve with its anchor points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    EnergyCalibration</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If there is not at least one anchor point.</span>
<span class="sd">    """</span>

    <span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">dph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">de</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">curvename</span><span class="p">:</span> <span class="n">Curvetypes</span>
    <span class="n">approximating</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">spline</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>
    <span class="n">energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ArrayLike</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>
    <span class="n">ph2uncertainty</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ArrayLike</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>
    <span class="n">input_transform</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">output_transform</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fail for inputs of length zero."""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a copy of this object, optionally changing some attributes."""</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">npts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the number of calibration anchor points."""</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_input_identity</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use ph as the argument to the spline"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ph</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_input_log</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use log(ph) as the argument to the spline"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ph</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"der=</span><span class="si">{</span><span class="n">der</span><span class="si">}</span><span class="s2">, should be one of (0,1)"</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_output_identity</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">yspline</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dery</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use the spline result as E itself"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dery</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yspline</span>
        <span class="k">elif</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_output_log</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">yspline</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dery</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use the spline result as log(E)"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dery</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Any order of d/dy equals E(y) itself, or exp(y).</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">yspline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_output_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">yspline</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dery</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use the spline result as gain = ph/E"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dery</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">yspline</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">yspline</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ph</span> <span class="o">/</span> <span class="n">yspline</span><span class="o">**</span><span class="mi">2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_output_invgain</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">yspline</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dery</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use the spline result as the inverse gain = E/ph"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dery</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ph</span> <span class="o">*</span> <span class="n">yspline</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">yspline</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ph</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ecal_output_loggain</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">yspline</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dery</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Use the spline result as the log of the gain, or log(ph/E)"</span>
        <span class="k">assert</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dery</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ph</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yspline</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yspline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">dery</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ph</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">yspline</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ismonotonic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is the curve monotonic from 0 to 1.05 times the max anchor point's pulse height?</span>
<span class="sd">        Test at 1001 points, equally spaced in pulse height."""</span>
        <span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1001</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">nsamples</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">name2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Convert a named energy feature to pulse height. `name` need not be a calibration point."""</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">STANDARD_FEATURES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2dedph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Calculate the slope at the given energies."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2dedph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2uncertainty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Cal uncertainty in eV at the given energies."""</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A full description of the calibration."""</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"EnergyCalibration(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">curvename</span><span class="si">}</span><span class="s2">)"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pulse_ht</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">):</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  energy(ph=</span><span class="si">{</span><span class="n">pulse_ht</span><span class="si">:</span><span class="s2">7.2f</span><span class="si">}</span><span class="s2">) --&gt; </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s2">9.2f</span><span class="si">}</span><span class="s2"> eV (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Apply the calibration, converting pulse heights `ph` to energies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ph : ArrayLike</span>
<span class="sd">            The pulse heights to convert to energies.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray[np.float64]</span>
<span class="sd">            Energies in eV.</span>
<span class="sd">        """</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">E</span>

    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">ph2energy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2dedph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Calculate the calibration curve's slope at pulse heights `ph`."""</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">dgdP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dydx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dEdP</span> <span class="o">=</span> <span class="n">dydx</span> <span class="o">*</span> <span class="n">dgdP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dfdP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dery</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dEdP</span> <span class="o">=</span> <span class="n">dfdP</span> <span class="o">+</span> <span class="n">dfdy</span> <span class="o">*</span> <span class="n">dydx</span> <span class="o">*</span> <span class="n">dgdP</span>
        <span class="k">return</span> <span class="n">dEdP</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2ph_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""An exact inversion of the calibration curve, converting energies `E` to pulse heights.</span>
<span class="sd">        This is still in TO DO status, as it simply uses the spline in the forward direction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        E : ArrayLike</span>
<span class="sd">            Energies in eV to be converted back to pulse heihgts</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray[np.float64]</span>
<span class="sd">            Pulse heights corresponding to the given energies.</span>
<span class="sd">        """</span>
        <span class="c1"># TODO use the spline as a starting point for Brent's method</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Save this calibration to an HDF5 group in a new subordinate group with the given name."""</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">hdf5_group</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">cal_group</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cal_group</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
        <span class="n">cal_group</span><span class="p">[</span><span class="s2">"ph"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">cal_group</span><span class="p">[</span><span class="s2">"energy"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
        <span class="n">cal_group</span><span class="p">[</span><span class="s2">"dph"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span>
        <span class="n">cal_group</span><span class="p">[</span><span class="s2">"de"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span>
        <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"curvetype"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvename</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"approximate"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_hdf5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load a calibration from an HDF5 group with the given name."""</span>
        <span class="n">cal_group</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Fix a behavior of h5py for writing in py2, reading in py3.</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"curvetype"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">ctype</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
        <span class="n">curvetype</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span>

        <span class="n">maker</span> <span class="o">=</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span>
            <span class="n">cal_group</span><span class="p">[</span><span class="s2">"ph"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"energy"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"dph"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"de"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"name"</span><span class="p">][:]</span>
        <span class="p">)</span>
        <span class="n">approximate</span> <span class="o">=</span> <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"approximate"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">maker</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvetype</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plotgain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the calibration curve as gain (PH/eV) vs pulse height."""</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"plottype"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"gain"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plotinvgain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the calibration curve as inverse gain (eV/PH) vs pulse height."""</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"plottype"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"invgain"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plotloggain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the calibration curve as log-gain log(PH/eV) vs pulse height."""</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"plottype"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"loggain"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"blue"</span><span class="p">,</span>
        <span class="n">markercolor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"red"</span><span class="p">,</span>
        <span class="n">plottype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"linear"</span><span class="p">,</span>
        <span class="n">ph_rescale_power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">removeslope</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">energy_x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">showtext</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">showerrors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the calibration curve, with options."""</span>
        <span class="c1"># Plot smooth curve</span>
        <span class="n">minph</span><span class="p">,</span> <span class="n">maxph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="k">if</span> <span class="n">min_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">min_energy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">max_energy</span><span class="p">)</span>
        <span class="n">phplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minph</span><span class="p">,</span> <span class="n">maxph</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">eplot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span>
        <span class="n">gplot</span> <span class="o">=</span> <span class="n">phplot</span> <span class="o">/</span> <span class="n">eplot</span>
        <span class="n">dyplot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">xplot</span> <span class="o">=</span> <span class="n">phplot</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span>
        <span class="k">if</span> <span class="n">energy_x</span><span class="p">:</span>
            <span class="n">xplot</span> <span class="o">=</span> <span class="n">eplot</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="c1"># axis.set_xlim([x[0], x[-1]*1.1])</span>
        <span class="k">if</span> <span class="n">energy_x</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Energy (eV)"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Pulse height"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"linear"</span><span class="p">:</span>
            <span class="n">yplot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">phplot</span><span class="o">**</span><span class="n">ph_rescale_power</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
                <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">phplot</span><span class="o">**</span><span class="n">ph_rescale_power</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">**</span><span class="n">ph_rescale_power</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ph_rescale_power</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Energy (eV)"</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Energy (eV) / PH^</span><span class="si">{</span><span class="n">ph_rescale_power</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Energy calibration curve, scaled by </span><span class="si">{</span><span class="n">ph_rescale_power</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> power of PH"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"gain"</span><span class="p">:</span>
            <span class="n">yplot</span> <span class="o">=</span> <span class="n">gplot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
                <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">eplot</span> <span class="o">*</span> <span class="n">gplot</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">gains</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Gain (PH/eV)"</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, gain"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"invgain"</span><span class="p">:</span>
            <span class="n">yplot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gplot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
                <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">phplot</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gains</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Inverse Gain (eV/PH)"</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, inverse gain"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"loggain"</span><span class="p">:</span>
            <span class="n">yplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gplot</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
                <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">eplot</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Log Gain: log(eV/PH)"</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, log gain"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"loglog"</span><span class="p">:</span>
            <span class="n">yplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eplot</span><span class="p">)</span>
            <span class="n">xplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
                <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">eplot</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Log energy/1 eV"</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"log(Pulse height/arbs)"</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, log gain"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"plottype must be one of ('linear', 'gain','loggain','invgain')."</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">removeslope</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">yplot</span> <span class="o">-=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xplot</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xplot</span><span class="p">,</span> <span class="n">yplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dyplot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">showerrors</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xplot</span><span class="p">,</span> <span class="n">yplot</span> <span class="o">+</span> <span class="n">dyplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xplot</span><span class="p">,</span> <span class="n">yplot</span> <span class="o">-</span> <span class="n">dyplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>

        <span class="c1"># Plot and label cal points</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">y</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">"o"</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">markercolor</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">removeslope</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ylabel</span><span class="si">}</span><span class="s2"> slope removed"</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">showtext</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xval</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">yval</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="n">yval</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xval</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">"  "</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"right"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.ismonotonic">
<code class="highlight language-python"><span class="n">ismonotonic</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is the curve monotonic from 0 to 1.05 times the max anchor point's pulse height?
Test at 1001 points, equally spaced in pulse height.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.npts">
<code class="highlight language-python"><span class="n">npts</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the number of calibration anchor points.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Fail for inputs of length zero.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fail for inputs of length zero."""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.__str__">
<code class="highlight language-python"><span class="fm">__str__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>A full description of the calibration.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A full description of the calibration."""</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"EnergyCalibration(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">curvename</span><span class="si">}</span><span class="s2">)"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pulse_ht</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">):</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  energy(ph=</span><span class="si">{</span><span class="n">pulse_ht</span><span class="si">:</span><span class="s2">7.2f</span><span class="si">}</span><span class="s2">) --&gt; </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s2">9.2f</span><span class="si">}</span><span class="s2"> eV (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.copy">
<code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">changes</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a copy of this object, optionally changing some attributes.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a copy of this object, optionally changing some attributes."""</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.energy2dedph">
<code class="highlight language-python"><span class="n">energy2dedph</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the slope at the given energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2dedph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Calculate the slope at the given energies."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2dedph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.energy2ph_exact">
<code class="highlight language-python"><span class="n">energy2ph_exact</span><span class="p">(</span><span class="n">E</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>An exact inversion of the calibration curve, converting energies <code>E</code> to pulse heights.
This is still in TO DO status, as it simply uses the spline in the forward direction.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>E</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Energies in eV to be converted back to pulse heihgts</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float64">float64</span>]</code>
              –
              <div class="doc-md-description">
<p>Pulse heights corresponding to the given energies.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2ph_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""An exact inversion of the calibration curve, converting energies `E` to pulse heights.</span>
<span class="sd">    This is still in TO DO status, as it simply uses the spline in the forward direction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    E : ArrayLike</span>
<span class="sd">        Energies in eV to be converted back to pulse heihgts</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray[np.float64]</span>
<span class="sd">        Pulse heights corresponding to the given energies.</span>
<span class="sd">    """</span>
    <span class="c1"># TODO use the spline as a starting point for Brent's method</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.energy2uncertainty">
<code class="highlight language-python"><span class="n">energy2uncertainty</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Cal uncertainty in eV at the given energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2uncertainty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Cal uncertainty in eV at the given energies."""</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.load_from_hdf5">
<code class="highlight language-python"><span class="n">load_from_hdf5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Load a calibration from an HDF5 group with the given name.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_from_hdf5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load a calibration from an HDF5 group with the given name."""</span>
    <span class="n">cal_group</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># Fix a behavior of h5py for writing in py2, reading in py3.</span>
    <span class="n">ctype</span> <span class="o">=</span> <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"curvetype"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">ctype</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
    <span class="n">curvetype</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span>

    <span class="n">maker</span> <span class="o">=</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span>
        <span class="n">cal_group</span><span class="p">[</span><span class="s2">"ph"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"energy"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"dph"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"de"</span><span class="p">][:],</span> <span class="n">cal_group</span><span class="p">[</span><span class="s2">"name"</span><span class="p">][:]</span>
    <span class="p">)</span>
    <span class="n">approximate</span> <span class="o">=</span> <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"approximate"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">maker</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvetype</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.name2ph">
<code class="highlight language-python"><span class="n">name2ph</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Convert a named energy feature to pulse height. <code>name</code> need not be a calibration point.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">name2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Convert a named energy feature to pulse height. `name` need not be a calibration point."""</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">STANDARD_FEATURES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.ph2dedph">
<code class="highlight language-python"><span class="n">ph2dedph</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the calibration curve's slope at pulse heights <code>ph</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph2dedph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Calculate the calibration curve's slope at pulse heights `ph`."""</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">dgdP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dydx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dEdP</span> <span class="o">=</span> <span class="n">dydx</span> <span class="o">*</span> <span class="n">dgdP</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">dfdP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dery</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dEdP</span> <span class="o">=</span> <span class="n">dfdP</span> <span class="o">+</span> <span class="n">dfdy</span> <span class="o">*</span> <span class="n">dydx</span> <span class="o">*</span> <span class="n">dgdP</span>
    <span class="k">return</span> <span class="n">dEdP</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.ph2energy">
<code class="highlight language-python"><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply the calibration, converting pulse heights <code>ph</code> to energies.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>ph</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The pulse heights to convert to energies.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float64">float64</span>]</code>
              –
              <div class="doc-md-description">
<p>Energies in eV.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Apply the calibration, converting pulse heights `ph` to energies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ph : ArrayLike</span>
<span class="sd">        The pulse heights to convert to energies.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray[np.float64]</span>
<span class="sd">        Energies in eV.</span>
<span class="sd">    """</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">markercolor</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">plottype</span><span class="o">=</span><span class="s1">'linear'</span><span class="p">,</span> <span class="n">ph_rescale_power</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">removeslope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">energy_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showtext</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showerrors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the calibration curve, with options.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"blue"</span><span class="p">,</span>
    <span class="n">markercolor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"red"</span><span class="p">,</span>
    <span class="n">plottype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"linear"</span><span class="p">,</span>
    <span class="n">ph_rescale_power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">removeslope</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">energy_x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">showtext</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">showerrors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the calibration curve, with options."""</span>
    <span class="c1"># Plot smooth curve</span>
    <span class="n">minph</span><span class="p">,</span> <span class="n">maxph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.1</span>
    <span class="k">if</span> <span class="n">min_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">minph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">min_energy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">max_energy</span><span class="p">)</span>
    <span class="n">phplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minph</span><span class="p">,</span> <span class="n">maxph</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">eplot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span>
    <span class="n">gplot</span> <span class="o">=</span> <span class="n">phplot</span> <span class="o">/</span> <span class="n">eplot</span>
    <span class="n">dyplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">xplot</span> <span class="o">=</span> <span class="n">phplot</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
    <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span>
    <span class="k">if</span> <span class="n">energy_x</span><span class="p">:</span>
        <span class="n">xplot</span> <span class="o">=</span> <span class="n">eplot</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
        <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span>

    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="c1"># axis.set_xlim([x[0], x[-1]*1.1])</span>
    <span class="k">if</span> <span class="n">energy_x</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Energy (eV)"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Pulse height"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"linear"</span><span class="p">:</span>
        <span class="n">yplot</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">phplot</span><span class="o">**</span><span class="n">ph_rescale_power</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
            <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">phplot</span><span class="o">**</span><span class="n">ph_rescale_power</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">**</span><span class="n">ph_rescale_power</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ph_rescale_power</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Energy (eV)"</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Energy (eV) / PH^</span><span class="si">{</span><span class="n">ph_rescale_power</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Energy calibration curve, scaled by </span><span class="si">{</span><span class="n">ph_rescale_power</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> power of PH"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"gain"</span><span class="p">:</span>
        <span class="n">yplot</span> <span class="o">=</span> <span class="n">gplot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
            <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">eplot</span> <span class="o">*</span> <span class="n">gplot</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">gains</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Gain (PH/eV)"</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, gain"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"invgain"</span><span class="p">:</span>
        <span class="n">yplot</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gplot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
            <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">phplot</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gains</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Inverse Gain (eV/PH)"</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, inverse gain"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"loggain"</span><span class="p">:</span>
        <span class="n">yplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gplot</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
            <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">eplot</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Log Gain: log(eV/PH)"</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, log gain"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">"loglog"</span><span class="p">:</span>
        <span class="n">yplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eplot</span><span class="p">)</span>
        <span class="n">xplot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span><span class="p">:</span>
            <span class="n">dyplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2uncertainty</span><span class="p">(</span><span class="n">phplot</span><span class="p">)</span> <span class="o">/</span> <span class="n">eplot</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">xerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">"Log energy/1 eV"</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"log(Pulse height/arbs)"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Energy calibration curve, log gain"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"plottype must be one of ('linear', 'gain','loggain','invgain')."</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">removeslope</span><span class="p">:</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yplot</span> <span class="o">-=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xplot</span>

    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xplot</span><span class="p">,</span> <span class="n">yplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dyplot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">showerrors</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xplot</span><span class="p">,</span> <span class="n">yplot</span> <span class="o">+</span> <span class="n">dyplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xplot</span><span class="p">,</span> <span class="n">yplot</span> <span class="o">-</span> <span class="n">dyplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>

    <span class="c1"># Plot and label cal points</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">"o"</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">markercolor</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">removeslope</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ylabel</span><span class="si">}</span><span class="s2"> slope removed"</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showtext</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xval</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">yval</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="n">yval</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xval</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">"  "</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"right"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.plotgain">
<code class="highlight language-python"><span class="n">plotgain</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the calibration curve as gain (PH/eV) vs pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plotgain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the calibration curve as gain (PH/eV) vs pulse height."""</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"plottype"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"gain"</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.plotinvgain">
<code class="highlight language-python"><span class="n">plotinvgain</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the calibration curve as inverse gain (eV/PH) vs pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plotinvgain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the calibration curve as inverse gain (eV/PH) vs pulse height."""</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"plottype"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"invgain"</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.plotloggain">
<code class="highlight language-python"><span class="n">plotloggain</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the calibration curve as log-gain log(PH/eV) vs pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plotloggain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the calibration curve as log-gain log(PH/eV) vs pulse height."""</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"plottype"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"loggain"</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibration.save_to_hdf5">
<code class="highlight language-python"><span class="n">save_to_hdf5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Save this calibration to an HDF5 group in a new subordinate group with the given name.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Save this calibration to an HDF5 group in a new subordinate group with the given name."""</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">hdf5_group</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">cal_group</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">cal_group</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
    <span class="n">cal_group</span><span class="p">[</span><span class="s2">"ph"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
    <span class="n">cal_group</span><span class="p">[</span><span class="s2">"energy"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
    <span class="n">cal_group</span><span class="p">[</span><span class="s2">"dph"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span>
    <span class="n">cal_group</span><span class="p">[</span><span class="s2">"de"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span>
    <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"curvetype"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvename</span><span class="o">.</span><span class="n">name</span>
    <span class="n">cal_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"approximate"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">approximating</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker">
<code>EnergyCalibrationMaker</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An object that can make energy calibration curves under various assumptions,
but using a single set of calibration anchor points and uncertainties on them.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="EnergyCalibrationMaker


  
      dataclass
   (mass2.calibration.energy_calibration.EnergyCalibrationMaker)" href="#mass2.calibration.energy_calibration.EnergyCalibrationMaker">EnergyCalibrationMaker</a></code>
              –
              <div class="doc-md-description">
<p>A factory for making various <code>EnergyCalibration</code> objects from the same anchor points.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>When calibration data arrays have unequal length, or <code>ph</code> is not monotone in <code>energy</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An object that can make energy calibration curves under various assumptions,</span>
<span class="sd">    but using a single set of calibration anchor points and uncertainties on them.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    EnergyCalibrationMaker</span>
<span class="sd">        A factory for making various `EnergyCalibration` objects from the same anchor points.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        When calibration data arrays have unequal length, or `ph` is not monotone in `energy`.</span>
<span class="sd">    """</span>

    <span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">dph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">de</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dph</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">de</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an EnergyCalibrationMaker, filling in any missing requirements with empty arrays."""</span>
        <span class="k">if</span> <span class="n">ph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dph</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">ph</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">de</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">de</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">energy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">de</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"dummy"</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dph</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">dph</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Check for inputs of unequal length. Check for monotone anchor points.</span>
<span class="sd">        Sort the input data by energy."""</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

        <span class="c1"># First sort according to energy of the calibration point</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">sortkeys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sortkeys</span><span class="p">]</span>

        <span class="c1"># Then confirm that the pulse heights are also in order</span>
        <span class="n">order_ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">order_en</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">order_ph</span> <span class="o">==</span> <span class="n">order_en</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"PH:     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[</span><span class="n">order_ph</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">b</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Energy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">order_ph</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calibration points are not monotone:</span><span class="se">\n</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">npts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The number of calibration anchor points."""</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_cal_point_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Remove calibration point number `idx` from the calibration. Return a new maker."""</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">dph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">dph</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_cal_point_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Remove calibration point named `name`. Return a new maker."""</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_cal_point_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_cal_point_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""This removes all cal points whose name starts with `prefix`.  Return a new maker."""</span>
        <span class="c1"># Work recursively: remove the first match and make a new Maker, and repeat until none match.</span>
        <span class="c1"># This is clearly less efficient when removing N matches, as N copies are made. So what?</span>
        <span class="c1"># This feature is likely to be rarely used, and we favor clarity over performance here.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_cal_point_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">remove_cal_point_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_cal_point_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">de</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Remove cal points at energies within ±`de` of `energy`. Return a new maker."""</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">de</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># Also recursive and less efficient. See previous method's comment.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_cal_point_idx</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">remove_cal_point_energy</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_cal_point</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
        <span class="n">ph_error</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">e_error</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add a single energy calibration point.</span>

<span class="sd">        Can call as .add_cal_point(ph, energy, name) or if the "energy" is a line name, then</span>
<span class="sd">        .add_cal_point(ph, name) will find energy as `energy=mass2.STANDARD_FEATURES[name]`.</span>
<span class="sd">        Thus the following are equivalent:</span>

<span class="sd">            cal = cal.add_cal_point(12345.6, 5898.801, "Mn Ka1")</span>
<span class="sd">            cal = cal.add_cal_point(12456.6, "Mn Ka1")</span>

<span class="sd">        `ph` must be in units of the self.ph_field and `energy` is in eV.</span>
<span class="sd">        `ph_error` is the 1-sigma uncertainty on the pulse height.  If None</span>
<span class="sd">        (the default), then assign ph_error = `ph`/1000. `e_error` is the</span>
<span class="sd">        1-sigma uncertainty on the energy itself. If None (the default), then</span>
<span class="sd">        assign e_error=0.01 eV.</span>

<span class="sd">        Careful!  If you give a name that's already in the list, or you add an equivalent</span>
<span class="sd">        energy but do NOT give a name, then this value replaces the previous one.</span>
<span class="sd">        You can prevent overwriting (and instead raise an error) by setting `replace`=False.</span>
<span class="sd">        """</span>

        <span class="c1"># If &lt;energy&gt; is a string and a known spectral feature's name, use it as the name instead</span>
        <span class="c1"># Otherwise, it needs to be a numeric type convertible to float.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="n">STANDARD_FEATURES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"2nd argument must be an energy or a known name"</span> <span class="o">+</span> <span class="s2">" from mass2.energy_calibration.STANDARD_FEATURES"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ph_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph_error</span> <span class="o">=</span> <span class="n">ph</span> <span class="o">*</span> <span class="mf">0.001</span>
        <span class="k">if</span> <span class="n">e_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">e_error</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Assume 0.01 eV error if none given</span>

        <span class="n">update_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>  <span class="c1"># Update an existing point by name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calibration point '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">' is already known and overwrite is False"</span><span class="p">)</span>
                <span class="n">update_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">e_error</span><span class="p">:</span>  <span class="c1"># Update existing point</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calibration point at energy </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV is already known and overwrite is False"</span><span class="p">)</span>
                <span class="n">update_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">update_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Add a new calibration anchor point</span>
            <span class="n">new_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span> <span class="n">ph</span><span class="p">))</span>
            <span class="n">new_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
            <span class="n">new_dph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">,</span> <span class="n">ph_error</span><span class="p">))</span>
            <span class="n">new_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">,</span> <span class="n">e_error</span><span class="p">))</span>
            <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Replace an existing calibration anchor point.</span>
            <span class="n">new_ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_dph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_ph</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph</span>
            <span class="n">new_energy</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
            <span class="n">new_dph</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_error</span>
            <span class="n">new_de</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_error</span>
            <span class="n">new_names</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span><span class="n">new_ph</span><span class="p">,</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_dph</span><span class="p">,</span> <span class="n">new_de</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic_samplepoints</span><span class="p">(</span><span class="n">anchors</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Given a set of calibration anchor points, return a few hundred</span>
<span class="sd">        sample points, reasonably spaced below, between, and above the anchor points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anchors : ArrayLike</span>
<span class="sd">            The anchor points (in pulse height space)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            _description_</span>
<span class="sd">        """</span>
        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
        <span class="c1"># Prescription is 50 points up to lowest anchor (but exclude 0):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">anchors</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">51</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># Then one points, plus one extra per 1% spacing between (and at) each anchor</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">/</span> <span class="n">low</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="c1"># Finally, 100 more points between the highest anchor and 2x that.</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">101</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_loglog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.15</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a calibration curve that is a spline in log(energy) vs log(pulse height)."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a calibration curve that is a spline in (pulse height/energy) vs pulse height."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_invgain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a calibration curve that is a spline in (energy/pulse height) vs pulse height."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">INVGAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_loggain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a calibration curve that is a spline in log(pulse height/energy) vs pulse height."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGGAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_linear</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">addzero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a calibration curve that is a spline in energy vs pulse height. If `addzero` include a (0,0) anchor point."""</span>
        <span class="n">curvename</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span> <span class="k">if</span> <span class="n">addzero</span> <span class="k">else</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_calibration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">curvename</span><span class="p">:</span> <span class="n">Curvetypes</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span>
        <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">powerlaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.15</span><span class="p">,</span>
        <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an energy calibration curve of the specified type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curvename : Curvetypes, optional</span>
<span class="sd">            Which curve type to use, by default Curvetypes.LOGLOG</span>
<span class="sd">        approximate : bool, optional</span>
<span class="sd">            Whether to approximate the anchor point data given the uncertainties, by default False</span>
<span class="sd">        powerlaw : float, optional</span>
<span class="sd">            An approximate powerlaw guess used by LOGLOG curves, by default 1.15</span>
<span class="sd">        extra_info : dict[str, Any] | None, optional</span>
<span class="sd">            Extra text to store in the result, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EnergyCalibration</span>
<span class="sd">            The calibration object.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If there are too few anchor points for an approximating curve, or if `curvename` is not in `Curvetypes`.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">approximate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"approximating curves require 3 or more cal anchor points, have </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Curvetypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">curvename</span><span class="si">=}</span><span class="s2">, must be in </span><span class="si">{</span><span class="n">Curvetypes</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Use a heuristic to repair negative uncertainties.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">regularize_uncertainties</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Replace negative uncertainties with the minimum non-negative uncertainty, or zero."""</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">x</span>
            <span class="n">target</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="n">dph</span> <span class="o">=</span> <span class="n">regularize_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">)</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">regularize_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">:</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_log</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_log</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
            <span class="c1"># When there's only one point, enhance it by a fake point to enforce power-law behavior</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">arboffset</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">arboffset</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">arboffset</span> <span class="o">/</span> <span class="n">powerlaw</span><span class="p">])</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>

        <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">:</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_gain</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
            <span class="c1"># Estimate spline uncertainties using slope of best-fit line</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(((</span><span class="n">slope</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dph</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>

        <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">INVGAIN</span><span class="p">:</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_invgain</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="c1"># Estimate spline uncertainties using slope of best-fit line</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(((</span><span class="n">slope</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dph</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>

        <span class="k">elif</span> <span class="n">curvename</span> <span class="ow">in</span> <span class="p">{</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span><span class="p">}:</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_identity</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">de</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">0.0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">):</span>
                <span class="c1"># Add a "zero"-energy and -PH point. But to avoid numerical problems, actually just use</span>
                <span class="c1"># 1e-3 times the lowest value, giving ±100% uncertainty on the values.</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="n">y</span><span class="p">))</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="n">dx</span><span class="p">))</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGGAIN</span><span class="p">:</span>
            <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
            <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_loggain</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
            <span class="c1"># Estimate spline uncertainties using slope of best-fit line</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(((</span><span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dph</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"curvename='</span><span class="si">{</span><span class="n">curvename</span><span class="si">}</span><span class="s2">' not recognized"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">approximate</span><span class="p">:</span>
            <span class="n">internal_spline</span><span class="p">:</span> <span class="n">CubicSpline</span> <span class="o">=</span> <span class="n">GPRSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">internal_spline</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">internal_spline</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">ph_samplepoints</span> <span class="o">=</span> <span class="n">EnergyCalibrationMaker</span><span class="o">.</span><span class="n">heuristic_samplepoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">E_samplepoints</span> <span class="o">=</span> <span class="n">output_transform</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">,</span> <span class="n">internal_spline</span><span class="p">(</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">)))</span>
        <span class="n">energy2ph</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">E_samplepoints</span><span class="p">,</span> <span class="n">ph_samplepoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">approximate</span><span class="p">:</span>
            <span class="n">dspline</span> <span class="o">=</span> <span class="n">internal_spline</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">:</span>
                <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">internal_spline</span><span class="p">(</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">:</span>
                <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">E_samplepoints</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ph_samplepoints</span>
            <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">INVGAIN</span><span class="p">:</span>
                <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">ph_samplepoints</span>
            <span class="k">elif</span> <span class="n">curvename</span> <span class="ow">in</span> <span class="p">{</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span><span class="p">}:</span>
                <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span>
            <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGGAIN</span><span class="p">:</span>
                <span class="n">abs_dfdp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">internal_spline</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">E_samplepoints</span> <span class="o">*</span> <span class="n">abs_dfdp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"curvename='</span><span class="si">{</span><span class="n">curvename</span><span class="si">}</span><span class="s2">' not recognized"</span><span class="p">)</span>

            <span class="n">uncertainty_spline</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">,</span> <span class="n">de_samplepoints</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uncertainty_spline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span>

        <span class="k">return</span> <span class="n">EnergyCalibration</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
            <span class="n">curvename</span><span class="o">=</span><span class="n">curvename</span><span class="p">,</span>
            <span class="n">approximating</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span>
            <span class="n">spline</span><span class="o">=</span><span class="n">internal_spline</span><span class="p">,</span>
            <span class="n">energy2ph</span><span class="o">=</span><span class="n">energy2ph</span><span class="p">,</span>
            <span class="n">ph2uncertainty</span><span class="o">=</span><span class="n">uncertainty_spline</span><span class="p">,</span>
            <span class="n">input_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="p">,</span>
            <span class="n">output_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="p">,</span>
            <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_one_errors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">curvename</span><span class="p">:</span> <span class="n">Curvetypes</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.15</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""For each calibration point, calculate the difference between the 'correct' energy</span>
<span class="sd">        and the energy predicted by creating a calibration without that point and using</span>
<span class="sd">        ph2energy to calculate the predicted energy</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curvename : Curvetypes, optional</span>
<span class="sd">            Calibration curve type to employ, by default Curvetypes.LOGLOG</span>
<span class="sd">        approximate : bool, optional</span>
<span class="sd">            Whether to approximate the anchor point data given the uncertainties, by default False</span>
<span class="sd">        powerlaw : float, optional</span>
<span class="sd">            An approximate powerlaw guess used by LOGLOG curves, by default 1.15</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[NDArray[np.float64], NDArray[np.float64]]</span>
<span class="sd">            An array of the anchor point energies, and an array of the differences between the predicted</span>
<span class="sd">            and actual energies for each anchor point.</span>
<span class="sd">        """</span>
        <span class="c1"># """For each calibration point, calculate the difference between the 'correct' energy</span>
        <span class="c1"># and the energy predicted by creating a calibration without that point and using</span>
        <span class="c1"># ph2energy to calculate the predicted energy, return (energies, drop_one_energy_diff)"""</span>
        <span class="n">drop_one_energy_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">):</span>
            <span class="n">dropped_pulseheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dropped_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">drop_one_maker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_cal_point_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">drop_one_cal</span> <span class="o">=</span> <span class="n">drop_one_maker</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="o">=</span><span class="n">curvename</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">)</span>
            <span class="n">predicted_energy</span> <span class="o">=</span> <span class="n">drop_one_cal</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">dropped_pulseheight</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">drop_one_energy_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_energy</span> <span class="o">-</span> <span class="n">dropped_energy</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">drop_one_energy_diff</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.npts">
<code class="highlight language-python"><span class="n">npts</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>The number of calibration anchor points.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Check for inputs of unequal length. Check for monotone anchor points.
Sort the input data by energy.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Check for inputs of unequal length. Check for monotone anchor points.</span>
<span class="sd">    Sort the input data by energy."""</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

    <span class="c1"># First sort according to energy of the calibration point</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">sortkeys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">[</span><span class="n">sortkeys</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sortkeys</span><span class="p">]</span>

    <span class="c1"># Then confirm that the pulse heights are also in order</span>
    <span class="n">order_ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">order_en</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">order_ph</span> <span class="o">==</span> <span class="n">order_en</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"PH:     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[</span><span class="n">order_ph</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">b</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Energy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">order_ph</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calibration points are not monotone:</span><span class="se">\n</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.add_cal_point">
<code class="highlight language-python"><span class="n">add_cal_point</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">ph_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Add a single energy calibration point.</p>
<p>Can call as .add_cal_point(ph, energy, name) or if the "energy" is a line name, then
.add_cal_point(ph, name) will find energy as <code>energy=mass2.STANDARD_FEATURES[name]</code>.
Thus the following are equivalent:</p>
<pre><code>cal = cal.add_cal_point(12345.6, 5898.801, "Mn Ka1")
cal = cal.add_cal_point(12456.6, "Mn Ka1")
</code></pre>
<p><code>ph</code> must be in units of the self.ph_field and <code>energy</code> is in eV.
<code>ph_error</code> is the 1-sigma uncertainty on the pulse height.  If None
(the default), then assign ph_error = <code>ph</code>/1000. <code>e_error</code> is the
1-sigma uncertainty on the energy itself. If None (the default), then
assign e_error=0.01 eV.</p>
<p>Careful!  If you give a name that's already in the list, or you add an equivalent
energy but do NOT give a name, then this value replaces the previous one.
You can prevent overwriting (and instead raise an error) by setting <code>replace</code>=False.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_cal_point</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
    <span class="n">ph_error</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">e_error</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add a single energy calibration point.</span>

<span class="sd">    Can call as .add_cal_point(ph, energy, name) or if the "energy" is a line name, then</span>
<span class="sd">    .add_cal_point(ph, name) will find energy as `energy=mass2.STANDARD_FEATURES[name]`.</span>
<span class="sd">    Thus the following are equivalent:</span>

<span class="sd">        cal = cal.add_cal_point(12345.6, 5898.801, "Mn Ka1")</span>
<span class="sd">        cal = cal.add_cal_point(12456.6, "Mn Ka1")</span>

<span class="sd">    `ph` must be in units of the self.ph_field and `energy` is in eV.</span>
<span class="sd">    `ph_error` is the 1-sigma uncertainty on the pulse height.  If None</span>
<span class="sd">    (the default), then assign ph_error = `ph`/1000. `e_error` is the</span>
<span class="sd">    1-sigma uncertainty on the energy itself. If None (the default), then</span>
<span class="sd">    assign e_error=0.01 eV.</span>

<span class="sd">    Careful!  If you give a name that's already in the list, or you add an equivalent</span>
<span class="sd">    energy but do NOT give a name, then this value replaces the previous one.</span>
<span class="sd">    You can prevent overwriting (and instead raise an error) by setting `replace`=False.</span>
<span class="sd">    """</span>

    <span class="c1"># If &lt;energy&gt; is a string and a known spectral feature's name, use it as the name instead</span>
    <span class="c1"># Otherwise, it needs to be a numeric type convertible to float.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">energy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">STANDARD_FEATURES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"2nd argument must be an energy or a known name"</span> <span class="o">+</span> <span class="s2">" from mass2.energy_calibration.STANDARD_FEATURES"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ph_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ph_error</span> <span class="o">=</span> <span class="n">ph</span> <span class="o">*</span> <span class="mf">0.001</span>
    <span class="k">if</span> <span class="n">e_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">e_error</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Assume 0.01 eV error if none given</span>

    <span class="n">update_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>  <span class="c1"># Update an existing point by name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calibration point '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">' is already known and overwrite is False"</span><span class="p">)</span>
            <span class="n">update_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">e_error</span><span class="p">:</span>  <span class="c1"># Update existing point</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calibration point at energy </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV is already known and overwrite is False"</span><span class="p">)</span>
            <span class="n">update_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">update_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Add a new calibration anchor point</span>
        <span class="n">new_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span> <span class="n">ph</span><span class="p">))</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
        <span class="n">new_dph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">,</span> <span class="n">ph_error</span><span class="p">))</span>
        <span class="n">new_de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">,</span> <span class="n">e_error</span><span class="p">))</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Replace an existing calibration anchor point.</span>
        <span class="n">new_ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_dph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_ph</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph</span>
        <span class="n">new_energy</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">new_dph</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_error</span>
        <span class="n">new_de</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_error</span>
        <span class="n">new_names</span><span class="p">[</span><span class="n">update_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span><span class="n">new_ph</span><span class="p">,</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_dph</span><span class="p">,</span> <span class="n">new_de</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.drop_one_errors">
<code class="highlight language-python"><span class="n">drop_one_errors</span><span class="p">(</span><span class="n">curvename</span><span class="o">=</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="mf">1.15</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>For each calibration point, calculate the difference between the 'correct' energy
and the energy predicted by creating a calibration without that point and using
ph2energy to calculate the predicted energy</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>curvename</code></b>
                  (<code><a class="autorefs autorefs-internal" title="Curvetypes (mass2.calibration.energy_calibration.Curvetypes)" href="#mass2.calibration.energy_calibration.Curvetypes">Curvetypes</a></code>, default:
                      <code><span title="mass2.calibration.energy_calibration.Curvetypes.LOGLOG">LOGLOG</span></code>
)
              –
              <div class="doc-md-description">
<p>Calibration curve type to employ, by default Curvetypes.LOGLOG</p>
</div>
</li>
<li>
<b><code>approximate</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>Whether to approximate the anchor point data given the uncertainties, by default False</p>
</div>
</li>
<li>
<b><code>powerlaw</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>1.15</code>
)
              –
              <div class="doc-md-description">
<p>An approximate powerlaw guess used by LOGLOG curves, by default 1.15</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float64">float64</span>], <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.float64">float64</span>]]</code>
              –
              <div class="doc-md-description">
<p>An array of the anchor point energies, and an array of the differences between the predicted
and actual energies for each anchor point.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_one_errors</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">curvename</span><span class="p">:</span> <span class="n">Curvetypes</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.15</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""For each calibration point, calculate the difference between the 'correct' energy</span>
<span class="sd">    and the energy predicted by creating a calibration without that point and using</span>
<span class="sd">    ph2energy to calculate the predicted energy</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    curvename : Curvetypes, optional</span>
<span class="sd">        Calibration curve type to employ, by default Curvetypes.LOGLOG</span>
<span class="sd">    approximate : bool, optional</span>
<span class="sd">        Whether to approximate the anchor point data given the uncertainties, by default False</span>
<span class="sd">    powerlaw : float, optional</span>
<span class="sd">        An approximate powerlaw guess used by LOGLOG curves, by default 1.15</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[NDArray[np.float64], NDArray[np.float64]]</span>
<span class="sd">        An array of the anchor point energies, and an array of the differences between the predicted</span>
<span class="sd">        and actual energies for each anchor point.</span>
<span class="sd">    """</span>
    <span class="c1"># """For each calibration point, calculate the difference between the 'correct' energy</span>
    <span class="c1"># and the energy predicted by creating a calibration without that point and using</span>
    <span class="c1"># ph2energy to calculate the predicted energy, return (energies, drop_one_energy_diff)"""</span>
    <span class="n">drop_one_energy_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">):</span>
        <span class="n">dropped_pulseheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dropped_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">drop_one_maker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_cal_point_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">drop_one_cal</span> <span class="o">=</span> <span class="n">drop_one_maker</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="o">=</span><span class="n">curvename</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">)</span>
        <span class="n">predicted_energy</span> <span class="o">=</span> <span class="n">drop_one_cal</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">dropped_pulseheight</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">drop_one_energy_diff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_energy</span> <span class="o">-</span> <span class="n">dropped_energy</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">drop_one_energy_diff</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.heuristic_samplepoints">
<code class="highlight language-python"><span class="n">heuristic_samplepoints</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Given a set of calibration anchor points, return a few hundred
sample points, reasonably spaced below, between, and above the anchor points.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>anchors</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The anchor points (in pulse height space)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">heuristic_samplepoints</span><span class="p">(</span><span class="n">anchors</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Given a set of calibration anchor points, return a few hundred</span>
<span class="sd">    sample points, reasonably spaced below, between, and above the anchor points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    anchors : ArrayLike</span>
<span class="sd">        The anchor points (in pulse height space)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        _description_</span>
<span class="sd">    """</span>
    <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
    <span class="c1"># Prescription is 50 points up to lowest anchor (but exclude 0):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">anchors</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">51</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="c1"># Then one points, plus one extra per 1% spacing between (and at) each anchor</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">/</span> <span class="n">low</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># Finally, 100 more points between the highest anchor and 2x that.</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">101</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.init">
<code class="highlight language-python"><span class="n">init</span><span class="p">(</span><span class="n">ph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">de</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create an EnergyCalibrationMaker, filling in any missing requirements with empty arrays.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dph</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">de</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create an EnergyCalibrationMaker, filling in any missing requirements with empty arrays."""</span>
    <span class="k">if</span> <span class="n">ph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dph</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">ph</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dph</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">de</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">de</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">energy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">de</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"dummy"</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dph</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">dph</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration">
<code class="highlight language-python"><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="o">=</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create an energy calibration curve of the specified type.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>curvename</code></b>
                  (<code><a class="autorefs autorefs-internal" title="Curvetypes (mass2.calibration.energy_calibration.Curvetypes)" href="#mass2.calibration.energy_calibration.Curvetypes">Curvetypes</a></code>, default:
                      <code><span title="mass2.calibration.energy_calibration.Curvetypes.LOGLOG">LOGLOG</span></code>
)
              –
              <div class="doc-md-description">
<p>Which curve type to use, by default Curvetypes.LOGLOG</p>
</div>
</li>
<li>
<b><code>approximate</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>Whether to approximate the anchor point data given the uncertainties, by default False</p>
</div>
</li>
<li>
<b><code>powerlaw</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>1.15</code>
)
              –
              <div class="doc-md-description">
<p>An approximate powerlaw guess used by LOGLOG curves, by default 1.15</p>
</div>
</li>
<li>
<b><code>extra_info</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Extra text to store in the result, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="EnergyCalibration


  
      dataclass
   (mass2.calibration.energy_calibration.EnergyCalibration)" href="#mass2.calibration.energy_calibration.EnergyCalibration">EnergyCalibration</a></code>
              –
              <div class="doc-md-description">
<p>The calibration object.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>If there are too few anchor points for an approximating curve, or if <code>curvename</code> is not in <code>Curvetypes</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_calibration</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">curvename</span><span class="p">:</span> <span class="n">Curvetypes</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span>
    <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">powerlaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.15</span><span class="p">,</span>
    <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create an energy calibration curve of the specified type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    curvename : Curvetypes, optional</span>
<span class="sd">        Which curve type to use, by default Curvetypes.LOGLOG</span>
<span class="sd">    approximate : bool, optional</span>
<span class="sd">        Whether to approximate the anchor point data given the uncertainties, by default False</span>
<span class="sd">    powerlaw : float, optional</span>
<span class="sd">        An approximate powerlaw guess used by LOGLOG curves, by default 1.15</span>
<span class="sd">    extra_info : dict[str, Any] | None, optional</span>
<span class="sd">        Extra text to store in the result, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    EnergyCalibration</span>
<span class="sd">        The calibration object.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If there are too few anchor points for an approximating curve, or if `curvename` is not in `Curvetypes`.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">approximate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"approximating curves require 3 or more cal anchor points, have </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">curvename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Curvetypes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">curvename</span><span class="si">=}</span><span class="s2">, must be in </span><span class="si">{</span><span class="n">Curvetypes</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Use a heuristic to repair negative uncertainties.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">regularize_uncertainties</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Replace negative uncertainties with the minimum non-negative uncertainty, or zero."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="n">dph</span> <span class="o">=</span> <span class="n">regularize_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">)</span>
    <span class="n">de</span> <span class="o">=</span> <span class="n">regularize_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">:</span>
        <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_log</span>
        <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_log</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="c1"># When there's only one point, enhance it by a fake point to enforce power-law behavior</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arboffset</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">arboffset</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">arboffset</span> <span class="o">/</span> <span class="n">powerlaw</span><span class="p">])</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>

    <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">:</span>
        <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
        <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_gain</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
        <span class="c1"># Estimate spline uncertainties using slope of best-fit line</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(((</span><span class="n">slope</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dph</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>

    <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">INVGAIN</span><span class="p">:</span>
        <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
        <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_invgain</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="c1"># Estimate spline uncertainties using slope of best-fit line</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(((</span><span class="n">slope</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dph</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>

    <span class="k">elif</span> <span class="n">curvename</span> <span class="ow">in</span> <span class="p">{</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span><span class="p">}:</span>
        <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
        <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_identity</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">de</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">0.0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">):</span>
            <span class="c1"># Add a "zero"-energy and -PH point. But to avoid numerical problems, actually just use</span>
            <span class="c1"># 1e-3 times the lowest value, giving ±100% uncertainty on the values.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="n">y</span><span class="p">))</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="n">dx</span><span class="p">))</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">dy</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGGAIN</span><span class="p">:</span>
        <span class="n">input_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_input_identity</span>
        <span class="n">output_transform</span> <span class="o">=</span> <span class="n">EnergyCalibration</span><span class="o">.</span><span class="n">_ecal_output_loggain</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span>
        <span class="c1"># Estimate spline uncertainties using slope of best-fit line</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(((</span><span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dph</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dph</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"curvename='</span><span class="si">{</span><span class="n">curvename</span><span class="si">}</span><span class="s2">' not recognized"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">approximate</span><span class="p">:</span>
        <span class="n">internal_spline</span><span class="p">:</span> <span class="n">CubicSpline</span> <span class="o">=</span> <span class="n">GPRSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">internal_spline</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">internal_spline</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="n">ph_samplepoints</span> <span class="o">=</span> <span class="n">EnergyCalibrationMaker</span><span class="o">.</span><span class="n">heuristic_samplepoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">E_samplepoints</span> <span class="o">=</span> <span class="n">output_transform</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">,</span> <span class="n">internal_spline</span><span class="p">(</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">)))</span>
    <span class="n">energy2ph</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">E_samplepoints</span><span class="p">,</span> <span class="n">ph_samplepoints</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">approximate</span><span class="p">:</span>
        <span class="n">dspline</span> <span class="o">=</span> <span class="n">internal_spline</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">:</span>
            <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">internal_spline</span><span class="p">(</span><span class="n">input_transform</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">:</span>
            <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">E_samplepoints</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ph_samplepoints</span>
        <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">INVGAIN</span><span class="p">:</span>
            <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">ph_samplepoints</span>
        <span class="k">elif</span> <span class="n">curvename</span> <span class="ow">in</span> <span class="p">{</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span><span class="p">}:</span>
            <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span>
        <span class="k">elif</span> <span class="n">curvename</span> <span class="o">==</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGGAIN</span><span class="p">:</span>
            <span class="n">abs_dfdp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">internal_spline</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">de_samplepoints</span> <span class="o">=</span> <span class="n">dspline</span> <span class="o">*</span> <span class="n">E_samplepoints</span> <span class="o">*</span> <span class="n">abs_dfdp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"curvename='</span><span class="si">{</span><span class="n">curvename</span><span class="si">}</span><span class="s2">' not recognized"</span><span class="p">)</span>

        <span class="n">uncertainty_spline</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ph_samplepoints</span><span class="p">,</span> <span class="n">de_samplepoints</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">uncertainty_spline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span>

    <span class="k">return</span> <span class="n">EnergyCalibration</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dph</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">de</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
        <span class="n">curvename</span><span class="o">=</span><span class="n">curvename</span><span class="p">,</span>
        <span class="n">approximating</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span>
        <span class="n">spline</span><span class="o">=</span><span class="n">internal_spline</span><span class="p">,</span>
        <span class="n">energy2ph</span><span class="o">=</span><span class="n">energy2ph</span><span class="p">,</span>
        <span class="n">ph2uncertainty</span><span class="o">=</span><span class="n">uncertainty_spline</span><span class="p">,</span>
        <span class="n">input_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="p">,</span>
        <span class="n">output_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="p">,</span>
        <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_gain">
<code class="highlight language-python"><span class="n">make_calibration_gain</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a calibration curve that is a spline in (pulse height/energy) vs pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a calibration curve that is a spline in (pulse height/energy) vs pulse height."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_invgain">
<code class="highlight language-python"><span class="n">make_calibration_invgain</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a calibration curve that is a spline in (energy/pulse height) vs pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_invgain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a calibration curve that is a spline in (energy/pulse height) vs pulse height."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">INVGAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_linear">
<code class="highlight language-python"><span class="n">make_calibration_linear</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">addzero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a calibration curve that is a spline in energy vs pulse height. If <code>addzero</code> include a (0,0) anchor point.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_linear</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">addzero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a calibration curve that is a spline in energy vs pulse height. If `addzero` include a (0,0) anchor point."""</span>
    <span class="n">curvename</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR_PLUS_ZERO</span> <span class="k">if</span> <span class="n">addzero</span> <span class="k">else</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">LINEAR</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_loggain">
<code class="highlight language-python"><span class="n">make_calibration_loggain</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a calibration curve that is a spline in log(pulse height/energy) vs pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_loggain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a calibration curve that is a spline in log(pulse height/energy) vs pulse height."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGGAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.make_calibration_loglog">
<code class="highlight language-python"><span class="n">make_calibration_loglog</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a calibration curve that is a spline in log(energy) vs log(pulse height).</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_calibration_loglog</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">powerlaw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.15</span><span class="p">,</span> <span class="n">extra_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a calibration curve that is a spline in log(energy) vs log(pulse height)."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">LOGLOG</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">,</span> <span class="n">powerlaw</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">,</span> <span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.remove_cal_point_energy">
<code class="highlight language-python"><span class="n">remove_cal_point_energy</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Remove cal points at energies within ±<code>de</code> of <code>energy</code>. Return a new maker.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_cal_point_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">de</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Remove cal points at energies within ±`de` of `energy`. Return a new maker."""</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="n">energy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">de</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="c1"># Also recursive and less efficient. See previous method's comment.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_cal_point_idx</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">remove_cal_point_energy</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.remove_cal_point_name">
<code class="highlight language-python"><span class="n">remove_cal_point_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Remove calibration point named <code>name</code>. Return a new maker.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_cal_point_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Remove calibration point named `name`. Return a new maker."""</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_cal_point_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.energy_calibration.EnergyCalibrationMaker.remove_cal_point_prefix">
<code class="highlight language-python"><span class="n">remove_cal_point_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>This removes all cal points whose name starts with <code>prefix</code>.  Return a new maker.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/energy_calibration.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_cal_point_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibrationMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""This removes all cal points whose name starts with `prefix`.  Return a new maker."""</span>
    <span class="c1"># Work recursively: remove the first match and make a new Maker, and repeat until none match.</span>
    <span class="c1"># This is clearly less efficient when removing N matches, as N copies are made. So what?</span>
    <span class="c1"># This feature is likely to be rarely used, and we favor clarity over performance here.</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_cal_point_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">remove_cal_point_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div><h3 id="fluorescence-line-shapes">Fluorescence line shapes</h3>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.fluorescence_lines"></a>
<div class="doc doc-contents first">
<p>fluorescence_lines.py</p>
<p>Tools for fitting and simulating X-ray fluorescence lines.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.AmplitudeType">
<code>AmplitudeType</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>
<p>AmplitudeType: which form of amplitude is used in the reference data.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AmplitudeType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""AmplitudeType: which form of amplitude is used in the reference data."""</span>

    <span class="n">LORENTZIAN_PEAK_HEIGHT</span> <span class="o">=</span> <span class="s2">"Peak height of Lorentzians"</span>
    <span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span> <span class="o">=</span> <span class="s2">"Integrated intensity of Lorentzians"</span>
    <span class="n">VOIGT_PEAK_HEIGHT</span> <span class="o">=</span> <span class="s2">"Peak height of Voigts"</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.LineshapeReference">
<code>LineshapeReference</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Description of our source of information on a line shape. Might be a reference to the literature,
or notes on conversations. They are stored in a YAML file mass2/data/fluorescence_line_references.yaml</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LineshapeReference</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Description of our source of information on a line shape. Might be a reference to the literature,</span>
<span class="sd">    or notes on conversations. They are stored in a YAML file mass2/data/fluorescence_line_references.yaml</span>
<span class="sd">    """</span>

    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load the reference comments from a YAML file. If filename is None, load the default file in mass2/data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : pathlib.Path | str | None, optional</span>
<span class="sd">            The file to read containing reference comments, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of LineshapeReference objects, keyed by their tag.</span>
<span class="sd">        """</span>
        <span class="n">references</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"unknown"</span><span class="p">:</span> <span class="n">LineshapeReference</span><span class="p">(</span><span class="s2">"unknown"</span><span class="p">,</span> <span class="s2">"unknown"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">"mass2"</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"data"</span> <span class="o">/</span> <span class="s2">"fluorescence_line_references.yaml"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"URL"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
                <span class="n">references</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">"tag"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">LineshapeReference</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"tag"</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">"description"</span><span class="p">],</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">references</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The citation string for this reference."""</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'lineshape_references["</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s1">"]:'</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"url: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.LineshapeReference.__str__">
<code class="highlight language-python"><span class="fm">__str__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>The citation string for this reference.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The citation string for this reference."""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'lineshape_references["</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s1">"]:'</span><span class="p">]</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"url: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.LineshapeReference.load">
<code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Load the reference comments from a YAML file. If filename is None, load the default file in mass2/data.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>filename</code></b>
                  (<code><span title="pathlib.Path">Path</span> | <span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>The file to read containing reference comments, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="dict">dict</span></code>
              –
              <div class="doc-md-description">
<p>A dictionary of LineshapeReference objects, keyed by their tag.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load the reference comments from a YAML file. If filename is None, load the default file in mass2/data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : pathlib.Path | str | None, optional</span>
<span class="sd">        The file to read containing reference comments, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of LineshapeReference objects, keyed by their tag.</span>
<span class="sd">    """</span>
    <span class="n">references</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"unknown"</span><span class="p">:</span> <span class="n">LineshapeReference</span><span class="p">(</span><span class="s2">"unknown"</span><span class="p">,</span> <span class="s2">"unknown"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">"mass2"</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"data"</span> <span class="o">/</span> <span class="s2">"fluorescence_line_references.yaml"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"URL"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">references</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">"tag"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">LineshapeReference</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"tag"</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">"description"</span><span class="p">],</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">references</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine">
<code>SpectralLine</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An abstract base class for modeling spectral lines as a sum
of Voigt profiles (i.e., Gaussian-convolved Lorentzians).</p>
<p>Call <code>SpectralLine.addline(...)</code> to create a new instance.</p>
<p>The API follows scipy.stats.stats.rv_continuous and is kind of like rv_frozen.
Calling this object with an argument evalutes the pdf at the argument, it does not
return an rv_frozen. So far, we ony define <code>rvs</code> and <code>pdf</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpectralLine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An abstract base class for modeling spectral lines as a sum</span>
<span class="sd">    of Voigt profiles (i.e., Gaussian-convolved Lorentzians).</span>

<span class="sd">    Call `SpectralLine.addline(...)` to create a new instance.</span>

<span class="sd">    The API follows scipy.stats.stats.rv_continuous and is kind of like rv_frozen.</span>
<span class="sd">    Calling this object with an argument evalutes the pdf at the argument, it does not</span>
<span class="sd">    return an rv_frozen. So far, we ony define `rvs` and `pdf`.</span>
<span class="sd">    """</span>

    <span class="n">element</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">linetype</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">nominal_peak_energy</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">energies</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">lorentzian_fwhm</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">reference_amplitude</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">reference_amplitude_type</span><span class="p">:</span> <span class="n">AmplitudeType</span> <span class="o">=</span> <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span>
    <span class="n">reference_measurement_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">"unknown"</span>
    <span class="n">intrinsic_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">reference_short</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"unknown"</span>
    <span class="n">position_uncertainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">is_default_material</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">peak_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Find the peak energy of the line shape assuming ideal instrument resolution."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">peak_energy</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brent</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">brack</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_peak_energy</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">peak_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nominal_peak_energy</span>
        <span class="k">return</span> <span class="n">peak_energy</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cumulative_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Cumulative sum of the Lorentzian integral intensities."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_integral_intensity</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lorentzian_integral_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return (and cache) computed integrated intensities of the Lorentzian components."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_amplitude_type</span> <span class="o">==</span> <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">VOIGT_PEAK_HEIGHT</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_plot_instrument_gaussian_fwhm</span> <span class="o">/</span> <span class="n">FWHM_OVER_SIGMA</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">ph</span> <span class="o">/</span> <span class="n">voigt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fwhm</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_amplitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_amplitude_type</span> <span class="o">==</span> <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_PEAK_HEIGHT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_amplitude</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_amplitude_type</span> <span class="o">==</span> <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_amplitude</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalized_lorentzian_integral_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return (and cache) computed integrated intensities of the Lorentzian components, normalized so sum=1."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_integral_intensity</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lorentz_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return (and cache) computed Lorentzian peak heights of the components."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_integral_intensity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make the class callable, returning the same value as the self.pdf method."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Spectrum (units of fraction per eV) as a function of &lt;x&gt;, the energy in eV"""</span>
        <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_lorentzian_integral_intensity</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">ampl</span> <span class="o">*</span> <span class="n">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">hwhm</span><span class="o">=</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">gaussian_sigma</span><span class="p">)</span>
            <span class="c1"># mass2.voigt() is normalized to have unit integrated intensity</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""List of spectrum components as a function of &lt;x&gt;, the energy in eV"""</span>
        <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_integral_intensity</span><span class="p">):</span>
            <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ampl</span> <span class="o">*</span> <span class="n">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">hwhm</span><span class="o">=</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">gaussian_sigma</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">components</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">setylim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the spectrum.</span>
<span class="sd">        x - np array of energy in eV to plot at (sensible default)</span>
<span class="sd">        axis - axis to plot on (default creates new figure)</span>
<span class="sd">        components - True plots each voigt component in addition to the spectrum</span>
<span class="sd">        label - a string to label the plot with (optional)"""</span>
        <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gaussian_sigma</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">)))</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">):</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="s2">"--"</span><span class="p">)</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Energy (eV)"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> eV bin"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">setylim</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> with resolution </span><span class="si">{</span><span class="n">instrument_gaussian_fwhm</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV FWHM"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">axis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_like_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the spectrum to match the instrument resolution used in the reference data publication, if known."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_plot_instrument_gaussian_fwhm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_plot_instrument_gaussian_fwhm</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">axis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The CDF and PPF (cumulative distribution and percentile point functions) are hard to</span>
<span class="sd">        compute.  But it's easy enough to generate the random variates themselves, so we</span>
<span class="sd">        override that method."""</span>
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">_rng</span>
        <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
        <span class="c1"># Choose from among the N Lorentzian lines in proportion to the line amplitudes</span>
        <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_amplitudes</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_amplitudes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">))</span>
        <span class="c1"># Choose Lorentzian variates of the appropriate width (but centered on 0)</span>
        <span class="n">lor</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_cauchy</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="c1"># If necessary, add a Gaussian variate to mimic finite resolution</span>
        <span class="k">if</span> <span class="n">gaussian_sigma</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">lor</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian_sigma</span>
        <span class="c1"># Finally, add the line centers.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">lor</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
        <span class="c1"># We must check for non-positive results and replace them by recursive call</span>
        <span class="c1"># to self.rvs().</span>
        <span class="n">not_positive</span> <span class="o">=</span> <span class="n">results</span> <span class="o">&lt;=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">not_positive</span><span class="p">):</span>
            <span class="n">Nbad</span> <span class="o">=</span> <span class="n">not_positive</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">results</span><span class="p">[</span><span class="n">not_positive</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">Nbad</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shortname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A short name for the line, suitable for use as a dictionary key."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_default_material</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">linetype</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="si">}</span><span class="s2">"</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The full comment and/or citation for the reference data."""</span>
        <span class="k">return</span> <span class="n">lineshape_references</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_short</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gaussian_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""combined intrinstic_sigma and insturment_gaussian_fwhm in quadrature and return the result"""</span>
        <span class="k">assert</span> <span class="n">instrument_gaussian_fwhm</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">instrument_gaussian_fwhm</span> <span class="o">/</span> <span class="n">FWHM_OVER_SIGMA</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""String representation of the SpectralLine."""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"SpectralLine: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span> <span class="n">qemodel</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate a LineModel instance from a SpectralLine"""</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="n">GenericLineModel</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">spect</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">qemodel</span><span class="o">=</span><span class="n">qemodel</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fitter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate a GenericLineModel instance for fitting this SpectralLine."""</span>
        <span class="n">fitter_class</span> <span class="o">=</span> <span class="n">GenericLineModel</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">fitter_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">minimum_fwhm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""for the narrowest lorentzian in the line model, calculate the combined fwhm including</span>
<span class="sd">        the lorentzian, intrinstic_sigma, and instrument_gaussian_fwhm"""</span>
        <span class="n">fwhm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_sigma</span> <span class="o">*</span> <span class="n">FWHM_OVER_SIGMA</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fwhm2</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">quick_monochromatic_line</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lorentzian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">intrinsic_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"SpectralLine"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Create a quick monochromatic line. Intended for use in calibration when we know a line energy, but not a lineshape model.</span>
<span class="sd">        Returns and instrance of SpectralLine with most fields having contents like "unknown: quick_line". The line will have</span>
<span class="sd">        a single lorentzian element with the given energy, fwhm, and intrinsic_sigma values.</span>
<span class="sd">        """</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">material</span> <span class="o">=</span> <span class="s2">"unknown: quick_line"</span>
        <span class="k">if</span> <span class="n">lorentzian_fwhm</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">intrinsic_sigma</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">intrinsic_sigma</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">linetype</span> <span class="o">=</span> <span class="s2">"Gaussian"</span>
        <span class="n">reference_short</span> <span class="o">=</span> <span class="s2">"unknown: quick_line"</span>
        <span class="n">reference_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="n">reference_amplitude_type</span> <span class="o">=</span> <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span>
        <span class="n">nominal_peak_energy</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">position_uncertainty</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">reference_measurement_type</span> <span class="o">=</span> <span class="s2">"unkown: quick_line"</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
            <span class="n">linetype</span><span class="o">=</span><span class="n">linetype</span><span class="p">,</span>
            <span class="n">energies</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energy</span><span class="p">]),</span>
            <span class="n">lorentzian_fwhm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lorentzian_fwhm</span><span class="p">]),</span>
            <span class="n">intrinsic_sigma</span><span class="o">=</span><span class="n">intrinsic_sigma</span><span class="p">,</span>
            <span class="n">reference_short</span><span class="o">=</span><span class="n">reference_short</span><span class="p">,</span>
            <span class="n">reference_amplitude</span><span class="o">=</span><span class="n">reference_amplitude</span><span class="p">,</span>
            <span class="n">reference_amplitude_type</span><span class="o">=</span><span class="n">reference_amplitude_type</span><span class="p">,</span>
            <span class="n">nominal_peak_energy</span><span class="o">=</span><span class="n">nominal_peak_energy</span><span class="p">,</span>
            <span class="n">position_uncertainty</span><span class="o">=</span><span class="n">position_uncertainty</span><span class="p">,</span>
            <span class="n">reference_measurement_type</span><span class="o">=</span><span class="n">reference_measurement_type</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">addline</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">linetype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reference_short</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nominal_peak_energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">lorentzian_fwhm</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">reference_amplitude</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">reference_amplitude_type</span><span class="p">:</span> <span class="n">AmplitudeType</span><span class="p">,</span>
        <span class="n">ka12_energy_diff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">position_uncertainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="n">intrinsic_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">reference_measurement_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_default_material</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_replacement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"SpectralLine"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add a new SpectralLine to the `mass2.fluorescence_lines.spectra` dictionary, and as a variable in this module."""</span>
        <span class="c1"># require exactly one method of specifying the amplitude of each component</span>
        <span class="k">assert</span> <span class="n">reference_amplitude_type</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_PEAK_HEIGHT</span><span class="p">,</span>
            <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span><span class="p">,</span>
            <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">VOIGT_PEAK_HEIGHT</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># require the reference exists in lineshape_references</span>
        <span class="k">assert</span> <span class="n">reference_short</span> <span class="ow">in</span> <span class="n">lineshape_references</span>

        <span class="c1"># require kalpha lines to have ka12_energy_diff</span>
        <span class="k">if</span> <span class="n">linetype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"KAlpha"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ka12_energy_diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ka12_energy_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ka12_energy_diff</span><span class="p">)</span>
        <span class="c1"># require reference_plot_instrument_gaussian_fwhm to be a float or None</span>
        <span class="k">assert</span> <span class="n">reference_plot_instrument_gaussian_fwhm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
            <span class="n">linetype</span><span class="o">=</span><span class="n">linetype</span><span class="p">,</span>
            <span class="n">nominal_peak_energy</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">nominal_peak_energy</span><span class="p">),</span>
            <span class="n">energies</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
            <span class="n">lorentzian_fwhm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lorentzian_fwhm</span><span class="p">),</span>
            <span class="n">reference_amplitude</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reference_amplitude</span><span class="p">),</span>
            <span class="n">reference_amplitude_type</span><span class="o">=</span><span class="n">reference_amplitude_type</span><span class="p">,</span>
            <span class="n">reference_measurement_type</span><span class="o">=</span><span class="n">reference_measurement_type</span><span class="p">,</span>
            <span class="n">intrinsic_sigma</span><span class="o">=</span><span class="n">intrinsic_sigma</span><span class="p">,</span>
            <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">,</span>
            <span class="n">reference_short</span><span class="o">=</span><span class="n">reference_short</span><span class="p">,</span>
            <span class="n">position_uncertainty</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">position_uncertainty</span><span class="p">),</span>
            <span class="n">is_default_material</span><span class="o">=</span><span class="n">is_default_material</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">shortname</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spectra</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_replacement</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"spectrum </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists"</span><span class="p">)</span>

        <span class="c1"># Add this SpectralLine to spectra dict AND make it be a variable in the module</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">line</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.cumulative_amplitudes">
<code class="highlight language-python"><span class="n">cumulative_amplitudes</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Cumulative sum of the Lorentzian integral intensities.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.lorentz_amplitude">
<code class="highlight language-python"><span class="n">lorentz_amplitude</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-cached"><code>cached</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return (and cache) computed Lorentzian peak heights of the components.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.lorentzian_integral_intensity">
<code class="highlight language-python"><span class="n">lorentzian_integral_intensity</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-cached"><code>cached</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return (and cache) computed integrated intensities of the Lorentzian components.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.normalized_lorentzian_integral_intensity">
<code class="highlight language-python"><span class="n">normalized_lorentzian_integral_intensity</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-cached"><code>cached</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return (and cache) computed integrated intensities of the Lorentzian components, normalized so sum=1.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.peak_energy">
<code class="highlight language-python"><span class="n">peak_energy</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-cached"><code>cached</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Find the peak energy of the line shape assuming ideal instrument resolution.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.reference">
<code class="highlight language-python"><span class="n">reference</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>The full comment and/or citation for the reference data.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.shortname">
<code class="highlight language-python"><span class="n">shortname</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>A short name for the line, suitable for use as a dictionary key.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make the class callable, returning the same value as the self.pdf method.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make the class callable, returning the same value as the self.pdf method."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>String representation of the SpectralLine.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""String representation of the SpectralLine."""</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"SpectralLine: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.addline">
<code class="highlight language-python"><span class="n">addline</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">linetype</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">reference_short</span><span class="p">,</span> <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">,</span> <span class="n">nominal_peak_energy</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">lorentzian_fwhm</span><span class="p">,</span> <span class="n">reference_amplitude</span><span class="p">,</span> <span class="n">reference_amplitude_type</span><span class="p">,</span> <span class="n">ka12_energy_diff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position_uncertainty</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">intrinsic_sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reference_measurement_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_default_material</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Add a new SpectralLine to the <code>mass2.fluorescence_lines.spectra</code> dictionary, and as a variable in this module.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">addline</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">linetype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">reference_short</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nominal_peak_energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">lorentzian_fwhm</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">reference_amplitude</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">reference_amplitude_type</span><span class="p">:</span> <span class="n">AmplitudeType</span><span class="p">,</span>
    <span class="n">ka12_energy_diff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_uncertainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">intrinsic_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">reference_measurement_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">is_default_material</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_replacement</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"SpectralLine"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add a new SpectralLine to the `mass2.fluorescence_lines.spectra` dictionary, and as a variable in this module."""</span>
    <span class="c1"># require exactly one method of specifying the amplitude of each component</span>
    <span class="k">assert</span> <span class="n">reference_amplitude_type</span> <span class="ow">in</span> <span class="p">{</span>
        <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_PEAK_HEIGHT</span><span class="p">,</span>
        <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span><span class="p">,</span>
        <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">VOIGT_PEAK_HEIGHT</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># require the reference exists in lineshape_references</span>
    <span class="k">assert</span> <span class="n">reference_short</span> <span class="ow">in</span> <span class="n">lineshape_references</span>

    <span class="c1"># require kalpha lines to have ka12_energy_diff</span>
    <span class="k">if</span> <span class="n">linetype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"KAlpha"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ka12_energy_diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ka12_energy_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ka12_energy_diff</span><span class="p">)</span>
    <span class="c1"># require reference_plot_instrument_gaussian_fwhm to be a float or None</span>
    <span class="k">assert</span> <span class="n">reference_plot_instrument_gaussian_fwhm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">linetype</span><span class="o">=</span><span class="n">linetype</span><span class="p">,</span>
        <span class="n">nominal_peak_energy</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">nominal_peak_energy</span><span class="p">),</span>
        <span class="n">energies</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
        <span class="n">lorentzian_fwhm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lorentzian_fwhm</span><span class="p">),</span>
        <span class="n">reference_amplitude</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reference_amplitude</span><span class="p">),</span>
        <span class="n">reference_amplitude_type</span><span class="o">=</span><span class="n">reference_amplitude_type</span><span class="p">,</span>
        <span class="n">reference_measurement_type</span><span class="o">=</span><span class="n">reference_measurement_type</span><span class="p">,</span>
        <span class="n">intrinsic_sigma</span><span class="o">=</span><span class="n">intrinsic_sigma</span><span class="p">,</span>
        <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="p">,</span>
        <span class="n">reference_short</span><span class="o">=</span><span class="n">reference_short</span><span class="p">,</span>
        <span class="n">position_uncertainty</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">position_uncertainty</span><span class="p">),</span>
        <span class="n">is_default_material</span><span class="o">=</span><span class="n">is_default_material</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">shortname</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spectra</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_replacement</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"spectrum </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists"</span><span class="p">)</span>

    <span class="c1"># Add this SpectralLine to spectra dict AND make it be a variable in the module</span>
    <span class="n">spectra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
    <span class="k">return</span> <span class="n">line</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.components">
<code class="highlight language-python"><span class="n">components</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>List of spectrum components as a function of <x>, the energy in eV</x></p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""List of spectrum components as a function of &lt;x&gt;, the energy in eV"""</span>
    <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_integral_intensity</span><span class="p">):</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ampl</span> <span class="o">*</span> <span class="n">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">hwhm</span><span class="o">=</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">gaussian_sigma</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">components</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.fitter">
<code class="highlight language-python"><span class="n">fitter</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Generate a GenericLineModel instance for fitting this SpectralLine.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fitter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate a GenericLineModel instance for fitting this SpectralLine."""</span>
    <span class="n">fitter_class</span> <span class="o">=</span> <span class="n">GenericLineModel</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">fitter_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">f</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.minimum_fwhm">
<code class="highlight language-python"><span class="n">minimum_fwhm</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>for the narrowest lorentzian in the line model, calculate the combined fwhm including
the lorentzian, intrinstic_sigma, and instrument_gaussian_fwhm</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">minimum_fwhm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""for the narrowest lorentzian in the line model, calculate the combined fwhm including</span>
<span class="sd">    the lorentzian, intrinstic_sigma, and instrument_gaussian_fwhm"""</span>
    <span class="n">fwhm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_sigma</span> <span class="o">*</span> <span class="n">FWHM_OVER_SIGMA</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fwhm2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.model">
<code class="highlight language-python"><span class="n">model</span><span class="p">(</span><span class="n">has_linear_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">qemodel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Generate a LineModel instance from a SpectralLine</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span> <span class="n">qemodel</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate a LineModel instance from a SpectralLine"""</span>
    <span class="n">model_class</span> <span class="o">=</span> <span class="n">GenericLineModel</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">spect</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">qemodel</span><span class="o">=</span><span class="n">qemodel</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.pdf">
<code class="highlight language-python"><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Spectrum (units of fraction per eV) as a function of <x>, the energy in eV</x></p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Spectrum (units of fraction per eV) as a function of &lt;x&gt;, the energy in eV"""</span>
    <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized_lorentzian_integral_intensity</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">ampl</span> <span class="o">*</span> <span class="n">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">hwhm</span><span class="o">=</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">gaussian_sigma</span><span class="p">)</span>
        <span class="c1"># mass2.voigt() is normalized to have unit integrated intensity</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setylim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the spectrum.
x - np array of energy in eV to plot at (sensible default)
axis - axis to plot on (default creates new figure)
components - True plots each voigt component in addition to the spectrum
label - a string to label the plot with (optional)</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">setylim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the spectrum.</span>
<span class="sd">    x - np array of energy in eV to plot at (sensible default)</span>
<span class="sd">    axis - axis to plot on (default creates new figure)</span>
<span class="sd">    components - True plots each voigt component in addition to the spectrum</span>
<span class="sd">    label - a string to label the plot with (optional)"""</span>
    <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gaussian_sigma</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">)))</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">components</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">):</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="s2">"--"</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Energy (eV)"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> eV bin"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">setylim</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> with resolution </span><span class="si">{</span><span class="n">instrument_gaussian_fwhm</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV FWHM"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axis</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.plot_like_reference">
<code class="highlight language-python"><span class="n">plot_like_reference</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the spectrum to match the instrument resolution used in the reference data publication, if known.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_like_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the spectrum to match the instrument resolution used in the reference data publication, if known."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_plot_instrument_gaussian_fwhm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_plot_instrument_gaussian_fwhm</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axis</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.quick_monochromatic_line">
<code class="highlight language-python"><span class="n">quick_monochromatic_line</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">lorentzian_fwhm</span><span class="p">,</span> <span class="n">intrinsic_sigma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a quick monochromatic line. Intended for use in calibration when we know a line energy, but not a lineshape model.
Returns and instrance of SpectralLine with most fields having contents like "unknown: quick_line". The line will have
a single lorentzian element with the given energy, fwhm, and intrinsic_sigma values.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">quick_monochromatic_line</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lorentzian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">intrinsic_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"SpectralLine"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a quick monochromatic line. Intended for use in calibration when we know a line energy, but not a lineshape model.</span>
<span class="sd">    Returns and instrance of SpectralLine with most fields having contents like "unknown: quick_line". The line will have</span>
<span class="sd">    a single lorentzian element with the given energy, fwhm, and intrinsic_sigma values.</span>
<span class="sd">    """</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">material</span> <span class="o">=</span> <span class="s2">"unknown: quick_line"</span>
    <span class="k">if</span> <span class="n">lorentzian_fwhm</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">intrinsic_sigma</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="n">intrinsic_sigma</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">linetype</span> <span class="o">=</span> <span class="s2">"Gaussian"</span>
    <span class="n">reference_short</span> <span class="o">=</span> <span class="s2">"unknown: quick_line"</span>
    <span class="n">reference_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">reference_amplitude_type</span> <span class="o">=</span> <span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_INTEGRAL_INTENSITY</span>
    <span class="n">nominal_peak_energy</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">position_uncertainty</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">reference_measurement_type</span> <span class="o">=</span> <span class="s2">"unkown: quick_line"</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span>
        <span class="n">linetype</span><span class="o">=</span><span class="n">linetype</span><span class="p">,</span>
        <span class="n">energies</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energy</span><span class="p">]),</span>
        <span class="n">lorentzian_fwhm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lorentzian_fwhm</span><span class="p">]),</span>
        <span class="n">intrinsic_sigma</span><span class="o">=</span><span class="n">intrinsic_sigma</span><span class="p">,</span>
        <span class="n">reference_short</span><span class="o">=</span><span class="n">reference_short</span><span class="p">,</span>
        <span class="n">reference_amplitude</span><span class="o">=</span><span class="n">reference_amplitude</span><span class="p">,</span>
        <span class="n">reference_amplitude_type</span><span class="o">=</span><span class="n">reference_amplitude_type</span><span class="p">,</span>
        <span class="n">nominal_peak_energy</span><span class="o">=</span><span class="n">nominal_peak_energy</span><span class="p">,</span>
        <span class="n">position_uncertainty</span><span class="o">=</span><span class="n">position_uncertainty</span><span class="p">,</span>
        <span class="n">reference_measurement_type</span><span class="o">=</span><span class="n">reference_measurement_type</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.SpectralLine.rvs">
<code class="highlight language-python"><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>The CDF and PPF (cumulative distribution and percentile point functions) are hard to
compute.  But it's easy enough to generate the random variates themselves, so we
override that method.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The CDF and PPF (cumulative distribution and percentile point functions) are hard to</span>
<span class="sd">    compute.  But it's easy enough to generate the random variates themselves, so we</span>
<span class="sd">    override that method."""</span>
    <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">_rng</span>
    <span class="n">gaussian_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_sigma</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
    <span class="c1"># Choose from among the N Lorentzian lines in proportion to the line amplitudes</span>
    <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_amplitudes</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_amplitudes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">))</span>
    <span class="c1"># Choose Lorentzian variates of the appropriate width (but centered on 0)</span>
    <span class="n">lor</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_cauchy</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lorentzian_fwhm</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="c1"># If necessary, add a Gaussian variate to mimic finite resolution</span>
    <span class="k">if</span> <span class="n">gaussian_sigma</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">lor</span> <span class="o">+=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian_sigma</span>
    <span class="c1"># Finally, add the line centers.</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">lor</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">energies</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
    <span class="c1"># We must check for non-positive results and replace them by recursive call</span>
    <span class="c1"># to self.rvs().</span>
    <span class="n">not_positive</span> <span class="o">=</span> <span class="n">results</span> <span class="o">&lt;=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">not_positive</span><span class="p">):</span>
        <span class="n">Nbad</span> <span class="o">=</span> <span class="n">not_positive</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="n">not_positive</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">Nbad</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.LineEnergies">
<code class="highlight language-python"><span class="n">LineEnergies</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>A dictionary to know a lot of x-ray fluorescence line energies, based on Deslattes' database.</p>
<p>It is built on facts from mass2.calibration.nist_xray_database module.</p>
<p>It is a dictionary from peak name to energy, with several alternate names
for the lines:</p>
<p>E = Energies()
print E["MnKAlpha"]
print E["MnKAlpha"], E["MnKA"], E["MnKA1"], E["MnKL3"]</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">LineEnergies</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A dictionary to know a lot of x-ray fluorescence line energies, based on Deslattes' database.</span>

<span class="sd">    It is built on facts from mass2.calibration.nist_xray_database module.</span>

<span class="sd">    It is a dictionary from peak name to energy, with several alternate names</span>
<span class="sd">    for the lines:</span>

<span class="sd">    E = Energies()</span>
<span class="sd">    print E["MnKAlpha"]</span>
<span class="sd">    print E["MnKAlpha"], E["MnKA"], E["MnKA1"], E["MnKL3"]</span>
<span class="sd">    """</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">NISTXrayDBFile</span><span class="p">()</span>
    <span class="n">alternate_line_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">element</span><span class="p">,</span> <span class="n">linename</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">allnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">linename</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">linename</span> <span class="ow">in</span> <span class="n">alternate_line_names</span><span class="p">:</span>
            <span class="n">siegbahn_linename</span> <span class="o">=</span> <span class="n">alternate_line_names</span><span class="p">[</span><span class="n">linename</span><span class="p">]</span>
            <span class="n">long_linename</span> <span class="o">=</span> <span class="n">siegbahn_linename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"Alpha"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="s2">"Beta"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"G"</span><span class="p">,</span> <span class="s2">"Gamma"</span><span class="p">)</span>

            <span class="n">allnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">siegbahn_linename</span><span class="p">)</span>
            <span class="n">allnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long_linename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">siegbahn_linename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"1"</span><span class="p">):</span>
                <span class="n">allnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">siegbahn_linename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">allnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long_linename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">allnames</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">element</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">peak</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.fluorescence_lines.plot_all_spectra">
<code class="highlight language-python"><span class="n">plot_all_spectra</span><span class="p">(</span><span class="n">maxplots</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Makes plots showing the line shape and component parts for some lines.
Intended to replicate plots in the literature giving spectral lineshapes.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/fluorescence_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_all_spectra</span><span class="p">(</span><span class="n">maxplots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Makes plots showing the line shape and component parts for some lines.</span>
<span class="sd">    Intended to replicate plots in the literature giving spectral lineshapes."""</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectra</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="n">maxplots</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_like_reference</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.line_models"></a>
<div class="doc doc-contents first">
<p>Implements MLEModel, CompositeMLEModel, GenericLineModel</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.line_models.CompositeMLEModel">
<code>CompositeMLEModel</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="MLEModel (mass2.calibration.line_models.MLEModel)" href="#mass2.calibration.line_models.MLEModel">MLEModel</a></code>, <code><span title="lmfit.CompositeModel">CompositeModel</span></code></p>
<p>A version of lmfit.CompositeModel that uses Maximum Likelihood weights
in place of chisq, as described in: doi:10.1007/s10909-014-1098-4
"Maximum-Likelihood Fits to Histograms for Improved Parameter Estimation"</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompositeMLEModel</span><span class="p">(</span><span class="n">MLEModel</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">CompositeModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A version of lmfit.CompositeModel that uses Maximum Likelihood weights</span>
<span class="sd">    in place of chisq, as described in: doi:10.1007/s10909-014-1098-4</span>
<span class="sd">    "Maximum-Likelihood Fits to Histograms for Improved Parameter Estimation"</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the chi_MLE^2 value from Joe Fowler's Paper</span>
<span class="sd">        doi:10.1007/s10909-014-1098-4 Maximum-Likelihood Fits to Histograms for Improved Parameter Estimation</span>
<span class="sd">        """</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">data</span>
        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">r2</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">data</span> <span class="o">/</span> <span class="n">y</span><span class="p">)[</span><span class="n">nonzero</span><span class="p">])</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">vals</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Sum of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Difference of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Product of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Ratio of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.CompositeMLEModel.__add__">
<code class="highlight language-python"><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Sum of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Sum of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.CompositeMLEModel.__mul__">
<code class="highlight language-python"><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Product of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Product of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.CompositeMLEModel.__sub__">
<code class="highlight language-python"><span class="fm">__sub__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Difference of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Difference of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.CompositeMLEModel.__truediv__">
<code class="highlight language-python"><span class="fm">__truediv__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Ratio of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Ratio of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.line_models.GenericLineModel">
<code>GenericLineModel</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="MLEModel (mass2.calibration.line_models.MLEModel)" href="#mass2.calibration.line_models.MLEModel">MLEModel</a></code></p>
<p>A generic line model for fitting spectral lines.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GenericLineModel</span><span class="p">(</span><span class="n">MLEModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A generic line model for fitting spectral lines."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spect</span><span class="p">:</span> <span class="s2">"SpectralLine"</span><span class="p">,</span>
        <span class="n">independent_vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"bin_centers"</span><span class="p">],</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
        <span class="n">nan_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"raise"</span><span class="p">,</span>
        <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">qemodel</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize a GenericLineModel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spect : SpectralLine</span>
<span class="sd">            The line or feature to be modeled</span>
<span class="sd">        independent_vars : list[str], optional</span>
<span class="sd">            List of independent variable names, by default ["bin_centers"]</span>
<span class="sd">        prefix : str, optional</span>
<span class="sd">            Model, by default ""</span>
<span class="sd">        nan_policy : str, optional</span>
<span class="sd">            How to handle NaN results in the computed spectrum, by default "raise"</span>
<span class="sd">        has_linear_background : bool, optional</span>
<span class="sd">            Whether the background model can have a nonzero slope, by default True</span>
<span class="sd">        has_tails : bool, optional</span>
<span class="sd">            Whether exponential tails are included in the model, by default False</span>
<span class="sd">        qemodel : Callable | None, optional</span>
<span class="sd">            A model for the quantum efficiency (which changes the expected line shape), by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GenericLineModel</span>
<span class="sd">            The initialized model</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the spectral model produces negative or NaN values</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spect</span> <span class="o">=</span> <span class="n">spect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_tails</span> <span class="o">=</span> <span class="n">has_tails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_linear_background</span> <span class="o">=</span> <span class="n">has_linear_background</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"fwhm"</span><span class="p">,</span> <span class="s2">"peak_ph"</span><span class="p">,</span> <span class="s2">"dph_de"</span><span class="p">,</span> <span class="s2">"integral"</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_linear_background</span><span class="p">:</span>
            <span class="n">param_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"background"</span><span class="p">,</span> <span class="s2">"bg_slope"</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_tails</span><span class="p">:</span>
            <span class="n">param_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"tail_frac"</span><span class="p">,</span> <span class="s2">"tail_tau"</span><span class="p">,</span> <span class="s2">"tail_share_hi"</span><span class="p">,</span> <span class="s2">"tail_tau_hi"</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"prefix"</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">"nan_policy"</span><span class="p">:</span> <span class="n">nan_policy</span><span class="p">,</span> <span class="s2">"independent_vars"</span><span class="p">:</span> <span class="n">independent_vars</span><span class="p">,</span> <span class="s2">"param_names"</span><span class="p">:</span> <span class="n">param_names</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">has_tails</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">modelfunctails</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
                <span class="n">bin_centers</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
                <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">peak_ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">dph_de</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">integral</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">background</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">bg_slope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">tail_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">tail_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                <span class="n">tail_share_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">tail_tau_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
                <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">-</span> <span class="n">peak_ph</span><span class="p">)</span> <span class="o">/</span> <span class="n">dph_de</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">cleanspectrum_fn</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>

                <span class="c1"># tail_tau* is in energy units but has to be converted to the same units as `bin_centers`</span>
                <span class="n">tail_arbs_lo</span> <span class="o">=</span> <span class="n">tail_tau</span> <span class="o">*</span> <span class="n">dph_de</span>
                <span class="n">tail_arbs_hi</span> <span class="o">=</span> <span class="n">tail_tau_hi</span> <span class="o">*</span> <span class="n">dph_de</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="n">_smear_exponential_tail</span><span class="p">(</span>
                    <span class="n">cleanspectrum_fn</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">tail_frac</span><span class="p">,</span> <span class="n">tail_arbs_lo</span><span class="p">,</span> <span class="n">tail_share_hi</span><span class="p">,</span> <span class="n">tail_arbs_hi</span>
                <span class="p">)</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">*</span> <span class="n">bin_width</span> <span class="o">*</span> <span class="n">dph_de</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">_scale_add_bg</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">bg_slope</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"some entry in r is nan or negative"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qemodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">r</span>
                <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">qemodel</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">modelfunctails</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">modelfunc</span><span class="p">(</span>
                <span class="n">bin_centers</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
                <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">peak_ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">dph_de</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">integral</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">background</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">bg_slope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
                <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">-</span> <span class="n">peak_ph</span><span class="p">)</span> <span class="o">/</span> <span class="n">dph_de</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">*</span> <span class="n">bin_width</span> <span class="o">/</span> <span class="n">dph_de</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">_scale_add_bg</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">bg_slope</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"some entry in r is nan or negative"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qemodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">r</span>
                <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">qemodel</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">modelfunc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_paramhints_prefix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_paramhints_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set parameter hints with reasonable initial values and bounds."""</span>
        <span class="n">nominal_peak_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">nominal_peak_energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"fwhm"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">nominal_peak_energy</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">nominal_peak_energy</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">nominal_peak_energy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"peak_ph"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">nominal_peak_energy</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"dph_de"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"integral"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_linear_background</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"background"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"bg_slope"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_tails</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"tail_frac"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"tail_tau"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">nominal_peak_energy</span> <span class="o">/</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">nominal_peak_energy</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"tail_share_hi"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s2">"tail_tau_hi"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">nominal_peak_energy</span> <span class="o">/</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">nominal_peak_energy</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dph_de</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">:</span>
        <span class="s2">"Guess values for the peak_ph, integral, and background."</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span>
        <span class="n">order_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">percentiles</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Find the p-th percentile of the data using histograms."""</span>
            <span class="k">return</span> <span class="n">bin_centers</span><span class="p">[(</span><span class="n">order_stat</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>

        <span class="n">fwhm_arb</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="n">percentiles</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">percentiles</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span>
        <span class="n">peak_ph</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="c1"># Ensure baseline guess &gt; 0 (see Issue #152). Guess at least 1 background across all bins</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">tcounts_above_bg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">baseline</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tcounts_above_bg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tcounts_above_bg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># lets avoid negative estimates for the integral</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">peak_ph</span><span class="o">=</span><span class="n">peak_ph</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">integral</span><span class="o">=</span><span class="n">tcounts_above_bg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm_arb</span> <span class="o">/</span> <span class="n">dph_de</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="n">dph_de</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">update_param_vals</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.GenericLineModel.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">spect</span><span class="p">,</span> <span class="n">independent_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">'bin_centers'</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">'raise'</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qemodel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Initialize a GenericLineModel</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>spect</code></b>
                  (<code><a class="autorefs autorefs-internal" title="SpectralLine


  
      dataclass
   (mass2.calibration.fluorescence_lines.SpectralLine)" href="#mass2.calibration.fluorescence_lines.SpectralLine">SpectralLine</a></code>)
              –
              <div class="doc-md-description">
<p>The line or feature to be modeled</p>
</div>
</li>
<li>
<b><code>independent_vars</code></b>
                  (<code><span title="list">list</span>[<span title="str">str</span>]</code>, default:
                      <code>['bin_centers']</code>
)
              –
              <div class="doc-md-description">
<p>List of independent variable names, by default ["bin_centers"]</p>
</div>
</li>
<li>
<b><code>prefix</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>''</code>
)
              –
              <div class="doc-md-description">
<p>Model, by default ""</p>
</div>
</li>
<li>
<b><code>nan_policy</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'raise'</code>
)
              –
              <div class="doc-md-description">
<p>How to handle NaN results in the computed spectrum, by default "raise"</p>
</div>
</li>
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
<p>Whether the background model can have a nonzero slope, by default True</p>
</div>
</li>
<li>
<b><code>has_tails</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>Whether exponential tails are included in the model, by default False</p>
</div>
</li>
<li>
<b><code>qemodel</code></b>
                  (<code><span title="collections.abc.Callable">Callable</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>A model for the quantum efficiency (which changes the expected line shape), by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>The initialized model</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>If the spectral model produces negative or NaN values</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">spect</span><span class="p">:</span> <span class="s2">"SpectralLine"</span><span class="p">,</span>
    <span class="n">independent_vars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"bin_centers"</span><span class="p">],</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
    <span class="n">nan_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"raise"</span><span class="p">,</span>
    <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">qemodel</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize a GenericLineModel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spect : SpectralLine</span>
<span class="sd">        The line or feature to be modeled</span>
<span class="sd">    independent_vars : list[str], optional</span>
<span class="sd">        List of independent variable names, by default ["bin_centers"]</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        Model, by default ""</span>
<span class="sd">    nan_policy : str, optional</span>
<span class="sd">        How to handle NaN results in the computed spectrum, by default "raise"</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        Whether the background model can have a nonzero slope, by default True</span>
<span class="sd">    has_tails : bool, optional</span>
<span class="sd">        Whether exponential tails are included in the model, by default False</span>
<span class="sd">    qemodel : Callable | None, optional</span>
<span class="sd">        A model for the quantum efficiency (which changes the expected line shape), by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        The initialized model</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the spectral model produces negative or NaN values</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spect</span> <span class="o">=</span> <span class="n">spect</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_has_tails</span> <span class="o">=</span> <span class="n">has_tails</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_has_linear_background</span> <span class="o">=</span> <span class="n">has_linear_background</span>

    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"fwhm"</span><span class="p">,</span> <span class="s2">"peak_ph"</span><span class="p">,</span> <span class="s2">"dph_de"</span><span class="p">,</span> <span class="s2">"integral"</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_linear_background</span><span class="p">:</span>
        <span class="n">param_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"background"</span><span class="p">,</span> <span class="s2">"bg_slope"</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_tails</span><span class="p">:</span>
        <span class="n">param_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"tail_frac"</span><span class="p">,</span> <span class="s2">"tail_tau"</span><span class="p">,</span> <span class="s2">"tail_share_hi"</span><span class="p">,</span> <span class="s2">"tail_tau_hi"</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"prefix"</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">"nan_policy"</span><span class="p">:</span> <span class="n">nan_policy</span><span class="p">,</span> <span class="s2">"independent_vars"</span><span class="p">:</span> <span class="n">independent_vars</span><span class="p">,</span> <span class="s2">"param_names"</span><span class="p">:</span> <span class="n">param_names</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">has_tails</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">modelfunctails</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
            <span class="n">bin_centers</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
            <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">peak_ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">dph_de</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">integral</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">background</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">bg_slope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">tail_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">tail_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">tail_share_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">tail_tau_hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
            <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">-</span> <span class="n">peak_ph</span><span class="p">)</span> <span class="o">/</span> <span class="n">dph_de</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">cleanspectrum_fn</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">instrument_gaussian_fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>

            <span class="c1"># tail_tau* is in energy units but has to be converted to the same units as `bin_centers`</span>
            <span class="n">tail_arbs_lo</span> <span class="o">=</span> <span class="n">tail_tau</span> <span class="o">*</span> <span class="n">dph_de</span>
            <span class="n">tail_arbs_hi</span> <span class="o">=</span> <span class="n">tail_tau_hi</span> <span class="o">*</span> <span class="n">dph_de</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">_smear_exponential_tail</span><span class="p">(</span>
                <span class="n">cleanspectrum_fn</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">tail_frac</span><span class="p">,</span> <span class="n">tail_arbs_lo</span><span class="p">,</span> <span class="n">tail_share_hi</span><span class="p">,</span> <span class="n">tail_arbs_hi</span>
            <span class="p">)</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">*</span> <span class="n">bin_width</span> <span class="o">*</span> <span class="n">dph_de</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">_scale_add_bg</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">bg_slope</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"some entry in r is nan or negative"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qemodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">qemodel</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">modelfunctails</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">modelfunc</span><span class="p">(</span>
            <span class="n">bin_centers</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
            <span class="n">fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">peak_ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">dph_de</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">integral</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">background</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">bg_slope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
            <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">-</span> <span class="n">peak_ph</span><span class="p">)</span> <span class="o">/</span> <span class="n">dph_de</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">*</span> <span class="n">bin_width</span> <span class="o">/</span> <span class="n">dph_de</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">_scale_add_bg</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">bg_slope</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"some entry in r is nan or negative"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qemodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">qemodel</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">modelfunc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_set_paramhints_prefix</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.GenericLineModel.guess">
<code class="highlight language-python"><span class="n">guess</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Guess values for the peak_ph, integral, and background.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dph_de</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">:</span>
    <span class="s2">"Guess values for the peak_ph, integral, and background."</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span>
    <span class="n">order_stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">percentiles</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Find the p-th percentile of the data using histograms."""</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">[(</span><span class="n">order_stat</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>

    <span class="n">fwhm_arb</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="n">percentiles</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">percentiles</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span>
    <span class="n">peak_ph</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="c1"># Ensure baseline guess &gt; 0 (see Issue #152). Guess at least 1 background across all bins</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">tcounts_above_bg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">baseline</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tcounts_above_bg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tcounts_above_bg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># lets avoid negative estimates for the integral</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">peak_ph</span><span class="o">=</span><span class="n">peak_ph</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">integral</span><span class="o">=</span><span class="n">tcounts_above_bg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm_arb</span> <span class="o">/</span> <span class="n">dph_de</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="n">dph_de</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">update_param_vals</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.line_models.LineModelResult">
<code>LineModelResult</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="lmfit.model.ModelResult">ModelResult</span></code></p>
<p>like lmfit.model.Model result, but with some convenient plotting functions for line spectra fits</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LineModelResult</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ModelResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""like lmfit.model.Model result, but with some convenient plotting functions for line spectra fits"""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compact_fit_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A compact fit report suitable for annotating a plot"""</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"background"</span><span class="p">:</span> <span class="s2">"bg"</span><span class="p">,</span> <span class="s2">"integral"</span><span class="p">:</span> <span class="s2">"intgrl"</span><span class="p">,</span> <span class="s2">"bg_slope"</span><span class="p">:</span> <span class="s2">"bg_slp"</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sig_figs</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="s2">7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2">±None</span><span class="se">\n</span><span class="s2">"</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sig_figs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">v</span><span class="o">.</span><span class="n">stderr</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">sig_figs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sig_figs</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="s2">7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2">±</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">stderr</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig_figs</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="s2">7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">sig_figs</span><span class="si">}</span><span class="s2">g</span><span class="si">}</span><span class="s2"> HELD</span><span class="se">\n</span><span class="s2">"</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"redchi  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">redchi</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plotm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""plot the data, the fit, and annotate the plot with the parameters"""</span>
        <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_default_labels</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ModelResult</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="mf">0.95</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compact_fit_report</span><span class="p">(),</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">"top"</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">"w"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">family</span><span class="o">=</span><span class="s2">"monospace"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># ax.legend(["data", self._compact_fit_report()],loc='best', frameon=True, framealpha = 0.5)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_label_hints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ds_shortname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unit_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cut_hint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">states_hint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set hints for axis labels and title for plotm()."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binsize</span> <span class="o">=</span> <span class="n">binsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_shortname</span> <span class="o">=</span> <span class="n">ds_shortname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_str</span> <span class="o">=</span> <span class="n">attr_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_str</span> <span class="o">=</span> <span class="n">unit_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cut_hint</span> <span class="o">=</span> <span class="n">cut_hint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_states_hint</span> <span class="o">=</span> <span class="n">states_hint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_label_hints</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_default_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Handle default labels for plotm()."""</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_has_label_hints"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds_shortname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"counts per </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_binsize</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_str</span><span class="si">}</span><span class="s2"> bin"</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_states_hint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">states=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_states_hint</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cut_hint</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_str</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_str</span><span class="si">}</span><span class="s2">)"</span>
        <span class="k">elif</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">"bin_centers"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkws</span><span class="p">:</span>
            <span class="n">binsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkws</span><span class="p">[</span><span class="s2">"bin_centers"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkws</span><span class="p">[</span><span class="s2">"bin_centers"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"counts per </span><span class="si">{</span><span class="n">binsize</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> unit bin"</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">return</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_bins_per_fwhm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Validate that the bin size is small enough compared to the fitted FWHM to prevent approximation problems."""</span>
        <span class="k">if</span> <span class="s2">"bin_centers"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkws</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># i guess someone used this for a non histogram fit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">VALIDATE_BIN_SIZE</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkws</span><span class="p">[</span><span class="s2">"bin_centers"</span><span class="p">]</span>
        <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iComp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">iComp</span><span class="o">.</span><span class="n">prefix</span>
            <span class="n">dphde</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">dph_de"</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">fwhm"</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dphde</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fwhm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">):</span>
                <span class="n">bin_size_energy</span> <span class="o">=</span> <span class="n">bin_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">dphde</span><span class="p">]</span>
                <span class="n">instrument_gaussian_fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">fwhm</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">minimum_fwhm_energy</span> <span class="o">=</span> <span class="n">iComp</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">minimum_fwhm</span><span class="p">(</span><span class="n">instrument_gaussian_fwhm</span><span class="p">)</span>
                <span class="n">bins_per_fwhm</span> <span class="o">=</span> <span class="n">minimum_fwhm_energy</span> <span class="o">/</span> <span class="n">bin_size_energy</span>
                <span class="k">if</span> <span class="n">bins_per_fwhm</span> <span class="o">&lt;</span> <span class="n">minimum_bins_per_fwhm</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""bins are too large.</span>
<span class="s2">Bin size (energy units) = </span><span class="si">{</span><span class="n">bin_size_energy</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, fit FWHM (energy units) = </span><span class="si">{</span><span class="n">instrument_gaussian_fwhm</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span>
<span class="s2">Minimum FWHM accounting for narrowest Lorentzian in spectrum (energy units) = </span><span class="si">{</span><span class="n">minimum_fwhm_energy</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span>
<span class="s2">Bins per FWHM = </span><span class="si">{</span><span class="n">bins_per_fwhm</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, Minimum Bins per FWHM = </span><span class="si">{</span><span class="n">minimum_bins_per_fwhm</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span>
<span class="s2">To avoid this error:</span>
<span class="s2">1. use smaller bins, or</span>
<span class="s2">2. pass a smaller value of `minimum_bins_per_fwhm` to .fit, or</span>
<span class="s2">3. set `mass2.calibration.line_models.VALIDATE_BIN_SIZE = False`.</span>
<span class="s2">See https://github.com/usnistgov/mass/issues/162 for discussion on this issue"""</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.LineModelResult.plotm">
<code class="highlight language-python"><span class="n">plotm</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>plot the data, the fit, and annotate the plot with the parameters</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plotm</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""plot the data, the fit, and annotate the plot with the parameters"""</span>
    <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_default_labels</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ModelResult</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mf">0.05</span><span class="p">,</span>
        <span class="mf">0.95</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compact_fit_report</span><span class="p">(),</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">"top"</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">"w"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="n">family</span><span class="o">=</span><span class="s2">"monospace"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># ax.legend(["data", self._compact_fit_report()],loc='best', frameon=True, framealpha = 0.5)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.LineModelResult.set_label_hints">
<code class="highlight language-python"><span class="n">set_label_hints</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">ds_shortname</span><span class="p">,</span> <span class="n">attr_str</span><span class="p">,</span> <span class="n">unit_str</span><span class="p">,</span> <span class="n">cut_hint</span><span class="p">,</span> <span class="n">states_hint</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set hints for axis labels and title for plotm().</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_label_hints</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ds_shortname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unit_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cut_hint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">states_hint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Set hints for axis labels and title for plotm()."""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_binsize</span> <span class="o">=</span> <span class="n">binsize</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ds_shortname</span> <span class="o">=</span> <span class="n">ds_shortname</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_attr_str</span> <span class="o">=</span> <span class="n">attr_str</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unit_str</span> <span class="o">=</span> <span class="n">unit_str</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cut_hint</span> <span class="o">=</span> <span class="n">cut_hint</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_states_hint</span> <span class="o">=</span> <span class="n">states_hint</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_has_label_hints</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel">
<code>MLEModel</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="lmfit.Model">Model</span></code></p>
<p>A version of lmfit.Model that uses Maximum Likelihood weights
in place of chisq, as described in: doi:10.1007/s10909-014-1098-4
"Maximum-Likelihood Fits to Histograms for Improved Parameter Estimation"</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MLEModel</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A version of lmfit.Model that uses Maximum Likelihood weights</span>
<span class="sd">    in place of chisq, as described in: doi:10.1007/s10909-014-1098-4</span>
<span class="sd">    "Maximum-Likelihood Fits to Histograms for Improved Parameter Estimation"</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the chi_MLE^2 value from Joe Fowler's Paper</span>
<span class="sd">        doi:10.1007/s10909-014-1098-4 "Maximum-Likelihood Fits to Histograms for Improved Parameter Estimation"</span>
<span class="sd">        """</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">data</span>
        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">r2</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">data</span> <span class="o">/</span> <span class="n">y</span><span class="p">)[</span><span class="n">nonzero</span><span class="p">])</span>
        <span class="c1"># points that are zero do not effect the chisq value, so should not</span>
        <span class="c1"># be inlcuded in the calculate on ndegrees of freedome, and therefore reduced chisq</span>
        <span class="c1"># GCO tried setting self.ndata here, but it doesn't persist</span>
        <span class="c1"># not clear how to calculate reduced chisq correctly</span>

        <span class="c1"># Calculate the sqrt(2*r2) in place into vals.</span>
        <span class="c1"># The mask for r2&gt;0 avoids the problem found in MASS issue #217.</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">nonneg</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">nonneg</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r2</span><span class="p">[</span><span class="n">nonneg</span><span class="p">])</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">vals</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return representation of Model."""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reprstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a longer string representation of Model, with its options."""</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"prefix='</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">long</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">='</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">)"</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Sum of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Difference of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Product of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Ratio of two models"""</span>
        <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LineModelResult"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""as lmfit.Model.fit except</span>
<span class="sd">        1. the default method is "least_squares because it gives error bars more often at 1.5-2.0X speed penalty</span>
<span class="sd">        2. supports "leastsq_refit" which uses "leastsq" to fit, but if there are no error bars, refits with</span>
<span class="sd">        "least_squares" call result.set_label_hints(...) then result.plotm() for a nice plot.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="s2">"method"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># change default method</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"least_squares"</span>
            <span class="c1"># least_squares always gives uncertainties, while the normal default leastsq often does not</span>
            <span class="c1"># leastsq fails to give uncertaities if parameters are near bounds or at their initial value</span>
            <span class="c1"># least_squares is about 1.5X to 2.0X slower based on two test case</span>
        <span class="k">if</span> <span class="n">minimum_bins_per_fwhm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minimum_bins_per_fwhm</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># provide default value</span>
        <span class="k">if</span> <span class="s2">"weights"</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"weights"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"MLEModel assumes Poisson-distributed data; cannot use weights other than None"</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">LineModelResult</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_validate_bins_per_fwhm</span><span class="p">(</span><span class="n">minimum_bins_per_fwhm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LineModelResult"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""internal implementation of fit to add support for "leastsq_refit" method"""</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"method"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"leastsq_refit"</span><span class="p">:</span>
            <span class="c1"># First fit with leastsq (the fastest method)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"leastsq"</span>
            <span class="n">result0</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result0</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result0</span><span class="o">.</span><span class="n">errorbars</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result0</span>

            <span class="c1"># If we didn't get uncertainties, fit again with least_squares</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"least_squares"</span>
            <span class="k">if</span> <span class="s2">"params"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">"params"</span><span class="p">]</span> <span class="o">=</span> <span class="n">result0</span><span class="o">.</span><span class="n">params</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">result0</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">arg</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel.__add__">
<code class="highlight language-python"><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Sum of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Sum of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel.__mul__">
<code class="highlight language-python"><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Product of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Product of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return representation of Model.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return representation of Model."""</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;"</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel.__sub__">
<code class="highlight language-python"><span class="fm">__sub__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Difference of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Difference of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel.__truediv__">
<code class="highlight language-python"><span class="fm">__truediv__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Ratio of two models</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CompositeMLEModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Ratio of two models"""</span>
    <span class="k">return</span> <span class="n">CompositeMLEModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.line_models.MLEModel.fit">
<code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>as lmfit.Model.fit except
1. the default method is "least_squares because it gives error bars more often at 1.5-2.0X speed penalty
2. supports "leastsq_refit" which uses "leastsq" to fit, but if there are no error bars, refits with
"least_squares" call result.set_label_hints(...) then result.plotm() for a nice plot.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/line_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LineModelResult"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""as lmfit.Model.fit except</span>
<span class="sd">    1. the default method is "least_squares because it gives error bars more often at 1.5-2.0X speed penalty</span>
<span class="sd">    2. supports "leastsq_refit" which uses "leastsq" to fit, but if there are no error bars, refits with</span>
<span class="sd">    "least_squares" call result.set_label_hints(...) then result.plotm() for a nice plot.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="s2">"method"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># change default method</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"least_squares"</span>
        <span class="c1"># least_squares always gives uncertainties, while the normal default leastsq often does not</span>
        <span class="c1"># leastsq fails to give uncertaities if parameters are near bounds or at their initial value</span>
        <span class="c1"># least_squares is about 1.5X to 2.0X slower based on two test case</span>
    <span class="k">if</span> <span class="n">minimum_bins_per_fwhm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">minimum_bins_per_fwhm</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># provide default value</span>
    <span class="k">if</span> <span class="s2">"weights"</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"weights"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"MLEModel assumes Poisson-distributed data; cannot use weights other than None"</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">LineModelResult</span>
    <span class="n">result</span><span class="o">.</span><span class="n">_validate_bins_per_fwhm</span><span class="p">(</span><span class="n">minimum_bins_per_fwhm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div><h3 id="calibration-algorithms">Calibration algorithms</h3>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.algorithms"></a>
<div class="doc doc-contents first">
<p>This file is intended to include algorithms that could be generally useful
for calibration. Mostly they are pulled out of the former
mass.calibration.young module.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.FailedToGetModelException">
<code>FailedToGetModelException</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>
<p>Exception raised when get_model() fails to find a model for a line</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FailedToGetModelException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Exception raised when get_model() fails to find a model for a line"""</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.build_fit_ranges">
<code class="highlight language-python"><span class="n">build_fit_ranges</span><span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">excluded_line_names</span><span class="p">,</span> <span class="n">approx_ecal</span><span class="p">,</span> <span class="n">fit_width_ev</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Returns a list of (lo,hi) where lo and hi have units of energy of
ranges to fit in for each energy in line_names.</p>
<p>Args:
    line_names (list[str or float]): list or line names or energies
    excluded_line_names (list[str or float]): list of line_names or energies to
        avoid when making fit ranges
    approx_ecal: an EnergyCalibration object containing an approximate calibration
    fit_width_ev (float): full size in eV of fit ranges</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_fit_ranges</span><span class="p">(</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span> <span class="n">excluded_line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span> <span class="n">approx_ecal</span><span class="p">:</span> <span class="n">EnergyCalibration</span><span class="p">,</span> <span class="n">fit_width_ev</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""Returns a list of (lo,hi) where lo and hi have units of energy of</span>
<span class="sd">    ranges to fit in for each energy in line_names.</span>

<span class="sd">    Args:</span>
<span class="sd">        line_names (list[str or float]): list or line names or energies</span>
<span class="sd">        excluded_line_names (list[str or float]): list of line_names or energies to</span>
<span class="sd">            avoid when making fit ranges</span>
<span class="sd">        approx_ecal: an EnergyCalibration object containing an approximate calibration</span>
<span class="sd">        fit_width_ev (float): full size in eV of fit ranges</span>
<span class="sd">    """</span>
    <span class="n">_names</span><span class="p">,</span> <span class="n">e_e</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">_excl_names</span><span class="p">,</span> <span class="n">excl_e_e</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">excluded_line_names</span><span class="p">)</span>
    <span class="n">half_width_ev</span> <span class="o">=</span> <span class="n">fit_width_ev</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">all_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">e_e</span><span class="p">,</span> <span class="n">excl_e_e</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_e</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_e</span><span class="p">))</span>
    <span class="n">fit_lo_hi_energy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slopes_de_dph</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">e_e</span><span class="p">:</span>
        <span class="n">slope_de_dph</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">approx_ecal</span><span class="o">.</span><span class="n">energy2dedph</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">all_e</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">):</span>
            <span class="n">nearest_below</span> <span class="o">=</span> <span class="n">all_e</span><span class="p">[</span><span class="n">all_e</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nearest_below</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">all_e</span> <span class="o">&gt;</span> <span class="n">e</span><span class="p">):</span>
            <span class="n">nearest_above</span> <span class="o">=</span> <span class="n">all_e</span><span class="p">[</span><span class="n">all_e</span> <span class="o">&gt;</span> <span class="n">e</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nearest_above</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">half_width_ev</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">nearest_below</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">half_width_ev</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">nearest_above</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">fit_lo_hi_energy</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">))</span>
        <span class="n">slopes_de_dph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope_de_dph</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">e_e</span><span class="p">,</span> <span class="n">fit_lo_hi_energy</span><span class="p">,</span> <span class="n">slopes_de_dph</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.build_fit_ranges_ph">
<code class="highlight language-python"><span class="n">build_fit_ranges_ph</span><span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">excluded_line_names</span><span class="p">,</span> <span class="n">approx_ecal</span><span class="p">,</span> <span class="n">fit_width_ev</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Call build_fit_ranges() to get (lo,hi) for fitranges in energy units,
then convert to ph using approx_ecal</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_fit_ranges_ph</span><span class="p">(</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span> <span class="n">excluded_line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span> <span class="n">approx_ecal</span><span class="p">:</span> <span class="n">EnergyCalibration</span><span class="p">,</span> <span class="n">fit_width_ev</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""Call build_fit_ranges() to get (lo,hi) for fitranges in energy units,</span>
<span class="sd">    then convert to ph using approx_ecal"""</span>
    <span class="n">e_e</span><span class="p">,</span> <span class="n">fit_lo_hi_energy</span><span class="p">,</span> <span class="n">slopes_de_dph</span> <span class="o">=</span> <span class="n">build_fit_ranges</span><span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">excluded_line_names</span><span class="p">,</span> <span class="n">approx_ecal</span><span class="p">,</span> <span class="n">fit_width_ev</span><span class="p">)</span>
    <span class="n">fit_lo_hi_ph</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="ow">in</span> <span class="n">fit_lo_hi_energy</span><span class="p">:</span>
        <span class="n">lo_ph</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">approx_ecal</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">lo</span><span class="p">))</span>
        <span class="n">hi_ph</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">approx_ecal</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">hi</span><span class="p">))</span>
        <span class="n">fit_lo_hi_ph</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lo_ph</span><span class="p">,</span> <span class="n">hi_ph</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">e_e</span><span class="p">,</span> <span class="n">fit_lo_hi_ph</span><span class="p">,</span> <span class="n">slopes_de_dph</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.find_local_maxima">
<code class="highlight language-python"><span class="n">find_local_maxima</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">gaussian_fwhm</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Smears each pulse by a gaussian of gaussian_fhwm and finds local maxima,
returns a list of their locations in pulse_height units (sorted by number of
pulses in peak) AND their peak values as: (peak_locations, peak_intensities)</p>
<p>Args:
    pulse_heights (np.array(dtype=float)): a list of pulse heights (eg p_filt_value)
    gaussian_fwhm = fwhm of a gaussian that each pulse is smeared with, in same units as pulse heights</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_local_maxima</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Smears each pulse by a gaussian of gaussian_fhwm and finds local maxima,</span>
<span class="sd">    returns a list of their locations in pulse_height units (sorted by number of</span>
<span class="sd">    pulses in peak) AND their peak values as: (peak_locations, peak_intensities)</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_heights (np.array(dtype=float)): a list of pulse heights (eg p_filt_value)</span>
<span class="sd">        gaussian_fwhm = fwhm of a gaussian that each pulse is smeared with, in same units as pulse heights</span>
<span class="sd">    """</span>
    <span class="c1"># kernel density estimation (with a gaussian kernel)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">gaussian_fwhm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gaussian_fwhm</span><span class="p">)</span>
    <span class="c1"># The above ensures that lo &amp; hi are floats, so that (lo-hi)/n is always a float in python2</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">gaussian_fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">tbw</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">gaussian_fwhm</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">gaussian_fwhm</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">lo</span> <span class="o">-</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">tx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tbw</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">*</span> <span class="n">ty</span><span class="p">)</span>

    <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="n">flag</span><span class="p">]</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">lm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">lm</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">lm</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">lm</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.find_opt_assignment">
<code class="highlight language-python"><span class="n">find_opt_assignment</span><span class="p">(</span><span class="n">peak_positions</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">nextra</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nincrement</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nextramax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">maxacc</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Tries to find an assignment of peaks to line names that is reasonably self consistent and smooth</p>
<p>Args:
    peak_positions (np.array(dtype=float)): a list of peak locations in arb units,
        e.g. p_filt_value units
    line_names (list[str or float)]): a list of calibration lines either as number (which is
        energies in eV), or name to be looked up in STANDARD_FEATURES
    nextra (int): the algorithm starts with the first len(line_names) + nextra peak_positions
    nincrement (int): each the algorithm fails to find a satisfactory peak assignment, it uses
        nincrement more lines
    nextramax (int): the algorithm stops incrementint nextra past this value, instead
        failing with a ValueError saying "no peak assignment succeeded"
    maxacc (float): an empirical number that determines if an assignment is good enough.
        The default number works reasonably well for tupac data</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_opt_assignment</span><span class="p">(</span>
    <span class="n">peak_positions</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nextra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">nincrement</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">nextramax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">maxacc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""Tries to find an assignment of peaks to line names that is reasonably self consistent and smooth</span>

<span class="sd">    Args:</span>
<span class="sd">        peak_positions (np.array(dtype=float)): a list of peak locations in arb units,</span>
<span class="sd">            e.g. p_filt_value units</span>
<span class="sd">        line_names (list[str or float)]): a list of calibration lines either as number (which is</span>
<span class="sd">            energies in eV), or name to be looked up in STANDARD_FEATURES</span>
<span class="sd">        nextra (int): the algorithm starts with the first len(line_names) + nextra peak_positions</span>
<span class="sd">        nincrement (int): each the algorithm fails to find a satisfactory peak assignment, it uses</span>
<span class="sd">            nincrement more lines</span>
<span class="sd">        nextramax (int): the algorithm stops incrementint nextra past this value, instead</span>
<span class="sd">            failing with a ValueError saying "no peak assignment succeeded"</span>
<span class="sd">        maxacc (float): an empirical number that determines if an assignment is good enough.</span>
<span class="sd">            The default number works reasonably well for tupac data</span>
<span class="sd">    """</span>
    <span class="n">name_e</span><span class="p">,</span> <span class="n">e_e</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>

    <span class="n">n_sel_pp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span> <span class="o">+</span> <span class="n">nextra</span>  <span class="c1"># number of peak_positions to use to line up to line_names</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span> <span class="o">+</span> <span class="n">nextramax</span>
    <span class="n">peak_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">peak_positions</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">sel_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">peak_positions</span><span class="p">[:</span><span class="n">n_sel_pp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"float"</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">e_e</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"float"</span><span class="p">)</span>
        <span class="n">assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">sel_positions</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names</span><span class="p">))))</span>
        <span class="n">assign</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fracs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">energies</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">est_pos</span> <span class="o">=</span> <span class="n">assign</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fracs</span><span class="p">)</span> <span class="o">+</span> <span class="n">assign</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">*</span> <span class="n">fracs</span>
        <span class="n">acc_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">est_pos</span> <span class="o">-</span> <span class="n">assign</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">assign</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">assign</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">opt_assign_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">acc_est</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">acc_est</span><span class="p">[</span><span class="n">opt_assign_i</span><span class="p">]</span>
        <span class="n">opt_assign</span> <span class="o">=</span> <span class="n">assign</span><span class="p">[</span><span class="n">opt_assign_i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="n">maxacc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)):</span>
            <span class="n">n_sel_pp</span> <span class="o">+=</span> <span class="n">nincrement</span>
            <span class="k">if</span> <span class="n">n_sel_pp</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"no peak assignment succeeded: acc </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">, maxacc*sqrt(len(energies)) </span><span class="si">{</span><span class="n">maxacc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">"</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name_e</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">opt_assign</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.get_model">
<code class="highlight language-python"><span class="n">get_model</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Get a GenericLineModel for a line, given either a line name or energy in eV</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>lineNameOrEnergy</code></b>
                  (<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a> | <a class="autorefs autorefs-internal" title="SpectralLine


  
      dataclass
   (mass2.calibration.fluorescence_lines.SpectralLine)" href="#mass2.calibration.fluorescence_lines.SpectralLine">SpectralLine</a> | <span title="str">str</span> | <span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>A line name, or energy, or a SpectralLine, or a GenericLineModel</p>
</div>
</li>
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
<p>Whether to allow a background slope, by default True</p>
</div>
</li>
<li>
<b><code>has_tails</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>Whether to allow exponential tails, by default False</p>
</div>
</li>
<li>
<b><code>prefix</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>''</code>
)
              –
              <div class="doc-md-description">
<p>Line nae prefix, by default ""</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>An appropriate line model</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="FailedToGetModelException (mass2.calibration.algorithms.FailedToGetModelException)" href="#mass2.calibration.algorithms.FailedToGetModelException">FailedToGetModelException</a></code>
              –
              <div class="doc-md-description">
<p>When a matching line cannot be found</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model</span><span class="p">(</span>
    <span class="n">lineNameOrEnergy</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Get a GenericLineModel for a line, given either a line name or energy in eV</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lineNameOrEnergy : GenericLineModel | SpectralLine | str | float</span>
<span class="sd">        A line name, or energy, or a SpectralLine, or a GenericLineModel</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        Whether to allow a background slope, by default True</span>
<span class="sd">    has_tails : bool, optional</span>
<span class="sd">        Whether to allow exponential tails, by default False</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        Line nae prefix, by default ""</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        An appropriate line model</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FailedToGetModelException</span>
<span class="sd">        When a matching line cannot be found</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">,</span> <span class="n">GenericLineModel</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lineNameOrEnergy</span><span class="o">.</span><span class="n">spect</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">,</span> <span class="n">SpectralLine</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lineNameOrEnergy</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lineNameOrEnergy</span> <span class="ow">in</span> <span class="n">mass2</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">lineNameOrEnergy</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">lineNameOrEnergy</span> <span class="ow">in</span> <span class="n">mass2</span><span class="o">.</span><span class="n">STANDARD_FEATURES</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">STANDARD_FEATURES</span><span class="p">[</span><span class="n">lineNameOrEnergy</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">SpectralLine</span><span class="o">.</span><span class="n">quick_monochromatic_line</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FailedToGetModelException</span><span class="p">(</span><span class="sa">f</span><span class="s2">"failed to get line from lineNameOrEnergy=</span><span class="si">{</span><span class="n">lineNameOrEnergy</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FailedToGetModelException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"lineNameOrEnergy = </span><span class="si">{</span><span class="n">lineNameOrEnergy</span><span class="si">}</span><span class="s2"> is not convertable"</span>
                <span class="s2">" to float or a str in mass2.spectra or mass2.STANDARD_FEATURES"</span>
            <span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">SpectralLine</span><span class="o">.</span><span class="n">quick_monochromatic_line</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">lineNameOrEnergy</span><span class="si">}</span><span class="s2">eV"</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lineNameOrEnergy</span><span class="p">),</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.line_names_and_energies">
<code class="highlight language-python"><span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Given a list of line_names, return (names, energies) in eV.</p>
<p>Can also accept energies in eV directly and return (names, energies).</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""Given a list of line_names, return (names, energies) in eV.</span>

<span class="sd">    Can also accept energies in eV directly and return (names, energies).</span>
<span class="sd">    """</span>
    <span class="n">energies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name_or_energy</span> <span class="ow">in</span> <span class="n">line_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_energy</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">STANDARD_FEATURES</span><span class="p">[</span><span class="n">name_or_energy</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">name_or_energy</span><span class="p">))</span>
    <span class="n">order</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">sorted_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
    <span class="n">energies</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sorted_names</span><span class="p">,</span> <span class="n">energies</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.multifit">
<code class="highlight language-python"><span class="n">multifit</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">fit_lo_hi</span><span class="p">,</span> <span class="n">binsize_ev</span><span class="p">,</span> <span class="n">slopes_de_dph</span><span class="p">,</span> <span class="n">hide_deprecation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Args:
    ph (np.array(dtype=float)): list of pulse heights
    line_names: names of calibration  lines
    fit_lo_hi (list[list[float]]): a list of (lo,hi) with units of ph, used as
        edges of histograms for fitting
    binsize_ev (list[float]): list of binsizes in eV for calibration lines
    slopes_de_dph (list[float]): - list of slopes de_dph (e in eV)
    hide_deprecation: whether to suppress deprecation warnings</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">multifit</span><span class="p">(</span>
    <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">fit_lo_hi</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">binsize_ev</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">slopes_de_dph</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">hide_deprecation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">        ph (np.array(dtype=float)): list of pulse heights</span>
<span class="sd">        line_names: names of calibration  lines</span>
<span class="sd">        fit_lo_hi (list[list[float]]): a list of (lo,hi) with units of ph, used as</span>
<span class="sd">            edges of histograms for fitting</span>
<span class="sd">        binsize_ev (list[float]): list of binsizes in eV for calibration lines</span>
<span class="sd">        slopes_de_dph (list[float]): - list of slopes de_dph (e in eV)</span>
<span class="sd">        hide_deprecation: whether to suppress deprecation warnings</span>
<span class="sd">    """</span>
    <span class="n">name_e</span><span class="p">,</span> <span class="n">e_e</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">peak_ph</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eres</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">name_e</span><span class="p">):</span>
        <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">fit_lo_hi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dP_dE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">slopes_de_dph</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">binsize_ph</span> <span class="o">=</span> <span class="n">binsize_ev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dP_dE</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">singlefit</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">binsize_ph</span><span class="p">,</span> <span class="n">dP_dE</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">peak_ph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">])</span>
        <span class="n">eres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">"fwhm"</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"results"</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span> <span class="s2">"peak_ph"</span><span class="p">:</span> <span class="n">peak_ph</span><span class="p">,</span> <span class="s2">"eres"</span><span class="p">:</span> <span class="n">eres</span><span class="p">,</span> <span class="s2">"line_names"</span><span class="p">:</span> <span class="n">name_e</span><span class="p">,</span> <span class="s2">"energies"</span><span class="p">:</span> <span class="n">e_e</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.algorithms.singlefit">
<code class="highlight language-python"><span class="n">singlefit</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">binsize_ph</span><span class="p">,</span> <span class="n">approx_dP_dE</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Performs a fit to a single line in pulse height units</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>ph</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Measured pulse heights</p>
</div>
</li>
<li>
<b><code>name</code></b>
                  (<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a> | <a class="autorefs autorefs-internal" title="SpectralLine


  
      dataclass
   (mass2.calibration.fluorescence_lines.SpectralLine)" href="#mass2.calibration.fluorescence_lines.SpectralLine">SpectralLine</a> | <span title="str">str</span> | <span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>Spectral line to fit, either as a name, energy in eV, SpectralLine, or GenericLineModel</p>
</div>
</li>
<li>
<b><code>lo</code></b>
                  (<code><span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>minimum pulse height to include in fit</p>
</div>
</li>
<li>
<b><code>hi</code></b>
                  (<code><span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>maximum pulse height to include in fit</p>
</div>
</li>
<li>
<b><code>binsize_ph</code></b>
                  (<code><span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>bin size in pulse height units</p>
</div>
</li>
<li>
<b><code>approx_dP_dE</code></b>
                  (<code><span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>Estimate of the dph/dE at the line energy, used to constrain the fit</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="LineModelResult (mass2.calibration.line_models.LineModelResult)" href="#mass2.calibration.line_models.LineModelResult">LineModelResult</a></code>
              –
              <div class="doc-md-description">
<p>The best-fit result</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>When too many bins would be used in the fit</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">singlefit</span><span class="p">(</span>
    <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lo</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">hi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">binsize_ph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">approx_dP_dE</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Performs a fit to a single line in pulse height units</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ph : ArrayLike</span>
<span class="sd">        Measured pulse heights</span>
<span class="sd">    name : GenericLineModel | SpectralLine | str | float</span>
<span class="sd">        Spectral line to fit, either as a name, energy in eV, SpectralLine, or GenericLineModel</span>
<span class="sd">    lo : float</span>
<span class="sd">        minimum pulse height to include in fit</span>
<span class="sd">    hi : float</span>
<span class="sd">        maximum pulse height to include in fit</span>
<span class="sd">    binsize_ph : float</span>
<span class="sd">        bin size in pulse height units</span>
<span class="sd">    approx_dP_dE : float</span>
<span class="sd">        Estimate of the dph/dE at the line energy, used to constrain the fit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    LineModelResult</span>
<span class="sd">        The best-fit result</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        When too many bins would be used in the fit</span>
<span class="sd">    """</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">/</span> <span class="n">binsize_ph</span>
    <span class="k">if</span> <span class="n">nbins</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"too damn many bins, dont like running out of memory"</span><span class="p">)</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">binsize_ph</span><span class="p">))</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">guess_params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="n">approx_dP_dE</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">"Gaussian"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">guess_params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">approx_dP_dE</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">guess_params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">energies</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h3 id="highly-charged-ions">Highly charged ions</h3>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.hci_lines"></a>
<div class="doc doc-contents first">
<p>hci_lines.py</p>
<p>Uses pickle file containing NIST ASD levels data to generate some commonly used HCI lines in mass.
Meant to be a replacement for _highly_charged_ion_lines.py, which hard codes in line parameters.</p>
<p>The pickle file can be gzip-compressed, provided the compressed filename ends with ".gz".</p>
<p>February 2020
Paul Szypryt</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.hci_lines.NIST_ASD">
<code>NIST_ASD</code>
</h2>
<div class="doc doc-contents">
<p>Class for working with a pickled atomic spectra database</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NIST_ASD</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Class for working with a pickled atomic spectra database"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickleFilename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Loads ASD pickle file (optionally gzipped)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pickleFilename : str | None, optional</span>
<span class="sd">            ASD pickle file name, as str, or if none then `mass2.calibration.hci_lines.DEFAULT_PICKLE_PATH` (default None)</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">pickleFilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pickleFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">DEFAULT_PICKLE_PATH</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pickleFilename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".gz"</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">pickleFilename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickleFilename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getAvailableElements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Returns a list of all available elements from the ASD pickle file"""</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getAvailableSpectralCharges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""For a given element, returns a list of all available charge states from the ASD pickle file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        element : str</span>
<span class="sd">            atomic symbol of element, e.g. 'Ne'</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[int]</span>
<span class="sd">            Available charge states</span>
<span class="sd">        """</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getAvailableLevels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">spectralCharge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">requiredConf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">requiredTerm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">requiredJVal</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">maxLevels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"eV"</span><span class="p">,</span>
        <span class="n">getUncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""For a given element and spectral charge state, return a dict of all known levels from the ASD pickle file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        element : str</span>
<span class="sd">            Elemental atomic symbol, e.g. 'Ne'</span>
<span class="sd">        spectralCharge : int</span>
<span class="sd">            spectral charge state, e.g. 1 for neutral atoms, 10 for H-like Ne</span>
<span class="sd">        requiredConf : str | None, optional</span>
<span class="sd">            if not None, limits results to those with `conf == requiredConf`, by default None</span>
<span class="sd">        requiredTerm : str | None, optional</span>
<span class="sd">            if not None, limits results to those with `term == requiredTerm`, by default None</span>
<span class="sd">        requiredJVal : str | None, optional</span>
<span class="sd">            if not None, limits results to those with `a == requiredJVal`, by default None</span>
<span class="sd">        maxLevels : int | None, optional</span>
<span class="sd">            the maximum number of levels (sorted by energy) to return, by default None</span>
<span class="sd">        units : str, optional</span>
<span class="sd">            'cm-1' or 'eV' for returned line position. If 'eV', converts from database 'cm-1' values, by default "eV"</span>
<span class="sd">        getUncertainty : bool, optional</span>
<span class="sd">            whether to return uncertain values, by default True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of energy level strings to energy levels.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"eV"</span><span class="p">,</span> <span class="s2">"cm-1"</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unit type not supported, please use eV or cm-1"</span><span class="p">)</span>

        <span class="n">spectralCharge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spectralCharge</span><span class="p">)</span>
        <span class="n">levelsDict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">numLevels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">iLevel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check to see if we reached maximum number of levels to return</span>
                <span class="k">if</span> <span class="n">maxLevels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">numLevels</span> <span class="o">==</span> <span class="n">maxLevels</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">levelsDict</span>
                <span class="c1"># If required, check to see if level matches search conf, term, JVal</span>
                <span class="n">includeTerm</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">includeJVal</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">conf</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">j_str</span> <span class="o">=</span> <span class="n">iLevel</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">JVal</span> <span class="o">=</span> <span class="n">j_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">includeConf</span> <span class="o">=</span> <span class="p">(</span><span class="n">requiredConf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">conf</span> <span class="o">==</span> <span class="n">requiredConf</span>
                <span class="n">includeTerm</span> <span class="o">=</span> <span class="p">(</span><span class="n">requiredTerm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span> <span class="o">==</span> <span class="n">requiredTerm</span>
                <span class="n">includeJVal</span> <span class="o">=</span> <span class="p">(</span><span class="n">requiredJVal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">JVal</span> <span class="o">==</span> <span class="n">requiredJVal</span>

                <span class="c1"># Include levels that match, in either cm-1 or eV</span>
                <span class="k">if</span> <span class="n">includeConf</span> <span class="ow">and</span> <span class="n">includeTerm</span> <span class="ow">and</span> <span class="n">includeJVal</span><span class="p">:</span>
                    <span class="n">numLevels</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"cm-1"</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
                            <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"eV"</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
                            <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">iValue</span> <span class="o">*</span> <span class="n">INVCM_TO_EV</span> <span class="k">for</span> <span class="n">iValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">]</span>
                            <span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="n">INVCM_TO_EV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="sa">f</span><span class="s2">"Warning: cannot parse level: </span><span class="si">{</span><span class="n">iLevel</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">levelsDict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getSingleLevel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">term</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">JVal</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"eV"</span><span class="p">,</span> <span class="n">getUncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the level data for a fully defined element, charge state, conf, term, and JVal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        element : str</span>
<span class="sd">            atomic symbol of element, e.g. 'Ne'</span>
<span class="sd">        spectralCharge : int</span>
<span class="sd">            spectral charge state, e.g. 1 for neutral atoms, 10 for H-like Ne</span>
<span class="sd">        conf : str</span>
<span class="sd">            nuclear configuration, e.g. '2p'</span>
<span class="sd">        term : str</span>
<span class="sd">            nuclear term, e.g. '2P*'</span>
<span class="sd">        JVal : str</span>
<span class="sd">            total angular momentum J, e.g. '3/2'</span>
<span class="sd">        units : str, optional</span>
<span class="sd">            'cm-1' or 'eV' for returned line position. If 'eV', converts from database 'cm-1' values, by default "eV"</span>
<span class="sd">        getUncertainty : bool, optional</span>
<span class="sd">            includes uncertainties in list of levels, by default True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            _description_</span>
<span class="sd">        """</span>

        <span class="n">levelString</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> J=</span><span class="si">{</span><span class="n">JVal</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"cm-1"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
                <span class="n">levelEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">levelEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"eV"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
                <span class="n">levelEnergy</span> <span class="o">=</span> <span class="p">[</span><span class="n">iValue</span> <span class="o">*</span> <span class="n">INVCM_TO_EV</span> <span class="k">for</span> <span class="n">iValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">levelEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">INVCM_TO_EV</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unit type not supported, please use eV or cm-1"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">levelEnergy</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.hci_lines.NIST_ASD.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">pickleFilename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Loads ASD pickle file (optionally gzipped)</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>pickleFilename</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>ASD pickle file name, as str, or if none then <code>mass2.calibration.hci_lines.DEFAULT_PICKLE_PATH</code> (default None)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickleFilename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Loads ASD pickle file (optionally gzipped)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pickleFilename : str | None, optional</span>
<span class="sd">        ASD pickle file name, as str, or if none then `mass2.calibration.hci_lines.DEFAULT_PICKLE_PATH` (default None)</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">pickleFilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pickleFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">DEFAULT_PICKLE_PATH</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pickleFilename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".gz"</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">pickleFilename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickleFilename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.hci_lines.NIST_ASD.getAvailableElements">
<code class="highlight language-python"><span class="n">getAvailableElements</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Returns a list of all available elements from the ASD pickle file</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">getAvailableElements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Returns a list of all available elements from the ASD pickle file"""</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.hci_lines.NIST_ASD.getAvailableLevels">
<code class="highlight language-python"><span class="n">getAvailableLevels</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="p">,</span> <span class="n">requiredConf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requiredTerm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requiredJVal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxLevels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">'eV'</span><span class="p">,</span> <span class="n">getUncertainty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>For a given element and spectral charge state, return a dict of all known levels from the ASD pickle file</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>element</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>Elemental atomic symbol, e.g. 'Ne'</p>
</div>
</li>
<li>
<b><code>spectralCharge</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
<p>spectral charge state, e.g. 1 for neutral atoms, 10 for H-like Ne</p>
</div>
</li>
<li>
<b><code>requiredConf</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>if not None, limits results to those with <code>conf == requiredConf</code>, by default None</p>
</div>
</li>
<li>
<b><code>requiredTerm</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>if not None, limits results to those with <code>term == requiredTerm</code>, by default None</p>
</div>
</li>
<li>
<b><code>requiredJVal</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>if not None, limits results to those with <code>a == requiredJVal</code>, by default None</p>
</div>
</li>
<li>
<b><code>maxLevels</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>the maximum number of levels (sorted by energy) to return, by default None</p>
</div>
</li>
<li>
<b><code>units</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'eV'</code>
)
              –
              <div class="doc-md-description">
<p>'cm-1' or 'eV' for returned line position. If 'eV', converts from database 'cm-1' values, by default "eV"</p>
</div>
</li>
<li>
<b><code>getUncertainty</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
<p>whether to return uncertain values, by default True</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="dict">dict</span></code>
              –
              <div class="doc-md-description">
<p>A dictionary of energy level strings to energy levels.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">getAvailableLevels</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">spectralCharge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">requiredConf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">requiredTerm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">requiredJVal</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">maxLevels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"eV"</span><span class="p">,</span>
    <span class="n">getUncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""For a given element and spectral charge state, return a dict of all known levels from the ASD pickle file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    element : str</span>
<span class="sd">        Elemental atomic symbol, e.g. 'Ne'</span>
<span class="sd">    spectralCharge : int</span>
<span class="sd">        spectral charge state, e.g. 1 for neutral atoms, 10 for H-like Ne</span>
<span class="sd">    requiredConf : str | None, optional</span>
<span class="sd">        if not None, limits results to those with `conf == requiredConf`, by default None</span>
<span class="sd">    requiredTerm : str | None, optional</span>
<span class="sd">        if not None, limits results to those with `term == requiredTerm`, by default None</span>
<span class="sd">    requiredJVal : str | None, optional</span>
<span class="sd">        if not None, limits results to those with `a == requiredJVal`, by default None</span>
<span class="sd">    maxLevels : int | None, optional</span>
<span class="sd">        the maximum number of levels (sorted by energy) to return, by default None</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        'cm-1' or 'eV' for returned line position. If 'eV', converts from database 'cm-1' values, by default "eV"</span>
<span class="sd">    getUncertainty : bool, optional</span>
<span class="sd">        whether to return uncertain values, by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of energy level strings to energy levels.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"eV"</span><span class="p">,</span> <span class="s2">"cm-1"</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unit type not supported, please use eV or cm-1"</span><span class="p">)</span>

    <span class="n">spectralCharge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spectralCharge</span><span class="p">)</span>
    <span class="n">levelsDict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">numLevels</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">iLevel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check to see if we reached maximum number of levels to return</span>
            <span class="k">if</span> <span class="n">maxLevels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">numLevels</span> <span class="o">==</span> <span class="n">maxLevels</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">levelsDict</span>
            <span class="c1"># If required, check to see if level matches search conf, term, JVal</span>
            <span class="n">includeTerm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">includeJVal</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">conf</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">j_str</span> <span class="o">=</span> <span class="n">iLevel</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">JVal</span> <span class="o">=</span> <span class="n">j_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">includeConf</span> <span class="o">=</span> <span class="p">(</span><span class="n">requiredConf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">conf</span> <span class="o">==</span> <span class="n">requiredConf</span>
            <span class="n">includeTerm</span> <span class="o">=</span> <span class="p">(</span><span class="n">requiredTerm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span> <span class="o">==</span> <span class="n">requiredTerm</span>
            <span class="n">includeJVal</span> <span class="o">=</span> <span class="p">(</span><span class="n">requiredJVal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">JVal</span> <span class="o">==</span> <span class="n">requiredJVal</span>

            <span class="c1"># Include levels that match, in either cm-1 or eV</span>
            <span class="k">if</span> <span class="n">includeConf</span> <span class="ow">and</span> <span class="n">includeTerm</span> <span class="ow">and</span> <span class="n">includeJVal</span><span class="p">:</span>
                <span class="n">numLevels</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"cm-1"</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
                        <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"eV"</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
                        <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">iValue</span> <span class="o">*</span> <span class="n">INVCM_TO_EV</span> <span class="k">for</span> <span class="n">iValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">]</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">]</span> <span class="o">=</span> <span class="n">INVCM_TO_EV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">iLevel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="sa">f</span><span class="s2">"Warning: cannot parse level: </span><span class="si">{</span><span class="n">iLevel</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">levelsDict</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.hci_lines.NIST_ASD.getAvailableSpectralCharges">
<code class="highlight language-python"><span class="n">getAvailableSpectralCharges</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>For a given element, returns a list of all available charge states from the ASD pickle file</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>element</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>atomic symbol of element, e.g. 'Ne'</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="list">list</span>[<span title="int">int</span>]</code>
              –
              <div class="doc-md-description">
<p>Available charge states</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">getAvailableSpectralCharges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""For a given element, returns a list of all available charge states from the ASD pickle file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    element : str</span>
<span class="sd">        atomic symbol of element, e.g. 'Ne'</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[int]</span>
<span class="sd">        Available charge states</span>
<span class="sd">    """</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.hci_lines.NIST_ASD.getSingleLevel">
<code class="highlight language-python"><span class="n">getSingleLevel</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">JVal</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">'eV'</span><span class="p">,</span> <span class="n">getUncertainty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the level data for a fully defined element, charge state, conf, term, and JVal.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>element</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>atomic symbol of element, e.g. 'Ne'</p>
</div>
</li>
<li>
<b><code>spectralCharge</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
<p>spectral charge state, e.g. 1 for neutral atoms, 10 for H-like Ne</p>
</div>
</li>
<li>
<b><code>conf</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>nuclear configuration, e.g. '2p'</p>
</div>
</li>
<li>
<b><code>term</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>nuclear term, e.g. '2P*'</p>
</div>
</li>
<li>
<b><code>JVal</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>total angular momentum J, e.g. '3/2'</p>
</div>
</li>
<li>
<b><code>units</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'eV'</code>
)
              –
              <div class="doc-md-description">
<p>'cm-1' or 'eV' for returned line position. If 'eV', converts from database 'cm-1' values, by default "eV"</p>
</div>
</li>
<li>
<b><code>getUncertainty</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
<p>includes uncertainties in list of levels, by default True</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="float">float</span></code>
              –
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">getSingleLevel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">term</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">JVal</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"eV"</span><span class="p">,</span> <span class="n">getUncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the level data for a fully defined element, charge state, conf, term, and JVal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    element : str</span>
<span class="sd">        atomic symbol of element, e.g. 'Ne'</span>
<span class="sd">    spectralCharge : int</span>
<span class="sd">        spectral charge state, e.g. 1 for neutral atoms, 10 for H-like Ne</span>
<span class="sd">    conf : str</span>
<span class="sd">        nuclear configuration, e.g. '2p'</span>
<span class="sd">    term : str</span>
<span class="sd">        nuclear term, e.g. '2P*'</span>
<span class="sd">    JVal : str</span>
<span class="sd">        total angular momentum J, e.g. '3/2'</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        'cm-1' or 'eV' for returned line position. If 'eV', converts from database 'cm-1' values, by default "eV"</span>
<span class="sd">    getUncertainty : bool, optional</span>
<span class="sd">        includes uncertainties in list of levels, by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        _description_</span>
<span class="sd">    """</span>

    <span class="n">levelString</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> J=</span><span class="si">{</span><span class="n">JVal</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"cm-1"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
            <span class="n">levelEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">levelEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">"eV"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">getUncertainty</span><span class="p">:</span>
            <span class="n">levelEnergy</span> <span class="o">=</span> <span class="p">[</span><span class="n">iValue</span> <span class="o">*</span> <span class="n">INVCM_TO_EV</span> <span class="k">for</span> <span class="n">iValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">levelEnergy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NIST_ASD_Dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectralCharge</span><span class="p">][</span><span class="n">levelString</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">INVCM_TO_EV</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unit type not supported, please use eV or cm-1"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">levelEnergy</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_lines.add_H_like_lines_from_asd">
<code class="highlight language-python"><span class="n">add_H_like_lines_from_asd</span><span class="p">(</span><span class="n">asd</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">maxLevels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Add all known H-like lines for a given element from the ASD database</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_H_like_lines_from_asd</span><span class="p">(</span><span class="n">asd</span><span class="p">:</span> <span class="n">NIST_ASD</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">maxLevels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SpectralLine</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Add all known H-like lines for a given element from the ASD database"""</span>
    <span class="n">spectr_ch</span> <span class="o">=</span> <span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="n">added_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">maxLevels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levelsDict</span> <span class="o">=</span> <span class="n">asd</span><span class="o">.</span><span class="n">getAvailableLevels</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="o">=</span><span class="n">spectr_ch</span><span class="p">,</span> <span class="n">maxLevels</span><span class="o">=</span><span class="n">maxLevels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">levelsDict</span> <span class="o">=</span> <span class="n">asd</span><span class="o">.</span><span class="n">getAvailableLevels</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="o">=</span><span class="n">spectr_ch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iLevel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">levelsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">lineEnergy</span> <span class="o">=</span> <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lineEnergy</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">iLine</span> <span class="o">=</span> <span class="n">add_hci_line</span><span class="p">(</span>
                <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span> <span class="n">spectr_ch</span><span class="o">=</span><span class="n">spectr_ch</span><span class="p">,</span> <span class="n">line_identifier</span><span class="o">=</span><span class="n">iLevel</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">lineEnergy</span><span class="p">],</span> <span class="n">widths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">added_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iLine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">added_lines</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_lines.add_He_like_lines_from_asd">
<code class="highlight language-python"><span class="n">add_He_like_lines_from_asd</span><span class="p">(</span><span class="n">asd</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">maxLevels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Add all known He-like lines for a given element from the ASD database</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_He_like_lines_from_asd</span><span class="p">(</span><span class="n">asd</span><span class="p">:</span> <span class="n">NIST_ASD</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">maxLevels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SpectralLine</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Add all known He-like lines for a given element from the ASD database"""</span>
    <span class="n">spectr_ch</span> <span class="o">=</span> <span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">added_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">maxLevels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levelsDict</span> <span class="o">=</span> <span class="n">asd</span><span class="o">.</span><span class="n">getAvailableLevels</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="o">=</span><span class="n">spectr_ch</span><span class="p">,</span> <span class="n">maxLevels</span><span class="o">=</span><span class="n">maxLevels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">levelsDict</span> <span class="o">=</span> <span class="n">asd</span><span class="o">.</span><span class="n">getAvailableLevels</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectralCharge</span><span class="o">=</span><span class="n">spectr_ch</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iLevel</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">levelsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">lineEnergy</span> <span class="o">=</span> <span class="n">levelsDict</span><span class="p">[</span><span class="n">iLevel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lineEnergy</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">iLine</span> <span class="o">=</span> <span class="n">add_hci_line</span><span class="p">(</span>
                <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span> <span class="n">spectr_ch</span><span class="o">=</span><span class="n">spectr_ch</span><span class="p">,</span> <span class="n">line_identifier</span><span class="o">=</span><span class="n">iLevel</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">lineEnergy</span><span class="p">],</span> <span class="n">widths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">added_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iLine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">added_lines</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_lines.add_hci_line">
<code class="highlight language-python"><span class="n">add_hci_line</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">spectr_ch</span><span class="p">,</span> <span class="n">line_identifier</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">ratios</span><span class="p">,</span> <span class="n">nominal_peak_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Add a single HCI line to the fluorescence_lines database</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>element</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>The element whose line is being added, e.g. 'Ne'</p>
</div>
</li>
<li>
<b><code>spectr_ch</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
<p>The charge state of the ion whose line is being added, e.g. 9 for H-like Ne</p>
</div>
</li>
<li>
<b><code>line_identifier</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>The line identifier, e.g. '1s2S1/2 - 2p2P3/2'</p>
</div>
</li>
<li>
<b><code>energies</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The energies of the components of the line, in eV</p>
</div>
</li>
<li>
<b><code>widths</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The Lorentzian FWHM widths of the components of the line, in eV</p>
</div>
</li>
<li>
<b><code>ratios</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The relative intensities of the components of the line</p>
</div>
</li>
<li>
<b><code>nominal_peak_energy</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>The nominal spectral peak in eV, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="SpectralLine


  
      dataclass
   (mass2.calibration.fluorescence_lines.SpectralLine)" href="#mass2.calibration.fluorescence_lines.SpectralLine">SpectralLine</a></code>
              –
              <div class="doc-md-description">
<p>The newly added SpectralLine object</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_lines.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_hci_line</span><span class="p">(</span>
    <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">spectr_ch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">line_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">energies</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">widths</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">ratios</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">nominal_peak_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralLine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add a single HCI line to the fluorescence_lines database</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    element : str</span>
<span class="sd">        The element whose line is being added, e.g. 'Ne'</span>
<span class="sd">    spectr_ch : int</span>
<span class="sd">        The charge state of the ion whose line is being added, e.g. 9 for H-like Ne</span>
<span class="sd">    line_identifier : str</span>
<span class="sd">        The line identifier, e.g. '1s2S1/2 - 2p2P3/2'</span>
<span class="sd">    energies : ArrayLike</span>
<span class="sd">        The energies of the components of the line, in eV</span>
<span class="sd">    widths : ArrayLike</span>
<span class="sd">        The Lorentzian FWHM widths of the components of the line, in eV</span>
<span class="sd">    ratios : ArrayLike</span>
<span class="sd">        The relative intensities of the components of the line</span>
<span class="sd">    nominal_peak_energy : float | None, optional</span>
<span class="sd">        The nominal spectral peak in eV, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpectralLine</span>
<span class="sd">        The newly added SpectralLine object</span>
<span class="sd">    """</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">widths</span><span class="p">)</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nominal_peak_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nominal_peak_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">ratios</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
    <span class="n">linetype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">spectr_ch</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line_identifier</span><span class="si">}</span><span class="s2">"</span>

    <span class="n">spectrum_class</span> <span class="o">=</span> <span class="n">fluorescence_lines</span><span class="o">.</span><span class="n">addline</span><span class="p">(</span>
        <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="s2">"Highly Charged Ion"</span><span class="p">,</span>
        <span class="n">linetype</span><span class="o">=</span><span class="n">linetype</span><span class="p">,</span>
        <span class="n">reference_short</span><span class="o">=</span><span class="s2">"NIST ASD"</span><span class="p">,</span>
        <span class="n">reference_plot_instrument_gaussian_fwhm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">nominal_peak_energy</span><span class="o">=</span><span class="n">nominal_peak_energy</span><span class="p">,</span>
        <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
        <span class="n">lorentzian_fwhm</span><span class="o">=</span><span class="n">widths</span><span class="p">,</span>
        <span class="n">reference_amplitude</span><span class="o">=</span><span class="n">ratios</span><span class="p">,</span>
        <span class="n">reference_amplitude_type</span><span class="o">=</span><span class="n">AmplitudeType</span><span class="o">.</span><span class="n">LORENTZIAN_PEAK_HEIGHT</span><span class="p">,</span>
        <span class="n">ka12_energy_diff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrum_class</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.hci_models"></a>
<div class="doc doc-contents first">
<p>hci_models.py</p>
<p>Some useful methods for initializing GenericLineModel and CompositeMLEModel objects applied to HCI lines.</p>
<p>June 2020
Paul Szypryt</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_models.add_bg_model">
<code class="highlight language-python"><span class="n">add_bg_model</span><span class="p">(</span><span class="n">generic_model</span><span class="p">,</span> <span class="n">vary_slope</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Adds a LinearBackgroundModel to a generic lmfit model</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>generic_model</code></b>
                  (<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>)
              –
              <div class="doc-md-description">
<p>object to which to add a linear background model</p>
</div>
</li>
<li>
<b><code>vary_slope</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>allows a varying linear slope rather than just constant value, by default False</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>The input model, with background componets added</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_bg_model</span><span class="p">(</span><span class="n">generic_model</span><span class="p">:</span> <span class="n">GenericLineModel</span><span class="p">,</span> <span class="n">vary_slope</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Adds a LinearBackgroundModel to a generic lmfit model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    generic_model : GenericLineModel</span>
<span class="sd">        object to which to add a linear background model</span>
<span class="sd">    vary_slope : bool, optional</span>
<span class="sd">        allows a varying linear slope rather than just constant value, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        The input model, with background componets added</span>
<span class="sd">    """</span>
    <span class="c1"># composite_name = generic_model._name</span>
    <span class="c1"># bg_prefix = f"{composite_name}_".replace(" ", "_").replace("J=", "").replace("/", "_").replace("*", "").replace(".", "")</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"No LinearBackgroundModel still exists in mass2"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_models.initialize_HLike_2P_model">
<code class="highlight language-python"><span class="n">initialize_HLike_2P_model</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vary_amp_ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Initializes H-like 2P models consisting of J=1/2 and J=3/2 lines</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>element</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>atomic symbol as str, e.g. 'Ne' or 'Ar'</p>
</div>
</li>
<li>
<b><code>conf</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>nuclear configuration as str, e.g. '2p' or '3p'</p>
</div>
</li>
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include a single linear background on top of the 2 Lorentzians, by default False</p>
</div>
</li>
<li>
<b><code>has_tails</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include low energy tail in the model, by default False</p>
</div>
</li>
<li>
<b><code>vary_amp_ratio</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>allow the ratio of the J=3/2 to J=1/2 states to vary away from 2, by default False</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>The new composite line</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_HLike_2P_model</span><span class="p">(</span>
    <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_amp_ratio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Initializes H-like 2P models consisting of J=1/2 and J=3/2 lines</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    element : str</span>
<span class="sd">        atomic symbol as str, e.g. 'Ne' or 'Ar'</span>
<span class="sd">    conf : str</span>
<span class="sd">        nuclear configuration as str, e.g. '2p' or '3p'</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        include a single linear background on top of the 2 Lorentzians, by default False</span>
<span class="sd">    has_tails : bool, optional</span>
<span class="sd">        include low energy tail in the model, by default False</span>
<span class="sd">    vary_amp_ratio : bool, optional</span>
<span class="sd">        allow the ratio of the J=3/2 to J=1/2 states to vary away from 2, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        The new composite line</span>
<span class="sd">    """</span>

    <span class="c1"># Set up line names and lmfit prefixes</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
    <span class="n">line_name_1_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2"> 2P* J=1/2"</span>
    <span class="n">line_name_3_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2"> 2P* J=3/2"</span>
    <span class="n">prefix_1_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_name_1_2</span><span class="si">}</span><span class="s2">_"</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"J="</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"*"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">prefix_3_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_name_3_2</span><span class="si">}</span><span class="s2">_"</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"J="</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"*"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="c1"># Initialize individual lines and models</span>
    <span class="n">line_1_2</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">line_name_1_2</span><span class="p">]</span>
    <span class="n">line_3_2</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">line_name_3_2</span><span class="p">]</span>
    <span class="n">model_1_2</span> <span class="o">=</span> <span class="n">line_1_2</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix_1_2</span><span class="p">)</span>
    <span class="n">model_3_2</span> <span class="o">=</span> <span class="n">line_3_2</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix_3_2</span><span class="p">)</span>
    <span class="c1"># Initialize composite model and set addition H-like constraints</span>
    <span class="n">composite_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">composite_model</span> <span class="o">=</span> <span class="n">initialize_hci_composite_model</span><span class="p">(</span>
        <span class="n">composite_name</span><span class="o">=</span><span class="n">composite_name</span><span class="p">,</span>
        <span class="n">individual_models</span><span class="o">=</span><span class="p">[</span><span class="n">model_1_2</span><span class="p">,</span> <span class="n">model_3_2</span><span class="p">],</span>
        <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span>
        <span class="n">peak_component_name</span><span class="o">=</span><span class="n">line_name_3_2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">amp_ratio_param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">_amp_ratio"</span>
    <span class="n">composite_model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">amp_ratio_param_name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="n">vary_amp_ratio</span><span class="p">)</span>
    <span class="n">composite_model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix_1_2</span><span class="si">}</span><span class="s2">integral"</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix_3_2</span><span class="si">}</span><span class="s2">integral * </span><span class="si">{</span><span class="n">amp_ratio_param_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">composite_model</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_models.initialize_HeLike_complex_model">
<code class="highlight language-python"><span class="n">initialize_HeLike_complex_model</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">additional_line_names</span><span class="o">=</span><span class="p">[])</span></code>
</h2>
<div class="doc doc-contents">
<p>Initializes 1s2s,2p He-like complexes for a given element.</p>
<p>By default, uses only the 1s.2s 3S J=1, 1s.2p 3P<em> J=1, and 1s.2p 1P</em> J=1 lines.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>element</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>atomic symbol as str, e.g. 'Ne' or 'Ar'</p>
</div>
</li>
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include a single linear background on top of the Lorentzian models, by default False</p>
</div>
</li>
<li>
<b><code>has_tails</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include low energy tail in the model, by default False</p>
</div>
</li>
<li>
<b><code>additional_line_names</code></b>
                  (<code><span title="list">list</span></code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
<p>additional line names to include in model, e.g. low level Li/Be-like features, by default []</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>A model of the given HCI complex.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_HeLike_complex_model</span><span class="p">(</span>
    <span class="n">element</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">additional_line_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Initializes 1s2s,2p He-like complexes for a given element.</span>

<span class="sd">    By default, uses only the 1s.2s 3S J=1, 1s.2p 3P* J=1, and 1s.2p 1P* J=1 lines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    element : str</span>
<span class="sd">        atomic symbol as str, e.g. 'Ne' or 'Ar'</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        include a single linear background on top of the Lorentzian models, by default False</span>
<span class="sd">    has_tails : bool, optional</span>
<span class="sd">        include low energy tail in the model, by default False</span>
<span class="sd">    additional_line_names : list, optional</span>
<span class="sd">        additional line names to include in model, e.g. low level Li/Be-like features, by default []</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        A model of the given HCI complex.</span>
<span class="sd">    """</span>

    <span class="c1"># Set up line names</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">line_name_1s2s_3S</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> 1s.2s 3S J=1"</span>
    <span class="n">line_name_1s2p_3P</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> 1s.2p 3P* J=1"</span>
    <span class="n">line_name_1s2p_1P</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> 1s.2p 1P* J=1"</span>
    <span class="n">line_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="n">line_name_1s2s_3S</span><span class="p">,</span> <span class="n">line_name_1s2p_3P</span><span class="p">,</span> <span class="n">line_name_1s2p_1P</span><span class="p">],</span> <span class="n">additional_line_names</span><span class="p">])</span>
    <span class="c1"># Set up lines and models based on line_names</span>
    <span class="c1"># individual_lines = [spectra[i_line_name]() for i_line_name in line_names]</span>
    <span class="n">individual_models</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">initialize_hci_line_model</span><span class="p">(</span><span class="n">i_line_name</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span> <span class="k">for</span> <span class="n">i_line_name</span> <span class="ow">in</span> <span class="n">line_names</span>
    <span class="p">]</span>
    <span class="c1"># Set up composite model</span>
    <span class="n">composite_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}{</span><span class="n">charge</span><span class="si">}</span><span class="s2"> 1s2s_2p Complex"</span>
    <span class="n">composite_model</span> <span class="o">=</span> <span class="n">initialize_hci_composite_model</span><span class="p">(</span>
        <span class="n">composite_name</span><span class="o">=</span><span class="n">composite_name</span><span class="p">,</span>
        <span class="n">individual_models</span><span class="o">=</span><span class="n">individual_models</span><span class="p">,</span>
        <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span>
        <span class="n">peak_component_name</span><span class="o">=</span><span class="n">line_name_1s2p_1P</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">composite_model</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_models.initialize_hci_composite_model">
<code class="highlight language-python"><span class="n">initialize_hci_composite_model</span><span class="p">(</span><span class="n">composite_name</span><span class="p">,</span> <span class="n">individual_models</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_component_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Initializes composite lmfit model from the sum of input models</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>composite_name</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>name given to composite line model</p>
</div>
</li>
<li>
<b><code>individual_models</code></b>
                  (<code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a>]</code>)
              –
              <div class="doc-md-description">
<p>Models to sum into a composite</p>
</div>
</li>
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include a single linear background on top of group of lorentzians, by default False</p>
</div>
</li>
<li>
<b><code>peak_component_name</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>designate a component to be a peak for energy, all expressions are referenced to this component, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>The new composite line</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_hci_composite_model</span><span class="p">(</span>
    <span class="n">composite_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">individual_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GenericLineModel</span><span class="p">],</span>
    <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">peak_component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Initializes composite lmfit model from the sum of input models</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    composite_name : str</span>
<span class="sd">        name given to composite line model</span>
<span class="sd">    individual_models : list[GenericLineModel]</span>
<span class="sd">        Models to sum into a composite</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        include a single linear background on top of group of lorentzians, by default False</span>
<span class="sd">    peak_component_name : str | None, optional</span>
<span class="sd">        designate a component to be a peak for energy, all expressions are referenced to this component, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        The new composite line</span>
<span class="sd">    """</span>

    <span class="n">composite_model</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">individual_models</span><span class="p">)</span>
    <span class="n">composite_model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">composite_name</span>
    <span class="k">if</span> <span class="n">has_linear_background</span><span class="p">:</span>
        <span class="n">composite_model</span> <span class="o">=</span> <span class="n">add_bg_model</span><span class="p">(</span><span class="n">composite_model</span><span class="p">)</span>
    <span class="c1"># Workaround for energy calibration using composite models, pick 1st GenericLineModel component</span>
    <span class="n">line_model_components</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i_comp</span> <span class="k">for</span> <span class="n">i_comp</span> <span class="ow">in</span> <span class="n">composite_model</span><span class="o">.</span><span class="n">components</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i_comp</span><span class="p">,</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">line_models</span><span class="o">.</span><span class="n">GenericLineModel</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">peak_component_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">peak_component_name</span> <span class="o">=</span> <span class="n">line_model_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_name</span>
    <span class="n">peak_component_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_comp</span><span class="o">.</span><span class="n">_name</span> <span class="k">for</span> <span class="n">i_comp</span> <span class="ow">in</span> <span class="n">line_model_components</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">peak_component_name</span><span class="p">)</span>
    <span class="n">peak_component</span> <span class="o">=</span> <span class="n">line_model_components</span><span class="p">[</span><span class="n">peak_component_index</span><span class="p">]</span>
    <span class="n">composite_model</span><span class="o">.</span><span class="n">peak_prefix</span> <span class="o">=</span> <span class="n">peak_component</span><span class="o">.</span><span class="n">prefix</span>
    <span class="n">composite_model</span><span class="o">.</span><span class="n">peak_energy</span> <span class="o">=</span> <span class="n">peak_component</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
    <span class="c1"># Set up some constraints relative to peak_component</span>
    <span class="n">num_line_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_model_components</span><span class="p">)</span>
    <span class="n">line_component_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">iComp</span><span class="o">.</span><span class="n">prefix</span> <span class="k">for</span> <span class="n">iComp</span> <span class="ow">in</span> <span class="n">line_model_components</span><span class="p">]</span>
    <span class="n">line_component_energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">iComp</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span> <span class="k">for</span> <span class="n">iComp</span> <span class="ow">in</span> <span class="n">line_model_components</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_line_components</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">peak_component_index</span><span class="p">:</span>
            <span class="c1"># Single fwhm across model</span>
            <span class="n">composite_model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_component_prefixes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">fwhm"</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">composite_model</span><span class="o">.</span><span class="n">peak_prefix</span><span class="si">}</span><span class="s2">fwhm"</span><span class="p">)</span>
            <span class="c1"># Single dph_de across model</span>
            <span class="n">composite_model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_component_prefixes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">dph_de"</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">composite_model</span><span class="o">.</span><span class="n">peak_prefix</span><span class="si">}</span><span class="s2">dph_de"</span><span class="p">)</span>
            <span class="c1"># Fixed energy separation based on database values</span>
            <span class="n">separation</span> <span class="o">=</span> <span class="n">line_component_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">composite_model</span><span class="o">.</span><span class="n">peak_energy</span>
            <span class="n">hint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">separation</span><span class="si">}</span><span class="s2"> * </span><span class="si">{</span><span class="n">composite_model</span><span class="o">.</span><span class="n">peak_prefix</span><span class="si">}</span><span class="s2">dph_de) + </span><span class="si">{</span><span class="n">composite_model</span><span class="o">.</span><span class="n">peak_prefix</span><span class="si">}</span><span class="s2">peak_ph"</span>
            <span class="n">composite_model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_component_prefixes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">peak_ph"</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">hint</span><span class="p">)</span>
    <span class="n">composite_model</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">composite_name</span>
    <span class="k">return</span> <span class="n">composite_model</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_models.initialize_hci_line_model">
<code class="highlight language-python"><span class="n">initialize_hci_line_model</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Initializes a single lorentzian HCI line model. Reformats line_name to create a lmfit valid prefix.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>line_name</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>name of line to use in mass2.spectra</p>
</div>
</li>
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include linear background in the model, by default False</p>
</div>
</li>
<li>
<b><code>has_tails</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include low-energy tail in the model, by default False</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="GenericLineModel (mass2.calibration.line_models.GenericLineModel)" href="#mass2.calibration.line_models.GenericLineModel">GenericLineModel</a></code>
              –
              <div class="doc-md-description">
<p>New HCI line.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_hci_line_model</span><span class="p">(</span><span class="n">line_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericLineModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Initializes a single lorentzian HCI line model. Reformats line_name to create a lmfit valid prefix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    line_name : str</span>
<span class="sd">        name of line to use in mass2.spectra</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        include linear background in the model, by default False</span>
<span class="sd">    has_tails : bool, optional</span>
<span class="sd">        include low-energy tail in the model, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GenericLineModel</span>
<span class="sd">        New HCI line.</span>
<span class="sd">    """</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_name</span><span class="si">}</span><span class="s2">_"</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"J="</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"*"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">line_model</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">line_model</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">line_name</span>
    <span class="k">return</span> <span class="n">line_model</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.hci_models.models">
<code class="highlight language-python"><span class="n">models</span><span class="p">(</span><span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vary_Hlike_amp_ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">additional_Helike_complex_lines</span><span class="o">=</span><span class="p">[])</span></code>
</h2>
<div class="doc doc-contents">
<p>Generates some commonly used HCI line models that can be used for energy calibration, etc.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>has_linear_background</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>include a single linear background on top of the 2 Lorentzians, by default False</p>
</div>
</li>
<li>
<b><code>has_tails</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>nclude low-energy tail in the model, by default False</p>
</div>
</li>
<li>
<b><code>vary_Hlike_amp_ratio</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
<p>allow the ratio of the J=3/2 to J=1/2 H-like states to vary, by default False</p>
</div>
</li>
<li>
<b><code>additional_Helike_complex_lines</code></b>
                  (<code><span title="list">list</span></code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
<p>additional line names to include inHe-like complex model, e.g. low level Li/Be-like features, by default []</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="_type_">_type_</span></code>
              –
              <div class="doc-md-description">
<p>Dictionary of mass2.calibration.fluorescence_lines.SpectralLine objects, containing commonly used HCI lines.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/hci_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">models</span><span class="p">(</span>
    <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">vary_Hlike_amp_ratio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">additional_Helike_complex_lines</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generates some commonly used HCI line models that can be used for energy calibration, etc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    has_linear_background : bool, optional</span>
<span class="sd">        include a single linear background on top of the 2 Lorentzians, by default False</span>
<span class="sd">    has_tails : bool, optional</span>
<span class="sd">        nclude low-energy tail in the model, by default False</span>
<span class="sd">    vary_Hlike_amp_ratio : bool, optional</span>
<span class="sd">        allow the ratio of the J=3/2 to J=1/2 H-like states to vary, by default False</span>
<span class="sd">    additional_Helike_complex_lines : list, optional</span>
<span class="sd">        additional line names to include inHe-like complex model, e.g. low level Li/Be-like features, by default []</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        Dictionary of mass2.calibration.fluorescence_lines.SpectralLine objects, containing commonly used HCI lines.</span>
<span class="sd">    """</span>

    <span class="n">models_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Make some common H-like 2P* models</span>
    <span class="n">conf_Hlike_2P_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conf_Hlike_2P_dict</span><span class="p">[</span><span class="s2">"N"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"3p"</span><span class="p">,</span> <span class="s2">"4p"</span><span class="p">,</span> <span class="s2">"5p"</span><span class="p">]</span>
    <span class="n">conf_Hlike_2P_dict</span><span class="p">[</span><span class="s2">"O"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"3p"</span><span class="p">,</span> <span class="s2">"4p"</span><span class="p">,</span> <span class="s2">"5p"</span><span class="p">]</span>
    <span class="n">conf_Hlike_2P_dict</span><span class="p">[</span><span class="s2">"Ne"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"2p"</span><span class="p">,</span> <span class="s2">"3p"</span><span class="p">,</span> <span class="s2">"4p"</span><span class="p">,</span> <span class="s2">"5p"</span><span class="p">]</span>
    <span class="n">conf_Hlike_2P_dict</span><span class="p">[</span><span class="s2">"Ar"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"2p"</span><span class="p">,</span> <span class="s2">"3p"</span><span class="p">,</span> <span class="s2">"4p"</span><span class="p">,</span> <span class="s2">"5p"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i_element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">conf_Hlike_2P_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">i_conf</span> <span class="ow">in</span> <span class="n">conf_Hlike_2P_dict</span><span class="p">[</span><span class="n">i_element</span><span class="p">]:</span>
            <span class="n">Hlike_model</span> <span class="o">=</span> <span class="n">initialize_HLike_2P_model</span><span class="p">(</span>
                <span class="n">i_element</span><span class="p">,</span>
                <span class="n">i_conf</span><span class="p">,</span>
                <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span>
                <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span>
                <span class="n">vary_amp_ratio</span><span class="o">=</span><span class="n">vary_Hlike_amp_ratio</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">models_dict</span><span class="p">[</span><span class="n">Hlike_model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hlike_model</span>

    <span class="c1"># Make some common He-like 1s2s,2p complex and higher order 1p* models</span>
    <span class="c1"># He-like lines</span>
    <span class="n">Helike_complex_elements</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"N"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"Ne"</span><span class="p">,</span> <span class="s2">"Ar"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i_element</span> <span class="ow">in</span> <span class="n">Helike_complex_elements</span><span class="p">:</span>
        <span class="n">Helike_model</span> <span class="o">=</span> <span class="n">initialize_HeLike_complex_model</span><span class="p">(</span>
            <span class="n">i_element</span><span class="p">,</span>
            <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span>
            <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span>
            <span class="n">additional_line_names</span><span class="o">=</span><span class="n">additional_Helike_complex_lines</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">models_dict</span><span class="p">[</span><span class="n">Helike_model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Helike_model</span>
    <span class="c1"># 1s.np 1P* lines for n&gt;=3</span>
    <span class="n">conf_Helike_1P_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">conf_Helike_1P_dict</span><span class="p">[</span><span class="s2">"N"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"1s.4p"</span><span class="p">,</span> <span class="s2">"1s.5p"</span><span class="p">]</span>
    <span class="n">conf_Helike_1P_dict</span><span class="p">[</span><span class="s2">"O"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"1s.4p"</span><span class="p">,</span> <span class="s2">"1s.5p"</span><span class="p">]</span>
    <span class="n">conf_Helike_1P_dict</span><span class="p">[</span><span class="s2">"Ne"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"1s.3p"</span><span class="p">,</span> <span class="s2">"1s.4p"</span><span class="p">,</span> <span class="s2">"1s.5p"</span><span class="p">]</span>
    <span class="n">conf_Helike_1P_dict</span><span class="p">[</span><span class="s2">"Ar"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"1s.3p"</span><span class="p">,</span> <span class="s2">"1s.4p"</span><span class="p">,</span> <span class="s2">"1s.5p"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i_element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">conf_Helike_1P_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">i_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">i_element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i_conf</span> <span class="ow">in</span> <span class="n">conf_Helike_1P_dict</span><span class="p">[</span><span class="n">i_element</span><span class="p">]:</span>
            <span class="n">Helike_line_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i_element</span><span class="si">}{</span><span class="n">i_charge</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">i_conf</span><span class="si">}</span><span class="s2"> 1P* J=1"</span>
            <span class="n">Helike_model</span> <span class="o">=</span> <span class="n">initialize_hci_line_model</span><span class="p">(</span>
                <span class="n">Helike_line_name</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span>
            <span class="p">)</span>
            <span class="n">models_dict</span><span class="p">[</span><span class="n">Helike_model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Helike_model</span>

    <span class="c1"># Some more complicated cases</span>
    <span class="c1"># 500 eV region of H-/He-like N</span>
    <span class="n">N6_1s3p_model</span> <span class="o">=</span> <span class="n">initialize_hci_line_model</span><span class="p">(</span><span class="s2">"N6 1s.3p 1P* J=1"</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
    <span class="n">N7_2p_model</span> <span class="o">=</span> <span class="n">initialize_HLike_2P_model</span><span class="p">(</span>
        <span class="s2">"N"</span><span class="p">,</span> <span class="s2">"2p"</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">vary_amp_ratio</span><span class="o">=</span><span class="n">vary_Hlike_amp_ratio</span>
    <span class="p">)</span>
    <span class="n">N_500eV_model</span> <span class="o">=</span> <span class="n">initialize_hci_composite_model</span><span class="p">(</span>
        <span class="s2">"N 500eV Region"</span><span class="p">,</span>
        <span class="p">[</span><span class="n">N6_1s3p_model</span><span class="p">,</span> <span class="n">N7_2p_model</span><span class="p">],</span>
        <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span>
        <span class="n">peak_component_name</span><span class="o">=</span><span class="s2">"N7 2p 2P* J=3/2"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">models_dict</span><span class="p">[</span><span class="n">N_500eV_model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_500eV_model</span>
    <span class="c1"># 660 eV region of H-/He-like O</span>
    <span class="n">O8_2p_model</span> <span class="o">=</span> <span class="n">initialize_HLike_2P_model</span><span class="p">(</span>
        <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"2p"</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">,</span> <span class="n">vary_amp_ratio</span><span class="o">=</span><span class="n">vary_Hlike_amp_ratio</span>
    <span class="p">)</span>
    <span class="n">O7_1s3p_model</span> <span class="o">=</span> <span class="n">initialize_hci_line_model</span><span class="p">(</span><span class="s2">"O7 1s.3p 1P* J=1"</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
    <span class="n">O_660eV_model</span> <span class="o">=</span> <span class="n">initialize_hci_composite_model</span><span class="p">(</span>
        <span class="s2">"O 660eV Region"</span><span class="p">,</span>
        <span class="p">[</span><span class="n">O8_2p_model</span><span class="p">,</span> <span class="n">O7_1s3p_model</span><span class="p">],</span>
        <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span>
        <span class="n">peak_component_name</span><span class="o">=</span><span class="s2">"O8 2p 2P* J=3/2"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">models_dict</span><span class="p">[</span><span class="n">O_660eV_model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">O_660eV_model</span>

    <span class="k">return</span> <span class="n">models_dict</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h3 id="bookkeeping">Bookkeeping</h3>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.import_asd"></a>
<div class="doc doc-contents first">
<p>import_asd.py</p>
<p>Tool for converting a NIST ASD levels sql dump into a pickle file</p>
<p>February 2020
Paul Szypryt</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.import_asd.parseLine">
<code class="highlight language-python"><span class="n">parseLine</span><span class="p">(</span><span class="n">energyLevelsDict</span><span class="p">,</span> <span class="n">fieldNamesDict</span><span class="p">,</span> <span class="n">formattedLine</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Parse a line from the ASD sql dump and add it to the energyLevelsDict</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>energyLevelsDict</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>[<span title="int">int</span>, <span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="float">float</span>]]]]</code>)
              –
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
<li>
<b><code>fieldNamesDict</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>)
              –
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
<li>
<b><code>formattedLine</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/import_asd.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parseLine</span><span class="p">(</span>
    <span class="n">energyLevelsDict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]],</span> <span class="n">fieldNamesDict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">formattedLine</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Parse a line from the ASD sql dump and add it to the energyLevelsDict</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energyLevelsDict : dict[str, dict[int, dict[str, list[float]]]]</span>
<span class="sd">        _description_</span>
<span class="sd">    fieldNamesDict : dict[str, Any]</span>
<span class="sd">        _description_</span>
<span class="sd">    formattedLine : str</span>
<span class="sd">        _description_</span>
<span class="sd">    """</span>
    <span class="n">lineAsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">formattedLine</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">iEntry</span> <span class="ow">in</span> <span class="n">lineAsArray</span><span class="p">:</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"element"</span><span class="p">)]</span>
        <span class="n">spectr_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"spectr_charge"</span><span class="p">)])</span>
        <span class="c1"># Pull information that will be used to name dictionary keys</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"conf"</span><span class="p">)]</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"term"</span><span class="p">)]</span>
        <span class="n">j_val</span> <span class="o">=</span> <span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"j_val"</span><span class="p">)]</span>
        <span class="c1"># Pull energy and uncertainty</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"energy"</span><span class="p">)]</span>  <span class="c1"># cm^-1, str</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">iEntry</span><span class="p">[</span><span class="n">fieldNamesDict</span><span class="p">[</span><span class="s2">"ASD_Levels"</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"unc"</span><span class="p">)]</span>  <span class="c1"># cm^-1, str</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">energy_inv_cm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>  <span class="c1"># cm^-1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">energy_inv_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unc_inv_cm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">unc</span><span class="p">)</span>  <span class="c1"># cm^-1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">unc_inv_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="ow">and</span> <span class="n">term</span> <span class="ow">and</span> <span class="n">term</span> <span class="o">!=</span> <span class="s2">"*"</span><span class="p">:</span>
            <span class="c1"># Set up upper level dictionary</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">energyLevelsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">energyLevelsDict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">spectr_charge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">energyLevelsDict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">energyLevelsDict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectr_charge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">levelName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> J=</span><span class="si">{</span><span class="n">j_val</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">energyLevelsDict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">spectr_charge</span><span class="p">][</span><span class="n">levelName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy_inv_cm</span><span class="p">,</span> <span class="n">unc_inv_cm</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.import_asd.write_asd_pickle">
<code class="highlight language-python"><span class="n">write_asd_pickle</span><span class="p">(</span><span class="n">inputFilename</span><span class="p">,</span> <span class="n">outputFilename</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Write the levels from a NIST Atomic Spectra Database SQL dump to a pickle file</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>inputFilename</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>The ASD's sql dump file name</p>
</div>
</li>
<li>
<b><code>outputFilename</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>The pickle file name to write the output dictionary to</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/import_asd.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_asd_pickle</span><span class="p">(</span><span class="n">inputFilename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outputFilename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Write the levels from a NIST Atomic Spectra Database SQL dump to a pickle file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inputFilename : str</span>
<span class="sd">        The ASD's sql dump file name</span>
<span class="sd">    outputFilename : str</span>
<span class="sd">        The pickle file name to write the output dictionary to</span>
<span class="sd">    """</span>
    <span class="n">createTableString</span> <span class="o">=</span> <span class="s2">"CREATE TABLE"</span>
    <span class="n">valueSearchString</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\`([^\`]*)\`"</span>
    <span class="n">tableName</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">fieldNamesDict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">energyLevelsDict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inputFilename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">ASD_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ASD_file</span><span class="p">:</span>
            <span class="c1"># Create dictionary of field names for various tables</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">createTableString</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">valueSearchString</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fieldNamesDict</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">tableName</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"`"</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">valueSearchString</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fieldNamesDict</span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Parse Levels portion</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"INSERT INTO `ASD_Levels` VALUES"</span><span class="p">):</span>
                <span class="n">partitionedLine</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">" VALUES "</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">nullReplacedLine</span> <span class="o">=</span> <span class="n">partitionedLine</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"NULL"</span><span class="p">,</span> <span class="s2">"''"</span><span class="p">)</span>
                <span class="n">formattedLine</span> <span class="o">=</span> <span class="n">nullReplacedLine</span>
                <span class="k">if</span> <span class="n">nullReplacedLine</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">";"</span><span class="p">:</span>
                    <span class="n">formattedLine</span> <span class="o">=</span> <span class="n">nullReplacedLine</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">parseLine</span><span class="p">(</span><span class="n">energyLevelsDict</span><span class="p">,</span> <span class="n">fieldNamesDict</span><span class="p">,</span> <span class="n">formattedLine</span><span class="p">)</span>

    <span class="c1"># Sort levels within an element/charge state by energy</span>
    <span class="n">outputDict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">iElement</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">energyLevelsDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">iCharge</span><span class="p">,</span> <span class="n">chargestate</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">energyOrder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chargestate</span><span class="o">.</span><span class="n">values</span><span class="p">()))[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">orderedKeys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chargestate</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="n">energyOrder</span><span class="p">]</span>
            <span class="n">orderedValues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chargestate</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="n">energyOrder</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iKey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orderedKeys</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">iElement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outputDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">outputDict</span><span class="p">[</span><span class="n">iElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">iCharge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outputDict</span><span class="p">[</span><span class="n">iElement</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">outputDict</span><span class="p">[</span><span class="n">iElement</span><span class="p">][</span><span class="n">iCharge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">outputDict</span><span class="p">[</span><span class="n">iElement</span><span class="p">][</span><span class="n">iCharge</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">iKey</span><span class="p">)]</span> <span class="o">=</span> <span class="n">orderedValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Write dict to pickle file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputFilename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">outputDict</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.calibration.nist_xray_database"></a>
<div class="doc doc-contents first">
<p>nist_xray_database</p>
<p>Download the NIST x-ray line database from the website, and parse the downloaded data into useable form.</p>
<p>For loading a file (locally, from disk) and plotting some information:
* NISTXrayDBFile
* plot_line_uncertainties</p>
<p>For updating the data files:
* NISTXrayDBRetrieve
* GetAllLines</p>
<p>Basic usage (assuming you put the x-ray files in
${MASS_HOME}/mass2/calibration/nist_xray_data.dat):</p>
<p>J. Fowler, NIST
February 2014</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayDBFile">
<code>NISTXrayDBFile</code>
</h2>
<div class="doc doc-contents">
<p>A NIST X-ray database file, loaded from disk.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NISTXrayDBFile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A NIST X-ray database file, loaded from disk."""</span>

    <span class="n">DEFAULT_FILENAMES</span> <span class="o">=</span> <span class="s2">"nist_xray_data.dat"</span><span class="p">,</span> <span class="s2">"low_z_xray_data.dat"</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">filenames</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize the database from 1 or more &lt;filenames&gt;, which point to</span>
<span class="sd">        files downloaded using NISTXrayDBRetrieve. If the list is empty (the</span>
<span class="sd">        default), then the file named by self.DEFAULT_FILENAME will be used."""</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alllines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_FILENAMES</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">' is not a readable file with X-ray database info! Continuing..."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">"Theory"</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">"Blend"</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">"Ref."</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">for</span> <span class="n">textline</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xrayline</span> <span class="o">=</span> <span class="n">NISTXrayLine</span><span class="p">(</span><span class="n">textline</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">xrayline</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xrayline</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alllines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xrayline</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">LINE_NICKNAMES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"KA1"</span><span class="p">:</span> <span class="s2">"KL3"</span><span class="p">,</span>
        <span class="s2">"KA2"</span><span class="p">:</span> <span class="s2">"KL2"</span><span class="p">,</span>
        <span class="s2">"KB1"</span><span class="p">:</span> <span class="s2">"KM3"</span><span class="p">,</span>
        <span class="s2">"KB3"</span><span class="p">:</span> <span class="s2">"KM2"</span><span class="p">,</span>
        <span class="s2">"KB5"</span><span class="p">:</span> <span class="s2">"KM5"</span><span class="p">,</span>
        <span class="s2">"LA1"</span><span class="p">:</span> <span class="s2">"L3M5"</span><span class="p">,</span>
        <span class="s2">"LA2"</span><span class="p">:</span> <span class="s2">"L3M4"</span><span class="p">,</span>
        <span class="s2">"Ll"</span><span class="p">:</span> <span class="s2">"L3M1"</span><span class="p">,</span>
        <span class="s2">"LB3"</span><span class="p">:</span> <span class="s2">"L1M3"</span><span class="p">,</span>
        <span class="s2">"LB1"</span><span class="p">:</span> <span class="s2">"L2M4"</span><span class="p">,</span>
        <span class="s2">"LB2"</span><span class="p">:</span> <span class="s2">"L3N5"</span><span class="p">,</span>
        <span class="s2">"LG1"</span><span class="p">:</span> <span class="s2">"L2N4"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_lines_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linetype</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="s2">"NISTXrayLine"</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return a tuple containing all lines of a certain type, e.g., "KL3".</span>
<span class="sd">        See self.LINE_NICKNAMES for some known line "nicknames"."""</span>
        <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">"ALPHA"</span> <span class="ow">in</span> <span class="n">linetype</span><span class="p">:</span>
            <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"ALPHA"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">"BETA"</span> <span class="ow">in</span> <span class="n">linetype</span><span class="p">:</span>
            <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"BETA"</span><span class="p">,</span> <span class="s2">"B"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">"GAMMA"</span> <span class="ow">in</span> <span class="n">linetype</span><span class="p">:</span>
            <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"GAMMA"</span><span class="p">,</span> <span class="s2">"G"</span><span class="p">)</span>
        <span class="n">linetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">linetype</span><span class="p">,</span> <span class="n">linetype</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ELEMENTS</span><span class="p">:</span>
            <span class="n">linename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">if</span> <span class="n">linename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">linename</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"NISTXrayLine"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get a line by its full name, e.g., "Fe KL3", or by a nickname, e.g., "Fe Kalpha1".</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            The line name or nickname</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NISTXrayLine</span>
<span class="sd">            The matching NISTXrayLine object</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            If not found</span>
<span class="sd">        """</span>
        <span class="n">element</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">lcline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">lcline</span> <span class="o">=</span> <span class="n">lcline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"alpha"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
        <span class="n">lcline</span> <span class="o">=</span> <span class="n">lcline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"beta"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">)</span>
        <span class="n">lcline</span> <span class="o">=</span> <span class="n">lcline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"gamma"</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lcline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="p">[</span><span class="n">lcline</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is not a known line or line nickname"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayDBFile.__getitem__">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Get a line by its full name, e.g., "Fe KL3", or by a nickname, e.g., "Fe Kalpha1".</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>key</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>The line name or nickname</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="NISTXrayLine (mass2.calibration.nist_xray_database.NISTXrayLine)" href="#mass2.calibration.nist_xray_database.NISTXrayLine">NISTXrayLine</a></code>
              –
              <div class="doc-md-description">
<p>The matching NISTXrayLine object</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="KeyError">KeyError</span></code>
              –
              <div class="doc-md-description">
<p>If not found</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"NISTXrayLine"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Get a line by its full name, e.g., "Fe KL3", or by a nickname, e.g., "Fe Kalpha1".</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : str</span>
<span class="sd">        The line name or nickname</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NISTXrayLine</span>
<span class="sd">        The matching NISTXrayLine object</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    KeyError</span>
<span class="sd">        If not found</span>
<span class="sd">    """</span>
    <span class="n">element</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">lcline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">lcline</span> <span class="o">=</span> <span class="n">lcline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"alpha"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
    <span class="n">lcline</span> <span class="o">=</span> <span class="n">lcline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"beta"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">)</span>
    <span class="n">lcline</span> <span class="o">=</span> <span class="n">lcline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"gamma"</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lcline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="p">[</span><span class="n">lcline</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is not a known line or line nickname"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayDBFile.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">filenames</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Initialize the database from 1 or more <filenames>, which point to
files downloaded using NISTXrayDBRetrieve. If the list is empty (the
default), then the file named by self.DEFAULT_FILENAME will be used.</filenames></p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">filenames</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize the database from 1 or more &lt;filenames&gt;, which point to</span>
<span class="sd">    files downloaded using NISTXrayDBRetrieve. If the list is empty (the</span>
<span class="sd">    default), then the file named by self.DEFAULT_FILENAME will be used."""</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alllines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_FILENAMES</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">loaded_filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">' is not a readable file with X-ray database info! Continuing..."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">"Theory"</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">"Blend"</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">"Ref."</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">for</span> <span class="n">textline</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xrayline</span> <span class="o">=</span> <span class="n">NISTXrayLine</span><span class="p">(</span><span class="n">textline</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">xrayline</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xrayline</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alllines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xrayline</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayDBFile.get_lines_by_type">
<code class="highlight language-python"><span class="n">get_lines_by_type</span><span class="p">(</span><span class="n">linetype</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a tuple containing all lines of a certain type, e.g., "KL3".
See self.LINE_NICKNAMES for some known line "nicknames".</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_lines_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linetype</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="s2">"NISTXrayLine"</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return a tuple containing all lines of a certain type, e.g., "KL3".</span>
<span class="sd">    See self.LINE_NICKNAMES for some known line "nicknames"."""</span>
    <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">"ALPHA"</span> <span class="ow">in</span> <span class="n">linetype</span><span class="p">:</span>
        <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"ALPHA"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"BETA"</span> <span class="ow">in</span> <span class="n">linetype</span><span class="p">:</span>
        <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"BETA"</span><span class="p">,</span> <span class="s2">"B"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"GAMMA"</span> <span class="ow">in</span> <span class="n">linetype</span><span class="p">:</span>
        <span class="n">linetype</span> <span class="o">=</span> <span class="n">linetype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"GAMMA"</span><span class="p">,</span> <span class="s2">"G"</span><span class="p">)</span>
    <span class="n">linetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_NICKNAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">linetype</span><span class="p">,</span> <span class="n">linetype</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ELEMENTS</span><span class="p">:</span>
        <span class="n">linename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">linetype</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="n">linename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">linename</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayLine">
<code>NISTXrayLine</code>
</h2>
<div class="doc doc-contents">
<p>A single line from the NIST X-ray database.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NISTXrayLine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A single line from the NIST X-ray database."""</span>

    <span class="n">DEFAULT_COLUMN_DEFS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"element"</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">"transition"</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="s2">"peak"</span><span class="p">:</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">59</span><span class="p">),</span>
        <span class="s2">"peak_unc"</span><span class="p">:</span> <span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span>
        <span class="s2">"blend"</span><span class="p">:</span> <span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">79</span><span class="p">),</span>
        <span class="s2">"ref"</span><span class="p">:</span> <span class="p">(</span><span class="mi">81</span><span class="p">,</span> <span class="mi">91</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">textline</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_defs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize a NISTXrayLine from a line of text found in the NIST x-ray database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        textline : str</span>
<span class="sd">            The text line from the database file</span>
<span class="sd">        column_defs : dict[str, tuple[int, int]] | None, optional</span>
<span class="sd">            The column boundaries of the relevant data, by default None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blend</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">if</span> <span class="n">column_defs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">column_defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_COLUMN_DEFS</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">colrange</span> <span class="ow">in</span> <span class="n">column_defs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">colrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">colrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">textline</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transition</span><span class="si">}</span><span class="s2">"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">textline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The user-friendly string representation of the line"""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transition</span><span class="si">}</span><span class="s2"> line: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> eV"</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">"The code representation of the line"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayLine.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">textline</span><span class="p">,</span> <span class="n">column_defs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Initialize a NISTXrayLine from a line of text found in the NIST x-ray database file.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>textline</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
<p>The text line from the database file</p>
</div>
</li>
<li>
<b><code>column_defs</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]] | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>The column boundaries of the relevant data, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">textline</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_defs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize a NISTXrayLine from a line of text found in the NIST x-ray database file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    textline : str</span>
<span class="sd">        The text line from the database file</span>
<span class="sd">    column_defs : dict[str, tuple[int, int]] | None, optional</span>
<span class="sd">        The column boundaries of the relevant data, by default None</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transition</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">blend</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span> <span class="n">column_defs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column_defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_COLUMN_DEFS</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">colrange</span> <span class="ow">in</span> <span class="n">column_defs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">colrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">colrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">textline</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transition</span><span class="si">}</span><span class="s2">"</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">textline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayLine.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>The code representation of the line</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s2">"The code representation of the line"</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.calibration.nist_xray_database.NISTXrayLine.__str__">
<code class="highlight language-python"><span class="fm">__str__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>The user-friendly string representation of the line</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The user-friendly string representation of the line"""</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transition</span><span class="si">}</span><span class="s2"> line: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_unc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> eV"</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.nist_xray_database.plot_line_energies">
<code class="highlight language-python"><span class="n">plot_line_energies</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>Plot the energies of some common families of lines from the NIST X-ray database.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_line_energies</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the energies of some common families of lines from the NIST X-ray database."""</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">NISTXrayDBFile</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral</span>
    <span class="n">transitions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"KL2"</span><span class="p">,</span>
        <span class="s2">"KL3"</span><span class="p">,</span>
        <span class="s2">"KM5"</span><span class="p">,</span>
        <span class="s2">"KM3"</span><span class="p">,</span>
        <span class="s2">"KM2"</span><span class="p">,</span>
        <span class="s2">"L3M5"</span><span class="p">,</span>
        <span class="s2">"L3M4"</span><span class="p">,</span>
        <span class="s2">"L3M1"</span><span class="p">,</span>
        <span class="s2">"L2M4"</span><span class="p">,</span>
        <span class="s2">"L2N4"</span><span class="p">,</span>
        <span class="s2">"L3N5"</span><span class="p">,</span>
        <span class="s2">"L1M3"</span><span class="p">,</span>
        <span class="s2">"L3N7"</span><span class="p">,</span>
        <span class="s2">"M5N7"</span><span class="p">,</span>
        <span class="s2">"M5N6"</span><span class="p">,</span>
        <span class="s2">"M4N6"</span><span class="p">,</span>
        <span class="s2">"M3N5"</span><span class="p">,</span>
        <span class="s2">"M3N4"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">linetype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_lines_by_type</span><span class="p">(</span><span class="n">linetype</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ATOMIC_NUMBERS</span><span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">element</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">peak</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="s2">"o-"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="n">linetype</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper left"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ELEMENTS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.calibration.nist_xray_database.plot_line_uncertainties">
<code class="highlight language-python"><span class="n">plot_line_uncertainties</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>Plot the uncertainties of some common families of lines from the NIST X-ray database.</p>
<details class="quote">
<summary>Source code in <code>mass2/calibration/nist_xray_database.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_line_uncertainties</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the uncertainties of some common families of lines from the NIST X-ray database."""</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">NISTXrayDBFile</span><span class="p">()</span>
    <span class="n">transitions</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"KL3"</span><span class="p">,</span> <span class="s2">"KL2"</span><span class="p">,</span> <span class="s2">"KM3"</span><span class="p">,</span> <span class="s2">"KM5"</span><span class="p">,</span> <span class="s2">"L3M5"</span><span class="p">,</span> <span class="s2">"L3M4"</span><span class="p">,</span> <span class="s2">"L2M4"</span><span class="p">,</span> <span class="s2">"L3N5"</span><span class="p">,</span> <span class="s2">"L2N4"</span><span class="p">,</span> <span class="s2">"L1M3"</span><span class="p">,</span> <span class="s2">"L3N7"</span><span class="p">,</span> <span class="s2">"L3M1"</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"KL3"</span><span class="p">:</span> <span class="s2">"K$</span><span class="se">\\</span><span class="s2">alpha_1$: Intense"</span><span class="p">,</span>
        <span class="s2">"KL2"</span><span class="p">:</span> <span class="s2">"K$</span><span class="se">\\</span><span class="s2">alpha_2$: Intense, but not easily resolved"</span><span class="p">,</span>
        <span class="s2">"KM3"</span><span class="p">:</span> <span class="s2">"K$</span><span class="se">\\</span><span class="s2">beta_1$: Intense"</span><span class="p">,</span>
        <span class="s2">"KM2"</span><span class="p">:</span> <span class="s2">"K$</span><span class="se">\\</span><span class="s2">beta_3$: Intense, usually unresolvable"</span><span class="p">,</span>
        <span class="s2">"KM5"</span><span class="p">:</span> <span class="s2">"K$</span><span class="se">\\</span><span class="s2">beta_5$: Weak line on high-E tail of K$</span><span class="se">\\</span><span class="s2">beta_1$"</span><span class="p">,</span>
        <span class="s2">"L3M5"</span><span class="p">:</span> <span class="s2">"L$</span><span class="se">\\</span><span class="s2">alpha_1$: Prominent"</span><span class="p">,</span>
        <span class="s2">"L3M4"</span><span class="p">:</span> <span class="s2">"L$</span><span class="se">\\</span><span class="s2">alpha_2$: Small satellite"</span><span class="p">,</span>
        <span class="s2">"L2M4"</span><span class="p">:</span> <span class="s2">"L$</span><span class="se">\\</span><span class="s2">beta_1$: Prominent"</span><span class="p">,</span>
        <span class="s2">"L3N5"</span><span class="p">:</span> <span class="s2">"L$</span><span class="se">\\</span><span class="s2">beta_2$: Prominent"</span><span class="p">,</span>
        <span class="s2">"L2N4"</span><span class="p">:</span> <span class="s2">"K$</span><span class="se">\\</span><span class="s2">gamma_1$: Weaker"</span><span class="p">,</span>
        <span class="s2">"L1M3"</span><span class="p">:</span> <span class="s2">"L$</span><span class="se">\\</span><span class="s2">beta_3$: Weaker"</span><span class="p">,</span>
        <span class="s2">"L3N7"</span><span class="p">:</span> <span class="s2">"Lu: barely visible"</span><span class="p">,</span>
        <span class="s2">"L3M1"</span><span class="p">:</span> <span class="s2">"L$</span><span class="se">\\</span><span class="s2">ell$: very weak"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">NX</span><span class="p">,</span> <span class="n">NY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NY</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">tr</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">NX</span> <span class="o">*</span> <span class="p">(</span><span class="n">NY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Line energy (eV)"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">NX</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Line uncertainty (eV)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mf">3e4</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">transition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">transition</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">peak_unc</span><span class="p">,</span> <span class="s2">"or"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">peak_unc</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h2 id="materials-transmission">Materials transmission</h2>
<div class="doc doc-object doc-module">
<a id="mass2.materials.efficiency_models"></a>
<div class="doc doc-contents first">
<p>Models for X-ray filter and detector efficiency.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.materials.efficiency_models.Filter">
<code>Filter</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Represent a single material layer in a FilterStack</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Represent a single material layer in a FilterStack"""</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">material</span><span class="p">:</span> <span class="n">NDArray</span>
    <span class="n">atomic_number</span><span class="p">:</span> <span class="n">NDArray</span>
    <span class="n">density_g_per_cm3</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">thickness_cm</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">fill_fraction</span><span class="p">:</span> <span class="n">Variable</span> <span class="o">=</span> <span class="n">ufloat</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">absorber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the efficiency of this Filter at the given x-ray energies."""</span>
        <span class="n">optical_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
            <span class="n">xraydb</span><span class="o">.</span><span class="n">material_mu</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_cm</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">individual_transmittance</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth</span><span class="p">)</span>
        <span class="n">transmittance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">individual_transmittance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorber</span><span class="p">:</span>
            <span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">transmittance</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="n">transmittance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uncertain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">efficiency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">efficiency</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a string representation of the Filter object."""</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">("</span>
        <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">thick</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_cm</span><span class="p">):</span>
            <span class="n">area_density</span> <span class="o">=</span> <span class="n">density</span> <span class="o">*</span> <span class="n">thick</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">area_density</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> g/cm^2, "</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"fill_fraction=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, absorber=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">absorber</span><span class="si">}</span><span class="s2">)"</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">newfilter</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">material</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">area_density_g_per_cm2</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thickness_nm</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">density_g_per_cm3</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_fraction</span><span class="p">:</span> <span class="n">Variable</span> <span class="o">=</span> <span class="n">ufloat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span>
        <span class="n">absorber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Filter"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a Filter from the given parameters, filling in defaults as needed."""</span>
        <span class="n">material</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">iMaterial</span><span class="p">)</span> <span class="k">for</span> <span class="n">iMaterial</span> <span class="ow">in</span> <span class="n">material</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fill_fraction</span> <span class="o">=</span> <span class="n">ensure_uncertain</span><span class="p">(</span><span class="n">fill_fraction</span><span class="p">)</span>

        <span class="c1"># Save density, either default values for that element, or the given density.</span>
        <span class="k">if</span> <span class="n">density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_density</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iAtomicNumber</span><span class="p">))</span> <span class="k">for</span> <span class="n">iAtomicNumber</span> <span class="ow">in</span> <span class="n">atomic_number</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">material</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">density_g_per_cm3</span><span class="p">)</span>

        <span class="c1"># Handle input value of areal density or thickness, but not both.</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">area_density_g_per_cm2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thickness_nm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">"must specify either areal density or thickness, not both"</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">thickness_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thickness_nm</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-7</span>
        <span class="k">elif</span> <span class="n">area_density_g_per_cm2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">area_density_g_per_cm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area_density_g_per_cm2</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">area_density_g_per_cm2</span> <span class="o">/</span> <span class="n">density_g_per_cm3</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thickness_cm</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"must specify either areal density or thickness, not both"</span><span class="p">)</span>
        <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">ensure_uncertain</span><span class="p">(</span><span class="n">thickness_cm</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">thickness_cm</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="n">thickness_cm</span><span class="p">,</span> <span class="n">fill_fraction</span><span class="p">,</span> <span class="n">absorber</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.Filter.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a string representation of the Filter object.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a string representation of the Filter object."""</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">("</span>
    <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">thick</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_cm</span><span class="p">):</span>
        <span class="n">area_density</span> <span class="o">=</span> <span class="n">density</span> <span class="o">*</span> <span class="n">thick</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">material</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">area_density</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> g/cm^2, "</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"fill_fraction=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, absorber=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">absorber</span><span class="si">}</span><span class="s2">)"</span>
    <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.Filter.get_efficiency">
<code class="highlight language-python"><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the efficiency of this Filter at the given x-ray energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the efficiency of this Filter at the given x-ray energies."""</span>
    <span class="n">optical_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
        <span class="n">xraydb</span><span class="o">.</span><span class="n">material_mu</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_cm</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="n">individual_transmittance</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth</span><span class="p">)</span>
    <span class="n">transmittance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">individual_transmittance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorber</span><span class="p">:</span>
        <span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">transmittance</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="n">transmittance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_fraction</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uncertain</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">efficiency</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">efficiency</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.Filter.newfilter">
<code class="highlight language-python"><span class="n">newfilter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">area_density_g_per_cm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_fraction</span><span class="o">=</span><span class="n">ufloat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-08</span><span class="p">),</span> <span class="n">absorber</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a Filter from the given parameters, filling in defaults as needed.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">newfilter</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">material</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">area_density_g_per_cm2</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">thickness_nm</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">density_g_per_cm3</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fill_fraction</span><span class="p">:</span> <span class="n">Variable</span> <span class="o">=</span> <span class="n">ufloat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span>
    <span class="n">absorber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Filter"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Filter from the given parameters, filling in defaults as needed."""</span>
    <span class="n">material</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">(</span><span class="n">iMaterial</span><span class="p">)</span> <span class="k">for</span> <span class="n">iMaterial</span> <span class="ow">in</span> <span class="n">material</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fill_fraction</span> <span class="o">=</span> <span class="n">ensure_uncertain</span><span class="p">(</span><span class="n">fill_fraction</span><span class="p">)</span>

    <span class="c1"># Save density, either default values for that element, or the given density.</span>
    <span class="k">if</span> <span class="n">density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_density</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iAtomicNumber</span><span class="p">))</span> <span class="k">for</span> <span class="n">iAtomicNumber</span> <span class="ow">in</span> <span class="n">atomic_number</span><span class="p">],</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">material</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">density_g_per_cm3</span><span class="p">)</span>

    <span class="c1"># Handle input value of areal density or thickness, but not both.</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">area_density_g_per_cm2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thickness_nm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">"must specify either areal density or thickness, not both"</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">thickness_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thickness_nm</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-7</span>
    <span class="k">elif</span> <span class="n">area_density_g_per_cm2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">area_density_g_per_cm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area_density_g_per_cm2</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">area_density_g_per_cm2</span> <span class="o">/</span> <span class="n">density_g_per_cm3</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thickness_cm</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"must specify either areal density or thickness, not both"</span><span class="p">)</span>
    <span class="n">thickness_cm</span> <span class="o">=</span> <span class="n">ensure_uncertain</span><span class="p">(</span><span class="n">thickness_cm</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">thickness_cm</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">density_g_per_cm3</span><span class="p">,</span> <span class="n">thickness_cm</span><span class="p">,</span> <span class="n">fill_fraction</span><span class="p">,</span> <span class="n">absorber</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack">
<code>FilterStack</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Represent a sequence of named materials</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterStack</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Represent a sequence of named materials"""</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">components</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">"Filter | FilterStack"</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">film</span><span class="p">:</span> <span class="s2">"Filter | FilterStack"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add a Filter or FilterStack to this FilterStack."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">film</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">area_density_g_per_cm2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thickness_nm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">density_g_per_cm3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_fraction</span><span class="p">:</span> <span class="n">Variable</span> <span class="o">=</span> <span class="n">ufloat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span>
        <span class="n">absorber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create and add a Filter layer to this FilterStack."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">material</span><span class="p">,</span>
                <span class="n">area_density_g_per_cm2</span><span class="o">=</span><span class="n">area_density_g_per_cm2</span><span class="p">,</span>
                <span class="n">thickness_nm</span><span class="o">=</span><span class="n">thickness_nm</span><span class="p">,</span>
                <span class="n">density_g_per_cm3</span><span class="o">=</span><span class="n">density_g_per_cm3</span><span class="p">,</span>
                <span class="n">fill_fraction</span><span class="o">=</span><span class="n">fill_fraction</span><span class="p">,</span>
                <span class="n">absorber</span><span class="o">=</span><span class="n">absorber</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the overall efficiency of this FilterStack at the given x-ray energies."""</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has no components of which to calculate efficiency"</span>
        <span class="n">individual_efficiency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">iComponent</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="n">uncertain</span><span class="p">)</span> <span class="k">for</span> <span class="n">iComponent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span>
        <span class="p">])</span>
        <span class="n">efficiency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">individual_efficiency</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uncertain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">efficiency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">efficiency</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Equivalent to get_efficiency."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="n">uncertain</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the efficiency of this FilterStack and its components."""</span>
        <span class="n">efficiency</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">efficiency</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"total"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Energy (keV)"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Efficiency (%)"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Efficiency"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">efficiency</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">efficiency</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span> <span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a string representation of the FilterStack object."""</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">"</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">")"</span>
        <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Equivalent to get_efficiency.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Equivalent to get_efficiency."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="n">uncertain</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a string representation of the FilterStack object.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a string representation of the FilterStack object."""</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">")"</span>
    <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack.add">
<code class="highlight language-python"><span class="n">add</span><span class="p">(</span><span class="n">film</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Add a Filter or FilterStack to this FilterStack.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">film</span><span class="p">:</span> <span class="s2">"Filter | FilterStack"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add a Filter or FilterStack to this FilterStack."""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">film</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack.add_filter">
<code class="highlight language-python"><span class="n">add_filter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">area_density_g_per_cm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_fraction</span><span class="o">=</span><span class="n">ufloat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-08</span><span class="p">),</span> <span class="n">absorber</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create and add a Filter layer to this FilterStack.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">material</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">area_density_g_per_cm2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">thickness_nm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">density_g_per_cm3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fill_fraction</span><span class="p">:</span> <span class="n">Variable</span> <span class="o">=</span> <span class="n">ufloat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span>
    <span class="n">absorber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create and add a Filter layer to this FilterStack."""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">material</span><span class="p">,</span>
            <span class="n">area_density_g_per_cm2</span><span class="o">=</span><span class="n">area_density_g_per_cm2</span><span class="p">,</span>
            <span class="n">thickness_nm</span><span class="o">=</span><span class="n">thickness_nm</span><span class="p">,</span>
            <span class="n">density_g_per_cm3</span><span class="o">=</span><span class="n">density_g_per_cm3</span><span class="p">,</span>
            <span class="n">fill_fraction</span><span class="o">=</span><span class="n">fill_fraction</span><span class="p">,</span>
            <span class="n">absorber</span><span class="o">=</span><span class="n">absorber</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack.get_efficiency">
<code class="highlight language-python"><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the overall efficiency of this FilterStack at the given x-ray energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the overall efficiency of this FilterStack at the given x-ray energies."""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has no components of which to calculate efficiency"</span>
    <span class="n">individual_efficiency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">iComponent</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">uncertain</span><span class="o">=</span><span class="n">uncertain</span><span class="p">)</span> <span class="k">for</span> <span class="n">iComponent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span>
    <span class="p">])</span>
    <span class="n">efficiency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">individual_efficiency</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uncertain</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">efficiency</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">efficiency</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.materials.efficiency_models.FilterStack.plot_efficiency">
<code class="highlight language-python"><span class="n">plot_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the efficiency of this FilterStack and its components.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xray_energies_eV</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the efficiency of this FilterStack and its components."""</span>
    <span class="n">efficiency</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">efficiency</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"total"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Energy (keV)"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Efficiency (%)"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Efficiency"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
        <span class="n">efficiency</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xray_energies_eV</span><span class="p">,</span> <span class="n">efficiency</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span> <span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.materials.efficiency_models.AlFilmWithOxide">
<code class="highlight language-python"><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="p">,</span> <span class="n">Al_density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_oxidized_surfaces</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">oxide_density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Create a Filter made of an alumninum film with oxides on one or both surfaces</p>
<p>Args:
    name: name given to filter object, e.g. '50K Filter'.
    Al_thickness_nm: thickness, in nm, of Al film
    Al_density_g_per_cm3: Al film density, in g/cm3, defaults to xraydb value
    num_oxidized_surfaces: Number of film surfaces that contain a native oxide, default 2
    oxide_density_g_per_cm3: Al2O3 oxide density, in g/cm3, defaults to bulk xraydb value</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">AlFilmWithOxide</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">Al_thickness_nm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">Al_density_g_per_cm3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_oxidized_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">oxide_density_g_per_cm3</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Filter made of an alumninum film with oxides on one or both surfaces</span>

<span class="sd">    Args:</span>
<span class="sd">        name: name given to filter object, e.g. '50K Filter'.</span>
<span class="sd">        Al_thickness_nm: thickness, in nm, of Al film</span>
<span class="sd">        Al_density_g_per_cm3: Al film density, in g/cm3, defaults to xraydb value</span>
<span class="sd">        num_oxidized_surfaces: Number of film surfaces that contain a native oxide, default 2</span>
<span class="sd">        oxide_density_g_per_cm3: Al2O3 oxide density, in g/cm3, defaults to bulk xraydb value</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">num_oxidized_surfaces</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="s2">"only 1 or 2 oxidzed surfaces allowed"</span>
    <span class="k">if</span> <span class="n">Al_density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Al_density_g_per_cm3</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_density</span><span class="p">(</span><span class="s2">"Al"</span><span class="p">))</span>
    <span class="n">arbE</span> <span class="o">=</span> <span class="mf">5000.0</span>  <span class="c1"># an arbitrary energy (5 keV) is used to get answers from material_mu_components()</span>
    <span class="n">oxide_dict</span> <span class="o">=</span> <span class="n">xraydb</span><span class="o">.</span><span class="n">material_mu_components</span><span class="p">(</span><span class="s2">"sapphire"</span><span class="p">,</span> <span class="n">arbE</span><span class="p">)</span>
    <span class="n">oxide_material</span> <span class="o">=</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="s2">"elements"</span><span class="p">]</span>
    <span class="n">oxide_mass_fractions</span> <span class="o">=</span> <span class="p">[</span><span class="n">oxide_dict</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="s2">"mass"</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oxide_material</span><span class="p">]</span>

    <span class="c1"># Assume oxidized surfaces are each 3 nm thick.</span>
    <span class="n">num_oxide_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxide_material</span><span class="p">)</span>
    <span class="n">oxide_thickness_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_oxidized_surfaces</span> <span class="o">*</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">num_oxide_elements</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">oxide_density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">oxide_density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">oxide_dict</span><span class="p">[</span><span class="s2">"density"</span><span class="p">],</span> <span class="n">num_oxide_elements</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">oxide_density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">oxide_density_g_per_cm3</span><span class="p">)</span>

    <span class="n">material</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="s2">"Al"</span><span class="p">,</span> <span class="n">oxide_material</span><span class="p">])</span>
    <span class="n">density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Al_density_g_per_cm3</span><span class="p">,</span> <span class="n">oxide_density_g_per_cm3</span> <span class="o">*</span> <span class="n">oxide_mass_fractions</span><span class="p">])</span>
    <span class="n">thickness_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Al_thickness_nm</span><span class="p">,</span> <span class="n">oxide_thickness_nm</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="n">thickness_nm</span><span class="p">,</span> <span class="n">density_g_per_cm3</span><span class="o">=</span><span class="n">density_g_per_cm3</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.materials.efficiency_models.AlFilmWithPolymer">
<code class="highlight language-python"><span class="n">AlFilmWithPolymer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="p">,</span> <span class="n">polymer_thickness_nm</span><span class="p">,</span> <span class="n">Al_density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_oxidized_surfaces</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">oxide_density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polymer_density_g_per_cm3</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Create a Filter made of an alumninum film with polymer backing</p>
<p>Args:
    name: name given to filter object, e.g. '50K Filter'.
    Al_thickness_nm: thickness, in nm, of Al film
    polymer_thickness_nm: thickness, in nm, of filter backside polymer
    Al_density_g_per_cm3: Al film density, in g/cm3, defaults to xraydb value
    num_oxidized_surfaces: Number of film surfaces that contain a native oxide, default 2
    oxide_density_g_per_cm3: Al2O3 oxide density, in g/cm3, defaults to bulk xraydb value
    polymer_density_g_per_cm3: Polymer density, in g/cm3, defaults to Kapton</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">AlFilmWithPolymer</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">Al_thickness_nm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">polymer_thickness_nm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">Al_density_g_per_cm3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_oxidized_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">oxide_density_g_per_cm3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">polymer_density_g_per_cm3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Filter made of an alumninum film with polymer backing</span>

<span class="sd">    Args:</span>
<span class="sd">        name: name given to filter object, e.g. '50K Filter'.</span>
<span class="sd">        Al_thickness_nm: thickness, in nm, of Al film</span>
<span class="sd">        polymer_thickness_nm: thickness, in nm, of filter backside polymer</span>
<span class="sd">        Al_density_g_per_cm3: Al film density, in g/cm3, defaults to xraydb value</span>
<span class="sd">        num_oxidized_surfaces: Number of film surfaces that contain a native oxide, default 2</span>
<span class="sd">        oxide_density_g_per_cm3: Al2O3 oxide density, in g/cm3, defaults to bulk xraydb value</span>
<span class="sd">        polymer_density_g_per_cm3: Polymer density, in g/cm3, defaults to Kapton</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">num_oxidized_surfaces</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="s2">"only 1 or 2 oxidzed surfaces allowed"</span>
    <span class="k">if</span> <span class="n">Al_density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Al_density_g_per_cm3</span> <span class="o">=</span> <span class="n">xraydb</span><span class="o">.</span><span class="n">atomic_density</span><span class="p">(</span><span class="s2">"Al"</span><span class="p">)</span>

    <span class="n">arbE</span> <span class="o">=</span> <span class="mf">5000.0</span>  <span class="c1"># an arbitrary energy (5 keV) is used to get answers from material_mu_components()</span>
    <span class="n">oxide_dict</span> <span class="o">=</span> <span class="n">xraydb</span><span class="o">.</span><span class="n">material_mu_components</span><span class="p">(</span><span class="s2">"sapphire"</span><span class="p">,</span> <span class="n">arbE</span><span class="p">)</span>
    <span class="n">oxide_thickness_nm</span> <span class="o">=</span> <span class="n">num_oxidized_surfaces</span> <span class="o">*</span> <span class="mf">3.0</span>  <span class="c1"># assume 3 nm per oxidized surface</span>
    <span class="n">oxide_material</span> <span class="o">=</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="s2">"elements"</span><span class="p">]</span>
    <span class="n">oxide_mass_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">oxide_dict</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="s2">"mass"</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oxide_material</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">oxide_density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">oxide_density_g_per_cm3</span> <span class="o">=</span> <span class="n">oxide_dict</span><span class="p">[</span><span class="s2">"density"</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oxide_material</span><span class="p">))</span>

    <span class="n">polymer_dict</span> <span class="o">=</span> <span class="n">xraydb</span><span class="o">.</span><span class="n">material_mu_components</span><span class="p">(</span><span class="s2">"kapton"</span><span class="p">,</span> <span class="n">arbE</span><span class="p">)</span>
    <span class="n">polymer_material</span> <span class="o">=</span> <span class="n">polymer_dict</span><span class="p">[</span><span class="s2">"elements"</span><span class="p">]</span>
    <span class="n">polymer_thickness_nm_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polymer_material</span><span class="p">))</span> <span class="o">*</span> <span class="n">polymer_thickness_nm</span>
    <span class="n">polymer_mass_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">polymer_dict</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">polymer_dict</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">polymer_dict</span><span class="p">[</span><span class="s2">"mass"</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">polymer_material</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">polymer_density_g_per_cm3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">polymer_density_g_per_cm3</span> <span class="o">=</span> <span class="n">polymer_dict</span><span class="p">[</span><span class="s2">"density"</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polymer_material</span><span class="p">))</span>

    <span class="n">material</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="s2">"Al"</span><span class="p">,</span> <span class="n">oxide_material</span><span class="p">,</span> <span class="n">polymer_material</span><span class="p">])</span>
    <span class="n">density_g_per_cm3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
        <span class="p">[</span><span class="n">Al_density_g_per_cm3</span><span class="p">],</span>
        <span class="n">oxide_density_g_per_cm3</span> <span class="o">*</span> <span class="n">oxide_mass_fractions</span><span class="p">,</span>
        <span class="n">polymer_density_g_per_cm3</span> <span class="o">*</span> <span class="n">polymer_mass_fractions</span><span class="p">,</span>
    <span class="p">])</span>
    <span class="n">thickness_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Al_thickness_nm</span><span class="p">,</span> <span class="n">oxide_thickness_nm</span><span class="p">,</span> <span class="n">polymer_thickness_nm_array</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">material</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="n">thickness_nm</span><span class="p">,</span> <span class="n">density_g_per_cm3</span><span class="o">=</span><span class="n">density_g_per_cm3</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.materials.efficiency_models.LEX_HT">
<code class="highlight language-python"><span class="n">LEX_HT</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Create an Al film with polymer and stainless steel backing.</p>
<p>Models the LEX-HT vacuum window.</p>
<p>Args:
    name: name given to filter object, e.g. '50K Filter'.</p>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">LEX_HT</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FilterStack</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create an Al film with polymer and stainless steel backing.</span>

<span class="sd">    Models the LEX-HT vacuum window.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: name given to filter object, e.g. '50K Filter'.</span>
<span class="sd">    """</span>
    <span class="c1"># Set up Al + polyimide film</span>
    <span class="n">film_material</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">"H"</span><span class="p">,</span> <span class="s2">"N"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"Al"</span><span class="p">]</span>
    <span class="n">film_area_density_g_per_cm2_given</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.7e-5</span><span class="p">,</span> <span class="mf">2.6e-6</span><span class="p">,</span> <span class="mf">7.2e-6</span><span class="p">,</span> <span class="mf">1.7e-5</span><span class="p">,</span> <span class="mf">1.7e-5</span><span class="p">])</span>
    <span class="n">film_area_density_g_per_cm2</span> <span class="o">=</span> <span class="n">with_fractional_uncertainty</span><span class="p">(</span><span class="n">film_area_density_g_per_cm2_given</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>
    <span class="n">film1</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"LEX_HT Film"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="n">film_material</span><span class="p">,</span> <span class="n">area_density_g_per_cm2</span><span class="o">=</span><span class="n">film_area_density_g_per_cm2</span><span class="p">)</span>
    <span class="c1"># Set up mesh</span>
    <span class="n">mesh_material</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Fe"</span><span class="p">,</span> <span class="s2">"Cr"</span><span class="p">,</span> <span class="s2">"Ni"</span><span class="p">,</span> <span class="s2">"Mn"</span><span class="p">,</span> <span class="s2">"Si"</span><span class="p">]</span>
    <span class="n">mesh_thickness</span> <span class="o">=</span> <span class="mf">100.0e-4</span>  <span class="c1"># cm</span>
    <span class="n">mesh_density</span> <span class="o">=</span> <span class="mf">8.0</span>  <span class="c1"># g/cm^3</span>
    <span class="n">mesh_material_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.705</span><span class="p">,</span> <span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>  <span class="c1"># fraction by weight</span>
    <span class="n">mesh_area_density_g_per_cm2_scalar</span> <span class="o">=</span> <span class="n">mesh_material_fractions</span> <span class="o">*</span> <span class="n">mesh_density</span> <span class="o">*</span> <span class="n">mesh_thickness</span>  <span class="c1"># g/cm^2</span>
    <span class="n">mesh_area_density_g_per_cm2</span> <span class="o">=</span> <span class="n">with_fractional_uncertainty</span><span class="p">(</span><span class="n">mesh_area_density_g_per_cm2_scalar</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="n">mesh_fill_fraction</span> <span class="o">=</span> <span class="n">ufloat</span><span class="p">(</span><span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">film2</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"LEX_HT Mesh"</span><span class="p">,</span>
        <span class="n">material</span><span class="o">=</span><span class="n">mesh_material</span><span class="p">,</span>
        <span class="n">area_density_g_per_cm2</span><span class="o">=</span><span class="n">mesh_area_density_g_per_cm2</span><span class="p">,</span>
        <span class="n">fill_fraction</span><span class="o">=</span><span class="n">mesh_fill_fraction</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">FilterStack</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">film1</span><span class="p">)</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">film2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stack</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.materials.efficiency_models.get_filter_stacks_dict">
<code class="highlight language-python"><span class="n">get_filter_stacks_dict</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>Create a dictionary with a few examples of FilterStack objects</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="dict">dict</span></code>
              –
              <div class="doc-md-description">
<p>A dictionary of named FilterStacks</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/materials/efficiency_models.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_filter_stacks_dict</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FilterStack</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Create a dictionary with a few examples of FilterStack objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary of named FilterStacks</span>
<span class="sd">    """</span>
    <span class="n">fs_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FilterStack</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># EBIT Instrument</span>
    <span class="n">EBIT_filter_stack</span> <span class="o">=</span> <span class="n">FilterStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"EBIT 2018"</span><span class="p">)</span>
    <span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"Electroplated Au Absorber"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">"Au"</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="n">with_fractional_uncertainty</span><span class="p">(</span><span class="mf">965.5</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">),</span> <span class="n">absorber</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"50mK Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="n">with_fractional_uncertainty</span><span class="p">(</span><span class="mf">112.5</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)))</span>
    <span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"3K Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="n">with_fractional_uncertainty</span><span class="p">(</span><span class="mf">108.5</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)))</span>

    <span class="n">filter_50K</span> <span class="o">=</span> <span class="n">FilterStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"50K Filter"</span><span class="p">)</span>
    <span class="n">filter_50K</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Al Film"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="n">with_fractional_uncertainty</span><span class="p">(</span><span class="mf">102.6</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)))</span>
    <span class="n">nickel</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">newfilter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Ni Mesh"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">"Ni"</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="n">ufloat</span><span class="p">(</span><span class="mf">15.0e3</span><span class="p">,</span> <span class="mf">2e3</span><span class="p">),</span> <span class="n">fill_fraction</span><span class="o">=</span><span class="n">ufloat</span><span class="p">(</span><span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
    <span class="n">filter_50K</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nickel</span><span class="p">)</span>
    <span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filter_50K</span><span class="p">)</span>
    <span class="n">luxel1</span> <span class="o">=</span> <span class="n">LEX_HT</span><span class="p">(</span><span class="s2">"Luxel Window TES"</span><span class="p">)</span>
    <span class="n">luxel2</span> <span class="o">=</span> <span class="n">LEX_HT</span><span class="p">(</span><span class="s2">"Luxel Window EBIT"</span><span class="p">)</span>
    <span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">luxel1</span><span class="p">)</span>
    <span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">luxel2</span><span class="p">)</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">EBIT_filter_stack</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">EBIT_filter_stack</span>

    <span class="c1"># RAVEN Instrument</span>
    <span class="n">RAVEN1_fs</span> <span class="o">=</span> <span class="n">FilterStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"RAVEN1 2019"</span><span class="p">)</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Evaporated Bi Absorber"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">"Bi"</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="mf">4.4e3</span><span class="p">,</span> <span class="n">absorber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithPolymer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"50mK Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mf">108.4</span><span class="p">,</span> <span class="n">polymer_thickness_nm</span><span class="o">=</span><span class="mf">206.4</span><span class="p">))</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithPolymer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"3K Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mf">108.4</span><span class="p">,</span> <span class="n">polymer_thickness_nm</span><span class="o">=</span><span class="mf">206.4</span><span class="p">))</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"50K Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mf">1.0e3</span><span class="p">))</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Be TES Vacuum Window"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">"Be"</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="mf">200.0e3</span><span class="p">)</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"e- Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mf">5.0e3</span><span class="p">))</span>
    <span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Be SEM Vacuum Window"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">"Be"</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="mf">200.0e3</span><span class="p">)</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">RAVEN1_fs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAVEN1_fs</span>

    <span class="c1"># Horton spring 2018, for metrology campaign.</span>
    <span class="n">Horton_filter_stack</span> <span class="o">=</span> <span class="n">FilterStack</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Horton 2018"</span><span class="p">)</span>
    <span class="n">Horton_filter_stack</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Electroplated Au Absorber"</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">"Au"</span><span class="p">,</span> <span class="n">thickness_nm</span><span class="o">=</span><span class="mf">965.5</span><span class="p">,</span> <span class="n">absorber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Horton_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"50mK Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mi">5000</span><span class="p">))</span>
    <span class="n">Horton_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"3K Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mi">5000</span><span class="p">))</span>
    <span class="n">Horton_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AlFilmWithOxide</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"50K Filter"</span><span class="p">,</span> <span class="n">Al_thickness_nm</span><span class="o">=</span><span class="mi">12700</span><span class="p">))</span>
    <span class="n">Horton_filter_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LEX_HT</span><span class="p">(</span><span class="s2">"Luxel Window TES"</span><span class="p">))</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">Horton_filter_stack</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Horton_filter_stack</span>

    <span class="k">return</span> <span class="n">fs_dict</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h2 id="math-and-statistics-functions">Math and statistics functions</h2>
<p>These live in <code>mass2.mathstat</code>.</p>
<h3 id="entropy">Entropy</h3>
<div class="doc doc-object doc-module">
<a id="mass2.mathstat.entropy"></a>
<div class="doc doc-contents first">
<p>entropy.py</p>
<p>Estimates of the distribution entropy computed using kernel-density estimates
of the distribution.</p>
<ul>
<li><code>laplace_entropy(x, w=1.0)</code> - Compute the entropy H(p) of data set <code>x</code> where the
kernel used to estimate p from x is the Laplace kernel k(x) \propto exp(-abs(x-x0)/w).</li>
<li><code>laplace_cross_entropy(x, y, w=1.0)</code> - Compute the cross entropy of q from p,
where q and p are the kernel-density estimates taken from data set
<code>y</code> and data set <code>x</code>, and where the kernel is the Laplace kernel.</li>
<li><code>KL_divergence(x, y, w=1.0)</code> - Compute the Kullback-Leibler Divergence
of data set <code>y</code> from <code>x</code>, where the kernel is the Laplace kernel.</li>
</ul>
<p>The K-L divergence of Q(x) from P(x) is defined as the integral over the full
x domain of P(x) log[P(x)/Q(x)].</p>
<p>This equals the cross-entropy H(P,Q) - H(P). Note that cross-entropy and K-L divergence
are not symmetric with respect to reversal of <code>x</code> and <code>y</code>.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_KL_divergence">
<code class="highlight language-python"><span class="n">laplace_KL_divergence</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">approx_mode</span><span class="o">=</span><span class="s1">'size'</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the Kullback-Leibler divergence of data set <code>y</code> from data set <code>x</code>.</p>
<p>Use kernel-density estimation, where the kernel is the Laplace kernel
k(x) \propto exp(-abs(x-x0)/w).</p>
<p>The <code>approx_mode</code> can be one of:
<code>exact</code>  The exact integral is computed (can take ~0.25 sec per 10^6 values).
<code>approx</code> The integral is approximated by histogramming the data, smoothing
           that, and using Simpson's rule on the PDF samples that result.
<code>size</code>   Uses "approx" if len(x)+len(y)&gt;200000, or "exact" otherwise.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">laplace_KL_divergence</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">approx_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"size"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">"""Compute the Kullback-Leibler divergence of data set `y` from data set `x`.</span>

<span class="sd">    Use kernel-density estimation, where the kernel is the Laplace kernel</span>
<span class="sd">    k(x) \propto exp(-abs(x-x0)/w).</span>

<span class="sd">    The `approx_mode` can be one of:</span>
<span class="sd">    ``exact``  The exact integral is computed (can take ~0.25 sec per 10^6 values).</span>
<span class="sd">    ``approx`` The integral is approximated by histogramming the data, smoothing</span>
<span class="sd">               that, and using Simpson's rule on the PDF samples that result.</span>
<span class="sd">    ``size``   Uses "approx" if len(x)+len(y)&gt;200000, or "exact" otherwise.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">laplace_cross_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">approx_mode</span><span class="o">=</span><span class="n">approx_mode</span><span class="p">)</span> <span class="o">-</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">approx_mode</span><span class="o">=</span><span class="n">approx_mode</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_cross_entropy">
<code class="highlight language-python"><span class="n">laplace_cross_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">approx_mode</span><span class="o">=</span><span class="s1">'size'</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p><code>laplace_cross_entropy(x, y, w: float = 1.0, approx_mode="size")</code></p>
<p>Compute the cross-entropy of data set <code>x</code> from data set <code>y</code>, where the
kernel for x is the Laplace kernel k(x) \propto exp(-abs(x-x0)/w).</p>
<p>The kernel for the y data is the piecewise-constant (top-hat) kernel. We choose this
because a Laplace kernel for y led to possible divergences when the y-distribtion q
is exceedingly small, but the x-distribution p nevertheless is non-zero because of a
random x-value lying far from any random y-values. The constant kernel is given a
non-zero floor value, so that q is never so small as to make any x-value impossible.</p>
<p>Args:
    x (array): One vector of data.
    y (array): The other vector of data.
    w (double): The width (exponential scale length) of the Laplace distribution
        to be used in kernel-density estimation.
    approx_mode (string): How to balance execution speed and accuracy
        (default "size").</p>
<p>The <code>approx_mode</code> can be one of:
<code>exact</code>  The exact integral is computed (can take ~0.25 sec per 10^6 values).
<code>approx</code> The integral is approximated by histogramming the data, smoothing
           that, and using Simpson's rule on the PDF samples that result.
<code>size</code>   Uses "approx" if len(x)+len(y)&gt;200000, or "exact" otherwise.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">laplace_cross_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">approx_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"size"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">"""`laplace_cross_entropy(x, y, w: float = 1.0, approx_mode="size")`</span>

<span class="sd">    Compute the cross-entropy of data set `x` from data set `y`, where the</span>
<span class="sd">    kernel for x is the Laplace kernel k(x) \propto exp(-abs(x-x0)/w).</span>

<span class="sd">    The kernel for the y data is the piecewise-constant (top-hat) kernel. We choose this</span>
<span class="sd">    because a Laplace kernel for y led to possible divergences when the y-distribtion q</span>
<span class="sd">    is exceedingly small, but the x-distribution p nevertheless is non-zero because of a</span>
<span class="sd">    random x-value lying far from any random y-values. The constant kernel is given a</span>
<span class="sd">    non-zero floor value, so that q is never so small as to make any x-value impossible.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array): One vector of data.</span>
<span class="sd">        y (array): The other vector of data.</span>
<span class="sd">        w (double): The width (exponential scale length) of the Laplace distribution</span>
<span class="sd">            to be used in kernel-density estimation.</span>
<span class="sd">        approx_mode (string): How to balance execution speed and accuracy</span>
<span class="sd">            (default "size").</span>

<span class="sd">    The `approx_mode` can be one of:</span>
<span class="sd">    ``exact``  The exact integral is computed (can take ~0.25 sec per 10^6 values).</span>
<span class="sd">    ``approx`` The integral is approximated by histogramming the data, smoothing</span>
<span class="sd">               that, and using Simpson's rule on the PDF samples that result.</span>
<span class="sd">    ``size``   Uses "approx" if len(x)+len(y)&gt;200000, or "exact" otherwise.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"laplace_cross_entropy(x, y, w) needs `w&gt;0`."</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Nx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">Ny</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"laplace_cross_entropy(x, y) needs at least 1 element apiece in `x` and `y`."</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">approx_mode</span> <span class="o">==</span> <span class="s2">"size"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Nx</span> <span class="o">+</span> <span class="n">Ny</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">:</span>
            <span class="n">approx_mode</span> <span class="o">=</span> <span class="s2">"exact"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">approx_mode</span> <span class="o">=</span> <span class="s2">"approx"</span>
    <span class="k">if</span> <span class="n">approx_mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"exact"</span><span class="p">):</span>
        <span class="n">xsorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
        <span class="n">ysorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">laplace_cross_entropy_arrays</span><span class="p">(</span><span class="n">xsorted</span><span class="p">,</span> <span class="n">ysorted</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">laplace_cross_entropy_approx</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_cross_entropy_approx">
<code class="highlight language-python"><span class="n">laplace_cross_entropy_approx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Approximate the cross-entropy H(P, Q) between two empirical distributions P and Q,
where P is estimated from data <code>x</code> and Q from data <code>y</code> using Laplace kernel-density
estimation and binned histograms.</p>
<p>This method uses histograms and convolution with a Laplace kernel to estimate the
probability distributions, then computes the cross-entropy using numerical integration.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Data points for the P distribution.</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Data points for the Q distribution.</p>
</div>
</li>
<li>
<b><code>w</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>1.0</code>
)
              –
              <div class="doc-md-description">
<p>The width (exponential scale length) of the Laplace kernel, by default 1.0.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="float">float</span></code>
              –
              <div class="doc-md-description">
<p>The approximate cross-entropy H(P, Q) between the two distributions.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="note" open="">
<summary>Notes</summary>
<ul>
<li>This is an approximate method, suitable for large data sets.</li>
<li>The Laplace kernel is defined as k(x) ∝ exp(-abs(x-x0)/w).</li>
<li>Uses Simpson's rule for numerical integration.</li>
</ul>
</details>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">laplace_cross_entropy_approx</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Approximate the cross-entropy H(P, Q) between two empirical distributions P and Q,</span>
<span class="sd">    where P is estimated from data `x` and Q from data `y` using Laplace kernel-density</span>
<span class="sd">    estimation and binned histograms.</span>

<span class="sd">    This method uses histograms and convolution with a Laplace kernel to estimate the</span>
<span class="sd">    probability distributions, then computes the cross-entropy using numerical integration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Data points for the P distribution.</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        Data points for the Q distribution.</span>
<span class="sd">    w : float, optional</span>
<span class="sd">        The width (exponential scale length) of the Laplace kernel, by default 1.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The approximate cross-entropy H(P, Q) between the two distributions.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This is an approximate method, suitable for large data sets.</span>
<span class="sd">    - The Laplace kernel is defined as k(x) ∝ exp(-abs(x-x0)/w).</span>
<span class="sd">    - Uses Simpson's rule for numerical integration.</span>
<span class="sd">    """</span>
    <span class="n">EXTEND_DATA</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">BINS_PER_W</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">KERNEL_WIDTH_IN_WS</span> <span class="o">=</span> <span class="mf">15.0</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">-</span> <span class="n">EXTEND_DATA</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="n">EXTEND_DATA</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">BINS_PER_W</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">cx</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
    <span class="n">cy</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">KERNEL_WIDTH_IN_WS</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">db</span><span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">kx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="n">db</span>
        <span class="n">kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">kx</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span>

    <span class="c1"># kde = unnormalized kernel-density estimator.</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"full"</span><span class="p">)[</span><span class="n">nx</span><span class="p">:</span><span class="o">-</span><span class="n">nx</span><span class="p">]</span>
    <span class="n">kde</span><span class="p">[</span><span class="n">kde</span> <span class="o">&lt;</span> <span class="n">kernel</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="c1"># p = normalized probability distribution.</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simpson</span><span class="p">(</span><span class="n">kde</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">kde</span> <span class="o">*</span> <span class="n">norm</span>

    <span class="n">kde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">cy</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"full"</span><span class="p">)[</span><span class="n">nx</span><span class="p">:</span><span class="o">-</span><span class="n">nx</span><span class="p">]</span>
    <span class="n">kde</span><span class="p">[</span><span class="n">kde</span> <span class="o">&lt;</span> <span class="n">kernel</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simpson</span><span class="p">(</span><span class="n">kde</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">kde</span> <span class="o">*</span> <span class="n">norm</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">sp</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simpson</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">dx</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_cross_entropy_arrays">
<code class="highlight language-python"><span class="n">laplace_cross_entropy_arrays</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the cross-entropy H(P, Q) between two empirical distributions P and Q,
where P is estimated from data <code>x</code> using a Laplace kernel, and Q is estimated
from data <code>y</code> using a piecewise-constant (top-hat) kernel.</p>
<p>This function assumes both <code>x</code> and <code>y</code> are sorted and scaled by the kernel width.
The cross-entropy is computed exactly by integrating over all points where the
estimated densities change due to the presence of data points in <code>x</code> or <code>y</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Sorted array of data points for the P distribution, scaled by kernel width.</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Sorted array of data points for the Q distribution, scaled by kernel width.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="float">float</span></code>
              –
              <div class="doc-md-description">
<p>The exact cross-entropy H(P, Q) between the two distributions.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="note" open="">
<summary>Notes</summary>
<ul>
<li>The Laplace kernel is defined as k(x) ∝ exp(-abs(x-x0)/w).</li>
<li>The Q distribution uses a top-hat kernel with a nonzero floor to avoid divergences.</li>
<li>This function is intended for internal use; see <code>laplace_cross_entropy</code> for the public API.</li>
</ul>
</details>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">laplace_cross_entropy_arrays</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># noqa: PLR0914</span>
<span class="w">    </span><span class="sd">"""Compute the cross-entropy H(P, Q) between two empirical distributions P and Q,</span>
<span class="sd">    where P is estimated from data `x` using a Laplace kernel, and Q is estimated</span>
<span class="sd">    from data `y` using a piecewise-constant (top-hat) kernel.</span>

<span class="sd">    This function assumes both `x` and `y` are sorted and scaled by the kernel width.</span>
<span class="sd">    The cross-entropy is computed exactly by integrating over all points where the</span>
<span class="sd">    estimated densities change due to the presence of data points in `x` or `y`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Sorted array of data points for the P distribution, scaled by kernel width.</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        Sorted array of data points for the Q distribution, scaled by kernel width.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The exact cross-entropy H(P, Q) between the two distributions.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The Laplace kernel is defined as k(x) ∝ exp(-abs(x-x0)/w).</span>
<span class="sd">    - The Q distribution uses a top-hat kernel with a nonzero floor to avoid divergences.</span>
<span class="sd">    - This function is intended for internal use; see `laplace_cross_entropy` for the public API.</span>
<span class="sd">    """</span>
    <span class="c1"># List of all places where q(u) increases or decreases because of a y-point.</span>
    <span class="n">Qstepwidth</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ynodes</span><span class="p">,</span> <span class="n">qstep_is_up</span> <span class="o">=</span> <span class="n">_merge_orderedlists</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Qstepwidth</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Qstepwidth</span><span class="p">)</span>

    <span class="c1"># List of all places where p(u) or q(u) changes because of an x- a y-point.</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">isx</span> <span class="o">=</span> <span class="n">_merge_orderedlists</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">Nx</span> <span class="o">+</span> <span class="n">Ny</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="c1"># Pretend q(u) is never lower than this value, and spread this probability across</span>
    <span class="c1"># the range 10 less than the lowest to 10 more than the highest node.</span>
    <span class="n">Qmin_sum</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ny</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">Qmin</span> <span class="o">=</span> <span class="n">Qmin_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">Qstep</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Qmin_sum</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ny</span> <span class="o">*</span> <span class="n">Qstepwidth</span><span class="p">)</span>

    <span class="c1"># Initialize the vectors decayfactor, c, and d.</span>
    <span class="n">decayfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">decayfactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># c requires a left-right pass over all nodes.</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="n">stepX</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nx</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">isx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepX</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">decayfactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">isx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stepX</span>

    <span class="c1"># d requires a right-left pass over all nodes.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isx</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepX</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">decayfactor</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">isx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stepX</span>

    <span class="c1"># Now a left-right pass over all nodes to compute the H integral.</span>
    <span class="n">net_up_qsteps</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">net_up_qsteps</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">H</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Qmin</span><span class="p">)</span>  <span class="c1"># H due to the open first interval [-inf, nodes[0]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">decayfactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Qmin</span> <span class="o">+</span> <span class="n">Qstep</span> <span class="o">*</span> <span class="n">net_up_qsteps</span>
        <span class="n">H</span> <span class="o">-=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">qstep_is_up</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">net_up_qsteps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">net_up_qsteps</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">H</span> <span class="o">-=</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Qmin</span><span class="p">)</span>  <span class="c1"># H due to the open last interval [nodes[-1], +inf]</span>
    <span class="k">return</span> <span class="n">H</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_entropy">
<code class="highlight language-python"><span class="n">laplace_entropy</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">approx_mode</span><span class="o">=</span><span class="s1">'size'</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the entropy of data set <code>x</code> where the kernel is the Laplace kernel,
$k(x) \propto$ exp(-abs(x-x0)/w).</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x_in</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The vector of data of which we want the entropy.</p>
</div>
</li>
<li>
<b><code>w</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>1.0</code>
)
              –
              <div class="doc-md-description">
<p>The width (exponential scale length) of the Laplace distribution
    to be used in kernel-density estimation, by default 1.0</p>
</div>
</li>
<li>
<b><code>approx_mode</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'size'</code>
)
              –
              <div class="doc-md-description">
<p>How to balance execution speed and accuracy, by default "size"
The <code>approx_mode</code> can be one of:
<code>exact</code>  The exact integral is computed (can take ~0.25 sec per 10^6 values).
<code>approx</code> The integral is approximated by histogramming the data, smoothing
        that, and using Simpson's rule on the PDF samples that result.
<code>size</code>   Uses "approx" if len(x)&gt;200000, or "exact" otherwise.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="float">float</span></code>
              –
              <div class="doc-md-description">
<p>The Laplace-kernel entropy.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>If the input array <code>x</code> has no values, or <code>w</code> is not positive.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">laplace_entropy</span><span class="p">(</span><span class="n">x_in</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">approx_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"size"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the entropy of data set `x` where the kernel is the Laplace kernel,</span>
<span class="sd">    $k(x) \\propto$ exp(-abs(x-x0)/w).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_in : ArrayLike</span>
<span class="sd">        The vector of data of which we want the entropy.</span>
<span class="sd">    w : float, optional</span>
<span class="sd">        The width (exponential scale length) of the Laplace distribution</span>
<span class="sd">            to be used in kernel-density estimation, by default 1.0</span>
<span class="sd">    approx_mode : str, optional</span>
<span class="sd">        How to balance execution speed and accuracy, by default "size"</span>
<span class="sd">        The `approx_mode` can be one of:</span>
<span class="sd">        ``exact``  The exact integral is computed (can take ~0.25 sec per 10^6 values).</span>
<span class="sd">        ``approx`` The integral is approximated by histogramming the data, smoothing</span>
<span class="sd">                that, and using Simpson's rule on the PDF samples that result.</span>
<span class="sd">        ``size``   Uses "approx" if len(x)&gt;200000, or "exact" otherwise.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The Laplace-kernel entropy.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the input array `x` has no values, or `w` is not positive.</span>
<span class="sd">    """</span>
    <span class="n">x_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_in</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"laplace_entropy(x) needs at least 1 element in `x`."</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"laplace_entropy(x, w) needs `w&gt;0`."</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">approx_mode</span> <span class="o">==</span> <span class="s2">"size"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">:</span>
            <span class="n">approx_mode</span> <span class="o">=</span> <span class="s2">"exact"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">approx_mode</span> <span class="o">=</span> <span class="s2">"approx"</span>
    <span class="k">if</span> <span class="n">approx_mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"exact"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">laplace_entropy_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">laplace_entropy_approx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_entropy_approx">
<code class="highlight language-python"><span class="n">laplace_entropy_approx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Approximage the entropy of data set <code>x</code> with a binned histogram and the Laplace-distribution
kernel-density estimator of the probability distribtion.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x_in</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The vector of data of which we want the entropy.</p>
</div>
</li>
<li>
<b><code>w</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>1.0</code>
)
              –
              <div class="doc-md-description">
<p>The width (exponential scale length) of the Laplace distribution
    to be used in kernel-density estimation, by default 1.0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="float">float</span></code>
              –
              <div class="doc-md-description">
<p>The approximate Laplace-kernel entropy.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">laplace_entropy_approx</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Approximage the entropy of data set `x` with a binned histogram and the Laplace-distribution</span>
<span class="sd">    kernel-density estimator of the probability distribtion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_in : ArrayLike</span>
<span class="sd">        The vector of data of which we want the entropy.</span>
<span class="sd">    w : float, optional</span>
<span class="sd">        The width (exponential scale length) of the Laplace distribution</span>
<span class="sd">            to be used in kernel-density estimation, by default 1.0</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The approximate Laplace-kernel entropy.</span>
<span class="sd">    """</span>
    <span class="n">EXTEND_DATA</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">BINS_PER_W</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">KERNEL_WIDTH_IN_WS</span> <span class="o">=</span> <span class="mf">15.0</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">EXTEND_DATA</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">EXTEND_DATA</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">BINS_PER_W</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">KERNEL_WIDTH_IN_WS</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">db</span><span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">kx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="n">db</span>
        <span class="n">kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kx</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span>

    <span class="c1"># kde = unnormalized kernel-density estimator.</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"full"</span><span class="p">)[</span><span class="n">nx</span><span class="p">:</span><span class="o">-</span><span class="n">nx</span><span class="p">]</span>
    <span class="n">minkern</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">kde</span><span class="p">[</span><span class="n">kde</span> <span class="o">&lt;</span> <span class="n">minkern</span><span class="p">]</span> <span class="o">=</span> <span class="n">minkern</span>

    <span class="c1"># p = normalized probability distribution.</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simpson</span><span class="p">(</span><span class="n">kde</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">kde</span> <span class="o">*</span> <span class="n">norm</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">sp</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simpson</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">dx</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.entropy.laplace_entropy_array">
<code class="highlight language-python"><span class="n">laplace_entropy_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the entropy of data set <code>x</code> where the kernel is the Laplace kernel,
$k(x) \propto$ exp(-abs(x-x0)/w).</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x_in</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The vector of data of which we want the entropy.</p>
</div>
</li>
<li>
<b><code>w</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>1.0</code>
)
              –
              <div class="doc-md-description">
<p>The width (exponential scale length) of the Laplace distribution
    to be used in kernel-density estimation, by default 1.0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="float">float</span></code>
              –
              <div class="doc-md-description">
<p>The exact Laplace-kernel entropy, regardless of the input array size.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/entropy.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">laplace_entropy_array</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the entropy of data set `x` where the kernel is the Laplace kernel,</span>
<span class="sd">    $k(x) \\propto$ exp(-abs(x-x0)/w).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_in : ArrayLike</span>
<span class="sd">        The vector of data of which we want the entropy.</span>
<span class="sd">    w : float, optional</span>
<span class="sd">        The width (exponential scale length) of the Laplace distribution</span>
<span class="sd">            to be used in kernel-density estimation, by default 1.0</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The exact Laplace-kernel entropy, regardless of the input array size.</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">stepsize</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepsize</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">stepsize</span>
    <span class="n">d</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stepsize</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">stepsize</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">H</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dp</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">atan</span><span class="p">((</span><span class="n">e2</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">e2</span><span class="p">)</span> <span class="o">*</span> <span class="n">r1</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r1</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">dp</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">H</span> <span class="o">-=</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h3 id="fitting">Fitting</h3>
<div class="doc doc-object doc-module">
<a id="mass2.mathstat.fitting"></a>
<div class="doc doc-contents first">
<p>mass2.mathstat.fitting</p>
<p>Model-fitting utilities.</p>
<p>Joe Fowler, NIST</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.fitting.fit_kink_model">
<code class="highlight language-python"><span class="n">fit_kink_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the linear least-squares solution for a kinked-linear model.</p>
<p>The model is f(x) = a+b(x-k) for x<k and="" f(x)="a+c(x-k)" for="" x="">=k, where
the 4 parameters are {k,a,b,c}, representing the kink at (x,y)=(k,a) and
slopes of b and c for x<k and="" x="">= k.</k></k></p>
<p>Given k, the model is linear in the other parameters, which can thus be
found exactly by linear algebra. The best value of k is found by use of
the Bounded method of the sp.optimize.minimize_scalar() routine.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The input data x-values</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The input data y-values</p>
</div>
</li>
<li>
<b><code>kbounds</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="tuple">tuple</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Bounds on k, by default None.
If (u,v), then the minimize_scalar is used to find the best k strictly in u&lt;=k&lt;=v.
If None, then use the Brent method, which will start with (b1,b2) as a search bracket
where b1 and b2 are the 2nd lowest and 2nd highest values of x.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code>model_y, abc, X2) where:</code>
              –
              <div class="doc-md-description">
<p>model_y : NDArray[float]
    an array of the model y-values;
kabc : NDArray[float]
    the best-fit values of the kink location and the 3 linear parameters;
X2 : float
    is the sum of square differences between y and model_y.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>if k doesn't satisfy x.min() &lt; k &lt; x.max()</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><span class="doc-section-title">Examples:</span></p>
<p>x = np.arange(10, dtype=float)
y = np.array(x)
truek = 4.6
y[x&gt;truek] = truek
y += np.random.default_rng().standard_normal(len(x))<em>.15
model, (kbest,a,b,c), X2 = fit_kink_model(x, y, kbounds=(3,6))
plt.clf()
plt.plot(x, y, "or", label="Noisy data to be fit")
xi = np.linspace(x[0], kbest, 200)
xj = np.linspace(kbest, x[-1], 200)
plt.plot(xi, a+b</em>(xi-kbest), "--k", label="Best-fit kinked model")
plt.plot(xj, a+c*(xj-kbest), "--k")
plt.legend()</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/fitting.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_kink_model</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">kbounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the linear least-squares solution for a kinked-linear model.</span>

<span class="sd">    The model is f(x) = a+b(x-k) for x&lt;k and f(x)=a+c(x-k) for x&gt;=k, where</span>
<span class="sd">    the 4 parameters are {k,a,b,c}, representing the kink at (x,y)=(k,a) and</span>
<span class="sd">    slopes of b and c for x&lt;k and x&gt;= k.</span>

<span class="sd">    Given k, the model is linear in the other parameters, which can thus be</span>
<span class="sd">    found exactly by linear algebra. The best value of k is found by use of</span>
<span class="sd">    the Bounded method of the sp.optimize.minimize_scalar() routine.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        The input data x-values</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        The input data y-values</span>
<span class="sd">    kbounds : Optional[tuple[float, float]], optional</span>
<span class="sd">        Bounds on k, by default None.</span>
<span class="sd">        If (u,v), then the minimize_scalar is used to find the best k strictly in u&lt;=k&lt;=v.</span>
<span class="sd">        If None, then use the Brent method, which will start with (b1,b2) as a search bracket</span>
<span class="sd">        where b1 and b2 are the 2nd lowest and 2nd highest values of x.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model_y, abc, X2) where:</span>
<span class="sd">        model_y : NDArray[float]</span>
<span class="sd">            an array of the model y-values;</span>
<span class="sd">        kabc : NDArray[float]</span>
<span class="sd">            the best-fit values of the kink location and the 3 linear parameters;</span>
<span class="sd">        X2 : float</span>
<span class="sd">            is the sum of square differences between y and model_y.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if k doesn't satisfy x.min() &lt; k &lt; x.max()</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    x = np.arange(10, dtype=float)</span>
<span class="sd">    y = np.array(x)</span>
<span class="sd">    truek = 4.6</span>
<span class="sd">    y[x&gt;truek] = truek</span>
<span class="sd">    y += np.random.default_rng().standard_normal(len(x))*.15</span>
<span class="sd">    model, (kbest,a,b,c), X2 = fit_kink_model(x, y, kbounds=(3,6))</span>
<span class="sd">    plt.clf()</span>
<span class="sd">    plt.plot(x, y, "or", label="Noisy data to be fit")</span>
<span class="sd">    xi = np.linspace(x[0], kbest, 200)</span>
<span class="sd">    xj = np.linspace(kbest, x[-1], 200)</span>
<span class="sd">    plt.plot(xi, a+b*(xi-kbest), "--k", label="Best-fit kinked model")</span>
<span class="sd">    plt.plot(xj, a+c*(xj-kbest), "--k")</span>
<span class="sd">    plt.legend()</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">penalty</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="s2">"Extract only the cost function from kink_model()"</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">X2</span> <span class="o">=</span> <span class="n">kink_model</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X2</span>

    <span class="k">if</span> <span class="n">kbounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kbounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">kbounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">or</span> <span class="n">kbounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"kbounds (</span><span class="si">{</span><span class="n">kbounds</span><span class="si">}</span><span class="s2">) must be within the range of x data"</span><span class="p">)</span>
    <span class="n">optimum</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">penalty</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">"Bounded"</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">kbounds</span><span class="p">)</span>
    <span class="n">kbest</span> <span class="o">=</span> <span class="n">optimum</span><span class="o">.</span><span class="n">x</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">abc</span><span class="p">,</span> <span class="n">X2</span> <span class="o">=</span> <span class="n">kink_model</span><span class="p">(</span><span class="n">kbest</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">kbest</span><span class="p">,</span> <span class="n">abc</span><span class="p">]),</span> <span class="n">X2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.fitting.kink_model">
<code class="highlight language-python"><span class="n">kink_model</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute a kinked-linear model on data {x,y} with kink at x=k.</p>
<p>The model is f(x) = a+b(x-k) for x<k and="" f(x)="a+c(x-k)" for="" x="">=k, where
the 4 parameters are {k,a,b,c}, representing the kink at (x,y)=(k,a) and
slopes of b and c for x<k and="" x="">= k.</k></k></p>
<p>For a fixed k, the model is linear in the other parameters, whose linear
least-squares values can thus be found exactly by linear algebra. This
function computes them.</p>
<p>Returns (model_y, (a,b,c), X2) where:
model_y is an array of the model y-values;
(a,b,c) are the best-fit values of the linear parameters;
X2 is the sum of square differences between y and model_y.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>k</code></b>
                  (<code><span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>Location of the kink, in x coordinates</p>
</div>
</li>
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The input data x-values</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>The input data y-values</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code>model_y, abc, X2) where:</code>
              –
              <div class="doc-md-description">
<p>model_y : NDArray[float]
    an array of the model y-values;
abc : NDArray[float]
    the best-fit values of the linear parameters;
X2 : float
    is the sum of square differences between y and model_y.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>if k doesn't satisfy x.min() &lt; k &lt; x.max()</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/fitting.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">kink_model</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a kinked-linear model on data {x,y} with kink at x=k.</span>

<span class="sd">    The model is f(x) = a+b(x-k) for x&lt;k and f(x)=a+c(x-k) for x&gt;=k, where</span>
<span class="sd">    the 4 parameters are {k,a,b,c}, representing the kink at (x,y)=(k,a) and</span>
<span class="sd">    slopes of b and c for x&lt;k and x&gt;= k.</span>

<span class="sd">    For a fixed k, the model is linear in the other parameters, whose linear</span>
<span class="sd">    least-squares values can thus be found exactly by linear algebra. This</span>
<span class="sd">    function computes them.</span>

<span class="sd">    Returns (model_y, (a,b,c), X2) where:</span>
<span class="sd">    model_y is an array of the model y-values;</span>
<span class="sd">    (a,b,c) are the best-fit values of the linear parameters;</span>
<span class="sd">    X2 is the sum of square differences between y and model_y.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : float</span>
<span class="sd">        Location of the kink, in x coordinates</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        The input data x-values</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        The input data y-values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model_y, abc, X2) where:</span>
<span class="sd">        model_y : NDArray[float]</span>
<span class="sd">            an array of the model y-values;</span>
<span class="sd">        abc : NDArray[float]</span>
<span class="sd">            the best-fit values of the linear parameters;</span>
<span class="sd">        X2 : float</span>
<span class="sd">            is the sum of square differences between y and model_y.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        if k doesn't satisfy x.min() &lt; k &lt; x.max()</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">xj</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">yj</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"k=</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2"> should be in range [xmin,xmax], or [</span><span class="si">{</span><span class="n">xmin</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">xmax</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">]."</span><span class="p">)</span>

    <span class="n">dxi</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">-</span> <span class="n">k</span>
    <span class="n">dxj</span> <span class="o">=</span> <span class="n">xj</span> <span class="o">-</span> <span class="n">k</span>
    <span class="n">si</span> <span class="o">=</span> <span class="n">dxi</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sj</span> <span class="o">=</span> <span class="n">dxj</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">si2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dxi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sj2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dxj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">N</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">],</span> <span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">si2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">sj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sj2</span><span class="p">]])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">yi</span> <span class="o">*</span> <span class="n">dxi</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">yj</span> <span class="o">*</span> <span class="n">dxj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()])</span>
    <span class="n">abc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dxi</span><span class="p">,</span> <span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dxj</span><span class="p">])</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="p">((</span><span class="n">model</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">abc</span><span class="p">,</span> <span class="n">X2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h3 id="interpolation">Interpolation</h3>
<div class="doc doc-object doc-module">
<a id="mass2.mathstat.interpolate"></a>
<div class="doc doc-contents first">
<p>interpolate.py</p>
<p>Module mass2.mathstat.interpolate</p>
<p>Contains interpolations functions not readily available elsewhere.</p>
<p>CubicSpline - Perform an exact cubic spline through the data, with either
    specified slope at the end of the interval or 'natural boundary conditions'
    (y''=0 at ends).</p>
<p>GPRSpline - Create a smoothing spline based on the theory of Gaussian process regression.
    Finds the curvature penalty by maximizing the Bayesian marginal likelihood.
    Intended to supercede <code>SmoothingSpline</code>, but very similar. Differs in how the
    curvature and data fidelity are balanced.</p>
<p>SmoothingSpline - Create a smoothing spline that does not exactly interpolate
    the data, but finds the cubic spline with lowest "curvature
    energy" among all splines that meet the maximum allowed value
    of chi-squared.</p>
<p>SmoothingSplineLog - Create a SmoothingSpline using the log of the x,y points.</p>
<p>NaturalBsplineBasis - A tool for expressing a spline basis using B-splines but
    also enforcing 'natural boundary conditions'.</p>
<p>Joe Fowler, NIST
Created Feb 2014</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.interpolate.CubicSpline">
<code>CubicSpline</code>
</h2>
<div class="doc doc-contents">
<p>An exact cubic spline, with either a specified slope or 'natural boundary
conditions' (y''=0) at ends of interval.</p>
<p>Note that the interface is similar to
scipy.interpolate.InterpolatedUnivariateSpline, but the behavior is
different. The scipy version will remove the 2nd and 2nd-to-last data points
from the set of knots as a way of using the 2 extra degrees of freedom. This
class instead sets the 1st or 2nd derivatives at the end of the interval to
use the extra degrees of freedom.</p>
<p>This code is inspired by section 3.3. of Numerical Recipes, 3rd Edition.</p>
<p>Usage:
x=np.linspace(4,12,20)
y=(x-6)**2+np.random.standard_normal(20)
cs = mass2.CubicSpline(x, y)
plt.clf()
plt.plot(x,y,'ok')
xa = np.linspace(0,16,200)
plt.plot(xa, cs(xa), 'b-')</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CubicSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An exact cubic spline, with either a specified slope or 'natural boundary</span>
<span class="sd">    conditions' (y''=0) at ends of interval.</span>

<span class="sd">    Note that the interface is similar to</span>
<span class="sd">    scipy.interpolate.InterpolatedUnivariateSpline, but the behavior is</span>
<span class="sd">    different. The scipy version will remove the 2nd and 2nd-to-last data points</span>
<span class="sd">    from the set of knots as a way of using the 2 extra degrees of freedom. This</span>
<span class="sd">    class instead sets the 1st or 2nd derivatives at the end of the interval to</span>
<span class="sd">    use the extra degrees of freedom.</span>

<span class="sd">    This code is inspired by section 3.3. of Numerical Recipes, 3rd Edition.</span>

<span class="sd">    Usage:</span>
<span class="sd">    x=np.linspace(4,12,20)</span>
<span class="sd">    y=(x-6)**2+np.random.standard_normal(20)</span>
<span class="sd">    cs = mass2.CubicSpline(x, y)</span>
<span class="sd">    plt.clf()</span>
<span class="sd">    plt.plot(x,y,'ok')</span>
<span class="sd">    xa = np.linspace(0,16,200)</span>
<span class="sd">    plt.plot(xa, cs(xa), 'b-')</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">yprime1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">yprimeN</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create an exact cubic spline representation for the function y(x).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            Indepdendent variable values. Will be sorted if not increasing.</span>
<span class="sd">        y : ArrayLike</span>
<span class="sd">            Dependent variable values.</span>
<span class="sd">        yprime1 : float | None, optional</span>
<span class="sd">            First derivative at the lower-x boundary, by default None</span>
<span class="sd">        yprimeN : float | None, optional</span>
<span class="sd">            First derivative at the upper-x boundary, by default None.</span>
<span class="sd">            slope of None means to use 'natural boundary conditions' by fixing the</span>
<span class="sd">            second derivative to zero at that boundary.</span>
<span class="sd">        """</span>
        <span class="n">argsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argsort</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span> <span class="o">=</span> <span class="n">yprime1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span> <span class="o">=</span> <span class="n">yprimeN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_y2</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_y2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute the second derivatives at the knots."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ystep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ystep</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-=</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># For natural boundary conditions, u[0]=y2[0]=0.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ystep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span>

        <span class="c1"># Again, the following is only for natural boundary conditions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qn</span> <span class="o">=</span> <span class="n">un</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qn</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">un</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ystep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">un</span> <span class="o">-</span> <span class="n">qn</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">qn</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Backsubstitution:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ystep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ystep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the value of the cubic spline (or its derivative) at x.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike | float</span>
<span class="sd">            Independent variable value(s) at which to evaluate the spline.</span>
<span class="sd">        der : int, optional</span>
<span class="sd">            Derivative order, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray</span>
<span class="sd">            Spline result</span>
<span class="sd">        """</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Find which interval 0,...self._n-2 contains the points (or extrapolates to the points)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Here, position == -1 means extrapolate below the first interval.</span>
        <span class="n">extrap_low</span> <span class="o">=</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">extrap_low</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># will be negative</span>
                <span class="n">result</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># position = self._n-1 means extrapolate above the last interval.</span>
        <span class="n">extrap_hi</span> <span class="o">=</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">extrap_hi</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># will be positive</span>
                <span class="n">result</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interp</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">klo</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span>
            <span class="n">khi</span> <span class="o">=</span> <span class="n">klo</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">interp</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">klo</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>

            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">6.0</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span>
                    <span class="o">+</span> <span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtest</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># noqa: PLR6301</span>
<span class="w">        </span><span class="sd">"""Return a dummy estimate of the variance at points `xtest`."""</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.CubicSpline.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the value of the cubic spline (or its derivative) at x.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span> | <span title="float">float</span></code>)
              –
              <div class="doc-md-description">
<p>Independent variable value(s) at which to evaluate the spline.</p>
</div>
</li>
<li>
<b><code>der</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
<p>Derivative order, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              –
              <div class="doc-md-description">
<p>Spline result</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the value of the cubic spline (or its derivative) at x.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike | float</span>
<span class="sd">        Independent variable value(s) at which to evaluate the spline.</span>
<span class="sd">    der : int, optional</span>
<span class="sd">        Derivative order, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        Spline result</span>
<span class="sd">    """</span>
    <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Find which interval 0,...self._n-2 contains the points (or extrapolates to the points)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Here, position == -1 means extrapolate below the first interval.</span>
    <span class="n">extrap_low</span> <span class="o">=</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">extrap_low</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># will be negative</span>
            <span class="n">result</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">extrap_low</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># position = self._n-1 means extrapolate above the last interval.</span>
    <span class="n">extrap_hi</span> <span class="o">=</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">extrap_hi</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># will be positive</span>
            <span class="n">result</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">extrap_hi</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interp</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">klo</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span>
        <span class="n">khi</span> <span class="o">=</span> <span class="n">klo</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstep</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">interp</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">klo</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>

        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">6.0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span>
                <span class="o">+</span> <span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">klo</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span><span class="p">[</span><span class="n">khi</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.CubicSpline.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yprime1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yprimeN</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create an exact cubic spline representation for the function y(x).</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Indepdendent variable values. Will be sorted if not increasing.</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Dependent variable values.</p>
</div>
</li>
<li>
<b><code>yprime1</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>First derivative at the lower-x boundary, by default None</p>
</div>
</li>
<li>
<b><code>yprimeN</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>First derivative at the upper-x boundary, by default None.
slope of None means to use 'natural boundary conditions' by fixing the
second derivative to zero at that boundary.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">yprime1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">yprimeN</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create an exact cubic spline representation for the function y(x).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Indepdendent variable values. Will be sorted if not increasing.</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        Dependent variable values.</span>
<span class="sd">    yprime1 : float | None, optional</span>
<span class="sd">        First derivative at the lower-x boundary, by default None</span>
<span class="sd">    yprimeN : float | None, optional</span>
<span class="sd">        First derivative at the upper-x boundary, by default None.</span>
<span class="sd">        slope of None means to use 'natural boundary conditions' by fixing the</span>
<span class="sd">        second derivative to zero at that boundary.</span>
<span class="sd">    """</span>
    <span class="n">argsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)[</span><span class="n">argsort</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argsort</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">yprime1</span> <span class="o">=</span> <span class="n">yprime1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">yprimeN</span> <span class="o">=</span> <span class="n">yprimeN</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_y2</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.CubicSpline.variance">
<code class="highlight language-python"><span class="n">variance</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a dummy estimate of the variance at points <code>xtest</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtest</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># noqa: PLR6301</span>
<span class="w">    </span><span class="sd">"""Return a dummy estimate of the variance at points `xtest`."""</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.interpolate.GPRSpline">
<code>GPRSpline</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="CubicSpline (mass2.mathstat.interpolate.CubicSpline)" href="#mass2.mathstat.interpolate.CubicSpline">CubicSpline</a></code></p>
<p>A callable object that performs a smoothing cubic spline operation</p>
<p>The smoothing spline is the cubic spline minimizing the "curvature
energy" subject to a constraint that the maximum allowed chi-squared is
equal to the number of data points. Here curvature energy is defined as
the integral of the square of the second derivative from the lowest to
the highest knots.</p>
<p>The value of <code>sigmaf</code> fixes the square root of the "function variance".
Small values of <code>sigmaf</code> correspond to large penalties on the curvature,
so they emphasize low curvature. Large <code>sigmaf</code> places emphasis on fidelity to
the data and will have relatively higher curvature (and a higher uncertainty on
the derived curve). Setting <code>sigmaf=None</code> (the default) will choose the value that
maximizes the Bayesian marginal likelihood of the data and is probably smart.</p>
<p>For further discussion, see Sections 2.2, 2.7, and 6.3 of
Rasmussen, C. E., &amp; Williams, K. I. (2006). Gaussian Processes for Machine Learning.
Retrieved from http://www.gaussianprocess.org/gpml/chapters/</p>
<p>This object is very similar to <code>SmoothingSpline</code> in this module but is based on
Gaussian Process Regression theory. It improves on <code>SmoothingSpline</code> in that:
1. The curvature/data fidelity trade-off is chosen by more principaled, Bayesian means.
2. The uncertainty in the spline curve is estimated by GPR theory.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GPRSpline</span><span class="p">(</span><span class="n">CubicSpline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A callable object that performs a smoothing cubic spline operation</span>

<span class="sd">    The smoothing spline is the cubic spline minimizing the "curvature</span>
<span class="sd">    energy" subject to a constraint that the maximum allowed chi-squared is</span>
<span class="sd">    equal to the number of data points. Here curvature energy is defined as</span>
<span class="sd">    the integral of the square of the second derivative from the lowest to</span>
<span class="sd">    the highest knots.</span>

<span class="sd">    The value of `sigmaf` fixes the square root of the "function variance".</span>
<span class="sd">    Small values of `sigmaf` correspond to large penalties on the curvature,</span>
<span class="sd">    so they emphasize low curvature. Large `sigmaf` places emphasis on fidelity to</span>
<span class="sd">    the data and will have relatively higher curvature (and a higher uncertainty on</span>
<span class="sd">    the derived curve). Setting `sigmaf=None` (the default) will choose the value that</span>
<span class="sd">    maximizes the Bayesian marginal likelihood of the data and is probably smart.</span>

<span class="sd">    For further discussion, see Sections 2.2, 2.7, and 6.3 of</span>
<span class="sd">    Rasmussen, C. E., &amp; Williams, K. I. (2006). Gaussian Processes for Machine Learning.</span>
<span class="sd">    Retrieved from http://www.gaussianprocess.org/gpml/chapters/</span>

<span class="sd">    This object is very similar to `SmoothingSpline` in this module but is based on</span>
<span class="sd">    Gaussian Process Regression theory. It improves on `SmoothingSpline` in that:</span>
<span class="sd">    1. The curvature/data fidelity trade-off is chosen by more principaled, Bayesian means.</span>
<span class="sd">    2. The uncertainty in the spline curve is estimated by GPR theory.</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigmaf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Set up the Gaussian Process Regression spline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            Indepdendent variable values. Will be sorted if not increasing.</span>
<span class="sd">        y : ArrayLike</span>
<span class="sd">            Dependent variable values.</span>
<span class="sd">        dy : ArrayLike</span>
<span class="sd">            Uncertainties in y values.</span>
<span class="sd">        dx : ArrayLike | None, optional</span>
<span class="sd">            Uncertainties in x values, by default None</span>
<span class="sd">        sigmaf : float | None, optional</span>
<span class="sd">            Allowed function variance, or None to maximize the data likelihood, by default None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
            <span class="n">roughfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="n">roughfit</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigmaf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigmaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_sigmaf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span> <span class="o">=</span> <span class="n">sigmaf</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sf2</span> <span class="o">=</span> <span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">):</span>
            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">):</span>
                <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">Ky</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Ky</span><span class="p">)</span>
        <span class="n">LH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LH</span><span class="p">)</span>
        <span class="n">KinvHT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">LH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KinvHT</span> <span class="o">=</span> <span class="n">KinvHT</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># Compute at test points = self.x</span>
        <span class="c1"># We know that these are the knots of a natural cubic spline</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="n">fbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">gbar</span> <span class="o">=</span> <span class="n">fbar</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">CubicSpline</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gbar</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">best_sigmaf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the sigmaf value that maximizes the marginal Bayesian likelihood."""</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginal_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">[</span><span class="n">guess</span> <span class="o">/</span> <span class="mf">1e4</span><span class="p">,</span> <span class="n">guess</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="c1"># _marginal_like depends only on the abs(argument), so take minimizer as positive.</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">raise</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Could not maximimze the marginal likelihood"</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_marginal_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigmaf</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute the marginal likelihood of the data given sigmaf.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sigmaf : float</span>
<span class="sd">            The square root of the function variance</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The marginal likelihood (up to an additive constant)</span>
<span class="sd">        """</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sf2</span> <span class="o">=</span> <span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">):</span>
            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">):</span>
                <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">Ky</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Ky</span><span class="p">)</span>
        <span class="n">LH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LH</span><span class="p">)</span>
        <span class="n">KinvHT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">LH</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">KinvHT</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">yCy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">Linvy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">yKinvy</span> <span class="o">=</span> <span class="n">Linvy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Linvy</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">Ky</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yCy</span> <span class="o">+</span> <span class="n">yKinvy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtest</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Returns the variance for function evaluations at the test points `xtest`.</span>

<span class="sd">        This equals the diagonal of `self.covariance(xtest)`, but for large test sets,</span>
<span class="sd">        this method computes only the diagonal and should therefore be faster."""</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xtest</span><span class="p">):</span>
            <span class="n">Ktest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">LinvKtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">Ktest</span><span class="p">)</span>
            <span class="n">cov_ftest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">LinvKtest</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ktest</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov_ftest</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xtest</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtest</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Returns the covariance between function evaluations at the test points `xtest`."""</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xtest</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>
        <span class="n">xtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>

        <span class="n">Ktest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xtest</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">LinvKtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">Ktest</span><span class="p">)</span>
        <span class="n">cov_ftest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xtest</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xtest</span><span class="p">])</span>
        <span class="n">cov_ftest</span> <span class="o">-=</span> <span class="n">LinvKtest</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LinvKtest</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xtest</span><span class="p">)),</span> <span class="n">xtest</span><span class="p">))</span>
        <span class="n">R</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ktest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov_ftest</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.GPRSpline.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigmaf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set up the Gaussian Process Regression spline.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Indepdendent variable values. Will be sorted if not increasing.</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Dependent variable values.</p>
</div>
</li>
<li>
<b><code>dy</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Uncertainties in y values.</p>
</div>
</li>
<li>
<b><code>dx</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Uncertainties in x values, by default None</p>
</div>
</li>
<li>
<b><code>sigmaf</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Allowed function variance, or None to maximize the data likelihood, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sigmaf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Set up the Gaussian Process Regression spline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Indepdendent variable values. Will be sorted if not increasing.</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        Dependent variable values.</span>
<span class="sd">    dy : ArrayLike</span>
<span class="sd">        Uncertainties in y values.</span>
<span class="sd">    dx : ArrayLike | None, optional</span>
<span class="sd">        Uncertainties in x values, by default None</span>
<span class="sd">    sigmaf : float | None, optional</span>
<span class="sd">        Allowed function variance, or None to maximize the data likelihood, by default None</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">roughfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="n">roughfit</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sigmaf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigmaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_sigmaf</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span> <span class="o">=</span> <span class="n">sigmaf</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sf2</span> <span class="o">=</span> <span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">):</span>
        <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">):</span>
            <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">Ky</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Ky</span><span class="p">)</span>
    <span class="n">LH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">LH</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LH</span><span class="p">)</span>
    <span class="n">KinvHT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">LH</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">KinvHT</span> <span class="o">=</span> <span class="n">KinvHT</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Compute at test points = self.x</span>
    <span class="c1"># We know that these are the knots of a natural cubic spline</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">fbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">gbar</span> <span class="o">=</span> <span class="n">fbar</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">CubicSpline</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gbar</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.GPRSpline.best_sigmaf">
<code class="highlight language-python"><span class="n">best_sigmaf</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the sigmaf value that maximizes the marginal Bayesian likelihood.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">best_sigmaf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the sigmaf value that maximizes the marginal Bayesian likelihood."""</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginal_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">[</span><span class="n">guess</span> <span class="o">/</span> <span class="mf">1e4</span><span class="p">,</span> <span class="n">guess</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
        <span class="c1"># _marginal_like depends only on the abs(argument), so take minimizer as positive.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">raise</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Could not maximimze the marginal likelihood"</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.GPRSpline.covariance">
<code class="highlight language-python"><span class="n">covariance</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Returns the covariance between function evaluations at the test points <code>xtest</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtest</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Returns the covariance between function evaluations at the test points `xtest`."""</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xtest</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>
    <span class="n">xtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>

    <span class="n">Ktest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xtest</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">LinvKtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">Ktest</span><span class="p">)</span>
    <span class="n">cov_ftest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xtest</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xtest</span><span class="p">])</span>
    <span class="n">cov_ftest</span> <span class="o">-=</span> <span class="n">LinvKtest</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">LinvKtest</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xtest</span><span class="p">)),</span> <span class="n">xtest</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ktest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cov_ftest</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.GPRSpline.variance">
<code class="highlight language-python"><span class="n">variance</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Returns the variance for function evaluations at the test points <code>xtest</code>.</p>
<p>This equals the diagonal of <code>self.covariance(xtest)</code>, but for large test sets,
this method computes only the diagonal and should therefore be faster.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtest</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Returns the variance for function evaluations at the test points `xtest`.</span>

<span class="sd">    This equals the diagonal of `self.covariance(xtest)`, but for large test sets,</span>
<span class="sd">    this method computes only the diagonal and should therefore be faster."""</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xtest</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xtest</span><span class="p">):</span>
        <span class="n">Ktest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">LinvKtest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">Ktest</span><span class="p">)</span>
        <span class="n">cov_ftest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">LinvKtest</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">KinvHT</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ktest</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov_ftest</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xtest</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.interpolate.NaturalBsplineBasis">
<code>NaturalBsplineBasis</code>
</h2>
<div class="doc doc-contents">
<p>Represent a cubic B-spline basis in 1D with natural boundary conditions.</p>
<p>That is, f''(x)=0 at the first and last knots. This constraint reduces the
effective number of basis functions from (2+Nknots) to Nknots.</p>
<p>Usage:
knots = [0,5,8,9,10,12]
basis = NaturalBsplineBasis(knots)
x = np.linspace(0, 12, 200)
plt.clf()
for id in range(len(knots)):
    plt.plot(x, basis(x, id))</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NaturalBsplineBasis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Represent a cubic B-spline basis in 1D with natural boundary conditions.</span>

<span class="sd">    That is, f''(x)=0 at the first and last knots. This constraint reduces the</span>
<span class="sd">    effective number of basis functions from (2+Nknots) to Nknots.</span>

<span class="sd">    Usage:</span>
<span class="sd">    knots = [0,5,8,9,10,12]</span>
<span class="sd">    basis = NaturalBsplineBasis(knots)</span>
<span class="sd">    x = np.linspace(0, 12, 200)</span>
<span class="sd">    plt.clf()</span>
<span class="sd">    for id in range(len(knots)):</span>
<span class="sd">        plt.plot(x, basis(x, id))</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knots</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialization requires only the list of knots."""</span>
        <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
        <span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">knots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">knots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">padknots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">knots</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">]])</span>

        <span class="c1"># Combinations of basis function #1 into 2 and 3 (and #N+2 into N+1</span>
        <span class="c1"># and N) are used to enforce the natural B.C. of f''(x)=0 at the ends.</span>
        <span class="n">lowfpp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">hifpp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">scoef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">scoef</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">lowfpp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">BSpline</span><span class="p">(</span><span class="n">padknots</span><span class="p">,</span> <span class="n">scoef</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">scoef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">scoef</span><span class="p">[</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># go from last to 3rd-to-last</span>
            <span class="n">hifpp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">BSpline</span><span class="p">(</span><span class="n">padknots</span><span class="p">,</span> <span class="n">scoef</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">lowfpp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">lowfpp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">hifpp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">hifpp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">=</span> <span class="n">Nk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padknots</span> <span class="o">=</span> <span class="n">padknots</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute the Basis-spline at the points `x` for basis function `id`, or its derivative of degree `der`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            Independent variable values at which to evaluate the basis function.</span>
<span class="sd">        id : int</span>
<span class="sd">            Which basis function to evaluate, 0 &lt;= id &lt; Nk</span>
<span class="sd">        der : int, optional</span>
<span class="sd">            Derivative degree, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray</span>
<span class="sd">            Basis function values (or derivative values) at `x`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `id` is not in the range 0 &lt;= id &lt; Nk</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Require 0 &lt;= id &lt; Nk=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">coef</span><span class="p">[</span><span class="nb">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">coef</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">-</span> <span class="nb">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">padknots</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">values_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return matrix M where M_ij = value at knot i for basis function j.</span>
<span class="sd">        If der&gt;0, then return the derivative of that order instead of the value."""</span>
        <span class="c1"># Note the array is naturally built by vstack as the Transpose of what we want.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">expand_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Given coefficients of this length-Nk basis, return the coefficients</span>
<span class="sd">        needed by FITPACK, which are of length Nk+2."""</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">first</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">last</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.NaturalBsplineBasis.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute the Basis-spline at the points <code>x</code> for basis function <code>id</code>, or its derivative of degree <code>der</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Independent variable values at which to evaluate the basis function.</p>
</div>
</li>
<li>
<b><code>id</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
<p>Which basis function to evaluate, 0 &lt;= id &lt; Nk</p>
</div>
</li>
<li>
<b><code>der</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
<p>Derivative degree, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              –
              <div class="doc-md-description">
<p>Basis function values (or derivative values) at <code>x</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>If <code>id</code> is not in the range 0 &lt;= id &lt; Nk</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the Basis-spline at the points `x` for basis function `id`, or its derivative of degree `der`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Independent variable values at which to evaluate the basis function.</span>
<span class="sd">    id : int</span>
<span class="sd">        Which basis function to evaluate, 0 &lt;= id &lt; Nk</span>
<span class="sd">    der : int, optional</span>
<span class="sd">        Derivative degree, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        Basis function values (or derivative values) at `x`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `id` is not in the range 0 &lt;= id &lt; Nk</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Require 0 &lt;= id &lt; Nk=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">coef</span><span class="p">[</span><span class="nb">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">coef</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">-</span> <span class="nb">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">padknots</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.NaturalBsplineBasis.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Initialization requires only the list of knots.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knots</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialization requires only the list of knots."""</span>
    <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
    <span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">knots</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">knots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">padknots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">knots</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">]])</span>

    <span class="c1"># Combinations of basis function #1 into 2 and 3 (and #N+2 into N+1</span>
    <span class="c1"># and N) are used to enforce the natural B.C. of f''(x)=0 at the ends.</span>
    <span class="n">lowfpp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">hifpp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">scoef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">scoef</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">lowfpp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">BSpline</span><span class="p">(</span><span class="n">padknots</span><span class="p">,</span> <span class="n">scoef</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">scoef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">scoef</span><span class="p">[</span><span class="n">Nk</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># go from last to 3rd-to-last</span>
        <span class="n">hifpp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">BSpline</span><span class="p">(</span><span class="n">padknots</span><span class="p">,</span> <span class="n">scoef</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">lowfpp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">lowfpp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">hifpp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">hifpp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">=</span> <span class="n">Nk</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">padknots</span> <span class="o">=</span> <span class="n">padknots</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.NaturalBsplineBasis.expand_coeff">
<code class="highlight language-python"><span class="n">expand_coeff</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Given coefficients of this length-Nk basis, return the coefficients
needed by FITPACK, which are of length Nk+2.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">expand_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Given coefficients of this length-Nk basis, return the coefficients</span>
<span class="sd">    needed by FITPACK, which are of length Nk+2."""</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">first</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">last</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.NaturalBsplineBasis.values_matrix">
<code class="highlight language-python"><span class="n">values_matrix</span><span class="p">(</span><span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return matrix M where M_ij = value at knot i for basis function j.
If der&gt;0, then return the derivative of that order instead of the value.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">values_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return matrix M where M_ij = value at knot i for basis function j.</span>
<span class="sd">    If der&gt;0, then return the derivative of that order instead of the value."""</span>
    <span class="c1"># Note the array is naturally built by vstack as the Transpose of what we want.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knots</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSpline">
<code>SmoothingSpline</code>
</h2>
<div class="doc doc-contents">
<p>A callable object that performs a smoothing cubic spline operation, using
the NaturalBsplineBasis object for the basis representation of splines.</p>
<p>The smoothing spline is the cubic spline minimizing the "curvature
energy" subject to a constraint that the maximum allowed chi-squared is
equal to the number of data points. Here curvature energy is defined as
the integral of the square of the second derivative from the lowest to
the highest knots.</p>
<p>For a proof see Reinsch, C. H. (1967). "Smoothing by spline functions."
Numerische Mathematik, 10(3), 177-183. http://doi.org/10.1007/BF02162161</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SmoothingSpline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A callable object that performs a smoothing cubic spline operation, using</span>
<span class="sd">    the NaturalBsplineBasis object for the basis representation of splines.</span>

<span class="sd">    The smoothing spline is the cubic spline minimizing the "curvature</span>
<span class="sd">    energy" subject to a constraint that the maximum allowed chi-squared is</span>
<span class="sd">    equal to the number of data points. Here curvature energy is defined as</span>
<span class="sd">    the integral of the square of the second derivative from the lowest to</span>
<span class="sd">    the highest knots.</span>

<span class="sd">    For a proof see Reinsch, C. H. (1967). "Smoothing by spline functions."</span>
<span class="sd">    Numerische Mathematik, 10(3), 177-183. http://doi.org/10.1007/BF02162161</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxchisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Smoothing spline for data {x,y} with errors {dy} on the y values</span>
<span class="sd">        and {dx} on the x values (or zero if not given).</span>

<span class="sd">        If dx errors are given, a global quadratic fit is done to the data to</span>
<span class="sd">        estimate the local slope. If that's a poor choice, then you should</span>
<span class="sd">        combine your dx and dy errors to create a sensible single error list,</span>
<span class="sd">        and you should pass that in as dy.</span>

<span class="sd">        maxchisq specifies the largest allowed value of chi-squared (the sum of</span>
<span class="sd">        the squares of the differences y_i-f(x_i), divided by the variance v_i).</span>
<span class="sd">        If not given, this defaults to the number of data values. When a</span>
<span class="sd">        (weighted) least squares fit of a line to the data meets the maxchisq</span>
<span class="sd">        constraint, then the actual chi-squared will be less than maxchisq.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roughfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="n">roughfit</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxchisq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxchisq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxchisq</span> <span class="o">=</span> <span class="n">maxchisq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">NaturalBsplineBasis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">values_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">values_matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_Omega</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">chisq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxchisq</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_Omega</span><span class="p">(</span><span class="n">knots</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">N2</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Given the matrix M2 of second derivates at the knots (that is, M2_ij is</span>
<span class="sd">        the value of B_j''(x_i), second derivative of basis function #j at knot i),</span>
<span class="sd">        compute the matrix Omega, where Omega_ij is the integral over the entire</span>
<span class="sd">        domain of the product B_i''(x) B_j''(x). This can be done because each B_i(x)</span>
<span class="sd">        is piecewise linear, with the slope changes at each knot location."""</span>

        <span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">N2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Nk</span>
        <span class="k">assert</span> <span class="n">N2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Nk</span>
        <span class="n">Omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">N2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nk</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">Omega</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">N2</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">N2</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">N2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">knots</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">knots</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="mf">6.0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nk</span><span class="p">):</span>
                    <span class="n">Omega</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">knots</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">knots</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="mf">3.0</span>
                <span class="n">Omega</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Omega</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Omega</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Choose the value of the curve at the knots so as to achieve the</span>
<span class="sd">        smallest possible curvature subject to the constraint that the</span>
<span class="sd">        sum over all {x,y} pairs S = [(y-f(x))/dy]^2 &lt;= chisq"""</span>
        <span class="k">if</span> <span class="n">chisq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span>

        <span class="n">Dinv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Vector but stands for diagonals of a diagonal matrix.</span>
        <span class="n">NTDinv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Dinv</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">NTDinv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="p">)</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Dinv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">best_params</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Return the best-fit parameters for a given curvature penalty p."""</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">rhs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">chisq_difference</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">target_chisq</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Return the difference between the chi-squared for curvature penalty p</span>
<span class="sd">            and the target chi-squared."""</span>
            <span class="c1"># If curvature is too small, the computation can become singular.</span>
            <span class="c1"># Avoid this by returning a crazy-high chisquared, as needed.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1e99</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chisq</span> <span class="o">-</span> <span class="n">target_chisq</span>

        <span class="n">mincurvature</span> <span class="o">=</span> <span class="mf">1e-20</span>
        <span class="n">pbest</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">chisq_difference</span><span class="p">,</span> <span class="n">mincurvature</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">chisq</span><span class="p">,))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">(</span><span class="n">pbest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">expand_coeff</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actualchisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Store the linear extrapolation outside the knotted region.</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eval</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eval</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">slope</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">slope</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the value of (the `der`th derivative of) the smoothing spline</span>
<span class="sd">        at data points `x`."""</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
        <span class="n">splresult</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">padknots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">low</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allow_extrapolate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">splresult</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowline</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">splresult</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowline</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">splresult</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allow_extrapolate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">splresult</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highline</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">splresult</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highline</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">splresult</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">splresult</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span><span class="o">**</span><span class="n">der</span>
        <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
            <span class="n">splresult</span> <span class="o">=</span> <span class="n">splresult</span><span class="p">[()]</span>
        <span class="k">return</span> <span class="n">splresult</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the value of (the `der`th derivative of) the smoothing spline</span>
<span class="sd">        at data points `x`."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSpline.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the value of (the <code>der</code>th derivative of) the smoothing spline
at data points <code>x</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the value of (the `der`th derivative of) the smoothing spline</span>
<span class="sd">    at data points `x`."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSpline.__eval">
<code class="highlight language-python"><span class="n">__eval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the value of (the <code>der</code>th derivative of) the smoothing spline
at data points <code>x</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the value of (the `der`th derivative of) the smoothing spline</span>
<span class="sd">    at data points `x`."""</span>
    <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
    <span class="n">splresult</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">padknots</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">low</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allow_extrapolate</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">splresult</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowline</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">splresult</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowline</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">splresult</span><span class="p">[</span><span class="n">low</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allow_extrapolate</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">splresult</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highline</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">splresult</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highline</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">der</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">splresult</span><span class="p">[</span><span class="n">high</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">der</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">splresult</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span><span class="o">**</span><span class="n">der</span>
    <span class="k">if</span> <span class="n">scalar</span><span class="p">:</span>
        <span class="n">splresult</span> <span class="o">=</span> <span class="n">splresult</span><span class="p">[()]</span>
    <span class="k">return</span> <span class="n">splresult</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSpline.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxchisq</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Smoothing spline for data {x,y} with errors {dy} on the y values
and {dx} on the x values (or zero if not given).</p>
<p>If dx errors are given, a global quadratic fit is done to the data to
estimate the local slope. If that's a poor choice, then you should
combine your dx and dy errors to create a sensible single error list,
and you should pass that in as dy.</p>
<p>maxchisq specifies the largest allowed value of chi-squared (the sum of
the squares of the differences y_i-f(x_i), divided by the variance v_i).
If not given, this defaults to the number of data values. When a
(weighted) least squares fit of a line to the data meets the maxchisq
constraint, then the actual chi-squared will be less than maxchisq.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxchisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Smoothing spline for data {x,y} with errors {dy} on the y values</span>
<span class="sd">    and {dx} on the x values (or zero if not given).</span>

<span class="sd">    If dx errors are given, a global quadratic fit is done to the data to</span>
<span class="sd">    estimate the local slope. If that's a poor choice, then you should</span>
<span class="sd">    combine your dx and dy errors to create a sensible single error list,</span>
<span class="sd">    and you should pass that in as dy.</span>

<span class="sd">    maxchisq specifies the largest allowed value of chi-squared (the sum of</span>
<span class="sd">    the squares of the differences y_i-f(x_i), divided by the variance v_i).</span>
<span class="sd">    If not given, this defaults to the number of data values. When a</span>
<span class="sd">    (weighted) least squares fit of a line to the data meets the maxchisq</span>
<span class="sd">    constraint, then the actual chi-squared will be less than maxchisq.</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># copy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">roughfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyder</span><span class="p">(</span><span class="n">roughfit</span><span class="p">,</span> <span class="mi">1</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxchisq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxchisq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxchisq</span> <span class="o">=</span> <span class="n">maxchisq</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">NaturalBsplineBasis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">values_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">N2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">values_matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_Omega</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">chisq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxchisq</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSpline.smooth">
<code class="highlight language-python"><span class="n">smooth</span><span class="p">(</span><span class="n">chisq</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Choose the value of the curve at the knots so as to achieve the
smallest possible curvature subject to the constraint that the
sum over all {x,y} pairs S = [(y-f(x))/dy]^2 &lt;= chisq</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Choose the value of the curve at the knots so as to achieve the</span>
<span class="sd">    smallest possible curvature subject to the constraint that the</span>
<span class="sd">    sum over all {x,y} pairs S = [(y-f(x))/dy]^2 &lt;= chisq"""</span>
    <span class="k">if</span> <span class="n">chisq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nk</span>

    <span class="n">Dinv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Vector but stands for diagonals of a diagonal matrix.</span>
    <span class="n">NTDinv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Dinv</span>
    <span class="n">lhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">NTDinv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="p">)</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Dinv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">best_params</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the best-fit parameters for a given curvature penalty p."""</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">rhs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">chisq_difference</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">target_chisq</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the difference between the chi-squared for curvature penalty p</span>
<span class="sd">        and the target chi-squared."""</span>
        <span class="c1"># If curvature is too small, the computation can become singular.</span>
        <span class="c1"># Avoid this by returning a crazy-high chisquared, as needed.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e99</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chisq</span> <span class="o">-</span> <span class="n">target_chisq</span>

    <span class="n">mincurvature</span> <span class="o">=</span> <span class="mf">1e-20</span>
    <span class="n">pbest</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">chisq_difference</span><span class="p">,</span> <span class="n">mincurvature</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">chisq</span><span class="p">,))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">(</span><span class="n">pbest</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">expand_coeff</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N0</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">actualchisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Store the linear extrapolation outside the knotted region.</span>
    <span class="n">endpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eval</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eval</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">allow_extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscale</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lowline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">slope</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">highline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="n">slope</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSplineLog">
<code>SmoothingSplineLog</code>
</h2>
<div class="doc doc-contents">
<p>A smoothing spline in log-log space.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SmoothingSplineLog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A smoothing spline in log-log space."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxchisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Set up a smoothing spline in log-log space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            Independent variable values. Must be positive and will be sorted if not increasing.</span>
<span class="sd">        y : ArrayLike</span>
<span class="sd">            Dependent variable values. Must be positive.</span>
<span class="sd">        dy : ArrayLike</span>
<span class="sd">            Uncertainties in y values.</span>
<span class="sd">        dx : ArrayLike | None, optional</span>
<span class="sd">            Uncertainties in x values, by default None</span>
<span class="sd">        maxchisq : float | None, optional</span>
<span class="sd">            Maximum allowed chi^2 value, by default None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any x or y values are not positive.</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"The x and y data must all be positive to use a SmoothingSplineLog"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_model</span> <span class="o">=</span> <span class="n">SmoothingSpline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">maxchisq</span><span class="o">=</span><span class="n">maxchisq</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute the log-log smoothing spline or its derivative at the points `x`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            Independent variable values at which to evaluate the spline.</span>
<span class="sd">        der : int, optional</span>
<span class="sd">            Derivative degree, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray</span>
<span class="sd">            Smoothing spline values (or derivative values) at `x`.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_model</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSplineLog.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute the log-log smoothing spline or its derivative at the points <code>x</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Independent variable values at which to evaluate the spline.</p>
</div>
</li>
<li>
<b><code>der</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
<p>Derivative degree, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              –
              <div class="doc-md-description">
<p>Smoothing spline values (or derivative values) at <code>x</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">der</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the log-log smoothing spline or its derivative at the points `x`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Independent variable values at which to evaluate the spline.</span>
<span class="sd">    der : int, optional</span>
<span class="sd">        Derivative degree, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        Smoothing spline values (or derivative values) at `x`.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_model</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">der</span><span class="o">=</span><span class="n">der</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.interpolate.SmoothingSplineLog.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxchisq</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set up a smoothing spline in log-log space.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Independent variable values. Must be positive and will be sorted if not increasing.</p>
</div>
</li>
<li>
<b><code>y</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Dependent variable values. Must be positive.</p>
</div>
</li>
<li>
<b><code>dy</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              –
              <div class="doc-md-description">
<p>Uncertainties in y values.</p>
</div>
</li>
<li>
<b><code>dx</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Uncertainties in x values, by default None</p>
</div>
</li>
<li>
<b><code>maxchisq</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Maximum allowed chi^2 value, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
<p>If any x or y values are not positive.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxchisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Set up a smoothing spline in log-log space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        Independent variable values. Must be positive and will be sorted if not increasing.</span>
<span class="sd">    y : ArrayLike</span>
<span class="sd">        Dependent variable values. Must be positive.</span>
<span class="sd">    dy : ArrayLike</span>
<span class="sd">        Uncertainties in y values.</span>
<span class="sd">    dx : ArrayLike | None, optional</span>
<span class="sd">        Uncertainties in x values, by default None</span>
<span class="sd">    maxchisq : float | None, optional</span>
<span class="sd">        Maximum allowed chi^2 value, by default None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If any x or y values are not positive.</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"The x and y data must all be positive to use a SmoothingSplineLog"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear_model</span> <span class="o">=</span> <span class="n">SmoothingSpline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">maxchisq</span><span class="o">=</span><span class="n">maxchisq</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.interpolate.k_spline">
<code class="highlight language-python"><span class="n">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the spline covariance kernel, R&amp;W eq 6.28.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/interpolate.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">k_spline</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the spline covariance kernel, R&amp;W eq 6.28."""</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h3 id="power-spectra">Power spectra</h3>
<div class="doc doc-object doc-module">
<a id="mass2.mathstat.power_spectrum"></a>
<div class="doc doc-contents first">
<p>A class and functions to compute a power spectrum using some of the
sophistications given in Numerical Recipes, including windowing and
overlapping data segments.</p>
<p>Use the class PowerSpectrum in the case that you are compute-limited
and PowerSpectrumOverlap in the case that you are data-limited.  The
latter uses k segments of data two segments at a time to make (k-1)
estimates and makes fuller use of all data (except in the first and
last segment).</p>
<p>Joe Fowler, NIST</p>
<p>October 13, 2010</p>
<p>Usage:</p>
<p>import power_spectrum as ps
import pylab as plt
N=1024
M=N/4
data=np.random.default_rng().standard_normal(N)
spec = ps.PowerSpectrum(M, dt=1e-6)
window = ps.hann(2<em>M)
for i in range(3):
    spec.addDataSegment(data[i</em>M : (i+2)*M], window=window)
plt.plot(spec.frequencies(), spec.spectrum())</p>
<p>Or you can use the convenience function that hides the class objects
from you and simply returns a (frequency,spectrum) pair of arrays:</p>
<p>N=1024
data=np.random.default_rng().standard_normal(N)
plt.clf()
for i in (2,4,8,1):
    f,s = ps.computeSpectrum(data, segfactor=i, dt=1e-6, window=np.hanning)
    plt.plot(f, s)</p>
<p>Window choices are:
bartlett - Triangle shape
hann     - Sine-squared
hamming  - 0.08 + 0.92*(sine-squared)
welch    - Parabolic
None     - Square (no windowing)
***      - Any other vector of length 2m OR any callable accepting
           2m as an argument and returning a sequence of that length.</p>
<p>Each window take an argument (n), the number of data points per
segment.  When using the PowerSpectrum or PowerSpectrumOverlap classes
or the convenience function computeSpectrum, you have a choice.  You
can call the window and pass in the resulting vector, or you can pass
in the callable function itself.  It is allowed to use different windows
on different data segments, though honestly that would be really weird.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum">
<code>PowerSpectrum</code>
</h2>
<div class="doc doc-contents">
<p>Object for accumulating power spectrum estimates from one or more data segments.</p>
<p>If you want to use multiple overlapping segments, use class
PowerSpectrumOvelap.</p>
<p>Based on Num Rec 3rd Ed section 13.4</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PowerSpectrum</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Object for accumulating power spectrum estimates from one or more data segments.</span>

<span class="sd">    If you want to use multiple overlapping segments, use class</span>
<span class="sd">    PowerSpectrumOvelap.</span>

<span class="sd">    Based on Num Rec 3rd Ed section 13.4"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Sets up to estimate PSD at m+1 frequencies (counting DC) given</span>
<span class="sd">        data segments of length 2m.  Optional dt is the time step Delta"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"PowerSpectrum"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the object.</span>

<span class="sd">        Handy when coding and you don't want to recompute everything, but</span>
<span class="sd">        you do want to update the method definitions."""</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">PowerSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Process a data segment of length 2m using the window function</span>
<span class="sd">        given.  window can be None (square window), a callable taking the</span>
<span class="sd">        length and returning a sequence, or a sequence."""</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"wrong size data segment.  len(data)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> but require </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"data contains NaN"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Window not understood"</span><span class="p">)</span>
        <span class="n">wksp</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">data</span>
        <span class="n">sum_window</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">sum_window</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># we want real units</span>
            <span class="n">scale_factor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
        <span class="n">wksp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">wksp</span><span class="p">)</span>

        <span class="c1"># The first line adds 2x too much to the first/last bins.</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wksp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span> <span class="o">+=</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="n">ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addLongData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Process a long vector of data as non-overlapping segments of length 2m."""</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="n">nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
            <span class="n">noff</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">noff</span> <span class="p">:</span> <span class="n">noff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""If &lt;nbins&gt; is given, the data are averaged into &lt;nbins&gt; bins."""</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot rebin into more than m=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="si">}</span><span class="s2"> bins"</span><span class="p">)</span>

        <span class="n">newbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span><span class="p">[</span><span class="n">newbin</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">autocorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the autocorrelation (the DFT of this power spectrum)"""</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"The autocorrelation method is not yet implemented."</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""If &lt;nbins&gt; is given, the data are averaged into &lt;nbins&gt; bins."""</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot rebin into more than m=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="si">}</span><span class="s2"> bins"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">nbins</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">arb_to_unit_scale_and_label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"arb"</span><span class="p">),</span>
        <span class="n">sqrt_psd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the power spectrum (or its square root) on a log-log plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axis : plt.Axes | None, optional</span>
<span class="sd">            Axes to plot on, or if None create a new figure, by default None</span>
<span class="sd">        arb_to_unit_scale_and_label : tuple[int, str], optional</span>
<span class="sd">            rescale the sqrt(PSD) by this amoutn and label it such, by default (1, "arb")</span>
<span class="sd">        sqrt_psd : bool, optional</span>
<span class="sd">            Whether to take the square root of the PSD, by default True</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">arb_to_unit_scale</span><span class="p">,</span> <span class="n">unit_label</span> <span class="o">=</span> <span class="n">arb_to_unit_scale_and_label</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arb_to_unit_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">sqrt_psd</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psd</span><span class="p">),</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Power Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$/</span><span class="se">\\</span><span class="s2">sqrt</span><span class="se">{{</span><span class="s2">Hz</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Amplitude Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$^2$ Hz$^</span><span class="se">{{</span><span class="s2">-1</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Sets up to estimate PSD at m+1 frequencies (counting DC) given
data segments of length 2m.  Optional dt is the time step Delta</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Sets up to estimate PSD at m+1 frequencies (counting DC) given</span>
<span class="sd">    data segments of length 2m.  Optional dt is the time step Delta"""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.addDataSegment">
<code class="highlight language-python"><span class="n">addDataSegment</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Process a data segment of length 2m using the window function
given.  window can be None (square window), a callable taking the
length and returning a sequence, or a sequence.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Process a data segment of length 2m using the window function</span>
<span class="sd">    given.  window can be None (square window), a callable taking the</span>
<span class="sd">    length and returning a sequence, or a sequence."""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"wrong size data segment.  len(data)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> but require </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"data contains NaN"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">window</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Window not understood"</span><span class="p">)</span>
    <span class="n">wksp</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">data</span>
    <span class="n">sum_window</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">sum_window</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># we want real units</span>
        <span class="n">scale_factor</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
    <span class="n">wksp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">wksp</span><span class="p">)</span>

    <span class="c1"># The first line adds 2x too much to the first/last bins.</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wksp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span> <span class="o">+=</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="n">ps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.addLongData">
<code class="highlight language-python"><span class="n">addLongData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Process a long vector of data as non-overlapping segments of length 2m.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">addLongData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Process a long vector of data as non-overlapping segments of length 2m."""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="n">nt</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
        <span class="n">noff</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">noff</span> <span class="p">:</span> <span class="n">noff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.autocorrelation">
<code class="highlight language-python"><span class="n">autocorrelation</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the autocorrelation (the DFT of this power spectrum)</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">autocorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the autocorrelation (the DFT of this power spectrum)"""</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"The autocorrelation method is not yet implemented."</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.copy">
<code class="highlight language-python"><span class="n">copy</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the object.</p>
<p>Handy when coding and you don't want to recompute everything, but
you do want to update the method definitions.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"PowerSpectrum"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of the object.</span>

<span class="sd">    Handy when coding and you don't want to recompute everything, but</span>
<span class="sd">    you do want to update the method definitions."""</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">PowerSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.frequencies">
<code class="highlight language-python"><span class="n">frequencies</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>If <nbins> is given, the data are averaged into <nbins> bins.</nbins></nbins></p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""If &lt;nbins&gt; is given, the data are averaged into &lt;nbins&gt; bins."""</span>
    <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>
    <span class="k">if</span> <span class="n">nbins</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot rebin into more than m=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="si">}</span><span class="s2"> bins"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">nbins</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arb_to_unit_scale_and_label</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'arb'</span><span class="p">),</span> <span class="n">sqrt_psd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the power spectrum (or its square root) on a log-log plot.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>axis</code></b>
                  (<code><span title="pylab.Axes">Axes</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
<p>Axes to plot on, or if None create a new figure, by default None</p>
</div>
</li>
<li>
<b><code>arb_to_unit_scale_and_label</code></b>
                  (<code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="str">str</span>]</code>, default:
                      <code>(1, 'arb')</code>
)
              –
              <div class="doc-md-description">
<p>rescale the sqrt(PSD) by this amoutn and label it such, by default (1, "arb")</p>
</div>
</li>
<li>
<b><code>sqrt_psd</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
<p>Whether to take the square root of the PSD, by default True</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">arb_to_unit_scale_and_label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"arb"</span><span class="p">),</span>
    <span class="n">sqrt_psd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the power spectrum (or its square root) on a log-log plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axis : plt.Axes | None, optional</span>
<span class="sd">        Axes to plot on, or if None create a new figure, by default None</span>
<span class="sd">    arb_to_unit_scale_and_label : tuple[int, str], optional</span>
<span class="sd">        rescale the sqrt(PSD) by this amoutn and label it such, by default (1, "arb")</span>
<span class="sd">    sqrt_psd : bool, optional</span>
<span class="sd">        Whether to take the square root of the PSD, by default True</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">arb_to_unit_scale</span><span class="p">,</span> <span class="n">unit_label</span> <span class="o">=</span> <span class="n">arb_to_unit_scale_and_label</span>
    <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arb_to_unit_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">sqrt_psd</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psd</span><span class="p">),</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Power Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$/</span><span class="se">\\</span><span class="s2">sqrt</span><span class="se">{{</span><span class="s2">Hz</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Amplitude Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$^2$ Hz$^</span><span class="se">{{</span><span class="s2">-1</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrum.spectrum">
<code class="highlight language-python"><span class="n">spectrum</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>If <nbins> is given, the data are averaged into <nbins> bins.</nbins></nbins></p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""If &lt;nbins&gt; is given, the data are averaged into &lt;nbins&gt; bins."""</span>
    <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span>
    <span class="k">if</span> <span class="n">nbins</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot rebin into more than m=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="si">}</span><span class="s2"> bins"</span><span class="p">)</span>

    <span class="n">newbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specsum</span><span class="p">[</span><span class="n">newbin</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsegments</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrumOverlap">
<code>PowerSpectrumOverlap</code>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="PowerSpectrum (mass2.mathstat.power_spectrum.PowerSpectrum)" href="#mass2.mathstat.power_spectrum.PowerSpectrum">PowerSpectrum</a></code></p>
<p>Object for power spectral estimation using overlapping data segments.</p>
<p>User sends non-overlapping segments of length m,
and they are processed in pairs of length 2m with overlap (except
on the first and last segment).</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PowerSpectrumOverlap</span><span class="p">(</span><span class="n">PowerSpectrum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Object for power spectral estimation using overlapping data segments.</span>

<span class="sd">    User sends non-overlapping segments of length m,</span>
<span class="sd">    and they are processed in pairs of length 2m with overlap (except</span>
<span class="sd">    on the first and last segment).</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Sets up an object to accumulate a power spectrum estimate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m : int</span>
<span class="sd">            Create a PSD estimate with m+1 frequency bins (counting DC)</span>
<span class="sd">        dt : float | None, optional</span>
<span class="sd">            Time sample period in seconds, by default 1.0</span>
<span class="sd">        """</span>
        <span class="n">PowerSpectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">"Process a data segment of length m using window."</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">PowerSpectrum</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">addLongData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Process a long vector of data as overlapping segments of</span>
<span class="sd">        length 2m."""</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>
        <span class="k">if</span> <span class="n">nk</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">delta_el</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nk</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta_el</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
            <span class="n">noff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">delta_el</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">PowerSpectrum</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">noff</span> <span class="p">:</span> <span class="n">noff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrumOverlap.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Sets up an object to accumulate a power spectrum estimate.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>m</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
<p>Create a PSD estimate with m+1 frequency bins (counting DC)</p>
</div>
</li>
<li>
<b><code>dt</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>1.0</code>
)
              –
              <div class="doc-md-description">
<p>Time sample period in seconds, by default 1.0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Sets up an object to accumulate a power spectrum estimate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m : int</span>
<span class="sd">        Create a PSD estimate with m+1 frequency bins (counting DC)</span>
<span class="sd">    dt : float | None, optional</span>
<span class="sd">        Time sample period in seconds, by default 1.0</span>
<span class="sd">    """</span>
    <span class="n">PowerSpectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrumOverlap.addDataSegment">
<code class="highlight language-python"><span class="n">addDataSegment</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Process a data segment of length m using window.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">"Process a data segment of length m using window."</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">PowerSpectrum</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullseg</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.mathstat.power_spectrum.PowerSpectrumOverlap.addLongData">
<code class="highlight language-python"><span class="n">addLongData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Process a long vector of data as overlapping segments of
length 2m.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">addLongData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Process a long vector of data as overlapping segments of</span>
<span class="sd">    length 2m."""</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>
    <span class="k">if</span> <span class="n">nk</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">delta_el</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nk</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_el</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
        <span class="n">noff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">delta_el</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">PowerSpectrum</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">noff</span> <span class="p">:</span> <span class="n">noff</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.bartlett">
<code class="highlight language-python"><span class="n">bartlett</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>A Bartlett window (triangle shape) of length n</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bartlett</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A Bartlett window (triangle shape) of length n"""</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">bartlett</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.computeSpectrum">
<code class="highlight language-python"><span class="n">computeSpectrum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">segfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Convenience function to compute the power spectrum of a single data array.</p>
<p>Args:
    <data>  Data for finding the spectrum
    <segfactor>   How many segments to break up the data into.  The spectrum
        will be found on each consecutive pair of segments and
        will be averaged over all pairs.
    <dt>      The sample spacing, in time.
    <window>  The window function to apply.  Should be a function that accepts
        a number of samples and returns an array of that length. Possible
        values are bartlett, welch, hann, and hamming in this module, or use
        a function of your choosing.</window></dt></segfactor></data></p>
<p>Returns:
    Either the PSD estimate as an array (non-negative frequencies only),
    <em>OR</em> the tuple (frequencies, PSD).  The latter returns when <dt> is not None.</dt></p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">computeSpectrum</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">segfactor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Convenience function to compute the power spectrum of a single data array.</span>

<span class="sd">    Args:</span>
<span class="sd">        &lt;data&gt;  Data for finding the spectrum</span>
<span class="sd">        &lt;segfactor&gt;   How many segments to break up the data into.  The spectrum</span>
<span class="sd">            will be found on each consecutive pair of segments and</span>
<span class="sd">            will be averaged over all pairs.</span>
<span class="sd">        &lt;dt&gt;      The sample spacing, in time.</span>
<span class="sd">        &lt;window&gt;  The window function to apply.  Should be a function that accepts</span>
<span class="sd">            a number of samples and returns an array of that length. Possible</span>
<span class="sd">            values are bartlett, welch, hann, and hamming in this module, or use</span>
<span class="sd">            a function of your choosing.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either the PSD estimate as an array (non-negative frequencies only),</span>
<span class="sd">        *OR* the tuple (frequencies, PSD).  The latter returns when &lt;dt&gt; is not None.</span>
<span class="sd">    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">segfactor</span><span class="p">)</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M</span>
    <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">window</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">==</span> <span class="n">window_length</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Window not understood"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">segfactor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">PowerSpectrum</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="c1"># Ensure that the datasegment has even length</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">PowerSpectrumOverlap</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">segfactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">addDataSegment</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">M</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">M</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">spec</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">frequencies</span><span class="p">(),</span> <span class="n">spec</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.demo">
<code class="highlight language-python"><span class="n">demo</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Plot a demonstration power spectrum with different segmentations.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>N</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>1024</code>
)
              –
              <div class="doc-md-description">
<p>Length of the white-noise random data vector, by default 1024</p>
</div>
</li>
<li>
<b><code>window</code></b>
                  (<code><span title="collections.abc.Callable">Callable</span> | <span title="numpy.typing.ArrayLike">ArrayLike</span> | None</code>, default:
                      <code><span title="numpy.hanning">hanning</span></code>
)
              –
              <div class="doc-md-description">
<p>Window function to apply, by default np.hanning</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">demo</span><span class="p">(</span><span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot a demonstration power spectrum with different segmentations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int, optional</span>
<span class="sd">        Length of the white-noise random data vector, by default 1024</span>
<span class="sd">    window : Callable | ArrayLike | None, optional</span>
<span class="sd">        Window function to apply, by default np.hanning</span>
<span class="sd">    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">computeSpectrum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">segfactor</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1e0</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.hamming">
<code class="highlight language-python"><span class="n">hamming</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>A Hamming window (0.08 + 0.92*sine-squared) of length n</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hamming</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A Hamming window (0.08 + 0.92*sine-squared) of length n"""</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.hann">
<code class="highlight language-python"><span class="n">hann</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>A Hann window (sine-squared) of length n</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hann</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A Hann window (sine-squared) of length n"""</span>
    <span class="c1"># twopi = np.pi*2</span>
    <span class="c1"># i = np.arange(n, dtype=float)</span>
    <span class="c1"># return  0.5*(1.0-np.cos(i*twopi/(n-1)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.power_spectrum.welch">
<code class="highlight language-python"><span class="n">welch</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>A Welch window (parabolic) of length n</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/power_spectrum.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">welch</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A Welch window (parabolic) of length n"""</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h3 id="robust-statistics">Robust statistics</h3>
<div class="doc doc-object doc-module">
<a id="mass2.mathstat.robust"></a>
<div class="doc doc-contents first">
<p>mass2.mathstat.robust</p>
<p>Functions from the field of robust statistics.</p>
<p>Location estimators:
bisquare_weighted_mean - Mean with weights given by the bisquare rho function.
huber_weighted_mean    - Mean with weights given by Huber's rho function.
trimean                - Tukey's trimean, the average of the median and the midhinge.
shorth_range           - Primarily a dispersion estimator, but location=True gives a (poor) location.</p>
<p>Dispersion estimators:
median_abs_dev - Median absolute deviation from the median.
shorth_range   - Length of the shortest closed interval containing at least half the data.
Qscale         - Normalized Rousseeuw &amp; Croux Q statistic, from the 25%ile of all 2-point distances.</p>
<p>Utility functions:
high_median    - Weighted median</p>
<p>Recommendations:
For location, suggest the bisquare_weighted_mean with k=3.9*sigma, if you can make any reasonable
guess as to the Gaussian-like width sigma.  If not, trimean is a good second choice, though less
efficient.</p>
<p>For dispersion, the Qscale is very efficient for nearly Gaussian data.  The median_abs_dev is
the most robust though less efficient.  If Qscale doesn't work, then short_range is a good
second choice.</p>
<p>Created on Feb 9, 2012
Rewritten with Numba Jan 23, 2025</p>
<p>@author: fowlerj</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.Qscale">
<code class="highlight language-python"><span class="n">Qscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sort_inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the robust estimator of scale Q of Rousseeuw and Croux using only O(n log n)
memory and computations.</p>
<p>A naive implementation is O(n^2) in both memory and computations.</p>
<p>Args:
    x: The data set, an unsorted sequence of values.
    sort_inplace: Whether it is okay for the function to reorder the set <x>.
        If True, <x> must be a np.ndarray (or ValueError is raised).</x></x></p>
<p>Q is defined as d_n * 2.2219 * {|xi-xj|; i&lt;j}_k, where</p>
<pre><code>{a}_k means the kth order-statistic of the set {a},
this set is that of the distances between all (n 2) possible pairs of data in {x}
n=# of observations in set {x},
k = (n choose 2)/4,
2.2219 makes Q consistent for sigma in normal distributions as n--&gt;infinity,
and d_n is a correction factor to the 2.2219 when n is not large.
</code></pre>
<p>This function does apply the correction factors to make Q consistent with sigma for a
Gaussian distribution.</p>
<p>Technique from C. Croux &amp; P. Rousseeuw in Comp. Stat Vol 1 (1992) ed. Dodge &amp; Whittaker,
Heidelberg: Physica-Verlag pages 411-428.  Available at
ftp://ftp.win.ua.ac.be/pub/preprints/92/Timeff92.pdf</p>
<p>The estimator is further studied in Rousseeuw &amp; Croux, J Am. Stat. Assoc 88 (1993), pp 1273-1283.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Qscale</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">sort_inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the robust estimator of scale Q of Rousseeuw and Croux using only O(n log n)</span>
<span class="sd">    memory and computations.</span>

<span class="sd">    A naive implementation is O(n^2) in both memory and computations.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: The data set, an unsorted sequence of values.</span>
<span class="sd">        sort_inplace: Whether it is okay for the function to reorder the set &lt;x&gt;.</span>
<span class="sd">            If True, &lt;x&gt; must be a np.ndarray (or ValueError is raised).</span>

<span class="sd">    Q is defined as d_n * 2.2219 * {|xi-xj|; i&lt;j}_k, where</span>

<span class="sd">        {a}_k means the kth order-statistic of the set {a},</span>
<span class="sd">        this set is that of the distances between all (n 2) possible pairs of data in {x}</span>
<span class="sd">        n=# of observations in set {x},</span>
<span class="sd">        k = (n choose 2)/4,</span>
<span class="sd">        2.2219 makes Q consistent for sigma in normal distributions as n--&gt;infinity,</span>
<span class="sd">        and d_n is a correction factor to the 2.2219 when n is not large.</span>

<span class="sd">    This function does apply the correction factors to make Q consistent with sigma for a</span>
<span class="sd">    Gaussian distribution.</span>

<span class="sd">    Technique from C. Croux &amp; P. Rousseeuw in Comp. Stat Vol 1 (1992) ed. Dodge &amp; Whittaker,</span>
<span class="sd">    Heidelberg: Physica-Verlag pages 411-428.  Available at</span>
<span class="sd">    ftp://ftp.win.ua.ac.be/pub/preprints/92/Timeff92.pdf</span>

<span class="sd">    The estimator is further studied in Rousseeuw &amp; Croux, J Am. Stat. Assoc 88 (1993), pp 1273-1283.</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_inplace</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"sort_inplace cannot be True unless the data set x is a np.ndarray."</span><span class="p">)</span>

    <span class="n">x</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Data set &lt;x&gt; must contain at least 2 values!"</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">target_k</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># -1 so that order count can start at 0 instead of conventional 1,2,3...</span>

    <span class="c1"># Compute the n-dependent prefactor to make Q consistent with sigma of a Gaussian.</span>
    <span class="n">prefactor</span> <span class="o">=</span> <span class="mf">2.2219</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">prefactor</span> <span class="o">*=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.399</span><span class="p">,</span> <span class="mf">0.994</span><span class="p">,</span> <span class="mf">0.512</span><span class="p">,</span> <span class="mf">0.844</span><span class="p">,</span> <span class="mf">0.611</span><span class="p">,</span> <span class="mf">0.857</span><span class="p">,</span> <span class="mf">0.669</span><span class="p">,</span> <span class="mf">0.872</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prefactor</span> <span class="o">*=</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1.4</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefactor</span> <span class="o">*=</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">3.8</span><span class="p">)</span>

    <span class="c1"># Now down to business finding the 25%ile of |xi - xj| for i&lt;j (or equivalently, for i != j)</span>
    <span class="c1"># Imagine the upper triangle of the matrix Aij = xj - xi (upper means j&gt;i).</span>
    <span class="c1"># If the set is sorted such that xi &lt;= x(i+1) for any i, then the upper triangle of Aij contains</span>
    <span class="c1"># exactly those distances from which we need the k=n/4 order statistic.</span>

    <span class="c1"># For small lists, too many boundary problems arise.  Just do it the slow way:</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dist</span><span class="p">[</span><span class="n">target_k</span><span class="p">]</span> <span class="o">*</span> <span class="n">prefactor</span>

    <span class="n">q</span><span class="p">,</span> <span class="n">npasses</span> <span class="o">=</span> <span class="n">_Qscale_subroutine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">target_k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">npasses</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Qscale tried </span><span class="si">{</span><span class="n">npasses</span><span class="si">}</span><span class="s2"> distances, which is too many"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="o">*</span> <span class="n">prefactor</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.bisquare_weighted_mean">
<code class="highlight language-python"><span class="n">bisquare_weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>The bisquare weighted mean of the data <x> with a k-value of <k>.</k></x></p>
<p>Args:
    x (array): data values to be summarized
    k (number): give zero weight to values at least distance k from the weighted
        mean.
    center (number): an initial guess at the weighted mean.
        If None, then the data median will be used (default None).
    tol (number): tolerance on the estimator (see below; default None)</p>
<p>A sensible choice of <k> is 3 to 5 times the rms width or 1.3 to 2 times the
full width at half max of a peak.  For strictly Gaussian data, the choices of
k= 3.14, 3.88, and 4.68 times sigma will be 80%, 90%, and 95% efficient.</k></p>
<p>The answer is found iteratively, revised until it changes by less than <tol>.  If
<tol> is None (the default), then <tol> will use 1e-5 times the median absolute
deviation of <x> about its median.</x></tol></tol></tol></p>
<p>Data values a distance of more than <k> from the weighted mean are given no weight.</k></p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bisquare_weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The bisquare weighted mean of the data &lt;x&gt; with a k-value of &lt;k&gt;.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array): data values to be summarized</span>
<span class="sd">        k (number): give zero weight to values at least distance k from the weighted</span>
<span class="sd">            mean.</span>
<span class="sd">        center (number): an initial guess at the weighted mean.</span>
<span class="sd">            If None, then the data median will be used (default None).</span>
<span class="sd">        tol (number): tolerance on the estimator (see below; default None)</span>

<span class="sd">    A sensible choice of &lt;k&gt; is 3 to 5 times the rms width or 1.3 to 2 times the</span>
<span class="sd">    full width at half max of a peak.  For strictly Gaussian data, the choices of</span>
<span class="sd">    k= 3.14, 3.88, and 4.68 times sigma will be 80%, 90%, and 95% efficient.</span>

<span class="sd">    The answer is found iteratively, revised until it changes by less than &lt;tol&gt;.  If</span>
<span class="sd">    &lt;tol&gt; is None (the default), then &lt;tol&gt; will use 1e-5 times the median absolute</span>
<span class="sd">    deviation of &lt;x&gt; about its median.</span>

<span class="sd">    Data values a distance of more than &lt;k&gt; from the weighted mean are given no weight.</span>
<span class="sd">    """</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">median_abs_dev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">newcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">newcenter</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">newcenter</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">"bisquare_weighted_mean used too many iterations.</span><span class="se">\n</span><span class="s2">"</span>
        <span class="o">+</span> <span class="s2">"Consider using higher &lt;tol&gt; or better &lt;center&gt;, or change to trimean(x)."</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.high_median">
<code class="highlight language-python"><span class="n">high_median</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the weighted high median of data set x with weights <weights>.</weights></p>
<p>Returns:
    The smallest x[j] such that the sum of all weights for data
    with x[i] &lt;= x[j] is strictly greater than half the total weight.</p>
<p>If return_index is True, then the chosen index is returned also as (highmed, index).</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">high_median</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute the weighted high median of data set x with weights &lt;weights&gt;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The smallest x[j] such that the sum of all weights for data</span>
<span class="sd">        with x[i] &lt;= x[j] is strictly greater than half the total weight.</span>

<span class="sd">    If return_index is True, then the chosen index is returned also as (highmed, index).</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>  <span class="c1"># now x[sort_idx] is sorted</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">_high_median</span><span class="p">(</span><span class="n">sort_idx</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">ri</span><span class="p">],</span> <span class="n">ri</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">ri</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.huber_weighted_mean">
<code class="highlight language-python"><span class="n">huber_weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Huber's weighted mean of the data <x> with a k-value of <k>.</k></x></p>
<p>Args:
    x (array): data values to be summarized
    k (number): give zero weight to values at least distance k from the weighted
        mean.
    center (number): an initial guess at the weighted mean.
        If None, then the data median will be used (default None).
    tol (number): tolerance on the estimator (see below; default None)</p>
<p>A sensible choice of <k> is 1 to 1.5 times the rms width or 0.4 to 0.6 times the
full width at half max of a peak.  For strictly Gaussian data, the choices of
k=1.0 and 1.4 sigma give ...</k></p>
<p>The answer is found iteratively, revised until it changes by less than <tol>.  If
<tol> is None (the default), then <tol> will use 1e-5 times the median absolute
deviation of <x> about its median.</x></tol></tol></tol></p>
<p>Data values a distance of more than <k> from the weighted mean are given no weight.</k></p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">huber_weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Huber's weighted mean of the data &lt;x&gt; with a k-value of &lt;k&gt;.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array): data values to be summarized</span>
<span class="sd">        k (number): give zero weight to values at least distance k from the weighted</span>
<span class="sd">            mean.</span>
<span class="sd">        center (number): an initial guess at the weighted mean.</span>
<span class="sd">            If None, then the data median will be used (default None).</span>
<span class="sd">        tol (number): tolerance on the estimator (see below; default None)</span>

<span class="sd">    A sensible choice of &lt;k&gt; is 1 to 1.5 times the rms width or 0.4 to 0.6 times the</span>
<span class="sd">    full width at half max of a peak.  For strictly Gaussian data, the choices of</span>
<span class="sd">    k=1.0 and 1.4 sigma give ...</span>

<span class="sd">    The answer is found iteratively, revised until it changes by less than &lt;tol&gt;.  If</span>
<span class="sd">    &lt;tol&gt; is None (the default), then &lt;tol&gt; will use 1e-5 times the median absolute</span>
<span class="sd">    deviation of &lt;x&gt; about its median.</span>

<span class="sd">    Data values a distance of more than &lt;k&gt; from the weighted mean are given no weight.</span>
<span class="sd">    """</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">median_abs_dev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">))</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">weights</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">newcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">newcenter</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">newcenter</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">"huber_weighted_mean used too many iterations.</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"Consider using higher &lt;tol&gt; or better &lt;center&gt;, or change to trimean(x)."</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.median_abs_dev">
<code class="highlight language-python"><span class="n">median_abs_dev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Median absolute deviation (from the median) of data vector.</p>
<p>Args:
    x (array): data to be summarized.
    normalize (bool): if True, then return MAD/0.675, which scaling makes
        the statistic consistent with the standard deviation for an asymptotically large
        sample of Gaussian deviates (default False).</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">median_abs_dev</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Median absolute deviation (from the median) of data vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array): data to be summarized.</span>
<span class="sd">        normalize (bool): if True, then return MAD/0.675, which scaling makes</span>
<span class="sd">            the statistic consistent with the standard deviation for an asymptotically large</span>
<span class="sd">            sample of Gaussian deviates (default False).</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mad</span> <span class="o">/</span> <span class="mf">0.674480</span>  <span class="c1"># Half of the normal distribution has abs(x-mu) &lt; 0.674480*sigma</span>
    <span class="k">return</span> <span class="n">mad</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.shorth_range">
<code class="highlight language-python"><span class="n">shorth_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Returns the Shortest Half (shorth) Range, a robust estimator of dispersion.</p>
<p>The Shortest Half of a data set {x} means that closed interval [a,b] where (1) a and b are both
elements of the data set, (2) at least half of the elements are in the closed interval, and (3)
which minimizes the length of the closed interval (b-a).  The shorth range is (b-a). See
mass2.mathstat.robust.shorth_information for further explanation and references in the
literature.</p>
<p>Args:
    x (array): The data set under study.  Must be a sequence of values.
    normalize (bool): If False (default), then return the actual range b-a.  If True, then the
        range will be divided by 1.348960, which normalizes the range to be a consistent estimator
        of the parameter sigma in the case of an exact Gaussian distribution.  (A small correction
        of order 1/N is applied, too, which mostly corrects for bias at modest values of the sample
        size N.)
    sort_inplace - Permit this function to reorder the data set <x>.  If False (default), then x will be
        copied and the copy will be sorted.  (Note that if <x> is not a np.ndarray, an error
        will be raised if <sort_inplace> is True.)
    location     - Whether to return two location estimators in addition to the dispersion estimator.
        (default False).</sort_inplace></x></x></p>
<p>Returns:
    shorth range   if <location> evaluates to False; otherwise returns:
    (shorth range, shorth mean, shorth center)</location></p>
<p>In this, shorth mean is the mean of all samples in the closed range [a,b], and
shorth center = (a+b)/2.  Beware that both of these location estimators have the
undesirable property that their asymptotic standard deviation improves only as
N^(-1/3) rather than the more usual N^(-1/2).  So it is not a very good idea to
use them as location estimators.  They are really only included here for testing
just how useless they are.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">shorth_range</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sort_inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Returns the Shortest Half (shorth) Range, a robust estimator of dispersion.</span>

<span class="sd">    The Shortest Half of a data set {x} means that closed interval [a,b] where (1) a and b are both</span>
<span class="sd">    elements of the data set, (2) at least half of the elements are in the closed interval, and (3)</span>
<span class="sd">    which minimizes the length of the closed interval (b-a).  The shorth range is (b-a). See</span>
<span class="sd">    mass2.mathstat.robust.shorth_information for further explanation and references in the</span>
<span class="sd">    literature.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array): The data set under study.  Must be a sequence of values.</span>
<span class="sd">        normalize (bool): If False (default), then return the actual range b-a.  If True, then the</span>
<span class="sd">            range will be divided by 1.348960, which normalizes the range to be a consistent estimator</span>
<span class="sd">            of the parameter sigma in the case of an exact Gaussian distribution.  (A small correction</span>
<span class="sd">            of order 1/N is applied, too, which mostly corrects for bias at modest values of the sample</span>
<span class="sd">            size N.)</span>
<span class="sd">        sort_inplace - Permit this function to reorder the data set &lt;x&gt;.  If False (default), then x will be</span>
<span class="sd">            copied and the copy will be sorted.  (Note that if &lt;x&gt; is not a np.ndarray, an error</span>
<span class="sd">            will be raised if &lt;sort_inplace&gt; is True.)</span>
<span class="sd">        location     - Whether to return two location estimators in addition to the dispersion estimator.</span>
<span class="sd">            (default False).</span>

<span class="sd">    Returns:</span>
<span class="sd">        shorth range   if &lt;location&gt; evaluates to False; otherwise returns:</span>
<span class="sd">        (shorth range, shorth mean, shorth center)</span>

<span class="sd">    In this, shorth mean is the mean of all samples in the closed range [a,b], and</span>
<span class="sd">    shorth center = (a+b)/2.  Beware that both of these location estimators have the</span>
<span class="sd">    undesirable property that their asymptotic standard deviation improves only as</span>
<span class="sd">    N^(-1/3) rather than the more usual N^(-1/2).  So it is not a very good idea to</span>
<span class="sd">    use them as location estimators.  They are really only included here for testing</span>
<span class="sd">    just how useless they are.</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_inplace</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"sort_inplace cannot be True unless the data set x is a np.ndarray."</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Number of data values</span>
    <span class="n">nhalves</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Number of minimal intervals containing at least half the data</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Number of data values in each minimal interval</span>

    <span class="n">range_each_half</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">nhalves</span> <span class="p">:</span> <span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nhalves</span><span class="p">]</span>
    <span class="n">idxa</span> <span class="o">=</span> <span class="n">range_each_half</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idxa</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">idxa</span> <span class="o">+</span> <span class="n">nobs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">shorth_range</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">shorth_range</span> <span class="o">/=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.674480</span>
        <span class="c1"># Asymptotic expectation for normal data: sigma*2*0.674480</span>
        <span class="c1"># The value 2*0.674480 is twice the inverse cumulative normal distribution at 0.75. That is,</span>
        <span class="c1"># the middle 50% of a normal distribution are within ±0.674480*sigma of the mean.</span>

        <span class="c1"># The small-n corrections depend on n mod 4.  See Rousseeuw &amp; Lerow 1988.</span>
        <span class="c1"># These are not at all clear from the text of the paper (see table on p. 115</span>
        <span class="c1"># if you want to try to decode them).</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shorth_range</span> <span class="o">*=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shorth_range</span> <span class="o">*=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">shorth_range</span> <span class="o">*=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shorth_range</span> <span class="o">*=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shorth_range</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">idxa</span> <span class="p">:</span> <span class="n">idxa</span> <span class="o">+</span> <span class="n">nobs</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shorth_range</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.mathstat.robust.trimean">
<code class="highlight language-python"><span class="n">trimean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return Tukey's trimean for a data set <x>, a measure of its central tendency
("location" or "center").</x></p>
<p>If (q1,q2,q3) are the quartiles (i.e., the 25%ile, median, and 75 %ile),
the trimean is (q1+q3)/4 + q2/2.</p>
<details class="quote">
<summary>Source code in <code>mass2/mathstat/robust.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trimean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return Tukey's trimean for a data set &lt;x&gt;, a measure of its central tendency</span>
<span class="sd">    ("location" or "center").</span>

<span class="sd">    If (q1,q2,q3) are the quartiles (i.e., the 25%ile, median, and 75 %ile),</span>
<span class="sd">    the trimean is (q1+q3)/4 + q2/2.</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">per</span><span class="p">)</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">)]</span>
    <span class="n">trimean</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">q1</span> <span class="o">+</span> <span class="n">q3</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">q2</span>
    <span class="k">return</span> <span class="n">trimean</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../docstrings/" class="btn btn-neutral float-left" title="Core docstrings"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../tests/" class="btn btn-neutral float-right" title="Testing">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../docstrings/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../tests/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
