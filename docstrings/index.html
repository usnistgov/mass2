<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://usnistgov.github.io/mass2/docstrings/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Core docstrings - Mass2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Core docstrings";
        var mkdocs_page_input_path = "docstrings.md";
        var mkdocs_page_url = "/mass2/docstrings/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Mass2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting_started/">Getting started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../demo_plot/">Demo plot</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../filtering/">Optimal filtering</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Fluorescence lines</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../fluorescence/">Atomic fluorescence</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../line_fitting/">Line fitting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hci_lines_from_asd/">Highly-charge ion lines</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../xray_efficiency_models/">X-ray efficiency models</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Digging deeper</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../LJHfiles/">LJH file format</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Core docstrings</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#core">Core</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core">core</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channel">channel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channel.BadChannel">BadChannel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channel.Channel">Channel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.last_avg_pulse">last_avg_pulse</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.last_filter">last_filter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.last_noise_autocorrelation">last_noise_autocorrelation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.last_noise_psd">last_noise_psd</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.shortname">shortname</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.__eq__">__eq__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.__hash__">__hash__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.as_bad">as_bad</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.bad_df">bad_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.compute_ats_model">compute_ats_model</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.compute_average_pulse">compute_average_pulse</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.concat_ch">concat_ch</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.concat_df">concat_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.correct_pretrig_mean_jumps">correct_pretrig_mean_jumps</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.driftcorrect">driftcorrect</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.filter5lag">filter5lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.filterATS">filterATS</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.fit_pulse">fit_pulse</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.from_ljh">from_ljh</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.from_off">from_off</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.get_step">get_step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.good_df">good_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.good_series">good_series</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.good_serieses">good_serieses</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.hist">hist</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.linefit">linefit</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.mo_stepplots">mo_stepplots</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.multifit_mass_cal">multifit_mass_cal</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.multifit_quadratic_gain_cal">multifit_quadratic_gain_cal</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.phase_correct_mass_specific_lines">phase_correct_mass_specific_lines</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.plot_hist">plot_hist</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.plot_hists">plot_hists</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.plot_scatter">plot_scatter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.plot_summaries">plot_summaries</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.rough_cal">rough_cal</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.rough_cal_combinatoric">rough_cal_combinatoric</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.rough_cal_combinatoric_height_info">rough_cal_combinatoric_height_info</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.save_recipes">save_recipes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.step_plot">step_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.step_summary">step_summary</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.summarize_pulses">summarize_pulses</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.typical_peak_ind">typical_peak_ind</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_categorize_step">with_categorize_step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_column_map_step">with_column_map_step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_columns">with_columns</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_experiment_state_df">with_experiment_state_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_external_trigger_df">with_external_trigger_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_good_expr">with_good_expr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_good_expr_below_nsigma_outlier_resistant">with_good_expr_below_nsigma_outlier_resistant</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_good_expr_nsigma_range_outlier_resistant">with_good_expr_nsigma_range_outlier_resistant</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_good_expr_pretrig_rms_and_postpeak_deriv">with_good_expr_pretrig_rms_and_postpeak_deriv</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_range_around_median">with_range_around_median</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_replacement_df">with_replacement_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_select_step">with_select_step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_step">with_step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_steps">with_steps</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channel.ChannelHeader">ChannelHeader</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.ChannelHeader.from_ljh_header_df">from_ljh_header_df</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channels">channels</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channels.Channels">Channels</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.ch0">ch0</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.__eq__">__eq__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.__hash__">__hash__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.concat_data">concat_data</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.dfg">dfg</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.from_df">from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.from_ljh_folder">from_ljh_folder</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.from_ljh_path_pairs">from_ljh_path_pairs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.from_off_paths">from_off_paths</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.get_an_ljh_path">get_an_ljh_path</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.get_experiment_state_df">get_experiment_state_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.get_path_in_output_folder">get_path_in_output_folder</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.linefit">linefit</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.linefit_joblib">linefit_joblib</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.load_analysis">load_analysis</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.load_recipes">load_recipes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.map">map</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.parent_folder_path">parent_folder_path</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_avg_pulses">plot_avg_pulses</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_filters">plot_filters</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_hist">plot_hist</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_hists">plot_hists</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_noise_autocorr">plot_noise_autocorr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_noise_spectrum">plot_noise_spectrum</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.save_analysis">save_analysis</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.save_recipes">save_recipes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.set_bad">set_bad</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.with_experiment_state_by_path">with_experiment_state_by_path</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.with_experiment_state_df">with_experiment_state_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.with_external_trigger_by_path">with_external_trigger_by_path</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.with_external_trigger_df">with_external_trigger_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.with_more_channels">with_more_channels</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.with_steps_dict">with_steps_dict</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms">analysis_algorithms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.HistogramSmoother">HistogramSmoother</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.analysis_algorithms.HistogramSmoother.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.analysis_algorithms.HistogramSmoother.__init__">__init__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.compute_max_deriv">compute_max_deriv</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.correct_flux_jumps">correct_flux_jumps</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.correct_flux_jumps_original">correct_flux_jumps_original</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.drift_correct">drift_correct</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.estimateRiseTime">estimateRiseTime</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.filter_signal_lowpass">filter_signal_lowpass</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.make_smooth_histogram">make_smooth_histogram</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.nearest_arrivals">nearest_arrivals</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.time_drift_correct">time_drift_correct</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.unwrap_n">unwrap_n</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.drift_correction">drift_correction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.drift_correction.DriftCorrectStep">DriftCorrectStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.drift_correction.DriftCorrectStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.drift_correction.DriftCorrectStep.dbg_plot">dbg_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.drift_correction.DriftCorrectStep.learn">learn</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.drift_correction.DriftCorrection">DriftCorrection</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.drift_correction.DriftCorrection.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.drift_correction.drift_correct_mass">drift_correct_mass</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.drift_correction.drift_correct_wip">drift_correct_wip</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.filter_steps">filter_steps</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.filter_steps.OptimalFilterStep">OptimalFilterStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.filter_steps.OptimalFilterStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.filter_steps.OptimalFilterStep.dbg_plot">dbg_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.filter_steps.OptimalFilterStep.drop_debug">drop_debug</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhfiles">ljhfiles</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile">LJHFile</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.datatimes_float">datatimes_float</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.datatimes_raw">datatimes_raw</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.is_continuous">is_continuous</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.pulse_size_bytes">pulse_size_bytes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.subframecount">subframecount</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.open">open</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.read_header">read_header</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.read_trace">read_trace</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.read_trace_with_timing">read_trace_with_timing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.reopen_binary">reopen_binary</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.to_polars">to_polars</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile.write_truncated_ljh">write_truncated_ljh</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_0">LJHFile_2_0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_0.datatimes_raw">datatimes_raw</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_0.to_polars">to_polars</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_1">LJHFile_2_1</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_1.datatimes_raw">datatimes_raw</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_1.to_polars">to_polars</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_2">LJHFile_2_2</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_2.datatimes_raw">datatimes_raw</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_2.is_continuous">is_continuous</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.ljhfiles.LJHFile_2_2.subframecount">subframecount</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil">ljhutil</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.experiment_state_path_from_ljh_path">experiment_state_path_from_ljh_path</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.external_trigger_bin_path_from_ljh_path">external_trigger_bin_path_from_ljh_path</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.extract_channel_number">extract_channel_number</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.filename_glob_expand">filename_glob_expand</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.find_folders_with_extension">find_folders_with_extension</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.find_ljh_files">find_ljh_files</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.helper_write_pulse">helper_write_pulse</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.ljh_append_traces">ljh_append_traces</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.ljh_merge">ljh_merge</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.ljh_sort_filenames_numerically">ljh_sort_filenames_numerically</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.ljh_truncate">ljh_truncate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.main_ljh_merge">main_ljh_merge</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.main_ljh_truncate">main_ljh_truncate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.ljhutil.match_files_by_channel">match_files_by_channel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc">misc</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.alwaysTrue">alwaysTrue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.concat_dfs_with_concat_state">concat_dfs_with_concat_state</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.extract_column_names_from_polars_expr">extract_column_names_from_polars_expr</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.good_series">good_series</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.hist_of_series">hist_of_series</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.launch_examples">launch_examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.median_absolute_deviation">median_absolute_deviation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.merge_dicts_ordered_by_keys">merge_dicts_ordered_by_keys</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.midpoints_and_step_size">midpoints_and_step_size</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.outlier_resistant_nsigma_above_mid">outlier_resistant_nsigma_above_mid</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.outlier_resistant_nsigma_range_from_mid">outlier_resistant_nsigma_range_from_mid</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.pickle_object">pickle_object</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.plot_a_vs_b_series">plot_a_vs_b_series</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.plot_hist_of_series">plot_hist_of_series</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.root_mean_squared">root_mean_squared</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.show">show</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.sigma_mad">sigma_mad</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.smallest_positive_real">smallest_positive_real</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.misc.unpickle_object">unpickle_object</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.multifit">multifit</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.multifit.FitSpec">FitSpec</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.FitSpec.fit_ch">fit_ch</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.FitSpec.fit_df">fit_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.FitSpec.fit_series_without_use_expr">fit_series_without_use_expr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.FitSpec.params">params</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.multifit.MultiFit">MultiFit</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.fit_ch">fit_ch</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.fit_df">fit_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.fit_series_without_use_expr">fit_series_without_use_expr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.plot_results">plot_results</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.plot_results_and_pfit">plot_results_and_pfit</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.results_params_as_df">results_params_as_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.to_mass_cal">to_mass_cal</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.to_pfit_gain">to_pfit_gain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.with_fitspec">with_fitspec</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.with_line">with_line</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFit.with_results">with_results</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep">MultiFitMassCalibrationStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep.dbg_plot">dbg_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep.drop_debug">drop_debug</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep.energy2ph">energy2ph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep.learn">learn</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitMassCalibrationStep.ph2energy">ph2energy</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep">MultiFitQuadraticGainStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep.dbg_plot">dbg_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep.drop_debug">drop_debug</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep.energy2ph">energy2ph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep.learn">learn</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.multifit.MultiFitQuadraticGainStep.ph2energy">ph2energy</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.multifit.handle_none">handle_none</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms">noise_algorithms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms.NoiseResult">NoiseResult</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_algorithms.NoiseResult.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_algorithms.NoiseResult.plot_log_rebinned">plot_log_rebinned</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms.calc_autocorrelation_times">calc_autocorrelation_times</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms.calc_continuous_autocorrelation">calc_continuous_autocorrelation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms.calc_discontinuous_autocorrelation">calc_discontinuous_autocorrelation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms.calc_noise_result">calc_noise_result</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_algorithms.noise_psd_periodogram">noise_psd_periodogram</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_channel">noise_channel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel">NoiseChannel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.is_continuous">is_continuous</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.__eq__">__eq__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.__hash__">__hash__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.calc_max_excursion">calc_max_excursion</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.from_ljh">from_ljh</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.get_records_2d">get_records_2d</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.noise_channel.NoiseChannel.spectrum">spectrum</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.offfiles">offfiles</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.offfiles.OffFile">OffFile</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.__getitem__">__getitem__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.__len__">__len__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.__sizeof__">__sizeof__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.close">close</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.modeledPulse">modeledPulse</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.recordXY">recordXY</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.sampleTimes">sampleTimes</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.validateHeader">validateHeader</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.offfiles.OffFile.view">view</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.offfiles.readJsonString">readJsonString</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.offfiles.recordDtype">recordDtype</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering">optimal_filtering</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter">Filter</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.filter_records">filter_records</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.report">report</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter1Lag">Filter1Lag</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter1Lag.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter1Lag.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter1Lag.filter_records">filter_records</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag">Filter5Lag</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag.filter_records">filter_records</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS">FilterATS</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS.filter_records">filter_records</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker">FilterMaker</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_1lag">compute_1lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_5lag">compute_5lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_5lag_noexp">compute_5lag_noexp</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_ats">compute_ats</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_constrained_1lag">compute_constrained_1lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_constrained_5lag">compute_constrained_5lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_fourier">compute_fourier</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener">ToeplitzWhitener</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.p">p</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.q">q</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.W">W</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.applyWT">applyWT</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.solveW">solveW</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.solveWT">solveWT</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.whiten">whiten</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.band_limit">band_limit</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.bracketR">bracketR</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.phase_correct">phase_correct</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.phase_correct.PhaseCorrector">PhaseCorrector</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct.PhaseCorrector.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct.PhaseCorrector.__repr__">__repr__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct.PhaseCorrector.correct">correct</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct.PhaseCorrector.fromHDF5">fromHDF5</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct.PhaseCorrector.toHDF5">toHDF5</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.phase_correct.phase_correct">phase_correct</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.phase_correct_steps">phase_correct_steps</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.phase_correct_steps.PhaseCorrectMassStep">PhaseCorrectMassStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct_steps.PhaseCorrectMassStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.phase_correct_steps.PhaseCorrectMassStep.dbg_plot">dbg_plot</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.phase_correct_steps.phase_correct_mass_specific_lines">phase_correct_mass_specific_lines</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.pulse_algorithms">pulse_algorithms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.pulse_algorithms.fit_pulse_2exp_with_tail">fit_pulse_2exp_with_tail</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.pulse_algorithms.pulse_2exp_with_tail">pulse_2exp_with_tail</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.pulse_algorithms.summarize_data_numba">summarize_data_numba</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.pulse_model">pulse_model</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.pulse_model.PulseModel">PulseModel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.pulse_model.PulseModel.fromHDF5">fromHDF5</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.pulse_model.PulseModel.labels">labels</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.pulse_model.PulseModel.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.pulse_model.PulseModel.toHDF5">toHDF5</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe">recipe</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.CategorizeStep">CategorizeStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.CategorizeStep.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.CategorizeStep.calc_from_df">calc_from_df</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.ColumnAsNumpyMapStep">ColumnAsNumpyMapStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.ColumnAsNumpyMapStep.__post_init__">__post_init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.ColumnAsNumpyMapStep.calc_from_df">calc_from_df</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.PretrigMeanJumpFixStep">PretrigMeanJumpFixStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.PretrigMeanJumpFixStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.PretrigMeanJumpFixStep.dbg_plot">dbg_plot</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.Recipe">Recipe</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.__getitem__">__getitem__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.__len__">__len__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.new_empty">new_empty</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.trim_dead_ends">trim_dead_ends</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.trim_debug_info">trim_debug_info</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.with_step">with_step</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.RecipeStep">RecipeStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.RecipeStep.description">description</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.RecipeStep.name">name</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.RecipeStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.RecipeStep.dbg_plot">dbg_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.RecipeStep.drop_debug">drop_debug</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.SelectStep">SelectStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.SelectStep.calc_from_df">calc_from_df</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.SummarizeStep">SummarizeStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.SummarizeStep.calc_from_df">calc_from_df</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal">rough_cal</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult">BestAssignmentPfitGainResult</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult.energy2ph">energy2ph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult.ph2energy">ph2energy</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult.ph_unassigned">ph_unassigned</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult.phzerogain">phzerogain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.BestAssignmentPfitGainResult.predicted_energies">predicted_energies</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep">RoughCalibrationStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.dbg_plot">dbg_plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.dbg_plot_failure">dbg_plot_failure</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.dbg_plot_success">dbg_plot_success</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.drop_debug">drop_debug</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.energy2ph">energy2ph</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.learn_3peak">learn_3peak</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.learn_combinatoric">learn_combinatoric</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.RoughCalibrationStep.learn_combinatoric_height_info">learn_combinatoric_height_info</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult">SmoothedLocalMaximaResult</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.inds_sorted_by_peak_height">inds_sorted_by_peak_height</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.inds_sorted_by_prominence">inds_sorted_by_prominence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.peak_height">peak_height</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.ph_sorted_by_peak_height">ph_sorted_by_peak_height</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.ph_sorted_by_prominence">ph_sorted_by_prominence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.rough_cal.SmoothedLocalMaximaResult.prominence">prominence</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.drift_correct_entropy">drift_correct_entropy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.eval_3peak_assignment_pfit_gain">eval_3peak_assignment_pfit_gain</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_best_residual_among_all_possible_assignments">find_best_residual_among_all_possible_assignments</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_best_residual_among_all_possible_assignments2">find_best_residual_among_all_possible_assignments2</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_local_maxima">find_local_maxima</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_optimal_assignment">find_optimal_assignment</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_optimal_assignment2">find_optimal_assignment2</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_optimal_assignment2_height_info">find_optimal_assignment2_height_info</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_optimal_assignment_height_info">find_optimal_assignment_height_info</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.find_pfit_gain_residual">find_pfit_gain_residual</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.hist_smoothed">hist_smoothed</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.local_maxima">local_maxima</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.minimize_entropy_linear">minimize_entropy_linear</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.peakfind_local_maxima_of_smoothed_hist">peakfind_local_maxima_of_smoothed_hist</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.rank_3peak_assignments">rank_3peak_assignments</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.rank_assignments">rank_assignments</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.smooth_hist_with_gauassian_by_fft">smooth_hist_with_gauassian_by_fft</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.rough_cal.smooth_hist_with_gauassian_by_fft_compute_kernel">smooth_hist_with_gauassian_by_fft_compute_kernel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin">truebq_bin</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.TriggerResult">TriggerResult</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.truebq_bin.TriggerResult.get_noise">get_noise</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.truebq_bin.TriggerResult.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.truebq_bin.TriggerResult.to_channel_copy_to_memory">to_channel_copy_to_memory</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.truebq_bin.TriggerResult.to_channel_mmap">to_channel_mmap</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.TrueBqBin">TrueBqBin</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.truebq_bin.TrueBqBin.load">load</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.truebq_bin.TrueBqBin.trigger">trigger</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.fast_apply_filter">fast_apply_filter</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.fasttrig_filter_trigger">fasttrig_filter_trigger</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.filter_and_residual_rms">filter_and_residual_rms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.gather_pulses_from_inds_numpy_contiguous">gather_pulses_from_inds_numpy_contiguous</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.gather_pulses_from_inds_numpy_contiguous_mmap">gather_pulses_from_inds_numpy_contiguous_mmap</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.gather_pulses_from_inds_numpy_contiguous_mmap_with_cache">gather_pulses_from_inds_numpy_contiguous_mmap_with_cache</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.get_noise_trigger_inds">get_noise_trigger_inds</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.truebq_bin.write_truebq_bin_file">write_truebq_bin_file</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.utilities">utilities</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.utilities.InlineUpdater">InlineUpdater</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.utilities.InlineUpdater.elapsedTimeSec">elapsedTimeSec</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.utilities.InlineUpdater.elapsedTimeStr">elapsedTimeStr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.utilities.InlineUpdater.timeRemaining">timeRemaining</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.utilities.InlineUpdater.timeRemainingStr">timeRemainingStr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.utilities.InlineUpdater.update">update</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.utilities.NullUpdater">NullUpdater</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.utilities.NullUpdater.update">update</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.utilities.show_progress">show_progress</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#other-docstrings">Other docstrings</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docstrings2/">Other docstrings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">Testing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mass2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Digging deeper</li>
      <li class="breadcrumb-item active">Core docstrings</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="automatic-documentation-generated-from-docstrings">Automatic documentation generated from docstrings</h1>
<p>This page is auto-generated from the docstrings of functions, methods, classes, and modules. Each lowest-level module in Mass2 (i.e., each python file) in <code>mass2.core</code> that you want documented and indexed for searching should be listed in this <code>docstrings.md</code> file. The <a href="../docstrings2/">non-core docstrings</a> contain the docstrings for all modules other than <code>mass2.core</code>.</p>
<h2 id="core">Core</h2>
<div class="doc doc-object doc-module">
<a id="mass2.core"></a>
<div class="doc doc-contents first">
<p>mass2.core: Core Mass2 functionality, including file I/O,
microcalorimeter channel bookkeeping, recipes, fitting, filtering, and more.</p>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.channel"></a>
<div class="doc doc-contents first">
<p>Data structures and methods for handling a single microcalorimeter channel's pulse data and metadata.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.channel.BadChannel">
<code>BadChannel</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A wrapper around Channel that includes error information.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BadChannel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A wrapper around Channel that includes error information."""</span>

    <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span>
    <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.channel.Channel">
<code>Channel</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A single microcalorimeter channel's pulse data and associated metadata.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PLR0904</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Channel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A single microcalorimeter channel's pulse data and associated metadata."""</span>

    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">ChannelHeader</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">npulses</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">subframediv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">noise</span><span class="p">:</span> <span class="n">NoiseChannel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">)</span>
    <span class="n">df_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">steps</span><span class="p">:</span> <span class="n">Recipe</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Recipe</span><span class="o">.</span><span class="n">new_empty</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">steps_elapsed_s</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shortname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A short name for this channel, suitable for plot titles."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mo_stepplots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Marimo UI element to choose and display step plots, with a dropdown to choose channel number."""</span>
        <span class="n">desc_ind</span> <span class="o">=</span> <span class="p">{</span><span class="n">step</span><span class="o">.</span><span class="n">description</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)}</span>
        <span class="n">first_non_summarize_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">SummarizeStep</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">first_non_summarize_step</span> <span class="o">=</span> <span class="n">step</span>
            <span class="k">break</span>
        <span class="n">mo_ui</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">(</span>
            <span class="n">desc_ind</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">first_non_summarize_step</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"choose step for ch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">Html</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Show the selected step plot."""</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mo_stepplots_explicit</span><span class="p">(</span><span class="n">mo_ui</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">step_ind</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Get the selected step index from the dropdown item, if any."""</span>
            <span class="k">return</span> <span class="n">mo_ui</span><span class="o">.</span><span class="n">value</span>

        <span class="n">mo_ui</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span>
        <span class="n">mo_ui</span><span class="o">.</span><span class="n">step_ind</span> <span class="o">=</span> <span class="n">step_ind</span>
        <span class="k">return</span> <span class="n">mo_ui</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mo_stepplots_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_ui</span><span class="p">:</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">Html</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Marimo UI element to choose and display step plots."""</span>
        <span class="n">step_ind</span> <span class="o">=</span> <span class="n">mo_ui</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_plot</span><span class="p">(</span><span class="n">step_ind</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mo</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">mo_ui</span><span class="p">,</span> <span class="n">misc</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get the step at the given index, supporting negative indices."""</span>
        <span class="c1"># normalize the index to a positive index</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">step</span><span class="p">,</span> <span class="n">index</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a debug plot for the given step index, supporting negative indices."""</span>
        <span class="n">step</span><span class="p">,</span> <span class="n">step_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step</span><span class="p">(</span><span class="n">step_ind</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step_ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_history</span><span class="p">):</span>
            <span class="n">df_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_history</span><span class="p">[</span><span class="n">step_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Compute a histogram of the given column, optionally filtering by good_expr and use_expr."""</span>
        <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
            <span class="c1"># so we special case True</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

        <span class="c1"># Group by the specified column and filter using good_expr</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Compute and plot a histogram of the given column, optionally filtering by good_expr and use_expr."""</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="n">use_good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">)</span>

        <span class="c1"># Customize the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - col (str): The column name to plot.</span>
<span class="sd">        - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">        - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">        - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
            <span class="c1"># so we special case True</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

        <span class="c1"># Group by the specified column and filter using good_expr</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot a histogram for each group</span>
        <span class="n">counts_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Get the data for the column to plot</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
            <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
            <span class="n">group_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
            <span class="n">counts_dict</span><span class="p">[</span><span class="n">group_name_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group_name_str</span><span class="p">)</span>
            <span class="c1"># Plot the histogram for the current group</span>
            <span class="c1"># if group_name == "EBIT":</span>
            <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.9, color="k", label=group_name_str)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.5, label=group_name_str)</span>
            <span class="c1"># bin_centers, counts = misc.hist_of_series(values, bin_edges)</span>
            <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>
        <span class="c1"># Customize the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Add a legend to label the groups</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_scatter</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">y_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">color_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">max_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate a scatter plot of `y_col` vs `x_col`, optionally colored by `color_col`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_col : str</span>
<span class="sd">            Name of the column to put on the x axis</span>
<span class="sd">        y_col : str</span>
<span class="sd">            Name of the column to put on the y axis</span>
<span class="sd">        color_col : str | None, optional</span>
<span class="sd">            Name of the column to color points by (generally a category like "state_label"), by default None</span>
<span class="sd">        use_expr : pl.Expr, optional</span>
<span class="sd">            An expression to select plottable points, by default pl.lit(True)</span>
<span class="sd">        use_good_expr : bool, optional</span>
<span class="sd">            Whether to apply the object's `good_expr` before plotting, by default True</span>
<span class="sd">        skip_none : bool, optional</span>
<span class="sd">            Whether to skip color categories with no name, by default True</span>
<span class="sd">        ax : plt.Axes | None, optional</span>
<span class="sd">            Axes to plot on, by default None</span>
<span class="sd">        annotate : bool, optional</span>
<span class="sd">            Whether to annotate points that are hovered over or clicked on by the mouse, by default True</span>
<span class="sd">        max_points: int, optional</span>
<span class="sd">            Maximum number of points allowed in scatter plot (or if None, no maximum). To ensure representative</span>
<span class="sd">            from all portions of the data, only 1 of each consecutive N points will be plotted, with N chosen to</span>
<span class="sd">            be consistent with the `max_points` requirement.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>  <span class="c1"># set current axis so I can use plt api</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>
        <span class="k">if</span> <span class="n">use_good_expr</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="s2">"pulse_idx"</span>
        <span class="c1"># Caused errors in Polars 1.35 if this was "index". See issue #85.</span>

        <span class="c1"># Plot only 1 data value out of every n, if max_points argument is an integer.</span>
        <span class="c1"># Compute n from the ratio of all points to max_points.</span>
        <span class="n">plot_every_nth</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">max_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_points</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
                <span class="n">plot_every_nth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_points</span>

        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">index_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color_col</span><span class="p">)</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">index_name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">columns_to_keep</span><span class="p">)</span>
            <span class="o">.</span><span class="n">gather_every</span><span class="p">(</span><span class="n">plot_every_nth</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">lines_pnums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,),</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">color_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span> <span class="ow">and</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">y_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span>
                <span class="s2">"."</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lines_pnums</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="s2">""</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s2">"offset points"</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">"round"</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">"w"</span><span class="p">),</span>
                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">"-&gt;"</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">update_note</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">                </span><span class="sd">"""Generate a matplotlib hovering note about the data point index</span>

<span class="sd">                Parameters</span>
<span class="sd">                ----------</span>
<span class="sd">                points : list</span>
<span class="sd">                    List of the plotted data points that are hovered over</span>
<span class="sd">                """</span>
                <span class="c1"># TODO: this only works if the first line object has the pulse we want.</span>
                <span class="n">line</span><span class="p">,</span> <span class="n">pnum</span> <span class="o">=</span> <span class="n">lines_pnums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">text2</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pnum</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Pulses [</span><span class="si">{</span><span class="n">text2</span><span class="si">}</span><span class="s2">]"</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Pulse </span><span class="si">{</span><span class="n">text2</span><span class="si">}</span><span class="s2">"</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">hover</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MouseEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">                </span><span class="sd">"""Callback to be used when mouse hovers near a plotted point</span>

<span class="sd">                Parameters</span>
<span class="sd">                ----------</span>
<span class="sd">                event : MouseEvent</span>
<span class="sd">                    The mouse-related event; contains location information</span>
<span class="sd">                """</span>
                <span class="n">vis</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">!=</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">cont</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                    <span class="n">update_note</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="s2">"ind"</span><span class="p">])</span>
                    <span class="n">annotation</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">vis</span><span class="p">:</span>
                    <span class="n">annotation</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">click</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MouseEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">                </span><span class="sd">"""Callback to be used when mouse clicks near a plotted point</span>

<span class="sd">                Parameters</span>
<span class="sd">                ----------</span>
<span class="sd">                event : MouseEvent</span>
<span class="sd">                    The mouse-related event; contains location information</span>
<span class="sd">                """</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">!=</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">cont</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                    <span class="n">pnum</span> <span class="o">=</span> <span class="n">lines_pnums</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">rownum</span> <span class="o">=</span> <span class="n">pnum</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="s2">"ind"</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"This is pulse# </span><span class="si">{</span><span class="n">rownum</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">rownum</span><span class="p">,</span> <span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">"motion_notify_event"</span><span class="p">,</span> <span class="n">hover</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">"button_press_event"</span><span class="p">,</span> <span class="n">click</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_col</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_col</span><span class="p">))</span>
        <span class="n">title_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span><span class="si">}</span>
<span class="s2">        use_expr=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="si">}</span>
<span class="s2">        good_expr=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="si">}</span><span class="s2">"""</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">color_col</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">good_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a Polars Series of the given column, filtered by good_expr and use_expr."""</span>
        <span class="k">return</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_avg_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the average pulse stored in the last recipe step that's an optimal filter step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray | None</span>
<span class="sd">            The last filtering step's signal model, or None if no such step</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">OptimalFilterStep</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">filter_maker</span><span class="o">.</span><span class="n">signal_model</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the average pulse stored in the last recipe step that's an optimal filter step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray | None</span>
<span class="sd">            The last filtering step's signal model, or None if no such step</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">OptimalFilterStep</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_noise_psd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the noise PSD stored in the last recipe step that's an optimal filter step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[NDArray, NDArray] | None</span>
<span class="sd">            The last filtering step's (frequencies, noise spectrum), or None if no such step</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">OptimalFilterStep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">step</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">psd</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_noise_autocorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the noise autocorrelation stored in the last recipe step that's an optimal filter step</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray | None</span>
<span class="sd">            The last filtering step's noise autocorrelation, or None if no such step</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">OptimalFilterStep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">step</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">autocorr_vec</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rough_cal_combinatoric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Learn a rough calibration by trying all combinatorically possible peak assignments."""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_combinatoric</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">uncalibrated_col</span><span class="o">=</span><span class="n">uncalibrated_col</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">ph_smoothing_fwhm</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">,</span>
            <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rough_cal_combinatoric_height_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Learn a rough calibration by trying all combinatorically possible peak assignments,</span>
<span class="sd">        using known relative peak heights to limit the possibilities."""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_combinatoric_height_info</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">line_heights_allowed</span><span class="p">,</span>
            <span class="n">uncalibrated_col</span><span class="o">=</span><span class="n">uncalibrated_col</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">ph_smoothing_fwhm</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">,</span>
            <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rough_cal</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"filtValue"</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
        <span class="n">n_extra_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">acceptable_rms_residual_e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Learn a rough calibration by trying to assign the 3 brightest peaks,</span>
<span class="sd">        then fitting a line to those and looking for other peaks that fit that line.</span>
<span class="sd">        """</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_3peak</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">uncalibrated_col</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="p">,</span>
            <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">,</span>
            <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">,</span>
            <span class="n">fwhm_pulse_height_units</span><span class="p">,</span>
            <span class="n">n_extra_peaks</span><span class="p">,</span>
            <span class="n">acceptable_rms_residual_e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">RecipeStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a new Channel with the given step applied to generate new columns in the dataframe."""</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">elapsed_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">df_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_history</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">],</span>
            <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
            <span class="n">steps_elapsed_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_elapsed_s</span> <span class="o">+</span> <span class="p">[</span><span class="n">elapsed_s</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="n">Recipe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a new Channel with the given steps applied to generate new columns in the dataframe."""</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="n">ch2</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a new Channel with the given good_expr, combined with the existing good_expr by "and",</span>
<span class="sd">        of by replacing it entirely if `replace` is True."""</span>
        <span class="c1"># the default value of self.good_expr is pl.lit(True)</span>
        <span class="c1"># and_(True) will just add visual noise when looking at good_expr and not affect behavior</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span> <span class="ow">and</span> <span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_expr</span><span class="o">=</span><span class="n">good_expr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_column_map_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""f should take a numpy array and return a numpy array with the same number of elements"""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">ColumnAsNumpyMapStep</span><span class="p">([</span><span class="n">input_col</span><span class="p">],</span> <span class="p">[</span><span class="n">output_col</span><span class="p">],</span> <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_pretrig_rms_and_postpeak_deriv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n_sigma_pretrig_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_sigma_postpeak_deriv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set good_expr to exclude pulses with pretrigger RMS or postpeak derivative above outlier-resistant thresholds."""</span>
        <span class="n">max_postpeak_deriv</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"postpeak_deriv"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_postpeak_deriv</span>
        <span class="p">)</span>
        <span class="n">max_pretrig_rms</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"pretrig_rms"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_pretrig_rms</span><span class="p">)</span>
        <span class="n">good_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_postpeak_deriv</span><span class="p">)</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_pretrig_rms</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_range_around_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">range_up</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">range_down</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set good_expr to exclude pulses with `col` outside the given range around its median."""</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">med</span> <span class="o">-</span> <span class="n">range_down</span><span class="p">,</span> <span class="n">med</span> <span class="o">+</span> <span class="n">range_up</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_below_nsigma_outlier_resistant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set good_expr to exclude pulses with any of the given columns above outlier-resistant thresholds.</span>
<span class="sd">        Always sets lower limit at 0, so don't use for values that can be negative</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
            <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
            <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_nsigma_range_outlier_resistant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set good_expr to exclude pulses with any of the given columns above outlier-resistant thresholds.</span>
<span class="sd">        Always sets lower limit at 0, so don't use for values that can be negative</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
            <span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_range_from_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
            <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">typical_peak_ind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the typical peak index of the given column, using the median peak index for the first 100 pulses."""</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_pulses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">pretrigger_ignore_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">peak_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Summarize the pulses, adding columns for pulse height, pretrigger mean, etc."""</span>
        <span class="k">if</span> <span class="n">peak_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peak_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">result_dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="c1"># mypy (incorrectly) thinks `out_names` might be None, and `list(None)` is forbidden. Assertion makes it happy again.</span>
        <span class="k">assert</span> <span class="n">out_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_names</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">SummarizeStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">frametime_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
            <span class="n">peak_index</span><span class="o">=</span><span class="n">peak_index</span><span class="p">,</span>
            <span class="n">pulse_col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">pretrigger_ignore_samples</span><span class="o">=</span><span class="n">pretrigger_ignore_samples</span><span class="p">,</span>
            <span class="n">n_presamples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
            <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct_pretrig_mean_jumps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="n">corrected</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ptm_jf"</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Correct pretrigger mean jumps in the raw pulse data, writing to a new column."""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">PretrigMeanJumpFixStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">uncorrected</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">corrected</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_select_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_expr_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        This step is meant for interactive exploration; it's basically like the df.select() method, but it's saved as a step.</span>
<span class="sd">        """</span>
        <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">col_expr_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">SelectStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
            <span class="n">output</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">col_expr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">col_expr_dict</span><span class="o">=</span><span class="n">col_expr_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_categorize_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_condition_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">],</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"category"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add a recipe step that categorizes pulses based on the given conditions."""</span>
        <span class="c1"># ensure the first condition is True, to be used as a fallback</span>
        <span class="n">first_expr</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">category_condition_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"fallback"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="o">**</span><span class="n">category_condition_dict</span><span class="p">}</span>
        <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">CategorizeStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">output_col</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">category_condition_dict</span><span class="o">=</span><span class="n">category_condition_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_average_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute an average pulse given a use expression.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pulse_col : str, optional</span>
<span class="sd">            Name of the column in self.df containing raw pulses, by default "pulse"</span>
<span class="sd">        use_expr : pl.Expr, optional</span>
<span class="sd">            Selection (in addition to self.good_expr) to use, by default pl.lit(True)</span>
<span class="sd">        limit : int, optional</span>
<span class="sd">            Use no more than this many pulses, by default 2000</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray</span>
<span class="sd">            _description_</span>
<span class="sd">        """</span>
        <span class="n">avg_pulse</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">)</span>
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">avg_pulse</span> <span class="o">-=</span> <span class="n">avg_pulse</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">avg_pulse</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter5lag</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
        <span class="n">peak_y_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagy"</span><span class="p">,</span>
        <span class="n">peak_x_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagx"</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">25e3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a 5-lag optimal filter and apply it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pulse_col : str, optional</span>
<span class="sd">            Which column contains raw data, by default "pulse"</span>
<span class="sd">        peak_y_col : str, optional</span>
<span class="sd">            Column to contain the optimal filter results, by default "5lagy"</span>
<span class="sd">        peak_x_col : str, optional</span>
<span class="sd">            Column to contain the 5-lag filter's estimate of arrival-time/phase, by default "5lagx"</span>
<span class="sd">        f_3db : float, optional</span>
<span class="sd">            A low-pass filter 3 dB point to apply to the computed filter, by default 25e3</span>
<span class="sd">        use_expr : pl.Expr, optional</span>
<span class="sd">            An expression to select pulses for averaging, by default pl.lit(True)</span>
<span class="sd">        time_constant_s_of_exp_to_be_orthogonal_to : float | None, optional</span>
<span class="sd">            Optionally an exponential decay time to make the filter insensitive to, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channel</span>
<span class="sd">            This channel with a Filter5LagStep added to the recipe.</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
        <span class="n">noiseresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="n">trunc_back</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_front</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">avg_pulse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_average_pulse</span><span class="p">(</span><span class="n">pulse_col</span><span class="o">=</span><span class="n">pulse_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="n">filter_maker</span> <span class="o">=</span> <span class="n">FilterMaker</span><span class="p">(</span>
            <span class="n">signal_model</span><span class="o">=</span><span class="n">avg_pulse</span><span class="p">,</span>
            <span class="n">n_pretrigger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
            <span class="n">noise_psd</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span>
            <span class="n">noise_autocorr</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">autocorr_vec</span><span class="p">,</span>
            <span class="n">sample_time_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter5lag</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_5lag</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter5lag</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_5lag_noexp</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="o">=</span><span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">OptimalFilterStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">peak_x_col</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">filter5lag</span><span class="p">,</span>
            <span class="n">spectrum</span><span class="o">=</span><span class="n">noiseresult</span><span class="p">,</span>
            <span class="n">filter_maker</span><span class="o">=</span><span class="n">filter_maker</span><span class="p">,</span>
            <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_ats_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Compute the average pulse and arrival-time model for an ATS filter.</span>
<span class="sd">        We use the first `limit` pulses that pass `good_expr` and `use_expr`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pulse_col : str</span>
<span class="sd">            _description_</span>
<span class="sd">        use_expr : pl.Expr, optional</span>
<span class="sd">            _description_, by default pl.lit(True)</span>
<span class="sd">        limit : int, optional</span>
<span class="sd">            _description_, by default 2000</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[NDArray, NDArray]</span>
<span class="sd">            _description_</span>
<span class="sd">        """</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">,</span> <span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="s2">"promptness"</span><span class="p">,</span> <span class="s2">"pretrig_mean"</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Adjust promptness: subtract a linear trend with pulse_rms</span>
        <span class="n">prms</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"pulse_rms"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">promptness</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"promptness"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">prms</span><span class="p">,</span> <span class="n">promptness</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">promptshifted</span><span class="o">=</span><span class="p">(</span><span class="n">promptness</span> <span class="o">-</span> <span class="n">poly</span><span class="p">(</span><span class="n">prms</span><span class="p">)))</span>

        <span class="c1"># Rescale promptness quadratically to span approximately [-0.5, +0.5], dropping any pulses with abs(t) &gt; 0.45.</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"promptshifted"</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.4</span><span class="p">])</span>
        <span class="n">ATime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">param</span><span class="p">)(</span><span class="n">df</span><span class="p">[</span><span class="s2">"promptshifted"</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ATime</span><span class="o">=</span><span class="n">ATime</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ATime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.45</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"promptshifted"</span><span class="p">)</span>

        <span class="c1"># Compute mean pulse and dt model as the offset and slope of a linear fit to each pulse sample vs ATime</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">avg_pulse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dt_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">):</span>
            <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"ATime"</span><span class="p">],</span> <span class="p">(</span><span class="n">pulse</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">"pretrig_mean"</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dt_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">slope</span>
            <span class="n">avg_pulse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">return</span> <span class="n">avg_pulse</span><span class="p">,</span> <span class="n">dt_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filterATS</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
        <span class="n">peak_y_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ats_y"</span><span class="p">,</span>
        <span class="n">peak_x_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ats_x"</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">25e3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute an arrival-time-safe (ATS) optimal filter and apply it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pulse_col : str, optional</span>
<span class="sd">            Which column contains raw data, by default "pulse"</span>
<span class="sd">        peak_y_col : str, optional</span>
<span class="sd">            Column to contain the optimal filter results, by default "ats_y"</span>
<span class="sd">        peak_x_col : str, optional</span>
<span class="sd">            Column to contain the ATS filter's estimate of arrival-time/phase, by default "ats_x"</span>
<span class="sd">        f_3db : float, optional</span>
<span class="sd">            A low-pass filter 3 dB point to apply to the computed filter, by default 25e3</span>
<span class="sd">        use_expr : pl.Expr, optional</span>
<span class="sd">            An expression to select pulses for averaging, by default pl.lit(True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channel</span>
<span class="sd">            This channel with a Filter5LagStep added to the recipe.</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
        <span class="n">mprms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">use</span> <span class="o">=</span> <span class="n">use_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">)</span> <span class="o">/</span> <span class="n">mprms</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">4000</span>
        <span class="n">avg_pulse</span><span class="p">,</span> <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_ats_model</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="n">noiseresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">filter_maker</span> <span class="o">=</span> <span class="n">FilterMaker</span><span class="p">(</span>
            <span class="n">signal_model</span><span class="o">=</span><span class="n">avg_pulse</span><span class="p">,</span>
            <span class="n">dt_model</span><span class="o">=</span><span class="n">dt_model</span><span class="p">,</span>
            <span class="n">n_pretrigger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
            <span class="n">noise_psd</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span>
            <span class="n">noise_autocorr</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">autocorr_vec</span><span class="p">,</span>
            <span class="n">sample_time_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">filter_ats</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_ats</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">OptimalFilterStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">peak_x_col</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">filter_ats</span><span class="p">,</span>
            <span class="n">spectrum</span><span class="o">=</span><span class="n">noiseresult</span><span class="p">,</span>
            <span class="n">filter_maker</span><span class="o">=</span><span class="n">filter_maker</span><span class="p">,</span>
            <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">good_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a Polars DataFrame of the given columns, filtered by good_expr and use_expr."""</span>
        <span class="n">good_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">good_df</span> <span class="o">=</span> <span class="n">good_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">good_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bad_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a Polars DataFrame of the given columns, filtered by the inverse of good_expr, and use_expr."""</span>
        <span class="n">bad_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">not_</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bad_df</span> <span class="o">=</span> <span class="n">bad_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bad_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">good_serieses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return a list of Polars Series of the given columns, filtered by good_expr and use_expr."""</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_df</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">df2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">driftcorrect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pretrig_mean"</span><span class="p">,</span>
        <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagy"</span><span class="p">,</span>
        <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Correct for gain drift correlated with the given indicator column."""</span>
        <span class="c1"># by defining a seperate learn method that takes ch as an argument,</span>
        <span class="c1"># we can move all the code for the step outside of Channel</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">DriftCorrectStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
            <span class="n">ch</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">indicator_col</span><span class="o">=</span><span class="n">indicator_col</span><span class="p">,</span>
            <span class="n">uncorrected_col</span><span class="o">=</span><span class="n">uncorrected_col</span><span class="p">,</span>
            <span class="n">corrected_col</span><span class="o">=</span><span class="n">corrected_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linefit</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit a spectral line to the  binned data from the given column, optionally filtering by use_expr."""</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
        <span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pe</span> <span class="o">-</span> <span class="n">dlo</span><span class="p">,</span> <span class="n">pe</span> <span class="o">+</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_bin_edges</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"before update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_update</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"after update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">ds_shortname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
            <span class="n">attr_str</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">use_expr</span><span class="si">=}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Return a list of (step type name, elapsed time in seconds) for each step in the recipe."""</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_elapsed_s</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a hash based on the object's id."""</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return True if the other object is the same object (by id)."""</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="c1"># only checks if the ids match, does not try to be equal if all contents are equal</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">noise_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load a Channel from an LJH file, optionally with a NoiseChannel from a corresponding noise LJH file."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">noise_path</span><span class="p">:</span>
            <span class="n">noise_channel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">noise_channel</span> <span class="o">=</span> <span class="n">NoiseChannel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">noise_path</span><span class="p">)</span>
        <span class="n">ljh</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span> <span class="o">=</span> <span class="n">ljh</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">keep_posix_usec</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="o">.</span><span class="n">from_ljh_header_df</span><span class="p">(</span><span class="n">header_df</span><span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="n">ljh</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">subframediv</span><span class="o">=</span><span class="n">ljh</span><span class="o">.</span><span class="n">subframediv</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise_channel</span><span class="p">,</span> <span class="n">transform_raw</span><span class="o">=</span><span class="n">transform_raw</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_off</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">off</span><span class="p">:</span> <span class="n">OffFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load a Channel from an OFF file."""</span>
        <span class="k">assert</span> <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"ns"</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">df_header</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">df_header</span> <span class="o">=</span> <span class="n">df_header</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">"Filename"</span><span class="p">,</span> <span class="p">[</span><span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">]))</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">off</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ChannelNumberMatchingName"</span><span class="p">],</span>
            <span class="n">off</span><span class="o">.</span><span class="n">framePeriodSeconds</span><span class="p">,</span>
            <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"recordPreSamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"recordSamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">df_header</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">off</span><span class="o">.</span><span class="n">nRecords</span><span class="p">,</span> <span class="n">subframediv</span><span class="o">=</span><span class="n">off</span><span class="o">.</span><span class="n">subframediv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_es</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">force_timestamp_monotonic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add experiment states from an existing dataframe"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">is_sorted</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span><span class="o">.</span><span class="n">cum_max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)))</span>
            <span class="c1"># print("WARNING: in with_experiment_state_df, timestamp is not monotonic, forcing it to be")</span>
            <span class="c1"># print("This is likely a BUG in DASTARD.")</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_es</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"timestamp"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"backward"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_ext</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add external trigger times from an existing dataframe"""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="c1"># Expect "subframecount" will be in the dataframe for LJH 2.2 files, but have to add it for OFF files:</span>
        <span class="k">if</span> <span class="s2">"subframecount"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">subframecount</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"framecount"</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_ext</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"backward"</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"_prev_ext_trig"</span><span class="p">)</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span>
            <span class="n">df_ext</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"forward"</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"_next_ext_trig"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_replacement_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Replace the dataframe with a new one, keeping all other attributes the same."""</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Append columns from df2 to the existing dataframe, keeping all other attributes the same."""</span>
        <span class="n">df3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">multifit_quadratic_gain_cal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit multiple spectral lines, to create a quadratic gain calibration."""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">MultiFitQuadraticGainStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">multifit_spec</span><span class="o">=</span><span class="n">multifit</span><span class="p">,</span>
            <span class="n">previous_cal_step_index</span><span class="o">=</span><span class="n">previous_cal_step_index</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">multifit_mass_cal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit multiple spectral lines, to create a Mass1-style gain calibration."""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">MultiFitMassCalibrationStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">multifit_spec</span><span class="o">=</span><span class="n">multifit</span><span class="p">,</span>
            <span class="n">previous_cal_step_index</span><span class="o">=</span><span class="n">previous_cal_step_index</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concat_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Concat the given dataframe to the existing dataframe, keeping all other attributes the same.</span>
<span class="sd">        If the new frame `df` has a history and/or steps, those will be lost"""</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span>
            <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span>
            <span class="n">subframediv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">,</span>
            <span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># we won't copy over df_history and steps. I don't think you should use this when those are filled in?</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concat_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Concat the given channel's dataframe to the existing dataframe, keeping all other attributes the same.</span>
<span class="sd">        If the new channel `ch` has a history and/or steps, those will be lost"""</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">phase_correct_mass_specific_lines</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply phase correction to the given uncorrected column, where specific lines are used to judge the correction."""</span>
        <span class="k">if</span> <span class="n">corrected_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">corrected_col</span> <span class="o">=</span> <span class="n">uncorrected_col</span> <span class="o">+</span> <span class="s2">"_pc"</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">phase_correct_steps</span><span class="o">.</span><span class="n">phase_correct_mass_specific_lines</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">indicator_col</span><span class="p">,</span>
            <span class="n">uncorrected_col</span><span class="p">,</span>
            <span class="n">corrected_col</span><span class="p">,</span>
            <span class="n">previous_cal_step_index</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"BadChannel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a BadChannel object, which wraps this Channel and includes error information."""</span>
        <span class="k">return</span> <span class="n">BadChannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Save the recipe steps to a pickle file, keyed by channel number."""</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_expr_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">downsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot a summary of the data set, including time series and histograms of key pulse properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_expr_in: pl.Expr | None, optional</span>
<span class="sd">            A polars expression to determine valid pulses, by default None. If None, use `self.good_expr`</span>
<span class="sd">        downsample: int | None, optional</span>
<span class="sd">            Plot only every one of `downsample` pulses in the scatter plots, by default None.</span>
<span class="sd">            If None, choose the smallest value so that no more than 10000 points appear</span>
<span class="sd">        log: bool, optional</span>
<span class="sd">            Whether to make the histograms have a logarithmic y-scale, by default False.</span>
<span class="sd">        """</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">tpi_microsec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
        <span class="n">plottables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="s2">"Pulse RMS"</span><span class="p">,</span> <span class="s2">"#dd00ff"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pulse_average"</span><span class="p">,</span> <span class="s2">"Pulse Avg"</span><span class="p">,</span> <span class="s2">"purple"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"peak_value"</span><span class="p">,</span> <span class="s2">"Peak value"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">,</span> <span class="s2">"Pretrig RMS"</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="s2">"Pretrig Mean"</span><span class="p">,</span> <span class="s2">"#00ff26"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">,</span> <span class="s2">"Max PostPk deriv"</span><span class="p">,</span> <span class="s2">"gold"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">,</span> <span class="s2">"Rise time (s)"</span><span class="p">,</span> <span class="s2">"orange"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">,</span> <span class="s2">"Peak time (s)"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">use_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="k">if</span> <span class="n">use_expr_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">use_expr_in</span>

        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">//</span> <span class="mi">10000</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">downsample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">gather_every</span><span class="p">(</span><span class="n">downsample</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"peak_index"</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"rise_time"</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">))</span>
        <span class="n">existing_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
        <span class="n">preserve</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plottables</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">]</span>
        <span class="n">preserve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">preserve</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Plot timeseries relative to 0 = the last 00 UT during or before the run.</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">last_midnight</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"datetime64[D]"</span><span class="p">)</span>
        <span class="n">hour_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">last_midnight</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600e6</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plottables</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="c1"># Time series scatter plots (left-hand panels)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hour_rel</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Time since last UT midnight (hours)"</span><span class="p">)</span>

            <span class="c1"># Histogram (right-hand panels)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">contents</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">"stepfilled"</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">contents</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Plotting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="si">}</span><span class="s2"> data points"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit a single pulse to a 2-exponential-with-tail model, returning the fit result."""</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">fit_pulse_2exp_with_tail</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npre</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ch=</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pulse index=</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.last_avg_pulse">
<code class="highlight language-python"><span class="n">last_avg_pulse</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the average pulse stored in the last recipe step that's an optimal filter step</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span> | None</code>
              
              <div class="doc-md-description">
<p>The last filtering step's signal model, or None if no such step</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.last_filter">
<code class="highlight language-python"><span class="n">last_filter</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the average pulse stored in the last recipe step that's an optimal filter step</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span> | None</code>
              
              <div class="doc-md-description">
<p>The last filtering step's signal model, or None if no such step</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.last_noise_autocorrelation">
<code class="highlight language-python"><span class="n">last_noise_autocorrelation</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the noise autocorrelation stored in the last recipe step that's an optimal filter step</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span> | None</code>
              
              <div class="doc-md-description">
<p>The last filtering step's noise autocorrelation, or None if no such step</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.last_noise_psd">
<code class="highlight language-python"><span class="n">last_noise_psd</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the noise PSD stored in the last recipe step that's an optimal filter step</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.typing.NDArray">NDArray</span>, <span title="numpy.typing.NDArray">NDArray</span>] | None</code>
              
              <div class="doc-md-description">
<p>The last filtering step's (frequencies, noise spectrum), or None if no such step</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.shortname">
<code class="highlight language-python"><span class="n">shortname</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>A short name for this channel, suitable for plot titles.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.__eq__">
<code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return True if the other object is the same object (by id).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span>
<span class="normal">994</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return True if the other object is the same object (by id)."""</span>
    <span class="c1"># needed to make functools.cache work</span>
    <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
    <span class="c1"># and we may get nonsense results</span>
    <span class="c1"># only checks if the ids match, does not try to be equal if all contents are equal</span>
    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.__hash__">
<code class="highlight language-python"><span class="fm">__hash__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a hash based on the object's id.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a hash based on the object's id."""</span>
    <span class="c1"># needed to make functools.cache work</span>
    <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
    <span class="c1"># and we may get nonsense results</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.as_bad">
<code class="highlight language-python"><span class="n">as_bad</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a BadChannel object, which wraps this Channel and includes error information.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">as_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"BadChannel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a BadChannel object, which wraps this Channel and includes error information."""</span>
    <span class="k">return</span> <span class="n">BadChannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.bad_df">
<code class="highlight language-python"><span class="n">bad_df</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a Polars DataFrame of the given columns, filtered by the inverse of good_expr, and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bad_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a Polars DataFrame of the given columns, filtered by the inverse of good_expr, and use_expr."""</span>
    <span class="n">bad_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">not_</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">bad_df</span> <span class="o">=</span> <span class="n">bad_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bad_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.compute_ats_model">
<code class="highlight language-python"><span class="n">compute_ats_model</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute the average pulse and arrival-time model for an ATS filter.
We use the first <code>limit</code> pulses that pass <code>good_expr</code> and <code>use_expr</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>pulse_col</code></b>
                  (<code><span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
<li>
<b><code>use_expr</code></b>
                  (<code><span title="polars.Expr">Expr</span></code>, default:
                      <code><span title="polars.lit">lit</span>(True)</code>
)
              
              <div class="doc-md-description">
<p><em>description</em>, by default pl.lit(True)</p>
</div>
</li>
<li>
<b><code>limit</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>2000</code>
)
              
              <div class="doc-md-description">
<p><em>description</em>, by default 2000</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.typing.NDArray">NDArray</span>, <span title="numpy.typing.NDArray">NDArray</span>]</code>
              
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_ats_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute the average pulse and arrival-time model for an ATS filter.</span>
<span class="sd">    We use the first `limit` pulses that pass `good_expr` and `use_expr`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pulse_col : str</span>
<span class="sd">        _description_</span>
<span class="sd">    use_expr : pl.Expr, optional</span>
<span class="sd">        _description_, by default pl.lit(True)</span>
<span class="sd">    limit : int, optional</span>
<span class="sd">        _description_, by default 2000</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[NDArray, NDArray]</span>
<span class="sd">        _description_</span>
<span class="sd">    """</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">,</span> <span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="s2">"promptness"</span><span class="p">,</span> <span class="s2">"pretrig_mean"</span><span class="p">)</span>
        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Adjust promptness: subtract a linear trend with pulse_rms</span>
    <span class="n">prms</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"pulse_rms"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">promptness</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"promptness"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">prms</span><span class="p">,</span> <span class="n">promptness</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">promptshifted</span><span class="o">=</span><span class="p">(</span><span class="n">promptness</span> <span class="o">-</span> <span class="n">poly</span><span class="p">(</span><span class="n">prms</span><span class="p">)))</span>

    <span class="c1"># Rescale promptness quadratically to span approximately [-0.5, +0.5], dropping any pulses with abs(t) &gt; 0.45.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"promptshifted"</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.4</span><span class="p">])</span>
    <span class="n">ATime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">param</span><span class="p">)(</span><span class="n">df</span><span class="p">[</span><span class="s2">"promptshifted"</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ATime</span><span class="o">=</span><span class="n">ATime</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ATime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.45</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"promptshifted"</span><span class="p">)</span>

    <span class="c1"># Compute mean pulse and dt model as the offset and slope of a linear fit to each pulse sample vs ATime</span>
    <span class="n">pulse</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">avg_pulse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dt_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">):</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"ATime"</span><span class="p">],</span> <span class="p">(</span><span class="n">pulse</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">"pretrig_mean"</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dt_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">slope</span>
        <span class="n">avg_pulse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">avg_pulse</span><span class="p">,</span> <span class="n">dt_model</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.compute_average_pulse">
<code class="highlight language-python"><span class="n">compute_average_pulse</span><span class="p">(</span><span class="n">pulse_col</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute an average pulse given a use expression.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>pulse_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'pulse'</code>
)
              
              <div class="doc-md-description">
<p>Name of the column in self.df containing raw pulses, by default "pulse"</p>
</div>
</li>
<li>
<b><code>use_expr</code></b>
                  (<code><span title="polars.Expr">Expr</span></code>, default:
                      <code><span title="polars.lit">lit</span>(True)</code>
)
              
              <div class="doc-md-description">
<p>Selection (in addition to self.good_expr) to use, by default pl.lit(True)</p>
</div>
</li>
<li>
<b><code>limit</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>2000</code>
)
              
              <div class="doc-md-description">
<p>Use no more than this many pulses, by default 2000</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              
              <div class="doc-md-description">
<p><em>description</em></p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_average_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute an average pulse given a use expression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pulse_col : str, optional</span>
<span class="sd">        Name of the column in self.df containing raw pulses, by default "pulse"</span>
<span class="sd">    use_expr : pl.Expr, optional</span>
<span class="sd">        Selection (in addition to self.good_expr) to use, by default pl.lit(True)</span>
<span class="sd">    limit : int, optional</span>
<span class="sd">        Use no more than this many pulses, by default 2000</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        _description_</span>
<span class="sd">    """</span>
    <span class="n">avg_pulse</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">)</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
        <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">avg_pulse</span> <span class="o">-=</span> <span class="n">avg_pulse</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avg_pulse</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.concat_ch">
<code class="highlight language-python"><span class="n">concat_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Concat the given channel's dataframe to the existing dataframe, keeping all other attributes the same.
If the new channel <code>ch</code> has a history and/or steps, those will be lost</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">concat_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Concat the given channel's dataframe to the existing dataframe, keeping all other attributes the same.</span>
<span class="sd">    If the new channel `ch` has a history and/or steps, those will be lost"""</span>
    <span class="n">ch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ch2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.concat_df">
<code class="highlight language-python"><span class="n">concat_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Concat the given dataframe to the existing dataframe, keeping all other attributes the same.
If the new frame <code>df</code> has a history and/or steps, those will be lost</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">concat_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Concat the given dataframe to the existing dataframe, keeping all other attributes the same.</span>
<span class="sd">    If the new frame `df` has a history and/or steps, those will be lost"""</span>
    <span class="n">ch2</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span>
        <span class="n">subframediv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">,</span>
        <span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># we won't copy over df_history and steps. I don't think you should use this when those are filled in?</span>
    <span class="k">return</span> <span class="n">ch2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.correct_pretrig_mean_jumps">
<code class="highlight language-python"><span class="n">correct_pretrig_mean_jumps</span><span class="p">(</span><span class="n">uncorrected</span><span class="o">=</span><span class="s1">'pretrig_mean'</span><span class="p">,</span> <span class="n">corrected</span><span class="o">=</span><span class="s1">'ptm_jf'</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Correct pretrigger mean jumps in the raw pulse data, writing to a new column.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_pretrig_mean_jumps</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="n">corrected</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ptm_jf"</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Correct pretrigger mean jumps in the raw pulse data, writing to a new column."""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">PretrigMeanJumpFixStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">uncorrected</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">corrected</span><span class="p">],</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.driftcorrect">
<code class="highlight language-python"><span class="n">driftcorrect</span><span class="p">(</span><span class="n">indicator_col</span><span class="o">=</span><span class="s1">'pretrig_mean'</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="o">=</span><span class="s1">'5lagy'</span><span class="p">,</span> <span class="n">corrected_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Correct for gain drift correlated with the given indicator column.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">driftcorrect</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pretrig_mean"</span><span class="p">,</span>
    <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagy"</span><span class="p">,</span>
    <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Correct for gain drift correlated with the given indicator column."""</span>
    <span class="c1"># by defining a seperate learn method that takes ch as an argument,</span>
    <span class="c1"># we can move all the code for the step outside of Channel</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">DriftCorrectStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
        <span class="n">ch</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">indicator_col</span><span class="o">=</span><span class="n">indicator_col</span><span class="p">,</span>
        <span class="n">uncorrected_col</span><span class="o">=</span><span class="n">uncorrected_col</span><span class="p">,</span>
        <span class="n">corrected_col</span><span class="o">=</span><span class="n">corrected_col</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.filter5lag">
<code class="highlight language-python"><span class="n">filter5lag</span><span class="p">(</span><span class="n">pulse_col</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="o">=</span><span class="s1">'5lagy'</span><span class="p">,</span> <span class="n">peak_x_col</span><span class="o">=</span><span class="s1">'5lagx'</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="mf">25000.0</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a 5-lag optimal filter and apply it.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>pulse_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'pulse'</code>
)
              
              <div class="doc-md-description">
<p>Which column contains raw data, by default "pulse"</p>
</div>
</li>
<li>
<b><code>peak_y_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'5lagy'</code>
)
              
              <div class="doc-md-description">
<p>Column to contain the optimal filter results, by default "5lagy"</p>
</div>
</li>
<li>
<b><code>peak_x_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'5lagx'</code>
)
              
              <div class="doc-md-description">
<p>Column to contain the 5-lag filter's estimate of arrival-time/phase, by default "5lagx"</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>25000.0</code>
)
              
              <div class="doc-md-description">
<p>A low-pass filter 3 dB point to apply to the computed filter, by default 25e3</p>
</div>
</li>
<li>
<b><code>use_expr</code></b>
                  (<code><span title="polars.Expr">Expr</span></code>, default:
                      <code><span title="polars.lit">lit</span>(True)</code>
)
              
              <div class="doc-md-description">
<p>An expression to select pulses for averaging, by default pl.lit(True)</p>
</div>
</li>
<li>
<b><code>time_constant_s_of_exp_to_be_orthogonal_to</code></b>
                  (<code><span title="float">float</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Optionally an exponential decay time to make the filter insensitive to, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Channel


  
      dataclass
   (mass2.core.channel.Channel)" href="#mass2.core.channel.Channel">Channel</a></code>
              
              <div class="doc-md-description">
<p>This channel with a Filter5LagStep added to the recipe.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter5lag</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
    <span class="n">peak_y_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagy"</span><span class="p">,</span>
    <span class="n">peak_x_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagx"</span><span class="p">,</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">25e3</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a 5-lag optimal filter and apply it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pulse_col : str, optional</span>
<span class="sd">        Which column contains raw data, by default "pulse"</span>
<span class="sd">    peak_y_col : str, optional</span>
<span class="sd">        Column to contain the optimal filter results, by default "5lagy"</span>
<span class="sd">    peak_x_col : str, optional</span>
<span class="sd">        Column to contain the 5-lag filter's estimate of arrival-time/phase, by default "5lagx"</span>
<span class="sd">    f_3db : float, optional</span>
<span class="sd">        A low-pass filter 3 dB point to apply to the computed filter, by default 25e3</span>
<span class="sd">    use_expr : pl.Expr, optional</span>
<span class="sd">        An expression to select pulses for averaging, by default pl.lit(True)</span>
<span class="sd">    time_constant_s_of_exp_to_be_orthogonal_to : float | None, optional</span>
<span class="sd">        Optionally an exponential decay time to make the filter insensitive to, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Channel</span>
<span class="sd">        This channel with a Filter5LagStep added to the recipe.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
    <span class="n">noiseresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="n">trunc_back</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_front</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">avg_pulse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_average_pulse</span><span class="p">(</span><span class="n">pulse_col</span><span class="o">=</span><span class="n">pulse_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="n">filter_maker</span> <span class="o">=</span> <span class="n">FilterMaker</span><span class="p">(</span>
        <span class="n">signal_model</span><span class="o">=</span><span class="n">avg_pulse</span><span class="p">,</span>
        <span class="n">n_pretrigger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
        <span class="n">noise_psd</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span>
        <span class="n">noise_autocorr</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">autocorr_vec</span><span class="p">,</span>
        <span class="n">sample_time_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter5lag</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_5lag</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter5lag</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_5lag_noexp</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="o">=</span><span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">OptimalFilterStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">peak_x_col</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="p">],</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="nb">filter</span><span class="o">=</span><span class="n">filter5lag</span><span class="p">,</span>
        <span class="n">spectrum</span><span class="o">=</span><span class="n">noiseresult</span><span class="p">,</span>
        <span class="n">filter_maker</span><span class="o">=</span><span class="n">filter_maker</span><span class="p">,</span>
        <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.filterATS">
<code class="highlight language-python"><span class="n">filterATS</span><span class="p">(</span><span class="n">pulse_col</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="o">=</span><span class="s1">'ats_y'</span><span class="p">,</span> <span class="n">peak_x_col</span><span class="o">=</span><span class="s1">'ats_x'</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="mf">25000.0</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute an arrival-time-safe (ATS) optimal filter and apply it.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>pulse_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'pulse'</code>
)
              
              <div class="doc-md-description">
<p>Which column contains raw data, by default "pulse"</p>
</div>
</li>
<li>
<b><code>peak_y_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'ats_y'</code>
)
              
              <div class="doc-md-description">
<p>Column to contain the optimal filter results, by default "ats_y"</p>
</div>
</li>
<li>
<b><code>peak_x_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'ats_x'</code>
)
              
              <div class="doc-md-description">
<p>Column to contain the ATS filter's estimate of arrival-time/phase, by default "ats_x"</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>25000.0</code>
)
              
              <div class="doc-md-description">
<p>A low-pass filter 3 dB point to apply to the computed filter, by default 25e3</p>
</div>
</li>
<li>
<b><code>use_expr</code></b>
                  (<code><span title="polars.Expr">Expr</span></code>, default:
                      <code><span title="polars.lit">lit</span>(True)</code>
)
              
              <div class="doc-md-description">
<p>An expression to select pulses for averaging, by default pl.lit(True)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Channel


  
      dataclass
   (mass2.core.channel.Channel)" href="#mass2.core.channel.Channel">Channel</a></code>
              
              <div class="doc-md-description">
<p>This channel with a Filter5LagStep added to the recipe.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filterATS</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
    <span class="n">peak_y_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ats_y"</span><span class="p">,</span>
    <span class="n">peak_x_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ats_x"</span><span class="p">,</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">25e3</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute an arrival-time-safe (ATS) optimal filter and apply it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pulse_col : str, optional</span>
<span class="sd">        Which column contains raw data, by default "pulse"</span>
<span class="sd">    peak_y_col : str, optional</span>
<span class="sd">        Column to contain the optimal filter results, by default "ats_y"</span>
<span class="sd">    peak_x_col : str, optional</span>
<span class="sd">        Column to contain the ATS filter's estimate of arrival-time/phase, by default "ats_x"</span>
<span class="sd">    f_3db : float, optional</span>
<span class="sd">        A low-pass filter 3 dB point to apply to the computed filter, by default 25e3</span>
<span class="sd">    use_expr : pl.Expr, optional</span>
<span class="sd">        An expression to select pulses for averaging, by default pl.lit(True)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Channel</span>
<span class="sd">        This channel with a Filter5LagStep added to the recipe.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
    <span class="n">mprms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">use</span> <span class="o">=</span> <span class="n">use_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">)</span> <span class="o">/</span> <span class="n">mprms</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="mi">4000</span>
    <span class="n">avg_pulse</span><span class="p">,</span> <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_ats_model</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    <span class="n">noiseresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
    <span class="n">filter_maker</span> <span class="o">=</span> <span class="n">FilterMaker</span><span class="p">(</span>
        <span class="n">signal_model</span><span class="o">=</span><span class="n">avg_pulse</span><span class="p">,</span>
        <span class="n">dt_model</span><span class="o">=</span><span class="n">dt_model</span><span class="p">,</span>
        <span class="n">n_pretrigger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
        <span class="n">noise_psd</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span>
        <span class="n">noise_autocorr</span><span class="o">=</span><span class="n">noiseresult</span><span class="o">.</span><span class="n">autocorr_vec</span><span class="p">,</span>
        <span class="n">sample_time_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">filter_ats</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_ats</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">OptimalFilterStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">peak_x_col</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="p">],</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="nb">filter</span><span class="o">=</span><span class="n">filter_ats</span><span class="p">,</span>
        <span class="n">spectrum</span><span class="o">=</span><span class="n">noiseresult</span><span class="p">,</span>
        <span class="n">filter_maker</span><span class="o">=</span><span class="n">filter_maker</span><span class="p">,</span>
        <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.fit_pulse">
<code class="highlight language-python"><span class="n">fit_pulse</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit a single pulse to a 2-exponential-with-tail model, returning the fit result.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit a single pulse to a 2-exponential-with-tail model, returning the fit result."""</span>
    <span class="n">pulse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">fit_pulse_2exp_with_tail</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npre</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ch=</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pulse index=</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.from_ljh">
<code class="highlight language-python"><span class="n">from_ljh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">noise_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform_raw</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Load a Channel from an LJH file, optionally with a NoiseChannel from a corresponding noise LJH file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ljh</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">noise_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load a Channel from an LJH file, optionally with a NoiseChannel from a corresponding noise LJH file."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">noise_path</span><span class="p">:</span>
        <span class="n">noise_channel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">noise_channel</span> <span class="o">=</span> <span class="n">NoiseChannel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">noise_path</span><span class="p">)</span>
    <span class="n">ljh</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span> <span class="o">=</span> <span class="n">ljh</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">keep_posix_usec</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="o">.</span><span class="n">from_ljh_header_df</span><span class="p">(</span><span class="n">header_df</span><span class="p">)</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="n">ljh</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">subframediv</span><span class="o">=</span><span class="n">ljh</span><span class="o">.</span><span class="n">subframediv</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise_channel</span><span class="p">,</span> <span class="n">transform_raw</span><span class="o">=</span><span class="n">transform_raw</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">channel</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.from_off">
<code class="highlight language-python"><span class="n">from_off</span><span class="p">(</span><span class="n">off</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Load a Channel from an OFF file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_off</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">off</span><span class="p">:</span> <span class="n">OffFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load a Channel from an OFF file."""</span>
    <span class="k">assert</span> <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"ns"</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">df_header</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">df_header</span> <span class="o">=</span> <span class="n">df_header</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">"Filename"</span><span class="p">,</span> <span class="p">[</span><span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">]))</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">off</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ChannelNumberMatchingName"</span><span class="p">],</span>
        <span class="n">off</span><span class="o">.</span><span class="n">framePeriodSeconds</span><span class="p">,</span>
        <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"recordPreSamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"recordSamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">df_header</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">off</span><span class="o">.</span><span class="n">nRecords</span><span class="p">,</span> <span class="n">subframediv</span><span class="o">=</span><span class="n">off</span><span class="o">.</span><span class="n">subframediv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">channel</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.get_step">
<code class="highlight language-python"><span class="n">get_step</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Get the step at the given index, supporting negative indices.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Get the step at the given index, supporting negative indices."""</span>
    <span class="c1"># normalize the index to a positive index</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span>
    <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step</span><span class="p">,</span> <span class="n">index</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.good_df">
<code class="highlight language-python"><span class="n">good_df</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a Polars DataFrame of the given columns, filtered by good_expr and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">good_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a Polars DataFrame of the given columns, filtered by good_expr and use_expr."""</span>
    <span class="n">good_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">good_df</span> <span class="o">=</span> <span class="n">good_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">good_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.good_series">
<code class="highlight language-python"><span class="n">good_series</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a Polars Series of the given column, filtered by good_expr and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">good_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a Polars Series of the given column, filtered by good_expr and use_expr."""</span>
    <span class="k">return</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.good_serieses">
<code class="highlight language-python"><span class="n">good_serieses</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a list of Polars Series of the given columns, filtered by good_expr and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">good_serieses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return a list of Polars Series of the given columns, filtered by good_expr and use_expr."""</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_df</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">df2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.hist">
<code class="highlight language-python"><span class="n">hist</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a histogram of the given column, optionally filtering by good_expr and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hist</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a histogram of the given column, optionally filtering by good_expr and use_expr."""</span>
    <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
        <span class="c1"># so we special case True</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

    <span class="c1"># Group by the specified column and filter using good_expr</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.linefit">
<code class="highlight language-python"><span class="n">linefit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dlo</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">dhi</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">params_update</span><span class="o">=</span><span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">())</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit a spectral line to the  binned data from the given column, optionally filtering by use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">linefit</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">line</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit a spectral line to the  binned data from the given column, optionally filtering by use_expr."""</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
    <span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pe</span> <span class="o">-</span> <span class="n">dlo</span><span class="p">,</span> <span class="n">pe</span> <span class="o">+</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_bin_edges</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"before update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_update</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"after update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
        <span class="n">binsize</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">ds_shortname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
        <span class="n">attr_str</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">use_expr</span><span class="si">=}</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.mo_stepplots">
<code class="highlight language-python"><span class="n">mo_stepplots</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Marimo UI element to choose and display step plots, with a dropdown to choose channel number.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mo_stepplots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Marimo UI element to choose and display step plots, with a dropdown to choose channel number."""</span>
    <span class="n">desc_ind</span> <span class="o">=</span> <span class="p">{</span><span class="n">step</span><span class="o">.</span><span class="n">description</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)}</span>
    <span class="n">first_non_summarize_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">SummarizeStep</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">first_non_summarize_step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="k">break</span>
    <span class="n">mo_ui</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">(</span>
        <span class="n">desc_ind</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">first_non_summarize_step</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"choose step for ch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">Html</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Show the selected step plot."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mo_stepplots_explicit</span><span class="p">(</span><span class="n">mo_ui</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step_ind</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the selected step index from the dropdown item, if any."""</span>
        <span class="k">return</span> <span class="n">mo_ui</span><span class="o">.</span><span class="n">value</span>

    <span class="n">mo_ui</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span>
    <span class="n">mo_ui</span><span class="o">.</span><span class="n">step_ind</span> <span class="o">=</span> <span class="n">step_ind</span>
    <span class="k">return</span> <span class="n">mo_ui</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.multifit_mass_cal">
<code class="highlight language-python"><span class="n">multifit_mass_cal</span><span class="p">(</span><span class="n">multifit</span><span class="p">,</span> <span class="n">previous_cal_step_index</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit multiple spectral lines, to create a Mass1-style gain calibration.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">multifit_mass_cal</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
    <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit multiple spectral lines, to create a Mass1-style gain calibration."""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">MultiFitMassCalibrationStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multifit_spec</span><span class="o">=</span><span class="n">multifit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="o">=</span><span class="n">previous_cal_step_index</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.multifit_quadratic_gain_cal">
<code class="highlight language-python"><span class="n">multifit_quadratic_gain_cal</span><span class="p">(</span><span class="n">multifit</span><span class="p">,</span> <span class="n">previous_cal_step_index</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit multiple spectral lines, to create a quadratic gain calibration.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">multifit_quadratic_gain_cal</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
    <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit multiple spectral lines, to create a quadratic gain calibration."""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">MultiFitQuadraticGainStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multifit_spec</span><span class="o">=</span><span class="n">multifit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="o">=</span><span class="n">previous_cal_step_index</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.phase_correct_mass_specific_lines">
<code class="highlight language-python"><span class="n">phase_correct_mass_specific_lines</span><span class="p">(</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">previous_cal_step_index</span><span class="p">,</span> <span class="n">corrected_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply phase correction to the given uncorrected column, where specific lines are used to judge the correction.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">phase_correct_mass_specific_lines</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply phase correction to the given uncorrected column, where specific lines are used to judge the correction."""</span>
    <span class="k">if</span> <span class="n">corrected_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">corrected_col</span> <span class="o">=</span> <span class="n">uncorrected_col</span> <span class="o">+</span> <span class="s2">"_pc"</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">phase_correct_steps</span><span class="o">.</span><span class="n">phase_correct_mass_specific_lines</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indicator_col</span><span class="p">,</span>
        <span class="n">uncorrected_col</span><span class="p">,</span>
        <span class="n">corrected_col</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.plot_hist">
<code class="highlight language-python"><span class="n">plot_hist</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute and plot a histogram of the given column, optionally filtering by good_expr and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute and plot a histogram of the given column, optionally filtering by good_expr and use_expr."""</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="n">use_good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">)</span>

    <span class="c1"># Customize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.plot_hists">
<code class="highlight language-python"><span class="n">plot_hists</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">skip_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plots histograms for the given column, grouped by the specified column.</p>
<p>Parameters:
- col (str): The column name to plot.
- bin_edges (array-like): The edges of the bins for the histogram.
- group_by_col (str): The column name to group by. This is required.
- axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - col (str): The column name to plot.</span>
<span class="sd">    - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">    - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">    - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

    <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
        <span class="c1"># so we special case True</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

    <span class="c1"># Group by the specified column and filter using good_expr</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Plot a histogram for each group</span>
    <span class="n">counts_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get the data for the column to plot</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">group_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="n">counts_dict</span><span class="p">[</span><span class="n">group_name_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group_name_str</span><span class="p">)</span>
        <span class="c1"># Plot the histogram for the current group</span>
        <span class="c1"># if group_name == "EBIT":</span>
        <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.9, color="k", label=group_name_str)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.5, label=group_name_str)</span>
        <span class="c1"># bin_centers, counts = misc.hist_of_series(values, bin_edges)</span>
        <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>
    <span class="c1"># Customize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Add a legend to label the groups</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts_dict</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.plot_scatter">
<code class="highlight language-python"><span class="n">plot_scatter</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">color_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_points</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Generate a scatter plot of <code>y_col</code> vs <code>x_col</code>, optionally colored by <code>color_col</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x_col</code></b>
                  (<code><span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>Name of the column to put on the x axis</p>
</div>
</li>
<li>
<b><code>y_col</code></b>
                  (<code><span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>Name of the column to put on the y axis</p>
</div>
</li>
<li>
<b><code>color_col</code></b>
                  (<code><span title="str">str</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Name of the column to color points by (generally a category like "state_label"), by default None</p>
</div>
</li>
<li>
<b><code>use_expr</code></b>
                  (<code><span title="polars.Expr">Expr</span></code>, default:
                      <code><span title="polars.lit">lit</span>(True)</code>
)
              
              <div class="doc-md-description">
<p>An expression to select plottable points, by default pl.lit(True)</p>
</div>
</li>
<li>
<b><code>use_good_expr</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              
              <div class="doc-md-description">
<p>Whether to apply the object's <code>good_expr</code> before plotting, by default True</p>
</div>
</li>
<li>
<b><code>skip_none</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              
              <div class="doc-md-description">
<p>Whether to skip color categories with no name, by default True</p>
</div>
</li>
<li>
<b><code>ax</code></b>
                  (<code><span title="pylab.Axes">Axes</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Axes to plot on, by default None</p>
</div>
</li>
<li>
<b><code>annotate</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to annotate points that are hovered over or clicked on by the mouse, by default True</p>
</div>
</li>
<li>
<b><code>max_points</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Maximum number of points allowed in scatter plot (or if None, no maximum). To ensure representative
from all portions of the data, only 1 of each consecutive N points will be plotted, with N chosen to
be consistent with the <code>max_points</code> requirement.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_scatter</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">y_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">color_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">annotate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">max_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate a scatter plot of `y_col` vs `x_col`, optionally colored by `color_col`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_col : str</span>
<span class="sd">        Name of the column to put on the x axis</span>
<span class="sd">    y_col : str</span>
<span class="sd">        Name of the column to put on the y axis</span>
<span class="sd">    color_col : str | None, optional</span>
<span class="sd">        Name of the column to color points by (generally a category like "state_label"), by default None</span>
<span class="sd">    use_expr : pl.Expr, optional</span>
<span class="sd">        An expression to select plottable points, by default pl.lit(True)</span>
<span class="sd">    use_good_expr : bool, optional</span>
<span class="sd">        Whether to apply the object's `good_expr` before plotting, by default True</span>
<span class="sd">    skip_none : bool, optional</span>
<span class="sd">        Whether to skip color categories with no name, by default True</span>
<span class="sd">    ax : plt.Axes | None, optional</span>
<span class="sd">        Axes to plot on, by default None</span>
<span class="sd">    annotate : bool, optional</span>
<span class="sd">        Whether to annotate points that are hovered over or clicked on by the mouse, by default True</span>
<span class="sd">    max_points: int, optional</span>
<span class="sd">        Maximum number of points allowed in scatter plot (or if None, no maximum). To ensure representative</span>
<span class="sd">        from all portions of the data, only 1 of each consecutive N points will be plotted, with N chosen to</span>
<span class="sd">        be consistent with the `max_points` requirement.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>  <span class="c1"># set current axis so I can use plt api</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>
    <span class="k">if</span> <span class="n">use_good_expr</span><span class="p">:</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="s2">"pulse_idx"</span>
    <span class="c1"># Caused errors in Polars 1.35 if this was "index". See issue #85.</span>

    <span class="c1"># Plot only 1 data value out of every n, if max_points argument is an integer.</span>
    <span class="c1"># Compute n from the ratio of all points to max_points.</span>
    <span class="n">plot_every_nth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">max_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_points</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
            <span class="n">plot_every_nth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_points</span>

    <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">index_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color_col</span><span class="p">)</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">index_name</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">columns_to_keep</span><span class="p">)</span>
        <span class="o">.</span><span class="n">gather_every</span><span class="p">(</span><span class="n">plot_every_nth</span><span class="p">)</span>
        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">lines_pnums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,),</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">color_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span> <span class="ow">and</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">y_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span>
            <span class="s2">"."</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lines_pnums</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">""</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s2">"offset points"</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">"round"</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">"w"</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">"-&gt;"</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">annotation</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">update_note</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Generate a matplotlib hovering note about the data point index</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            points : list</span>
<span class="sd">                List of the plotted data points that are hovered over</span>
<span class="sd">            """</span>
            <span class="c1"># TODO: this only works if the first line object has the pulse we want.</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">pnum</span> <span class="o">=</span> <span class="n">lines_pnums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">text2</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pnum</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Pulses [</span><span class="si">{</span><span class="n">text2</span><span class="si">}</span><span class="s2">]"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Pulse </span><span class="si">{</span><span class="n">text2</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">hover</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MouseEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Callback to be used when mouse hovers near a plotted point</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            event : MouseEvent</span>
<span class="sd">                The mouse-related event; contains location information</span>
<span class="sd">            """</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">!=</span> <span class="n">ax</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">cont</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="n">update_note</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="s2">"ind"</span><span class="p">])</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">vis</span><span class="p">:</span>
                <span class="n">annotation</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">click</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MouseEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Callback to be used when mouse clicks near a plotted point</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            event : MouseEvent</span>
<span class="sd">                The mouse-related event; contains location information</span>
<span class="sd">            """</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">!=</span> <span class="n">ax</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">cont</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="n">pnum</span> <span class="o">=</span> <span class="n">lines_pnums</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rownum</span> <span class="o">=</span> <span class="n">pnum</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="s2">"ind"</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"This is pulse# </span><span class="si">{</span><span class="n">rownum</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">rownum</span><span class="p">,</span> <span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">"motion_notify_event"</span><span class="p">,</span> <span class="n">hover</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">"button_press_event"</span><span class="p">,</span> <span class="n">click</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_col</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_col</span><span class="p">))</span>
    <span class="n">title_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span><span class="si">}</span>
<span class="s2">    use_expr=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="si">}</span>
<span class="s2">    good_expr=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="si">}</span><span class="s2">"""</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">color_col</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.plot_summaries">
<code class="highlight language-python"><span class="n">plot_summaries</span><span class="p">(</span><span class="n">use_expr_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot a summary of the data set, including time series and histograms of key pulse properties.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>use_expr_in</code></b>
                  (<code><span title="polars.Expr">Expr</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A polars expression to determine valid pulses, by default None. If None, use <code>self.good_expr</code></p>
</div>
</li>
<li>
<b><code>downsample</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Plot only every one of <code>downsample</code> pulses in the scatter plots, by default None.
If None, choose the smallest value so that no more than 10000 points appear</p>
</div>
</li>
<li>
<b><code>log</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to make the histograms have a logarithmic y-scale, by default False.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_expr_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">downsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot a summary of the data set, including time series and histograms of key pulse properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    use_expr_in: pl.Expr | None, optional</span>
<span class="sd">        A polars expression to determine valid pulses, by default None. If None, use `self.good_expr`</span>
<span class="sd">    downsample: int | None, optional</span>
<span class="sd">        Plot only every one of `downsample` pulses in the scatter plots, by default None.</span>
<span class="sd">        If None, choose the smallest value so that no more than 10000 points appear</span>
<span class="sd">    log: bool, optional</span>
<span class="sd">        Whether to make the histograms have a logarithmic y-scale, by default False.</span>
<span class="sd">    """</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">tpi_microsec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
    <span class="n">plottables</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="s2">"Pulse RMS"</span><span class="p">,</span> <span class="s2">"#dd00ff"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"pulse_average"</span><span class="p">,</span> <span class="s2">"Pulse Avg"</span><span class="p">,</span> <span class="s2">"purple"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"peak_value"</span><span class="p">,</span> <span class="s2">"Peak value"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">,</span> <span class="s2">"Pretrig RMS"</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="s2">"Pretrig Mean"</span><span class="p">,</span> <span class="s2">"#00ff26"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">,</span> <span class="s2">"Max PostPk deriv"</span><span class="p">,</span> <span class="s2">"gold"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">,</span> <span class="s2">"Rise time (s)"</span><span class="p">,</span> <span class="s2">"orange"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">,</span> <span class="s2">"Peak time (s)"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="n">use_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="k">if</span> <span class="n">use_expr_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">use_expr_in</span>

    <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">//</span> <span class="mi">10000</span>
    <span class="n">downsample</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">downsample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">gather_every</span><span class="p">(</span><span class="n">downsample</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"peak_index"</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"rise_time"</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">))</span>
    <span class="n">existing_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
    <span class="n">preserve</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plottables</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">]</span>
    <span class="n">preserve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">preserve</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Plot timeseries relative to 0 = the last 00 UT during or before the run.</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">last_midnight</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"datetime64[D]"</span><span class="p">)</span>
    <span class="n">hour_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">last_midnight</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600e6</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plottables</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Time series scatter plots (left-hand panels)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hour_rel</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Time since last UT midnight (hours)"</span><span class="p">)</span>

        <span class="c1"># Histogram (right-hand panels)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">contents</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">"stepfilled"</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">contents</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Plotting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="si">}</span><span class="s2"> data points"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.rough_cal">
<code class="highlight language-python"><span class="n">rough_cal</span><span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">uncalibrated_col</span><span class="o">=</span><span class="s1">'filtValue'</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_gain_fraction_at_ph_30k</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">n_extra_peaks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">acceptable_rms_residual_e</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Learn a rough calibration by trying to assign the 3 brightest peaks,
then fitting a line to those and looking for other peaks that fit that line.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rough_cal</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"filtValue"</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
    <span class="n">n_extra_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">acceptable_rms_residual_e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Learn a rough calibration by trying to assign the 3 brightest peaks,</span>
<span class="sd">    then fitting a line to those and looking for other peaks that fit that line.</span>
<span class="sd">    """</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_3peak</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">,</span>
        <span class="n">uncalibrated_col</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">,</span>
        <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">,</span>
        <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">,</span>
        <span class="n">fwhm_pulse_height_units</span><span class="p">,</span>
        <span class="n">n_extra_peaks</span><span class="p">,</span>
        <span class="n">acceptable_rms_residual_e</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.rough_cal_combinatoric">
<code class="highlight language-python"><span class="n">rough_cal_combinatoric</span><span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">ph_smoothing_fwhm</span><span class="p">,</span> <span class="n">n_extra</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Learn a rough calibration by trying all combinatorically possible peak assignments.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rough_cal_combinatoric</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Learn a rough calibration by trying all combinatorically possible peak assignments."""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_combinatoric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">,</span>
        <span class="n">uncalibrated_col</span><span class="o">=</span><span class="n">uncalibrated_col</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.rough_cal_combinatoric_height_info">
<code class="highlight language-python"><span class="n">rough_cal_combinatoric_height_info</span><span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">line_heights_allowed</span><span class="p">,</span> <span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">ph_smoothing_fwhm</span><span class="p">,</span> <span class="n">n_extra</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
</h3>
<div class="doc doc-contents">
<p>Learn a rough calibration by trying all combinatorically possible peak assignments,
using known relative peak heights to limit the possibilities.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rough_cal_combinatoric_height_info</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Learn a rough calibration by trying all combinatorically possible peak assignments,</span>
<span class="sd">    using known relative peak heights to limit the possibilities."""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_combinatoric_height_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">,</span>
        <span class="n">line_heights_allowed</span><span class="p">,</span>
        <span class="n">uncalibrated_col</span><span class="o">=</span><span class="n">uncalibrated_col</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.save_recipes">
<code class="highlight language-python"><span class="n">save_recipes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Save the recipe steps to a pickle file, keyed by channel number.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Save the recipe steps to a pickle file, keyed by channel number."""</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
    <span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">steps</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.step_plot">
<code class="highlight language-python"><span class="n">step_plot</span><span class="p">(</span><span class="n">step_ind</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a debug plot for the given step index, supporting negative indices.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">step_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a debug plot for the given step index, supporting negative indices."""</span>
    <span class="n">step</span><span class="p">,</span> <span class="n">step_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step</span><span class="p">(</span><span class="n">step_ind</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">step_ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_history</span><span class="p">):</span>
        <span class="n">df_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_history</span><span class="p">[</span><span class="n">step_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.step_summary">
<code class="highlight language-python"><span class="n">step_summary</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a list of (step type name, elapsed time in seconds) for each step in the recipe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">step_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""Return a list of (step type name, elapsed time in seconds) for each step in the recipe."""</span>
    <span class="k">return</span> <span class="p">[(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_elapsed_s</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.summarize_pulses">
<code class="highlight language-python"><span class="n">summarize_pulses</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">pretrigger_ignore_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">peak_index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Summarize the pulses, adding columns for pulse height, pretrigger mean, etc.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">summarize_pulses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">pretrigger_ignore_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">peak_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Summarize the pulses, adding columns for pulse height, pretrigger mean, etc."""</span>
    <span class="k">if</span> <span class="n">peak_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">peak_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">out_names</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">result_dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="c1"># mypy (incorrectly) thinks `out_names` might be None, and `list(None)` is forbidden. Assertion makes it happy again.</span>
    <span class="k">assert</span> <span class="n">out_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_names</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">SummarizeStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">frametime_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="n">peak_index</span><span class="o">=</span><span class="n">peak_index</span><span class="p">,</span>
        <span class="n">pulse_col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">pretrigger_ignore_samples</span><span class="o">=</span><span class="n">pretrigger_ignore_samples</span><span class="p">,</span>
        <span class="n">n_presamples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
        <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.typical_peak_ind">
<code class="highlight language-python"><span class="n">typical_peak_ind</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-cached"><code>cached</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the typical peak index of the given column, using the median peak index for the first 100 pulses.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">typical_peak_ind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the typical peak index of the given column, using the median peak index for the first 100 pulses."""</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_categorize_step">
<code class="highlight language-python"><span class="n">with_categorize_step</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="p">,</span> <span class="n">output_col</span><span class="o">=</span><span class="s1">'category'</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Add a recipe step that categorizes pulses based on the given conditions.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_categorize_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_condition_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">],</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"category"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add a recipe step that categorizes pulses based on the given conditions."""</span>
    <span class="c1"># ensure the first condition is True, to be used as a fallback</span>
    <span class="n">first_expr</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
        <span class="n">category_condition_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"fallback"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="o">**</span><span class="n">category_condition_dict</span><span class="p">}</span>
    <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">CategorizeStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">output_col</span><span class="p">],</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">category_condition_dict</span><span class="o">=</span><span class="n">category_condition_dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_column_map_step">
<code class="highlight language-python"><span class="n">with_column_map_step</span><span class="p">(</span><span class="n">input_col</span><span class="p">,</span> <span class="n">output_col</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>f should take a numpy array and return a numpy array with the same number of elements</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_column_map_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""f should take a numpy array and return a numpy array with the same number of elements"""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">ColumnAsNumpyMapStep</span><span class="p">([</span><span class="n">input_col</span><span class="p">],</span> <span class="p">[</span><span class="n">output_col</span><span class="p">],</span> <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_columns">
<code class="highlight language-python"><span class="n">with_columns</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Append columns from df2 to the existing dataframe, keeping all other attributes the same.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Append columns from df2 to the existing dataframe, keeping all other attributes the same."""</span>
    <span class="n">df3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df3</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_experiment_state_df">
<code class="highlight language-python"><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">,</span> <span class="n">force_timestamp_monotonic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Add experiment states from an existing dataframe</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_es</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">force_timestamp_monotonic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add experiment states from an existing dataframe"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">is_sorted</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span><span class="o">.</span><span class="n">cum_max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)))</span>
        <span class="c1"># print("WARNING: in with_experiment_state_df, timestamp is not monotonic, forcing it to be")</span>
        <span class="c1"># print("This is likely a BUG in DASTARD.")</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_es</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"timestamp"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"backward"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_external_trigger_df">
<code class="highlight language-python"><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Add external trigger times from an existing dataframe</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_ext</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Add external trigger times from an existing dataframe"""</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="c1"># Expect "subframecount" will be in the dataframe for LJH 2.2 files, but have to add it for OFF files:</span>
    <span class="k">if</span> <span class="s2">"subframecount"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">subframecount</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"framecount"</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_ext</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"backward"</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"_prev_ext_trig"</span><span class="p">)</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span>
        <span class="n">df_ext</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"forward"</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"_next_ext_trig"</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_good_expr">
<code class="highlight language-python"><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a new Channel with the given good_expr, combined with the existing good_expr by "and",
of by replacing it entirely if <code>replace</code> is True.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a new Channel with the given good_expr, combined with the existing good_expr by "and",</span>
<span class="sd">    of by replacing it entirely if `replace` is True."""</span>
    <span class="c1"># the default value of self.good_expr is pl.lit(True)</span>
    <span class="c1"># and_(True) will just add visual noise when looking at good_expr and not affect behavior</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span> <span class="ow">and</span> <span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
        <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_expr</span><span class="o">=</span><span class="n">good_expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_good_expr_below_nsigma_outlier_resistant">
<code class="highlight language-python"><span class="n">with_good_expr_below_nsigma_outlier_resistant</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set good_expr to exclude pulses with any of the given columns above outlier-resistant thresholds.
Always sets lower limit at 0, so don't use for values that can be negative</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_below_nsigma_outlier_resistant</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Set good_expr to exclude pulses with any of the given columns above outlier-resistant thresholds.</span>
<span class="sd">    Always sets lower limit at 0, so don't use for values that can be negative</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
        <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
        <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_good_expr_nsigma_range_outlier_resistant">
<code class="highlight language-python"><span class="n">with_good_expr_nsigma_range_outlier_resistant</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set good_expr to exclude pulses with any of the given columns above outlier-resistant thresholds.
Always sets lower limit at 0, so don't use for values that can be negative</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_nsigma_range_outlier_resistant</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Set good_expr to exclude pulses with any of the given columns above outlier-resistant thresholds.</span>
<span class="sd">    Always sets lower limit at 0, so don't use for values that can be negative</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
        <span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_range_from_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
        <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_good_expr_pretrig_rms_and_postpeak_deriv">
<code class="highlight language-python"><span class="n">with_good_expr_pretrig_rms_and_postpeak_deriv</span><span class="p">(</span><span class="n">n_sigma_pretrig_rms</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_sigma_postpeak_deriv</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set good_expr to exclude pulses with pretrigger RMS or postpeak derivative above outlier-resistant thresholds.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_pretrig_rms_and_postpeak_deriv</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">n_sigma_pretrig_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_sigma_postpeak_deriv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Set good_expr to exclude pulses with pretrigger RMS or postpeak derivative above outlier-resistant thresholds."""</span>
    <span class="n">max_postpeak_deriv</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"postpeak_deriv"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_postpeak_deriv</span>
    <span class="p">)</span>
    <span class="n">max_pretrig_rms</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"pretrig_rms"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_pretrig_rms</span><span class="p">)</span>
    <span class="n">good_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_postpeak_deriv</span><span class="p">)</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_pretrig_rms</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_range_around_median">
<code class="highlight language-python"><span class="n">with_range_around_median</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">range_up</span><span class="p">,</span> <span class="n">range_down</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Set good_expr to exclude pulses with <code>col</code> outside the given range around its median.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_range_around_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">range_up</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">range_down</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Set good_expr to exclude pulses with `col` outside the given range around its median."""</span>
    <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">med</span> <span class="o">-</span> <span class="n">range_down</span><span class="p">,</span> <span class="n">med</span> <span class="o">+</span> <span class="n">range_up</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_replacement_df">
<code class="highlight language-python"><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Replace the dataframe with a new one, keeping all other attributes the same.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_replacement_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Replace the dataframe with a new one, keeping all other attributes the same."""</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_select_step">
<code class="highlight language-python"><span class="n">with_select_step</span><span class="p">(</span><span class="n">col_expr_dict</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>This step is meant for interactive exploration; it's basically like the df.select() method, but it's saved as a step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_select_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_expr_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This step is meant for interactive exploration; it's basically like the df.select() method, but it's saved as a step.</span>
<span class="sd">    """</span>
    <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">col_expr_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">SelectStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
        <span class="n">output</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">col_expr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">col_expr_dict</span><span class="o">=</span><span class="n">col_expr_dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_step">
<code class="highlight language-python"><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a new Channel with the given step applied to generate new columns in the dataframe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">RecipeStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a new Channel with the given step applied to generate new columns in the dataframe."""</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
    <span class="n">elapsed_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
    <span class="n">ch2</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">df_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_history</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">],</span>
        <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
        <span class="n">steps_elapsed_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_elapsed_s</span> <span class="o">+</span> <span class="p">[</span><span class="n">elapsed_s</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ch2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_steps">
<code class="highlight language-python"><span class="n">with_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a new Channel with the given steps applied to generate new columns in the dataframe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="n">Recipe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a new Channel with the given steps applied to generate new columns in the dataframe."""</span>
    <span class="n">ch2</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="n">ch2</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ch2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.channel.ChannelHeader">
<code>ChannelHeader</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Metadata about a Channel, of the sort read from file header.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChannelHeader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Metadata about a Channel, of the sort read from file header."""</span>

    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># filename or date/run number, etc</span>
    <span class="n">data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>  <span class="c1"># complete file path, if read from a file</span>
    <span class="n">ch_num</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">n_presamples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_header_df</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ChannelHeader"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Construct from the LJH header dataframe as returned by LJHFile.to_polars()"""</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">data_source</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
            <span class="n">ch_num</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Channel"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">frametime_s</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Timebase"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">n_presamples</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Presamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">n_samples</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Total Samples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.ChannelHeader.from_ljh_header_df">
<code class="highlight language-python"><span class="n">from_ljh_header_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Construct from the LJH header dataframe as returned by LJHFile.to_polars()</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_header_df</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ChannelHeader"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Construct from the LJH header dataframe as returned by LJHFile.to_polars()"""</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">data_source</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
        <span class="n">ch_num</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Channel"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">frametime_s</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Timebase"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">n_presamples</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Presamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"Total Samples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.channels"></a>
<div class="doc doc-contents first">
<p>Data structures and methods for handling a group of microcalorimeter channels.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.channels.Channels">
<code>Channels</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A collection of microcalorimeter channels, with methods to operate in parallel on all channels.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PLR0904</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Channels</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A collection of microcalorimeter channels, with methods to operate in parallel on all channels."""</span>

    <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">bad_channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">BadChannel</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ch0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a representative Channel object for convenient exploration (the one with the lowest channel number)."""</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"channels must be non-empty"</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_more_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">more</span><span class="p">:</span> <span class="s2">"Channels"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a Channels object with additional Channels in it.</span>
<span class="sd">        New channels with the same number will overrule existing ones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        more : Channels</span>
<span class="sd">            Another Channels object, to be added</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channels</span>
<span class="sd">            The replacement</span>
<span class="sd">        """</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">channels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">more</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bad</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">more</span><span class="o">.</span><span class="n">bad_channels</span><span class="p">)</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="n">more</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Warning! created by with_more_channels()"</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">bad</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">descr</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a DataFrame containing good pulses from each channel. Excludes the given columns (default "pulse")."""</span>
        <span class="c1"># return a dataframe containing good pulses from each channel,</span>
        <span class="c1"># exluding "pulse" by default</span>
        <span class="c1"># and including column "ch_num"</span>
        <span class="c1"># the more common call should be to wrap this in a convenient plotter</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
            <span class="c1"># key_series = pl.Series("key", dtype=pl.Int64).extend_constant(key, len(df))</span>
            <span class="k">assert</span> <span class="n">ch_num</span> <span class="o">==</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span>
            <span class="n">ch_series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">"ch_num"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">extend_constant</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ch_series</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linefit</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="n">GenericLineModel</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Perform a fit to one spectral line in the coadded histogram of the given column."""</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
        <span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pe</span> <span class="o">-</span> <span class="n">dlo</span><span class="p">,</span> <span class="n">pe</span> <span class="o">+</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_bin_edges</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"before update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_update</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"after update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">ds_shortname</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
            <span class="n">attr_str</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">use_expr</span><span class="si">=}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot a histogram for the given column across all channels."""</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - col (str): The column name to plot.</span>
<span class="sd">        - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">        - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">        - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot a histogram for each group</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Get the data for the column to plot</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="c1"># Plot the histogram for the current group</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">"EBIT"</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"k"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
            <span class="c1"># bin_centers, counts = mass2.misc.hist_of_series(values, bin_edges)</span>
            <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>

        <span class="c1"># Customize the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Frequency"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Coadded Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Add a legend to label the groups</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_limited_chan_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""A helper to get a list of channel numbers, limited to the given number if needed, and including only</span>
<span class="sd">        channel numbers from `channels` if not None."""</span>
        <span class="n">limited_chan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limited_chan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">limited_chan</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">)))</span>
            <span class="n">limited_chan</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_chan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">limited_chan</span> <span class="o">=</span> <span class="n">limited_chan</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">limited_chan</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_filters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the optimal filters for the channels in this Channels object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        limit : int | None, optional</span>
<span class="sd">            Plot at most this many filters if not None, by default 20</span>
<span class="sd">        channels : list[int] | None, optional</span>
<span class="sd">            Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">        colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">            The color scale to use, by default plt.cm.viridis</span>
<span class="sd">        axis : plt.Axes | None, optional</span>
<span class="sd">            A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The `plt.Axes` containing the plot.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="c1"># The next line _assumes_ a 5-lag filter. Fix as needed.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_filter</span>
            <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Samples after trigger"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Optimal filters"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_avg_pulses</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the average pulses (the signal model) for the channels in this Channels object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        limit : int | None, optional</span>
<span class="sd">            Plot at most this many filters if not None, by default 20</span>
<span class="sd">        channels : list[int] | None, optional</span>
<span class="sd">            Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">        colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">            The color scale to use, by default plt.cm.viridis</span>
<span class="sd">        axis : plt.Axes | None, optional</span>
<span class="sd">            A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The `plt.Axes` containing the plot.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">-</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_avg_pulse</span>
            <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Samples after trigger"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Average pulses"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_noise_spectrum</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the noise power spectrum for the channels in this Channels object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        limit : int | None, optional</span>
<span class="sd">            Plot at most this many filters if not None, by default 20</span>
<span class="sd">        channels : list[int] | None, optional</span>
<span class="sd">            Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">        colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">            The color scale to use, by default plt.cm.viridis</span>
<span class="sd">        axis : plt.Axes | None, optional</span>
<span class="sd">            A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The `plt.Axes` containing the plot.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">freqpsd</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_noise_psd</span>
            <span class="k">if</span> <span class="n">freqpsd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">freq</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">freqpsd</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Noise power spectral density"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_noise_autocorr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the noise power autocorrelation for the channels in this Channels object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        limit : int | None, optional</span>
<span class="sd">            Plot at most this many filters if not None, by default 20</span>
<span class="sd">        channels : list[int] | None, optional</span>
<span class="sd">            Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">        colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">            The color scale to use, by default plt.cm.viridis</span>
<span class="sd">        axis : plt.Axes | None, optional</span>
<span class="sd">            A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plt.Axes</span>
<span class="sd">            The `plt.Axes` containing the plot.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_noise_autocorrelation</span>
            <span class="k">if</span> <span class="n">ac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Lags"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Noise autocorrelation"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">allow_throw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Map function `f` over all channels, returning a new Channels object containing the new Channel objects."""</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">kint</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">kint</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">allow_throw</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">channel</span><span class="si">=}</span><span class="s2"> failed the step </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">error_type</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">error_message</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">new_bad_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">as_bad</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">error_message</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span>
        <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">merge_dicts_ordered_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">new_bad_channels</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">new_bad_channels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">require_ch_num_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with the given channel number marked as bad."""</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">require_ch_num_exists</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2"> can't be set bad because it does not exist"</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ch_num</span><span class="p">:</span>
                <span class="n">new_bad_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">as_bad</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">new_bad_channels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linefit_joblib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"threads"</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""No one but Galen understands this function."""</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""A unit of parallel work: fit line to one channel."""</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">linefit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="n">prefer</span><span class="p">)</span>  <span class="c1"># its not clear if threads are better.... what blocks the gil?</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">work</span><span class="p">)(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Hash based on the object's id (identity)."""</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Equality test based on object identity."""</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_path_pairs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Create a :class:`Channels` instance from pairs of LJH files.</span>

<span class="sd">        Args:</span>
<span class="sd">            pulse_noise_pairs (List[Tuple[str, str]]):</span>
<span class="sd">                A list of `(pulse_path, noise_path)` tuples, where each entry contains</span>
<span class="sd">                the file path to a pulse LJH file and its corresponding noise LJH file.</span>
<span class="sd">            description (str):</span>
<span class="sd">                A human-readable description for the resulting Channels object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Channels:</span>
<span class="sd">                A Channels object with one :class:`Channel` per `(pulse_path, noise_path)` pair.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError:</span>
<span class="sd">                If two input files correspond to the same channel number.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Each channel is created via :meth:`Channel.from_ljh`.</span>
<span class="sd">            The channel number is taken from the LJH file header and used as the key</span>
<span class="sd">            in the returned Channels mapping.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; pairs = [</span>
<span class="sd">            ...     ("datadir/run0000_ch0000.ljh", "datadir/run0001_ch0000.ljh"),</span>
<span class="sd">            ...     ("datadir/run0000_ch0001.ljh", "datadir/run0001_ch0001.ljh"),</span>
<span class="sd">            ... ]</span>
<span class="sd">            &gt;&gt;&gt; channels = Channels.from_ljh_path_pairs(pairs, description="Test run")</span>
<span class="sd">            &gt;&gt;&gt; list(channels.keys())</span>
<span class="sd">            [0, 1]</span>
<span class="sd">        """</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span> <span class="ow">in</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_off_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">off_paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an instance from a sequence of OFF-file paths"""</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">off_paths</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_off</span><span class="p">(</span><span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">OffFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_folder</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">pulse_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">noise_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create an instance from a directory of LJH files."""</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
        <span class="n">pulse_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude_ch_nums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude_ch_nums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">noise_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">find_ljh_files</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="n">include_ch_nums</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">path</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">noise_folder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
            <span class="n">noise_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_folder</span><span class="p">)</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">match_files_by_channel</span><span class="p">(</span>
                <span class="n">pulse_folder</span><span class="p">,</span> <span class="n">noise_folder</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="n">include_ch_nums</span>
            <span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"from_ljh_folder </span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   from_ljh_folder has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_ljh_path_pairs</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   and the Channels obj has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_an_ljh_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the path to a representative one of the LJH files used to create this Channels object."""</span>
        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_path_in_output_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a path in an output folder named like the run number, sibling to the LJH folder."""</span>
        <span class="n">ljh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_an_ljh_path</span><span class="p">()</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_chan"</span><span class="p">)</span>
        <span class="n">date</span><span class="p">,</span> <span class="n">run_num</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_run"</span><span class="p">)</span>  <span class="c1"># timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">run_num</span><span class="si">}</span><span class="s2">mass2_output"</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a DataFrame containing experiment state information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        experiment_state_path : str | Path | None, optional</span>
<span class="sd">            load experiment state info from the given path or (if None) infer the path from an LJH file, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pl.DataFrame</span>
<span class="sd">            A Data Frame with a table of experiment state labels and the corresponding start time (in Polars timestamp format).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">experiment_state_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ljh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_an_ljh_path</span><span class="p">()</span>
            <span class="n">experiment_state_path</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">experiment_state_path_from_ljh_path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="p">,</span> <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="s2">"state_label"</span><span class="p">])</span>
        <span class="n">df_es</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"ns"</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span>

        <span class="c1"># Strip leading/trailing whitespace from state labels. Convert string -&gt; categorical</span>
        <span class="n">df_labels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"state_label"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip_chars</span><span class="p">())</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Categorical</span><span class="p">)</span>
        <span class="n">df_es</span> <span class="o">=</span> <span class="n">df_es</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df_labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_es</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_es</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with experiment state information added to each Channel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_es : pl.DataFrame</span>
<span class="sd">            experiment state info</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channels</span>
<span class="sd">            An enhanced copy of self, with experiment state information added to each channel.</span>
<span class="sd">        """</span>
        <span class="c1"># TODO: the following is less performant than making a use_expr for each state,</span>
        <span class="c1"># and using .set_sorted on the timestamp column.</span>
        <span class="n">ch2s</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ch2s</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">ch2s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with experiment state information added to each Channel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        experiment_state_path : str | Path | None, optional</span>
<span class="sd">            load experiment state info from the given path or (if None) infer the path from an LJH file, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channels</span>
<span class="sd">            An enhanced copy of self, with experiment state information added to each channel.</span>
<span class="sd">        """</span>
        <span class="n">df_es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_state_df</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with external trigger information added, loaded</span>
<span class="sd">        from the given path or EVENTUALLY (if None) inferring it from an LJH file (not yet implemented)."""</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"cannot infer external trigger path yet"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">_f</span><span class="p">:</span>
            <span class="n">_header_line</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># read the one header line before opening the binary data</span>
            <span class="n">external_trigger_subframe_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">_f</span><span class="p">,</span> <span class="s2">"int64"</span><span class="p">)</span>
        <span class="n">df_ext</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"subframecount"</span><span class="p">:</span> <span class="n">external_trigger_subframe_count</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_ext</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with external trigger information added to each Channel,</span>
<span class="sd">        found from the given DataFrame."""</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">with_etrig_df</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Return a copy of one Channel object with external trigger information added to it"""</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">with_etrig_df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_steps_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with the given Recipe objects added to each Channel."""</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">load_recipes</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Return a copy of one Channel object with Recipe steps added to it"""</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">steps_dict</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"steps dict did not contain steps for this ch_num"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">with_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_recipes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Pickle a dictionary (one entry per channel) of Recipe objects.</span>

<span class="sd">        If you want to save a "recipe", a minimal series of steps required to reproduce the required field(s),</span>
<span class="sd">        then set `required_fields` to be a list/tuple/set of DataFrame column names (or a single column name)</span>
<span class="sd">        whose production from raw data should be possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Filename to store recipe in, typically of the form "*.pkl"</span>
<span class="sd">        required_fields : str | Iterable[str] | None</span>
<span class="sd">            The field (str) or fields (Iterable[str]) that the recipe should be able to generate from a raw LJH file.</span>
<span class="sd">            Drop all steps that do not lead (directly or indireactly) to producing this field or these fields.</span>
<span class="sd">            If None, then preserve all steps (default None).</span>
<span class="sd">        drop_debug: bool</span>
<span class="sd">            Whether to remove debugging-related data from each `RecipeStep`, if the subclass supports this (via the</span>
<span class="sd">            `RecipeStep.drop_debug() method).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with keys=channel numbers, values=the (possibly trimmed and debug-dropped) Recipe objects.</span>
<span class="sd">        """</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channum</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">steps</span><span class="p">[</span><span class="n">channum</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">trim_dead_ends</span><span class="p">(</span><span class="n">required_fields</span><span class="o">=</span><span class="n">required_fields</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="n">drop_debug</span><span class="p">)</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this Channels object with Recipe objects loaded from the given pickle file</span>
<span class="sd">        and applied to each Channel."""</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">unpickle_object</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_steps_dict</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parent_folder_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the parent folder of the LJH files used to create this Channels object. Specifically, the</span>
<span class="sd">        `self.ch0` channel's directory is used (normally the answer would be the same for all channels)."""</span>
        <span class="n">parent_folder_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parent_folder_path</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_folder_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concat_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_data</span><span class="p">:</span> <span class="s2">"Channels"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a new Channels object with data from this and the other Channels object concatenated together.</span>
<span class="sd">        Only channels that exist in both objects are included in the result."""</span>
        <span class="c1"># sorting here to show intention, but I think set is sorted by insertion order as</span>
        <span class="c1"># an implementation detail so this may not do anything</span>
        <span class="n">ch_nums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="n">ch_nums</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">other_ch</span> <span class="o">=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">combined_df</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">other_ch</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="n">new_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
            <span class="n">new_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ch</span>
        <span class="k">return</span> <span class="n">mass2</span><span class="o">.</span><span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="n">other_data</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_df</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">df_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_presamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"from Channels.channels_from_df"</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a Channels object from a single DataFrame that holds data from multiple channels."""</span>
        <span class="c1"># requres a column named "ch_num" containing the channel number</span>
        <span class="n">keys_df</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">partition_by</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">"ch_num"</span><span class="p">],</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">df</span> <span class="k">for</span> <span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_df</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">ChannelHeader</span><span class="p">(</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">"from df"</span><span class="p">,</span>
                    <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">ch_num</span><span class="o">=</span><span class="n">ch_num</span><span class="p">,</span>
                    <span class="n">frametime_s</span><span class="o">=</span><span class="n">frametime_s</span><span class="p">,</span>
                    <span class="n">n_presamples</span><span class="o">=</span><span class="n">n_presamples</span><span class="p">,</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">trim_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">trim_timestamp_and_subframecount</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Save an analysis-in-progress completely to a zip file, only tested for ljh backed channels so far</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : Path | str</span>
<span class="sd">            Directory to save work in. If it doesn't exist, its parent should.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If `path` exists, whether to overwrite it, by default False</span>
<span class="sd">        trim_debug : bool, optional</span>
<span class="sd">            Whether to make save file smaller (potentially) at the cost of breaking some debugging plots, by default False</span>
<span class="sd">        trim_timestamp_and_subframecount: bool, optional</span>
<span class="sd">            Whether to make the save file smaller at the cost of reduced information avaialble when the ljh files are</span>
<span class="sd">            not available, eg when loading on another computer.</span>
<span class="sd">        """</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">".zip"</span><span class="p">:</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">".zip"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File exists; use `save_analysis(...overwrite=True)` to overwrite the existing </span><span class="si">{</span><span class="n">zip_path</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">store_dataframe_to_parquet_and_return_pickleable_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">zf</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">parquet_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Store the `ch.df` to a parquet file of the given name in the ZipFile (open for writing).</span>
<span class="sd">            Prepare `ch` for pickling by removing its dataframe and dataframe history, and stripping debug info from `steps`</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ch : Channel</span>
<span class="sd">                The channel to modify by storing dataframe to parquet and removing it.</span>
<span class="sd">            zf : ZipFile</span>
<span class="sd">                A ZipFile object currently open for writing.</span>
<span class="sd">            parquet_file : str</span>
<span class="sd">                The name to use for storing the parquet file within `zf`</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Channel</span>
<span class="sd">                A copy of `ch` amenable to pickling with the dataframe and dataframe history removed and with trimmed steps.</span>
<span class="sd">            """</span>
            <span class="c1"># Don't store the memmapped LJH pulse info (if present) in the Parquet file</span>
            <span class="k">if</span> <span class="n">trim_timestamp_and_subframecount</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">,</span> <span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">,</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">trim_debug</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">trim_debug_info</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span>
            <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">df_history</span><span class="o">=</span><span class="p">[],</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_path</span><span class="p">),</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">parquet_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
                <span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">store_dataframe_to_parquet_and_return_pickleable_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">parquet_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">badch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">parquet_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_bad_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">store_dataframe_to_parquet_and_return_pickleable_channel</span><span class="p">(</span><span class="n">badch</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">parquet_path</span><span class="p">)</span>
                <span class="n">bad_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">badch</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">bad_channels</span><span class="p">)</span>
            <span class="n">pickle_file</span> <span class="o">=</span> <span class="s2">"data_all.pkl"</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="n">dill</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_analysis</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load an analysis-in-progress from a zipfile</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : Path | str</span>
<span class="sd">            Zipfile that work was saved in.</span>
<span class="sd">        """</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_restore_dataframe</span><span class="p">(</span><span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Take a channel and replace its dataframe with the given one, loaded from a parquet file</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ch : Channel</span>
<span class="sd">                A channel, loaded from a pickle file, with an empty dataframe</span>
<span class="sd">            df : DataFrame</span>
<span class="sd">                A replacement dataframe for the existing one (typically, the existing one is empty)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Channel</span>
<span class="sd">                The Channel `ch` but with `ch.df` updated, including any raw data backed by an LJH file</span>
<span class="sd">            """</span>
            <span class="c1"># If this channel was based on an LJH file, restore columns from the LJH file to the dataframe.</span>
            <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">data_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ljh_path</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">data_source</span>
                <span class="k">if</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".ljh"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".noi"</span><span class="p">):</span>
                    <span class="n">ljh_backed_chan</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ljh_backed_chan</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="c1"># df_history is needed for some debug plots to work. This version has strictly more columns than required</span>
            <span class="c1"># at each history point. TODO: We could use the steps inputs and outputs to trim the appropriate columns.</span>
            <span class="c1"># For getting started, though, it's easier just to let each dataframe in history equal the final dataframe.</span>
            <span class="n">df_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">df_history</span><span class="o">=</span><span class="n">df_history</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="n">pickle_file</span> <span class="o">=</span> <span class="s2">"data_all.pkl"</span>
            <span class="n">pickle_bytes</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">Channels</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle_bytes</span><span class="p">)</span>

            <span class="n">restored_channels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">parquet_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">))</span>
                <span class="n">restored_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">_restore_dataframe</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

            <span class="n">restored_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">badch</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bad_channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">parquet_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_bad_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">))</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">_restore_dataframe</span><span class="p">(</span><span class="n">badch</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
                <span class="n">restored_bad_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">badch</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="n">ch</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">restored_channels</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">restored_bad_channels</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.ch0">
<code class="highlight language-python"><span class="n">ch0</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a representative Channel object for convenient exploration (the one with the lowest channel number).</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.__eq__">
<code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Equality test based on object identity.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Equality test based on object identity."""</span>
    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.__hash__">
<code class="highlight language-python"><span class="fm">__hash__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Hash based on the object's id (identity).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Hash based on the object's id (identity)."""</span>
    <span class="c1"># needed to make functools.cache work</span>
    <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
    <span class="c1"># and we may get nonsense results</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.concat_data">
<code class="highlight language-python"><span class="n">concat_data</span><span class="p">(</span><span class="n">other_data</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a new Channels object with data from this and the other Channels object concatenated together.
Only channels that exist in both objects are included in the result.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">concat_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_data</span><span class="p">:</span> <span class="s2">"Channels"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a new Channels object with data from this and the other Channels object concatenated together.</span>
<span class="sd">    Only channels that exist in both objects are included in the result."""</span>
    <span class="c1"># sorting here to show intention, but I think set is sorted by insertion order as</span>
    <span class="c1"># an implementation detail so this may not do anything</span>
    <span class="n">ch_nums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="n">ch_nums</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="n">other_ch</span> <span class="o">=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">other_ch</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">new_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
        <span class="n">new_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ch</span>
    <span class="k">return</span> <span class="n">mass2</span><span class="o">.</span><span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="n">other_data</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.dfg">
<code class="highlight language-python"><span class="n">dfg</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-cached"><code>cached</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a DataFrame containing good pulses from each channel. Excludes the given columns (default "pulse").</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a DataFrame containing good pulses from each channel. Excludes the given columns (default "pulse")."""</span>
    <span class="c1"># return a dataframe containing good pulses from each channel,</span>
    <span class="c1"># exluding "pulse" by default</span>
    <span class="c1"># and including column "ch_num"</span>
    <span class="c1"># the more common call should be to wrap this in a convenient plotter</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="c1"># key_series = pl.Series("key", dtype=pl.Int64).extend_constant(key, len(df))</span>
        <span class="k">assert</span> <span class="n">ch_num</span> <span class="o">==</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span>
        <span class="n">ch_series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">"ch_num"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">extend_constant</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ch_series</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.from_df">
<code class="highlight language-python"><span class="n">from_df</span><span class="p">(</span><span class="n">df_in</span><span class="p">,</span> <span class="n">frametime_s</span><span class="p">,</span> <span class="n">n_presamples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">'from Channels.channels_from_df'</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a Channels object from a single DataFrame that holds data from multiple channels.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_df</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">df_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_presamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"from Channels.channels_from_df"</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Channels object from a single DataFrame that holds data from multiple channels."""</span>
    <span class="c1"># requres a column named "ch_num" containing the channel number</span>
    <span class="n">keys_df</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">partition_by</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">"ch_num"</span><span class="p">],</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">df</span> <span class="k">for</span> <span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_df</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">ChannelHeader</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">"from df"</span><span class="p">,</span>
                <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">ch_num</span><span class="o">=</span><span class="n">ch_num</span><span class="p">,</span>
                <span class="n">frametime_s</span><span class="o">=</span><span class="n">frametime_s</span><span class="p">,</span>
                <span class="n">n_presamples</span><span class="o">=</span><span class="n">n_presamples</span><span class="p">,</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.from_ljh_folder">
<code class="highlight language-python"><span class="n">from_ljh_folder</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">,</span> <span class="n">noise_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create an instance from a directory of LJH files.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_folder</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">pulse_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">noise_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create an instance from a directory of LJH files."""</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
    <span class="n">pulse_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exclude_ch_nums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude_ch_nums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">noise_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">find_ljh_files</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="n">include_ch_nums</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">path</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">noise_folder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
        <span class="n">noise_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_folder</span><span class="p">)</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">match_files_by_channel</span><span class="p">(</span>
            <span class="n">pulse_folder</span><span class="p">,</span> <span class="n">noise_folder</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="n">include_ch_nums</span>
        <span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"from_ljh_folder </span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   from_ljh_folder has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs"</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_ljh_path_pairs</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   and the Channels obj has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.from_ljh_path_pairs">
<code class="highlight language-python"><span class="n">from_ljh_path_pairs</span><span class="p">(</span><span class="n">pulse_noise_pairs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a :class:<code>Channels</code> instance from pairs of LJH files.</p>
<p>Args:
    pulse_noise_pairs (List[Tuple[str, str]]):
        A list of <code>(pulse_path, noise_path)</code> tuples, where each entry contains
        the file path to a pulse LJH file and its corresponding noise LJH file.
    description (str):
        A human-readable description for the resulting Channels object.</p>
<p>Returns:
    Channels:
        A Channels object with one :class:<code>Channel</code> per <code>(pulse_path, noise_path)</code> pair.</p>
<p>Raises:
    AssertionError:
        If two input files correspond to the same channel number.</p>
<p>Notes:
    Each channel is created via :meth:<code>Channel.from_ljh</code>.
    The channel number is taken from the LJH file header and used as the key
    in the returned Channels mapping.</p>
<p>Examples:
    &gt;&gt;&gt; pairs = [
    ...     ("datadir/run0000_ch0000.ljh", "datadir/run0001_ch0000.ljh"),
    ...     ("datadir/run0000_ch0001.ljh", "datadir/run0001_ch0001.ljh"),
    ... ]
    &gt;&gt;&gt; channels = Channels.from_ljh_path_pairs(pairs, description="Test run")
    &gt;&gt;&gt; list(channels.keys())
    [0, 1]</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_path_pairs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a :class:`Channels` instance from pairs of LJH files.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_noise_pairs (List[Tuple[str, str]]):</span>
<span class="sd">            A list of `(pulse_path, noise_path)` tuples, where each entry contains</span>
<span class="sd">            the file path to a pulse LJH file and its corresponding noise LJH file.</span>
<span class="sd">        description (str):</span>
<span class="sd">            A human-readable description for the resulting Channels object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Channels:</span>
<span class="sd">            A Channels object with one :class:`Channel` per `(pulse_path, noise_path)` pair.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError:</span>
<span class="sd">            If two input files correspond to the same channel number.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Each channel is created via :meth:`Channel.from_ljh`.</span>
<span class="sd">        The channel number is taken from the LJH file header and used as the key</span>
<span class="sd">        in the returned Channels mapping.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; pairs = [</span>
<span class="sd">        ...     ("datadir/run0000_ch0000.ljh", "datadir/run0001_ch0000.ljh"),</span>
<span class="sd">        ...     ("datadir/run0000_ch0001.ljh", "datadir/run0001_ch0001.ljh"),</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; channels = Channels.from_ljh_path_pairs(pairs, description="Test run")</span>
<span class="sd">        &gt;&gt;&gt; list(channels.keys())</span>
<span class="sd">        [0, 1]</span>
<span class="sd">    """</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span> <span class="ow">in</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.from_off_paths">
<code class="highlight language-python"><span class="n">from_off_paths</span><span class="p">(</span><span class="n">off_paths</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create an instance from a sequence of OFF-file paths</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_off_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">off_paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create an instance from a sequence of OFF-file paths"""</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">off_paths</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_off</span><span class="p">(</span><span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">OffFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.get_an_ljh_path">
<code class="highlight language-python"><span class="n">get_an_ljh_path</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the path to a representative one of the LJH files used to create this Channels object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_an_ljh_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the path to a representative one of the LJH files used to create this Channels object."""</span>
    <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.get_experiment_state_df">
<code class="highlight language-python"><span class="n">get_experiment_state_df</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a DataFrame containing experiment state information.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>experiment_state_path</code></b>
                  (<code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>load experiment state info from the given path or (if None) infer the path from an LJH file, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="polars.DataFrame">DataFrame</span></code>
              
              <div class="doc-md-description">
<p>A Data Frame with a table of experiment state labels and the corresponding start time (in Polars timestamp format).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a DataFrame containing experiment state information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment_state_path : str | Path | None, optional</span>
<span class="sd">        load experiment state info from the given path or (if None) infer the path from an LJH file, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pl.DataFrame</span>
<span class="sd">        A Data Frame with a table of experiment state labels and the corresponding start time (in Polars timestamp format).</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">experiment_state_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ljh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_an_ljh_path</span><span class="p">()</span>
        <span class="n">experiment_state_path</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">experiment_state_path_from_ljh_path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="p">,</span> <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="s2">"state_label"</span><span class="p">])</span>
    <span class="n">df_es</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"ns"</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span>

    <span class="c1"># Strip leading/trailing whitespace from state labels. Convert string -&gt; categorical</span>
    <span class="n">df_labels</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"state_label"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip_chars</span><span class="p">())</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Categorical</span><span class="p">)</span>
    <span class="n">df_es</span> <span class="o">=</span> <span class="n">df_es</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df_labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_es</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.get_path_in_output_folder">
<code class="highlight language-python"><span class="n">get_path_in_output_folder</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a path in an output folder named like the run number, sibling to the LJH folder.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_path_in_output_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a path in an output folder named like the run number, sibling to the LJH folder."""</span>
    <span class="n">ljh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_an_ljh_path</span><span class="p">()</span>
    <span class="n">base_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_chan"</span><span class="p">)</span>
    <span class="n">date</span><span class="p">,</span> <span class="n">run_num</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_run"</span><span class="p">)</span>  <span class="c1"># timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">run_num</span><span class="si">}</span><span class="s2">mass2_output"</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.linefit">
<code class="highlight language-python"><span class="n">linefit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dlo</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">dhi</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">params_update</span><span class="o">=</span><span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">())</span></code>
</h3>
<div class="doc doc-contents">
<p>Perform a fit to one spectral line in the coadded histogram of the given column.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">linefit</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">line</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="n">GenericLineModel</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Perform a fit to one spectral line in the coadded histogram of the given column."""</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
    <span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pe</span> <span class="o">-</span> <span class="n">dlo</span><span class="p">,</span> <span class="n">pe</span> <span class="o">+</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_bin_edges</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"before update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_update</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"after update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
        <span class="n">binsize</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">ds_shortname</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
        <span class="n">attr_str</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">use_expr</span><span class="si">=}</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.linefit_joblib">
<code class="highlight language-python"><span class="n">linefit_joblib</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s1">'threads'</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>No one but Galen understands this function.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">linefit_joblib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"threads"</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""No one but Galen understands this function."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A unit of parallel work: fit line to one channel."""</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">linefit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

    <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="n">prefer</span><span class="p">)</span>  <span class="c1"># its not clear if threads are better.... what blocks the gil?</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">work</span><span class="p">)(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.load_analysis">
<code class="highlight language-python"><span class="n">load_analysis</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Load an analysis-in-progress from a zipfile</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>path</code></b>
                  (<code><span title="pathlib.Path">Path</span> | <span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>Zipfile that work was saved in.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_analysis</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load an analysis-in-progress from a zipfile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path | str</span>
<span class="sd">        Zipfile that work was saved in.</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_restore_dataframe</span><span class="p">(</span><span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Take a channel and replace its dataframe with the given one, loaded from a parquet file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ch : Channel</span>
<span class="sd">            A channel, loaded from a pickle file, with an empty dataframe</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            A replacement dataframe for the existing one (typically, the existing one is empty)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channel</span>
<span class="sd">            The Channel `ch` but with `ch.df` updated, including any raw data backed by an LJH file</span>
<span class="sd">        """</span>
        <span class="c1"># If this channel was based on an LJH file, restore columns from the LJH file to the dataframe.</span>
        <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">data_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ljh_path</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">data_source</span>
            <span class="k">if</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".ljh"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".noi"</span><span class="p">):</span>
                <span class="n">ljh_backed_chan</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ljh_backed_chan</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># df_history is needed for some debug plots to work. This version has strictly more columns than required</span>
        <span class="c1"># at each history point. TODO: We could use the steps inputs and outputs to trim the appropriate columns.</span>
        <span class="c1"># For getting started, though, it's easier just to let each dataframe in history equal the final dataframe.</span>
        <span class="n">df_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">df_history</span><span class="o">=</span><span class="n">df_history</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
        <span class="n">pickle_file</span> <span class="o">=</span> <span class="s2">"data_all.pkl"</span>
        <span class="n">pickle_bytes</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Channels</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle_bytes</span><span class="p">)</span>

        <span class="n">restored_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parquet_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">))</span>
            <span class="n">restored_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">_restore_dataframe</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

        <span class="n">restored_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">badch</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bad_channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parquet_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_bad_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parquet_file</span><span class="p">))</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">_restore_dataframe</span><span class="p">(</span><span class="n">badch</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">restored_bad_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">badch</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="n">ch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">restored_channels</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">restored_bad_channels</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.load_recipes">
<code class="highlight language-python"><span class="n">load_recipes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with Recipe objects loaded from the given pickle file
and applied to each Channel.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with Recipe objects loaded from the given pickle file</span>
<span class="sd">    and applied to each Channel."""</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">unpickle_object</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_steps_dict</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.map">
<code class="highlight language-python"><span class="nb">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">allow_throw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Map function <code>f</code> over all channels, returning a new Channels object containing the new Channel objects.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">allow_throw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Map function `f` over all channels, returning a new Channels object containing the new Channel objects."""</span>
    <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">kint</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">kint</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">allow_throw</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">channel</span><span class="si">=}</span><span class="s2"> failed the step </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">error_type</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">error_message</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">new_bad_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">as_bad</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">error_message</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span>
    <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">merge_dicts_ordered_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">new_bad_channels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">new_bad_channels</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.parent_folder_path">
<code class="highlight language-python"><span class="n">parent_folder_path</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the parent folder of the LJH files used to create this Channels object. Specifically, the
<code>self.ch0</code> channel's directory is used (normally the answer would be the same for all channels).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parent_folder_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the parent folder of the LJH files used to create this Channels object. Specifically, the</span>
<span class="sd">    `self.ch0` channel's directory is used (normally the answer would be the same for all channels)."""</span>
    <span class="n">parent_folder_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parent_folder_path</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parent_folder_path</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_avg_pulses">
<code class="highlight language-python"><span class="n">plot_avg_pulses</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the average pulses (the signal model) for the channels in this Channels object.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>limit</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>20</code>
)
              
              <div class="doc-md-description">
<p>Plot at most this many filters if not None, by default 20</p>
</div>
</li>
<li>
<b><code>channels</code></b>
                  (<code><span title="list">list</span>[<span title="int">int</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Plot only channels with numbers in this list if not None, by default None</p>
</div>
</li>
<li>
<b><code>colormap</code></b>
                  (<code><span title="matplotlib.colors.Colormap">Colormap</span></code>, default:
                      <code><span title="pylab.cm.viridis">viridis</span></code>
)
              
              <div class="doc-md-description">
<p>The color scale to use, by default plt.cm.viridis</p>
</div>
</li>
<li>
<b><code>axis</code></b>
                  (<code><span title="pylab.Axes">Axes</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A <code>plt.Axes</code> to plot on, or if None a new one, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="pylab.Axes">Axes</span></code>
              
              <div class="doc-md-description">
<p>The <code>plt.Axes</code> containing the plot.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_avg_pulses</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the average pulses (the signal model) for the channels in this Channels object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    limit : int | None, optional</span>
<span class="sd">        Plot at most this many filters if not None, by default 20</span>
<span class="sd">    channels : list[int] | None, optional</span>
<span class="sd">        Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">    colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">        The color scale to use, by default plt.cm.viridis</span>
<span class="sd">    axis : plt.Axes | None, optional</span>
<span class="sd">        A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Axes</span>
<span class="sd">        The `plt.Axes` containing the plot.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">-</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_avg_pulse</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Samples after trigger"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Average pulses"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_filters">
<code class="highlight language-python"><span class="n">plot_filters</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the optimal filters for the channels in this Channels object.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>limit</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>20</code>
)
              
              <div class="doc-md-description">
<p>Plot at most this many filters if not None, by default 20</p>
</div>
</li>
<li>
<b><code>channels</code></b>
                  (<code><span title="list">list</span>[<span title="int">int</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Plot only channels with numbers in this list if not None, by default None</p>
</div>
</li>
<li>
<b><code>colormap</code></b>
                  (<code><span title="matplotlib.colors.Colormap">Colormap</span></code>, default:
                      <code><span title="pylab.cm.viridis">viridis</span></code>
)
              
              <div class="doc-md-description">
<p>The color scale to use, by default plt.cm.viridis</p>
</div>
</li>
<li>
<b><code>axis</code></b>
                  (<code><span title="pylab.Axes">Axes</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A <code>plt.Axes</code> to plot on, or if None a new one, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="pylab.Axes">Axes</span></code>
              
              <div class="doc-md-description">
<p>The <code>plt.Axes</code> containing the plot.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_filters</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the optimal filters for the channels in this Channels object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    limit : int | None, optional</span>
<span class="sd">        Plot at most this many filters if not None, by default 20</span>
<span class="sd">    channels : list[int] | None, optional</span>
<span class="sd">        Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">    colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">        The color scale to use, by default plt.cm.viridis</span>
<span class="sd">    axis : plt.Axes | None, optional</span>
<span class="sd">        A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Axes</span>
<span class="sd">        The `plt.Axes` containing the plot.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="c1"># The next line _assumes_ a 5-lag filter. Fix as needed.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_filter</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Samples after trigger"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Optimal filters"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_hist">
<code class="highlight language-python"><span class="n">plot_hist</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot a histogram for the given column across all channels.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot a histogram for the given column across all channels."""</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_hists">
<code class="highlight language-python"><span class="n">plot_hists</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plots histograms for the given column, grouped by the specified column.</p>
<p>Parameters:
- col (str): The column name to plot.
- bin_edges (array-like): The edges of the bins for the histogram.
- group_by_col (str): The column name to group by. This is required.
- axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - col (str): The column name to plot.</span>
<span class="sd">    - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">    - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">    - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

    <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Plot a histogram for each group</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get the data for the column to plot</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="c1"># Plot the histogram for the current group</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">"EBIT"</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"k"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
        <span class="c1"># bin_centers, counts = mass2.misc.hist_of_series(values, bin_edges)</span>
        <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>

    <span class="c1"># Customize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Frequency"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Coadded Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Add a legend to label the groups</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_noise_autocorr">
<code class="highlight language-python"><span class="n">plot_noise_autocorr</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the noise power autocorrelation for the channels in this Channels object.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>limit</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>20</code>
)
              
              <div class="doc-md-description">
<p>Plot at most this many filters if not None, by default 20</p>
</div>
</li>
<li>
<b><code>channels</code></b>
                  (<code><span title="list">list</span>[<span title="int">int</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Plot only channels with numbers in this list if not None, by default None</p>
</div>
</li>
<li>
<b><code>colormap</code></b>
                  (<code><span title="matplotlib.colors.Colormap">Colormap</span></code>, default:
                      <code><span title="pylab.cm.viridis">viridis</span></code>
)
              
              <div class="doc-md-description">
<p>The color scale to use, by default plt.cm.viridis</p>
</div>
</li>
<li>
<b><code>axis</code></b>
                  (<code><span title="pylab.Axes">Axes</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A <code>plt.Axes</code> to plot on, or if None a new one, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="pylab.Axes">Axes</span></code>
              
              <div class="doc-md-description">
<p>The <code>plt.Axes</code> containing the plot.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_noise_autocorr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the noise power autocorrelation for the channels in this Channels object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    limit : int | None, optional</span>
<span class="sd">        Plot at most this many filters if not None, by default 20</span>
<span class="sd">    channels : list[int] | None, optional</span>
<span class="sd">        Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">    colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">        The color scale to use, by default plt.cm.viridis</span>
<span class="sd">    axis : plt.Axes | None, optional</span>
<span class="sd">        A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Axes</span>
<span class="sd">        The `plt.Axes` containing the plot.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_noise_autocorrelation</span>
        <span class="k">if</span> <span class="n">ac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Lags"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Noise autocorrelation"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_noise_spectrum">
<code class="highlight language-python"><span class="n">plot_noise_spectrum</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the noise power spectrum for the channels in this Channels object.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>limit</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>20</code>
)
              
              <div class="doc-md-description">
<p>Plot at most this many filters if not None, by default 20</p>
</div>
</li>
<li>
<b><code>channels</code></b>
                  (<code><span title="list">list</span>[<span title="int">int</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Plot only channels with numbers in this list if not None, by default None</p>
</div>
</li>
<li>
<b><code>colormap</code></b>
                  (<code><span title="matplotlib.colors.Colormap">Colormap</span></code>, default:
                      <code><span title="pylab.cm.viridis">viridis</span></code>
)
              
              <div class="doc-md-description">
<p>The color scale to use, by default plt.cm.viridis</p>
</div>
</li>
<li>
<b><code>axis</code></b>
                  (<code><span title="pylab.Axes">Axes</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A <code>plt.Axes</code> to plot on, or if None a new one, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="pylab.Axes">Axes</span></code>
              
              <div class="doc-md-description">
<p>The <code>plt.Axes</code> containing the plot.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_noise_spectrum</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the noise power spectrum for the channels in this Channels object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    limit : int | None, optional</span>
<span class="sd">        Plot at most this many filters if not None, by default 20</span>
<span class="sd">    channels : list[int] | None, optional</span>
<span class="sd">        Plot only channels with numbers in this list if not None, by default None</span>
<span class="sd">    colormap : matplotlib.colors.Colormap, optional</span>
<span class="sd">        The color scale to use, by default plt.cm.viridis</span>
<span class="sd">    axis : plt.Axes | None, optional</span>
<span class="sd">        A `plt.Axes` to plot on, or if None a new one, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Axes</span>
<span class="sd">        The `plt.Axes` containing the plot.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">plot_these_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limited_chan_list</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_these_chan</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="n">freqpsd</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">last_noise_psd</span>
        <span class="k">if</span> <span class="n">freqpsd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">freqpsd</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_expected</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Chan </span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Noise power spectral density"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.save_analysis">
<code class="highlight language-python"><span class="n">save_analysis</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trim_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trim_timestamp_and_subframecount</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Save an analysis-in-progress completely to a zip file, only tested for ljh backed channels so far</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>path</code></b>
                  (<code><span title="pathlib.Path">Path</span> | <span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>Directory to save work in. If it doesn't exist, its parent should.</p>
</div>
</li>
<li>
<b><code>overwrite</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>If <code>path</code> exists, whether to overwrite it, by default False</p>
</div>
</li>
<li>
<b><code>trim_debug</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to make save file smaller (potentially) at the cost of breaking some debugging plots, by default False</p>
</div>
</li>
<li>
<b><code>trim_timestamp_and_subframecount</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to make the save file smaller at the cost of reduced information avaialble when the ljh files are
not available, eg when loading on another computer.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_analysis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">trim_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">trim_timestamp_and_subframecount</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Save an analysis-in-progress completely to a zip file, only tested for ljh backed channels so far</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path | str</span>
<span class="sd">        Directory to save work in. If it doesn't exist, its parent should.</span>
<span class="sd">    overwrite : bool, optional</span>
<span class="sd">        If `path` exists, whether to overwrite it, by default False</span>
<span class="sd">    trim_debug : bool, optional</span>
<span class="sd">        Whether to make save file smaller (potentially) at the cost of breaking some debugging plots, by default False</span>
<span class="sd">    trim_timestamp_and_subframecount: bool, optional</span>
<span class="sd">        Whether to make the save file smaller at the cost of reduced information avaialble when the ljh files are</span>
<span class="sd">        not available, eg when loading on another computer.</span>
<span class="sd">    """</span>
    <span class="n">zip_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">".zip"</span><span class="p">:</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">".zip"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File exists; use `save_analysis(...overwrite=True)` to overwrite the existing </span><span class="si">{</span><span class="n">zip_path</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">store_dataframe_to_parquet_and_return_pickleable_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">zf</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">parquet_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Store the `ch.df` to a parquet file of the given name in the ZipFile (open for writing).</span>
<span class="sd">        Prepare `ch` for pickling by removing its dataframe and dataframe history, and stripping debug info from `steps`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ch : Channel</span>
<span class="sd">            The channel to modify by storing dataframe to parquet and removing it.</span>
<span class="sd">        zf : ZipFile</span>
<span class="sd">            A ZipFile object currently open for writing.</span>
<span class="sd">        parquet_file : str</span>
<span class="sd">            The name to use for storing the parquet file within `zf`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Channel</span>
<span class="sd">            A copy of `ch` amenable to pickling with the dataframe and dataframe history removed and with trimmed steps.</span>
<span class="sd">        """</span>
        <span class="c1"># Don't store the memmapped LJH pulse info (if present) in the Parquet file</span>
        <span class="k">if</span> <span class="n">trim_timestamp_and_subframecount</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">,</span> <span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">,</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">trim_debug</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">trim_debug_info</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">df_history</span><span class="o">=</span><span class="p">[],</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_path</span><span class="p">),</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parquet_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">store_dataframe_to_parquet_and_return_pickleable_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">parquet_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">badch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parquet_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"data_bad_chan</span><span class="si">{</span><span class="n">ch_num</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.parquet"</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">store_dataframe_to_parquet_and_return_pickleable_channel</span><span class="p">(</span><span class="n">badch</span><span class="o">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">parquet_path</span><span class="p">)</span>
            <span class="n">bad_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">badch</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="n">ch</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">bad_channels</span><span class="p">)</span>
        <span class="n">pickle_file</span> <span class="o">=</span> <span class="s2">"data_all.pkl"</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="n">dill</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.save_recipes">
<code class="highlight language-python"><span class="n">save_recipes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">required_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Pickle a dictionary (one entry per channel) of Recipe objects.</p>
<p>If you want to save a "recipe", a minimal series of steps required to reproduce the required field(s),
then set <code>required_fields</code> to be a list/tuple/set of DataFrame column names (or a single column name)
whose production from raw data should be possible.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>filename</code></b>
                  (<code><span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>Filename to store recipe in, typically of the form "*.pkl"</p>
</div>
</li>
<li>
<b><code>required_fields</code></b>
                  (<code><span title="str">str</span> | <span title="collections.abc.Iterable">Iterable</span>[<span title="str">str</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The field (str) or fields (Iterable[str]) that the recipe should be able to generate from a raw LJH file.
Drop all steps that do not lead (directly or indireactly) to producing this field or these fields.
If None, then preserve all steps (default None).</p>
</div>
</li>
<li>
<b><code>drop_debug</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              
              <div class="doc-md-description">
<p>Whether to remove debugging-related data from each <code>RecipeStep</code>, if the subclass supports this (via the
`RecipeStep.drop_debug() method).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="dict">dict</span></code>
              
              <div class="doc-md-description">
<p>Dictionary with keys=channel numbers, values=the (possibly trimmed and debug-dropped) Recipe objects.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Pickle a dictionary (one entry per channel) of Recipe objects.</span>

<span class="sd">    If you want to save a "recipe", a minimal series of steps required to reproduce the required field(s),</span>
<span class="sd">    then set `required_fields` to be a list/tuple/set of DataFrame column names (or a single column name)</span>
<span class="sd">    whose production from raw data should be possible.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Filename to store recipe in, typically of the form "*.pkl"</span>
<span class="sd">    required_fields : str | Iterable[str] | None</span>
<span class="sd">        The field (str) or fields (Iterable[str]) that the recipe should be able to generate from a raw LJH file.</span>
<span class="sd">        Drop all steps that do not lead (directly or indireactly) to producing this field or these fields.</span>
<span class="sd">        If None, then preserve all steps (default None).</span>
<span class="sd">    drop_debug: bool</span>
<span class="sd">        Whether to remove debugging-related data from each `RecipeStep`, if the subclass supports this (via the</span>
<span class="sd">        `RecipeStep.drop_debug() method).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with keys=channel numbers, values=the (possibly trimmed and debug-dropped) Recipe objects.</span>
<span class="sd">    """</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">channum</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">steps</span><span class="p">[</span><span class="n">channum</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">trim_dead_ends</span><span class="p">(</span><span class="n">required_fields</span><span class="o">=</span><span class="n">required_fields</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="n">drop_debug</span><span class="p">)</span>
    <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">steps</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.set_bad">
<code class="highlight language-python"><span class="n">set_bad</span><span class="p">(</span><span class="n">ch_num</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">require_ch_num_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with the given channel number marked as bad.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">require_ch_num_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with the given channel number marked as bad."""</span>
    <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">require_ch_num_exists</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2"> can't be set bad because it does not exist"</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ch_num</span><span class="p">:</span>
            <span class="n">new_bad_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">as_bad</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
    <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">new_bad_channels</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.with_experiment_state_by_path">
<code class="highlight language-python"><span class="n">with_experiment_state_by_path</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with experiment state information added to each Channel.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>experiment_state_path</code></b>
                  (<code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>load experiment state info from the given path or (if None) infer the path from an LJH file, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Channels


  
      dataclass
   (mass2.core.channels.Channels)" href="#mass2.core.channels.Channels">Channels</a></code>
              
              <div class="doc-md-description">
<p>An enhanced copy of self, with experiment state information added to each channel.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with experiment state information added to each Channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment_state_path : str | Path | None, optional</span>
<span class="sd">        load experiment state info from the given path or (if None) infer the path from an LJH file, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Channels</span>
<span class="sd">        An enhanced copy of self, with experiment state information added to each channel.</span>
<span class="sd">    """</span>
    <span class="n">df_es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_state_df</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.with_experiment_state_df">
<code class="highlight language-python"><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with experiment state information added to each Channel.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>df_es</code></b>
                  (<code><span title="polars.DataFrame">DataFrame</span></code>)
              
              <div class="doc-md-description">
<p>experiment state info</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Channels


  
      dataclass
   (mass2.core.channels.Channels)" href="#mass2.core.channels.Channels">Channels</a></code>
              
              <div class="doc-md-description">
<p>An enhanced copy of self, with experiment state information added to each channel.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_es</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with experiment state information added to each Channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_es : pl.DataFrame</span>
<span class="sd">        experiment state info</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Channels</span>
<span class="sd">        An enhanced copy of self, with experiment state information added to each channel.</span>
<span class="sd">    """</span>
    <span class="c1"># TODO: the following is less performant than making a use_expr for each state,</span>
    <span class="c1"># and using .set_sorted on the timestamp column.</span>
    <span class="n">ch2s</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ch2s</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">ch2s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.with_external_trigger_by_path">
<code class="highlight language-python"><span class="n">with_external_trigger_by_path</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with external trigger information added, loaded
from the given path or EVENTUALLY (if None) inferring it from an LJH file (not yet implemented).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with external trigger information added, loaded</span>
<span class="sd">    from the given path or EVENTUALLY (if None) inferring it from an LJH file (not yet implemented)."""</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"cannot infer external trigger path yet"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">_f</span><span class="p">:</span>
        <span class="n">_header_line</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># read the one header line before opening the binary data</span>
        <span class="n">external_trigger_subframe_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">_f</span><span class="p">,</span> <span class="s2">"int64"</span><span class="p">)</span>
    <span class="n">df_ext</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">"subframecount"</span><span class="p">:</span> <span class="n">external_trigger_subframe_count</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.with_external_trigger_df">
<code class="highlight language-python"><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with external trigger information added to each Channel,
found from the given DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_ext</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with external trigger information added to each Channel,</span>
<span class="sd">    found from the given DataFrame."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_etrig_df</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of one Channel object with external trigger information added to it"""</span>
        <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">with_etrig_df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.with_more_channels">
<code class="highlight language-python"><span class="n">with_more_channels</span><span class="p">(</span><span class="n">more</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a Channels object with additional Channels in it.
New channels with the same number will overrule existing ones.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>more</code></b>
                  (<code><a class="autorefs autorefs-internal" title="Channels


  
      dataclass
   (mass2.core.channels.Channels)" href="#mass2.core.channels.Channels">Channels</a></code>)
              
              <div class="doc-md-description">
<p>Another Channels object, to be added</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Channels


  
      dataclass
   (mass2.core.channels.Channels)" href="#mass2.core.channels.Channels">Channels</a></code>
              
              <div class="doc-md-description">
<p>The replacement</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_more_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">more</span><span class="p">:</span> <span class="s2">"Channels"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a Channels object with additional Channels in it.</span>
<span class="sd">    New channels with the same number will overrule existing ones.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    more : Channels</span>
<span class="sd">        Another Channels object, to be added</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Channels</span>
<span class="sd">        The replacement</span>
<span class="sd">    """</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">channels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">more</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">bad</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">more</span><span class="o">.</span><span class="n">bad_channels</span><span class="p">)</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="n">more</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Warning! created by with_more_channels()"</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">bad</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">descr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.with_steps_dict">
<code class="highlight language-python"><span class="n">with_steps_dict</span><span class="p">(</span><span class="n">steps_dict</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this Channels object with the given Recipe objects added to each Channel.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_steps_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this Channels object with the given Recipe objects added to each Channel."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_recipes</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of one Channel object with Recipe steps added to it"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">steps_dict</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"steps dict did not contain steps for this ch_num"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">with_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_recipes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.analysis_algorithms"></a>
<div class="doc doc-contents first">
<p>mass2.core.analysis_algorithms - main algorithms used in data analysis</p>
<p>Designed to abstract certain key algorithms out of the class <code>MicrocalDataSet</code>
and be able to run them fast.</p>
<p>Created on Jun 9, 2014</p>
<p>@author: fowlerj</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.HistogramSmoother">
<code>HistogramSmoother</code>
</h2>
<div class="doc doc-contents">
<p>Object that can repeatedly smooth histograms with the same bin count and
width to the same Gaussian width.  By pre-computing the smoothing kernel for
that histogram, we can smooth multiple histograms with the same geometry.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HistogramSmoother</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Object that can repeatedly smooth histograms with the same bin count and</span>
<span class="sd">    width to the same Gaussian width.  By pre-computing the smoothing kernel for</span>
<span class="sd">    that histogram, we can smooth multiple histograms with the same geometry.</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Give the smoothing Gaussian's width as &lt;smooth_sigma&gt; and the</span>
<span class="sd">        [lower,upper] histogram limits as &lt;limits&gt;."""</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span> <span class="o">=</span> <span class="n">smooth_sigma</span>

        <span class="c1"># Choose a reasonable # of bins, at least 1024 and a power of 2</span>
        <span class="n">stepsize</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">smooth_sigma</span>
        <span class="n">dlimits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nbins_guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dlimits</span> <span class="o">/</span> <span class="n">stepsize</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">min_nbins</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">max_nbins</span> <span class="o">=</span> <span class="mi">32768</span>  <span class="c1"># 32k bins, 2**15</span>

        <span class="c1"># Clamp nbins_guess to at least min_nbins</span>
        <span class="n">clamped_nbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">nbins_guess</span><span class="p">,</span> <span class="n">min_nbins</span><span class="p">,</span> <span class="n">max_nbins</span><span class="p">)</span>
        <span class="n">nbins_forced_to_power_of_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">clamped_nbins</span><span class="p">)))</span>
        <span class="c1"># if nbins_forced_to_power_of_2 == max_nbins:</span>
        <span class="c1">#     print(f"Warning: HistogramSmoother (for drift correct) Limiting histogram bins to {max_nbins} (requested {nbins_guess})")</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins_forced_to_power_of_2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">=</span> <span class="n">dlimits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>

        <span class="c1"># Compute the Fourier-space smoothing kernel</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">kernel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Handle the negative frequencies</span>
        <span class="n">kernel</span> <span class="o">/=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a smoothed histogram of the data vector &lt;values&gt;"""</span>
        <span class="n">contents</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span>
        <span class="n">ftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="n">csmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">*</span> <span class="n">ftc</span><span class="p">)</span>
        <span class="n">csmooth</span><span class="p">[</span><span class="n">csmooth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">csmooth</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.analysis_algorithms.HistogramSmoother.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a smoothed histogram of the data vector <values></values></p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a smoothed histogram of the data vector &lt;values&gt;"""</span>
    <span class="n">contents</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">ftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="n">csmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">*</span> <span class="n">ftc</span><span class="p">)</span>
    <span class="n">csmooth</span><span class="p">[</span><span class="n">csmooth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">csmooth</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.analysis_algorithms.HistogramSmoother.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">smooth_sigma</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Give the smoothing Gaussian's width as <smooth_sigma> and the
[lower,upper] histogram limits as <limits>.</limits></smooth_sigma></p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Give the smoothing Gaussian's width as &lt;smooth_sigma&gt; and the</span>
<span class="sd">    [lower,upper] histogram limits as &lt;limits&gt;."""</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span> <span class="o">=</span> <span class="n">smooth_sigma</span>

    <span class="c1"># Choose a reasonable # of bins, at least 1024 and a power of 2</span>
    <span class="n">stepsize</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">smooth_sigma</span>
    <span class="n">dlimits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nbins_guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dlimits</span> <span class="o">/</span> <span class="n">stepsize</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">min_nbins</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">max_nbins</span> <span class="o">=</span> <span class="mi">32768</span>  <span class="c1"># 32k bins, 2**15</span>

    <span class="c1"># Clamp nbins_guess to at least min_nbins</span>
    <span class="n">clamped_nbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">nbins_guess</span><span class="p">,</span> <span class="n">min_nbins</span><span class="p">,</span> <span class="n">max_nbins</span><span class="p">)</span>
    <span class="n">nbins_forced_to_power_of_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">clamped_nbins</span><span class="p">)))</span>
    <span class="c1"># if nbins_forced_to_power_of_2 == max_nbins:</span>
    <span class="c1">#     print(f"Warning: HistogramSmoother (for drift correct) Limiting histogram bins to {max_nbins} (requested {nbins_guess})")</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins_forced_to_power_of_2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">=</span> <span class="n">dlimits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>

    <span class="c1"># Compute the Fourier-space smoothing kernel</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">kernel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Handle the negative frequencies</span>
    <span class="n">kernel</span> <span class="o">/=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.compute_max_deriv">
<code class="highlight language-python"><span class="n">compute_max_deriv</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="n">ignore_leading</span><span class="p">,</span> <span class="n">spike_reject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Computes the maximum derivative in timeseries <pulse_data>.
<pulse_data> can be a 2D array where each row is a different pulse record, in which case
the return value will be an array last long as the number of rows in <pulse_data>.</pulse_data></pulse_data></pulse_data></p>
<p>Args:
    pulse_data:
    ignore_leading:
    spike_reject: (default True)
    kernel: the linear filter against which the signals will be convolved
        (CONVOLED, not correlated, so reverse the filter as needed). If None,
        then the default kernel of [+.2 +.1 0 -.1 -.2] will be used. If
        "SG", then the cubic 5-point Savitzky-Golay filter will be used (see
        below). Otherwise, kernel needs to be a (short) array which will
        be converted to a 1xN 2-dimensional np.ndarray. (default None)</p>
<p>Returns:
    An np.ndarray, dimension 1: the value of the maximum derivative (units of <pulse_data units=""> per sample).</pulse_data></p>
<p>When kernel=="SG", then we estimate the derivative by Savitzky-Golay filtering
(with 1 point before/3 points after the point in question and fitting polynomial
of order 3).  Find the right general area by first doing a simple difference.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_max_deriv</span><span class="p">(</span>
    <span class="n">pulse_data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ignore_leading</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spike_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Computes the maximum derivative in timeseries &lt;pulse_data&gt;.</span>
<span class="sd">    &lt;pulse_data&gt; can be a 2D array where each row is a different pulse record, in which case</span>
<span class="sd">    the return value will be an array last long as the number of rows in &lt;pulse_data&gt;.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_data:</span>
<span class="sd">        ignore_leading:</span>
<span class="sd">        spike_reject: (default True)</span>
<span class="sd">        kernel: the linear filter against which the signals will be convolved</span>
<span class="sd">            (CONVOLED, not correlated, so reverse the filter as needed). If None,</span>
<span class="sd">            then the default kernel of [+.2 +.1 0 -.1 -.2] will be used. If</span>
<span class="sd">            "SG", then the cubic 5-point Savitzky-Golay filter will be used (see</span>
<span class="sd">            below). Otherwise, kernel needs to be a (short) array which will</span>
<span class="sd">            be converted to a 1xN 2-dimensional np.ndarray. (default None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        An np.ndarray, dimension 1: the value of the maximum derivative (units of &lt;pulse_data units&gt; per sample).</span>

<span class="sd">    When kernel=="SG", then we estimate the derivative by Savitzky-Golay filtering</span>
<span class="sd">    (with 1 point before/3 points after the point in question and fitting polynomial</span>
<span class="sd">    of order 3).  Find the right general area by first doing a simple difference.</span>
<span class="sd">    """</span>

    <span class="c1"># If pulse_data is a 1D array, turn it into 2</span>
    <span class="n">pulse_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"input pulse_data should be a 1d or 2d array."</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pulse_view</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="p">[:,</span> <span class="n">ignore_leading</span><span class="p">:]</span>
    <span class="n">NPulse</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">NSamp</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># The default filter:</span>
    <span class="n">filter_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s2">"SG"</span><span class="p">:</span>
        <span class="c1"># This filter is the Savitzky-Golay filter of n_L=1, n_R=3 and M=3, to use the</span>
        <span class="c1"># language of Numerical Recipes 3rd edition.  It amounts to least-squares fitting</span>
        <span class="c1"># of an M=3rd order polynomial to the five points [-1,+3] and</span>
        <span class="c1"># finding the slope of the polynomial at 0.</span>
        <span class="c1"># Note that we reverse the order of coefficients because convolution will re-reverse</span>
        <span class="n">filter_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.45238</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02381</span><span class="p">,</span> <span class="mf">0.28571</span><span class="p">,</span> <span class="mf">0.30952</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.11905</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span> <span class="o">=</span> <span class="n">filter_coef</span>

    <span class="n">max_deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NPulse</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spike_reject</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPulse</span><span class="p">):</span>
            <span class="n">pulses</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="n">t2</span> <span class="k">if</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="k">else</span> <span class="n">t0</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">NSamp</span><span class="p">):</span>
                <span class="n">t3</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">t3</span> <span class="k">if</span> <span class="n">t3</span> <span class="o">&lt;</span> <span class="n">t1</span> <span class="k">else</span> <span class="n">t1</span>
                <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span> <span class="n">t_max_deriv</span><span class="p">)</span>

                <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span>

            <span class="n">max_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max_deriv</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPulse</span><span class="p">):</span>
            <span class="n">pulses</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="n">t0</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">NSamp</span><span class="p">):</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_max_deriv</span><span class="p">)</span>
            <span class="n">max_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max_deriv</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">max_deriv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.correct_flux_jumps">
<code class="highlight language-python"><span class="n">correct_flux_jumps</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Remove 'flux' jumps' from pretrigger mean.</p>
<p>When using umux readout, if a pulse is recorded that has a very fast rising
edge (e.g. a cosmic ray), the readout system will "slip" an integer number
of flux quanta. This means that the baseline level returned to after the
pulse will different from the pretrigger value by an integer number of flux
quanta. This causes that pretrigger mean summary quantity to jump around in
a way that causes trouble for the rest of MASS. This function attempts to
correct these jumps.</p>
<p>Arguments:
vals -- array of values to correct
mask -- mask indentifying "good" pulses
flux_quant -- size of 1 flux quanta</p>
<p>Returns:
Array with values corrected</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_flux_jumps</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Remove 'flux' jumps' from pretrigger mean.</span>

<span class="sd">    When using umux readout, if a pulse is recorded that has a very fast rising</span>
<span class="sd">    edge (e.g. a cosmic ray), the readout system will "slip" an integer number</span>
<span class="sd">    of flux quanta. This means that the baseline level returned to after the</span>
<span class="sd">    pulse will different from the pretrigger value by an integer number of flux</span>
<span class="sd">    quanta. This causes that pretrigger mean summary quantity to jump around in</span>
<span class="sd">    a way that causes trouble for the rest of MASS. This function attempts to</span>
<span class="sd">    correct these jumps.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    vals -- array of values to correct</span>
<span class="sd">    mask -- mask indentifying "good" pulses</span>
<span class="sd">    flux_quant -- size of 1 flux quanta</span>

<span class="sd">    Returns:</span>
<span class="sd">    Array with values corrected</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">unwrap_n</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.correct_flux_jumps_original">
<code class="highlight language-python"><span class="n">correct_flux_jumps_original</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Remove 'flux' jumps' from pretrigger mean.</p>
<p>When using umux readout, if a pulse is recorded that has a very fast rising
edge (e.g. a cosmic ray), the readout system will "slip" an integer number
of flux quanta. This means that the baseline level returned to after the
pulse will different from the pretrigger value by an integer number of flux
quanta. This causes that pretrigger mean summary quantity to jump around in
a way that causes trouble for the rest of MASS. This function attempts to
correct these jumps.</p>
<p>Arguments:
vals -- array of values to correct
mask -- mask indentifying "good" pulses
flux_quant -- size of 1 flux quanta</p>
<p>Returns:
Array with values corrected</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_flux_jumps_original</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Remove 'flux' jumps' from pretrigger mean.</span>

<span class="sd">    When using umux readout, if a pulse is recorded that has a very fast rising</span>
<span class="sd">    edge (e.g. a cosmic ray), the readout system will "slip" an integer number</span>
<span class="sd">    of flux quanta. This means that the baseline level returned to after the</span>
<span class="sd">    pulse will different from the pretrigger value by an integer number of flux</span>
<span class="sd">    quanta. This causes that pretrigger mean summary quantity to jump around in</span>
<span class="sd">    a way that causes trouble for the rest of MASS. This function attempts to</span>
<span class="sd">    correct these jumps.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    vals -- array of values to correct</span>
<span class="sd">    mask -- mask indentifying "good" pulses</span>
<span class="sd">    flux_quant -- size of 1 flux quanta</span>

<span class="sd">    Returns:</span>
<span class="sd">    Array with values corrected</span>
<span class="sd">    """</span>
    <span class="c1"># The naive thing is to simply replace each value with its value mod</span>
    <span class="c1"># the flux quantum. But of the baseline value turns out to fluctuate</span>
    <span class="c1"># about an integer number of flux quanta, this will introduce new</span>
    <span class="c1"># jumps. I don't know the best way to handle this in general. For now,</span>
    <span class="c1"># if there are still jumps after the mod, I add 1/4 of a flux quanta</span>
    <span class="c1"># before modding, then mod, then subtract the 1/4 flux quantum and then</span>
    <span class="c1"># *add* a single flux quantum so that the values never go negative.</span>
    <span class="c1">#</span>
    <span class="c1"># To determine whether there are "still jumps after the mod" I look at the</span>
    <span class="c1"># difference between the largest and smallest values for "good" pulses. If</span>
    <span class="c1"># you don't exclude "bad" pulses, this check can be tricked in cases where</span>
    <span class="c1"># the pretrigger section contains a (sufficiently large) tail.</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">flux_quant</span><span class="p">:</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">%</span> <span class="n">flux_quant</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">flux_quant</span><span class="p">:</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span> <span class="o">+</span> <span class="n">flux_quant</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">flux_quant</span><span class="p">)</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="n">corrected</span> <span class="o">-</span> <span class="n">flux_quant</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">flux_quant</span>
        <span class="n">corrected</span> <span class="o">-=</span> <span class="n">corrected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">corrected</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vals</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.drift_correct">
<code class="highlight language-python"><span class="n">drift_correct</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute a drift correction that minimizes the spectral entropy.</p>
<p>Args:
    indicator: The "x-axis", which indicates the size of the correction.
    uncorrected: A filtered pulse height vector. Same length as indicator.
        Assumed to have some gain that is linearly related to indicator.
    limit: The upper limit of uncorrected values over which entropy is
        computed (default None).</p>
<p>Generally indicator will be the pretrigger mean of the pulses, but you can
experiment with other choices.</p>
<p>The entropy will be computed on corrected values only in the range
[0, limit], so limit should be set to a characteristic large value of
uncorrected. If limit is None (the default), then in will be compute as
25% larger than the 99%ile point of uncorrected.</p>
<p>The model is that the filtered pulse height PH should be scaled by (1 +
a*PTM) where a is an arbitrary parameter computed here, and PTM is the
difference between each record's pretrigger mean and the median value of all
pretrigger means. (Or replace "pretrigger mean" with whatever quantity you
passed in as <indicator>.)</indicator></p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drift_correct</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a drift correction that minimizes the spectral entropy.</span>

<span class="sd">    Args:</span>
<span class="sd">        indicator: The "x-axis", which indicates the size of the correction.</span>
<span class="sd">        uncorrected: A filtered pulse height vector. Same length as indicator.</span>
<span class="sd">            Assumed to have some gain that is linearly related to indicator.</span>
<span class="sd">        limit: The upper limit of uncorrected values over which entropy is</span>
<span class="sd">            computed (default None).</span>

<span class="sd">    Generally indicator will be the pretrigger mean of the pulses, but you can</span>
<span class="sd">    experiment with other choices.</span>

<span class="sd">    The entropy will be computed on corrected values only in the range</span>
<span class="sd">    [0, limit], so limit should be set to a characteristic large value of</span>
<span class="sd">    uncorrected. If limit is None (the default), then in will be compute as</span>
<span class="sd">    25% larger than the 99%ile point of uncorrected.</span>

<span class="sd">    The model is that the filtered pulse height PH should be scaled by (1 +</span>
<span class="sd">    a*PTM) where a is an arbitrary parameter computed here, and PTM is the</span>
<span class="sd">    difference between each record's pretrigger mean and the median value of all</span>
<span class="sd">    pretrigger means. (Or replace "pretrigger mean" with whatever quantity you</span>
<span class="sd">    passed in as &lt;indicator&gt;.)</span>
<span class="sd">    """</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">)</span>
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>  <span class="c1"># make a copy</span>
    <span class="n">ptm_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
    <span class="n">indicator</span> <span class="o">-=</span> <span class="n">ptm_offset</span>

    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pct99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">pct99</span>

    <span class="n">smoother</span> <span class="o">=</span> <span class="n">HistogramSmoother</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">smoother</span><span class="o">.</span><span class="n">nbins</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">,</span> <span class="s2">"will be crazy slow, should not be possible"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">entropy</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">smoother</span><span class="p">:</span> <span class="n">HistogramSmoother</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the entropy of the drift-corrected values"""</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">indicator</span> <span class="o">*</span> <span class="n">param</span><span class="p">)</span>
        <span class="n">hsmooth</span> <span class="o">=</span> <span class="n">smoother</span><span class="p">(</span><span class="n">corrected</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">hsmooth</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hsmooth</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">hsmooth</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">drift_corr_param</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brent</span><span class="p">(</span><span class="n">entropy</span><span class="p">,</span> <span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">smoother</span><span class="p">),</span> <span class="n">brack</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">])</span>

    <span class="n">drift_correct_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"ptmean_gain"</span><span class="p">,</span> <span class="s2">"slope"</span><span class="p">:</span> <span class="n">drift_corr_param</span><span class="p">,</span> <span class="s2">"median_pretrig_mean"</span><span class="p">:</span> <span class="n">ptm_offset</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">drift_corr_param</span><span class="p">,</span> <span class="n">drift_correct_info</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.estimateRiseTime">
<code class="highlight language-python"><span class="n">estimateRiseTime</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="n">timebase</span><span class="p">,</span> <span class="n">nPretrig</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Computes the rise time of timeseries <pulse_data>, where the time steps are <timebase>.
<pulse_data> can be a 2D array where each row is a different pulse record, in which case
the return value will be an array last long as the number of rows in <pulse_data>.</pulse_data></pulse_data></timebase></pulse_data></p>
<p>If nPretrig &gt;= 4, then the samples pulse_data[:nPretrig] are averaged to estimate
the baseline.  Otherwise, the minimum of pulse_data is assumed to be the baseline.</p>
<p>Specifically, take the first and last of the rising points in the range of
10% to 90% of the peak value, interpolate a line between the two, and use its
slope to find the time to rise from 0 to the peak.</p>
<p>Args:
    pulse_data: An np.ndarray of dimension 1 (a single pulse record) or 2 (an
        array with each row being a pulse record).
    timebase: The sampling time.
    nPretrig: The number of samples that are recorded before the trigger.</p>
<p>Returns:
    An ndarray of dimension 1, giving the rise times.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">estimateRiseTime</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">timebase</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">nPretrig</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Computes the rise time of timeseries &lt;pulse_data&gt;, where the time steps are &lt;timebase&gt;.</span>
<span class="sd">    &lt;pulse_data&gt; can be a 2D array where each row is a different pulse record, in which case</span>
<span class="sd">    the return value will be an array last long as the number of rows in &lt;pulse_data&gt;.</span>

<span class="sd">    If nPretrig &gt;= 4, then the samples pulse_data[:nPretrig] are averaged to estimate</span>
<span class="sd">    the baseline.  Otherwise, the minimum of pulse_data is assumed to be the baseline.</span>

<span class="sd">    Specifically, take the first and last of the rising points in the range of</span>
<span class="sd">    10% to 90% of the peak value, interpolate a line between the two, and use its</span>
<span class="sd">    slope to find the time to rise from 0 to the peak.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_data: An np.ndarray of dimension 1 (a single pulse record) or 2 (an</span>
<span class="sd">            array with each row being a pulse record).</span>
<span class="sd">        timebase: The sampling time.</span>
<span class="sd">        nPretrig: The number of samples that are recorded before the trigger.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An ndarray of dimension 1, giving the rise times.</span>
<span class="sd">    """</span>
    <span class="n">MINTHRESH</span><span class="p">,</span> <span class="n">MAXTHRESH</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span>

    <span class="c1"># If pulse_data is a 1D array, turn it into 2</span>
    <span class="n">pulse_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"input pulse_data should be a 1d or 2d array."</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># The following requires a lot of numpy foo to read. Sorry!</span>
    <span class="k">if</span> <span class="n">nPretrig</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">baseline_value</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nPretrig</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">baseline_value</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nPretrig</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">value_at_peak</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">baseline_value</span>
    <span class="n">idx_last_pk</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">npulses</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rising_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">pulse_data</span><span class="p">[:,</span> <span class="n">nPretrig</span> <span class="p">:</span> <span class="n">idx_last_pk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline_value</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="n">value_at_peak</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1"># Find the last and first indices at which the data are in (0.1, 0.9] times the</span>
        <span class="c1"># peak value. Then make sure last is at least 1 past first.</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rising_data</span> <span class="o">&gt;</span> <span class="n">MAXTHRESH</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rising_data</span> <span class="o">&gt;</span> <span class="n">MINTHRESH</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_idx</span><span class="p">[</span><span class="n">last_idx</span> <span class="o">&lt;</span> <span class="n">first_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_idx</span><span class="p">[</span><span class="n">last_idx</span> <span class="o">&lt;</span> <span class="n">first_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">last_idx</span><span class="p">[</span><span class="n">last_idx</span> <span class="o">==</span> <span class="n">rising_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rising_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">pulsenum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npulses</span><span class="p">)</span>
        <span class="n">y_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rising_data</span><span class="p">[</span><span class="n">pulsenum</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">rising_data</span><span class="p">[</span><span class="n">pulsenum</span><span class="p">,</span> <span class="n">first_idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">y_diff</span><span class="p">[</span><span class="n">y_diff</span> <span class="o">&lt;</span> <span class="n">timebase</span><span class="p">]</span> <span class="o">=</span> <span class="n">timebase</span>
        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">timebase</span> <span class="o">*</span> <span class="p">(</span><span class="n">last_idx</span> <span class="o">-</span> <span class="n">first_idx</span><span class="p">)</span>
        <span class="n">rise_time</span> <span class="o">=</span> <span class="n">time_diff</span> <span class="o">/</span> <span class="n">y_diff</span>
        <span class="n">rise_time</span><span class="p">[</span><span class="n">y_diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.9e-6</span>
        <span class="k">return</span> <span class="n">rise_time</span>

    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">9.9e-6</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.filter_signal_lowpass">
<code class="highlight language-python"><span class="n">filter_signal_lowpass</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fcut</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Tophat lowpass filter using an FFT</p>
<p>Args:
    sig - the signal to be filtered
    fs - the sampling frequency of the signal
    fcut - the frequency at which to cutoff the signal</p>
<p>Returns:
    the filtered signal</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_signal_lowpass</span><span class="p">(</span><span class="n">sig</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">fs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fcut</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Tophat lowpass filter using an FFT</span>

<span class="sd">    Args:</span>
<span class="sd">        sig - the signal to be filtered</span>
<span class="sd">        fs - the sampling frequency of the signal</span>
<span class="sd">        fcut - the frequency at which to cutoff the signal</span>

<span class="sd">    Returns:</span>
<span class="sd">        the filtered signal</span>
<span class="sd">    """</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SIG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fs</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">SIG</span><span class="p">)</span>
    <span class="n">filt</span><span class="p">[</span><span class="n">freqs</span> <span class="o">&lt;</span> <span class="n">fcut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">sig_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">SIG</span> <span class="o">*</span> <span class="n">filt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig_filt</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.make_smooth_histogram">
<code class="highlight language-python"><span class="n">make_smooth_histogram</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Convert a vector of arbitrary <values> info a smoothed histogram by
histogramming it and smoothing.</values></p>
<p>This is a convenience function using the HistogramSmoother class.</p>
<p>Args:
    values: The vector of data to be histogrammed.
    smooth_sigma: The smoothing Gaussian's width (FWHM)
    limit, upper_limit: The histogram limits are [limit,upper_limit] or
        [0,limit] if upper_limit is None.</p>
<p>Returns:
    The smoothed histogram as an array.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_smooth_histogram</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert a vector of arbitrary &lt;values&gt; info a smoothed histogram by</span>
<span class="sd">    histogramming it and smoothing.</span>

<span class="sd">    This is a convenience function using the HistogramSmoother class.</span>

<span class="sd">    Args:</span>
<span class="sd">        values: The vector of data to be histogrammed.</span>
<span class="sd">        smooth_sigma: The smoothing Gaussian's width (FWHM)</span>
<span class="sd">        limit, upper_limit: The histogram limits are [limit,upper_limit] or</span>
<span class="sd">            [0,limit] if upper_limit is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The smoothed histogram as an array.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">upper_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limit</span><span class="p">,</span> <span class="n">upper_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span>
    <span class="k">return</span> <span class="n">HistogramSmoother</span><span class="p">(</span><span class="n">smooth_sigma</span><span class="p">,</span> <span class="p">[</span><span class="n">limit</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">])(</span><span class="n">values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.nearest_arrivals">
<code class="highlight language-python"><span class="n">nearest_arrivals</span><span class="p">(</span><span class="n">reference_times</span><span class="p">,</span> <span class="n">other_times</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the external trigger time immediately before and after each pulse timestamp</p>
<p>Args:
    pulse_timestamps - 1d array of pulse timestamps whose nearest neighbors
        need to be found.
    external_trigger_timestamps - 1d array of possible nearest neighbors.</p>
<p>Returns:
    (before_times, after_times)</p>
<p>before_times is an ndarray of the same size as pulse_timestamps.
before_times[i] contains the difference between the closest lesser time
contained in external_trigger_timestamps and pulse_timestamps[i]  or inf if there was no
earlier time in other_times Note that before_times is always a positive
number even though the time difference it represents is negative.</p>
<p>after_times is an ndarray of the same size as pulse_timestamps.
after_times[i] contains the difference between pulse_timestamps[i] and the
closest greater time contained in other_times or a inf number if there was
no later time in external_trigger_timestamps.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">nearest_arrivals</span><span class="p">(</span><span class="n">reference_times</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">other_times</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the external trigger time immediately before and after each pulse timestamp</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_timestamps - 1d array of pulse timestamps whose nearest neighbors</span>
<span class="sd">            need to be found.</span>
<span class="sd">        external_trigger_timestamps - 1d array of possible nearest neighbors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (before_times, after_times)</span>

<span class="sd">    before_times is an ndarray of the same size as pulse_timestamps.</span>
<span class="sd">    before_times[i] contains the difference between the closest lesser time</span>
<span class="sd">    contained in external_trigger_timestamps and pulse_timestamps[i]  or inf if there was no</span>
<span class="sd">    earlier time in other_times Note that before_times is always a positive</span>
<span class="sd">    number even though the time difference it represents is negative.</span>

<span class="sd">    after_times is an ndarray of the same size as pulse_timestamps.</span>
<span class="sd">    after_times[i] contains the difference between pulse_timestamps[i] and the</span>
<span class="sd">    closest greater time contained in other_times or a inf number if there was</span>
<span class="sd">    no later time in external_trigger_timestamps.</span>
<span class="sd">    """</span>
    <span class="n">other_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">other_times</span><span class="p">)</span>
    <span class="n">nearest_after_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">other_times</span><span class="p">,</span> <span class="n">reference_times</span><span class="p">)</span>
    <span class="c1"># because both sets of arrival times should be sorted, there are faster algorithms than searchsorted</span>
    <span class="c1"># for example: https://github.com/kwgoodman/bottleneck/issues/47</span>
    <span class="c1"># we could use one if performance becomes an issue</span>
    <span class="n">last_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">nearest_after_index</span><span class="p">,</span> <span class="n">other_times</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">"left"</span><span class="p">)</span>
    <span class="n">first_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">nearest_after_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">nearest_before_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nearest_after_index</span><span class="p">)</span>
    <span class="n">nearest_before_index</span><span class="p">[:</span><span class="n">first_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">nearest_before_index</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">before_times</span> <span class="o">=</span> <span class="n">reference_times</span> <span class="o">-</span> <span class="n">other_times</span><span class="p">[</span><span class="n">nearest_before_index</span><span class="p">]</span>
    <span class="n">before_times</span><span class="p">[:</span><span class="n">first_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">nearest_after_index</span><span class="p">[</span><span class="n">last_index</span><span class="p">:]</span> <span class="o">=</span> <span class="n">other_times</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">after_times</span> <span class="o">=</span> <span class="n">other_times</span><span class="p">[</span><span class="n">nearest_after_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_times</span>
    <span class="n">after_times</span><span class="p">[</span><span class="n">last_index</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">return</span> <span class="n">before_times</span><span class="p">,</span> <span class="n">after_times</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.time_drift_correct">
<code class="highlight language-python"><span class="n">time_drift_correct</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">sec_per_degree</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">pulses_per_degree</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">max_degrees</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ndeg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute a time-based drift correction that minimizes the spectral entropy.</p>
<p>Args:
    time: The "time-axis". Correction will be a low-order polynomial in this.
    uncorrected: A filtered pulse height vector. Same length as indicator.
        Assumed to have some gain that is linearly related to indicator.
    w: the kernel width for the Laplace KDE density estimator
    sec_per_degree: assign as many as one polynomial degree per this many seconds
    pulses_per_degree: assign as many as one polynomial degree per this many pulses
    max_degrees: never use more than this many degrees of Legendre polynomial.
    n_deg: If not None, use this many degrees, regardless of the values of
           sec_per_degree, pulses_per_degree, and max_degress. In this case, never downsample.
    limit: The [lower,upper] limit of uncorrected values over which entropy is
        computed (default None).</p>
<p>The entropy will be computed on corrected values only in the range
[limit[0], limit[1]], so limit should be set to a characteristic large value
of uncorrected. If limit is None (the default), then it will be computed as
25%% larger than the 99%%ile point of uncorrected.</p>
<p>Possible improvements in the future:
* Use Numba to speed up.
* Allow the parameters to be function arguments with defaults: photons per
  degree of freedom, seconds per degree of freedom, and max degrees of freedom.
* Figure out how to span the available time with more than one set of legendre
  polynomials, so that we can have more than 20 d.o.f. eventually, for long runs.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">time_drift_correct</span><span class="p">(</span>  <span class="c1"># noqa: PLR0914</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sec_per_degree</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">pulses_per_degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">max_degrees</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">ndeg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a time-based drift correction that minimizes the spectral entropy.</span>

<span class="sd">    Args:</span>
<span class="sd">        time: The "time-axis". Correction will be a low-order polynomial in this.</span>
<span class="sd">        uncorrected: A filtered pulse height vector. Same length as indicator.</span>
<span class="sd">            Assumed to have some gain that is linearly related to indicator.</span>
<span class="sd">        w: the kernel width for the Laplace KDE density estimator</span>
<span class="sd">        sec_per_degree: assign as many as one polynomial degree per this many seconds</span>
<span class="sd">        pulses_per_degree: assign as many as one polynomial degree per this many pulses</span>
<span class="sd">        max_degrees: never use more than this many degrees of Legendre polynomial.</span>
<span class="sd">        n_deg: If not None, use this many degrees, regardless of the values of</span>
<span class="sd">               sec_per_degree, pulses_per_degree, and max_degress. In this case, never downsample.</span>
<span class="sd">        limit: The [lower,upper] limit of uncorrected values over which entropy is</span>
<span class="sd">            computed (default None).</span>

<span class="sd">    The entropy will be computed on corrected values only in the range</span>
<span class="sd">    [limit[0], limit[1]], so limit should be set to a characteristic large value</span>
<span class="sd">    of uncorrected. If limit is None (the default), then it will be computed as</span>
<span class="sd">    25%% larger than the 99%%ile point of uncorrected.</span>

<span class="sd">    Possible improvements in the future:</span>
<span class="sd">    * Use Numba to speed up.</span>
<span class="sd">    * Allow the parameters to be function arguments with defaults: photons per</span>
<span class="sd">      degree of freedom, seconds per degree of freedom, and max degrees of freedom.</span>
<span class="sd">    * Figure out how to span the available time with more than one set of legendre</span>
<span class="sd">      polynomials, so that we can have more than 20 d.o.f. eventually, for long runs.</span>
<span class="sd">    """</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pct99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">pct99</span><span class="p">)</span>

    <span class="n">use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">uncorrected</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uncorrected</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">use</span><span class="p">])</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">[</span><span class="n">use</span><span class="p">])</span>

    <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Rescale time to the range [-1,1]"""</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">-</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"tmin"</span><span class="p">:</span> <span class="n">tmin</span><span class="p">,</span>
        <span class="s2">"tmax"</span><span class="p">:</span> <span class="n">tmax</span><span class="p">,</span>
        <span class="s2">"normalize"</span><span class="p">:</span> <span class="n">normalize</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">dtime</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">-</span> <span class="n">tmin</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndeg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ndeg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">dtime</span> <span class="o">/</span> <span class="n">sec_per_degree</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="n">pulses_per_degree</span><span class="p">))</span>
        <span class="n">ndeg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="n">max_degrees</span><span class="p">)</span>
        <span class="n">ndeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">phot_per_degree</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ndeg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phot_per_degree</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pulses_per_degree</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">phot_per_degree</span> <span class="o">/</span> <span class="n">pulses_per_degree</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[::</span><span class="n">downsample</span><span class="p">]</span>
            <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">uncorrected</span><span class="p">[::</span><span class="n">downsample</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Using </span><span class="si">%2d</span><span class="s2"> degrees for </span><span class="si">%6d</span><span class="s2"> photons (after </span><span class="si">%d</span><span class="s2"> downsample)"</span><span class="p">,</span> <span class="n">ndeg</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">downsample</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"That's </span><span class="si">%6.1f</span><span class="s2"> photons per degree, and </span><span class="si">%6.1f</span><span class="s2"> seconds per degree."</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ndeg</span><span class="p">),</span> <span class="n">dtime</span> <span class="o">/</span> <span class="n">ndeg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">model1</span><span class="p">(</span><span class="n">pi</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"The model function, with one parameter pi varied, others fixed."</span>
        <span class="n">pcopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">pcopy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pcopy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cost1</span><span class="p">(</span><span class="n">pi</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="s2">"The cost function (spectral entropy), with one parameter pi varied, others fixed."</span>
        <span class="k">return</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">model1</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">xnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">legendre</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)(</span><span class="n">xnorm</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndeg</span><span class="p">)])</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">"coefficients"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndeg</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">_fval</span><span class="p">,</span> <span class="n">_iter</span><span class="p">,</span> <span class="n">funcalls</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brent</span><span class="p">(</span>
            <span class="n">cost1</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">fc</span> <span class="o">+=</span> <span class="n">funcalls</span>
        <span class="n">model</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">legendre</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">result</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">"coefficients"</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">"funccalls"</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span>

    <span class="n">xk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ndeg</span><span class="p">)</span>
    <span class="n">model2</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">xk</span><span class="p">,</span> <span class="n">model</span><span class="p">(</span><span class="n">xk</span><span class="p">))</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="p">(</span><span class="n">xnorm</span><span class="p">)),</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">H3</span> <span class="o">=</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model2</span><span class="p">(</span><span class="n">xnorm</span><span class="p">)),</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">H2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">H2</span> <span class="o">-</span> <span class="n">H1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">H3</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">H3</span> <span class="o">-</span> <span class="n">H2</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model2</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">"entropies"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">H1</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">H3</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">"model"</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.unwrap_n">
<code class="highlight language-python"><span class="n">unwrap_n</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Unwrap data that has been restricted to a given period.</p>
<p>The algorithm iterates through each data point and compares
it to the average of the previous n data points. It then
offsets the data point by the multiple of the period that
will minimize the difference from that n-point running average.</p>
<p>For the first n data points, there are not enough preceding
points to average n of them, so the algorithm will average
fewer points.</p>
<p>This code was written by Thomas Baker; integrated into MASS by Dan
Becker. Sped up 300x by @njit.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>data</code></b>
                  (<code>array of data values</code>)
              
              <div class="doc-md-description">
</div>
</li>
<li>
<b><code>period</code></b>
                  (<code>the range over which the data loops</code>)
              
              <div class="doc-md-description">
</div>
</li>
<li>
<b><code>n</code></b>
                  (<code>how many preceding points to average</code>, default:
                      <code>3</code>
)
              
              <div class="doc-md-description">
</div>
</li>
<li>
<b><code>mask</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unwrap_n</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">],</span> <span class="n">period</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Unwrap data that has been restricted to a given period.</span>

<span class="sd">    The algorithm iterates through each data point and compares</span>
<span class="sd">    it to the average of the previous n data points. It then</span>
<span class="sd">    offsets the data point by the multiple of the period that</span>
<span class="sd">    will minimize the difference from that n-point running average.</span>

<span class="sd">    For the first n data points, there are not enough preceding</span>
<span class="sd">    points to average n of them, so the algorithm will average</span>
<span class="sd">    fewer points.</span>

<span class="sd">    This code was written by Thomas Baker; integrated into MASS by Dan</span>
<span class="sd">    Becker. Sped up 300x by @njit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array of data values</span>
<span class="sd">    period : the range over which the data loops</span>
<span class="sd">    n : how many preceding points to average</span>
<span class="sd">    mask: mask indentifying "good" pulses</span>
<span class="sd">    """</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">udata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># make a copy for output</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">udata</span>

    <span class="c1"># Iterate through each data point and offset it by</span>
    <span class="c1"># an amount that will minimize the difference from the</span>
    <span class="c1"># rolling average</span>
    <span class="n">nprior</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">firstgoodidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">priorvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">udata</span><span class="p">[</span><span class="n">firstgoodidx</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="c1"># Take the average of the previous n data points (only those with mask[i]==True).</span>
        <span class="c1"># Offset the data point by the most reasonable multiple of period (make this point closest to the running average).</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">priorvalues</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nprior</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">priorvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">nprior</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">priorvalues</span><span class="p">[:</span><span class="n">nprior</span><span class="p">])</span>
        <span class="n">udata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">udata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">avg</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span> <span class="o">*</span> <span class="n">period</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">priorvalues</span><span class="p">[</span><span class="n">nprior</span> <span class="o">%</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">udata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nprior</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">udata</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.drift_correction"></a>
<div class="doc doc-contents first">
<p>Provide <code>DriftCorrectStep</code> and <code>DriftCorrection</code> for correcting gain drifts that correlate with pretrigger mean.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.drift_correction.DriftCorrectStep">
<code>DriftCorrectStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A RecipeStep to apply a linear drift correction to pulse data in a DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DriftCorrectStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A RecipeStep to apply a linear drift correction to pulse data in a DataFrame."""</span>

    <span class="n">dc</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply the drift correction to the input DataFrame and return a new DataFrame with results."""</span>
        <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">slope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">offset</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">uncorrected_col</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">indicator_col</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">df</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the uncorrected and corrected values against the indicator for debugging purposes."""</span>
        <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="n">df_after</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span> <span class="n">df_small</span><span class="p">[</span><span class="n">uncorrected_col</span><span class="p">])</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span>
            <span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span>
            <span class="n">df_small</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span> <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"DriftCorrectStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a DriftCorrectStep by learning the correction from data in the given Channel."""</span>
        <span class="k">if</span> <span class="n">corrected_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">corrected_col</span> <span class="o">=</span> <span class="n">uncorrected_col</span> <span class="o">+</span> <span class="s2">"_dc"</span>
        <span class="n">indicator_s</span><span class="p">,</span> <span class="n">uncorrected_s</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_serieses</span><span class="p">([</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">],</span> <span class="n">use_expr</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">drift_correct</span><span class="p">(</span>
            <span class="n">indicator</span><span class="o">=</span><span class="n">indicator_s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">uncorrected</span><span class="o">=</span><span class="n">uncorrected_s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">corrected_col</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="n">dc</span><span class="o">=</span><span class="n">dc</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.drift_correction.DriftCorrectStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply the drift correction to the input DataFrame and return a new DataFrame with results.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply the drift correction to the input DataFrame and return a new DataFrame with results."""</span>
    <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">slope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">offset</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">uncorrected_col</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">indicator_col</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">df</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.drift_correction.DriftCorrectStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the uncorrected and corrected values against the indicator for debugging purposes.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the uncorrected and corrected values against the indicator for debugging purposes."""</span>
    <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
    <span class="c1"># breakpoint()</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="n">df_after</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span> <span class="n">df_small</span><span class="p">[</span><span class="n">uncorrected_col</span><span class="p">])</span>
    <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span>
        <span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span>
        <span class="n">df_small</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.drift_correction.DriftCorrectStep.learn">
<code class="highlight language-python"><span class="n">learn</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">,</span> <span class="n">corrected_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a DriftCorrectStep by learning the correction from data in the given Channel.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span> <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"DriftCorrectStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a DriftCorrectStep by learning the correction from data in the given Channel."""</span>
    <span class="k">if</span> <span class="n">corrected_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">corrected_col</span> <span class="o">=</span> <span class="n">uncorrected_col</span> <span class="o">+</span> <span class="s2">"_dc"</span>
    <span class="n">indicator_s</span><span class="p">,</span> <span class="n">uncorrected_s</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_serieses</span><span class="p">([</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">],</span> <span class="n">use_expr</span><span class="p">)</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">drift_correct</span><span class="p">(</span>
        <span class="n">indicator</span><span class="o">=</span><span class="n">indicator_s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">uncorrected</span><span class="o">=</span><span class="n">uncorrected_s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">corrected_col</span><span class="p">],</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="n">dc</span><span class="o">=</span><span class="n">dc</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.drift_correction.DriftCorrection">
<code>DriftCorrection</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A linear correction used to attempt remove any correlation between pretrigger mean and pulse height;
will work with other quantities instead.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DriftCorrection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A linear correction used to attempt remove any correlation between pretrigger mean and pulse height;</span>
<span class="sd">    will work with other quantities instead."""</span>

    <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">slope</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply the drift correction to the given uncorrected values using the given indicator values."""</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
        <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">indicator</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slope</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.drift_correction.DriftCorrection.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply the drift correction to the given uncorrected values using the given indicator values.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply the drift correction to the given uncorrected values using the given indicator values."""</span>
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">indicator</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">slope</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.drift_correction.drift_correct_mass">
<code class="highlight language-python"><span class="n">drift_correct_mass</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Determine drift correction parameters using mass2.core.analysis_algorithms.drift_correct.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drift_correct_mass</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"DriftCorrection"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Determine drift correction parameters using mass2.core.analysis_algorithms.drift_correct."""</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">dc_info</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">analysis_algorithms</span><span class="o">.</span><span class="n">drift_correct</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">dc_info</span><span class="p">[</span><span class="s2">"median_pretrig_mean"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">DriftCorrection</span><span class="p">(</span><span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.drift_correction.drift_correct_wip">
<code class="highlight language-python"><span class="n">drift_correct_wip</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Work in progress to Determine drift correction parameters directly (??).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/drift_correction.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drift_correct_wip</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"DriftCorrection"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Work in progress to Determine drift correction parameters directly (??)."""</span>
    <span class="n">opt_result</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">rough_cal</span><span class="o">.</span><span class="n">minimize_entropy_linear</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indicator</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">),</span>
        <span class="n">bin_edges</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60000</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">fwhm_in_bin_number_units</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">DriftCorrection</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">slope</span><span class="o">=</span><span class="n">opt_result</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.filter_steps"></a>
<div class="doc doc-contents first">
<p>Provide <code>OptimalFilterStep</code>, a step to apply an optimal filter to pulse data in a DataFrame.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.filter_steps.OptimalFilterStep">
<code>OptimalFilterStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A step to apply an optimal filter to pulse data in a DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/filter_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OptimalFilterStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A step to apply an optimal filter to pulse data in a DataFrame."""</span>

    <span class="nb">filter</span><span class="p">:</span> <span class="n">Filter</span>
    <span class="n">spectrum</span><span class="p">:</span> <span class="n">NoiseResult</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">filter_maker</span><span class="p">:</span> <span class="s2">"FilterMaker"</span>
    <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply the optimal filter to the input DataFrame and return a new DataFrame with results."""</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">filter_records</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"peak_x"</span><span class="p">:</span> <span class="n">peak_x</span><span class="p">,</span> <span class="s2">"peak_y"</span><span class="p">:</span> <span class="n">peak_y</span><span class="p">}))</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">"peak_x"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"peak_y"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the filter shape for debugging purposes."""</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">axis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"OptimalFilterStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this step with debugging information (the NoiseResult) removed."""</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.filter_steps.OptimalFilterStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply the optimal filter to the input DataFrame and return a new DataFrame with results.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/filter_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply the optimal filter to the input DataFrame and return a new DataFrame with results."""</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">filter_records</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"peak_x"</span><span class="p">:</span> <span class="n">peak_x</span><span class="p">,</span> <span class="s2">"peak_y"</span><span class="p">:</span> <span class="n">peak_y</span><span class="p">}))</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">"peak_x"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"peak_y"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.filter_steps.OptimalFilterStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the filter shape for debugging purposes.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/filter_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the filter shape for debugging purposes."""</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axis</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.filter_steps.OptimalFilterStep.drop_debug">
<code class="highlight language-python"><span class="n">drop_debug</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this step with debugging information (the NoiseResult) removed.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/filter_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"OptimalFilterStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this step with debugging information (the NoiseResult) removed."""</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.ljhfiles"></a>
<div class="doc doc-contents first">
<p>Classes and functions for reading and handling LJH files.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile">
<code>LJHFile</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>
<p>Represents the header and binary information of a single LJH file.</p>
<p>Includes the complete ASCII header stored both as a dictionary and a string, and
key attributes including the number of pulses, number of samples (and presamples)
in each pulse record, client information stored by the LJH writer, and the filename.</p>
<p>Also includes a <code>np.memmap</code> to the raw binary data. This memmap always starts with
pulse zero and extends to the last full pulse given the file size at the time of object
creation. To extend the memmap for files that are growing, use <code>LJHFile.reopen_binary()</code>
to return a new object with a possibly longer memmap.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LJHFile</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represents the header and binary information of a single LJH file.</span>

<span class="sd">    Includes the complete ASCII header stored both as a dictionary and a string, and</span>
<span class="sd">    key attributes including the number of pulses, number of samples (and presamples)</span>
<span class="sd">    in each pulse record, client information stored by the LJH writer, and the filename.</span>

<span class="sd">    Also includes a `np.memmap` to the raw binary data. This memmap always starts with</span>
<span class="sd">    pulse zero and extends to the last full pulse given the file size at the time of object</span>
<span class="sd">    creation. To extend the memmap for files that are growing, use `LJHFile.reopen_binary()`</span>
<span class="sd">    to return a new object with a possibly longer memmap.</span>
<span class="sd">    """</span>

    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">channum</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">npulses</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">timebase</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">npresamples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">subframediv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">client</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">header</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">header_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">header_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">binary_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">_mmap</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span>
    <span class="n">ljh_version</span><span class="p">:</span> <span class="n">Version</span>
    <span class="n">max_pulses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">OVERLONG_HEADER</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A string that can be evaluated to re-open this LJH file."""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"""mass2.core.ljhfiles.LJHFile.open("</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">")"""</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">max_pulses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LJHFile"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Open an LJH file, parsing its header information and returning an LJHFile object."""</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">header_dict</span><span class="p">,</span> <span class="n">header_string</span><span class="p">,</span> <span class="n">header_size</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">channum</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Channel"</span><span class="p">]</span>
        <span class="n">timebase</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Timebase"</span><span class="p">]</span>
        <span class="n">nsamples</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Total Samples"</span><span class="p">]</span>
        <span class="n">npresamples</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Presamples"</span><span class="p">]</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">header_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Software Version"</span><span class="p">,</span> <span class="s2">"UNKNOWN"</span><span class="p">)</span>
        <span class="n">subframediv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">"Subframe divisions"</span> <span class="ow">in</span> <span class="n">header_dict</span><span class="p">:</span>
            <span class="n">subframediv</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Subframe divisions"</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">"Number of rows"</span> <span class="ow">in</span> <span class="n">header_dict</span><span class="p">:</span>
            <span class="n">subframediv</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Number of rows"</span><span class="p">]</span>

        <span class="n">ljh_version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">header_dict</span><span class="p">[</span><span class="s2">"Save File Format Version"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.0.0"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"LJH files version 1 are not supported"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.1.0"</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
                <span class="p">(</span><span class="s2">"internal_unused"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"internal_ms"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="n">concrete_LJHFile_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">LJHFile</span><span class="p">]</span> <span class="o">=</span> <span class="n">LJHFile_2_0</span>
        <span class="k">elif</span> <span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.2.0"</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
                <span class="p">(</span><span class="s2">"internal_us"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"internal_unused"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"internal_ms"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="n">concrete_LJHFile_type</span> <span class="o">=</span> <span class="n">LJHFile_2_1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
                <span class="p">(</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"posix_usec"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="n">concrete_LJHFile_type</span> <span class="o">=</span> <span class="n">LJHFile_2_2</span>
        <span class="n">pulse_size_bytes</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">binary_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="n">header_size</span>

        <span class="c1"># Fix long-standing bug in LJH files made by MATTER or XCALDAQ_client:</span>
        <span class="c1"># It adds 3 to the "true value" of nPresamples. Assume only DASTARD clients have value correct.</span>
        <span class="k">if</span> <span class="s2">"DASTARD"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">npresamples</span> <span class="o">+=</span> <span class="mi">3</span>

        <span class="n">npulses</span> <span class="o">=</span> <span class="n">binary_size</span> <span class="o">//</span> <span class="n">pulse_size_bytes</span>
        <span class="k">if</span> <span class="n">max_pulses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npulses</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_pulses</span><span class="p">,</span> <span class="n">npulses</span><span class="p">)</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">header_size</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">npulses</span><span class="p">,))</span>

        <span class="k">return</span> <span class="n">concrete_LJHFile_type</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">channum</span><span class="p">,</span>
            <span class="n">dtype</span><span class="p">,</span>
            <span class="n">npulses</span><span class="p">,</span>
            <span class="n">timebase</span><span class="p">,</span>
            <span class="n">nsamples</span><span class="p">,</span>
            <span class="n">npresamples</span><span class="p">,</span>
            <span class="n">subframediv</span><span class="p">,</span>
            <span class="n">client</span><span class="p">,</span>
            <span class="n">header_dict</span><span class="p">,</span>
            <span class="n">header_string</span><span class="p">,</span>
            <span class="n">header_size</span><span class="p">,</span>
            <span class="n">binary_size</span><span class="p">,</span>
            <span class="n">mmap</span><span class="p">,</span>
            <span class="n">ljh_version</span><span class="p">,</span>
            <span class="n">max_pulses</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_header</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Read in the text header of an LJH file. Return the header parsed into a dictionary,</span>
<span class="sd">        the complete header string (in case you want to generate a new LJH file from this one),</span>
<span class="sd">        and the size of the header in bytes. The file does not remain open after this method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (header_dict, header_string, header_size)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: path to the file to be opened.</span>
<span class="sd">        """</span>
        <span class="c1"># parse header into a dictionary</span>
        <span class="n">header_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"#End of Header"</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"reached EOF before #End of Header"</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">OVERLONG_HEADER</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"header is too long--seems not to contain '#End of Header'</span><span class="se">\n</span><span class="s2">in file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="c1"># ignore lines without ":"</span>
                <span class="k">elif</span> <span class="s2">":"</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">header_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">header_size</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">header_string</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="c1"># Convert values from header_dict into numeric types, when appropriate</span>
        <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">"Channel"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Timebase"</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Total Samples"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Presamples"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Number of columns"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Number of rows"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Subframe divisions"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"Timestamp offset (s)"</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="c1"># Have to convert to float first, as some early LJH have "Channel: 1.0"</span>
            <span class="n">header_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">header_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">header_dict</span><span class="p">,</span> <span class="n">header_string</span><span class="p">,</span> <span class="n">header_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pulse_size_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The size in bytes of each binary pulse record (including the timestamps)"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reopen_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pulses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LJHFile"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Reopen the underlying binary section of the LJH file, in case its size has changed,</span>
<span class="sd">        without re-reading the LJH header section.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_pulses : Optional[int], optional</span>
<span class="sd">            A limit to the number of pulses to memory map or None for no limit, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Self</span>
<span class="sd">            A new `LJHFile` object with the same header but a new memmap and number of pulses.</span>
<span class="sd">        """</span>
        <span class="n">current_binary_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_size</span>
        <span class="n">npulses</span> <span class="o">=</span> <span class="n">current_binary_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse_size_bytes</span>
        <span class="k">if</span> <span class="n">max_pulses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npulses</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_pulses</span><span class="p">,</span> <span class="n">npulses</span><span class="p">)</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header_size</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">npulses</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">npulses</span><span class="o">=</span><span class="n">npulses</span><span class="p">,</span>
            <span class="n">_mmap</span><span class="o">=</span><span class="n">mmap</span><span class="p">,</span>
            <span class="n">max_pulses</span><span class="o">=</span><span class="n">max_pulses</span><span class="p">,</span>
            <span class="n">binary_size</span><span class="o">=</span><span class="n">current_binary_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subframecount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the subframecount memory map.</span>

<span class="sd">        Old LJH versions don't have this: return zeros, unless overridden by derived class (LJHFile_2_2 will be the only one).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of subframecount values for each pulse record.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">datatimes_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the raw timestamp (posix usec) memory map.</span>

<span class="sd">        In mass issue #337, we found that computing on the entire memory map at once was prohibitively</span>
<span class="sd">        expensive for large files. To prevent problems, copy chunks of no more than</span>
<span class="sd">        `MAXSEGMENT` records at once.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</span>
<span class="sd">        """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"illegal: this is an abstract base class"</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">datatimes_float</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute pulse record times in floating-point (seconds since the 1970 epoch).</span>

<span class="sd">        In mass issue #337, we found that computing on the entire memory map at once was prohibitively</span>
<span class="sd">        expensive for large files. To prevent problems, compute on chunks of no more than</span>
<span class="sd">        `MAXSEGMENT` records at once.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of pulse record times in floating-point (seconds since the 1970 epoch).</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatimes_raw</span> <span class="o">/</span> <span class="mf">1e6</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a single pulse record from an LJH file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int</span>
<span class="sd">            Pulse record number (0-indexed)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ArrayLike</span>
<span class="sd">            A view into the pulse record.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"data"</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_trace_with_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return a single data trace as (subframecount, posix_usec, pulse_record)."""</span>
        <span class="n">pulse_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_trace</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subframecount</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatimes_raw</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pulse_record</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">first_pulse</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Convert this LJH file to two Polars dataframes: one for the binary data, one for the header.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        first_pulse : int, optional</span>
<span class="sd">            The pulse dataframe starts with this pulse record number, by default 0</span>
<span class="sd">        keep_posix_usec : bool, optional</span>
<span class="sd">            Whether to keep the raw `posix_usec` field in the pulse dataframe, by default False</span>
<span class="sd">        force_continuous: bool</span>
<span class="sd">            Whether to claim that the data stream is actually continuous (because it cannot be learned from</span>
<span class="sd">            data for LJH files before version 2.2.0). Only relevant for noise data files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[pl.DataFrame, pl.DataFrame]</span>
<span class="sd">            (df, header_df)</span>
<span class="sd">            df: the dataframe containing raw pulse information, one row per pulse</span>
<span class="sd">            header_df: a one-row dataframe containing the information from the LJH file header</span>
<span class="sd">        """</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"pulse"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"data"</span><span class="p">][</span><span class="n">first_pulse</span><span class="p">:],</span>
            <span class="s2">"posix_usec"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatimes_raw</span><span class="p">[</span><span class="n">first_pulse</span><span class="p">:],</span>
            <span class="s2">"subframecount"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframecount</span><span class="p">[</span><span class="n">first_pulse</span><span class="p">:],</span>
        <span class="p">}</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">SchemaDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">),</span>
            <span class="s2">"posix_usec"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt64</span><span class="p">,</span>
            <span class="s2">"subframecount"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt64</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"posix_usec"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_posix_usec</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"posix_usec"</span><span class="p">))</span>
        <span class="n">continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_continuous</span> <span class="ow">or</span> <span class="n">force_continuous</span>
        <span class="n">header_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">continuous</span><span class="o">=</span><span class="n">continuous</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_truncated_ljh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">npulses</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Write an LJH copy of this file, with a limited number of pulses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            The path where a new LJH file will be created (or replaced).</span>
<span class="sd">        npulses : int</span>
<span class="sd">            Number of pulse records to write</span>
<span class="sd">        """</span>
        <span class="n">npulses</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npulses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[:</span><span class="n">npulses</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this LJH file made of a perfectly continuous data stream?</span>

<span class="sd">        For pre-version 2.2 LJH files, we cannot discern from the data.</span>
<span class="sd">        So just claim False. (LJH_2_2 subtype will override by actually computing.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether every record is strictly continuous with the ones before and after</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.datatimes_float">
<code class="highlight language-python"><span class="n">datatimes_float</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Compute pulse record times in floating-point (seconds since the 1970 epoch).</p>
<p>In mass issue #337, we found that computing on the entire memory map at once was prohibitively
expensive for large files. To prevent problems, compute on chunks of no more than
<code>MAXSEGMENT</code> records at once.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of pulse record times in floating-point (seconds since the 1970 epoch).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.datatimes_raw">
<code class="highlight language-python"><span class="n">datatimes_raw</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the raw timestamp (posix usec) memory map.</p>
<p>In mass issue #337, we found that computing on the entire memory map at once was prohibitively
expensive for large files. To prevent problems, copy chunks of no more than
<code>MAXSEGMENT</code> records at once.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.is_continuous">
<code class="highlight language-python"><span class="n">is_continuous</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this LJH file made of a perfectly continuous data stream?</p>
<p>For pre-version 2.2 LJH files, we cannot discern from the data.
So just claim False. (LJH_2_2 subtype will override by actually computing.)</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="bool">bool</span></code>
              
              <div class="doc-md-description">
<p>Whether every record is strictly continuous with the ones before and after</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.pulse_size_bytes">
<code class="highlight language-python"><span class="n">pulse_size_bytes</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>The size in bytes of each binary pulse record (including the timestamps)</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.subframecount">
<code class="highlight language-python"><span class="n">subframecount</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the subframecount memory map.</p>
<p>Old LJH versions don't have this: return zeros, unless overridden by derived class (LJHFile_2_2 will be the only one).</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of subframecount values for each pulse record.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>A string that can be evaluated to re-open this LJH file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A string that can be evaluated to re-open this LJH file."""</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"""mass2.core.ljhfiles.LJHFile.open("</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">")"""</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.open">
<code class="highlight language-python"><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">max_pulses</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Open an LJH file, parsing its header information and returning an LJHFile object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">max_pulses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LJHFile"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Open an LJH file, parsing its header information and returning an LJHFile object."""</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header_dict</span><span class="p">,</span> <span class="n">header_string</span><span class="p">,</span> <span class="n">header_size</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">channum</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Channel"</span><span class="p">]</span>
    <span class="n">timebase</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Timebase"</span><span class="p">]</span>
    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Total Samples"</span><span class="p">]</span>
    <span class="n">npresamples</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Presamples"</span><span class="p">]</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">header_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Software Version"</span><span class="p">,</span> <span class="s2">"UNKNOWN"</span><span class="p">)</span>
    <span class="n">subframediv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">"Subframe divisions"</span> <span class="ow">in</span> <span class="n">header_dict</span><span class="p">:</span>
        <span class="n">subframediv</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Subframe divisions"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">"Number of rows"</span> <span class="ow">in</span> <span class="n">header_dict</span><span class="p">:</span>
        <span class="n">subframediv</span> <span class="o">=</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Number of rows"</span><span class="p">]</span>

    <span class="n">ljh_version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">header_dict</span><span class="p">[</span><span class="s2">"Save File Format Version"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.0.0"</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"LJH files version 1 are not supported"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.1.0"</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">"internal_unused"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"internal_ms"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="n">concrete_LJHFile_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">LJHFile</span><span class="p">]</span> <span class="o">=</span> <span class="n">LJHFile_2_0</span>
    <span class="k">elif</span> <span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.2.0"</span><span class="p">):</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">"internal_us"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"internal_unused"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"internal_ms"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="n">concrete_LJHFile_type</span> <span class="o">=</span> <span class="n">LJHFile_2_1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"posix_usec"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="n">concrete_LJHFile_type</span> <span class="o">=</span> <span class="n">LJHFile_2_2</span>
    <span class="n">pulse_size_bytes</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">binary_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="n">header_size</span>

    <span class="c1"># Fix long-standing bug in LJH files made by MATTER or XCALDAQ_client:</span>
    <span class="c1"># It adds 3 to the "true value" of nPresamples. Assume only DASTARD clients have value correct.</span>
    <span class="k">if</span> <span class="s2">"DASTARD"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">npresamples</span> <span class="o">+=</span> <span class="mi">3</span>

    <span class="n">npulses</span> <span class="o">=</span> <span class="n">binary_size</span> <span class="o">//</span> <span class="n">pulse_size_bytes</span>
    <span class="k">if</span> <span class="n">max_pulses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">npulses</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_pulses</span><span class="p">,</span> <span class="n">npulses</span><span class="p">)</span>
    <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">header_size</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">npulses</span><span class="p">,))</span>

    <span class="k">return</span> <span class="n">concrete_LJHFile_type</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">channum</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">,</span>
        <span class="n">npulses</span><span class="p">,</span>
        <span class="n">timebase</span><span class="p">,</span>
        <span class="n">nsamples</span><span class="p">,</span>
        <span class="n">npresamples</span><span class="p">,</span>
        <span class="n">subframediv</span><span class="p">,</span>
        <span class="n">client</span><span class="p">,</span>
        <span class="n">header_dict</span><span class="p">,</span>
        <span class="n">header_string</span><span class="p">,</span>
        <span class="n">header_size</span><span class="p">,</span>
        <span class="n">binary_size</span><span class="p">,</span>
        <span class="n">mmap</span><span class="p">,</span>
        <span class="n">ljh_version</span><span class="p">,</span>
        <span class="n">max_pulses</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.read_header">
<code class="highlight language-python"><span class="n">read_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Read in the text header of an LJH file. Return the header parsed into a dictionary,
the complete header string (in case you want to generate a new LJH file from this one),
and the size of the header in bytes. The file does not remain open after this method.</p>
<p>Returns:
    (header_dict, header_string, header_size)</p>
<p>Args:
    filename: path to the file to be opened.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">read_header</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Read in the text header of an LJH file. Return the header parsed into a dictionary,</span>
<span class="sd">    the complete header string (in case you want to generate a new LJH file from this one),</span>
<span class="sd">    and the size of the header in bytes. The file does not remain open after this method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (header_dict, header_string, header_size)</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: path to the file to be opened.</span>
<span class="sd">    """</span>
    <span class="c1"># parse header into a dictionary</span>
    <span class="n">header_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"#End of Header"</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"reached EOF before #End of Header"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">OVERLONG_HEADER</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"header is too long--seems not to contain '#End of Header'</span><span class="se">\n</span><span class="s2">in file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="c1"># ignore lines without ":"</span>
            <span class="k">elif</span> <span class="s2">":"</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">header_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">header_size</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">header_string</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1"># Convert values from header_dict into numeric types, when appropriate</span>
    <span class="n">header_dict</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="p">(</span><span class="s2">"Channel"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Timebase"</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Total Samples"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Presamples"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Number of columns"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Number of rows"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Subframe divisions"</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Timestamp offset (s)"</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="c1"># Have to convert to float first, as some early LJH have "Channel: 1.0"</span>
        <span class="n">header_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">header_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">header_dict</span><span class="p">,</span> <span class="n">header_string</span><span class="p">,</span> <span class="n">header_size</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.read_trace">
<code class="highlight language-python"><span class="n">read_trace</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a single pulse record from an LJH file.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>i</code></b>
                  (<code><span title="int">int</span></code>)
              
              <div class="doc-md-description">
<p>Pulse record number (0-indexed)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ArrayLike">ArrayLike</span></code>
              
              <div class="doc-md-description">
<p>A view into the pulse record.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a single pulse record from an LJH file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Pulse record number (0-indexed)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ArrayLike</span>
<span class="sd">        A view into the pulse record.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"data"</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.read_trace_with_timing">
<code class="highlight language-python"><span class="n">read_trace_with_timing</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a single data trace as (subframecount, posix_usec, pulse_record).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_trace_with_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return a single data trace as (subframecount, posix_usec, pulse_record)."""</span>
    <span class="n">pulse_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_trace</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subframecount</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatimes_raw</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pulse_record</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.reopen_binary">
<code class="highlight language-python"><span class="n">reopen_binary</span><span class="p">(</span><span class="n">max_pulses</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Reopen the underlying binary section of the LJH file, in case its size has changed,
without re-reading the LJH header section.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>max_pulses</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="int">int</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A limit to the number of pulses to memory map or None for no limit, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="Self">Self</span></code>
              
              <div class="doc-md-description">
<p>A new <code>LJHFile</code> object with the same header but a new memmap and number of pulses.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reopen_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pulses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"LJHFile"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Reopen the underlying binary section of the LJH file, in case its size has changed,</span>
<span class="sd">    without re-reading the LJH header section.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    max_pulses : Optional[int], optional</span>
<span class="sd">        A limit to the number of pulses to memory map or None for no limit, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Self</span>
<span class="sd">        A new `LJHFile` object with the same header but a new memmap and number of pulses.</span>
<span class="sd">    """</span>
    <span class="n">current_binary_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_size</span>
    <span class="n">npulses</span> <span class="o">=</span> <span class="n">current_binary_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse_size_bytes</span>
    <span class="k">if</span> <span class="n">max_pulses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">npulses</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_pulses</span><span class="p">,</span> <span class="n">npulses</span><span class="p">)</span>
    <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header_size</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">npulses</span><span class="p">,),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">npulses</span><span class="o">=</span><span class="n">npulses</span><span class="p">,</span>
        <span class="n">_mmap</span><span class="o">=</span><span class="n">mmap</span><span class="p">,</span>
        <span class="n">max_pulses</span><span class="o">=</span><span class="n">max_pulses</span><span class="p">,</span>
        <span class="n">binary_size</span><span class="o">=</span><span class="n">current_binary_size</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.to_polars">
<code class="highlight language-python"><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Convert this LJH file to two Polars dataframes: one for the binary data, one for the header.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>first_pulse</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The pulse dataframe starts with this pulse record number, by default 0</p>
</div>
</li>
<li>
<b><code>keep_posix_usec</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to keep the raw <code>posix_usec</code> field in the pulse dataframe, by default False</p>
</div>
</li>
<li>
<b><code>force_continuous</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to claim that the data stream is actually continuous (because it cannot be learned from
data for LJH files before version 2.2.0). Only relevant for noise data files.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="polars.DataFrame">DataFrame</span>, <span title="polars.DataFrame">DataFrame</span>]</code>
              
              <div class="doc-md-description">
<p>(df, header_df)
df: the dataframe containing raw pulse information, one row per pulse
header_df: a one-row dataframe containing the information from the LJH file header</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">first_pulse</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Convert this LJH file to two Polars dataframes: one for the binary data, one for the header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    first_pulse : int, optional</span>
<span class="sd">        The pulse dataframe starts with this pulse record number, by default 0</span>
<span class="sd">    keep_posix_usec : bool, optional</span>
<span class="sd">        Whether to keep the raw `posix_usec` field in the pulse dataframe, by default False</span>
<span class="sd">    force_continuous: bool</span>
<span class="sd">        Whether to claim that the data stream is actually continuous (because it cannot be learned from</span>
<span class="sd">        data for LJH files before version 2.2.0). Only relevant for noise data files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[pl.DataFrame, pl.DataFrame]</span>
<span class="sd">        (df, header_df)</span>
<span class="sd">        df: the dataframe containing raw pulse information, one row per pulse</span>
<span class="sd">        header_df: a one-row dataframe containing the information from the LJH file header</span>
<span class="sd">    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"pulse"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"data"</span><span class="p">][</span><span class="n">first_pulse</span><span class="p">:],</span>
        <span class="s2">"posix_usec"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatimes_raw</span><span class="p">[</span><span class="n">first_pulse</span><span class="p">:],</span>
        <span class="s2">"subframecount"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframecount</span><span class="p">[</span><span class="n">first_pulse</span><span class="p">:],</span>
    <span class="p">}</span>
    <span class="n">schema</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">_typing</span><span class="o">.</span><span class="n">SchemaDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">),</span>
        <span class="s2">"posix_usec"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt64</span><span class="p">,</span>
        <span class="s2">"subframecount"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt64</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"posix_usec"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_posix_usec</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"posix_usec"</span><span class="p">))</span>
    <span class="n">continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_continuous</span> <span class="ow">or</span> <span class="n">force_continuous</span>
    <span class="n">header_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">continuous</span><span class="o">=</span><span class="n">continuous</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile.write_truncated_ljh">
<code class="highlight language-python"><span class="n">write_truncated_ljh</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">npulses</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Write an LJH copy of this file, with a limited number of pulses.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>filename</code></b>
                  (<code><span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>The path where a new LJH file will be created (or replaced).</p>
</div>
</li>
<li>
<b><code>npulses</code></b>
                  (<code><span title="int">int</span></code>)
              
              <div class="doc-md-description">
<p>Number of pulse records to write</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_truncated_ljh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">npulses</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Write an LJH copy of this file, with a limited number of pulses.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path where a new LJH file will be created (or replaced).</span>
<span class="sd">    npulses : int</span>
<span class="sd">        Number of pulse records to write</span>
<span class="sd">    """</span>
    <span class="n">npulses</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npulses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[:</span><span class="n">npulses</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_0">
<code>LJHFile_2_0</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LJHFile


  
      dataclass
   (mass2.core.ljhfiles.LJHFile)" href="#mass2.core.ljhfiles.LJHFile">LJHFile</a></code></p>
<p>LJH files version 2.0, which have internal_ms fields only, but no subframecount and no s information.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LJHFile_2_0</span><span class="p">(</span><span class="n">LJHFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""LJH files version 2.0, which have internal_ms fields only, but no subframecount and no s information."""</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">datatimes_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the raw timestamp (posix usec) memory map.</span>

<span class="sd">        In mass issue #337, we found that computing on the entire memory map at once was prohibitively</span>
<span class="sd">        expensive for large files. To prevent problems, copy chunks of no more than</span>
<span class="sd">        `MAXSEGMENT` records at once.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</span>
<span class="sd">        """</span>
        <span class="n">usec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"internal_ms"</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"Timestamp offset (s)"</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>

        <span class="n">MAXSEGMENT</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">MAXSEGMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
            <span class="n">usec</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">last</span>
        <span class="n">usec</span> <span class="o">=</span> <span class="n">usec</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">offset</span>

        <span class="k">return</span> <span class="n">usec</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">first_pulse</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Generate two Polars dataframes from this LJH file: one for the binary data, one for the header."""</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">df_header</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="n">force_continuous</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"subframecount"</span><span class="p">)),</span> <span class="n">df_header</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_0.datatimes_raw">
<code class="highlight language-python"><span class="n">datatimes_raw</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the raw timestamp (posix usec) memory map.</p>
<p>In mass issue #337, we found that computing on the entire memory map at once was prohibitively
expensive for large files. To prevent problems, copy chunks of no more than
<code>MAXSEGMENT</code> records at once.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_0.to_polars">
<code class="highlight language-python"><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Generate two Polars dataframes from this LJH file: one for the binary data, one for the header.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">first_pulse</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Generate two Polars dataframes from this LJH file: one for the binary data, one for the header."""</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">df_header</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="n">force_continuous</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"subframecount"</span><span class="p">)),</span> <span class="n">df_header</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_1">
<code>LJHFile_2_1</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LJHFile


  
      dataclass
   (mass2.core.ljhfiles.LJHFile)" href="#mass2.core.ljhfiles.LJHFile">LJHFile</a></code></p>
<p>LJH files version 2.1, which have internal_us and internal_ms fields, but no subframecount.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LJHFile_2_1</span><span class="p">(</span><span class="n">LJHFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""LJH files version 2.1, which have internal_us and internal_ms fields, but no subframecount."""</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">datatimes_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the raw timestamp (posix usec) memory map.</span>

<span class="sd">        In mass issue #337, we found that computing on the entire memory map at once was prohibitively</span>
<span class="sd">        expensive for large files. To prevent problems, copy chunks of no more than</span>
<span class="sd">        `MAXSEGMENT` records at once.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</span>
<span class="sd">        """</span>
        <span class="n">usec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"internal_ms"</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"Timestamp offset (s)"</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>

        <span class="n">MAXSEGMENT</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">MAXSEGMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
            <span class="n">usec</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">last</span>
        <span class="n">usec</span> <span class="o">=</span> <span class="n">usec</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">offset</span>

        <span class="c1"># Add the 4 s units found in LJH version 2.1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">"internal_us"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"internal_us"</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">MAXSEGMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
            <span class="n">usec</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">last</span>

        <span class="k">return</span> <span class="n">usec</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">first_pulse</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Generate two Polars dataframes from this LJH file: one for the binary data, one for the header."""</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">df_header</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="n">force_continuous</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"subframecount"</span><span class="p">)),</span> <span class="n">df_header</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_1.datatimes_raw">
<code class="highlight language-python"><span class="n">datatimes_raw</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the raw timestamp (posix usec) memory map.</p>
<p>In mass issue #337, we found that computing on the entire memory map at once was prohibitively
expensive for large files. To prevent problems, copy chunks of no more than
<code>MAXSEGMENT</code> records at once.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_1.to_polars">
<code class="highlight language-python"><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Generate two Polars dataframes from this LJH file: one for the binary data, one for the header.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_polars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">first_pulse</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force_continuous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Generate two Polars dataframes from this LJH file: one for the binary data, one for the header."""</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">df_header</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">first_pulse</span><span class="p">,</span> <span class="n">keep_posix_usec</span><span class="p">,</span> <span class="n">force_continuous</span><span class="o">=</span><span class="n">force_continuous</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"subframecount"</span><span class="p">)),</span> <span class="n">df_header</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_2">
<code>LJHFile_2_2</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LJHFile


  
      dataclass
   (mass2.core.ljhfiles.LJHFile)" href="#mass2.core.ljhfiles.LJHFile">LJHFile</a></code></p>
<p>LJH files version 2.2 and later, which have subframecount and posix_usec fields.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LJHFile_2_2</span><span class="p">(</span><span class="n">LJHFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""LJH files version 2.2 and later, which have subframecount and posix_usec fields."""</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subframecount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the subframecount memory map.</span>

<span class="sd">        In mass issue #337, we found that computing on the entire memory map at once was prohibitively</span>
<span class="sd">        expensive for large files. To prevent problems, copy chunks of no more than</span>
<span class="sd">        `MAXSEGMENT` records at once.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of subframecount values for each pulse record.</span>
<span class="sd">        """</span>
        <span class="n">subframecount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"subframecount"</span><span class="p">]</span>
        <span class="n">MAXSEGMENT</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">MAXSEGMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
            <span class="n">subframecount</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">last</span>
        <span class="k">return</span> <span class="n">subframecount</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">datatimes_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of the raw timestamp (posix usec) memory map.</span>

<span class="sd">        In mass issue #337, we found that computing on the entire memory map at once was prohibitively</span>
<span class="sd">        expensive for large files. To prevent problems, copy chunks of no more than</span>
<span class="sd">        `MAXSEGMENT` records at once.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</span>
<span class="sd">        """</span>
        <span class="n">usec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">"posix_usec"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"posix_usec"</span><span class="p">]</span>

        <span class="n">MAXSEGMENT</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="n">MAXSEGMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
            <span class="n">usec</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">last</span>
        <span class="k">return</span> <span class="n">usec</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this LJH file made of a perfectly continuous data stream?</span>

<span class="sd">        We generally do take noise data in this mode, and it's useful to analyze the noise</span>
<span class="sd">        data by gluing many records together. This property says whether such gluing is valid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether every record is strictly continuous with the ones before and after</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">expected_subframe_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span>
        <span class="n">subframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"subframecount"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">subframe</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">expected_subframe_diff</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_2.datatimes_raw">
<code class="highlight language-python"><span class="n">datatimes_raw</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the raw timestamp (posix usec) memory map.</p>
<p>In mass issue #337, we found that computing on the entire memory map at once was prohibitively
expensive for large files. To prevent problems, copy chunks of no more than
<code>MAXSEGMENT</code> records at once.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of timestamp values for each pulse record, in microseconds since the epoh (1970).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_2.is_continuous">
<code class="highlight language-python"><span class="n">is_continuous</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this LJH file made of a perfectly continuous data stream?</p>
<p>We generally do take noise data in this mode, and it's useful to analyze the noise
data by gluing many records together. This property says whether such gluing is valid.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="bool">bool</span></code>
              
              <div class="doc-md-description">
<p>Whether every record is strictly continuous with the ones before and after</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.ljhfiles.LJHFile_2_2.subframecount">
<code class="highlight language-python"><span class="n">subframecount</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return a copy of the subframecount memory map.</p>
<p>In mass issue #337, we found that computing on the entire memory map at once was prohibitively
expensive for large files. To prevent problems, copy chunks of no more than
<code>MAXSEGMENT</code> records at once.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.ndarray">ndarray</span></code>
              
              <div class="doc-md-description">
<p>An array of subframecount values for each pulse record.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.ljhutil"></a>
<div class="doc doc-contents first">
<p>Utility functions for handling and finding LJH files, and opening them as Channel or Channels objects.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.experiment_state_path_from_ljh_path">
<code class="highlight language-python"><span class="n">experiment_state_path_from_ljh_path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the experiment_state.txt file in the directory of the given ljh file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">experiment_state_path_from_ljh_path</span><span class="p">(</span>
    <span class="n">ljh_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Find the experiment_state.txt file in the directory of the given ljh file."""</span>
    <span class="n">ljh_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>  <span class="c1"># Convert to Path if it's a string</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_chan"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_experiment_state.txt"</span>
    <span class="k">return</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">new_file_name</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.external_trigger_bin_path_from_ljh_path">
<code class="highlight language-python"><span class="n">external_trigger_bin_path_from_ljh_path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the external_trigger.bin file in the directory of the given ljh file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">external_trigger_bin_path_from_ljh_path</span><span class="p">(</span>
    <span class="n">ljh_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Find the external_trigger.bin file in the directory of the given ljh file."""</span>
    <span class="n">ljh_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>  <span class="c1"># Convert to Path if it's a string</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_chan"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_external_trigger.bin"</span>
    <span class="k">return</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">new_file_name</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.extract_channel_number">
<code class="highlight language-python"><span class="n">extract_channel_number</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Extracts the channel number from the .ljh file name.</p>
<p>Args:
- file_path (str): The path to the .ljh file.</p>
<p>Returns:
- int: The channel number.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_channel_number</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Extracts the channel number from the .ljh file name.</span>

<span class="sd">    Args:</span>
<span class="sd">    - file_path (str): The path to the .ljh file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - int: The channel number.</span>
<span class="sd">    """</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"_chan(\d+)\..*$"</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File path does not match expected pattern: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.filename_glob_expand">
<code class="highlight language-python"><span class="n">filename_glob_expand</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the result of glob-expansion on the input pattern.</p>
<p>:param pattern: Aglob pattern and return the glob-result as a list.
:type pattern: str
:return: filenames; the result is sorted first by str.sort, then by ljh_sort_filenames_numerically()
:rtype: list</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filename_glob_expand</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return the result of glob-expansion on the input pattern.</span>

<span class="sd">    :param pattern: Aglob pattern and return the glob-result as a list.</span>
<span class="sd">    :type pattern: str</span>
<span class="sd">    :return: filenames; the result is sorted first by str.sort, then by ljh_sort_filenames_numerically()</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    """</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ljh_sort_filenames_numerically</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.find_folders_with_extension">
<code class="highlight language-python"><span class="n">find_folders_with_extension</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">extensions</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Finds all folders within the root_path that contain at least one file with the given extension.</p>
<p>Args:
- root_path (str): The root directory to start the search from.
- extension (str): The file extension to search for (e.g., '.txt').</p>
<p>Returns:
- list[str]: A list of paths to directories containing at least one file with the given extension.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_folders_with_extension</span><span class="p">(</span><span class="n">root_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Finds all folders within the root_path that contain at least one file with the given extension.</span>

<span class="sd">    Args:</span>
<span class="sd">    - root_path (str): The root directory to start the search from.</span>
<span class="sd">    - extension (str): The file extension to search for (e.g., '.txt').</span>

<span class="sd">    Returns:</span>
<span class="sd">    - list[str]: A list of paths to directories containing at least one file with the given extension.</span>
<span class="sd">    """</span>
    <span class="n">matching_folders</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Walk through the directory tree</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root_path</span><span class="p">):</span>
        <span class="c1"># Check if any file in the current directory has the given extension</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extension</span><span class="p">):</span>
                    <span class="n">matching_folders</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
                    <span class="k">break</span>  <span class="c1"># No need to check further, move to the next directory</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">matching_folders</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.find_ljh_files">
<code class="highlight language-python"><span class="n">find_ljh_files</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">'.ljh'</span><span class="p">,</span> <span class="n">search_subdirectories</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="p">[],</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Finds all files of a specific file extension in the given folder and (optionally) its subfolders.</p>
<p>An optional list of channel numbers can be excluded from the results. Also optionally, the results
can be restricted only to a specific list of channel numbers.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>folder</code></b>
                  (<code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>)
              
              <div class="doc-md-description">
<p>Folder to search for data files</p>
</div>
</li>
<li>
<b><code>ext</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>'.ljh'</code>
)
              
              <div class="doc-md-description">
<p>The filename extension to search for, by default ".ljh"</p>
</div>
</li>
<li>
<b><code>search_subdirectories</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to search the subdirectories of <code>folder</code> recursively, by default False</p>
</div>
</li>
<li>
<b><code>exclude_ch_nums</code></b>
                  (<code><span title="list">list</span>[<span title="int">int</span>]</code>, default:
                      <code>[]</code>
)
              
              <div class="doc-md-description">
<p>List of channel numbers to exclude from the results, by default []</p>
</div>
</li>
<li>
<b><code>include_ch_nums</code></b>
                  (<code><span title="list">list</span>[<span title="int">int</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>If not None, then a list of channel # such that results are excluded if they don't appear in the list, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="list">list</span>[<span title="str">str</span>]</code>
              
              <div class="doc-md-description">
<p>A list of paths to .ljh files.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>When the <code>include_ch_nums</code> list exists and contains one or more channels also in <code>exclude_ch_nums</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_ljh_files</span><span class="p">(</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">".ljh"</span><span class="p">,</span>
    <span class="n">search_subdirectories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">exclude_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">include_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Finds all files of a specific file extension in the given folder and (optionally) its subfolders.</span>

<span class="sd">    An optional list of channel numbers can be excluded from the results. Also optionally, the results</span>
<span class="sd">    can be restricted only to a specific list of channel numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str | pathlib.Path</span>
<span class="sd">        Folder to search for data files</span>
<span class="sd">    ext : str, optional</span>
<span class="sd">        The filename extension to search for, by default ".ljh"</span>
<span class="sd">    search_subdirectories : bool, optional</span>
<span class="sd">        Whether to search the subdirectories of `folder` recursively, by default False</span>
<span class="sd">    exclude_ch_nums : list[int], optional</span>
<span class="sd">        List of channel numbers to exclude from the results, by default []</span>
<span class="sd">    include_ch_nums : list[int] | None, optional</span>
<span class="sd">        If not None, then a list of channel # such that results are excluded if they don't appear in the list, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[str]</span>
<span class="sd">        A list of paths to .ljh files.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        When the `include_ch_nums` list exists and contains one or more channels also in `exclude_ch_nums`.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">include_ch_nums</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">include_ch_nums</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">exclude_ch_nums</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"exclude and include lists should not overlap, but both include channels </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="n">ljh_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">search_subdirectories</span><span class="p">:</span>
        <span class="n">pathgen</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pathgen</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="n">folder</span><span class="p">],</span> <span class="p">[[</span><span class="s2">""</span><span class="p">]],</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">pathgen</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
                <span class="n">ch_num</span> <span class="o">=</span> <span class="n">extract_channel_number</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="n">exclude_ch_nums</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">include_ch_nums</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ch_num</span> <span class="ow">in</span> <span class="n">include_ch_nums</span><span class="p">):</span>
                    <span class="n">ljh_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ljh_files</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.helper_write_pulse">
<code class="highlight language-python"><span class="n">helper_write_pulse</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Write a single pulse from one LJHFile to another open file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">helper_write_pulse</span><span class="p">(</span><span class="n">dest</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="n">LJHFile</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Write a single pulse from one LJHFile to another open file."""</span>
    <span class="n">subframecount</span><span class="p">,</span> <span class="n">timestamp_usec</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read_trace_with_timing</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">subframecount</span><span class="p">))</span>
    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_usec</span><span class="p">))</span>
    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">trace</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.ljh_append_traces">
<code class="highlight language-python"><span class="n">ljh_append_traces</span><span class="p">(</span><span class="n">src_name</span><span class="p">,</span> <span class="n">dest_name</span><span class="p">,</span> <span class="n">pulses</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Append traces from one LJH file onto another. The destination file is
assumed to be version 2.2.0.</p>
<p>Can be used to grab specific traces from some other ljh file, and append them onto an existing ljh file.</p>
<p>Args:
    src_name: the name of the source file
    dest_name: the name of the destination file
    pulses: indices of the pulses to copy (default: None, meaning copy all)</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ljh_append_traces</span><span class="p">(</span><span class="n">src_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pulses</span><span class="p">:</span> <span class="nb">range</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Append traces from one LJH file onto another. The destination file is</span>
<span class="sd">    assumed to be version 2.2.0.</span>

<span class="sd">    Can be used to grab specific traces from some other ljh file, and append them onto an existing ljh file.</span>

<span class="sd">    Args:</span>
<span class="sd">        src_name: the name of the source file</span>
<span class="sd">        dest_name: the name of the destination file</span>
<span class="sd">        pulses: indices of the pulses to copy (default: None, meaning copy all)</span>
<span class="sd">    """</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pulses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pulses</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">npulses</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_name</span><span class="p">,</span> <span class="s2">"ab"</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest_fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pulses</span><span class="p">:</span>
            <span class="n">helper_write_pulse</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.ljh_merge">
<code class="highlight language-python"><span class="n">ljh_merge</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Merge a set of LJH files to a single output file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ljh_merge</span><span class="p">(</span><span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filenames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Merge a set of LJH files to a single output file."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"To overwrite destination </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">, use the --force flag"</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out_path</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
    <span class="n">channum</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">channum</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> LJH files from channel </span><span class="si">{</span><span class="n">channum</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&lt;-- </span><span class="si">{</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">in_fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">channum</span> <span class="o">!=</span> <span class="n">channum</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"file '</span><span class="si">{</span><span class="n">in_fname</span><span class="si">}</span><span class="s2">' channel=</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">channum</span><span class="si">}</span><span class="s2">, but want </span><span class="si">{</span><span class="n">channum</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"&lt;-- </span><span class="si">{</span><span class="n">in_fname</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">ljh_append_traces</span><span class="p">(</span><span class="n">in_fname</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"--&gt; </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">    size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> bytes.</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.ljh_sort_filenames_numerically">
<code class="highlight language-python"><span class="n">ljh_sort_filenames_numerically</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">inclusion_list</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Sort filenames of the form '<em>_chanXXX.</em>', according to the numerical value of channel number XXX.</p>
<p>Filenames are first sorted by the usual string comparisons, then by channel number. In this way,
the standard sort is applied to all files with the same channel number.</p>
<p>:param fnames: A sequence of filenames of the form '<em>_chan</em>.*'
:type fnames: list of str
:param inclusion_list: If not None, a container with channel numbers. All files
    whose channel numbers are not on this list will be omitted from the
    output, defaults to None
:type inclusion_list: sequence of int, optional
:return: A list containg the same filenames, sorted according to the numerical value of channel number.
:rtype: list</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ljh_sort_filenames_numerically</span><span class="p">(</span><span class="n">fnames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">inclusion_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Sort filenames of the form '*_chanXXX.*', according to the numerical value of channel number XXX.</span>

<span class="sd">    Filenames are first sorted by the usual string comparisons, then by channel number. In this way,</span>
<span class="sd">    the standard sort is applied to all files with the same channel number.</span>

<span class="sd">    :param fnames: A sequence of filenames of the form '*_chan*.*'</span>
<span class="sd">    :type fnames: list of str</span>
<span class="sd">    :param inclusion_list: If not None, a container with channel numbers. All files</span>
<span class="sd">        whose channel numbers are not on this list will be omitted from the</span>
<span class="sd">        output, defaults to None</span>
<span class="sd">    :type inclusion_list: sequence of int, optional</span>
<span class="sd">    :return: A list containg the same filenames, sorted according to the numerical value of channel number.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">inclusion_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">extract_channel_number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inclusion_list</span><span class="p">,</span> <span class="n">fnames</span><span class="p">))</span>

    <span class="c1"># Sort the results first by raw filename, then sort numerically by LJH channel number.</span>
    <span class="c1"># Because string sort and the builtin `sorted` are both stable, we ensure that the first</span>
    <span class="c1"># sort is used to break ties in channel number.</span>
    <span class="n">fnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">extract_channel_number</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.ljh_truncate">
<code class="highlight language-python"><span class="n">ljh_truncate</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">n_pulses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Truncate an LJH file.</p>
<p>Writes a new copy of an LJH file, with the same header but fewer raw data pulses.</p>
<p>Arguments:
input_filename  -- name of file to truncate
output_filename -- filename for truncated file
n_pulses        -- truncate to include only this many pulses (default None)
timestamp       -- truncate to include only pulses with timestamp earlier
                   than this number (default None)</p>
<p>Exactly one of n_pulses and timestamp must be specified.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ljh_truncate</span><span class="p">(</span><span class="n">input_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_pulses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Truncate an LJH file.</span>

<span class="sd">    Writes a new copy of an LJH file, with the same header but fewer raw data pulses.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    input_filename  -- name of file to truncate</span>
<span class="sd">    output_filename -- filename for truncated file</span>
<span class="sd">    n_pulses        -- truncate to include only this many pulses (default None)</span>
<span class="sd">    timestamp       -- truncate to include only pulses with timestamp earlier</span>
<span class="sd">                       than this number (default None)</span>

<span class="sd">    Exactly one of n_pulses and timestamp must be specified.</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n_pulses</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n_pulses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Must specify exactly one of n_pulses, timestamp."</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">" Values were </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">n_pulses</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Check for file problems, then open the input and output LJH files.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Input '</span><span class="si">{</span><span class="n">input_filename</span><span class="si">}</span><span class="s2">' and output '</span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2">' are the same file, which is not allowed"</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">infile</span> <span class="o">=</span> <span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">infile</span><span class="o">.</span><span class="n">ljh_version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">"2.2.0"</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Don't know how to truncate this LJH version [</span><span class="si">{</span><span class="n">infile</span><span class="o">.</span><span class="n">ljh_version</span><span class="si">}</span><span class="s2">]"</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="c1"># write the header as a single string.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">infile</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">"#End of Header</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Write pulses.</span>
        <span class="k">if</span> <span class="n">n_pulses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_pulses</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">npulses</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pulses</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">infile</span><span class="o">.</span><span class="n">datatimes_float</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">subframecount</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&lt;Q"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">datatimes_raw</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read_trace</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.main_ljh_merge">
<code class="highlight language-python"><span class="n">main_ljh_merge</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>Merge all LJH files that match a pattern to a single output file.</p>
<p>The idea is that all such files come from a single TES and could have been
(but were not) written as a single continuous file.</p>
<p>The pattern should be of the form "blah_blah_*_chan1.ljh" or something.
The output will then be "merged_chan1.ljh" in the directory of the first file found
(or alter the directory with the --outdir argument). It is not (currently) possible to
merge data from LJH files that represent channels with different numbers.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main_ljh_merge</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Merge all LJH files that match a pattern to a single output file.</span>

<span class="sd">    The idea is that all such files come from a single TES and could have been</span>
<span class="sd">    (but were not) written as a single continuous file.</span>

<span class="sd">    The pattern should be of the form "blah_blah_*_chan1.ljh" or something.</span>
<span class="sd">    The output will then be "merged_chan1.ljh" in the directory of the first file found</span>
<span class="sd">    (or alter the directory with the --outdir argument). It is not (currently) possible to</span>
<span class="sd">    merge data from LJH files that represent channels with different numbers.</span>
<span class="sd">    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Merge a set of LJH files"</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">"Beware! Python glob does not perform brace-expansion, so braces must be expanded by the shell."</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">"patterns"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">"+"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'glob pattern of files to process, e.g. "20171116_*_chan1.ljh" (suggest double quotes)'</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">"-d"</span><span class="p">,</span>
        <span class="s2">"--outdir"</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"directory to place output file (default: same as directory of first file to be merged"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># TODO: add way to control the output _filename_</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-F"</span><span class="p">,</span> <span class="s2">"--force"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"force overwrite of existing target? (default: False)"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-v"</span><span class="p">,</span> <span class="s2">"--verbose"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"list files found before merging (default: False)"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-n"</span><span class="p">,</span> <span class="s2">"--dry-run"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"list files found, then quit without merging (default: False)"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">filenames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">patterns</span><span class="p">:</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filename_glob_expand</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Will expand the following </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="si">}</span><span class="s2"> files:"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"  - "</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="n">ljh</span> <span class="o">=</span> <span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">channum</span> <span class="o">=</span> <span class="n">ljh</span><span class="o">.</span><span class="n">channum</span>

    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_dir</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"merged_chan</span><span class="si">{</span><span class="n">channum</span><span class="si">}</span><span class="s2">.ljh"</span><span class="p">)</span>

    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">force</span>
    <span class="n">ljh_merge</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.main_ljh_truncate">
<code class="highlight language-python"><span class="n">main_ljh_truncate</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>A convenience script to truncate all LJH files that match a pattern, writing a new LJH file for each
that contains only the first N pulse records.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main_ljh_truncate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A convenience script to truncate all LJH files that match a pattern, writing a new LJH file for each</span>
<span class="sd">    that contains only the first N pulse records.</span>
<span class="sd">    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Truncate a set of LJH files"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"pattern"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"basename of files to process, e.g. 20171116_152922"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"out"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"string to append to basename when creating output filename"</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--npulses"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"Number of pulses to keep"</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--timestamp"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"Keep only pulses before this timestamp"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pattern</span><span class="si">}</span><span class="s2">_chan*.ljh"</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="n">filename_glob_expand</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">in_fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"chan(\d+)\.ljh"</span><span class="p">,</span> <span class="n">in_fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">out_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">pattern</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="si">}</span><span class="s2">_chan</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">.ljh"</span>
            <span class="n">ljh_truncate</span><span class="p">(</span><span class="n">in_fname</span><span class="p">,</span> <span class="n">out_fname</span><span class="p">,</span> <span class="n">n_pulses</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.ljhutil.match_files_by_channel">
<code class="highlight language-python"><span class="n">match_files_by_channel</span><span class="p">(</span><span class="n">folder1</span><span class="p">,</span> <span class="n">folder2</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="p">[],</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Matches .ljh files from two folders by channel number.</p>
<p>Args:
- folder1 (str): The first root directory.
- folder2 (str): The second root directory.</p>
<p>Returns:
- list[Iterator[tuple[str, str]]]: A list of iterators, each containing pairs of paths with matching channel numbers.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>When the <code>include_ch_nums</code> list exists and contains one or more channels also in <code>exclude_ch_nums</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/ljhutil.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">match_files_by_channel</span><span class="p">(</span>
    <span class="n">folder1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">folder2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">include_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Matches .ljh files from two folders by channel number.</span>

<span class="sd">    Args:</span>
<span class="sd">    - folder1 (str): The first root directory.</span>
<span class="sd">    - folder2 (str): The second root directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - list[Iterator[tuple[str, str]]]: A list of iterators, each containing pairs of paths with matching channel numbers.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        When the `include_ch_nums` list exists and contains one or more channels also in `exclude_ch_nums`.</span>
<span class="sd">    """</span>
    <span class="n">files1</span> <span class="o">=</span> <span class="n">find_ljh_files</span><span class="p">(</span><span class="n">folder1</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="n">include_ch_nums</span><span class="p">)</span>
    <span class="n">files2</span> <span class="o">=</span> <span class="n">find_ljh_files</span><span class="p">(</span><span class="n">folder2</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">,</span> <span class="n">include_ch_nums</span><span class="o">=</span><span class="n">include_ch_nums</span><span class="p">)</span>
    <span class="c1"># print(f"in folder {folder1} found {len(files1)} files")</span>
    <span class="c1"># print(f"in folder {folder2} found {len(files2)} files")</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_to_dict_error_on_repeat_channel</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Collects files into a dictionary by channel number, raising an error if a channel number is repeated.</span>
<span class="sd">        """</span>
        <span class="n">files_by_channel</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">extract_channel_number</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">files_by_channel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">existing_file</span> <span class="o">=</span> <span class="n">files_by_channel</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Duplicate channel number found: </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> in file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> and already in </span><span class="si">{</span><span class="n">existing_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">files_by_channel</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>
        <span class="k">return</span> <span class="n">files_by_channel</span>

    <span class="c1"># we could have repeat channels even in the same folder, so we should error on that</span>
    <span class="n">files1_by_channel</span> <span class="o">=</span> <span class="n">collect_to_dict_error_on_repeat_channel</span><span class="p">(</span><span class="n">files1</span><span class="p">)</span>
    <span class="n">files2_by_channel</span> <span class="o">=</span> <span class="n">collect_to_dict_error_on_repeat_channel</span><span class="p">(</span><span class="n">files2</span><span class="p">)</span>

    <span class="n">matching_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files1_by_channel</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">files2_by_channel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">matching_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">files1_by_channel</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">files2_by_channel</span><span class="p">[</span><span class="n">channel</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">matching_pairs</span> <span class="o">=</span> <span class="n">matching_pairs</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">matching_pairs</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.misc"></a>
<div class="doc doc-contents first">
<p>Miscellaneous utility functions used in mass2 for plotting, pickling, statistics, and DataFrame manipulation.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.alwaysTrue">
<code class="highlight language-python"><span class="n">alwaysTrue</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>alwaysTrue: a factory function to generate a new copy of polars literal True for class construction</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="polars.Expr">Expr</span></code>
              
              <div class="doc-md-description">
<p>Literal True</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">alwaysTrue</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""alwaysTrue: a factory function to generate a new copy of polars literal True for class construction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pl.Expr</span>
<span class="sd">        Literal True</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.concat_dfs_with_concat_state">
<code class="highlight language-python"><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">concat_state_col</span><span class="o">=</span><span class="s1">'concat_state'</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Concatenate two DataFrames vertically, adding a column <code>concat_state</code> (or named according to <code>concat_state_col</code>)
to indicate which DataFrame each row came from.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">concat_dfs_with_concat_state</span><span class="p">(</span><span class="n">df1</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">concat_state_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"concat_state"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Concatenate two DataFrames vertically, adding a column `concat_state` (or named according to `concat_state_col`)</span>
<span class="sd">    to indicate which DataFrame each row came from."""</span>
    <span class="k">if</span> <span class="n">concat_state_col</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Continue incrementing from the last known concat_state</span>
        <span class="n">max_state</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">concat_state_col</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">max_state</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">concat_state_col</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fresh concat: label first as 0, second as 1</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">concat_state_col</span><span class="p">))</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">concat_state_col</span><span class="p">))</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">"vertical"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_out</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.extract_column_names_from_polars_expr">
<code class="highlight language-python"><span class="n">extract_column_names_from_polars_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Recursively extract all column names from a Polars expression.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_column_names_from_polars_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Recursively extract all column names from a Polars expression."""</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">"meta"</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">meta</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"root_names"</span><span class="p">):</span>
            <span class="c1"># For polars &gt;=0.19.0</span>
            <span class="n">names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">root_names</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"output_name"</span><span class="p">):</span>
            <span class="c1"># For older polars</span>
            <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">output_name</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"inputs"</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subexpr</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">inputs</span><span class="p">():</span>
                <span class="n">names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract_column_names_from_polars_expr</span><span class="p">(</span><span class="n">subexpr</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.good_series">
<code class="highlight language-python"><span class="n">good_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return a Series from the given DataFrame column, filtered by the given good_expr and use_expr.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">good_series</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a Series from the given DataFrame column, filtered by the given good_expr and use_expr."""</span>
    <span class="c1"># This uses lazy before filtering. We hope this will allow polars to only access the data needed to filter</span>
    <span class="c1"># and the data needed to output what we want.</span>
    <span class="n">good_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">good_expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">good_df</span> <span class="o">=</span> <span class="n">good_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">good_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.hist_of_series">
<code class="highlight language-python"><span class="n">hist_of_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the bin centers and counts of a histogram of the given Series using the given bin edges.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hist_of_series</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return the bin centers and counts of a histogram of the given Series using the given bin edges."""</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">"count"</span><span class="p">)</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="n">include_category</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_breakpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.launch_examples">
<code class="highlight language-python"><span class="n">launch_examples</span><span class="p">()</span></code>
</h2>
<div class="doc doc-contents">
<p>Launch marimo edit in the examples folder.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">launch_examples</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Launch marimo edit in the examples folder."""</span>
    <span class="n">examples_folder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">"examples"</span>
    <span class="c1"># use relative path to avoid this bug: https://github.com/marimo-team/marimo/issues/1895</span>
    <span class="n">examples_folder_relative</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">examples_folder</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()))</span>
    <span class="c1"># Prepare the command</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"marimo"</span><span class="p">,</span> <span class="s2">"edit"</span><span class="p">,</span> <span class="n">examples_folder_relative</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># Execute the command</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"launching marimo edit in </span><span class="si">{</span><span class="n">examples_folder_relative</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Execute the command and directly forward stdout and stderr</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="c1"># Handle cleanup on Ctrl-C</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Check if the command was successful</span>
    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.median_absolute_deviation">
<code class="highlight language-python"><span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the median absolute deviation of the input, unnormalized.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">median_absolute_deviation</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the median absolute deviation of the input, unnormalized."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.merge_dicts_ordered_by_keys">
<code class="highlight language-python"><span class="n">merge_dicts_ordered_by_keys</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Merge two dictionaries and return a new dictionary with items ordered by key.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">merge_dicts_ordered_by_keys</span><span class="p">(</span><span class="n">dict1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">dict2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Merge two dictionaries and return a new dictionary with items ordered by key."""</span>
    <span class="c1"># Combine both dictionaries' items (key, value) into a list of tuples</span>
    <span class="n">combined_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict1</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict2</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="c1"># Sort the combined list of tuples by key</span>
    <span class="n">combined_items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Convert the sorted list of tuples back into a dictionary</span>
    <span class="n">merged_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combined_items</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">merged_dict</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.midpoints_and_step_size">
<code class="highlight language-python"><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>return midpoints, step_size for bin edges x</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">midpoints_and_step_size</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""return midpoints, step_size for bin edges x"""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">d</span><span class="si">=}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">step_size</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.outlier_resistant_nsigma_above_mid">
<code class="highlight language-python"><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>RReturn the value that is <code>nsigma</code> median absolute deviations (MADs) above the median of the input.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""RReturn the value that is `nsigma` median absolute deviations (MADs) above the median of the input."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">nsigma</span> <span class="o">*</span> <span class="n">sigma_mad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.outlier_resistant_nsigma_range_from_mid">
<code class="highlight language-python"><span class="n">outlier_resistant_nsigma_range_from_mid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the values that are <code>nsigma</code> median absolute deviations (MADs) below and above the median of the input</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">outlier_resistant_nsigma_range_from_mid</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return the values that are `nsigma` median absolute deviations (MADs) below and above the median of the input"""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">smad</span> <span class="o">=</span> <span class="n">sigma_mad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">nsigma</span> <span class="o">*</span> <span class="n">smad</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">nsigma</span> <span class="o">*</span> <span class="n">smad</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.pickle_object">
<code class="highlight language-python"><span class="n">pickle_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Pickle the given object to the given filename using dill.
Mass2 Recipe objects are compatible with <code>dill</code> but <em>not</em> with the standard <code>pickle</code> module.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pickle_object</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Pickle the given object to the given filename using dill.</span>
<span class="sd">    Mass2 Recipe objects are compatible with `dill` but _not_ with the standard `pickle` module."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.plot_a_vs_b_series">
<code class="highlight language-python"><span class="n">plot_a_vs_b_series</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Plot the two given Series as a scatterplot on the given axis (or a new one if None).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_a_vs_b_series</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the two given Series as a scatterplot on the given axis (or a new one if None)."""</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.plot_hist_of_series">
<code class="highlight language-python"><span class="n">plot_hist_of_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Plot a histogram of the given Series using the given bin edges on the given axis (or a new one if None).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hist_of_series</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot a histogram of the given Series using the given bin edges on the given axis (or a new one if None)."""</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">"count"</span><span class="p">)</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="n">include_category</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_breakpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axis</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.root_mean_squared">
<code class="highlight language-python"><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the root mean square of the input along the given axis or axes.
Does <em>not</em> subtract the mean first.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">root_mean_squared</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the root mean square of the input along the given axis or axes.</span>
<span class="sd">    Does _not_ subtract the mean first."""</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.show">
<code class="highlight language-python"><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Create a Marimo interactive view of the given Matplotlib figure (or the current figure if None).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">Html</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Marimo interactive view of the given Matplotlib figure (or the current figure if None)."""</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mo</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.sigma_mad">
<code class="highlight language-python"><span class="n">sigma_mad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the nomrlized median absolute deviation of the input, rescaled to give the standard deviation
if distribution is Gaussian. This method is more robust to outliers than calculating the standard deviation directly.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sigma_mad</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the nomrlized median absolute deviation of the input, rescaled to give the standard deviation</span>
<span class="sd">    if distribution is Gaussian. This method is more robust to outliers than calculating the standard deviation directly."""</span>
    <span class="k">return</span> <span class="n">median_absolute_deviation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.4826</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.smallest_positive_real">
<code class="highlight language-python"><span class="n">smallest_positive_real</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the smallest positive real number in the given array-like object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">smallest_positive_real</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the smallest positive real number in the given array-like object."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_positive_real</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s2">"Is `x` a positive real number?"</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">positive_real_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_positive_real</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positive_real_numbers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.misc.unpickle_object">
<code class="highlight language-python"><span class="n">unpickle_object</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Unpickle an object from the given filename using dill.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/misc.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unpickle_object</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Unpickle an object from the given filename using dill."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.multifit"></a>
<div class="doc doc-contents first">
<p>Tools for fitting multiple spectral lines in a single pass.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.multifit.FitSpec">
<code>FitSpec</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Specification of a single line fit within a MultiFit.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FitSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Specification of a single line fit within a MultiFit."""</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">GenericLineModel</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>
    <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">Parameters</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">counts</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a reasonable guess at the parameters given the spectrum to be fit."""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_update</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_series_without_use_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit the given Series without applying a use_expr filter."""</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
            <span class="n">ds_shortname</span><span class="o">=</span><span class="s2">"??"</span><span class="p">,</span>
            <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
            <span class="n">attr_str</span><span class="o">=</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit the given DataFrame column `col` after applying good_expr and use_expr filters."""</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_series_without_use_expr</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit the given Channel's DataFrame column `col` after applying the Channel's good_expr and</span>
<span class="sd">        this FitSpec's use_expr filters."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.FitSpec.fit_ch">
<code class="highlight language-python"><span class="n">fit_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit the given Channel's DataFrame column <code>col</code> after applying the Channel's good_expr and
this FitSpec's use_expr filters.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit the given Channel's DataFrame column `col` after applying the Channel's good_expr and</span>
<span class="sd">    this FitSpec's use_expr filters."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.FitSpec.fit_df">
<code class="highlight language-python"><span class="n">fit_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit the given DataFrame column <code>col</code> after applying good_expr and use_expr filters.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit the given DataFrame column `col` after applying good_expr and use_expr filters."""</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_series_without_use_expr</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.FitSpec.fit_series_without_use_expr">
<code class="highlight language-python"><span class="n">fit_series_without_use_expr</span><span class="p">(</span><span class="n">series</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit the given Series without applying a use_expr filter.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_series_without_use_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit the given Series without applying a use_expr filter."""</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
        <span class="n">binsize</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
        <span class="n">ds_shortname</span><span class="o">=</span><span class="s2">"??"</span><span class="p">,</span>
        <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
        <span class="n">attr_str</span><span class="o">=</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.FitSpec.params">
<code class="highlight language-python"><span class="n">params</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a reasonable guess at the parameters given the spectrum to be fit.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">counts</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a reasonable guess at the parameters given the spectrum to be fit."""</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_update</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.multifit.MultiFit">
<code>MultiFit</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Specification of multiple emission-line fits to be done in one pass.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiFit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Specification of multiple emission-line fits to be done in one pass."""</span>

    <span class="n">default_fit_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">default_bin_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">default_use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">)</span>
    <span class="n">default_params_update</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">)</span>
    <span class="n">fitspecs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FitSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_line</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this MultiFit with an additional FitSpec for the given line."""</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">peak_energy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
        <span class="n">dlo</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">dlo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">dhi</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">dhi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">bin_size</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_bin_size</span><span class="p">)</span>
        <span class="n">params_update</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">params_update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_params_update</span><span class="p">)</span>
        <span class="n">use_expr</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">use_expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_use_expr</span><span class="p">)</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">dlo</span><span class="p">,</span> <span class="n">dhi</span> <span class="o">+</span> <span class="n">bin_size</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">peak_energy</span>
        <span class="n">fitspec</span> <span class="o">=</span> <span class="n">FitSpec</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">,</span> <span class="n">params_update</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_fitspec</span><span class="p">(</span><span class="n">fitspec</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_fitspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitspec</span><span class="p">:</span> <span class="n">FitSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this MultiFit with a new FitSpec added."""</span>
        <span class="c1"># make sure they're always sorted by energy</span>
        <span class="n">newfitspecs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span> <span class="o">+</span> <span class="p">[</span><span class="n">fitspec</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitspecs</span><span class="o">=</span><span class="n">newfitspecs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this MultiFit with the given results added."""</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">results_params_as_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a DataFrame made from the fit parameters from the results."""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">"line"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">shortname</span> <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span> <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">"peak_energy_ref_err"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for quickline, position_uncertainty is a string</span>
        <span class="c1"># translate that into a large value for uncertainty so we can proceed without crashing</span>
        <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">position_uncertainty</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>  <span class="c1"># 10% error is large!</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">position_uncertainty</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">"peak_energy_ref_err"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
            <span class="n">d</span><span class="p">[</span><span class="n">param_name</span> <span class="o">+</span> <span class="s2">"_stderr"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_series_without_use_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
        <span class="s2">"Fit all the FitSpecs in this MultiFit to the given Series without applying any use_expr filter."</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitspec</span><span class="o">.</span><span class="n">fit_series_without_use_expr</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit all the FitSpecs in this MultiFit to the given DataFrame column `col` after applying good_expr filter."""</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">fitspec</span><span class="o">.</span><span class="n">fit_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit all the FitSpecs in this MultiFit to the given Channel's DataFrame column `col`</span>
<span class="sd">        after applying the Channel's good_expr filter."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_extra_axes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Plot all the fit results in subplots, with n_extra_axes empty subplots included at the end."""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra_axes</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># Adjust figure size as needed</span>

        <span class="c1"># If there's only one subplot, axes is not a list but a single Axes object.</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">plotm</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Hide any remaining empty subplots</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">:]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results_and_pfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncalibrated_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">n_extra_axes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot all the fit results in subplots, and also plot the gain curve on an extra axis."""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">_fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">n_extra_axes</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n_extra_axes</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)]</span>
        <span class="n">multifit_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_params_as_df</span><span class="p">()</span>
        <span class="n">peaks_in_energy_rough_cal</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">peaks_uncalibrated</span> <span class="o">=</span> <span class="n">previous_energy2ph</span><span class="p">(</span><span class="n">peaks_in_energy_rough_cal</span><span class="p">)</span>
        <span class="n">peaks_in_energy_reference</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">pfit_gain</span><span class="p">,</span> <span class="n">rms_residual_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pfit_gain</span><span class="p">(</span><span class="n">previous_energy2ph</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pfit_gain</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">"k"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"fit"</span><span class="p">)</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">peaks_uncalibrated</span> <span class="o">/</span> <span class="n">peaks_in_energy_reference</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">uncalibrated_name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"gain"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rms_residual_energy</span><span class="si">=:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">multifit_df</span><span class="p">[</span><span class="s2">"line"</span><span class="p">],</span> <span class="n">peaks_uncalibrated</span><span class="p">,</span> <span class="n">gain</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">axes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_pfit_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return a best-fit 2nd degree polynomial for gain (ph/energy) vs uncalibrated ph,</span>
<span class="sd">        and the rms residual in energy after applying that gain correction."""</span>
        <span class="n">multifit_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_params_as_df</span><span class="p">()</span>
        <span class="n">peaks_in_energy_rough_cal</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">peaks_uncalibrated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">previous_energy2ph</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">peaks_in_energy_rough_cal</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">peaks_in_energy_reference</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">peaks_uncalibrated</span> <span class="o">/</span> <span class="n">peaks_in_energy_reference</span>
        <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
            <span class="s2">"Given an array `ph` of pulse heights, return the corresponding energies as an array."</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">gain</span>

        <span class="n">e_predicted</span> <span class="o">=</span> <span class="n">ph2energy</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">)</span>
        <span class="n">rms_residual_energy</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">e_predicted</span> <span class="o">-</span> <span class="n">peaks_in_energy_reference</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pfit_gain</span><span class="p">,</span> <span class="n">rms_residual_energy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_mass_cal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">curvetype</span><span class="p">:</span> <span class="n">Curvetypes</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a calibration object made from the fit results in this MultiFit."""</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_params_as_df</span><span class="p">()</span>
        <span class="n">maker</span> <span class="o">=</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span>
            <span class="n">ph</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">previous_energy2ph</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]),</span>
            <span class="n">energy</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">dph</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"peak_ph_stderr"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">de</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"peak_energy_ref_err"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">"line"</span><span class="p">]],</span>
        <span class="p">)</span>
        <span class="n">cal</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="o">=</span><span class="n">curvetype</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cal</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.fit_ch">
<code class="highlight language-python"><span class="n">fit_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit all the FitSpecs in this MultiFit to the given Channel's DataFrame column <code>col</code>
after applying the Channel's good_expr filter.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit all the FitSpecs in this MultiFit to the given Channel's DataFrame column `col`</span>
<span class="sd">    after applying the Channel's good_expr filter."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.fit_df">
<code class="highlight language-python"><span class="n">fit_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit all the FitSpecs in this MultiFit to the given DataFrame column <code>col</code> after applying good_expr filter.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit all the FitSpecs in this MultiFit to the given DataFrame column `col` after applying good_expr filter."""</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fitspec</span><span class="o">.</span><span class="n">fit_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.fit_series_without_use_expr">
<code class="highlight language-python"><span class="n">fit_series_without_use_expr</span><span class="p">(</span><span class="n">series</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Fit all the FitSpecs in this MultiFit to the given Series without applying any use_expr filter.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_series_without_use_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
    <span class="s2">"Fit all the FitSpecs in this MultiFit to the given Series without applying any use_expr filter."</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitspec</span><span class="o">.</span><span class="n">fit_series_without_use_expr</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.plot_results">
<code class="highlight language-python"><span class="n">plot_results</span><span class="p">(</span><span class="n">n_extra_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot all the fit results in subplots, with n_extra_axes empty subplots included at the end.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_extra_axes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Plot all the fit results in subplots, with n_extra_axes empty subplots included at the end."""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra_axes</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># Adjust figure size as needed</span>

    <span class="c1"># If there's only one subplot, axes is not a list but a single Axes object.</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">plotm</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># Hide any remaining empty subplots</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.plot_results_and_pfit">
<code class="highlight language-python"><span class="n">plot_results_and_pfit</span><span class="p">(</span><span class="n">uncalibrated_name</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">,</span> <span class="n">n_extra_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot all the fit results in subplots, and also plot the gain curve on an extra axis.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_results_and_pfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncalibrated_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">n_extra_axes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot all the fit results in subplots, and also plot the gain curve on an extra axis."""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">_fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span><span class="n">n_extra_axes</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n_extra_axes</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)]</span>
    <span class="n">multifit_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_params_as_df</span><span class="p">()</span>
    <span class="n">peaks_in_energy_rough_cal</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">peaks_uncalibrated</span> <span class="o">=</span> <span class="n">previous_energy2ph</span><span class="p">(</span><span class="n">peaks_in_energy_rough_cal</span><span class="p">)</span>
    <span class="n">peaks_in_energy_reference</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">pfit_gain</span><span class="p">,</span> <span class="n">rms_residual_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pfit_gain</span><span class="p">(</span><span class="n">previous_energy2ph</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pfit_gain</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">"k"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"fit"</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">peaks_uncalibrated</span> <span class="o">/</span> <span class="n">peaks_in_energy_reference</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">uncalibrated_name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"gain"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rms_residual_energy</span><span class="si">=:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">multifit_df</span><span class="p">[</span><span class="s2">"line"</span><span class="p">],</span> <span class="n">peaks_uncalibrated</span><span class="p">,</span> <span class="n">gain</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.results_params_as_df">
<code class="highlight language-python"><span class="n">results_params_as_df</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a DataFrame made from the fit parameters from the results.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">results_params_as_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a DataFrame made from the fit parameters from the results."""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">"line"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">shortname</span> <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span> <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">"peak_energy_ref_err"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># for quickline, position_uncertainty is a string</span>
    <span class="c1"># translate that into a large value for uncertainty so we can proceed without crashing</span>
    <span class="k">for</span> <span class="n">fitspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">position_uncertainty</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>  <span class="c1"># 10% error is large!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">fitspec</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">position_uncertainty</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">"peak_energy_ref_err"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="n">param_name</span> <span class="o">+</span> <span class="s2">"_stderr"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.to_mass_cal">
<code class="highlight language-python"><span class="n">to_mass_cal</span><span class="p">(</span><span class="n">previous_energy2ph</span><span class="p">,</span> <span class="n">curvetype</span><span class="o">=</span><span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a calibration object made from the fit results in this MultiFit.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_mass_cal</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">curvetype</span><span class="p">:</span> <span class="n">Curvetypes</span> <span class="o">=</span> <span class="n">Curvetypes</span><span class="o">.</span><span class="n">GAIN</span><span class="p">,</span> <span class="n">approximate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a calibration object made from the fit results in this MultiFit."""</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_params_as_df</span><span class="p">()</span>
    <span class="n">maker</span> <span class="o">=</span> <span class="n">EnergyCalibrationMaker</span><span class="p">(</span>
        <span class="n">ph</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">previous_energy2ph</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]),</span>
        <span class="n">energy</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">dph</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"peak_ph_stderr"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">de</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"peak_energy_ref_err"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">"line"</span><span class="p">]],</span>
    <span class="p">)</span>
    <span class="n">cal</span> <span class="o">=</span> <span class="n">maker</span><span class="o">.</span><span class="n">make_calibration</span><span class="p">(</span><span class="n">curvename</span><span class="o">=</span><span class="n">curvetype</span><span class="p">,</span> <span class="n">approximate</span><span class="o">=</span><span class="n">approximate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cal</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.to_pfit_gain">
<code class="highlight language-python"><span class="n">to_pfit_gain</span><span class="p">(</span><span class="n">previous_energy2ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a best-fit 2nd degree polynomial for gain (ph/energy) vs uncalibrated ph,
and the rms residual in energy after applying that gain correction.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_pfit_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_energy2ph</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return a best-fit 2nd degree polynomial for gain (ph/energy) vs uncalibrated ph,</span>
<span class="sd">    and the rms residual in energy after applying that gain correction."""</span>
    <span class="n">multifit_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_params_as_df</span><span class="p">()</span>
    <span class="n">peaks_in_energy_rough_cal</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">peaks_uncalibrated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">previous_energy2ph</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">peaks_in_energy_rough_cal</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">peaks_in_energy_reference</span> <span class="o">=</span> <span class="n">multifit_df</span><span class="p">[</span><span class="s2">"peak_energy_ref"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">peaks_uncalibrated</span> <span class="o">/</span> <span class="n">peaks_in_energy_reference</span>
    <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Given an array `ph` of pulse heights, return the corresponding energies as an array."</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">gain</span>

    <span class="n">e_predicted</span> <span class="o">=</span> <span class="n">ph2energy</span><span class="p">(</span><span class="n">peaks_uncalibrated</span><span class="p">)</span>
    <span class="n">rms_residual_energy</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">e_predicted</span> <span class="o">-</span> <span class="n">peaks_in_energy_reference</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pfit_gain</span><span class="p">,</span> <span class="n">rms_residual_energy</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.with_fitspec">
<code class="highlight language-python"><span class="n">with_fitspec</span><span class="p">(</span><span class="n">fitspec</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this MultiFit with a new FitSpec added.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_fitspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitspec</span><span class="p">:</span> <span class="n">FitSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this MultiFit with a new FitSpec added."""</span>
    <span class="c1"># make sure they're always sorted by energy</span>
    <span class="n">newfitspecs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitspecs</span> <span class="o">+</span> <span class="p">[</span><span class="n">fitspec</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitspecs</span><span class="o">=</span><span class="n">newfitspecs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.with_line">
<code class="highlight language-python"><span class="n">with_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dlo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params_update</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this MultiFit with an additional FitSpec for the given line.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_line</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">line</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this MultiFit with an additional FitSpec for the given line."""</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">peak_energy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
    <span class="n">dlo</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">dlo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dhi</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">dhi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_fit_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_bin_size</span><span class="p">)</span>
    <span class="n">params_update</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">params_update</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_params_update</span><span class="p">)</span>
    <span class="n">use_expr</span> <span class="o">=</span> <span class="n">handle_none</span><span class="p">(</span><span class="n">use_expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_use_expr</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">dlo</span><span class="p">,</span> <span class="n">dhi</span> <span class="o">+</span> <span class="n">bin_size</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">peak_energy</span>
    <span class="n">fitspec</span> <span class="o">=</span> <span class="n">FitSpec</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">,</span> <span class="n">params_update</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_fitspec</span><span class="p">(</span><span class="n">fitspec</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFit.with_results">
<code class="highlight language-python"><span class="n">with_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this MultiFit with the given results added.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFit"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this MultiFit with the given results added."""</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep">
<code>MultiFitMassCalibrationStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A RecipeStep to apply a mass-style calibration derived from a MultiFit.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiFitMassCalibrationStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A RecipeStep to apply a mass-style calibration derived from a MultiFit."""</span>

    <span class="n">cal</span><span class="p">:</span> <span class="n">EnergyCalibration</span>
    <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calibrate energy and return a new DataFrame with results."""</span>
        <span class="c1"># only works with in memory data, but just takes it as numpy data and calls function</span>
        <span class="c1"># is much faster than map_elements approach, but wouldn't work with out of core data without some extra book keeping</span>
        <span class="n">inputs_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">inputs_np</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">out</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitMassCalibrationStep"</span><span class="p">:</span>
        <span class="s2">"For slimmer object pickling, return a copy of self with the fat debugging info removed"</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multifit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
        <span class="s2">"Plot the fit results and gain curve for debugging purposes."</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span><span class="o">.</span><span class="n">plot_results_and_pfit</span><span class="p">(</span>
            <span class="n">uncalibrated_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">previous_energy2ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">axes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"The quadratic gain calibration curve: ph -&gt; energy"</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The inverse of the quadratic gain calibration curve: energy -&gt; ph"""</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span>
        <span class="n">multifit_spec</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitMassCalibrationStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""multifit then make a mass calibration object with curve_type=Curvetypes.GAIN and approx=False</span>
<span class="sd">        TODO: support more options"""</span>
        <span class="n">previous_cal_step</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">previous_cal_step_index</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="p">,</span> <span class="s2">"energy2ph"</span><span class="p">)</span>
        <span class="n">rough_energy_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uncalibrated_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">multifit_with_results</span> <span class="o">=</span> <span class="n">multifit_spec</span><span class="o">.</span><span class="n">fit_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">rough_energy_col</span><span class="p">)</span>
        <span class="n">cal</span> <span class="o">=</span> <span class="n">multifit_with_results</span><span class="o">.</span><span class="n">to_mass_cal</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
            <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
            <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="p">,</span>
            <span class="n">cal</span><span class="p">,</span>
            <span class="n">multifit_with_results</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calibrate energy and return a new DataFrame with results.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calibrate energy and return a new DataFrame with results."""</span>
    <span class="c1"># only works with in memory data, but just takes it as numpy data and calls function</span>
    <span class="c1"># is much faster than map_elements approach, but wouldn't work with out of core data without some extra book keeping</span>
    <span class="n">inputs_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">inputs_np</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">out</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the fit results and gain curve for debugging purposes.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
    <span class="s2">"Plot the fit results and gain curve for debugging purposes."</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span><span class="o">.</span><span class="n">plot_results_and_pfit</span><span class="p">(</span>
        <span class="n">uncalibrated_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">previous_energy2ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep.drop_debug">
<code class="highlight language-python"><span class="n">drop_debug</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>For slimmer object pickling, return a copy of self with the fat debugging info removed</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitMassCalibrationStep"</span><span class="p">:</span>
    <span class="s2">"For slimmer object pickling, return a copy of self with the fat debugging info removed"</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multifit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep.energy2ph">
<code class="highlight language-python"><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>The inverse of the quadratic gain calibration curve: energy -&gt; ph</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The inverse of the quadratic gain calibration curve: energy -&gt; ph"""</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep.learn">
<code class="highlight language-python"><span class="n">learn</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">multifit_spec</span><span class="p">,</span> <span class="n">previous_cal_step_index</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>multifit then make a mass calibration object with curve_type=Curvetypes.GAIN and approx=False
TODO: support more options</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span>
    <span class="n">multifit_spec</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
    <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitMassCalibrationStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""multifit then make a mass calibration object with curve_type=Curvetypes.GAIN and approx=False</span>
<span class="sd">    TODO: support more options"""</span>
    <span class="n">previous_cal_step</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">previous_cal_step_index</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="p">,</span> <span class="s2">"energy2ph"</span><span class="p">)</span>
    <span class="n">rough_energy_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">uncalibrated_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">multifit_with_results</span> <span class="o">=</span> <span class="n">multifit_spec</span><span class="o">.</span><span class="n">fit_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">rough_energy_col</span><span class="p">)</span>
    <span class="n">cal</span> <span class="o">=</span> <span class="n">multifit_with_results</span><span class="o">.</span><span class="n">to_mass_cal</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
        <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">,</span>
        <span class="n">cal</span><span class="p">,</span>
        <span class="n">multifit_with_results</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitMassCalibrationStep.ph2energy">
<code class="highlight language-python"><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>The quadratic gain calibration curve: ph -&gt; energy</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
    <span class="s2">"The quadratic gain calibration curve: ph -&gt; energy"</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep">
<code>MultiFitQuadraticGainStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A RecipeStep to apply a quadratic gain curve, after fitting multiple emission lines.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiFitQuadraticGainStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A RecipeStep to apply a quadratic gain curve, after fitting multiple emission lines."""</span>

    <span class="n">pfit_gain</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span>
    <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">rms_residual_energy</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calibrate energy and return a new DataFrame with results."""</span>
        <span class="c1"># only works with in memory data, but just takes it as numpy data and calls function</span>
        <span class="c1"># is much faster than map_elements approach, but wouldn't work with out of core data without some extra book keeping</span>
        <span class="n">inputs_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">inputs_np</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">out</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the fit results and gain curve for debugging purposes."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span><span class="o">.</span><span class="n">plot_results_and_pfit</span><span class="p">(</span><span class="n">uncalibrated_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">previous_energy2ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitQuadraticGainStep"</span><span class="p">:</span>
        <span class="s2">"For slimmer object pickling, return a copy of self with the fat debugging info removed"</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multifit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"The quadratic gain calibration curve: ph -&gt; energy"</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">gain</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The inverse of the quadratic gain calibration curve: energy -&gt; ph"""</span>
        <span class="c1"># ph2energy is equivalent to this with y=energy, x=ph</span>
        <span class="c1"># y = x/(c + b*x + a*x^2)</span>
        <span class="c1"># so</span>
        <span class="c1"># y*c + (y*b-1)*x + a*x^2 = 0</span>
        <span class="c1"># and given that we've selected for well formed calibrations,</span>
        <span class="c1"># we know which root we want</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">cba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span><span class="o">.</span><span class="n">coef</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">cba</span> <span class="o">*</span> <span class="n">energy</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">),</span> <span class="n">energy</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span>
        <span class="n">multifit_spec</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitQuadraticGainStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Perform a multifit then make a quadratic gain calibration object."""</span>
        <span class="n">previous_cal_step</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">previous_cal_step_index</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="p">,</span> <span class="s2">"energy2ph"</span><span class="p">)</span>
        <span class="n">rough_energy_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uncalibrated_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">multifit_with_results</span> <span class="o">=</span> <span class="n">multifit_spec</span><span class="o">.</span><span class="n">fit_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">rough_energy_col</span><span class="p">)</span>
        <span class="c1"># multifit_df = multifit_with_results.results_params_as_df()</span>
        <span class="n">pfit_gain</span><span class="p">,</span> <span class="n">rms_residual_energy</span> <span class="o">=</span> <span class="n">multifit_with_results</span><span class="o">.</span><span class="n">to_pfit_gain</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
            <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
            <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="p">,</span>
            <span class="n">pfit_gain</span><span class="p">,</span>
            <span class="n">multifit_with_results</span><span class="p">,</span>
            <span class="n">rms_residual_energy</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calibrate energy and return a new DataFrame with results.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calibrate energy and return a new DataFrame with results."""</span>
    <span class="c1"># only works with in memory data, but just takes it as numpy data and calls function</span>
    <span class="c1"># is much faster than map_elements approach, but wouldn't work with out of core data without some extra book keeping</span>
    <span class="n">inputs_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">inputs_np</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">out</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the fit results and gain curve for debugging purposes.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the fit results and gain curve for debugging purposes."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multifit</span><span class="o">.</span><span class="n">plot_results_and_pfit</span><span class="p">(</span><span class="n">uncalibrated_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">previous_energy2ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep.drop_debug">
<code class="highlight language-python"><span class="n">drop_debug</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>For slimmer object pickling, return a copy of self with the fat debugging info removed</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitQuadraticGainStep"</span><span class="p">:</span>
    <span class="s2">"For slimmer object pickling, return a copy of self with the fat debugging info removed"</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multifit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep.energy2ph">
<code class="highlight language-python"><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>The inverse of the quadratic gain calibration curve: energy -&gt; ph</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The inverse of the quadratic gain calibration curve: energy -&gt; ph"""</span>
    <span class="c1"># ph2energy is equivalent to this with y=energy, x=ph</span>
    <span class="c1"># y = x/(c + b*x + a*x^2)</span>
    <span class="c1"># so</span>
    <span class="c1"># y*c + (y*b-1)*x + a*x^2 = 0</span>
    <span class="c1"># and given that we've selected for well formed calibrations,</span>
    <span class="c1"># we know which root we want</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="n">cba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span><span class="o">.</span><span class="n">coef</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">cba</span> <span class="o">*</span> <span class="n">energy</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">),</span> <span class="n">energy</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ph</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep.learn">
<code class="highlight language-python"><span class="n">learn</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">multifit_spec</span><span class="p">,</span> <span class="n">previous_cal_step_index</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Perform a multifit then make a quadratic gain calibration object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">,</span>
    <span class="n">multifit_spec</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
    <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"MultiFitQuadraticGainStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Perform a multifit then make a quadratic gain calibration object."""</span>
    <span class="n">previous_cal_step</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">previous_cal_step_index</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="p">,</span> <span class="s2">"energy2ph"</span><span class="p">)</span>
    <span class="n">rough_energy_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">uncalibrated_col</span> <span class="o">=</span> <span class="n">previous_cal_step</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">multifit_with_results</span> <span class="o">=</span> <span class="n">multifit_spec</span><span class="o">.</span><span class="n">fit_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">rough_energy_col</span><span class="p">)</span>
    <span class="c1"># multifit_df = multifit_with_results.results_params_as_df()</span>
    <span class="n">pfit_gain</span><span class="p">,</span> <span class="n">rms_residual_energy</span> <span class="o">=</span> <span class="n">multifit_with_results</span><span class="o">.</span><span class="n">to_pfit_gain</span><span class="p">(</span><span class="n">previous_cal_step</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
        <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">,</span>
        <span class="n">pfit_gain</span><span class="p">,</span>
        <span class="n">multifit_with_results</span><span class="p">,</span>
        <span class="n">rms_residual_energy</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.multifit.MultiFitQuadraticGainStep.ph2energy">
<code class="highlight language-python"><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>The quadratic gain calibration curve: ph -&gt; energy</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
    <span class="s2">"The quadratic gain calibration curve: ph -&gt; energy"</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">gain</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.multifit.handle_none">
<code class="highlight language-python"><span class="n">handle_none</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>If val is None, return a copy of default, else return val.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/multifit.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_none</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">T</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
    <span class="s2">"If val is None, return a copy of default, else return val."</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.noise_algorithms"></a>
<div class="doc doc-contents first">
<p>Algorithms to analyze noise data.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.noise_algorithms.NoiseResult">
<code>NoiseResult</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A dataclass to hold the results of noise analysis, both power-spectral density and (optionally) autocorrelation.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NoiseResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A dataclass to hold the results of noise analysis, both power-spectral density and (optionally) autocorrelation."""</span>

    <span class="n">psd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">autocorr_vec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">frequencies</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">arb_to_unit_scale_and_label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"arb"</span><span class="p">),</span>
        <span class="n">sqrt_psd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">loglog</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot the power spectral density."""</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">arb_to_unit_scale</span><span class="p">,</span> <span class="n">unit_label</span> <span class="o">=</span> <span class="n">arb_to_unit_scale_and_label</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arb_to_unit_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">sqrt_psd</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psd</span><span class="p">),</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Amplitude Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$/</span><span class="se">\\</span><span class="s2">sqrt</span><span class="se">{{</span><span class="s2">Hz</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Power Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$^2$ Hz$^</span><span class="se">{{</span><span class="s2">-1</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loglog</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"noise from records of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_log_rebinned</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bins_per_decade</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">arb_to_unit_scale_and_label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"arb"</span><span class="p">),</span>
        <span class="n">sqrt_psd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot PSD rebinned into logarithmically spaced frequency bins."""</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">arb_to_unit_scale</span><span class="p">,</span> <span class="n">unit_label</span> <span class="o">=</span> <span class="n">arb_to_unit_scale_and_label</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arb_to_unit_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># define logarithmically spaced bin edges</span>
        <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n_decades</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span> <span class="o">/</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bins_per_decade</span> <span class="o">*</span> <span class="n">n_decades</span><span class="p">)</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># digitize frequencies into bins</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

        <span class="c1"># average PSD per bin</span>
        <span class="n">binned_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">binned_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">inds</span> <span class="o">==</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">binned_freqs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">mask</span><span class="p">])))</span>  <span class="c1"># geometric mean</span>
                <span class="n">binned_psd</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">sqrt_psd</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binned_freqs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">binned_psd</span><span class="p">),</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Amplitude Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$/</span><span class="se">\\</span><span class="s2">sqrt</span><span class="se">{{</span><span class="s2">Hz</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binned_freqs</span><span class="p">,</span> <span class="n">binned_psd</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Power Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$^2$ Hz$^</span><span class="se">{{</span><span class="s2">-1</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">"both"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Log-rebinned noise from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2"> samples"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_algorithms.NoiseResult.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arb_to_unit_scale_and_label</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'arb'</span><span class="p">),</span> <span class="n">sqrt_psd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loglog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot the power spectral density.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">arb_to_unit_scale_and_label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"arb"</span><span class="p">),</span>
    <span class="n">sqrt_psd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">loglog</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot the power spectral density."""</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">arb_to_unit_scale</span><span class="p">,</span> <span class="n">unit_label</span> <span class="o">=</span> <span class="n">arb_to_unit_scale_and_label</span>
    <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arb_to_unit_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">sqrt_psd</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psd</span><span class="p">),</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Amplitude Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$/</span><span class="se">\\</span><span class="s2">sqrt</span><span class="se">{{</span><span class="s2">Hz</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Power Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$^2$ Hz$^</span><span class="se">{{</span><span class="s2">-1</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loglog</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"noise from records of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_algorithms.NoiseResult.plot_log_rebinned">
<code class="highlight language-python"><span class="n">plot_log_rebinned</span><span class="p">(</span><span class="n">bins_per_decade</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arb_to_unit_scale_and_label</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'arb'</span><span class="p">),</span> <span class="n">sqrt_psd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot PSD rebinned into logarithmically spaced frequency bins.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_log_rebinned</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">bins_per_decade</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">arb_to_unit_scale_and_label</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"arb"</span><span class="p">),</span>
    <span class="n">sqrt_psd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plotkwarg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot PSD rebinned into logarithmically spaced frequency bins."""</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">arb_to_unit_scale</span><span class="p">,</span> <span class="n">unit_label</span> <span class="o">=</span> <span class="n">arb_to_unit_scale_and_label</span>
    <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arb_to_unit_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># define logarithmically spaced bin edges</span>
    <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_decades</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span> <span class="o">/</span> <span class="n">fmin</span><span class="p">)</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bins_per_decade</span> <span class="o">*</span> <span class="n">n_decades</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># digitize frequencies into bins</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

    <span class="c1"># average PSD per bin</span>
    <span class="n">binned_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">binned_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">inds</span> <span class="o">==</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">binned_freqs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">mask</span><span class="p">])))</span>  <span class="c1"># geometric mean</span>
            <span class="n">binned_psd</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psd</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sqrt_psd</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binned_freqs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">binned_psd</span><span class="p">),</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Amplitude Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$/</span><span class="se">\\</span><span class="s2">sqrt</span><span class="se">{{</span><span class="s2">Hz</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binned_freqs</span><span class="p">,</span> <span class="n">binned_psd</span><span class="p">,</span> <span class="o">**</span><span class="n">plotkwarg</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Power Spectral Density (</span><span class="si">{</span><span class="n">unit_label</span><span class="si">}</span><span class="s2">$^2$ Hz$^</span><span class="se">{{</span><span class="s2">-1</span><span class="se">}}</span><span class="s2">$)"</span><span class="p">)</span>

    <span class="n">axis</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">"both"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Frequency (Hz)"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Log-rebinned noise from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2"> samples"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.noise_algorithms.calc_autocorrelation_times">
<code class="highlight language-python"><span class="n">calc_autocorrelation_times</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the timesteps for an autocorrelation function</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>n</code></b>
                  (<code><span title="int">int</span></code>)
              
              <div class="doc-md-description">
<p>Number of lags</p>
</div>
</li>
<li>
<b><code>dt</code></b>
                  (<code><span title="float">float</span></code>)
              
              <div class="doc-md-description">
<p>Sample time</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              
              <div class="doc-md-description">
<p>The time delays for each lag</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_autocorrelation_times</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the timesteps for an autocorrelation function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of lags</span>
<span class="sd">    dt : float</span>
<span class="sd">        Sample time</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        The time delays for each lag</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.noise_algorithms.calc_continuous_autocorrelation">
<code class="highlight language-python"><span class="n">calc_continuous_autocorrelation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_lags</span><span class="p">,</span> <span class="n">max_excursion</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Calculate the autocorrelation of the input data, assuming the entire array is continuous.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>data</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>Data to be autocorrelated. Arrays of 2+ dimensions will be converted to a 1D array via <code>.ravel()</code>.</p>
</div>
</li>
<li>
<b><code>n_lags</code></b>
                  (<code><span title="int">int</span></code>)
              
              <div class="doc-md-description">
<p>Compute the autocorrelation for lags in the range <code>[0, n_lags-1]</code>.</p>
</div>
</li>
<li>
<b><code>max_excursion</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>1000</code>
)
              
              <div class="doc-md-description">
<p>Chunks of data with max absolute excursion from the mean this large will be excluded from the calculation, by default 1000</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              
              <div class="doc-md-description">
<p>The autocorrelation array</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>If the data are too short to provide the requested number of lags, or the data contain apparent pulses.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_continuous_autocorrelation</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">n_lags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_excursion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the autocorrelation of the input data, assuming the entire array is continuous.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ArrayLike</span>
<span class="sd">        Data to be autocorrelated. Arrays of 2+ dimensions will be converted to a 1D array via `.ravel()`.</span>
<span class="sd">    n_lags : int</span>
<span class="sd">        Compute the autocorrelation for lags in the range `[0, n_lags-1]`.</span>
<span class="sd">    max_excursion : int, optional</span>
<span class="sd">        Chunks of data with max absolute excursion from the mean this large will be excluded from the calculation, by default 1000</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        The autocorrelation array</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the data are too short to provide the requested number of lags, or the data contain apparent pulses.</span>
<span class="sd">    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">n_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n_lags</span> <span class="o">&lt;</span> <span class="n">n_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">padded_length</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a sensible number in the range [n, 2n] which is not too</span>
<span class="sd">        much larger than n, yet is good for FFTs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A number: (1, 3, or 5)*(a power of two), whichever is smallest.</span>
<span class="sd">        """</span>
        <span class="n">pow2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">pow2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">pow2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">pow2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mf">0.625</span> <span class="o">*</span> <span class="n">pow2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">pow2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">0.625</span> <span class="o">*</span> <span class="n">pow2</span><span class="p">))</span>

    <span class="c1"># When there are 10 million data points and only 10,000 lags wanted,</span>
    <span class="c1"># it's hugely inefficient to compute the full autocorrelation, especially</span>
    <span class="c1"># in memory.  Instead, compute it on chunks several times the length of the desired</span>
    <span class="c1"># correlation, and average.</span>
    <span class="n">CHUNK_MULTIPLE</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="k">if</span> <span class="n">n_data</span> <span class="o">&lt;</span> <span class="n">CHUNK_MULTIPLE</span> <span class="o">*</span> <span class="n">n_lags</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"There are too few data values (</span><span class="si">{</span><span class="n">n_data</span><span class="si">=}</span><span class="s2">) to compute at least </span><span class="si">{</span><span class="n">n_lags</span><span class="si">}</span><span class="s2"> lags."</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Be sure to pad chunksize samples by AT LEAST n_lags zeros, to prevent</span>
    <span class="c1"># unwanted wraparound in the autocorrelation.</span>
    <span class="c1"># padded_data is what we do DFT/InvDFT on; ac is the unnormalized output.</span>
    <span class="n">chunksize</span> <span class="o">=</span> <span class="n">CHUNK_MULTIPLE</span> <span class="o">*</span> <span class="n">n_lags</span>
    <span class="n">padsize</span> <span class="o">=</span> <span class="n">n_lags</span>
    <span class="n">padded_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">padded_length</span><span class="p">(</span><span class="n">padsize</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_lags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">Nchunks</span> <span class="o">=</span> <span class="n">n_data</span> <span class="o">//</span> <span class="n">chunksize</span>
    <span class="n">datachunks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span> <span class="n">Nchunks</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Nchunks</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datachunks</span><span class="p">:</span>
        <span class="n">padded_data</span><span class="p">[:</span><span class="n">chunksize</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">padded_data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_excursion</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">padded_data</span><span class="p">)</span>
        <span class="n">ft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># this redundantly removes the mean of the data set</span>
        <span class="n">power</span> <span class="o">=</span> <span class="p">(</span><span class="n">ft</span> <span class="o">*</span> <span class="n">ft</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">.</span><span class="n">real</span>
        <span class="n">acsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
        <span class="n">ac</span> <span class="o">+=</span> <span class="n">acsum</span><span class="p">[:</span><span class="n">n_lags</span><span class="p">]</span>
        <span class="n">entries</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Apparently all 'noise' chunks had large excursions from baseline, so no autocorrelation was computed"</span><span class="p">)</span>

    <span class="n">ac</span> <span class="o">/=</span> <span class="n">entries</span>
    <span class="n">ac</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">-</span> <span class="n">n_lags</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ac</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.noise_algorithms.calc_discontinuous_autocorrelation">
<code class="highlight language-python"><span class="n">calc_discontinuous_autocorrelation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">max_excursion</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Calculate the autocorrelation of the input data, assuming the rows of the array are NOT
continuous in time.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>data</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 2D array of noise data. Shape is <code>(ntraces, nsamples)</code>.</p>
</div>
</li>
<li>
<b><code>max_excursion</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>1000</code>
)
              
              <div class="doc-md-description">
<p><em>description</em>, by default 1000</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="numpy.typing.NDArray">NDArray</span></code>
              
              <div class="doc-md-description">
<p>The mean autocorrelation of the rows ("traces") in the input <code>data</code>, from lags <code>[0, nsamples-1]</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_discontinuous_autocorrelation</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">max_excursion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the autocorrelation of the input data, assuming the rows of the array are NOT</span>
<span class="sd">    continuous in time.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ArrayLike</span>
<span class="sd">        A 2D array of noise data. Shape is `(ntraces, nsamples)`.</span>
<span class="sd">    max_excursion : int, optional</span>
<span class="sd">        _description_, by default 1000</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray</span>
<span class="sd">        The mean autocorrelation of the rows ("traces") in the input `data`, from lags `[0, nsamples-1]`.</span>
<span class="sd">    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">ntraces</span><span class="p">,</span> <span class="n">nsamples</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsamples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">traces_used</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraces</span><span class="p">):</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pulse</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_excursion</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ac</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="n">nsamples</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="n">traces_used</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ac</span> <span class="o">/=</span> <span class="n">traces_used</span>
    <span class="n">ac</span> <span class="o">/=</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nsamples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ac</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.noise_algorithms.calc_noise_result">
<code class="highlight language-python"><span class="n">calc_noise_result</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">continuous</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_autocorr_if_length_over</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Analyze the noise as Mass has always done.</p>
<ul>
<li>Compute autocorrelation with a lower noise at longer lags when data are known to be continuous</li>
<li>Subtract the mean before computing the power spectrum</li>
</ul>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>data</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 2d array of noise data, of shape <code>(npulses, nsamples)</code></p>
</div>
</li>
<li>
<b><code>dt</code></b>
                  (<code><span title="float">float</span></code>)
              
              <div class="doc-md-description">
<p>Periodic sampling time, in seconds</p>
</div>
</li>
<li>
<b><code>continuous</code></b>
                  (<code><span title="bool">bool</span></code>)
              
              <div class="doc-md-description">
<p>Whether the "pulses" in the <code>data</code> array are continuous in time</p>
</div>
</li>
<li>
<b><code>window</code></b>
                  (<code><span title="callable">callable</span></code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A function to compute a data window (or if None, no windowing), by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="NoiseResult


  
      dataclass
   (mass2.core.noise_algorithms.NoiseResult)" href="#mass2.core.noise_algorithms.NoiseResult">NoiseResult</a></code>
              
              <div class="doc-md-description">
<p>The derived noise spectrum and autocorrelation</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_noise_result</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">continuous</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skip_autocorr_if_length_over</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"NoiseResult"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Analyze the noise as Mass has always done.</span>

<span class="sd">    * Compute autocorrelation with a lower noise at longer lags when data are known to be continuous</span>
<span class="sd">    * Subtract the mean before computing the power spectrum</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ArrayLike</span>
<span class="sd">        A 2d array of noise data, of shape `(npulses, nsamples)`</span>
<span class="sd">    dt : float</span>
<span class="sd">        Periodic sampling time, in seconds</span>
<span class="sd">    continuous : bool</span>
<span class="sd">        Whether the "pulses" in the `data` array are continuous in time</span>
<span class="sd">    window : callable, optional</span>
<span class="sd">        A function to compute a data window (or if None, no windowing), by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NoiseResult</span>
<span class="sd">        The derived noise spectrum and autocorrelation</span>
<span class="sd">    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data_zeromean</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">(</span><span class="n">n_pulses</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_zeromean</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># see test_ravel_behavior to be sure this is written correctly</span>
    <span class="n">f_mass</span><span class="p">,</span> <span class="n">psd_mass</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">mathstat</span><span class="o">.</span><span class="n">power_spectrum</span><span class="o">.</span><span class="n">computeSpectrum</span><span class="p">(</span><span class="n">data_zeromean</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">segfactor</span><span class="o">=</span><span class="n">n_pulses</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nsamples</span> <span class="o">&lt;=</span> <span class="n">skip_autocorr_if_length_over</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">continuous</span><span class="p">:</span>
            <span class="n">autocorr_vec</span> <span class="o">=</span> <span class="n">calc_continuous_autocorrelation</span><span class="p">(</span><span class="n">data_zeromean</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">n_lags</span><span class="o">=</span><span class="n">nsamples</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">autocorr_vec</span> <span class="o">=</span> <span class="n">calc_discontinuous_autocorrelation</span><span class="p">(</span><span class="n">data_zeromean</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
<span class="w">            </span><span class="sd">"""warning: noise_psd_mass skipping autocorrelation calculation for long traces,</span>
<span class="sd">            use skip_autocorr_if_length_over argument to override this"""</span>
        <span class="p">)</span>
        <span class="n">autocorr_vec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">NoiseResult</span><span class="p">(</span><span class="n">psd</span><span class="o">=</span><span class="n">psd_mass</span><span class="p">,</span> <span class="n">autocorr_vec</span><span class="o">=</span><span class="n">autocorr_vec</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">=</span><span class="n">f_mass</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.noise_algorithms.noise_psd_periodogram">
<code class="highlight language-python"><span class="n">noise_psd_periodogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">'boxcar'</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the noise power spectral density using scipy's periodogram function and the autocorrelation.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">noise_psd_periodogram</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"boxcar"</span><span class="p">,</span> <span class="n">detrend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"NoiseResult"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the noise power spectral density using scipy's periodogram function and the autocorrelation."""</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">Pxx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">periodogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
    <span class="c1"># len(f) = data.shape[1]//2+1</span>
    <span class="c1"># Pxx[i, j] is the PSD at frequency f[j] for the ith trace data[i, :]</span>
    <span class="n">Pxx_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Pxx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Pxx_mean[j] is the averaged PSD at frequency f[j] over all traces</span>
    <span class="n">autocorr_vec</span> <span class="o">=</span> <span class="n">calc_discontinuous_autocorrelation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">NoiseResult</span><span class="p">(</span><span class="n">psd</span><span class="o">=</span><span class="n">Pxx_mean</span><span class="p">,</span> <span class="n">autocorr_vec</span><span class="o">=</span><span class="n">autocorr_vec</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.noise_channel"></a>
<div class="doc doc-contents first">
<p>Hold a class to represent a channel with noise data only, and to analyze its noise characteristics.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel">
<code>NoiseChannel</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A class to represent a channel with noise data only, and to analyze its noise characteristics.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NoiseChannel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A class to represent a channel with noise data only, and to analyze its noise characteristics."""</span>

    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>  <span class="c1"># DO NOT MUTATE THIS!!!</span>
    <span class="n">header_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>  <span class="c1"># DO NOT MUTATE THIS!!</span>
    <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span>

    <span class="c1"># @functools.cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_max_excursion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">trace_col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Compute the maximum excursion from the median for each noise record, and store in dataframe."""</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">excursion2d</span><span class="p">(</span><span class="n">noise_trace</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Return the excursion (max - min) for each trace in a 2D array of traces."""</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">noise_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">noise_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">noise_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n_limit</span><span class="p">)[</span><span class="n">trace_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">excursion</span> <span class="o">=</span> <span class="n">excursion2d</span><span class="p">(</span><span class="n">noise_traces</span><span class="p">)</span>
        <span class="n">max_excursion</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">excursion</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">excursion_nsigma</span><span class="p">)</span>
        <span class="n">df_noise2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n_limit</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">excursion</span><span class="o">=</span><span class="n">excursion</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_noise2</span><span class="p">,</span> <span class="n">max_excursion</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_records_2d</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trace_col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
        <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">excursion_nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">trunc_front</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">trunc_back</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return a 2D NumPy array of cleaned noise traces from the specified column.</span>

<span class="sd">        This method identifies noise traces with excursions below a threshold and</span>
<span class="sd">        optionally truncates the beginning and/or end of each trace.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        trace_col_name : str, optional</span>
<span class="sd">            Name of the column containing trace data. Default is "pulse".</span>
<span class="sd">        n_limit : int, optional</span>
<span class="sd">            Maximum number of traces to analyze. Default is 10000.</span>
<span class="sd">        excursion_nsigma : float, optional</span>
<span class="sd">            Threshold for maximum excursion in units of noise sigma. Default is 5.</span>
<span class="sd">        trunc_front : int, optional</span>
<span class="sd">            Number of samples to truncate from the front of each trace. Default is 0.</span>
<span class="sd">        trunc_back : int, optional</span>
<span class="sd">            Number of samples to truncate from the back of each trace. Must be &gt;= 0. Default is 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            A 2D array of cleaned and optionally truncated noise traces.</span>

<span class="sd">            Shape: (n_pulses, len(pulse))</span>
<span class="sd">        """</span>
        <span class="n">df_noise2</span><span class="p">,</span> <span class="n">max_excursion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_max_excursion</span><span class="p">(</span><span class="n">trace_col_name</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="p">)</span>
        <span class="n">noise_traces_clean</span> <span class="o">=</span> <span class="n">df_noise2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"excursion"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_excursion</span><span class="p">)[</span><span class="s2">"pulse"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trunc_back</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_traces_clean2</span> <span class="o">=</span> <span class="n">noise_traces_clean</span><span class="p">[:,</span> <span class="n">trunc_front</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">trunc_back</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_traces_clean2</span> <span class="o">=</span> <span class="n">noise_traces_clean</span><span class="p">[:,</span> <span class="n">trunc_front</span><span class="p">:</span><span class="o">-</span><span class="n">trunc_back</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"trunc_back must be &gt;= 0"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">noise_traces_clean2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">noise_traces_clean2</span>

    <span class="c1"># @functools.cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spectrum</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trace_col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
        <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">excursion_nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">trunc_front</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">trunc_back</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">skip_autocorr_if_length_over</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoiseResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute and return the noise result from the noise traces."""</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_records_2d</span><span class="p">(</span><span class="n">trace_col_name</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="p">,</span> <span class="n">trunc_front</span><span class="p">,</span> <span class="n">trunc_back</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">noise_algorithms</span><span class="o">.</span><span class="n">calc_noise_result</span><span class="p">(</span>
            <span class="n">records</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_continuous</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span> <span class="n">skip_autocorr_if_length_over</span><span class="o">=</span><span class="n">skip_autocorr_if_length_over</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">spectrum</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A hash function based on the object's id."""</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Equality based on object identity."""</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s2">"Whether this channel is continuous data (True) or triggered records with arbitrary gaps (False)."</span>
        <span class="k">if</span> <span class="s2">"continuous"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_df</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_df</span><span class="p">[</span><span class="s2">"continuous"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"NoiseChannel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a NoiseChannel by loading data from the given LJH file path."""</span>
        <span class="n">ljh</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span> <span class="o">=</span> <span class="n">ljh</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span>
        <span class="n">noise_channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">header_df</span><span class="p">,</span> <span class="n">header_df</span><span class="p">[</span><span class="s2">"Timebase"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">noise_channel</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.is_continuous">
<code class="highlight language-python"><span class="n">is_continuous</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Whether this channel is continuous data (True) or triggered records with arbitrary gaps (False).</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.__eq__">
<code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Equality based on object identity.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Equality based on object identity."""</span>
    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.__hash__">
<code class="highlight language-python"><span class="fm">__hash__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>A hash function based on the object's id.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A hash function based on the object's id."""</span>
    <span class="c1"># needed to make functools.cache work</span>
    <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
    <span class="c1"># and we may get nonsense results</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.calc_max_excursion">
<code class="highlight language-python"><span class="n">calc_max_excursion</span><span class="p">(</span><span class="n">trace_col_name</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">n_limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute the maximum excursion from the median for each noise record, and store in dataframe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_max_excursion</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">trace_col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute the maximum excursion from the median for each noise record, and store in dataframe."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">excursion2d</span><span class="p">(</span><span class="n">noise_trace</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the excursion (max - min) for each trace in a 2D array of traces."""</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">noise_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">noise_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">noise_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n_limit</span><span class="p">)[</span><span class="n">trace_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">excursion</span> <span class="o">=</span> <span class="n">excursion2d</span><span class="p">(</span><span class="n">noise_traces</span><span class="p">)</span>
    <span class="n">max_excursion</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">excursion</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">excursion_nsigma</span><span class="p">)</span>
    <span class="n">df_noise2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n_limit</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">excursion</span><span class="o">=</span><span class="n">excursion</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_noise2</span><span class="p">,</span> <span class="n">max_excursion</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.from_ljh">
<code class="highlight language-python"><span class="n">from_ljh</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a NoiseChannel by loading data from the given LJH file path.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ljh</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"NoiseChannel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a NoiseChannel by loading data from the given LJH file path."""</span>
    <span class="n">ljh</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span> <span class="o">=</span> <span class="n">ljh</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span>
    <span class="n">noise_channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">header_df</span><span class="p">,</span> <span class="n">header_df</span><span class="p">[</span><span class="s2">"Timebase"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">noise_channel</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.get_records_2d">
<code class="highlight language-python"><span class="n">get_records_2d</span><span class="p">(</span><span class="n">trace_col_name</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">n_limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">trunc_front</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trunc_back</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a 2D NumPy array of cleaned noise traces from the specified column.</p>
<p>This method identifies noise traces with excursions below a threshold and
optionally truncates the beginning and/or end of each trace.</p>
<details class="parameters:" open="">
<summary>Parameters:</summary>
<p>trace_col_name : str, optional
    Name of the column containing trace data. Default is "pulse".
n_limit : int, optional
    Maximum number of traces to analyze. Default is 10000.
excursion_nsigma : float, optional
    Threshold for maximum excursion in units of noise sigma. Default is 5.
trunc_front : int, optional
    Number of samples to truncate from the front of each trace. Default is 0.
trunc_back : int, optional
    Number of samples to truncate from the back of each trace. Must be &gt;= 0. Default is 0.</p>
</details>
<details class="returns:" open="">
<summary>Returns:</summary>
<p>np.ndarray
    A 2D array of cleaned and optionally truncated noise traces.</p>
<pre><code>Shape: (n_pulses, len(pulse))
</code></pre>
</details>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_records_2d</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">trace_col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
    <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="n">excursion_nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">trunc_front</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">trunc_back</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Return a 2D NumPy array of cleaned noise traces from the specified column.</span>

<span class="sd">    This method identifies noise traces with excursions below a threshold and</span>
<span class="sd">    optionally truncates the beginning and/or end of each trace.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    trace_col_name : str, optional</span>
<span class="sd">        Name of the column containing trace data. Default is "pulse".</span>
<span class="sd">    n_limit : int, optional</span>
<span class="sd">        Maximum number of traces to analyze. Default is 10000.</span>
<span class="sd">    excursion_nsigma : float, optional</span>
<span class="sd">        Threshold for maximum excursion in units of noise sigma. Default is 5.</span>
<span class="sd">    trunc_front : int, optional</span>
<span class="sd">        Number of samples to truncate from the front of each trace. Default is 0.</span>
<span class="sd">    trunc_back : int, optional</span>
<span class="sd">        Number of samples to truncate from the back of each trace. Must be &gt;= 0. Default is 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        A 2D array of cleaned and optionally truncated noise traces.</span>

<span class="sd">        Shape: (n_pulses, len(pulse))</span>
<span class="sd">    """</span>
    <span class="n">df_noise2</span><span class="p">,</span> <span class="n">max_excursion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_max_excursion</span><span class="p">(</span><span class="n">trace_col_name</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="p">)</span>
    <span class="n">noise_traces_clean</span> <span class="o">=</span> <span class="n">df_noise2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"excursion"</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_excursion</span><span class="p">)[</span><span class="s2">"pulse"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">trunc_back</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_traces_clean2</span> <span class="o">=</span> <span class="n">noise_traces_clean</span><span class="p">[:,</span> <span class="n">trunc_front</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">trunc_back</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_traces_clean2</span> <span class="o">=</span> <span class="n">noise_traces_clean</span><span class="p">[:,</span> <span class="n">trunc_front</span><span class="p">:</span><span class="o">-</span><span class="n">trunc_back</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"trunc_back must be &gt;= 0"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">noise_traces_clean2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">noise_traces_clean2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.noise_channel.NoiseChannel.spectrum">
<code class="highlight language-python"><span class="n">spectrum</span><span class="p">(</span><span class="n">trace_col_name</span><span class="o">=</span><span class="s1">'pulse'</span><span class="p">,</span> <span class="n">n_limit</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">trunc_front</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trunc_back</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">skip_autocorr_if_length_over</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute and return the noise result from the noise traces.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/noise_channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">spectrum</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">trace_col_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
    <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="n">excursion_nsigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">trunc_front</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">trunc_back</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">skip_autocorr_if_length_over</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoiseResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute and return the noise result from the noise traces."""</span>
    <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_records_2d</span><span class="p">(</span><span class="n">trace_col_name</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">,</span> <span class="n">excursion_nsigma</span><span class="p">,</span> <span class="n">trunc_front</span><span class="p">,</span> <span class="n">trunc_back</span><span class="p">)</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">noise_algorithms</span><span class="o">.</span><span class="n">calc_noise_result</span><span class="p">(</span>
        <span class="n">records</span><span class="p">,</span> <span class="n">continuous</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_continuous</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span> <span class="n">skip_autocorr_if_length_over</span><span class="o">=</span><span class="n">skip_autocorr_if_length_over</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrum</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.offfiles"></a>
<div class="doc doc-contents first">
<p>Code copied from Mass version 1. Not up to date with latest style. Sorry.</p>
<p>Supported off versions:
0.1.0 has projectors and basis in json with base64 encoding
0.2.0 has projectors and basis after json as binary
0.3.0 adds pretrigDelta field</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.offfiles.OffFile">
<code>OffFile</code>
</h2>
<div class="doc doc-contents">
<p>Working with an OFF file:
off = OffFile("filename")
print off.dtype # show the fields available
off[0] # get record 0
off[0]["coefs"] # get the model coefs for record 0
x,y = off.recordXY(0)
plot(x,y) # plot record 0</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OffFile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Working with an OFF file:</span>
<span class="sd">    off = OffFile("filename")</span>
<span class="sd">    print off.dtype # show the fields available</span>
<span class="sd">    off[0] # get record 0</span>
<span class="sd">    off[0]["coefs"] # get the model coefs for record 0</span>
<span class="sd">    x,y = off.recordXY(0)</span>
<span class="sd">    plot(x,y) # plot record 0</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headerString</span> <span class="o">=</span> <span class="n">readJsonString</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># self.headerStringLength = f.tell() # doesn't work on windows because readline uses a readahead buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headerStringLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headerString</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headerString</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">recordDtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FileFormatVersion"</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumberOfBases"</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_non_descriptive</span> <span class="o">=</span> <span class="n">recordDtype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FileFormatVersion"</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumberOfBases"</span><span class="p">],</span> <span class="n">descriptive_coefs_names</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">framePeriodSeconds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FramePeriodSeconds"</span><span class="p">])</span>

        <span class="c1"># Estimate subframe division rate. If explicitly given in ReadoutInfo, use that.</span>
        <span class="c1"># Otherwise, if it's a Lancero-TDM system, then we know it's equal to the # of rows.</span>
        <span class="c1"># Otherwise, we don't know any way to estimate subframe divisions. (But add it if you think of any!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ReadoutInfo"</span><span class="p">][</span><span class="s2">"Subframedivisions"</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"CreationInfo"</span><span class="p">][</span><span class="s2">"SourceName"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Lancero"</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ReadoutInfo"</span><span class="p">][</span><span class="s2">"NumberOfRows"</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validateHeader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decodeModelInfo</span><span class="p">()</span>  <span class="c1"># calculates afterHeaderPos used by _updateMmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateMmap</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Close the memory map and projectors and basis memmaps"""</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validateHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">"Check that the header looks like we expect, with a valid version code"</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headerStringLength</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"}</span><span class="se">\n</span><span class="s2">"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"failed to find end of header"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FileFormat"</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"OFF"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"FileFormatVersion is </span><span class="si">{}</span><span class="s2">, want OFF"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FileFormatVersion"</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_updateMmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_nRecords</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Memory map an OFF file's data.</span>
<span class="sd">        `_nRecords` maps only a subset--designed for testing only</span>
<span class="sd">        """</span>
        <span class="n">fileSize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">recordSize</span> <span class="o">=</span> <span class="n">fileSize</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">afterHeaderPos</span>
        <span class="k">if</span> <span class="n">_nRecords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nRecords</span> <span class="o">=</span> <span class="n">recordSize</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># for testing only</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nRecords</span> <span class="o">=</span> <span class="n">_nRecords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">afterHeaderPos</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nRecords</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="s2">"Make indexing into the off the same as indexing into the memory mapped array"</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Number of records in the OFF file"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__sizeof__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Size of the memory mapped array in bytes"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">__sizeof__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decodeModelInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Decode the model info (projectors and basis) from the OFF file, either from base64 in json</span>
<span class="sd">        or a later proprietary, binary format"""</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">"RowMajorFloat64ValuesBase64"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Projectors"</span><span class="p">]</span>
            <span class="ow">and</span> <span class="s2">"RowMajorFloat64ValuesBase64"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Basis"</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="c1"># should only be in version 0.1.0 files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decodeModelInfoBase64</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decodeModelInfoMmap</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decodeModelInfoBase64</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Decode the model info (projectors and basis) from the OFF file, from base64 in json."""</span>
        <span class="n">projectorsData</span> <span class="o">=</span> <span class="n">decodebytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Projectors"</span><span class="p">][</span><span class="s2">"RowMajorFloat64ValuesBase64"</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">projectorsRows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Projectors"</span><span class="p">][</span><span class="s2">"Rows"</span><span class="p">])</span>
        <span class="n">projectorsCols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Projectors"</span><span class="p">][</span><span class="s2">"Cols"</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">projectorsData</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">projectorsRows</span><span class="p">,</span> <span class="n">projectorsCols</span><span class="p">))</span>
        <span class="n">basisData</span> <span class="o">=</span> <span class="n">decodebytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Basis"</span><span class="p">][</span><span class="s2">"RowMajorFloat64ValuesBase64"</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">basisRows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Basis"</span><span class="p">][</span><span class="s2">"Rows"</span><span class="p">])</span>
        <span class="n">basisCols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Basis"</span><span class="p">][</span><span class="s2">"Cols"</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">basisData</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">basisRows</span><span class="p">,</span> <span class="n">basisCols</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">basisRows</span> <span class="o">!=</span> <span class="n">projectorsCols</span> <span class="ow">or</span> <span class="n">basisCols</span> <span class="o">!=</span> <span class="n">projectorsRows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumberOfBases"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">projectorsRows</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">"basis shape should be transpose of projectors shape. have basis "</span>
                <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">basisCols</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">basisRows</span><span class="si">}</span><span class="s2">), projectors (</span><span class="si">{</span><span class="n">projectorsCols</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">projectorsRows</span><span class="si">}</span><span class="s2">), "</span>
                <span class="sa">f</span><span class="s2">"NumberOfBases </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'NumberOfBases'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afterHeaderPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerStringLength</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decodeModelInfoMmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Decode the model info (projectors and basis) from the OFF file, from binary."""</span>
        <span class="n">projectorsRows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Projectors"</span><span class="p">][</span><span class="s2">"Rows"</span><span class="p">])</span>
        <span class="n">projectorsCols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Projectors"</span><span class="p">][</span><span class="s2">"Cols"</span><span class="p">])</span>
        <span class="n">basisRows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Basis"</span><span class="p">][</span><span class="s2">"Rows"</span><span class="p">])</span>
        <span class="n">basisCols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ModelInfo"</span><span class="p">][</span><span class="s2">"Basis"</span><span class="p">][</span><span class="s2">"Cols"</span><span class="p">])</span>
        <span class="c1"># 8 for float64, basis and projectors have the same number of elements and therefore of bytes</span>
        <span class="n">nBytes</span> <span class="o">=</span> <span class="n">basisCols</span> <span class="o">*</span> <span class="n">basisRows</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">projectorsPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerStringLength</span>
        <span class="n">basisPos</span> <span class="o">=</span> <span class="n">projectorsPos</span> <span class="o">+</span> <span class="n">nBytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afterHeaderPos</span> <span class="o">=</span> <span class="n">basisPos</span> <span class="o">+</span> <span class="n">nBytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">projectorsPos</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">projectorsRows</span><span class="p">,</span> <span class="n">projectorsCols</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">basisPos</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">basisRows</span><span class="p">,</span> <span class="n">basisCols</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">basisRows</span> <span class="o">!=</span> <span class="n">projectorsCols</span> <span class="ow">or</span> <span class="n">basisCols</span> <span class="o">!=</span> <span class="n">projectorsRows</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumberOfBases"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">projectorsRows</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">"basis shape should be transpose of projectors shape. have basis "</span>
                <span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">basisCols</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">basisRows</span><span class="si">}</span><span class="s2">), projectors (</span><span class="si">{</span><span class="n">projectorsCols</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">projectorsRows</span><span class="si">}</span><span class="s2">), "</span>
                <span class="sa">f</span><span class="s2">"NumberOfBases </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'NumberOfBases'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a string representation of the OffFile object."""</span>
        <span class="k">return</span> <span class="s2">"&lt;OFF file&gt; </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> records, </span><span class="si">{}</span><span class="s2"> length basis</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRecords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumberOfBases"</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sampleTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""return a vector of sample times for record i, approriate for plotting"""</span>
        <span class="n">recordSamples</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"recordSamples"</span><span class="p">]</span>
        <span class="n">recordPreSamples</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"recordPreSamples"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">recordPreSamples</span><span class="p">,</span> <span class="n">recordSamples</span> <span class="o">-</span> <span class="n">recordPreSamples</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">framePeriodSeconds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">modeledPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""return a vector of the modeled pulse samples, the best available value of the actual raw samples"""</span>
        <span class="c1"># projectors has size (n,z) where it is (rows,cols)</span>
        <span class="c1"># basis has size (z,n)</span>
        <span class="c1"># coefs has size (n,1)</span>
        <span class="c1"># coefs (n,1) = projectors (n,z) * data (z,1)</span>
        <span class="c1"># modelData (z,1) = basis (z,n) * coefs (n,1)</span>
        <span class="c1"># n = number of basis (eg 3)</span>
        <span class="c1"># z = record length (eg 4)</span>

        <span class="c1"># .view(self._dtype_non_descriptive) should be a copy-free way of changing</span>
        <span class="c1"># the dtype so we can access the coefs all together</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">allVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap_with_coefs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"coefs"</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">allVals</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">recordXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""return (x,y) for record i, where x is time and y is modeled pulse"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleTimes</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeledPulse</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_mmap_with_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a view of the memmap with the coefs all together in one field"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype_non_descriptive</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a view of the memmap with the given args"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.__getitem__">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make indexing into the off the same as indexing into the memory mapped array</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="s2">"Make indexing into the off the same as indexing into the memory mapped array"</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.__len__">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Number of records in the OFF file</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Number of records in the OFF file"""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a string representation of the OffFile object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a string representation of the OffFile object."""</span>
    <span class="k">return</span> <span class="s2">"&lt;OFF file&gt; </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> records, </span><span class="si">{}</span><span class="s2"> length basis</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRecords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumberOfBases"</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.__sizeof__">
<code class="highlight language-python"><span class="n">__sizeof__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Size of the memory mapped array in bytes</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__sizeof__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Size of the memory mapped array in bytes"""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">__sizeof__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.close">
<code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Close the memory map and projectors and basis memmaps</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Close the memory map and projectors and basis memmaps"""</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.modeledPulse">
<code class="highlight language-python"><span class="n">modeledPulse</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>return a vector of the modeled pulse samples, the best available value of the actual raw samples</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">modeledPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""return a vector of the modeled pulse samples, the best available value of the actual raw samples"""</span>
    <span class="c1"># projectors has size (n,z) where it is (rows,cols)</span>
    <span class="c1"># basis has size (z,n)</span>
    <span class="c1"># coefs has size (n,1)</span>
    <span class="c1"># coefs (n,1) = projectors (n,z) * data (z,1)</span>
    <span class="c1"># modelData (z,1) = basis (z,n) * coefs (n,1)</span>
    <span class="c1"># n = number of basis (eg 3)</span>
    <span class="c1"># z = record length (eg 4)</span>

    <span class="c1"># .view(self._dtype_non_descriptive) should be a copy-free way of changing</span>
    <span class="c1"># the dtype so we can access the coefs all together</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">allVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap_with_coefs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"coefs"</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">allVals</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.recordXY">
<code class="highlight language-python"><span class="n">recordXY</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>return (x,y) for record i, where x is time and y is modeled pulse</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">recordXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""return (x,y) for record i, where x is time and y is modeled pulse"""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleTimes</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeledPulse</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.sampleTimes">
<code class="highlight language-python"><span class="n">sampleTimes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>return a vector of sample times for record i, approriate for plotting</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sampleTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""return a vector of sample times for record i, approriate for plotting"""</span>
    <span class="n">recordSamples</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"recordSamples"</span><span class="p">]</span>
    <span class="n">recordPreSamples</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"recordPreSamples"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">recordPreSamples</span><span class="p">,</span> <span class="n">recordSamples</span> <span class="o">-</span> <span class="n">recordPreSamples</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">framePeriodSeconds</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.validateHeader">
<code class="highlight language-python"><span class="n">validateHeader</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Check that the header looks like we expect, with a valid version code</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validateHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">"Check that the header looks like we expect, with a valid version code"</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headerStringLength</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"}</span><span class="se">\n</span><span class="s2">"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"failed to find end of header"</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FileFormat"</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"OFF"</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"FileFormatVersion is </span><span class="si">{}</span><span class="s2">, want OFF"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"FileFormatVersion"</span><span class="p">]))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.offfiles.OffFile.view">
<code class="highlight language-python"><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a view of the memmap with the given args</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a view of the memmap with the given args"""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.offfiles.readJsonString">
<code class="highlight language-python"><span class="n">readJsonString</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>look in file f for a line "}\n" and return all contents up to that point
for an OFF file this can be parsed by json.dumps
and all remaining data is records</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">readJsonString</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""look in file f for a line "}\\n" and return all contents up to that point</span>
<span class="sd">    for an OFF file this can be parsed by json.dumps</span>
<span class="sd">    and all remaining data is records"""</span>
    <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">"}</span><span class="se">\n</span><span class="s2">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"""reached end of file without finding an end-of-JSON line "}</span><span class="se">\\</span><span class="s2">n" """</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.offfiles.recordDtype">
<code class="highlight language-python"><span class="n">recordDtype</span><span class="p">(</span><span class="n">offVersion</span><span class="p">,</span> <span class="n">nBasis</span><span class="p">,</span> <span class="n">descriptive_coefs_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>return a np.dtype matching the record datatype for the given offVersion and nBasis
descriptive_coefs_names - determines how the modeled pulse coefficients are name, you usually want True
For True, the names will be <code>derivLike</code>, <code>pulseLike</code>, and if nBasis&gt;3, also <code>extraCoefs</code>
For False, they will all have the single name <code>coefs</code>. False is to make implementing recordXY and other
methods that want access to all coefs simultaneously easier</p>
<details class="quote">
<summary>Source code in <code>mass2/core/offfiles.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">recordDtype</span><span class="p">(</span><span class="n">offVersion</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nBasis</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">descriptive_coefs_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""return a np.dtype matching the record datatype for the given offVersion and nBasis</span>
<span class="sd">    descriptive_coefs_names - determines how the modeled pulse coefficients are name, you usually want True</span>
<span class="sd">    For True, the names will be `derivLike`, `pulseLike`, and if nBasis&gt;3, also `extraCoefs`</span>
<span class="sd">    For False, they will all have the single name `coefs`. False is to make implementing recordXY and other</span>
<span class="sd">    methods that want access to all coefs simultaneously easier"""</span>
    <span class="k">if</span> <span class="n">offVersion</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"0.1.0"</span><span class="p">,</span> <span class="s2">"0.2.0"</span><span class="p">}:</span>
        <span class="c1"># start of the dtype is identical for all cases</span>
        <span class="n">dt_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">"recordSamples"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"recordPreSamples"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"framecount"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pretriggerMean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"residualStdDev"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">offVersion</span> <span class="o">==</span> <span class="s2">"0.3.0"</span><span class="p">:</span>
        <span class="n">dt_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">"recordSamples"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"recordPreSamples"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"framecount"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pretriggerMean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pretriggerDelta"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"residualStdDev"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"dtype for OFF version </span><span class="si">{</span><span class="n">offVersion</span><span class="si">}</span><span class="s2"> not implemented"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">descriptive_coefs_names</span><span class="p">:</span>
        <span class="n">dt_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="s2">"pulseMean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="s2">"derivativeLike"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="s2">"filtValue"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">nBasis</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dt_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="s2">"extraCoefs"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nBasis</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="s2">"coefs"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nBasis</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dt_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.optimal_filtering"></a>
<div class="doc doc-contents first">
<p>Classes to create time-domain and Fourier-domain optimal filters.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter">
<code>Filter</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>
<p>A single optimal filter, possibly with optimal estimators of the Delta-t and of the DC level.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A set of optimal filter values.</p>
<p>These values are chosen with the following specifics:
* one model of the pulses and of the noise, including pulse record length,
* a first-order arrival-time detection filter is (optionally) computed
* filtering model (1-lag, or other odd # of lags),
* low-pass smoothing of the filter itself,
* a fixed number of samples "cut" (given zero weight) at the start and/or end of records.</p>
<p>The object also stores the pulse shape and (optionally) the delta-T shape used to generate it,
and the low-pass filter's fmax or f_3db (cutoff or rolloff) frequency.</p>
<p>It also stores the predicted <code>variance</code> due to noise and the resulting <code>predicted_v_over_dv</code>,
the ratio of the filtered pulse height to the (FWHM) noise, in pulse height units. Both
of these values assume pulses of the same size as that used to generate the filter: <code>nominal_peak</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A single optimal filter, possibly with optimal estimators of the Delta-t and of the DC level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A set of optimal filter values.</span>

<span class="sd">        These values are chosen with the following specifics:</span>
<span class="sd">        * one model of the pulses and of the noise, including pulse record length,</span>
<span class="sd">        * a first-order arrival-time detection filter is (optionally) computed</span>
<span class="sd">        * filtering model (1-lag, or other odd # of lags),</span>
<span class="sd">        * low-pass smoothing of the filter itself,</span>
<span class="sd">        * a fixed number of samples "cut" (given zero weight) at the start and/or end of records.</span>

<span class="sd">        The object also stores the pulse shape and (optionally) the delta-T shape used to generate it,</span>
<span class="sd">        and the low-pass filter's fmax or f_3db (cutoff or rolloff) frequency.</span>

<span class="sd">        It also stores the predicted `variance` due to noise and the resulting `predicted_v_over_dv`,</span>
<span class="sd">        the ratio of the filtered pulse height to the (FWHM) noise, in pulse height units. Both</span>
<span class="sd">        of these values assume pulses of the same size as that used to generate the filter: `nominal_peak`.</span>

<span class="sd">    """</span>

    <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">nominal_peak</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">variance</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">predicted_v_over_dv</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">n_pretrigger</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dt_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">const_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">signal_model</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">dt_model</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">convolution_lags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The name for this filter type"""</span>
        <span class="k">return</span> <span class="s2">"illegal: this is supposed to be an abstract base class"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a plot of the filter</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axis : plt.Axes, optional</span>
<span class="sd">            A pre-existing axis to plot on, by default None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"mass 5lag filter"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Filter type=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_type</span><span class="si">}</span><span class="s2"> V/dV=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"filter value"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Samples"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5898.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Report on estimated V/dV for the filter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        std_energy : float, optional</span>
<span class="sd">            Energy (in eV) of a "standard" pulse.  Resolution will be given in eV at this energy,</span>
<span class="sd">                assuming linear devices, by default 5898.8</span>
<span class="sd">        """</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span>
        <span class="n">v_dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span>
        <span class="n">fwhm_eV</span> <span class="o">=</span> <span class="n">std_energy</span> <span class="o">/</span> <span class="n">v_dv</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"v/</span><span class="se">\u03b4</span><span class="s2">v: </span><span class="si">{</span><span class="n">v_dv</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">, variance: </span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\u03b4</span><span class="s2">E: </span><span class="si">{</span><span class="n">fwhm_eV</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV (FWHM), assuming standard E=</span><span class="si">{</span><span class="n">std_energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Filter one microcalorimeter record or an array of records."""</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.filter_records">
<code class="highlight language-python"><span class="n">filter_records</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Filter one microcalorimeter record or an array of records.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Filter one microcalorimeter record or an array of records."""</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a plot of the filter</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>axis</code></b>
                  (<code><span title="matplotlib.pylab.Axes">Axes</span></code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A pre-existing axis to plot on, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a plot of the filter</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axis : plt.Axes, optional</span>
<span class="sd">        A pre-existing axis to plot on, by default None</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"mass 5lag filter"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Filter type=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_type</span><span class="si">}</span><span class="s2"> V/dV=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"filter value"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Samples"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.report">
<code class="highlight language-python"><span class="n">report</span><span class="p">(</span><span class="n">std_energy</span><span class="o">=</span><span class="mf">5898.8</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Report on estimated V/dV for the filter.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>std_energy</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>5898.8</code>
)
              
              <div class="doc-md-description">
<p>Energy (in eV) of a "standard" pulse.  Resolution will be given in eV at this energy,
    assuming linear devices, by default 5898.8</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5898.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Report on estimated V/dV for the filter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    std_energy : float, optional</span>
<span class="sd">        Energy (in eV) of a "standard" pulse.  Resolution will be given in eV at this energy,</span>
<span class="sd">            assuming linear devices, by default 5898.8</span>
<span class="sd">    """</span>
    <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span>
    <span class="n">v_dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span>
    <span class="n">fwhm_eV</span> <span class="o">=</span> <span class="n">std_energy</span> <span class="o">/</span> <span class="n">v_dv</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"v/</span><span class="se">\u03b4</span><span class="s2">v: </span><span class="si">{</span><span class="n">v_dv</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">, variance: </span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\u03b4</span><span class="s2">E: </span><span class="si">{</span><span class="n">fwhm_eV</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV (FWHM), assuming standard E=</span><span class="si">{</span><span class="n">std_energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter1Lag">
<code>Filter1Lag</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code></p>
<p>Represent an optimal filter, specifically one intended for single-lag convolution with data</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter1Lag


  
      dataclass
   (mass2.core.optimal_filtering.Filter1Lag)" href="#mass2.core.optimal_filtering.Filter1Lag">Filter1Lag</a></code>
              
              <div class="doc-md-description">
<p>An optimal filter, for single-lag convolution (i.e., a dot product) with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Filter1Lag</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represent an optimal filter, specifically one intended for single-lag convolution with data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter1Lag</span>
<span class="sd">        An optimal filter, for single-lag convolution (i.e., a dot product) with the data</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Post-init checks that this filter, indeed, is a 1-lag one"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Name for this filter type"""</span>
        <span class="k">return</span> <span class="s2">"1lag"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            A 1-d array, a single pulse record, or a 2-d array, where `x[i, :]` is pulse record number `i`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">            2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the input array is the wrong length</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">dotproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">peak_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">peak_y</span> <span class="o">=</span> <span class="n">dotproduct</span>
        <span class="k">return</span> <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter1Lag.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter1Lag.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Post-init checks that this filter, indeed, is a 1-lag one</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Post-init checks that this filter, indeed, is a 1-lag one"""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter1Lag.filter_records">
<code class="highlight language-python"><span class="n">filter_records</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Filter one microcalorimeter record or an array of records.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 1-d array, a single pulse record, or a 2-d array, where <code>x[i, :]</code> is pulse record number <code>i</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
              
              <div class="doc-md-description">
<ol>
<li>The optimally filtered value, or an array (one per row) if the input is a 2-d array.</li>
<li>The phase, or arrival-time estimate in samples. Same shape as the filtered value.</li>
</ol>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="AssertionError">AssertionError</span></code>
              
              <div class="doc-md-description">
<p>If the input array is the wrong length</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        A 1-d array, a single pulse record, or a 2-d array, where `x[i, :]` is pulse record number `i`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">        2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AssertionError</span>
<span class="sd">        If the input array is the wrong length</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">dotproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">peak_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">peak_y</span> <span class="o">=</span> <span class="n">dotproduct</span>
    <span class="k">return</span> <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag">
<code>Filter5Lag</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code></p>
<p>Represent an optimal filter, specifically one intended for 5-lag convolution with data</p>
<pre><code>The traditional 5-lag filter used by default until 2015.
</code></pre>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter5Lag


  
      dataclass
   (mass2.core.optimal_filtering.Filter5Lag)" href="#mass2.core.optimal_filtering.Filter5Lag">Filter5Lag</a></code>
              
              <div class="doc-md-description">
<p>An optimal filter, for convolution with data (at 5 lags, obviously)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Filter5Lag</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represent an optimal filter, specifically one intended for 5-lag convolution with data</span>

<span class="sd">        The traditional 5-lag filter used by default until 2015.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter5Lag</span>
<span class="sd">        An optimal filter, for convolution with data (at 5 lags, obviously)</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Post-init checks that this filter, indeed, is a 5-lag one"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">5</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Name for this filter type"""</span>
        <span class="k">return</span> <span class="s2">"5lag"</span>

    <span class="c1"># These parameters fit a parabola to any 5 evenly-spaced points</span>
    <span class="n">FIVELAG_FITTER</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="mf">70.0</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            A 1-d array, a single pulse record, or a 2-d array, where `x[i, :]` is pulse record number `i`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">            2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the input array is the wrong length</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">nrec</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span>
        <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">nrec</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlags</span><span class="p">,</span> <span class="n">nrec</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nlags</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">conv</span><span class="p">[</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Least-squares fit of 5 values to a parabola.</span>
        <span class="c1"># Order is row 0 = constant ... row 2 = quadratic coefficients.</span>
        <span class="k">if</span> <span class="n">nlags</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Currently require 5 lags to estimate peak x, y"</span><span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIVELAG_FITTER</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="n">peak_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">peak_y</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Post-init checks that this filter, indeed, is a 5-lag one</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Post-init checks that this filter, indeed, is a 5-lag one"""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag.filter_records">
<code class="highlight language-python"><span class="n">filter_records</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Filter one microcalorimeter record or an array of records.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 1-d array, a single pulse record, or a 2-d array, where <code>x[i, :]</code> is pulse record number <code>i</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
              
              <div class="doc-md-description">
<ol>
<li>The optimally filtered value, or an array (one per row) if the input is a 2-d array.</li>
<li>The phase, or arrival-time estimate in samples. Same shape as the filtered value.</li>
</ol>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="AssertionError">AssertionError</span></code>
              
              <div class="doc-md-description">
<p>If the input array is the wrong length</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        A 1-d array, a single pulse record, or a 2-d array, where `x[i, :]` is pulse record number `i`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">        2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AssertionError</span>
<span class="sd">        If the input array is the wrong length</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">nrec</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span>
    <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nrec</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlags</span><span class="p">,</span> <span class="n">nrec</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nlags</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">conv</span><span class="p">[</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Least-squares fit of 5 values to a parabola.</span>
    <span class="c1"># Order is row 0 = constant ... row 2 = quadratic coefficients.</span>
    <span class="k">if</span> <span class="n">nlags</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Currently require 5 lags to estimate peak x, y"</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIVELAG_FITTER</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
    <span class="n">peak_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">peak_y</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS">
<code>FilterATS</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code></p>
<p>Represent an optimal filter according to the arrival-time-safe, single-lag design of 2015.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="FilterATS


  
      dataclass
   (mass2.core.optimal_filtering.FilterATS)" href="#mass2.core.optimal_filtering.FilterATS">FilterATS</a></code>
              
              <div class="doc-md-description">
<p>An optimal filter, for convolution with data (at 5 lags, obviously)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterATS</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represent an optimal filter according to the arrival-time-safe, single-lag design of 2015.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FilterATS</span>
<span class="sd">        An optimal filter, for convolution with data (at 5 lags, obviously)</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Post-init checks that this filter aexpects one lag, and has a dt_values array"""</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the name for this filter type"""</span>
        <span class="k">return</span> <span class="s2">"ats"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            A 1-d array, a single pulse record, or a 2-d array, each row a pulse records.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">            2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the input array is the wrong length</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_filter_records_ats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Post-init checks that this filter aexpects one lag, and has a dt_values array</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Post-init checks that this filter aexpects one lag, and has a dt_values array"""</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS.filter_records">
<code class="highlight language-python"><span class="n">filter_records</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Filter one microcalorimeter record or an array of records.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 1-d array, a single pulse record, or a 2-d array, each row a pulse records.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
              
              <div class="doc-md-description">
<ol>
<li>The optimally filtered value, or an array (one per row) if the input is a 2-d array.</li>
<li>The phase, or arrival-time estimate in samples. Same shape as the filtered value.</li>
</ol>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="AssertionError">AssertionError</span></code>
              
              <div class="doc-md-description">
<p>If the input array is the wrong length</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        A 1-d array, a single pulse record, or a 2-d array, each row a pulse records.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">        2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AssertionError</span>
<span class="sd">        If the input array is the wrong length</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_filter_records_ats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker">
<code>FilterMaker</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An object capable of creating optimal filter based on a single signal and noise set.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>signal_model</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>The average signal shape.  Filters will be rescaled so that the output
upon putting this signal into the filter equals the <em>peak value</em> of this
filter (that is, peak value relative to the baseline level).</p>
</div>
</li>
<li>
<b><code>n_pretrigger</code></b>
                  (<code><span title="int">int</span></code>)
              
              <div class="doc-md-description">
<p>The number of leading samples in the average signal that are considered
to be pre-trigger samples.  The avg_signal in this section is replaced by
its constant averaged value before creating filters.  Also, one filter
(filt_baseline_pretrig) is designed to infer the baseline using only
<code>n_pretrigger</code> samples at the start of a record.</p>
</div>
</li>
<li>
<b><code>noise_autocorr</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The autocorrelation function of the noise, where the lag spacing is
assumed to be the same as the sample period of <code>avg_signal</code>.</p>
</div>
</li>
<li>
<b><code>noise_psd</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The noise power spectral density.  If not None, then it must be of length (2N+1),
where N is the length of <code>avg_signal</code>, and its values are assumed to cover the
non-negative frequencies from 0, 1/Delta, 2/Delta,.... up to the Nyquist frequency.
If None, then method <code>compute_fourier()</code> will not work.</p>
</div>
</li>
<li>
<b><code>whitener</code></b>
                  (<code><span title="Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ToeplitzWhitener


  
      dataclass
   (mass2.core.optimal_filtering.ToeplitzWhitener)" href="#mass2.core.optimal_filtering.ToeplitzWhitener">ToeplitzWhitener</a>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>An optional function object which, when called, whitens a vector or the
columns of a matrix. Supersedes <code>noise_autocorr</code> if both are given.</p>
</div>
</li>
<li>
<b><code>sample_time_sec</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0</code>
)
              
              <div class="doc-md-description">
<p>The time step between samples in <code>avg_signal</code> and <code>noise_autocorr</code> (in seconds).
This must be given if <code>fmax</code> or <code>f_3db</code> are ever to be used.</p>
</div>
</li>
<li>
<b><code>peak</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0</code>
)
              
              <div class="doc-md-description">
<p>The peak amplitude of the standard signal</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="note" open="">
<summary>Notes</summary>
<ul>
<li>
<p>If both <code>noise_autocorr</code> and <code>whitener</code> are None, then methods <code>compute_5lag</code> and
<code>compute_ats</code> will both fail, as they require a time-domain characterization of the
noise.</p>
</li>
<li>
<p>The units of <code>noise_autocorr</code> are the square of the units used in <code>signal_model</code> and/or
<code>peak</code>. The units of <code>whitener</code> are the inverse of the signal units.  Any rescaling of the
noise autocorrelation or whitener does not affect any filter values, but only
the predicted signal/noise ratios.</p>
</li>
<li>
<p>The units of <code>noise_psd</code> are square signal units, per Hertz.</p>
</li>
</ul>
</details>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="FilterMaker


  
      dataclass
   (mass2.core.optimal_filtering.FilterMaker)" href="#mass2.core.optimal_filtering.FilterMaker">FilterMaker</a></code>
              
              <div class="doc-md-description">
<p>An object that can make a variety of optimal filters, assuming a single signal and noise analysis.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An object capable of creating optimal filter based on a single signal and noise set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    signal_model : ArrayLike</span>
<span class="sd">        The average signal shape.  Filters will be rescaled so that the output</span>
<span class="sd">        upon putting this signal into the filter equals the *peak value* of this</span>
<span class="sd">        filter (that is, peak value relative to the baseline level).</span>
<span class="sd">    n_pretrigger : int</span>
<span class="sd">        The number of leading samples in the average signal that are considered</span>
<span class="sd">        to be pre-trigger samples.  The avg_signal in this section is replaced by</span>
<span class="sd">        its constant averaged value before creating filters.  Also, one filter</span>
<span class="sd">        (filt_baseline_pretrig) is designed to infer the baseline using only</span>
<span class="sd">        `n_pretrigger` samples at the start of a record.</span>
<span class="sd">    noise_autocorr : Optional[ArrayLike]</span>
<span class="sd">        The autocorrelation function of the noise, where the lag spacing is</span>
<span class="sd">        assumed to be the same as the sample period of `avg_signal`.</span>
<span class="sd">    noise_psd : Optional[ArrayLike]</span>
<span class="sd">        The noise power spectral density.  If not None, then it must be of length (2N+1),</span>
<span class="sd">        where N is the length of `avg_signal`, and its values are assumed to cover the</span>
<span class="sd">        non-negative frequencies from 0, 1/Delta, 2/Delta,.... up to the Nyquist frequency.</span>
<span class="sd">        If None, then method `compute_fourier()` will not work.</span>
<span class="sd">    whitener : Optional[ToeplitzWhitener]</span>
<span class="sd">        An optional function object which, when called, whitens a vector or the</span>
<span class="sd">        columns of a matrix. Supersedes `noise_autocorr` if both are given.</span>
<span class="sd">    sample_time_sec : float</span>
<span class="sd">        The time step between samples in `avg_signal` and `noise_autocorr` (in seconds).</span>
<span class="sd">        This must be given if `fmax` or `f_3db` are ever to be used.</span>
<span class="sd">    peak : float</span>
<span class="sd">        The peak amplitude of the standard signal</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    * If both `noise_autocorr` and `whitener` are None, then methods `compute_5lag` and</span>
<span class="sd">    `compute_ats` will both fail, as they require a time-domain characterization of the</span>
<span class="sd">    noise.</span>

<span class="sd">    * The units of `noise_autocorr` are the square of the units used in `signal_model` and/or</span>
<span class="sd">    `peak`. The units of `whitener` are the inverse of the signal units.  Any rescaling of the</span>
<span class="sd">    noise autocorrelation or whitener does not affect any filter values, but only</span>
<span class="sd">    the predicted signal/noise ratios.</span>

<span class="sd">    * The units of `noise_psd` are square signal units, per Hertz.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FilterMaker</span>
<span class="sd">        An object that can make a variety of optimal filters, assuming a single signal and noise analysis.</span>
<span class="sd">    """</span>

    <span class="n">signal_model</span><span class="p">:</span> <span class="n">NDArray</span>
    <span class="n">n_pretrigger</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">noise_autocorr</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">noise_psd</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dt_model</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">whitener</span><span class="p">:</span> <span class="n">ToeplitzWhitener</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sample_time_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">peak</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_constrained_1lag</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">constraints</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter. Can be used with 0-lag "convolution" only,</span>
<span class="sd">        so cannot estimate arrival time.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints: ndarray, optional</span>
<span class="sd">            The vector or vectors to which the filter should be orthogonal. If a 2d array, each _row_</span>
<span class="sd">            is a constraint, and the number of columns should be equal to the len(self.signal_model)</span>
<span class="sd">            minus `(cut_pre+cut_post)`.</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 1-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate 1-lag filters"</span><span class="p">)</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">,</span> <span class="s2">"Noise autocorrelation vector is too short for signal size"</span>
        <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">avg_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pulse_model</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span>

        <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Rinv_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pulse_model</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv_model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">all_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Rinv_model</span><span class="p">)</span>
        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">band_limit</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filter</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_corr</span><span class="p">)</span>

        <span class="c1"># Set weights in the cut_pre and cut_post windows to 0</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">),</span> <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_post</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">variance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">Filter1Lag</span><span class="p">(</span>
            <span class="n">filt_noconst</span><span class="p">,</span>
            <span class="n">peak</span><span class="p">,</span>
            <span class="n">variance</span><span class="p">,</span>
            <span class="n">vdv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">avg_signal</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">fmax</span><span class="p">,</span>
            <span class="n">f_3db</span><span class="p">,</span>
            <span class="n">cut_pre</span><span class="p">,</span>
            <span class="n">cut_post</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_1lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter. Can be used with 0-lag "convolution" only,</span>
<span class="sd">        so cannot estimate arrival time.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 1-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_1lag</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_constrained_5lag</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">constraints</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints: ndarray, optional</span>
<span class="sd">            The vector or vectors to which the filter should be orthogonal. If a 2d array, each _row_</span>
<span class="sd">            is a constraint, and the number of columns should be equal to the len(self.signal_model)</span>
<span class="sd">            minus `(cut_pre+cut_post)`.</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate 5-lag filters"</span><span class="p">)</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># for 5-lag convolution</span>
        <span class="n">truncated_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">,</span> <span class="s2">"Noise autocorrelation vector is too short for signal size"</span>
        <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">truncated_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pulse_model</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span>

        <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Rinv_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pulse_model</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv_model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">all_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Rinv_model</span><span class="p">)</span>
        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">band_limit</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_corr</span><span class="p">)</span>

        <span class="c1"># Set weights in the cut_pre and cut_post windows to 0</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">),</span> <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_post</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">variance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
            <span class="n">filt_noconst</span><span class="p">,</span>
            <span class="n">peak</span><span class="p">,</span>
            <span class="n">variance</span><span class="p">,</span>
            <span class="n">vdv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">avg_signal</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span>
            <span class="n">fmax</span><span class="p">,</span>
            <span class="n">f_3db</span><span class="p">,</span>
            <span class="n">cut_pre</span><span class="p">,</span>
            <span class="n">cut_post</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag_noexp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exp_time_seconds: float</span>
<span class="sd">            Generate a filter orthogonal to decaying exponentials of this time constant (must be positive)</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">exp_time_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">log_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">/</span> <span class="n">exp_time_seconds</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_per_sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fourier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single Fourier-domain filter, with optional low-pass filtering, and with optional</span>
<span class="sd">        zero weights at the pre-trigger or post-trigger end of the filter. Fourier domain calculation</span>
<span class="sd">        implicitly assumes periodic boundary conditions.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter, computed in the Fourier domain.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="c1"># Make sure we have either a noise PSD or an autocorrelation or a whitener</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_psd to generate a Fourier filter"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span><span class="p">)</span>

        <span class="c1"># Terminology: the `avg_signal` vector will be "shortened" by `shorten` _on each end.</span>
        <span class="c1"># That's to permit 5-lag filtering (where we step the filter by 2 lags either direction from 0 lag).</span>
        <span class="c1"># The `avg_signal` was already "reduced" in length by (cut_pre, cut_post), for a total</span>
        <span class="c1"># `reduction` of `2 * shorten + (cut_pre + cut_post)`.</span>
        <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># to use in 5-lag style</span>
        <span class="n">reduction</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span> <span class="o">+</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">truncated_avg_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
        <span class="n">len_reduced_psd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reduction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sig_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">truncated_avg_signal</span> <span class="o">*</span> <span class="n">window</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len_reduced_psd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"signal real DFT and noise PSD are not the same length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">len_reduced_psd</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

        <span class="c1"># Careful with PSD: "shorten" it by converting into a real space autocorrelation,</span>
        <span class="c1"># truncating the middle, and going back to Fourier space</span>
        <span class="k">if</span> <span class="n">reduction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span>
            <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">noise_autocorr</span><span class="p">[:</span> <span class="n">len_reduced_psd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">noise_autocorr</span><span class="p">[</span><span class="o">-</span><span class="n">len_reduced_psd</span><span class="p">:]))</span>
            <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">))</span>
        <span class="n">sig_ft_weighted</span> <span class="o">=</span> <span class="n">sig_ft</span> <span class="o">/</span> <span class="n">noise_psd</span>

        <span class="c1"># Band-limit</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_nyquist</span><span class="p">,</span> <span class="n">len_reduced_psd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sig_ft_weighted</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">f_3db</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">filt_fourier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">sig_ft_weighted</span><span class="p">)</span> <span class="o">/</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>

        <span class="c1"># How we compute the uncertainty depends on whether there's a noise autocorrelation result</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_ft_squared</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">*</span> <span class="n">noise_psd</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">noise_ft_squared</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">variance_fourier</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">kappa</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">noise_ft_squared</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span><span class="p">)[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">)]</span>
            <span class="n">variance_fourier</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_fourier</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
            <span class="n">filt_fourier</span><span class="p">,</span>
            <span class="n">peak</span><span class="p">,</span>
            <span class="n">variance_fourier</span><span class="p">,</span>
            <span class="n">vdv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">truncated_avg_signal</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span>
            <span class="n">fmax</span><span class="p">,</span>
            <span class="n">f_3db</span><span class="p">,</span>
            <span class="n">cut_pre</span><span class="p">,</span>
            <span class="n">cut_post</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_ats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>  <span class="c1"># noqa: PLR0914</span>
<span class="w">        </span><span class="sd">"""Compute a single "arrival-time-safe" filter, with optional low-pass filtering,</span>
<span class="sd">        and with optional zero weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            An arrival-time-safe optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate ATS filters"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have dt_model to generate ATS filters"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>

        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cut_pre+cut_post = </span><span class="si">{</span><span class="n">cut_pre</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cut_post</span><span class="si">}</span><span class="s2"> but should be &lt; </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">MT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">avg_signal</span><span class="p">,</span> <span class="n">dt_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ns</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">WM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="p">(</span><span class="n">MT</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WM</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">WM</span><span class="p">)</span>
            <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">WtWM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">WM</span><span class="p">)</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">WtWM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ns</span>
            <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">ns</span><span class="p">]</span>
            <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">RinvM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">MT</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="n">RinvM</span><span class="p">)</span>
            <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">RinvM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">band_limit</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nfilt</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">filt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)])</span>

        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filt_dt</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filt_baseline</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_autocorr</span><span class="p">)</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">FilterATS</span><span class="p">(</span>
            <span class="n">filt_noconst</span><span class="p">,</span>
            <span class="n">peak</span><span class="p">,</span>
            <span class="n">variance</span><span class="p">,</span>
            <span class="n">vdv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span><span class="p">,</span>
            <span class="n">filt_dt</span><span class="p">,</span>
            <span class="n">filt_baseline</span><span class="p">,</span>
            <span class="n">avg_signal</span><span class="p">,</span>
            <span class="n">dt_model</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">fmax</span><span class="p">,</span>
            <span class="n">f_3db</span><span class="p">,</span>
            <span class="n">cut_pre</span><span class="p">,</span>
            <span class="n">cut_post</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_autocorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the noise autocorrelation, if any, cut down by the requested number of values at the start and end.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cut_pre : int, optional</span>
<span class="sd">            How many samples to remove from the start of the each pulse record, by default 0</span>
<span class="sd">        cut_post : int, optional</span>
<span class="sd">            How many samples to remove from the end of the each pulse record, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The noise autocorrelation of the appropriate length. Or a length-0 array if not known.</span>
<span class="sd">        """</span>
        <span class="c1"># If there's an autocorrelation, cut it down to length.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span><span class="p">)[:</span> <span class="n">N</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Compute the normalized signal, peak value, and first-order arrival-time model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cut_pre : int, optional</span>
<span class="sd">            How many samples to remove from the start of the each pulse record, by default 0</span>
<span class="sd">        cut_post : int, optional</span>
<span class="sd">            How many samples to remove from the end of the each pulse record, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, float, np.ndarray]</span>
<span class="sd">            (sig, pk, dsig), where `sig` is the nominal signal model (normalized to have unit amplitude), `pk` is the</span>
<span class="sd">            peak values of the nominal signal, and `dsig` is the delta between `sig` that differ by one sample in</span>
<span class="sd">            arrival time. The `dsig` will be an empty array if no arrival-time model is known.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If negative numbers of samples are to be cut, or the entire record is to be cut.</span>
<span class="sd">        """</span>
        <span class="n">avg_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">)</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">pre_avg</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cut_pre+cut_post = </span><span class="si">{</span><span class="n">cut_pre</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cut_post</span><span class="si">}</span><span class="s2"> but should be &lt; </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Unless passed in, find the signal's peak value. This is normally peak=(max-pretrigger).</span>
        <span class="c1"># If signal is negative-going, however, then peak=(pretrigger-min).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">peak_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">is_negative</span> <span class="o">=</span> <span class="n">pre_avg</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">-</span> <span class="n">pre_avg</span>
            <span class="k">if</span> <span class="n">is_negative</span><span class="p">:</span>
                <span class="n">peak_signal</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">pre_avg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peak_signal</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">pre_avg</span>

        <span class="c1"># avg_signal: normalize to have unit peak</span>
        <span class="n">avg_signal</span> <span class="o">-=</span> <span class="n">pre_avg</span>

        <span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">avg_signal</span> <span class="o">*=</span> <span class="n">rescale</span>
        <span class="n">avg_signal</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">avg_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="o">*</span> <span class="n">rescale</span>
            <span class="n">dt_model</span> <span class="o">=</span> <span class="n">dt_model</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak_signal</span><span class="p">,</span> <span class="n">dt_model</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_5lag_filter</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Rescale 5-lag filter `f` in-place so that it gives unit response to avg_signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : np.ndarray</span>
<span class="sd">            Optimal filter values, which need to be renormalized</span>
<span class="sd">        avg_signal : np.ndarray</span>
<span class="sd">            The signal to which filter `f` should give unit response</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fit_ctr</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fit_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">fit_ctr</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">fit_peak</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_filter</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Rescale single-lag filter `f` in-place so that it gives unit response to avg_signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : np.ndarray</span>
<span class="sd">            Optimal filter values, which need to be renormalized</span>
<span class="sd">        avg_signal : np.ndarray</span>
<span class="sd">            The signal to which filter `f` should give unit response</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_1lag">
<code class="highlight language-python"><span class="n">compute_1lag</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter. Can be used with 0-lag "convolution" only,
so cannot estimate arrival time.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 1-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_1lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter. Can be used with 0-lag "convolution" only,</span>
<span class="sd">    so cannot estimate arrival time.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 1-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_1lag</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_5lag">
<code class="highlight language-python"><span class="n">compute_5lag</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_5lag_noexp">
<code class="highlight language-python"><span class="n">compute_5lag_noexp</span><span class="p">(</span><span class="n">exp_time_seconds</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>exp_time_seconds</code></b>
                  (<code><span title="float">float</span></code>)
              
              <div class="doc-md-description">
<p>Generate a filter orthogonal to decaying exponentials of this time constant (must be positive)</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag_noexp</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_time_seconds: float</span>
<span class="sd">        Generate a filter orthogonal to decaying exponentials of this time constant (must be positive)</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">exp_time_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">log_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">/</span> <span class="n">exp_time_seconds</span>
    <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_per_sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_ats">
<code class="highlight language-python"><span class="n">compute_ats</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single "arrival-time-safe" filter, with optional low-pass filtering,
and with optional zero weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>An arrival-time-safe optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_ats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>  <span class="c1"># noqa: PLR0914</span>
<span class="w">    </span><span class="sd">"""Compute a single "arrival-time-safe" filter, with optional low-pass filtering,</span>
<span class="sd">    and with optional zero weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        An arrival-time-safe optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate ATS filters"</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have dt_model to generate ATS filters"</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>

    <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cut_pre+cut_post = </span><span class="si">{</span><span class="n">cut_pre</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cut_post</span><span class="si">}</span><span class="s2"> but should be &lt; </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">MT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">avg_signal</span><span class="p">,</span> <span class="n">dt_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ns</span><span class="p">)))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">WM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="p">(</span><span class="n">MT</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WM</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">WM</span><span class="p">)</span>
        <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">WtWM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">WM</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">WtWM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ns</span>
        <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">ns</span><span class="p">]</span>
        <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">RinvM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">MT</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="n">RinvM</span><span class="p">)</span>
        <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">RinvM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">band_limit</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nfilt</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">filt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)])</span>

    <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">filt_dt</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">filt_baseline</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_autocorr</span><span class="p">)</span>
    <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">FilterATS</span><span class="p">(</span>
        <span class="n">filt_noconst</span><span class="p">,</span>
        <span class="n">peak</span><span class="p">,</span>
        <span class="n">variance</span><span class="p">,</span>
        <span class="n">vdv</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span><span class="p">,</span>
        <span class="n">filt_dt</span><span class="p">,</span>
        <span class="n">filt_baseline</span><span class="p">,</span>
        <span class="n">avg_signal</span><span class="p">,</span>
        <span class="n">dt_model</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_constrained_1lag">
<code class="highlight language-python"><span class="n">compute_constrained_1lag</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter. Can be used with 0-lag "convolution" only,
so cannot estimate arrival time.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>constraints</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The vector or vectors to which the filter should be orthogonal. If a 2d array, each <em>row</em>
is a constraint, and the number of columns should be equal to the len(self.signal_model)
minus <code>(cut_pre+cut_post)</code>.</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 1-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_constrained_1lag</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter. Can be used with 0-lag "convolution" only,</span>
<span class="sd">    so cannot estimate arrival time.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    constraints: ndarray, optional</span>
<span class="sd">        The vector or vectors to which the filter should be orthogonal. If a 2d array, each _row_</span>
<span class="sd">        is a constraint, and the number of columns should be equal to the len(self.signal_model)</span>
<span class="sd">        minus `(cut_pre+cut_post)`.</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 1-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate 1-lag filters"</span><span class="p">)</span>
    <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">,</span> <span class="s2">"Noise autocorrelation vector is too short for signal size"</span>
    <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">avg_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pulse_model</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span>

    <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Rinv_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pulse_model</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv_model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">all_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Rinv_model</span><span class="p">)</span>
    <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">band_limit</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filter</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_corr</span><span class="p">)</span>

    <span class="c1"># Set weights in the cut_pre and cut_post windows to 0</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">),</span> <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_post</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">variance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">Filter1Lag</span><span class="p">(</span>
        <span class="n">filt_noconst</span><span class="p">,</span>
        <span class="n">peak</span><span class="p">,</span>
        <span class="n">variance</span><span class="p">,</span>
        <span class="n">vdv</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">avg_signal</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_constrained_5lag">
<code class="highlight language-python"><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>constraints</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The vector or vectors to which the filter should be orthogonal. If a 2d array, each <em>row</em>
is a constraint, and the number of columns should be equal to the len(self.signal_model)
minus <code>(cut_pre+cut_post)</code>.</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_constrained_5lag</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    constraints: ndarray, optional</span>
<span class="sd">        The vector or vectors to which the filter should be orthogonal. If a 2d array, each _row_</span>
<span class="sd">        is a constraint, and the number of columns should be equal to the len(self.signal_model)</span>
<span class="sd">        minus `(cut_pre+cut_post)`.</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate 5-lag filters"</span><span class="p">)</span>
    <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># for 5-lag convolution</span>
    <span class="n">truncated_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">,</span> <span class="s2">"Noise autocorrelation vector is too short for signal size"</span>
    <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">truncated_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pulse_model</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span>

    <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Rinv_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pulse_model</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv_model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">all_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Rinv_model</span><span class="p">)</span>
    <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">band_limit</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_corr</span><span class="p">)</span>

    <span class="c1"># Set weights in the cut_pre and cut_post windows to 0</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">),</span> <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_post</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">variance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
        <span class="n">filt_noconst</span><span class="p">,</span>
        <span class="n">peak</span><span class="p">,</span>
        <span class="n">variance</span><span class="p">,</span>
        <span class="n">vdv</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">avg_signal</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_fourier">
<code class="highlight language-python"><span class="n">compute_fourier</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single Fourier-domain filter, with optional low-pass filtering, and with optional
zero weights at the pre-trigger or post-trigger end of the filter. Fourier domain calculation
implicitly assumes periodic boundary conditions.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter, computed in the Fourier domain.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_fourier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single Fourier-domain filter, with optional low-pass filtering, and with optional</span>
<span class="sd">    zero weights at the pre-trigger or post-trigger end of the filter. Fourier domain calculation</span>
<span class="sd">    implicitly assumes periodic boundary conditions.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter, computed in the Fourier domain.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="c1"># Make sure we have either a noise PSD or an autocorrelation or a whitener</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_psd to generate a Fourier filter"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span><span class="p">)</span>

    <span class="c1"># Terminology: the `avg_signal` vector will be "shortened" by `shorten` _on each end.</span>
    <span class="c1"># That's to permit 5-lag filtering (where we step the filter by 2 lags either direction from 0 lag).</span>
    <span class="c1"># The `avg_signal` was already "reduced" in length by (cut_pre, cut_post), for a total</span>
    <span class="c1"># `reduction` of `2 * shorten + (cut_pre + cut_post)`.</span>
    <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># to use in 5-lag style</span>
    <span class="n">reduction</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span> <span class="o">+</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">truncated_avg_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
    <span class="n">len_reduced_psd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reduction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">window</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">sig_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">truncated_avg_signal</span> <span class="o">*</span> <span class="n">window</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len_reduced_psd</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"signal real DFT and noise PSD are not the same length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">len_reduced_psd</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

    <span class="c1"># Careful with PSD: "shorten" it by converting into a real space autocorrelation,</span>
    <span class="c1"># truncating the middle, and going back to Fourier space</span>
    <span class="k">if</span> <span class="n">reduction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">noise_autocorr</span><span class="p">[:</span> <span class="n">len_reduced_psd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">noise_autocorr</span><span class="p">[</span><span class="o">-</span><span class="n">len_reduced_psd</span><span class="p">:]))</span>
        <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">))</span>
    <span class="n">sig_ft_weighted</span> <span class="o">=</span> <span class="n">sig_ft</span> <span class="o">/</span> <span class="n">noise_psd</span>

    <span class="c1"># Band-limit</span>
    <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f_nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_nyquist</span><span class="p">,</span> <span class="n">len_reduced_psd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_ft_weighted</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">f_3db</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">filt_fourier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">sig_ft_weighted</span><span class="p">)</span> <span class="o">/</span> <span class="n">window</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>

    <span class="c1"># How we compute the uncertainty depends on whether there's a noise autocorrelation result</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noise_ft_squared</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">*</span> <span class="n">noise_psd</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">noise_ft_squared</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">variance_fourier</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">kappa</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">noise_ft_squared</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span><span class="p">)[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">)]</span>
        <span class="n">variance_fourier</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>
    <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_fourier</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
        <span class="n">filt_fourier</span><span class="p">,</span>
        <span class="n">peak</span><span class="p">,</span>
        <span class="n">variance_fourier</span><span class="p">,</span>
        <span class="n">vdv</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">truncated_avg_signal</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener">
<code>ToeplitzWhitener</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An object that can perform approximate noise whitening.</p>
<p>For an ARMA(p,q) noise model, mutliply by (or solve) the matrix W (or its
transpose), where W is the Toeplitz approximation to the whitening matrix V.
A whitening matrix V means that if R is the ARMA noise covariance matrix,
then VRV' = I. While W only approximately satisfies this, it has some handy
properties that make it a useful replacement. (In particular, it has the
time-transpose property that if you zero-pad the beginning of vector v and
shift the remaining elements, then the same is done to Wv.)</p>
<p>The callable function object returns Wv or WM if called with
vector v or matrix M. Other methods:</p>
<ul>
<li><code>tw.whiten(v)</code> returns Wv; it is equivalent to <code>tw(v)</code></li>
<li><code>tw.solveWT(v)</code> returns inv(W')*v</li>
<li><code>tw.applyWT(v)</code> returns W'v</li>
<li><code>tw.solveW(v)</code> returns inv(W)*v</li>
</ul>
<details class="arguments" open="">
<summary>Arguments</summary>
<p>theta : np.ndarray
    The moving-average (MA) process coefficients
phi : np.ndarray
    The autoregressive (AR) process coefficients</p>
</details>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="ToeplitzWhitener


  
      dataclass
   (mass2.core.optimal_filtering.ToeplitzWhitener)" href="#mass2.core.optimal_filtering.ToeplitzWhitener">ToeplitzWhitener</a></code>
              
              <div class="doc-md-description">
<p>Object that can perform approximate, time-invariant noise whitening.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>If the operative methods are passed an array of dimension higher than 2.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToeplitzWhitener</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An object that can perform approximate noise whitening.</span>

<span class="sd">    For an ARMA(p,q) noise model, mutliply by (or solve) the matrix W (or its</span>
<span class="sd">    transpose), where W is the Toeplitz approximation to the whitening matrix V.</span>
<span class="sd">    A whitening matrix V means that if R is the ARMA noise covariance matrix,</span>
<span class="sd">    then VRV' = I. While W only approximately satisfies this, it has some handy</span>
<span class="sd">    properties that make it a useful replacement. (In particular, it has the</span>
<span class="sd">    time-transpose property that if you zero-pad the beginning of vector v and</span>
<span class="sd">    shift the remaining elements, then the same is done to Wv.)</span>

<span class="sd">    The callable function object returns Wv or WM if called with</span>
<span class="sd">    vector v or matrix M. Other methods:</span>

<span class="sd">    * `tw.whiten(v)` returns Wv; it is equivalent to `tw(v)`</span>
<span class="sd">    * `tw.solveWT(v)` returns inv(W')*v</span>
<span class="sd">    * `tw.applyWT(v)` returns W'v</span>
<span class="sd">    * `tw.solveW(v)` returns inv(W)*v</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    theta : np.ndarray</span>
<span class="sd">        The moving-average (MA) process coefficients</span>
<span class="sd">    phi : np.ndarray</span>
<span class="sd">        The autoregressive (AR) process coefficients</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ToeplitzWhitener</span>
<span class="sd">        Object that can perform approximate, time-invariant noise whitening.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the operative methods are passed an array of dimension higher than 2.</span>
<span class="sd">    """</span>

    <span class="n">theta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">phi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the autoregressive order"""</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the moving-average order"""</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be an array of dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">w</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">w</span>

        <span class="c1"># Multiply by the Toeplitz AR matrix to make the MA*w vector.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Second, solve the MA matrix (a banded, lower-triangular Toeplitz matrix with</span>
        <span class="c1"># q non-zero subdiagonals.)</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solveW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return unwhitened vector (or matrix of column vectors) inv(W)*v"</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveW</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="c1"># Multiply by the Toeplitz MA matrix to make the AR*w vector.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Second, solve the AR matrix (a banded, lower-triangular Toeplitz matrix with</span>
        <span class="c1"># p non-zero subdiagonals.)</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solveWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return vector (or matrix of column vectors) inv(W')*v"</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">applyWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return vector (or matrix of column vectors) W'v"""</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the full, approximate whitening matrix.</span>

<span class="sd">        Normally the full W is large and slow to use. But it's here so you can</span>
<span class="sd">        easily test that W(len(v))*v == whiten(v), and similar.</span>
<span class="sd">        """</span>
        <span class="n">AR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">MA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">AR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">MA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">MA</span><span class="p">,</span> <span class="n">AR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.p">
<code class="highlight language-python"><span class="n">p</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the autoregressive order</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.q">
<code class="highlight language-python"><span class="n">q</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Return the moving-average order</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.W">
<code class="highlight language-python"><span class="n">W</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the full, approximate whitening matrix.</p>
<p>Normally the full W is large and slow to use. But it's here so you can
easily test that W(len(v))*v == whiten(v), and similar.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the full, approximate whitening matrix.</span>

<span class="sd">    Normally the full W is large and slow to use. But it's here so you can</span>
<span class="sd">    easily test that W(len(v))*v == whiten(v), and similar.</span>
<span class="sd">    """</span>
    <span class="n">AR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">MA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">AR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">MA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">MA</span><span class="p">,</span> <span class="n">AR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return whitened vector (or matrix of column vectors) Wv</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be an array of dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">w</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">w</span>

    <span class="c1"># Multiply by the Toeplitz AR matrix to make the MA*w vector.</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Second, solve the MA matrix (a banded, lower-triangular Toeplitz matrix with</span>
    <span class="c1"># q non-zero subdiagonals.)</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.applyWT">
<code class="highlight language-python"><span class="n">applyWT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return vector (or matrix of column vectors) W'v</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">applyWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return vector (or matrix of column vectors) W'v"""</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="p">:]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.solveW">
<code class="highlight language-python"><span class="n">solveW</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return unwhitened vector (or matrix of column vectors) inv(W)*v</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solveW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return unwhitened vector (or matrix of column vectors) inv(W)*v"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveW</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="c1"># Multiply by the Toeplitz MA matrix to make the AR*w vector.</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Second, solve the AR matrix (a banded, lower-triangular Toeplitz matrix with</span>
    <span class="c1"># p non-zero subdiagonals.)</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.solveWT">
<code class="highlight language-python"><span class="n">solveWT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return vector (or matrix of column vectors) inv(W')*v</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solveWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return vector (or matrix of column vectors) inv(W')*v"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="p">:]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.whiten">
<code class="highlight language-python"><span class="n">whiten</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return whitened vector (or matrix of column vectors) Wv</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.band_limit">
<code class="highlight language-python"><span class="n">band_limit</span><span class="p">(</span><span class="n">modelmatrix</span><span class="p">,</span> <span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Band-limit the column-vectors in a model matrix with a hard and/or
1-pole low-pass filter. Change the input <code>modelmatrix</code> in-place.</p>
<p>No effect if both <code>fmax</code> and <code>f_3db</code> are <code>None</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>modelmatrix</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              
              <div class="doc-md-description">
<p>The 1D or 2D array to band-limit. (If a 2D array, columns are independently band-limited.)</p>
</div>
</li>
<li>
<b><code>sample_time_sec</code></b>
                  (<code><span title="float">float</span></code>)
              
              <div class="doc-md-description">
<p>The sampling period, normally in seconds.</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>)
              
              <div class="doc-md-description">
<p>The hard maximum frequency (units are inverse of <code>sample_time_sec</code> units, or Hz)</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>)
              
              <div class="doc-md-description">
<p>The 1-pole low-pass filter's 3 dB point (same units as <code>fmax</code>)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">band_limit</span><span class="p">(</span><span class="n">modelmatrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sample_time_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Band-limit the column-vectors in a model matrix with a hard and/or</span>
<span class="sd">    1-pole low-pass filter. Change the input `modelmatrix` in-place.</span>

<span class="sd">    No effect if both `fmax` and `f_3db` are `None`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    modelmatrix : np.ndarray</span>
<span class="sd">        The 1D or 2D array to band-limit. (If a 2D array, columns are independently band-limited.)</span>
<span class="sd">    sample_time_sec : float</span>
<span class="sd">        The sampling period, normally in seconds.</span>
<span class="sd">    fmax : Optional[float]</span>
<span class="sd">        The hard maximum frequency (units are inverse of `sample_time_sec` units, or Hz)</span>
<span class="sd">    f_3db : Optional[float]</span>
<span class="sd">        The 1-pole low-pass filter's 3 dB point (same units as `fmax`)</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Handle the 2D case by calling this function once per column.</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">modelmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">band_limit</span><span class="p">(</span><span class="n">modelmatrix</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">vector</span> <span class="o">=</span> <span class="n">modelmatrix</span>
    <span class="n">filt_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">sig_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">filt_length</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">sample_time_sec</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_ft</span><span class="p">[</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_ft</span> <span class="o">/=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">freq</span> <span class="o">/</span> <span class="n">f_3db</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># n=filt_length is needed when filt_length is ODD</span>
    <span class="n">vector</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">filt_length</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.bracketR">
<code class="highlight language-python"><span class="n">bracketR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the dot product (q^T R q) for vector <q> and matrix R constructed from
the vector <noise> by R_ij = noise_|i-j|.  We don't want to construct the full matrix
R because for records as long as 10,000 samples, the matrix will consist of 10^8 floats
(800 MB of memory).</noise></q></p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bracketR</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the dot product (q^T R q) for vector &lt;q&gt; and matrix R constructed from</span>
<span class="sd">    the vector &lt;noise&gt; by R_ij = noise_|i-j|.  We don't want to construct the full matrix</span>
<span class="sd">    R because for records as long as 10,000 samples, the matrix will consist of 10^8 floats</span>
<span class="sd">    (800 MB of memory).</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Vector q (length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">) cannot be longer than the noise (length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">::</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">dot</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">dot</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dot</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.phase_correct"></a>
<div class="doc doc-contents first">
<p>Classes and functions to correct for arrival-time bias in optimal filtering.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.phase_correct.PhaseCorrector">
<code>PhaseCorrector</code>
</h2>
<div class="doc doc-contents">
<p>A class to correct for arrival-time bias in optimal filtering.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PhaseCorrector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A class to correct for arrival-time bias in optimal filtering."""</span>

    <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">phase_uniformifier_x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">phase_uniformifier_y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">corrections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CubicSpline</span><span class="p">],</span>
        <span class="n">indicatorName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">uncorrectedName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span> <span class="o">=</span> <span class="n">corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_uniformifier_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_uniformifier_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicatorName</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">indicatorName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncorrectedName</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">uncorrectedName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">toHDF5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"phase_correction"</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Write to the given HDF5 group for later recovery from disk (by fromHDF5 class method)."""</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">h5group_update</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="s2">"Overwrite or create a dataset in the given group."</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot overwrite phase correction dataset '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
            <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>

        <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"phase_uniformifier_x"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_x</span><span class="p">)</span>
        <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"phase_uniformifier_y"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_y</span><span class="p">)</span>
        <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"uncorrected_name"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncorrectedName</span><span class="p">)</span>
        <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"indicator_name"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicatorName</span><span class="p">)</span>
        <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"version"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">correction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">):</span>
            <span class="n">h5group_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">"correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_x"</span><span class="p">,</span> <span class="n">correction</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
            <span class="n">h5group_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">"correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_y"</span><span class="p">,</span> <span class="n">correction</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply the phase correction to the given data `ph`."""</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="c1"># attempt to force phases to fall between X and X</span>
        <span class="n">phase_uniformified</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="c1"># Compute a correction for each pulse for each correction-line energy</span>
        <span class="c1"># For the actual correction, don't let |ph| &gt; 0.6 sample</span>
        <span class="n">phase_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">phase_uniformified</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="n">pheight_corrected</span> <span class="o">=</span> <span class="n">_phase_corrected_filtvals</span><span class="p">(</span><span class="n">phase_clipped</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pheight_corrected</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Equivalent to self.correct()"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">phase_indicator</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromHDF5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"phase_correction"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"PhaseCorrector"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Recover a PhaseCorrector object from the given HDF5 group."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/phase_uniformifier_x"</span><span class="p">][()]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/phase_uniformifier_y"</span><span class="p">][()]</span>
        <span class="n">uncorrectedName</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/uncorrected_name"</span><span class="p">][()])</span>
        <span class="n">indicatorName</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/indicator_name"</span><span class="p">][()])</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/version"</span><span class="p">][()]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_x"</span> <span class="ow">in</span> <span class="n">hdf5_group</span><span class="p">:</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_x"</span><span class="p">][()]</span>
            <span class="n">_y</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_y"</span><span class="p">][()]</span>
            <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">version</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">version</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">corrections</span><span class="p">,</span> <span class="n">indicatorName</span><span class="p">,</span> <span class="n">uncorrectedName</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""String representation of this object."""</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""PhaseCorrector with</span>
<span class="s2">        splines at this many levels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">)</span><span class="si">}</span>
<span class="s2">        phase_uniformifier_x: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_x</span><span class="si">}</span>
<span class="s2">        phase_uniformifier_y: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_y</span><span class="si">}</span>
<span class="s2">        uncorrectedName: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uncorrectedName</span><span class="si">}</span>
<span class="s2">        """</span>
        <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct.PhaseCorrector.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">phase_indicator</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Equivalent to self.correct()</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
    <span class="s2">"Equivalent to self.correct()"</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">phase_indicator</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct.PhaseCorrector.__repr__">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>String representation of this object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""String representation of this object."""</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""PhaseCorrector with</span>
<span class="s2">    splines at this many levels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">)</span><span class="si">}</span>
<span class="s2">    phase_uniformifier_x: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_x</span><span class="si">}</span>
<span class="s2">    phase_uniformifier_y: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_y</span><span class="si">}</span>
<span class="s2">    uncorrectedName: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uncorrectedName</span><span class="si">}</span>
<span class="s2">    """</span>
    <span class="k">return</span> <span class="n">s</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct.PhaseCorrector.correct">
<code class="highlight language-python"><span class="n">correct</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply the phase correction to the given data <code>ph</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply the phase correction to the given data `ph`."""</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="c1"># attempt to force phases to fall between X and X</span>
    <span class="n">phase_uniformified</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="c1"># Compute a correction for each pulse for each correction-line energy</span>
    <span class="c1"># For the actual correction, don't let |ph| &gt; 0.6 sample</span>
    <span class="n">phase_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">phase_uniformified</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
    <span class="n">pheight_corrected</span> <span class="o">=</span> <span class="n">_phase_corrected_filtvals</span><span class="p">(</span><span class="n">phase_clipped</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pheight_corrected</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct.PhaseCorrector.fromHDF5">
<code class="highlight language-python"><span class="n">fromHDF5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'phase_correction'</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Recover a PhaseCorrector object from the given HDF5 group.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fromHDF5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"phase_correction"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"PhaseCorrector"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Recover a PhaseCorrector object from the given HDF5 group."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/phase_uniformifier_x"</span><span class="p">][()]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/phase_uniformifier_y"</span><span class="p">][()]</span>
    <span class="n">uncorrectedName</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/uncorrected_name"</span><span class="p">][()])</span>
    <span class="n">indicatorName</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/indicator_name"</span><span class="p">][()])</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/version"</span><span class="p">][()]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_x"</span> <span class="ow">in</span> <span class="n">hdf5_group</span><span class="p">:</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_x"</span><span class="p">][()]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_y"</span><span class="p">][()]</span>
        <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">version</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">version</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">corrections</span><span class="p">,</span> <span class="n">indicatorName</span><span class="p">,</span> <span class="n">uncorrectedName</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct.PhaseCorrector.toHDF5">
<code class="highlight language-python"><span class="n">toHDF5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'phase_correction'</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Write to the given HDF5 group for later recovery from disk (by fromHDF5 class method).</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">toHDF5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"phase_correction"</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Write to the given HDF5 group for later recovery from disk (by fromHDF5 class method)."""</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">h5group_update</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">"Overwrite or create a dataset in the given group."</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot overwrite phase correction dataset '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>

    <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"phase_uniformifier_x"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_x</span><span class="p">)</span>
    <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"phase_uniformifier_y"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_uniformifier_y</span><span class="p">)</span>
    <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"uncorrected_name"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncorrectedName</span><span class="p">)</span>
    <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"indicator_name"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicatorName</span><span class="p">)</span>
    <span class="n">h5group_update</span><span class="p">(</span><span class="s2">"version"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">correction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="p">):</span>
        <span class="n">h5group_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">"correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_x"</span><span class="p">,</span> <span class="n">correction</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
        <span class="n">h5group_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">"correction_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_y"</span><span class="p">,</span> <span class="n">correction</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.phase_correct.phase_correct">
<code class="highlight language-python"><span class="n">phase_correct</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">pheight</span><span class="p">,</span> <span class="n">ph_peaks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method2017</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indicatorName</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">uncorrectedName</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Create a PhaseCorrector object to correct for arrival-time bias in optimal filtering.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">phase_correct</span><span class="p">(</span>
    <span class="n">phase</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">pheight</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">ph_peaks</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method2017</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">kernel_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">indicatorName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
    <span class="n">uncorrectedName</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PhaseCorrector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a PhaseCorrector object to correct for arrival-time bias in optimal filtering."""</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
    <span class="n">pheight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pheight</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ph_peaks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ph_peaks</span> <span class="o">=</span> <span class="n">_find_peaks_heuristic</span><span class="p">(</span><span class="n">pheight</span><span class="p">)</span>
    <span class="n">ph_peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph_peaks</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph_peaks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Could not phase_correct because no peaks found"</span><span class="p">)</span>
    <span class="n">ph_peaks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1"># Compute a correction function at each line in ph_peaks</span>
    <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">median_phase</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">kernel_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kernel_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ph_peaks</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">ph_peaks</span><span class="p">:</span>
        <span class="n">nextcorr</span><span class="p">,</span> <span class="n">mphase</span> <span class="o">=</span> <span class="n">_phasecorr_find_alignment</span><span class="p">(</span>
            <span class="n">phase</span><span class="p">,</span> <span class="n">pheight</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="mf">0.012</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ph_peaks</span><span class="p">),</span> <span class="n">method2017</span><span class="o">=</span><span class="n">method2017</span><span class="p">,</span> <span class="n">kernel_width</span><span class="o">=</span><span class="n">kernel_width</span>
        <span class="p">)</span>
        <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextcorr</span><span class="p">)</span>
        <span class="n">median_phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mphase</span><span class="p">)</span>

    <span class="n">NC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">NC</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">phase_uniformifier_x</span> <span class="o">=</span> <span class="n">ph_peaks</span>
        <span class="n">phase_uniformifier_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">median_phase</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Too few peaks to spline, so just bin and take the median per bin, then</span>
        <span class="c1"># interpolated (approximating) spline through/near these points.</span>
        <span class="n">NBINS</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pheight</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pheight</span><span class="p">,</span> <span class="mi">98</span><span class="p">))</span>
        <span class="nb">bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">pheight</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">NBINS</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBINS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBINS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBINS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBINS</span><span class="p">):</span>
            <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bin</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pheight</span><span class="p">[</span><span class="nb">bin</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="nb">bin</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>

        <span class="n">nonempty</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># Use sp.interpolate.UnivariateSpline because it can make an approximating</span>
        <span class="c1"># spline. But then use its x/y data and knots to create a Mass CubicSpline,</span>
        <span class="c1"># because that one can have natural boundary conditions instead of insane</span>
        <span class="c1"># cubic functions in the extrapolation.</span>
        <span class="k">if</span> <span class="n">nonempty</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">spline_order</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nonempty</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">crazy_spline</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">nonempty</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">nonempty</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="n">nonempty</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">12</span><span class="o">**-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">spline_order</span><span class="p">)</span>
            <span class="n">phase_uniformifier_x</span> <span class="o">=</span> <span class="n">crazy_spline</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">phase_uniformifier_y</span> <span class="o">=</span> <span class="n">crazy_spline</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase_uniformifier_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">phase_uniformifier_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">PhaseCorrector</span><span class="p">(</span><span class="n">phase_uniformifier_x</span><span class="p">,</span> <span class="n">phase_uniformifier_y</span><span class="p">,</span> <span class="n">corrections</span><span class="p">,</span> <span class="n">indicatorName</span><span class="p">,</span> <span class="n">uncorrectedName</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.phase_correct_steps"></a>
<div class="doc doc-contents first">
<p>Phase correction step, Mass-style.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.phase_correct_steps.PhaseCorrectMassStep">
<code>PhaseCorrectMassStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>Perform a Mass-style phase correction step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PhaseCorrectMassStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Perform a Mass-style phase correction step."""</span>

    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">line_energies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">previous_step_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">phase_corrector</span><span class="p">:</span> <span class="n">PhaseCorrector</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the phase-corrected pulse height and return a new DataFrame."""</span>
        <span class="c1"># since we only need to load two columns I'm assuming we can fit them in memory and just</span>
        <span class="c1"># loading them whole</span>
        <span class="c1"># if it becomes an issues, use iter_slices or</span>
        <span class="c1"># add a user defined funciton in rust</span>
        <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
        <span class="n">corrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">uncorrected_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_corrector</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">corrected_col</span><span class="p">,</span> <span class="n">corrected</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a diagnostic plot of the phase correction."""</span>
        <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="n">df_after</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span> <span class="n">df_small</span><span class="p">[</span><span class="n">uncorrected_col</span><span class="p">])</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span>
            <span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span>
            <span class="n">df_small</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct_steps.PhaseCorrectMassStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the phase-corrected pulse height and return a new DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the phase-corrected pulse height and return a new DataFrame."""</span>
    <span class="c1"># since we only need to load two columns I'm assuming we can fit them in memory and just</span>
    <span class="c1"># loading them whole</span>
    <span class="c1"># if it becomes an issues, use iter_slices or</span>
    <span class="c1"># add a user defined funciton in rust</span>
    <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
    <span class="n">corrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">uncorrected_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_corrector</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">)</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">corrected_col</span><span class="p">,</span> <span class="n">corrected</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.phase_correct_steps.PhaseCorrectMassStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a diagnostic plot of the phase correction.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a diagnostic plot of the phase correction."""</span>
    <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="n">df_after</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span> <span class="n">df_small</span><span class="p">[</span><span class="n">uncorrected_col</span><span class="p">])</span>
    <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_a_vs_b_series</span><span class="p">(</span>
        <span class="n">df_small</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">],</span>
        <span class="n">df_small</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.phase_correct_steps.phase_correct_mass_specific_lines">
<code class="highlight language-python"><span class="n">phase_correct_mass_specific_lines</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">,</span> <span class="n">corrected_col</span><span class="p">,</span> <span class="n">previous_step_index</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Perform a Mass-style phase correction step using specific lines.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/phase_correct_steps.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">phase_correct_mass_specific_lines</span><span class="p">(</span>
    <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
    <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">previous_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PhaseCorrectMassStep</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Perform a Mass-style phase correction step using specific lines."""</span>
    <span class="n">previous_step</span><span class="p">,</span> <span class="n">previous_step_index</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">get_step</span><span class="p">(</span><span class="n">previous_step_index</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">previous_step</span><span class="p">,</span> <span class="s2">"energy2ph"</span><span class="p">)</span>
    <span class="p">(</span><span class="n">line_names</span><span class="p">,</span> <span class="n">line_energies</span><span class="p">)</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">line_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">previous_step</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">line_energy</span><span class="p">)</span> <span class="k">for</span> <span class="n">line_energy</span> <span class="ow">in</span> <span class="n">line_energies</span><span class="p">]</span>
    <span class="p">[</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_serieses</span><span class="p">([</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">],</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="n">phase_corrector</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">phase_correct</span><span class="o">.</span><span class="n">phase_correct</span><span class="p">(</span>
        <span class="n">indicator</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">uncorrected</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">line_positions</span><span class="p">,</span>
        <span class="n">indicatorName</span><span class="o">=</span><span class="n">indicator_col</span><span class="p">,</span>
        <span class="n">uncorrectedName</span><span class="o">=</span><span class="n">uncorrected_col</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">PhaseCorrectMassStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">indicator_col</span><span class="p">,</span> <span class="n">uncorrected_col</span><span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">corrected_col</span><span class="p">],</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="n">line_names</span><span class="o">=</span><span class="n">line_names</span><span class="p">,</span>
        <span class="n">line_energies</span><span class="o">=</span><span class="n">line_energies</span><span class="p">,</span>
        <span class="n">previous_step_index</span><span class="o">=</span><span class="n">previous_step_index</span><span class="p">,</span>
        <span class="n">phase_corrector</span><span class="o">=</span><span class="n">phase_corrector</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.pulse_algorithms"></a>
<div class="doc doc-contents first">
<p>Pulse summarizing algorithms.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.pulse_algorithms.fit_pulse_2exp_with_tail">
<code class="highlight language-python"><span class="n">fit_pulse_2exp_with_tail</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">guess_tau</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Fit a pulse shape to data using two exponentials plus an exponential tail.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_pulse_2exp_with_tail</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">guess_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Fit a pulse shape to data using two exponentials plus an exponential tail."""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">guess_tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">guess_tau</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">pulse_2exp_with_tail</span><span class="p">)</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
        <span class="n">t0</span><span class="o">=</span><span class="n">npre</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span>
        <span class="n">a_tail</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">,</span>
        <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
        <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">,</span>
        <span class="n">tau_tail</span><span class="o">=</span><span class="n">guess_tau</span><span class="p">,</span>
        <span class="n">tau_rise</span><span class="o">=</span><span class="n">guess_tau</span><span class="p">,</span>
        <span class="n">tau_fall_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"a_tail"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"a"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"tau_tail"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"tau_rise"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">"tau_fall_factor"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"tau_fall"</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s2">"tau_rise*tau_fall_factor"</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.pulse_algorithms.pulse_2exp_with_tail">
<code class="highlight language-python"><span class="n">pulse_2exp_with_tail</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">a_tail</span><span class="p">,</span> <span class="n">tau_tail</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">tau_rise</span><span class="p">,</span> <span class="n">tau_fall_factor</span><span class="p">,</span> <span class="n">baseline</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Create a pulse shape from two exponentials plus an exponential tail.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pulse_2exp_with_tail</span><span class="p">(</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">a_tail</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tau_tail</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tau_rise</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tau_fall_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">baseline</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a pulse shape from two exponentials plus an exponential tail."""</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">tau_fall</span> <span class="o">=</span> <span class="n">tau_rise</span> <span class="o">*</span> <span class="n">tau_fall_factor</span>
    <span class="k">assert</span> <span class="n">tau_fall_factor</span> <span class="o">&gt;=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">tau_fall_factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># location of peak</span>
        <span class="n">t_peak</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau_rise</span> <span class="o">*</span> <span class="n">tau_fall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau_fall</span> <span class="o">-</span> <span class="n">tau_rise</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tau_fall</span> <span class="o">/</span> <span class="n">tau_rise</span><span class="p">)</span>
        <span class="c1"># value at peak</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t_peak</span> <span class="o">/</span> <span class="n">tau_fall</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t_peak</span> <span class="o">/</span> <span class="n">tau_rise</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># tau_fall == tau_rise</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">a_tail</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tt</span> <span class="o">/</span> <span class="n">tau_tail</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">tau_tail</span><span class="p">)</span>  <span class="c1"># normalized tail</span>
        <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tt</span> <span class="o">/</span> <span class="n">tau_fall</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tt</span> <span class="o">/</span> <span class="n">tau_rise</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_val</span>
        <span class="o">+</span> <span class="n">baseline</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.pulse_algorithms.summarize_data_numba">
<code class="highlight language-python"><span class="n">summarize_data_numba</span><span class="p">(</span><span class="n">rawdata</span><span class="p">,</span> <span class="n">timebase</span><span class="p">,</span> <span class="n">peak_samplenumber</span><span class="p">,</span> <span class="n">pretrigger_ignore_samples</span><span class="p">,</span> <span class="n">nPresamples</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Summarize one segment of the data file, loading it into cache.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">summarize_data_numba</span><span class="p">(</span>  <span class="c1"># noqa: PLR0914</span>
    <span class="n">rawdata</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">],</span>
    <span class="n">timebase</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">peak_samplenumber</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pretrigger_ignore_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nPresamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResultArrayType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Summarize one segment of the data file, loading it into cache."""</span>
    <span class="n">nPulses</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nSamples</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">e_nPresamples</span> <span class="o">=</span> <span class="n">nPresamples</span> <span class="o">-</span> <span class="n">pretrigger_ignore_samples</span>

    <span class="c1"># Create the structured array for results</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">result_dtype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPulses</span><span class="p">):</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="n">rawdata</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">pretrig_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pretrig_rms_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pulse_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pulse_rms_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">promptness_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">peak_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">peak_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
        <span class="n">s_prompt</span> <span class="o">=</span> <span class="n">nPresamples</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">e_prompt</span> <span class="o">=</span> <span class="n">nPresamples</span> <span class="o">+</span> <span class="mi">8</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nSamples</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">signal</span> <span class="o">&gt;</span> <span class="n">peak_value</span><span class="p">:</span>
                <span class="n">peak_value</span> <span class="o">=</span> <span class="n">signal</span>
                <span class="n">peak_index</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">min_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_value</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">e_nPresamples</span><span class="p">:</span>
                <span class="n">pretrig_sum</span> <span class="o">+=</span> <span class="n">signal</span>
                <span class="n">pretrig_rms_sum</span> <span class="o">+=</span> <span class="n">signal</span><span class="o">**</span><span class="mi">2</span>

            <span class="k">if</span> <span class="n">s_prompt</span> <span class="o">&lt;=</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">e_prompt</span><span class="p">:</span>
                <span class="n">promptness_sum</span> <span class="o">+=</span> <span class="n">signal</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">nPresamples</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ptm</span> <span class="o">=</span> <span class="n">pretrig_sum</span> <span class="o">/</span> <span class="n">e_nPresamples</span>
                <span class="n">ptrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pretrig_rms_sum</span> <span class="o">/</span> <span class="n">e_nPresamples</span> <span class="o">-</span> <span class="n">ptm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">signal</span> <span class="o">-</span> <span class="n">ptm</span> <span class="o">&gt;</span> <span class="mf">4.3</span> <span class="o">*</span> <span class="n">ptrms</span><span class="p">:</span>
                    <span class="n">e_prompt</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">s_prompt</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">"shift1"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">"shift1"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">nPresamples</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pulse_sum</span> <span class="o">+=</span> <span class="n">signal</span>
                <span class="n">pulse_rms_sum</span> <span class="o">+=</span> <span class="n">signal</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">results</span><span class="p">[</span><span class="s2">"pretrig_mean"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptm</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">"pretrig_rms"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptrms</span>
        <span class="k">if</span> <span class="n">ptm</span> <span class="o">&lt;</span> <span class="n">peak_value</span><span class="p">:</span>
            <span class="n">peak_value</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ptm</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"promptness"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">promptness_sum</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="o">-</span> <span class="n">ptm</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak_value</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"peak_value"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_value</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"peak_index"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"promptness"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"peak_value"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"peak_index"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">"min_value"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_value</span>
        <span class="n">pulse_avg</span> <span class="o">=</span> <span class="n">pulse_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">nSamples</span> <span class="o">-</span> <span class="n">nPresamples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">ptm</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">"pulse_average"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pulse_avg</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">"pulse_rms"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pulse_rms_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">nSamples</span> <span class="o">-</span> <span class="n">nPresamples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">ptm</span> <span class="o">*</span> <span class="n">pulse_avg</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ptm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">low_th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">peak_value</span> <span class="o">+</span> <span class="n">ptm</span><span class="p">)</span>
        <span class="n">high_th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">peak_value</span> <span class="o">+</span> <span class="n">ptm</span><span class="p">)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">nPresamples</span>
        <span class="n">low_value</span> <span class="o">=</span> <span class="n">high_value</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nSamples</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">&gt;</span> <span class="n">low_th</span><span class="p">:</span>
                <span class="n">low_idx</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">low_value</span> <span class="o">=</span> <span class="n">signal</span>
                <span class="k">break</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">high_value</span> <span class="o">=</span> <span class="n">low_value</span>
        <span class="n">high_idx</span> <span class="o">=</span> <span class="n">low_idx</span>

        <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nSamples</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">&gt;</span> <span class="n">high_th</span><span class="p">:</span>
                <span class="n">high_idx</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">high_value</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">high_idx</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">high_value</span> <span class="o">&gt;</span> <span class="n">low_value</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"rise_time"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">timebase</span> <span class="o">*</span> <span class="p">(</span><span class="n">high_idx</span> <span class="o">-</span> <span class="n">low_idx</span><span class="p">)</span> <span class="o">*</span> <span class="n">peak_value</span> <span class="o">/</span> <span class="p">(</span><span class="n">high_value</span> <span class="o">-</span> <span class="n">low_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"rise_time"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">timebase</span>

        <span class="c1"># The following is quite confusing, but it appears to be equivalent to</span>
        <span class="c1"># slope = -2 * pulse[peak_samplenumber:-4]</span>
        <span class="c1"># slope -= pulse[peak_samplenumber+1:-3]</span>
        <span class="c1"># slope += pulse[peak_samplenumber+3:-1]</span>
        <span class="c1"># slope += 2*pulse[peak_samplenumber+4:]</span>
        <span class="c1"># slope = np.minimum(slope[2:], slope[:-2])</span>
        <span class="c1"># results["postpeak_deriv"][j] = 0.1 * np.max(slope)</span>
        <span class="c1"># TODO: consider replacing, if the above is not slower?</span>

        <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pulse</span><span class="p">[</span><span class="n">peak_samplenumber</span><span class="p">],</span>
            <span class="n">pulse</span><span class="p">[</span><span class="n">peak_samplenumber</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">pulse</span><span class="p">[</span><span class="n">peak_samplenumber</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">pulse</span><span class="p">[</span><span class="n">peak_samplenumber</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">s4</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">peak_samplenumber</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">s0</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">s3</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">s4</span>
        <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s4</span>
        <span class="n">s4</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">peak_samplenumber</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">s0</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">s3</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">s4</span>
        <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">peak_samplenumber</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">nSamples</span><span class="p">):</span>
            <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s4</span>
            <span class="n">s4</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">s0</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">s3</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">s4</span>

            <span class="n">t3</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
            <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_max_deriv</span><span class="p">,</span> <span class="n">t3</span><span class="p">)</span>

            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

        <span class="n">results</span><span class="p">[</span><span class="s2">"postpeak_deriv"</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">t_max_deriv</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.pulse_model"></a>
<div class="doc doc-contents first">
<p>Pulse model object, to hold a low-dimensional linear basis able to express all normal pulses,</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.pulse_model.PulseModel">
<code>PulseModel</code>
</h2>
<div class="doc doc-contents">
<p>Object to hold a "pulse model", meaning a low-dimensional linear basis to express "all" pulses,
along with a projector such that projector.dot(basis) is the identity matrix.</p>
<p>Also has the capacity to store to and restore from HDF5, and the ability to compute additional
basis elements and corresponding projectors with method _additional_projectors_tsvd</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_model.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PulseModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Object to hold a "pulse model", meaning a low-dimensional linear basis to express "all" pulses,</span>
<span class="sd">    along with a projector such that projector.dot(basis) is the identity matrix.</span>

<span class="sd">    Also has the capacity to store to and restore from HDF5, and the ability to compute additional</span>
<span class="sd">    basis elements and corresponding projectors with method _additional_projectors_tsvd"""</span>

    <span class="n">version</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">projectors_so_far</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">basis_so_far</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">n_basis</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pulses_for_svd</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">v_dv</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">pretrig_rms_median</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">pretrig_rms_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">extra_n_basis_5lag</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">f_5lag</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">average_pulse_for_5lag</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">noise_psd</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">noise_psd_delta_f</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">noise_autocorr</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">_from_hdf5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span> <span class="o">=</span> <span class="n">pulses_for_svd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">=</span> <span class="n">n_basis</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">n_basis</span> <span class="o">-</span> <span class="n">extra_n_basis_5lag</span>
        <span class="k">if</span> <span class="n">projectors_so_far</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_projectors_tsvd</span><span class="p">(</span><span class="n">projectors_so_far</span><span class="p">,</span> <span class="n">basis_so_far</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">pulses_for_svd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">projectors_so_far</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dn</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_from_hdf5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">projectors_so_far</span><span class="p">,</span> <span class="n">basis_so_far</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># don't throw error on</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"n_basis-extra_n_basis_5lag=</span><span class="si">{</span><span class="n">dn</span><span class="si">}</span><span class="s2"> &lt; projectors_so_far.shape[0] = </span><span class="si">{</span><span class="n">projectors_so_far</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">", extra_n_basis_5lag=</span><span class="si">{</span><span class="n">extra_n_basis_5lag</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_from_hdf5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extra_n_basis_5lag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">filters_5lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">f_5lag</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">filters_5lag</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">projectors_so_far</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filters_5lag</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">projectors_so_far</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_projectors_tsvd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="n">n_basis</span><span class="p">,</span> <span class="n">filters_5lag</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v_dv</span> <span class="o">=</span> <span class="n">v_dv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrig_rms_median</span> <span class="o">=</span> <span class="n">pretrig_rms_median</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrig_rms_sigma</span> <span class="o">=</span> <span class="n">pretrig_rms_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span> <span class="o">=</span> <span class="n">extra_n_basis_5lag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_5lag</span> <span class="o">=</span> <span class="n">f_5lag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_pulse_for_5lag</span> <span class="o">=</span> <span class="n">average_pulse_for_5lag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span> <span class="o">=</span> <span class="n">noise_psd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd_delta_f</span> <span class="o">=</span> <span class="n">noise_psd_delta_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">noise_autocorr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">toHDF5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">save_inverted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Save the pulse model to an HDF5 group."""</span>
        <span class="n">projectors</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">[()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[()]</span>
        <span class="k">if</span> <span class="n">save_inverted</span><span class="p">:</span>
            <span class="c1"># flip every component except the mean component if data is being inverted</span>
            <span class="n">basis</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">projectors</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># projectors is MxN, where N is samples/record and M the number of basis elements</span>
        <span class="c1"># basis is NxM</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/projectors"</span><span class="p">]</span> <span class="o">=</span> <span class="n">projectors</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/basis"</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/v_dv"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_dv</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/training_pulses_for_plots"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/was_saved_inverted"</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_inverted</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_median"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrig_rms_median</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_sigma"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrig_rms_sigma</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/version"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/file_name"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/extra_n_basis_5lag"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/5lag_filter"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_5lag</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/average_pulse_for_5lag"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_pulse_for_5lag</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd_delta_f"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd_delta_f</span>
        <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_autocorr"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromHDF5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"PulseModel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Restore a pulse model from an HDF5 group."""</span>
        <span class="n">projectors</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/projectors"</span><span class="p">][()]</span>
        <span class="n">n_basis</span> <span class="o">=</span> <span class="n">projectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/basis"</span><span class="p">][()]</span>
        <span class="n">v_dv</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/v_dv"</span><span class="p">][()]</span>
        <span class="n">pulses_for_svd</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/training_pulses_for_plots"</span><span class="p">][()]</span>
        <span class="n">pretrig_rms_median</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_median"</span><span class="p">][()]</span>
        <span class="n">pretrig_rms_sigma</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_sigma"</span><span class="p">][()]</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/version"</span><span class="p">][()]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/file_name"</span><span class="p">][()])</span>
        <span class="n">extra_n_basis_5lag</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/extra_n_basis_5lag"</span><span class="p">][()]</span>
        <span class="n">f_5lag</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/5lag_filter"</span><span class="p">][()]</span>
        <span class="n">average_pulse_for_5lag</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/average_pulse_for_5lag"</span><span class="p">][()]</span>
        <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd"</span><span class="p">][()]</span>
        <span class="n">noise_psd_delta_f</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd_delta_f"</span><span class="p">][()]</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_autocorr"</span><span class="p">][()]</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"loading not implemented for other versions, version=</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">projectors</span><span class="p">,</span>
            <span class="n">basis</span><span class="p">,</span>
            <span class="n">n_basis</span><span class="p">,</span>
            <span class="n">pulses_for_svd</span><span class="p">,</span>
            <span class="n">v_dv</span><span class="p">,</span>
            <span class="n">pretrig_rms_median</span><span class="p">,</span>
            <span class="n">pretrig_rms_sigma</span><span class="p">,</span>
            <span class="n">file_name</span><span class="p">,</span>
            <span class="n">extra_n_basis_5lag</span><span class="p">,</span>
            <span class="n">f_5lag</span><span class="p">,</span>
            <span class="n">average_pulse_for_5lag</span><span class="p">,</span>
            <span class="n">noise_psd</span><span class="p">,</span>
            <span class="n">noise_psd_delta_f</span><span class="p">,</span>
            <span class="n">noise_autocorr</span><span class="p">,</span>
            <span class="n">_from_hdf5</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_additional_projectors_tsvd</span><span class="p">(</span>
        <span class="n">projectors</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">n_basis</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pulses_for_svd</span><span class="p">:</span> <span class="n">NDArray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given an existing basis with projectors, compute a basis with n_basis elements</span>
<span class="sd">        by randomized SVD of the residual elements of the training data in pulses_for_svd.</span>
<span class="sd">        It should be the case that projectors.dot(basis) is approximately the identity matrix.</span>

<span class="sd">        It is assumed that the projectors will have been computed from the basis in some</span>
<span class="sd">        noise-optimal way, say, from optimal filtering. However, the additional basis elements</span>
<span class="sd">        will be computed from a standard (non-noise-weighted) SVD, and the additional projectors</span>
<span class="sd">        will be computed without noise optimization.</span>

<span class="sd">        The projectors and basis will be ordered as:</span>
<span class="sd">        mean, deriv_ike, pulse_like, any svd components...</span>
<span class="sd">        """</span>
        <span class="c1"># Check sanity of inputs</span>
        <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_existing</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">n_existing</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span> <span class="o">==</span> <span class="n">projectors</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">n_basis</span> <span class="o">&gt;=</span> <span class="n">n_existing</span>

        <span class="k">if</span> <span class="n">n_basis</span> <span class="o">==</span> <span class="n">n_existing</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">projectors</span><span class="p">,</span> <span class="n">basis</span>

        <span class="n">mpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">projectors</span><span class="p">,</span> <span class="n">pulses_for_svd</span><span class="p">)</span>  <span class="c1"># modeled pulse coefs</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">mpc</span><span class="p">)</span>  <span class="c1"># modeled pulse</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">pulses_for_svd</span> <span class="o">-</span> <span class="n">mp</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">mathstat</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">find_range_randomly</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">n_basis</span> <span class="o">-</span> <span class="n">n_existing</span><span class="p">)</span>

        <span class="n">projectors2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>  <span class="c1"># = Q.T, perhaps??</span>
        <span class="n">projectors2</span> <span class="o">-=</span> <span class="n">projectors2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">projectors</span><span class="p">)</span>

        <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">basis</span><span class="p">,</span> <span class="n">Q</span><span class="p">])</span>
        <span class="n">projectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">projectors</span><span class="p">,</span> <span class="n">projectors2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">projectors</span><span class="p">,</span> <span class="n">basis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return a list of labels for the basis elements."""</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"const"</span><span class="p">,</span> <span class="s2">"deriv"</span><span class="p">,</span> <span class="s2">"pulse"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"5lag</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"svd</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">labels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig1</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fig2</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot a pulse model"""</span>
        <span class="c1"># plots information about a pulse model</span>
        <span class="c1"># fig1 and fig2 are optional matplotlib.pyplot (plt) figures if you need to embed the plots.</span>
        <span class="c1"># you can pass in the reference like fig=plt.figure() call or the figure's number, e.g. fig.number</span>
        <span class="c1">#   fig1 has modeled pulse vs true pulse</span>
        <span class="c1">#   fig2 has projectors, basis, "from ljh", residuals, and a measure of "wrongness"</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span>
        <span class="n">mpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="n">mpc</span><span class="p">)</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span> <span class="o">-</span> <span class="n">mp</span>

        <span class="k">if</span> <span class="n">fig1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">511</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"projectors"</span><span class="p">)</span>
        <span class="c1"># projector_scale = np.amax(np.abs(self.projectors[2, :]))</span>
        <span class="c1"># plt.ylim(-2*projector_scale, 2*projector_scale)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"basis"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">513</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"from ljh"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">514</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">residuals</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"residuals"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">should_be_identity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span><span class="p">)</span>
        <span class="n">wrongness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">should_be_identity</span> <span class="o">-</span> <span class="n">identity</span><span class="p">)</span>
        <span class="n">wrongness</span><span class="p">[</span><span class="n">wrongness</span> <span class="o">&lt;</span> <span class="mf">1e-20</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-20</span>  <span class="c1"># avoid warnings</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">515</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wrongness</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"log10(abs(projectors*basis-identity))"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fig2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"from ljh index 0"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"modeled pulse index 0"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"modeled pulse vs true pulse"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.pulse_model.PulseModel.fromHDF5">
<code class="highlight language-python"><span class="n">fromHDF5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Restore a pulse model from an HDF5 group.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_model.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fromHDF5</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"PulseModel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Restore a pulse model from an HDF5 group."""</span>
    <span class="n">projectors</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/projectors"</span><span class="p">][()]</span>
    <span class="n">n_basis</span> <span class="o">=</span> <span class="n">projectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/basis"</span><span class="p">][()]</span>
    <span class="n">v_dv</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/v_dv"</span><span class="p">][()]</span>
    <span class="n">pulses_for_svd</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/training_pulses_for_plots"</span><span class="p">][()]</span>
    <span class="n">pretrig_rms_median</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_median"</span><span class="p">][()]</span>
    <span class="n">pretrig_rms_sigma</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_sigma"</span><span class="p">][()]</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/version"</span><span class="p">][()]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">tostr</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/file_name"</span><span class="p">][()])</span>
    <span class="n">extra_n_basis_5lag</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/extra_n_basis_5lag"</span><span class="p">][()]</span>
    <span class="n">f_5lag</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/5lag_filter"</span><span class="p">][()]</span>
    <span class="n">average_pulse_for_5lag</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/average_pulse_for_5lag"</span><span class="p">][()]</span>
    <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd"</span><span class="p">][()]</span>
    <span class="n">noise_psd_delta_f</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd_delta_f"</span><span class="p">][()]</span>
    <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_autocorr"</span><span class="p">][()]</span>

    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"loading not implemented for other versions, version=</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">projectors</span><span class="p">,</span>
        <span class="n">basis</span><span class="p">,</span>
        <span class="n">n_basis</span><span class="p">,</span>
        <span class="n">pulses_for_svd</span><span class="p">,</span>
        <span class="n">v_dv</span><span class="p">,</span>
        <span class="n">pretrig_rms_median</span><span class="p">,</span>
        <span class="n">pretrig_rms_sigma</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">,</span>
        <span class="n">extra_n_basis_5lag</span><span class="p">,</span>
        <span class="n">f_5lag</span><span class="p">,</span>
        <span class="n">average_pulse_for_5lag</span><span class="p">,</span>
        <span class="n">noise_psd</span><span class="p">,</span>
        <span class="n">noise_psd_delta_f</span><span class="p">,</span>
        <span class="n">noise_autocorr</span><span class="p">,</span>
        <span class="n">_from_hdf5</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.pulse_model.PulseModel.labels">
<code class="highlight language-python"><span class="n">labels</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a list of labels for the basis elements.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_model.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return a list of labels for the basis elements."""</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"const"</span><span class="p">,</span> <span class="s2">"deriv"</span><span class="p">,</span> <span class="s2">"pulse"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"5lag</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"svd</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">labels</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.pulse_model.PulseModel.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">fig1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig2</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot a pulse model</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_model.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig1</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fig2</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot a pulse model"""</span>
    <span class="c1"># plots information about a pulse model</span>
    <span class="c1"># fig1 and fig2 are optional matplotlib.pyplot (plt) figures if you need to embed the plots.</span>
    <span class="c1"># you can pass in the reference like fig=plt.figure() call or the figure's number, e.g. fig.number</span>
    <span class="c1">#   fig1 has modeled pulse vs true pulse</span>
    <span class="c1">#   fig2 has projectors, basis, "from ljh", residuals, and a measure of "wrongness"</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span>
    <span class="n">mpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span><span class="p">)</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="n">mpc</span><span class="p">)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span> <span class="o">-</span> <span class="n">mp</span>

    <span class="k">if</span> <span class="n">fig1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">511</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"projectors"</span><span class="p">)</span>
    <span class="c1"># projector_scale = np.amax(np.abs(self.projectors[2, :]))</span>
    <span class="c1"># plt.ylim(-2*projector_scale, 2*projector_scale)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"basis"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">513</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"from ljh"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">514</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">residuals</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"residuals"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">should_be_identity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span><span class="p">)</span>
    <span class="n">wrongness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">should_be_identity</span> <span class="o">-</span> <span class="n">identity</span><span class="p">)</span>
    <span class="n">wrongness</span><span class="p">[</span><span class="n">wrongness</span> <span class="o">&lt;</span> <span class="mf">1e-20</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-20</span>  <span class="c1"># avoid warnings</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">515</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">wrongness</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"log10(abs(projectors*basis-identity))"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fig2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"from ljh index 0"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"modeled pulse index 0"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"modeled pulse vs true pulse"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.pulse_model.PulseModel.toHDF5">
<code class="highlight language-python"><span class="n">toHDF5</span><span class="p">(</span><span class="n">hdf5_group</span><span class="p">,</span> <span class="n">save_inverted</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Save the pulse model to an HDF5 group.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/pulse_model.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">toHDF5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">save_inverted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Save the pulse model to an HDF5 group."""</span>
    <span class="n">projectors</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectors</span><span class="p">[()],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">[()]</span>
    <span class="k">if</span> <span class="n">save_inverted</span><span class="p">:</span>
        <span class="c1"># flip every component except the mean component if data is being inverted</span>
        <span class="n">basis</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">projectors</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># projectors is MxN, where N is samples/record and M the number of basis elements</span>
    <span class="c1"># basis is NxM</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/projectors"</span><span class="p">]</span> <span class="o">=</span> <span class="n">projectors</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/basis"</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/v_dv"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_dv</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/training_pulses_for_plots"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulses_for_svd</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/was_saved_inverted"</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_inverted</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_median"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrig_rms_median</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/pretrig_rms_sigma"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrig_rms_sigma</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/version"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/file_name"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/extra_n_basis_5lag"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_n_basis_5lag</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/5lag_filter"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_5lag</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/average_pulse_for_5lag"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_pulse_for_5lag</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_psd_delta_f"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd_delta_f</span>
    <span class="n">hdf5_group</span><span class="p">[</span><span class="s2">"svdbasis/noise_autocorr"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.recipe"></a>
<div class="doc doc-contents first">
<p>Define RecipeStep and Recipe classes for processing pulse data in a sequence of steps.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.CategorizeStep">
<code>CategorizeStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A step to categorize pulses into discrete categories based on conditions given in a dictionary mapping
category names to polars expressions. The first condition must be True, to be used as a fallback.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CategorizeStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A step to categorize pulses into discrete categories based on conditions given in a dictionary mapping</span>
<span class="sd">    category names to polars expressions. The first condition must be True, to be used as a fallback."""</span>

    <span class="n">category_condition_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Verify that the first condition is always True."""</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">"The first condition must be True, to be used as a fallback"</span>
        <span class="n">first_condition</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="n">first_condition</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">first_condition</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)),</span> <span class="n">err_msg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the category for each pulse and return a new DataFrame with a column for the category names."""</span>
        <span class="n">output_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">categorize_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">category_condition_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">],</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""returns a series showing which category each pulse is in</span>
<span class="sd">            pulses will be assigned to the last category for which the condition evaluates to True"""</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">physical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">category_int</span><span class="p">,</span> <span class="p">(</span><span class="n">category_str</span><span class="p">,</span> <span class="n">condition_expr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">condition_expr</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">condition_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
                    <span class="n">in_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">in_category</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">condition_expr</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">in_category</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span>
                <span class="n">physical</span><span class="p">[</span><span class="n">in_category</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_int</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">output_col</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">physical</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">output_col</span><span class="p">:</span> <span class="n">series</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">categorize_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_condition_dict</span><span class="p">,</span> <span class="n">output_col</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.CategorizeStep.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Verify that the first condition is always True.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Verify that the first condition is always True."""</span>
    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">"The first condition must be True, to be used as a fallback"</span>
    <span class="n">first_condition</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">assert</span> <span class="n">first_condition</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">first_condition</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)),</span> <span class="n">err_msg</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.CategorizeStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the category for each pulse and return a new DataFrame with a column for the category names.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the category for each pulse and return a new DataFrame with a column for the category names."""</span>
    <span class="n">output_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">categorize_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">category_condition_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">],</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""returns a series showing which category each pulse is in</span>
<span class="sd">        pulses will be assigned to the last category for which the condition evaluates to True"""</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">physical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">category_int</span><span class="p">,</span> <span class="p">(</span><span class="n">category_str</span><span class="p">,</span> <span class="n">condition_expr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">condition_expr</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">condition_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
                <span class="n">in_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">in_category</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">condition_expr</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">in_category</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span>
            <span class="n">physical</span><span class="p">[</span><span class="n">in_category</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_int</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">output_col</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">physical</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">output_col</span><span class="p">:</span> <span class="n">series</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">df2</span> <span class="o">=</span> <span class="n">categorize_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_condition_dict</span><span class="p">,</span> <span class="n">output_col</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.ColumnAsNumpyMapStep">
<code>ColumnAsNumpyMapStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>This step is meant for interactive exploration, it takes a column and applies a function to it,
and makes a new column with the result. It makes it easy to test functions on a column without
having to write a whole new step class,
while maintaining the benefit of being able to use the step in a Recipe chain, like replaying steps
on another channel.</p>
<p>example usage:</p>
<blockquote>
<blockquote>
<blockquote>
<p>def my_function(x):
...     return x * 2
step = ColumnAsNumpyMapStep(inputs=["my_column"], output=["my_new_column"], f=my_function)
ch2 = ch.with_step(step)</p>
</blockquote>
</blockquote>
</blockquote>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ColumnAsNumpyMapStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This step is meant for interactive exploration, it takes a column and applies a function to it,</span>
<span class="sd">    and makes a new column with the result. It makes it easy to test functions on a column without</span>
<span class="sd">    having to write a whole new step class,</span>
<span class="sd">    while maintaining the benefit of being able to use the step in a Recipe chain, like replaying steps</span>
<span class="sd">    on another channel.</span>

<span class="sd">    example usage:</span>
<span class="sd">    &gt;&gt;&gt; def my_function(x):</span>
<span class="sd">    ...     return x * 2</span>
<span class="sd">    &gt;&gt;&gt; step = ColumnAsNumpyMapStep(inputs=["my_column"], output=["my_new_column"], f=my_function)</span>
<span class="sd">    &gt;&gt;&gt; ch2 = ch.with_step(step)</span>
<span class="sd">    """</span>

    <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Check that inputs and outputs are valid (single column each) and that `f` is a callable object."""</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ColumnMapStep expects exactly one input"</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ColumnMapStep expects exactly one output"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"f must be a callable, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the new column by applying `f` to the input column, returning a new DataFrame."""</span>
        <span class="n">output_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">():</span>
            <span class="n">series1</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># Have to apply the function differently when series elements are arrays vs scalars</span>
            <span class="k">if</span> <span class="n">series1</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_type</span><span class="p">()</span> <span class="ow">is</span> <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
                <span class="n">output_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">series1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_numpy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">series1</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="n">this_output_segment</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span> <span class="n">output_numpy</span><span class="p">)</span>
            <span class="n">output_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_output_segment</span><span class="p">)</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">output_segments</span><span class="p">)</span>
        <span class="c1"># Put into a DataFrame with one column</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">output_col</span><span class="p">:</span> <span class="n">combined</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.ColumnAsNumpyMapStep.__post_init__">
<code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Check that inputs and outputs are valid (single column each) and that <code>f</code> is a callable object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Check that inputs and outputs are valid (single column each) and that `f` is a callable object."""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ColumnMapStep expects exactly one input"</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ColumnMapStep expects exactly one output"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"f must be a callable, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.ColumnAsNumpyMapStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the new column by applying <code>f</code> to the input column, returning a new DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the new column by applying `f` to the input column, returning a new DataFrame."""</span>
    <span class="n">output_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_segments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">():</span>
        <span class="n">series1</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># Have to apply the function differently when series elements are arrays vs scalars</span>
        <span class="k">if</span> <span class="n">series1</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_type</span><span class="p">()</span> <span class="ow">is</span> <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
            <span class="n">output_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">series1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_numpy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">series1</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">this_output_segment</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span> <span class="n">output_numpy</span><span class="p">)</span>
        <span class="n">output_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_output_segment</span><span class="p">)</span>

    <span class="n">combined</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">output_segments</span><span class="p">)</span>
    <span class="c1"># Put into a DataFrame with one column</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">output_col</span><span class="p">:</span> <span class="n">combined</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.PretrigMeanJumpFixStep">
<code>PretrigMeanJumpFixStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A step to fix jumps in the pretrigger mean by unwrapping the phase angle, a periodic quantity.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PretrigMeanJumpFixStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A step to fix jumps in the pretrigger mean by unwrapping the phase angle, a periodic quantity."""</span>

    <span class="n">period</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the jump-corrected pretrigger mean and return a new DataFrame."""</span>
        <span class="n">ptm1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">ptm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">ptm1</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ptm2</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a diagnostic plot of the pretrigger mean before and after the jump fix."""</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">],</span> <span class="n">df_after</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">],</span> <span class="n">df_after</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"pretrig mean"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.PretrigMeanJumpFixStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the jump-corrected pretrigger mean and return a new DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the jump-corrected pretrigger mean and return a new DataFrame."""</span>
    <span class="n">ptm1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">ptm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">ptm1</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ptm2</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.PretrigMeanJumpFixStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a diagnostic plot of the pretrigger mean before and after the jump fix.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a diagnostic plot of the pretrigger mean before and after the jump fix."""</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">],</span> <span class="n">df_after</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">],</span> <span class="n">df_after</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"pretrig mean"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.Recipe">
<code>Recipe</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a>]</code></p>
<p>A sequence of RecipeStep objects to be applied in order to a DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Recipe</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">"""A sequence of RecipeStep objects to be applied in order to a DataFrame."""</span>

    <span class="n">steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]</span>

    <span class="c1"># TODO: leaves many optimizations on the table, but is very simple</span>
    <span class="c1"># 1. we could calculate filt_value_5lag and filt_phase_5lag at the same time</span>
    <span class="c1"># 2. we could calculate intermediate quantities optionally and not materialize all of them</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="s2">"return a dataframe with all the newly calculated info"</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a new empty Recipe."""</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">([])</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecipeStep</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the step at a given index."""</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return the steps at a given slice of indices."""</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecipeStep</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Return the step at the given index, or the steps at a slice of steps."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the number of steps in the recipe."""</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">RecipeStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a new Recipe with the given step added to the end."""</span>
        <span class="c1"># return a new Recipe with the step added, no mutation!</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="p">[</span><span class="n">step</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trim_dead_ends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a new Recipe object with all dead-end steps (and optionally also debug info) removed.</span>

<span class="sd">        The purpose is to replace the fully useful interactive Recipe with a trimmed-down object that can</span>
<span class="sd">        repeat the current steps as a "recipe" without having the extra information from which the recipe</span>
<span class="sd">        was first created. In one test, this method reduced the pickle file's size from 3.4 MB per channel</span>
<span class="sd">        to 30 kB per channel, or a 112x size reduction (with `drop_debug=True`).</span>

<span class="sd">        Dead-end steps are defined as any step that can be omitted without affecting the ability to</span>
<span class="sd">        compute any of the fields given in `required_fields`. The result of this method is to return</span>
<span class="sd">        a Recipe where any step is remove if it does not contribute to computing any of the `required_fields`</span>
<span class="sd">        (i.e., if it is a dead end).</span>

<span class="sd">        Examples of a dead end are typically steps used to prepare a tentative, intermediate calibration function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        required_fields : Iterable[str] | str | None</span>
<span class="sd">            Steps will be preserved if any of their outputs are among `required_fields`, or if their outputs are</span>
<span class="sd">            found recursively among the inputs to any such steps. If a string, treat as a list of that one string.</span>
<span class="sd">            If None, preserve all steps.</span>

<span class="sd">        drop_debug : bool</span>
<span class="sd">            Whether to run `step.drop_debug()` to remove debugging information from the preserved steps.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Recipe</span>
<span class="sd">            A copy of `self`, except that any steps not required to compute any of `required_fields` are omitted.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">required_fields</span><span class="p">]</span>

        <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">required</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># The easiest approach is to traverse the steps from last to first to build our list of required</span>
        <span class="c1"># fields, because necessarily no later step can produce the inputs needed by an earlier step.</span>
        <span class="k">if</span> <span class="n">required_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">required</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_fields_out</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">all_fields_out</span><span class="p">:</span>
                        <span class="n">required</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">all_fields_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">required</span><span class="p">):</span>
            <span class="c1"># If this error ever because a problem, where user _acutally_ wants an empty series of steps</span>
            <span class="c1"># to be a non-err, then add argument `error_on_empty_output=True` to this method.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"trim_dead_ends found no steps to be preserved"</span><span class="p">)</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">required</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">drop_debug</span><span class="p">:</span>
                    <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_debug</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trim_debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a new Recipe object with all debug info removed from each step, but no steps removed.</span>

<span class="sd">        The following are exactly equivalent:</span>
<span class="sd">        &gt;&gt;&gt; recipe2 = recipe.trim_debug_info()</span>
<span class="sd">        &gt;&gt;&gt; recipe2 = recipe.trim_dead_ends(required_fields=None, drop_debug=True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Recipe</span>
<span class="sd">            A copy of `self`, except that `drop_debug()` is called to replace each step with a less-baggage</span>
<span class="sd">            version of that step.</span>
<span class="sd">        """</span>
        <span class="n">slim_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">slim_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">drop_debug</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">slim_steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.__getitem__">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>
</h3>
<div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecipeStep</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]</span>
</code></pre></div> </div>
<div class="doc doc-contents">
<p>Return the step at the given index, or the steps at a slice of steps.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecipeStep</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Return the step at the given index, or the steps at a slice of steps."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.__len__">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the number of steps in the recipe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the number of steps in the recipe."""</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>return a dataframe with all the newly calculated info</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s2">"return a dataframe with all the newly calculated info"</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.new_empty">
<code class="highlight language-python"><span class="n">new_empty</span><span class="p">()</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a new empty Recipe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">new_empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a new empty Recipe."""</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">([])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.trim_dead_ends">
<code class="highlight language-python"><span class="n">trim_dead_ends</span><span class="p">(</span><span class="n">required_fields</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a new Recipe object with all dead-end steps (and optionally also debug info) removed.</p>
<p>The purpose is to replace the fully useful interactive Recipe with a trimmed-down object that can
repeat the current steps as a "recipe" without having the extra information from which the recipe
was first created. In one test, this method reduced the pickle file's size from 3.4 MB per channel
to 30 kB per channel, or a 112x size reduction (with <code>drop_debug=True</code>).</p>
<p>Dead-end steps are defined as any step that can be omitted without affecting the ability to
compute any of the fields given in <code>required_fields</code>. The result of this method is to return
a Recipe where any step is remove if it does not contribute to computing any of the <code>required_fields</code>
(i.e., if it is a dead end).</p>
<p>Examples of a dead end are typically steps used to prepare a tentative, intermediate calibration function.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>required_fields</code></b>
                  (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="str">str</span>] | <span title="str">str</span> | None</code>)
              
              <div class="doc-md-description">
<p>Steps will be preserved if any of their outputs are among <code>required_fields</code>, or if their outputs are
found recursively among the inputs to any such steps. If a string, treat as a list of that one string.
If None, preserve all steps.</p>
</div>
</li>
<li>
<b><code>drop_debug</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              
              <div class="doc-md-description">
<p>Whether to run <code>step.drop_debug()</code> to remove debugging information from the preserved steps.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Recipe


  
      dataclass
   (mass2.core.recipe.Recipe)" href="#mass2.core.recipe.Recipe">Recipe</a></code>
              
              <div class="doc-md-description">
<p>A copy of <code>self</code>, except that any steps not required to compute any of <code>required_fields</code> are omitted.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trim_dead_ends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a new Recipe object with all dead-end steps (and optionally also debug info) removed.</span>

<span class="sd">    The purpose is to replace the fully useful interactive Recipe with a trimmed-down object that can</span>
<span class="sd">    repeat the current steps as a "recipe" without having the extra information from which the recipe</span>
<span class="sd">    was first created. In one test, this method reduced the pickle file's size from 3.4 MB per channel</span>
<span class="sd">    to 30 kB per channel, or a 112x size reduction (with `drop_debug=True`).</span>

<span class="sd">    Dead-end steps are defined as any step that can be omitted without affecting the ability to</span>
<span class="sd">    compute any of the fields given in `required_fields`. The result of this method is to return</span>
<span class="sd">    a Recipe where any step is remove if it does not contribute to computing any of the `required_fields`</span>
<span class="sd">    (i.e., if it is a dead end).</span>

<span class="sd">    Examples of a dead end are typically steps used to prepare a tentative, intermediate calibration function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    required_fields : Iterable[str] | str | None</span>
<span class="sd">        Steps will be preserved if any of their outputs are among `required_fields`, or if their outputs are</span>
<span class="sd">        found recursively among the inputs to any such steps. If a string, treat as a list of that one string.</span>
<span class="sd">        If None, preserve all steps.</span>

<span class="sd">    drop_debug : bool</span>
<span class="sd">        Whether to run `step.drop_debug()` to remove debugging information from the preserved steps.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Recipe</span>
<span class="sd">        A copy of `self`, except that any steps not required to compute any of `required_fields` are omitted.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">required_fields</span><span class="p">]</span>

    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># The easiest approach is to traverse the steps from last to first to build our list of required</span>
    <span class="c1"># fields, because necessarily no later step can produce the inputs needed by an earlier step.</span>
    <span class="k">if</span> <span class="n">required_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">required</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_fields_out</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_fields</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">all_fields_out</span><span class="p">:</span>
                    <span class="n">required</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">all_fields_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">required</span><span class="p">):</span>
        <span class="c1"># If this error ever because a problem, where user _acutally_ wants an empty series of steps</span>
        <span class="c1"># to be a non-err, then add argument `error_on_empty_output=True` to this method.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"trim_dead_ends found no steps to be preserved"</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">required</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">drop_debug</span><span class="p">:</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_debug</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.trim_debug_info">
<code class="highlight language-python"><span class="n">trim_debug_info</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a new Recipe object with all debug info removed from each step, but no steps removed.</p>
<p>The following are exactly equivalent:</p>
<blockquote>
<blockquote>
<blockquote>
<p>recipe2 = recipe.trim_debug_info()
recipe2 = recipe.trim_dead_ends(required_fields=None, drop_debug=True)</p>
</blockquote>
</blockquote>
</blockquote>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Recipe


  
      dataclass
   (mass2.core.recipe.Recipe)" href="#mass2.core.recipe.Recipe">Recipe</a></code>
              
              <div class="doc-md-description">
<p>A copy of <code>self</code>, except that <code>drop_debug()</code> is called to replace each step with a less-baggage
version of that step.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trim_debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a new Recipe object with all debug info removed from each step, but no steps removed.</span>

<span class="sd">    The following are exactly equivalent:</span>
<span class="sd">    &gt;&gt;&gt; recipe2 = recipe.trim_debug_info()</span>
<span class="sd">    &gt;&gt;&gt; recipe2 = recipe.trim_dead_ends(required_fields=None, drop_debug=True)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Recipe</span>
<span class="sd">        A copy of `self`, except that `drop_debug()` is called to replace each step with a less-baggage</span>
<span class="sd">        version of that step.</span>
<span class="sd">    """</span>
    <span class="n">slim_steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="n">slim_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">drop_debug</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">slim_steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.with_step">
<code class="highlight language-python"><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a new Recipe with the given step added to the end.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">RecipeStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a new Recipe with the given step added to the end."""</span>
    <span class="c1"># return a new Recipe with the step added, no mutation!</span>
    <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="p">[</span><span class="n">step</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.RecipeStep">
<code>RecipeStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Represent one step in a data processing recipe.</p>
<p>A step has inputs, outputs, and a calculation method. It also has a good_expr and use_expr that
can be used to filter the data before processing.</p>
<p>This is an abstract base class, subclasses should implement calc_from_df and dbg_plot.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RecipeStep</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Represent one step in a data processing recipe.</span>

<span class="sd">    A step has inputs, outputs, and a calculation method. It also has a good_expr and use_expr that</span>
<span class="sd">    can be used to filter the data before processing.</span>

<span class="sd">    This is an abstract base class, subclasses should implement calc_from_df and dbg_plot.</span>
<span class="sd">    """</span>

    <span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""The name of this step, usually the class name."""</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A short description of this step, including its inputs and outputs."""</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> inputs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="si">}</span><span class="s2"> outputs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the outputs from the inputs in the given DataFrame, returning a new DataFrame."""</span>
        <span class="c1"># TODO: should this be an abstract method?</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate a diagnostic plot of the results after this step."""</span>
        <span class="c1"># this is a no-op, subclasses can override this to plot something</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"No plot defined for: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RecipeStep"</span><span class="p">:</span>
        <span class="s2">"Return self, or a copy of it with debug information removed"</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.recipe.RecipeStep.description">
<code class="highlight language-python"><span class="n">description</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>A short description of this step, including its inputs and outputs.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.recipe.RecipeStep.name">
<code class="highlight language-python"><span class="n">name</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>The name of this step, usually the class name.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.RecipeStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the outputs from the inputs in the given DataFrame, returning a new DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the outputs from the inputs in the given DataFrame, returning a new DataFrame."""</span>
    <span class="c1"># TODO: should this be an abstract method?</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.RecipeStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Generate a diagnostic plot of the results after this step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate a diagnostic plot of the results after this step."""</span>
    <span class="c1"># this is a no-op, subclasses can override this to plot something</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"No plot defined for: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.RecipeStep.drop_debug">
<code class="highlight language-python"><span class="n">drop_debug</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return self, or a copy of it with debug information removed</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RecipeStep"</span><span class="p">:</span>
    <span class="s2">"Return self, or a copy of it with debug information removed"</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.SelectStep">
<code>SelectStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SelectStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</span>
<span class="sd">    """</span>

    <span class="n">col_expr_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Select the given columns and return a new DataFrame."""</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">col_expr_dict</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.SelectStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Select the given columns and return a new DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Select the given columns and return a new DataFrame."""</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">col_expr_dict</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.SummarizeStep">
<code>SummarizeStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>Summarize raw pulse data into summary statistics using numba-accelerated code.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SummarizeStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Summarize raw pulse data into summary statistics using numba-accelerated code."""</span>

    <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">peak_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">pretrigger_ignore_samples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">n_presamples</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate the summary statistics and return a new DataFrame."""</span>
        <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">():</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                <span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">summarize_data_numba</span><span class="p">(</span>
                    <span class="n">raw</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
                    <span class="n">peak_samplenumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_index</span><span class="p">,</span>
                    <span class="n">pretrigger_ignore_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrigger_ignore_samples</span><span class="p">,</span>
                    <span class="n">nPresamples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.SummarizeStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Calculate the summary statistics and return a new DataFrame.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the summary statistics and return a new DataFrame."""</span>
    <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">():</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
            <span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">summarize_data_numba</span><span class="p">(</span>
                <span class="n">raw</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
                <span class="n">peak_samplenumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_index</span><span class="p">,</span>
                <span class="n">pretrigger_ignore_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrigger_ignore_samples</span><span class="p">,</span>
                <span class="n">nPresamples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.rough_cal"></a>
<div class="doc doc-contents first">
<p>Tools for rough calibration of pulse heights to energies</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult">
<code>BestAssignmentPfitGainResult</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Result of finding the best assignment of pulse heights to energies and fitting a polynomial gain curve.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BestAssignmentPfitGainResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Result of finding the best assignment of pulse heights to energies and fitting a polynomial gain curve."""</span>

    <span class="n">rms_residual</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">ph_assigned</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">residual_e</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">assignment_inds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">pfit_gain</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span>
    <span class="n">energy_target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">names_target</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># list of strings with names for the energies in energy_target</span>
    <span class="n">ph_target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># longer than energy target by 0-3</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph_unassigned</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Which pulse heights were not assigned to any energy."""</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_target</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a diagnostic plot of the gain fit."""</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_target</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_target</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">)</span>
        <span class="n">ph_large_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ph_large_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph_large_range</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"pulse_height"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"gain"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BestAssignmentPfitGainResult rms_residual=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_residual</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_target</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="n">gain</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">phzerogain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Find the pulse height where the gain goes to zero.</span>
<span class="sd">        Quadratic fits should have two roots, we want the positive one; if they are complex, choose the real part."""</span>
        <span class="c1"># the pulse height at which the gain is zero</span>
        <span class="c1"># for now I'm counting on the roots being ordered, we want the positive root where gain goes zero</span>
        <span class="c1"># since our function is invalid outside that range</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">roots</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Convert pulse height to energy using the fitted gain curve."""</span>
        <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert the gain curve to convert energy to pulse height."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy2ph_deg2</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy2ph_deg1</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy2ph_deg0</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"degree out of range"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_energy2ph_deg2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert a 2nd degree polynomial gain curve to convert energy to pulse height."""</span>
        <span class="c1"># ph2energy is equivalent to this with y=energy, x=ph</span>
        <span class="c1"># y = x/(c + b*x + a*x^2)</span>
        <span class="c1"># so</span>
        <span class="c1"># y*c + (y*b-1)*x + a*x^2 = 0</span>
        <span class="c1"># and given that we've selected for well formed calibrations,</span>
        <span class="c1"># we know which root we want</span>
        <span class="n">cba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span><span class="o">.</span><span class="n">coef</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">cba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_energy2ph_deg1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert a 1st degree polynomial gain curve to convert energy to pulse height."""</span>
        <span class="c1"># ph2energy is equivalent to this with y=energy, x=ph</span>
        <span class="c1"># y = x/(b + a*x)</span>
        <span class="c1"># so</span>
        <span class="c1"># x = y*b/(1-y*a)</span>
        <span class="c1"># and given that we've selected for well formed calibrations,</span>
        <span class="c1"># we know which root we want</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span><span class="o">.</span><span class="n">coef</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_energy2ph_deg0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert a 0th degree polynomial gain curve to convert energy to pulse height."""</span>
        <span class="c1"># ph2energy is equivalent to this with y=energy, x=ph</span>
        <span class="c1"># y = x/(a)</span>
        <span class="c1"># so</span>
        <span class="c1"># x = y*a</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span><span class="o">.</span><span class="n">coef</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">ph</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predicted_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Convert the assigned pulse heights to energies using the fitted gain curve."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult.energy2ph">
<code class="highlight language-python"><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Invert the gain curve to convert energy to pulse height.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Invert the gain curve to convert energy to pulse height."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy2ph_deg2</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy2ph_deg1</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy2ph_deg0</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"degree out of range"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult.ph2energy">
<code class="highlight language-python"><span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Convert pulse height to energy using the fitted gain curve.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert pulse height to energy using the fitted gain curve."""</span>
    <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult.ph_unassigned">
<code class="highlight language-python"><span class="n">ph_unassigned</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Which pulse heights were not assigned to any energy.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph_unassigned</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Which pulse heights were not assigned to any energy."""</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_target</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult.phzerogain">
<code class="highlight language-python"><span class="n">phzerogain</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Find the pulse height where the gain goes to zero.
Quadratic fits should have two roots, we want the positive one; if they are complex, choose the real part.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">phzerogain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Find the pulse height where the gain goes to zero.</span>
<span class="sd">    Quadratic fits should have two roots, we want the positive one; if they are complex, choose the real part."""</span>
    <span class="c1"># the pulse height at which the gain is zero</span>
    <span class="c1"># for now I'm counting on the roots being ordered, we want the positive root where gain goes zero</span>
    <span class="c1"># since our function is invalid outside that range</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">roots</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a diagnostic plot of the gain fit.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a diagnostic plot of the gain fit."""</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_target</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_target</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">)</span>
    <span class="n">ph_large_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ph_large_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph_large_range</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"pulse_height"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"gain"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BestAssignmentPfitGainResult rms_residual=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_residual</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_target</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="n">gain</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.BestAssignmentPfitGainResult.predicted_energies">
<code class="highlight language-python"><span class="n">predicted_energies</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Convert the assigned pulse heights to energies using the fitted gain curve.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predicted_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert the assigned pulse heights to energies using the fitted gain curve."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep">
<code>RoughCalibrationStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>A step to perform a rough calibration of pulse heights to energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RoughCalibrationStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A step to perform a rough calibration of pulse heights to energies."""</span>

    <span class="n">pfresult</span><span class="p">:</span> <span class="n">SmoothedLocalMaximaResult</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">assignment_result</span><span class="p">:</span> <span class="n">BestAssignmentPfitGainResult</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">ph2energy</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply the rough calibration to a dataframe."""</span>
        <span class="c1"># only works with in memory data, but just takes it as numpy data and calls function</span>
        <span class="c1"># is much faster than map_elements approach, but wouldn't work with out of core data without some extra book keeping</span>
        <span class="n">inputs_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">inputs_np</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">out</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a copy of this step with debug information removed."""</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pfresult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assignment_result</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create diagnostic plots of the rough calibration step."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_plot_success</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_plot_failure</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create diagnostic plots of the rough calibration step, if it succeeded."""</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create diagnostic plots of the rough calibration step, if it failed."""</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Convert energy to pulse height using the fitted gain curve."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn_combinatoric</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,</span>
<span class="sd">        and assigning them to known energies in a way that minimizes the RMS error in a local linearity test."""</span>
        <span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ee</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
        <span class="n">uncalibrated</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"not enough pulses"</span>
        <span class="n">pfresult</span> <span class="o">=</span> <span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">)</span>
        <span class="n">assignment_result</span> <span class="o">=</span> <span class="n">find_optimal_assignment2</span><span class="p">(</span><span class="n">pfresult</span><span class="o">.</span><span class="n">ph_sorted_by_prominence</span><span class="p">()[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra</span><span class="p">],</span> <span class="n">ee</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
        <span class="c1"># phzerogain doesn't exist if there is only one line, and it might make no sense even if it does.</span>
        <span class="n">good_expr_with_new_info</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Fix issue #95: don't cut pulses exceeding max_ph if that value is negative or cuts most pulses.</span>
            <span class="c1"># exclude pulses with values where the gain is negative</span>
            <span class="n">max_ph</span> <span class="o">=</span> <span class="n">assignment_result</span><span class="o">.</span><span class="n">phzerogain</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">max_ph</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_ph</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">):</span>
                <span class="n">good_expr_with_new_info</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_ph</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
            <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
            <span class="n">good_expr_with_new_info</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="n">pfresult</span><span class="o">=</span><span class="n">pfresult</span><span class="p">,</span>
            <span class="n">assignment_result</span><span class="o">=</span><span class="n">assignment_result</span><span class="p">,</span>
            <span class="n">ph2energy</span><span class="o">=</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">,</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">step</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn_combinatoric_height_info</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,</span>
<span class="sd">        and assigning them to known energies in a way that minimizes the RMS error in a local linearity test,</span>
<span class="sd">        while respecting constraints on which pulse heights can be assigned to which energies."""</span>
        <span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ee</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
        <span class="n">uncalibrated</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"not enough pulses"</span>
        <span class="n">pfresult</span> <span class="o">=</span> <span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">)</span>
        <span class="n">assignment_result</span> <span class="o">=</span> <span class="n">find_optimal_assignment2_height_info</span><span class="p">(</span>
            <span class="n">pfresult</span><span class="o">.</span><span class="n">ph_sorted_by_prominence</span><span class="p">()[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra</span><span class="p">],</span>
            <span class="n">ee</span><span class="p">,</span>
            <span class="n">names</span><span class="p">,</span>
            <span class="n">line_heights_allowed</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
            <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
            <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="n">pfresult</span><span class="o">=</span><span class="n">pfresult</span><span class="p">,</span>
            <span class="n">assignment_result</span><span class="o">=</span><span class="n">assignment_result</span><span class="p">,</span>
            <span class="n">ph2energy</span><span class="o">=</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">,</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">step</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn_3peak</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917 PLR0914,</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"filtValue"</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
        <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
        <span class="n">n_extra_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">acceptable_rms_residual_e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,</span>
<span class="sd">        and assigning 3 of them to known energies in a way that minimizes the RMS error in a local linearity test,</span>
<span class="sd">        and then evaluating that assignment by fitting a 2nd degree polynomial gain curve to all possible pulse heights</span>
<span class="sd">        and returning the RMS error in energy after applying that gain curve to all possible pulse heights.</span>
<span class="sd">        If no good assignment is found, the step will be marked as unsuccessful."""</span>
        <span class="k">if</span> <span class="n">calibrated_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calibrated_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"energy_</span><span class="si">{</span><span class="n">uncalibrated_col</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">(</span><span class="n">line_names_str</span><span class="p">,</span> <span class="n">line_energies_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
        <span class="n">line_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line_energies_list</span><span class="p">)</span>
        <span class="n">uncalibrated</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">pfresult</span> <span class="o">=</span> <span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="n">fwhm_pulse_height_units</span><span class="p">)</span>
        <span class="n">possible_phs</span> <span class="o">=</span> <span class="n">pfresult</span><span class="o">.</span><span class="n">ph_sorted_by_prominence</span><span class="p">()[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra_peaks</span><span class="p">]</span>
        <span class="n">df3peak</span><span class="p">,</span> <span class="n">_dfe</span> <span class="o">=</span> <span class="n">rank_3peak_assignments</span><span class="p">(</span>
            <span class="n">possible_phs</span><span class="p">,</span>
            <span class="n">line_energies</span><span class="p">,</span>
            <span class="n">line_names_str</span><span class="p">,</span>
            <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">,</span>
            <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">best_assignment_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">assignment_row</span> <span class="ow">in</span> <span class="n">df3peak</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"e0"</span><span class="p">,</span> <span class="s2">"ph0"</span><span class="p">,</span> <span class="s2">"e1"</span><span class="p">,</span> <span class="s2">"ph1"</span><span class="p">,</span> <span class="s2">"e2"</span><span class="p">,</span> <span class="s2">"ph2"</span><span class="p">,</span> <span class="s2">"e_err_at_ph2"</span><span class="p">)</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">():</span>
            <span class="n">e0</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">ph2</span><span class="p">,</span> <span class="n">_e_err_at_ph2</span> <span class="o">=</span> <span class="n">assignment_row</span>
            <span class="n">pharray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ph0</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">ph2</span><span class="p">])</span>
            <span class="n">earray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e0</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">])</span>
            <span class="n">rms_residual</span><span class="p">,</span> <span class="n">assignment_result</span> <span class="o">=</span> <span class="n">eval_3peak_assignment_pfit_gain</span><span class="p">(</span>
                <span class="n">pharray</span><span class="p">,</span> <span class="n">earray</span><span class="p">,</span> <span class="n">possible_phs</span><span class="p">,</span> <span class="n">line_energies</span><span class="p">,</span> <span class="n">line_names_str</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">rms_residual</span> <span class="o">&lt;</span> <span class="n">best_rms_residual</span><span class="p">:</span>
                <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">rms_residual</span>
                <span class="n">best_assignment_result</span> <span class="o">=</span> <span class="n">assignment_result</span>
                <span class="k">if</span> <span class="n">rms_residual</span> <span class="o">&lt;</span> <span class="n">acceptable_rms_residual_e</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">best_assignment_result</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_assignment_result</span><span class="p">,</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">best_rms_residual</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ph2energy</span> <span class="o">=</span> <span class="n">best_assignment_result</span><span class="o">.</span><span class="n">ph2energy</span>
            <span class="c1"># df3peak_on_failure = None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">nanenergy</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
                <span class="s2">"Return NaN for all pulse heights, indicating failure to calibrate."</span>
                <span class="k">return</span> <span class="n">ph</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">ph2energy</span> <span class="o">=</span> <span class="n">nanenergy</span>
            <span class="c1"># df3peak_on_failure = df3peak</span>
        <span class="c1"># df3peak_on_failure = df3peak</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_assignment_result</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">best_assignment_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
            <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
            <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="n">pfresult</span><span class="o">=</span><span class="n">pfresult</span><span class="p">,</span>
            <span class="n">assignment_result</span><span class="o">=</span><span class="n">best_assignment_result</span><span class="p">,</span>
            <span class="n">ph2energy</span><span class="o">=</span><span class="n">ph2energy</span><span class="p">,</span>
            <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Apply the rough calibration to a dataframe.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply the rough calibration to a dataframe."""</span>
    <span class="c1"># only works with in memory data, but just takes it as numpy data and calls function</span>
    <span class="c1"># is much faster than map_elements approach, but wouldn't work with out of core data without some extra book keeping</span>
    <span class="n">inputs_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">(</span><span class="n">inputs_np</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">out</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.dbg_plot">
<code class="highlight language-python"><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create diagnostic plots of the rough calibration step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create diagnostic plots of the rough calibration step."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_plot_success</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_plot_failure</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.dbg_plot_failure">
<code class="highlight language-python"><span class="n">dbg_plot_failure</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create diagnostic plots of the rough calibration step, if it failed.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create diagnostic plots of the rough calibration step, if it failed."""</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.dbg_plot_success">
<code class="highlight language-python"><span class="n">dbg_plot_success</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create diagnostic plots of the rough calibration step, if it succeeded.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create diagnostic plots of the rough calibration step, if it succeeded."""</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfresult</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.drop_debug">
<code class="highlight language-python"><span class="n">drop_debug</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a copy of this step with debug information removed.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a copy of this step with debug information removed."""</span>
    <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pfresult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">assignment_result</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.energy2ph">
<code class="highlight language-python"><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Convert energy to pulse height using the fitted gain curve.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert energy to pulse height using the fitted gain curve."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.0</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.learn_3peak">
<code class="highlight language-python"><span class="n">learn_3peak</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">uncalibrated_col</span><span class="o">=</span><span class="s1">'filtValue'</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span> <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_gain_fraction_at_ph_30k</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">n_extra_peaks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">acceptable_rms_residual_e</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,
and assigning 3 of them to known energies in a way that minimizes the RMS error in a local linearity test,
and then evaluating that assignment by fitting a 2nd degree polynomial gain curve to all possible pulse heights
and returning the RMS error in energy after applying that gain curve to all possible pulse heights.
If no good assignment is found, the step will be marked as unsuccessful.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">learn_3peak</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917 PLR0914,</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"filtValue"</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
    <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
    <span class="n">n_extra_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">acceptable_rms_residual_e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,</span>
<span class="sd">    and assigning 3 of them to known energies in a way that minimizes the RMS error in a local linearity test,</span>
<span class="sd">    and then evaluating that assignment by fitting a 2nd degree polynomial gain curve to all possible pulse heights</span>
<span class="sd">    and returning the RMS error in energy after applying that gain curve to all possible pulse heights.</span>
<span class="sd">    If no good assignment is found, the step will be marked as unsuccessful."""</span>
    <span class="k">if</span> <span class="n">calibrated_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">calibrated_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"energy_</span><span class="si">{</span><span class="n">uncalibrated_col</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">(</span><span class="n">line_names_str</span><span class="p">,</span> <span class="n">line_energies_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">line_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line_energies_list</span><span class="p">)</span>
    <span class="n">uncalibrated</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">pfresult</span> <span class="o">=</span> <span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="n">fwhm_pulse_height_units</span><span class="p">)</span>
    <span class="n">possible_phs</span> <span class="o">=</span> <span class="n">pfresult</span><span class="o">.</span><span class="n">ph_sorted_by_prominence</span><span class="p">()[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names_str</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra_peaks</span><span class="p">]</span>
    <span class="n">df3peak</span><span class="p">,</span> <span class="n">_dfe</span> <span class="o">=</span> <span class="n">rank_3peak_assignments</span><span class="p">(</span>
        <span class="n">possible_phs</span><span class="p">,</span>
        <span class="n">line_energies</span><span class="p">,</span>
        <span class="n">line_names_str</span><span class="p">,</span>
        <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">,</span>
        <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_assignment_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">assignment_row</span> <span class="ow">in</span> <span class="n">df3peak</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"e0"</span><span class="p">,</span> <span class="s2">"ph0"</span><span class="p">,</span> <span class="s2">"e1"</span><span class="p">,</span> <span class="s2">"ph1"</span><span class="p">,</span> <span class="s2">"e2"</span><span class="p">,</span> <span class="s2">"ph2"</span><span class="p">,</span> <span class="s2">"e_err_at_ph2"</span><span class="p">)</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">():</span>
        <span class="n">e0</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">ph2</span><span class="p">,</span> <span class="n">_e_err_at_ph2</span> <span class="o">=</span> <span class="n">assignment_row</span>
        <span class="n">pharray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ph0</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">ph2</span><span class="p">])</span>
        <span class="n">earray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e0</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">])</span>
        <span class="n">rms_residual</span><span class="p">,</span> <span class="n">assignment_result</span> <span class="o">=</span> <span class="n">eval_3peak_assignment_pfit_gain</span><span class="p">(</span>
            <span class="n">pharray</span><span class="p">,</span> <span class="n">earray</span><span class="p">,</span> <span class="n">possible_phs</span><span class="p">,</span> <span class="n">line_energies</span><span class="p">,</span> <span class="n">line_names_str</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">rms_residual</span> <span class="o">&lt;</span> <span class="n">best_rms_residual</span><span class="p">:</span>
            <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">rms_residual</span>
            <span class="n">best_assignment_result</span> <span class="o">=</span> <span class="n">assignment_result</span>
            <span class="k">if</span> <span class="n">rms_residual</span> <span class="o">&lt;</span> <span class="n">acceptable_rms_residual_e</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">best_assignment_result</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_assignment_result</span><span class="p">,</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">best_rms_residual</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ph2energy</span> <span class="o">=</span> <span class="n">best_assignment_result</span><span class="o">.</span><span class="n">ph2energy</span>
        <span class="c1"># df3peak_on_failure = None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">nanenergy</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
            <span class="s2">"Return NaN for all pulse heights, indicating failure to calibrate."</span>
            <span class="k">return</span> <span class="n">ph</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">ph2energy</span> <span class="o">=</span> <span class="n">nanenergy</span>
        <span class="c1"># df3peak_on_failure = df3peak</span>
    <span class="c1"># df3peak_on_failure = df3peak</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_assignment_result</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">best_assignment_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
        <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="n">pfresult</span><span class="o">=</span><span class="n">pfresult</span><span class="p">,</span>
        <span class="n">assignment_result</span><span class="o">=</span><span class="n">best_assignment_result</span><span class="p">,</span>
        <span class="n">ph2energy</span><span class="o">=</span><span class="n">ph2energy</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.learn_combinatoric">
<code class="highlight language-python"><span class="n">learn_combinatoric</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">ph_smoothing_fwhm</span><span class="p">,</span> <span class="n">n_extra</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">))</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,
and assigning them to known energies in a way that minimizes the RMS error in a local linearity test.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">learn_combinatoric</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,</span>
<span class="sd">    and assigning them to known energies in a way that minimizes the RMS error in a local linearity test."""</span>
    <span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ee</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">uncalibrated</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"not enough pulses"</span>
    <span class="n">pfresult</span> <span class="o">=</span> <span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">)</span>
    <span class="n">assignment_result</span> <span class="o">=</span> <span class="n">find_optimal_assignment2</span><span class="p">(</span><span class="n">pfresult</span><span class="o">.</span><span class="n">ph_sorted_by_prominence</span><span class="p">()[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra</span><span class="p">],</span> <span class="n">ee</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
    <span class="c1"># phzerogain doesn't exist if there is only one line, and it might make no sense even if it does.</span>
    <span class="n">good_expr_with_new_info</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Fix issue #95: don't cut pulses exceeding max_ph if that value is negative or cuts most pulses.</span>
        <span class="c1"># exclude pulses with values where the gain is negative</span>
        <span class="n">max_ph</span> <span class="o">=</span> <span class="n">assignment_result</span><span class="o">.</span><span class="n">phzerogain</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_ph</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_ph</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">):</span>
            <span class="n">good_expr_with_new_info</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_ph</span><span class="p">)</span>

    <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
        <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
        <span class="n">good_expr_with_new_info</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="n">pfresult</span><span class="o">=</span><span class="n">pfresult</span><span class="p">,</span>
        <span class="n">assignment_result</span><span class="o">=</span><span class="n">assignment_result</span><span class="p">,</span>
        <span class="n">ph2energy</span><span class="o">=</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.RoughCalibrationStep.learn_combinatoric_height_info">
<code class="highlight language-python"><span class="n">learn_combinatoric_height_info</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">line_heights_allowed</span><span class="p">,</span> <span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">calibrated_col</span><span class="p">,</span> <span class="n">ph_smoothing_fwhm</span><span class="p">,</span> <span class="n">n_extra</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">))</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,
and assigning them to known energies in a way that minimizes the RMS error in a local linearity test,
while respecting constraints on which pulse heights can be assigned to which energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">learn_combinatoric_height_info</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">ch</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RoughCalibrationStep"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Train a rough calibration step by finding peaks in a smoothed histogram of pulse heights,</span>
<span class="sd">    and assigning them to known energies in a way that minimizes the RMS error in a local linearity test,</span>
<span class="sd">    while respecting constraints on which pulse heights can be assigned to which energies."""</span>
    <span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ee</span><span class="p">)</span> <span class="o">=</span> <span class="n">line_names_and_energies</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span>
    <span class="n">uncalibrated</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="n">uncalibrated_col</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"not enough pulses"</span>
    <span class="n">pfresult</span> <span class="o">=</span> <span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">uncalibrated</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">)</span>
    <span class="n">assignment_result</span> <span class="o">=</span> <span class="n">find_optimal_assignment2_height_info</span><span class="p">(</span>
        <span class="n">pfresult</span><span class="o">.</span><span class="n">ph_sorted_by_prominence</span><span class="p">()[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_extra</span><span class="p">],</span>
        <span class="n">ee</span><span class="p">,</span>
        <span class="n">names</span><span class="p">,</span>
        <span class="n">line_heights_allowed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">step</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="p">[</span><span class="n">uncalibrated_col</span><span class="p">],</span>
        <span class="p">[</span><span class="n">calibrated_col</span><span class="p">],</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="n">pfresult</span><span class="o">=</span><span class="n">pfresult</span><span class="p">,</span>
        <span class="n">assignment_result</span><span class="o">=</span><span class="n">assignment_result</span><span class="p">,</span>
        <span class="n">ph2energy</span><span class="o">=</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">ph2energy</span><span class="p">,</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult">
<code>SmoothedLocalMaximaResult</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A set of local maxima found in a smoothed histogram of pulse heights.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SmoothedLocalMaximaResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A set of local maxima found in a smoothed histogram of pulse heights."""</span>

    <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">bin_centers</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">smoothed_counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">local_maxima_inds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># inds into bin_centers</span>
    <span class="n">local_minima_inds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># inds into bin_centers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inds_sorted_by_peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Indices of local maxima sorted by peak height, highest first."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_height</span><span class="p">())]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inds_sorted_by_prominence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Indices of local maxima sorted by prominence, most prominent first."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prominence</span><span class="p">())]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph_sorted_by_prominence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Pulse heights of local maxima sorted by prominence, most prominent first."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_prominence</span><span class="p">()]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph_sorted_by_peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Pulse heights of local maxima sorted by peak height, highest first."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_peak_height</span><span class="p">()]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Peak heights of local maxima."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prominence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Prominence of local maxima, in aems order as `local_maxima_inds`."""</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_minima_inds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">"peakfind_local_maxima_of_smoothed_hist must ensure this "</span>
        <span class="p">)</span>
        <span class="n">prominence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">)):</span>
            <span class="n">sc_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sc_min_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_minima_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sc_min_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_minima_inds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">prominence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sc_max</span> <span class="o">-</span> <span class="n">sc_min_before</span> <span class="o">-</span> <span class="n">sc_min_after</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">prominence</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">"prominence should be non-negative"</span>
        <span class="k">return</span> <span class="n">prominence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">assignment_result</span><span class="p">:</span> <span class="n">BestAssignmentPfitGainResult</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_highlight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">plot_counts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a diagnostic plot of the smoothed histogram and local maxima."""</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">inds_prominence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_prominence</span><span class="p">()[:</span><span class="n">n_highlight</span><span class="p">]</span>
        <span class="n">inds_peak_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_peak_height</span><span class="p">()[:</span><span class="n">n_highlight</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">plot_counts</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"counts"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"smoothed_counts"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">],</span>
            <span class="s2">"."</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">"peaks"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">assignment_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inds_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">assignment_result</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)</span>
            <span class="n">inds_unassigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">assignment_result</span><span class="o">.</span><span class="n">ph_unassigned</span><span class="p">())</span>
            <span class="n">bin_centers_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_assigned</span><span class="p">]</span>
            <span class="n">bin_centers_unassigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_unassigned</span><span class="p">]</span>
            <span class="n">smoothed_counts_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_assigned</span><span class="p">]</span>
            <span class="n">smoothed_counts_unassigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_unassigned</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers_assigned</span><span class="p">,</span> <span class="n">smoothed_counts_assigned</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"assigned"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">bin_centers_unassigned</span><span class="p">,</span>
                <span class="n">smoothed_counts_unassigned</span><span class="p">,</span>
                <span class="s2">"o"</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">"unassigned"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">assignment_result</span><span class="o">.</span><span class="n">names_target</span><span class="p">,</span>
                <span class="n">bin_centers_assigned</span><span class="p">,</span>
                <span class="n">smoothed_counts_assigned</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SmoothedLocalMaximaResult rms_residual=</span><span class="si">{</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">rms_residual</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_prominence</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_prominence</span><span class="p">],</span>
                <span class="s2">"o"</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">n_highlight</span><span class="si">}</span><span class="s2"> most prominent"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_peak_height</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_peak_height</span><span class="p">],</span>
                <span class="s2">"v"</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">n_highlight</span><span class="si">}</span><span class="s2"> highest"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"SmoothedLocalMaximaResult"</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"pulse height"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"intensity"</span><span class="p">)</span>
        <span class="c1"># print(f"{np.amax(self.smoothed_counts)=} {np.amin(self.smoothed_counts)=} ")</span>
        <span class="c1"># ax.set_ylim(1/self.fwhm_pulse_height_units, ax.get_ylim()[1])</span>

        <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.inds_sorted_by_peak_height">
<code class="highlight language-python"><span class="n">inds_sorted_by_peak_height</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Indices of local maxima sorted by peak height, highest first.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inds_sorted_by_peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Indices of local maxima sorted by peak height, highest first."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_height</span><span class="p">())]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.inds_sorted_by_prominence">
<code class="highlight language-python"><span class="n">inds_sorted_by_prominence</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Indices of local maxima sorted by prominence, most prominent first.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">inds_sorted_by_prominence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Indices of local maxima sorted by prominence, most prominent first."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prominence</span><span class="p">())]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.peak_height">
<code class="highlight language-python"><span class="n">peak_height</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Peak heights of local maxima.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Peak heights of local maxima."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.ph_sorted_by_peak_height">
<code class="highlight language-python"><span class="n">ph_sorted_by_peak_height</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Pulse heights of local maxima sorted by peak height, highest first.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph_sorted_by_peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Pulse heights of local maxima sorted by peak height, highest first."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_peak_height</span><span class="p">()]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.ph_sorted_by_prominence">
<code class="highlight language-python"><span class="n">ph_sorted_by_prominence</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Pulse heights of local maxima sorted by prominence, most prominent first.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ph_sorted_by_prominence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Pulse heights of local maxima sorted by prominence, most prominent first."""</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_prominence</span><span class="p">()]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">assignment_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_highlight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">plot_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a diagnostic plot of the smoothed histogram and local maxima.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">assignment_result</span><span class="p">:</span> <span class="n">BestAssignmentPfitGainResult</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_highlight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">plot_counts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a diagnostic plot of the smoothed histogram and local maxima."""</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">inds_prominence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_prominence</span><span class="p">()[:</span><span class="n">n_highlight</span><span class="p">]</span>
    <span class="n">inds_peak_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inds_sorted_by_peak_height</span><span class="p">()[:</span><span class="n">n_highlight</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot_counts</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"counts"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"smoothed_counts"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">],</span>
        <span class="s2">"."</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">"peaks"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">assignment_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inds_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">assignment_result</span><span class="o">.</span><span class="n">ph_assigned</span><span class="p">)</span>
        <span class="n">inds_unassigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">assignment_result</span><span class="o">.</span><span class="n">ph_unassigned</span><span class="p">())</span>
        <span class="n">bin_centers_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_assigned</span><span class="p">]</span>
        <span class="n">bin_centers_unassigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_unassigned</span><span class="p">]</span>
        <span class="n">smoothed_counts_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_assigned</span><span class="p">]</span>
        <span class="n">smoothed_counts_unassigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_unassigned</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers_assigned</span><span class="p">,</span> <span class="n">smoothed_counts_assigned</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"assigned"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">bin_centers_unassigned</span><span class="p">,</span>
            <span class="n">smoothed_counts_unassigned</span><span class="p">,</span>
            <span class="s2">"o"</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">"unassigned"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">assignment_result</span><span class="o">.</span><span class="n">names_target</span><span class="p">,</span>
            <span class="n">bin_centers_assigned</span><span class="p">,</span>
            <span class="n">smoothed_counts_assigned</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SmoothedLocalMaximaResult rms_residual=</span><span class="si">{</span><span class="n">assignment_result</span><span class="o">.</span><span class="n">rms_residual</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_prominence</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_prominence</span><span class="p">],</span>
            <span class="s2">"o"</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">n_highlight</span><span class="si">}</span><span class="s2"> most prominent"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">inds_peak_height</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">inds_peak_height</span><span class="p">],</span>
            <span class="s2">"v"</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">n_highlight</span><span class="si">}</span><span class="s2"> highest"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"SmoothedLocalMaximaResult"</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"pulse height"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"intensity"</span><span class="p">)</span>
    <span class="c1"># print(f"{np.amax(self.smoothed_counts)=} {np.amin(self.smoothed_counts)=} ")</span>
    <span class="c1"># ax.set_ylim(1/self.fwhm_pulse_height_units, ax.get_ylim()[1])</span>

    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.rough_cal.SmoothedLocalMaximaResult.prominence">
<code class="highlight language-python"><span class="n">prominence</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Prominence of local maxima, in aems order as <code>local_maxima_inds</code>.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prominence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Prominence of local maxima, in aems order as `local_maxima_inds`."""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_minima_inds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">"peakfind_local_maxima_of_smoothed_hist must ensure this "</span>
    <span class="p">)</span>
    <span class="n">prominence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">)):</span>
        <span class="n">sc_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_maxima_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">sc_min_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_minima_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">sc_min_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_minima_inds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">prominence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sc_max</span> <span class="o">-</span> <span class="n">sc_min_before</span> <span class="o">-</span> <span class="n">sc_min_after</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">prominence</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">"prominence should be non-negative"</span>
    <span class="k">return</span> <span class="n">prominence</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.drift_correct_entropy">
<code class="highlight language-python"><span class="n">drift_correct_entropy</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">indicator_zero_mean</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Calculate the entropy of a histogram of drift-corrected pulse heights.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drift_correct_entropy</span><span class="p">(</span>
    <span class="n">slope</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">indicator_zero_mean</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm_in_bin_number_units</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the entropy of a histogram of drift-corrected pulse heights."""</span>
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">indicator_zero_mean</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span>
    <span class="n">smoothed_counts</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">_counts</span> <span class="o">=</span> <span class="n">hist_smoothed</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">smoothed_counts</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">smoothed_counts</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">smoothed_counts</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.eval_3peak_assignment_pfit_gain">
<code class="highlight language-python"><span class="n">eval_3peak_assignment_pfit_gain</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="n">e_assigned</span><span class="p">,</span> <span class="n">possible_phs</span><span class="p">,</span> <span class="n">line_energies</span><span class="p">,</span> <span class="n">line_names</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Evaluate a proposed assignment of 3 pulse heights to 3 energies by fitting a 2nd degree polynomial gain curve,
and returning the RMS residual in energy after applying that gain curve to all possible pulse heights.
If the proposed assignment does not lead to a well formed gain curve, return infinity and a string describing the problem.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">eval_3peak_assignment_pfit_gain</span><span class="p">(</span>
    <span class="n">ph_assigned</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">e_assigned</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">possible_phs</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">line_energies</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">BestAssignmentPfitGainResult</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Evaluate a proposed assignment of 3 pulse heights to 3 energies by fitting a 2nd degree polynomial gain curve,</span>
<span class="sd">    and returning the RMS residual in energy after applying that gain curve to all possible pulse heights.</span>
<span class="sd">    If the proposed assignment does not lead to a well formed gain curve, return infinity and a string describing the problem."""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">),</span> <span class="s2">"assignments must be unique"</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">e_assigned</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">e_assigned</span><span class="p">),</span> <span class="s2">"assignments must be unique"</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">"assignments must be sorted"</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">e_assigned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">"assignments must be sorted"</span>
    <span class="n">gain_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_assigned</span><span class="p">)</span>
    <span class="n">pfit_gain_3peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="n">gain_assigned</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pfit_gain_3peak</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># well formed calibration have negative derivative at zero pulse height</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">"pfit_gain_3peak deriv at 0 should be &lt;0"</span>
    <span class="k">if</span> <span class="n">pfit_gain_3peak</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># well formed calibration have positive gain at 1e5</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">"pfit_gain_3peak should be above zero at 100k ph"</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">pfit_gain_3peak</span><span class="o">.</span><span class="n">roots</span><span class="p">())):</span>
        <span class="c1"># well formed calibrations have real roots</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">"pfit_gain_3peak must have real roots"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Convert pulse height to energy using the fitted gain curve."</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">pfit_gain_3peak</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">gain</span>

    <span class="n">cba</span> <span class="o">=</span> <span class="n">pfit_gain_3peak</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span><span class="o">.</span><span class="n">coef</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy2ph</span><span class="p">(</span><span class="n">energy</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="s2">"Invert the gain curve to convert energy to pulse height."</span>
        <span class="c1"># ph2energy is equivalent to this with y=energy, x=ph</span>
        <span class="c1"># y = x/(c + b*x + a*x^2)</span>
        <span class="c1"># so</span>
        <span class="c1"># y*c + (y*b-1)*x + a*x^2 = 0</span>
        <span class="c1"># and given that we've selected for well formed calibrations,</span>
        <span class="c1"># we know which root we want</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">cba</span> <span class="o">*</span> <span class="n">energy</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ph</span>

    <span class="n">predicted_ph</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy2ph</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span> <span class="k">for</span> <span class="n">_e</span> <span class="ow">in</span> <span class="n">line_energies</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">"line_energy"</span><span class="p">:</span> <span class="n">line_energies</span><span class="p">,</span>
        <span class="s2">"line_name"</span><span class="p">:</span> <span class="n">line_names</span><span class="p">,</span>
        <span class="s2">"predicted_ph"</span><span class="p">:</span> <span class="n">predicted_ph</span><span class="p">,</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"predicted_ph"</span><span class="p">)</span>
    <span class="n">dfph</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"possible_ph"</span><span class="p">:</span> <span class="n">possible_phs</span><span class="p">,</span> <span class="s2">"ph_ind"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible_phs</span><span class="p">))})</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"possible_ph"</span><span class="p">)</span>
    <span class="c1"># for each e find the closest possible_ph to the calculaed predicted_ph</span>
    <span class="c1"># we started with assignments for 3 energies</span>
    <span class="c1"># now we have assignments for all energies</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">dfph</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">"predicted_ph"</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">"possible_ph"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"nearest"</span><span class="p">)</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"possible_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">n_unique</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="c1"># assigned multiple energies to same pulseheight, not a good cal</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">"assignments should be unique"</span>

    <span class="c1"># now we evaluate the assignment and create a result object</span>
    <span class="n">residual_e</span><span class="p">,</span> <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">find_pfit_gain_residual</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"possible_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">"line_energy"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">pfit_gain</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># well formed calibration have positive gain at 1e5</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">"pfit_gain should be above zero at 100k ph"</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">pfit_gain</span><span class="o">.</span><span class="n">roots</span><span class="p">())):</span>
        <span class="c1"># well formed calibrations have real roots</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s2">"pfit_gain should not have complex roots"</span>
    <span class="n">rms_residual_e</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">residual_e</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">(</span>
        <span class="n">rms_residual_e</span><span class="p">,</span>
        <span class="n">ph_assigned</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"possible_ph"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">residual_e</span><span class="o">=</span><span class="n">residual_e</span><span class="p">,</span>
        <span class="n">assignment_inds</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"ph_ind"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">pfit_gain</span><span class="o">=</span><span class="n">pfit_gain</span><span class="p">,</span>
        <span class="n">energy_target</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"line_energy"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="n">names_target</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">"line_name"</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="n">ph_target</span><span class="o">=</span><span class="n">possible_phs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">rms_residual_e</span><span class="p">,</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_best_residual_among_all_possible_assignments">
<code class="highlight language-python"><span class="n">find_best_residual_among_all_possible_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Try all possible assignments of pulse heights to energies,
and return the one with the lowest RMS residual in energy after fitting a 2nd degree polynomial gain curve.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_best_residual_among_all_possible_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">Polynomial</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Try all possible assignments of pulse heights to energies,</span>
<span class="sd">    and return the one with the lowest RMS residual in energy after fitting a 2nd degree polynomial gain curve.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">assignments_inds</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_ph_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">best_residual_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">best_assignment_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">best_pfit</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignments_inds</span><span class="p">):</span>
        <span class="n">assignment_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">ph_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ph</span><span class="p">[</span><span class="n">assignment_inds</span><span class="p">])</span>
        <span class="n">residual_e</span><span class="p">,</span> <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">find_pfit_gain_residual</span><span class="p">(</span><span class="n">ph_assigned</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">rms_residual</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">residual_e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rms_residual</span> <span class="o">&lt;</span> <span class="n">best_rms_residual</span><span class="p">:</span>
            <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">rms_residual</span>
            <span class="n">best_ph_assigned</span> <span class="o">=</span> <span class="n">ph_assigned</span>
            <span class="n">best_residual_e</span> <span class="o">=</span> <span class="n">residual_e</span>
            <span class="n">best_assignment_inds</span> <span class="o">=</span> <span class="n">assignment_inds</span>
            <span class="n">best_pfit</span> <span class="o">=</span> <span class="n">pfit_gain</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">best_rms_residual</span><span class="p">,</span>
        <span class="n">best_ph_assigned</span><span class="p">,</span>
        <span class="n">best_residual_e</span><span class="p">,</span>
        <span class="n">best_assignment_inds</span><span class="p">,</span>
        <span class="n">best_pfit</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_best_residual_among_all_possible_assignments2">
<code class="highlight language-python"><span class="n">find_best_residual_among_all_possible_assignments2</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Try all possible assignments of pulse heights to energies,
and return the one with the lowest RMS residual in energy after fitting a 2nd degree polynomial gain curve.
Return as a BestAssignmentPfitGainResult object.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_best_residual_among_all_possible_assignments2</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Try all possible assignments of pulse heights to energies,</span>
<span class="sd">    and return the one with the lowest RMS residual in energy after fitting a 2nd degree polynomial gain curve.</span>
<span class="sd">    Return as a BestAssignmentPfitGainResult object.</span>
<span class="sd">    """</span>
    <span class="p">(</span>
        <span class="n">best_rms_residual</span><span class="p">,</span>
        <span class="n">best_ph_assigned</span><span class="p">,</span>
        <span class="n">best_residual_e</span><span class="p">,</span>
        <span class="n">best_assignment_inds</span><span class="p">,</span>
        <span class="n">best_pfit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">find_best_residual_among_all_possible_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">(</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">best_rms_residual</span><span class="p">),</span>
        <span class="n">best_ph_assigned</span><span class="p">,</span>
        <span class="n">best_residual_e</span><span class="p">,</span>
        <span class="n">best_assignment_inds</span><span class="p">,</span>
        <span class="n">best_pfit</span><span class="p">,</span>
        <span class="n">e</span><span class="p">,</span>
        <span class="n">names</span><span class="p">,</span>
        <span class="n">ph</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_local_maxima">
<code class="highlight language-python"><span class="n">find_local_maxima</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">gaussian_fwhm</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Smears each pulse by a gaussian of gaussian_fhwm and finds local maxima,
returns a list of their locations in pulse_height units (sorted by number of
pulses in peak) AND their peak values as: (peak_locations, peak_intensities)</p>
<p>Args:
    pulse_heights (np.array(dtype=float)): a list of pulse heights (eg p_filt_value)
    gaussian_fwhm = fwhm of a gaussian that each pulse is smeared with, in same units as pulse heights</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_local_maxima</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">gaussian_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Smears each pulse by a gaussian of gaussian_fhwm and finds local maxima,</span>
<span class="sd">    returns a list of their locations in pulse_height units (sorted by number of</span>
<span class="sd">    pulses in peak) AND their peak values as: (peak_locations, peak_intensities)</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_heights (np.array(dtype=float)): a list of pulse heights (eg p_filt_value)</span>
<span class="sd">        gaussian_fwhm = fwhm of a gaussian that each pulse is smeared with, in same units as pulse heights</span>
<span class="sd">    """</span>
    <span class="c1"># kernel density estimation (with a gaussian kernel)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">gaussian_fwhm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gaussian_fwhm</span><span class="p">)</span>
    <span class="c1"># The above ensures that lo &amp; hi are floats, so that (lo-hi)/n is always a float in python2</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">gaussian_fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">tbw</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">gaussian_fwhm</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">gaussian_fwhm</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">lo</span> <span class="o">-</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">tx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tbw</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">*</span> <span class="n">ty</span><span class="p">)</span>

    <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="n">flag</span><span class="p">]</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">lm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">lm</span><span class="p">])]</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">_step_size</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">lm</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">lm</span><span class="p">]),</span> <span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_optimal_assignment">
<code class="highlight language-python"><span class="n">find_optimal_assignment</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_optimal_assignment</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test."""</span>
    <span class="c1"># ph is a list of peak heights longer than e</span>
    <span class="c1"># e is a list of known peak energies</span>
    <span class="c1"># we want to find the set of peak heights from ph that are closest to being locally linear with the energies in e</span>

    <span class="c1"># when given 3 or less energies to match, use the largest peaks in peak order</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ph</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)]))</span>

    <span class="n">rms_e_residual</span><span class="p">,</span> <span class="n">pha</span><span class="p">,</span> <span class="n">_pha_inds</span> <span class="o">=</span> <span class="n">rank_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">rms_e_residual</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rms_e_residual</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">pha</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_optimal_assignment2">
<code class="highlight language-python"><span class="n">find_optimal_assignment2</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">line_names</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test,
and fit a polynomial gain curve to the result.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_optimal_assignment2</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test,</span>
<span class="sd">    and fit a polynomial gain curve to the result."""</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">rms_e_residual</span><span class="p">,</span> <span class="n">pha</span> <span class="o">=</span> <span class="n">find_optimal_assignment</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"cannot use energy=0 points to learn gain based calibration"</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">pha</span> <span class="o">/</span> <span class="n">e</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">(</span>
        <span class="n">rms_e_residual</span><span class="p">,</span>
        <span class="n">ph_assigned</span><span class="o">=</span><span class="n">pha</span><span class="p">,</span>
        <span class="n">residual_e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">assignment_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pfit_gain</span><span class="o">=</span><span class="n">pfit_gain</span><span class="p">,</span>
        <span class="n">energy_target</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="n">names_target</span><span class="o">=</span><span class="n">line_names</span><span class="p">,</span>
        <span class="n">ph_target</span><span class="o">=</span><span class="n">ph</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_optimal_assignment2_height_info">
<code class="highlight language-python"><span class="n">find_optimal_assignment2_height_info</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">line_heights_allowed</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test,
while respecting constraints on which pulse heights can be assigned to which energies,
and fit a polynomial gain curve to the result.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_optimal_assignment2_height_info</span><span class="p">(</span>
    <span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="n">ArrayLike</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test,</span>
<span class="sd">    while respecting constraints on which pulse heights can be assigned to which energies,</span>
<span class="sd">    and fit a polynomial gain curve to the result."""</span>
    <span class="n">rms_e_residual</span><span class="p">,</span> <span class="n">pha</span> <span class="o">=</span> <span class="n">find_optimal_assignment_height_info</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">line_heights_allowed</span><span class="p">)</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">pha</span> <span class="o">/</span> <span class="n">e</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pha</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">BestAssignmentPfitGainResult</span><span class="p">(</span>
        <span class="n">rms_e_residual</span><span class="p">,</span>
        <span class="n">ph_assigned</span><span class="o">=</span><span class="n">pha</span><span class="p">,</span>
        <span class="n">residual_e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">assignment_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pfit_gain</span><span class="o">=</span><span class="n">pfit_gain</span><span class="p">,</span>
        <span class="n">energy_target</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="n">names_target</span><span class="o">=</span><span class="n">line_names</span><span class="p">,</span>
        <span class="n">ph_target</span><span class="o">=</span><span class="n">ph</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_optimal_assignment_height_info">
<code class="highlight language-python"><span class="n">find_optimal_assignment_height_info</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">line_heights_allowed</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test,
while respecting constraints on which pulse heights can be assigned to which energies.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_optimal_assignment_height_info</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the optimal assignment of pulse heights to energies by minimizing the RMS error in a local linearity test,</span>
<span class="sd">    while respecting constraints on which pulse heights can be assigned to which energies."""</span>
    <span class="c1"># ph is a list of peak heights longer than e</span>
    <span class="c1"># e is a list of known peak energies</span>
    <span class="c1"># we want to find the set of peak heights from ph that are closest to being locally linear with the energies in e</span>

    <span class="c1"># when given 3 or less energies to match, use the largest peaks in peak order</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">line_heights_allowed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line_heights_allowed</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ph</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)]))</span>

    <span class="n">rms_e_residual</span><span class="p">,</span> <span class="n">pha</span><span class="p">,</span> <span class="n">pha_inds</span> <span class="o">=</span> <span class="n">rank_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">best_ind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">e</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i_assign</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rms_e_residual</span><span class="p">)):</span>
        <span class="n">rms_e_candidate</span> <span class="o">=</span> <span class="n">rms_e_residual</span><span class="p">[</span><span class="n">i_assign</span><span class="p">]</span>
        <span class="c1"># pha[i,:] is one choice of len(e) values from ph to assign to e</span>
        <span class="n">pha_inds_candidate</span> <span class="o">=</span> <span class="n">pha_inds</span><span class="p">[</span><span class="n">i_assign</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">rms_e_candidate</span> <span class="o">&gt;</span> <span class="n">best_rms_residual</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># check if peaks mathch height info</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pha_inds_candidate</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">line_heights_allowed</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">failed_line_height_check</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">pha_inds_candidate</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_heights_allowed</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">failed_line_height_check</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"not allowed"</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">pha_inds_candidate</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">line_heights_allowed</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">a</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">b</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">failed_line_height_check</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"is new best!"</span><span class="p">)</span>
        <span class="n">best_rms_residual</span> <span class="o">=</span> <span class="n">rms_e_candidate</span>
        <span class="n">best_ind</span> <span class="o">=</span> <span class="n">i_assign</span>
    <span class="k">if</span> <span class="n">best_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"no assignment found satisfying peak height info"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rms_e_residual</span><span class="p">[</span><span class="n">best_ind</span><span class="p">],</span> <span class="n">pha</span><span class="p">[</span><span class="n">best_ind</span><span class="p">,</span> <span class="p">:]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.find_pfit_gain_residual">
<code class="highlight language-python"><span class="n">find_pfit_gain_residual</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find a 2nd degree polynomial fit to the gain curve defined by ph/e,
and return the residuals in energy when using that gain curve to convert ph to energy.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_pfit_gain_residual</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Polynomial</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find a 2nd degree polynomial fit to the gain curve defined by ph/e,</span>
<span class="sd">    and return the residuals in energy when using that gain curve to convert ph to energy."""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">e</span>
    <span class="n">pfit_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">gain</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Convert pulse height to energy using the fitted gain curve."""</span>
        <span class="k">return</span> <span class="n">ph</span> <span class="o">/</span> <span class="n">pfit_gain</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="n">predicted_e</span> <span class="o">=</span> <span class="n">ph2energy</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">residual_e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">predicted_e</span>
    <span class="k">return</span> <span class="n">residual_e</span><span class="p">,</span> <span class="n">pfit_gain</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.hist_smoothed">
<code class="highlight language-python"><span class="n">hist_smoothed</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute a histogram of pulse heights and smooth it with a Gaussian of given FWHM.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hist_smoothed</span><span class="p">(</span>
    <span class="n">pulse_heights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a histogram of pulse heights and smooth it with a Gaussian of given FWHM."""</span>
    <span class="n">pulse_heights</span> <span class="o">=</span> <span class="n">pulse_heights</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c1"># convert to float64 to avoid wrapping subtraction and platform specific behavior regarding uint16s</span>
    <span class="c1"># linux CI will throw errors, while windows does not, but maybe is just silently wrong?</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_heights</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">"not enough pulses"</span>
    <span class="k">if</span> <span class="n">bin_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fwhm_pulse_height_units</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fwhm_pulse_height_units</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">fwhm_in_bin_number_units</span> <span class="o">=</span> <span class="n">fwhm_pulse_height_units</span> <span class="o">/</span> <span class="n">step_size</span>
    <span class="n">smoothed_counts</span> <span class="o">=</span> <span class="n">smooth_hist_with_gauassian_by_fft</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smoothed_counts</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">counts</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.local_maxima">
<code class="highlight language-python"><span class="n">local_maxima</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find local maxima and minima, as 1D arrays.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">local_maxima</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
    <span class="s2">"Find local maxima and minima, as 1D arrays."</span>
    <span class="n">local_maxima_inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">local_minima_inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">increasing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">increasing</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">local_maxima_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">increasing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">increasing</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">local_minima_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">increasing</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># increasing starts false, so we always start with a miniumum</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_maxima_inds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_minima_inds</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.minimize_entropy_linear">
<code class="highlight language-python"><span class="n">minimize_entropy_linear</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Minimize the entropy of a histogram of drift-corrected pulse heights
by varying the slope of a linear correction based on the given indicator.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">minimize_entropy_linear</span><span class="p">(</span>
    <span class="n">indicator</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm_in_bin_number_units</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">OptimizeResult</span><span class="p">,</span> <span class="n">float32</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Minimize the entropy of a histogram of drift-corrected pulse heights</span>
<span class="sd">    by varying the slope of a linear correction based on the given indicator."""</span>
    <span class="n">indicator_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
    <span class="n">indicator_zero_mean</span> <span class="o">=</span> <span class="n">indicator</span> <span class="o">-</span> <span class="n">indicator_mean</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">entropy_fun</span><span class="p">(</span><span class="n">slope</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the entropy of a histogram of drift-corrected pulse heights, the optimization target."""</span>
        <span class="k">return</span> <span class="n">drift_correct_entropy</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">indicator_zero_mean</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">entropy_fun</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">indicator_mean</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.peakfind_local_maxima_of_smoothed_hist">
<code class="highlight language-python"><span class="n">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find local maxima in a smoothed histogram of pulse heights.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">peakfind_local_maxima_of_smoothed_hist</span><span class="p">(</span>
    <span class="n">pulse_heights</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SmoothedLocalMaximaResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Find local maxima in a smoothed histogram of pulse heights."""</span>
    <span class="n">pulse_heights</span> <span class="o">=</span> <span class="n">pulse_heights</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_heights</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">"not enough pulses"</span>
    <span class="n">smoothed_counts</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">hist_smoothed</span><span class="p">(</span><span class="n">pulse_heights</span><span class="p">,</span> <span class="n">fwhm_pulse_height_units</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">_step_size</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
    <span class="n">local_maxima_inds</span><span class="p">,</span> <span class="n">local_minima_inds</span> <span class="o">=</span> <span class="n">local_maxima</span><span class="p">(</span><span class="n">smoothed_counts</span><span class="p">)</span>
    <span class="c1"># require a minimum before and after a maximum (the first check is redundant with behavior of local_maxima)</span>
    <span class="k">if</span> <span class="n">local_maxima_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">local_minima_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">local_maxima_inds</span> <span class="o">=</span> <span class="n">local_maxima_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">local_maxima_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">local_minima_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">local_maxima_inds</span> <span class="o">=</span> <span class="n">local_maxima_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SmoothedLocalMaximaResult</span><span class="p">(</span>
        <span class="n">fwhm_pulse_height_units</span><span class="p">,</span>
        <span class="n">bin_centers</span><span class="p">,</span>
        <span class="n">counts</span><span class="p">,</span>
        <span class="n">smoothed_counts</span><span class="p">,</span>
        <span class="n">local_maxima_inds</span><span class="p">,</span>
        <span class="n">local_minima_inds</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.rank_3peak_assignments">
<code class="highlight language-python"><span class="n">rank_3peak_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">line_names</span><span class="p">,</span> <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_gain_fraction_at_ph_30k</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Explore and rank possible assignments of pulse heights to energies when there are 3 or more lines.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rank_3peak_assignments</span><span class="p">(</span>
    <span class="n">ph</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
    <span class="n">e</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
    <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Explore and rank possible assignments of pulse heights to energies when there are 3 or more lines."""</span>
    <span class="c1"># we explore possible line assignments, and down select based on knowledge of gain curve shape</span>
    <span class="c1"># gain = ph/e, and we assume gain starts at zero, decreases with pulse height, and</span>
    <span class="c1"># that a 2nd order polynomial is a reasonably good approximation</span>
    <span class="c1"># with one assignment we model the gain as constant, and use that to find the most likely</span>
    <span class="c1"># 2nd assignments, then we model the gain as linear, and use that to rank 3rd assignments</span>
    <span class="n">dfe</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"e0_ind"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="s2">"e0"</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="n">line_names</span><span class="p">})</span>
    <span class="n">dfph</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"ph0_ind"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="p">)),</span> <span class="s2">"ph0"</span><span class="p">:</span> <span class="n">ph</span><span class="p">})</span>
    <span class="c1"># dfph should know about peak_area and use it to weight choices somehow</span>

    <span class="c1"># 1st assignments ####</span>
    <span class="c1"># e0 and ph0 are the first assignment</span>
    <span class="n">df0</span> <span class="o">=</span> <span class="n">dfe</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfph</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">"cross"</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">gain0</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph0"</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e0"</span><span class="p">))</span>
    <span class="c1"># 2nd assignments ####</span>
    <span class="c1"># e1 and ph1 are the 2nd assignment</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df0</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">"cross"</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">"e0_right"</span><span class="p">:</span> <span class="s2">"e1"</span><span class="p">,</span> <span class="s2">"ph0_right"</span><span class="p">:</span> <span class="s2">"ph1"</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">"e0_ind_right"</span><span class="p">,</span> <span class="s2">"ph0_ind_right"</span><span class="p">,</span> <span class="s2">"gain0_right"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># 1) keep only assignments with e0&lt;e1 and ph0&lt;ph1 to avoid looking at the same pair in reverse</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e0"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e1"</span><span class="p">))</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph0"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph1"</span><span class="p">)))</span>
    <span class="c1"># 2) the gain slope must be negative</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df1</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">gain1</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph1"</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e1"</span><span class="p">))</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">gain_slope</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain1"</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain0"</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph1"</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph0"</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_slope"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># 3) the gain slope should not have too large a magnitude</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">gain_at_0</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain0"</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph0"</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_slope"</span><span class="p">))</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">gain_frac_at_ph30k</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">30000</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_slope"</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_at_0"</span><span class="p">)))</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_frac_at_ph30k"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">)</span>

    <span class="c1"># 3rd assignments ####</span>
    <span class="c1"># e2 and ph2 are the 3rd assignment</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df0</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">e2</span><span class="o">=</span><span class="s2">"e0"</span><span class="p">,</span> <span class="n">ph2</span><span class="o">=</span><span class="s2">"ph0"</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s2">"cross"</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">gain_at_ph2</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_at_0"</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_slope"</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph2"</span><span class="p">))</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">e_at_ph2</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph2"</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"gain_at_ph2"</span><span class="p">))</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e1"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e2"</span><span class="p">))</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph1"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"ph2"</span><span class="p">)))</span>
    <span class="c1"># 1) rank 3rd assignments by energy error at ph2 assuming gain = gain_slope*ph+gain_at_0</span>
    <span class="c1"># where gain_slope and gain are calculated from assignments 1 and 2</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">e_err_at_ph2</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e_at_ph2"</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e2"</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e_err_at_ph2"</span><span class="p">)))</span>
    <span class="c1"># 2) return a dataframe downselected to the assignments and the ranking criteria</span>
    <span class="c1"># 3) throw away assignments with large (default 10%) energy errors</span>
    <span class="n">df3peak</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"e0"</span><span class="p">,</span> <span class="s2">"ph0"</span><span class="p">,</span> <span class="s2">"e1"</span><span class="p">,</span> <span class="s2">"ph1"</span><span class="p">,</span> <span class="s2">"e2"</span><span class="p">,</span> <span class="s2">"ph2"</span><span class="p">,</span> <span class="s2">"e_err_at_ph2"</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e_err_at_ph2"</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"e2"</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">max_fractional_energy_error_3rd_assignment</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df3peak</span><span class="p">,</span> <span class="n">dfe</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.rank_assignments">
<code class="highlight language-python"><span class="n">rank_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Rank possible assignments of pulse heights to energies by how locally linear their implied gain curves are.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rank_assignments</span><span class="p">(</span><span class="n">ph</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Rank possible assignments of pulse heights to energies by how locally linear their implied gain curves are."""</span>
    <span class="c1"># ph is a list of peak heights longer than e</span>
    <span class="c1"># e is a list of known peak energies</span>
    <span class="c1"># we want to find the set of peak heights from ph that are closest to being locally linear with the energies in e</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">ph</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">pha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">))))</span>
    <span class="n">pha_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">))))</span>
    <span class="c1"># pha[i,:] is one choice of len(e) values from ph to assign to e</span>
    <span class="c1"># we use linear interpolation of the form y = y0 + (y1-y0)*(x-x0)/(x1-x0)</span>
    <span class="c1"># on each set of 3 values</span>
    <span class="c1"># with y = e and x = ph</span>
    <span class="c1"># x is pha[:,1:-1], x0 is pha[:,:-2], x1 is pha[:,2:]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">pha</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">e</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">x_m_x0_over_x1_m_x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_m_x0_over_x1_m_x0</span>
    <span class="n">y_expected</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rms_e_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_expected</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># prefer negative slopes for gain</span>
    <span class="c1"># gain_first = ph[0]/e[0]</span>
    <span class="c1"># gain_last = ph[-1]/e[-1]</span>
    <span class="k">return</span> <span class="n">rms_e_residual</span><span class="p">,</span> <span class="n">pha</span><span class="p">,</span> <span class="n">pha_inds</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.smooth_hist_with_gauassian_by_fft">
<code class="highlight language-python"><span class="n">smooth_hist_with_gauassian_by_fft</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Smooth a histogram by convolution with a Gaussian, using FFTs.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">smooth_hist_with_gauassian_by_fft</span><span class="p">(</span><span class="n">hist</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Smooth a histogram by convolution with a Gaussian, using FFTs."""</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">smooth_hist_with_gauassian_by_fft_compute_kernel</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">),</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">*</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.rough_cal.smooth_hist_with_gauassian_by_fft_compute_kernel">
<code class="highlight language-python"><span class="n">smooth_hist_with_gauassian_by_fft_compute_kernel</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute the DFT of a Gaussian kernel for smoothing a histogram.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/rough_cal.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">smooth_hist_with_gauassian_by_fft_compute_kernel</span><span class="p">(</span><span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fwhm_in_bin_number_units</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the DFT of a Gaussian kernel for smoothing a histogram."""</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm_in_bin_number_units</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">tbw</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">tx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">tbw</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kernel</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.truebq_bin"></a>
<div class="doc doc-contents first">
<p>Tools for working with continuous data, as taken by the True Bequerel project.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.TriggerResult">
<code>TriggerResult</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>A trigger result from applying a triggering filter and threshold to a TrueBqBin data source.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TriggerResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A trigger result from applying a triggering filter and threshold to a TrueBqBin data source."""</span>

    <span class="n">data_source</span><span class="p">:</span> <span class="s2">"TrueBqBin"</span>
    <span class="n">filter_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">trig_inds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">limit_samples</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">decimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">offset_raw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_axis_time_s</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a diagnostic plot of the trigger result."""</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># raw (full-resolution) index ranges</span>
        <span class="n">raw_start</span> <span class="o">=</span> <span class="n">offset_raw</span>
        <span class="n">raw_stop</span> <span class="o">=</span> <span class="n">raw_start</span> <span class="o">+</span> <span class="n">n_limit</span> <span class="o">*</span> <span class="n">decimate</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># scaling for x-axis (applied after decimation)</span>
        <span class="n">x_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span> <span class="o">*</span> <span class="n">decimate</span> <span class="k">if</span> <span class="n">x_axis_time_s</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="c1"># raw filter output</span>
        <span class="n">filt_raw</span> <span class="o">=</span> <span class="n">fast_apply_filter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">raw_start</span><span class="p">:</span><span class="n">raw_stop</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_in</span><span class="p">)</span>

        <span class="c1"># decimated data and filter</span>
        <span class="n">data_dec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">raw_start</span><span class="p">:</span><span class="n">raw_stop</span><span class="p">:</span><span class="n">decimate</span><span class="p">]</span>
        <span class="n">filt_dec</span> <span class="o">=</span> <span class="n">filt_raw</span><span class="p">[::</span><span class="n">decimate</span><span class="p">]</span>

        <span class="c1"># truncate to the same length</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_dec</span><span class="p">))</span>
        <span class="n">data_dec</span> <span class="o">=</span> <span class="n">data_dec</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">filt_dec</span> <span class="o">=</span> <span class="n">filt_dec</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

        <span class="c1"># shared x-axis</span>
        <span class="n">x_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_scale</span>

        <span class="c1"># plot data + filter</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">,</span> <span class="n">data_dec</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">,</span> <span class="n">filt_dec</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"filter_out"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"threshold"</span><span class="p">)</span>

        <span class="c1"># trigger indices (raw)  restrict to plotted window  convert to decimated indices</span>
        <span class="n">trig_inds_raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span>
            <span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"trig_inds"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">})</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"trig_inds"</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">raw_start</span><span class="p">,</span> <span class="n">raw_stop</span><span class="p">))</span>
            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">trig_inds_dec</span> <span class="o">=</span> <span class="p">(</span><span class="n">trig_inds_raw</span> <span class="o">-</span> <span class="n">raw_start</span><span class="p">)</span> <span class="o">//</span> <span class="n">decimate</span>
        <span class="c1"># clip to avoid indexing past n</span>
        <span class="n">trig_inds_dec</span> <span class="o">=</span> <span class="n">trig_inds_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="n">filt_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"trig_inds filt"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="n">data_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"trig_inds data"</span><span class="p">)</span>

        <span class="c1"># labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">, trigger result debug plot"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"time with arb offset / s"</span> <span class="k">if</span> <span class="n">x_axis_time_s</span> <span class="k">else</span> <span class="s2">"sample number (decimated)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"signal (arb)"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_noise</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_dead_samples_after_pulse_trigger</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_record_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">max_noise_triggers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoiseChannel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Synthesize a NoiseChannel from the data source by finding time periods without pulse triggers."""</span>
        <span class="n">noise_trigger_inds</span> <span class="o">=</span> <span class="n">get_noise_trigger_inds</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">,</span>
            <span class="n">n_dead_samples_after_pulse_trigger</span><span class="p">,</span>
            <span class="n">n_record_samples</span><span class="p">,</span>
            <span class="n">max_noise_triggers</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">noise_trigger_inds</span><span class="p">[</span><span class="n">noise_trigger_inds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># ensure all inds are greater than 0</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_record_samples</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
        <span class="n">pulses</span> <span class="o">=</span> <span class="n">gather_pulses_from_inds_numpy_contiguous</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">npre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">nsamples</span><span class="o">=</span><span class="n">n_record_samples</span><span class="p">,</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">NoiseChannel</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">header_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">header_df</span><span class="p">,</span>
            <span class="n">frametime_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">noise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_channel_copy_to_memory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">npost</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a Channel object by copying pulse data into memory."""</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_noise</span><span class="p">(</span>
            <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">,</span>
            <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
            <span class="n">max_noise_triggers</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">]</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">npre</span> <span class="o">-</span> <span class="n">npost</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
        <span class="n">pulses</span> <span class="o">=</span> <span class="n">gather_pulses_from_inds_numpy_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="o">=</span><span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">pulses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="s2">"pulses and trig_inds must have the same length"</span>
        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
        <span class="n">ch_header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">channel_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
            <span class="n">npre</span><span class="p">,</span>
            <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">header_df</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ch_header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">),</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_channel_mmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">npost</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a Channel object by memory-mapping pulse data from disk."""</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_noise</span><span class="p">(</span>
            <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">,</span>
            <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
            <span class="n">max_noise_triggers</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">]</span>  <span class="c1"># ensure all inds inbounds</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">npre</span> <span class="o">-</span> <span class="n">npost</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
        <span class="n">pulses</span> <span class="o">=</span> <span class="n">gather_pulses_from_inds_numpy_contiguous_mmap_with_cache</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">npre</span><span class="o">=</span><span class="n">npre</span><span class="p">,</span>
            <span class="n">nsamples</span><span class="o">=</span><span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span>
            <span class="n">bin_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
        <span class="n">ch_header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">channel_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
            <span class="n">npre</span><span class="p">,</span>
            <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">header_df</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ch_header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">),</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.truebq_bin.TriggerResult.get_noise">
<code class="highlight language-python"><span class="n">get_noise</span><span class="p">(</span><span class="n">n_dead_samples_after_pulse_trigger</span><span class="p">,</span> <span class="n">n_record_samples</span><span class="p">,</span> <span class="n">max_noise_triggers</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Synthesize a NoiseChannel from the data source by finding time periods without pulse triggers.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_noise</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_dead_samples_after_pulse_trigger</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_record_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_noise_triggers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoiseChannel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Synthesize a NoiseChannel from the data source by finding time periods without pulse triggers."""</span>
    <span class="n">noise_trigger_inds</span> <span class="o">=</span> <span class="n">get_noise_trigger_inds</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">,</span>
        <span class="n">n_dead_samples_after_pulse_trigger</span><span class="p">,</span>
        <span class="n">n_record_samples</span><span class="p">,</span>
        <span class="n">max_noise_triggers</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">noise_trigger_inds</span><span class="p">[</span><span class="n">noise_trigger_inds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># ensure all inds are greater than 0</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_record_samples</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
    <span class="n">pulses</span> <span class="o">=</span> <span class="n">gather_pulses_from_inds_numpy_contiguous</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">npre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">nsamples</span><span class="o">=</span><span class="n">n_record_samples</span><span class="p">,</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">NoiseChannel</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">header_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">header_df</span><span class="p">,</span>
        <span class="n">frametime_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">noise</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.truebq_bin.TriggerResult.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">decimate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_limit</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">offset_raw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_axis_time_s</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a diagnostic plot of the trigger result.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">decimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">offset_raw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_axis_time_s</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a diagnostic plot of the trigger result."""</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># raw (full-resolution) index ranges</span>
    <span class="n">raw_start</span> <span class="o">=</span> <span class="n">offset_raw</span>
    <span class="n">raw_stop</span> <span class="o">=</span> <span class="n">raw_start</span> <span class="o">+</span> <span class="n">n_limit</span> <span class="o">*</span> <span class="n">decimate</span>

    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># scaling for x-axis (applied after decimation)</span>
    <span class="n">x_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span> <span class="o">*</span> <span class="n">decimate</span> <span class="k">if</span> <span class="n">x_axis_time_s</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="c1"># raw filter output</span>
    <span class="n">filt_raw</span> <span class="o">=</span> <span class="n">fast_apply_filter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">raw_start</span><span class="p">:</span><span class="n">raw_stop</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_in</span><span class="p">)</span>

    <span class="c1"># decimated data and filter</span>
    <span class="n">data_dec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">raw_start</span><span class="p">:</span><span class="n">raw_stop</span><span class="p">:</span><span class="n">decimate</span><span class="p">]</span>
    <span class="n">filt_dec</span> <span class="o">=</span> <span class="n">filt_raw</span><span class="p">[::</span><span class="n">decimate</span><span class="p">]</span>

    <span class="c1"># truncate to the same length</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_dec</span><span class="p">))</span>
    <span class="n">data_dec</span> <span class="o">=</span> <span class="n">data_dec</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">filt_dec</span> <span class="o">=</span> <span class="n">filt_dec</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

    <span class="c1"># shared x-axis</span>
    <span class="n">x_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_scale</span>

    <span class="c1"># plot data + filter</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">,</span> <span class="n">data_dec</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">,</span> <span class="n">filt_dec</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"filter_out"</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"threshold"</span><span class="p">)</span>

    <span class="c1"># trigger indices (raw)  restrict to plotted window  convert to decimated indices</span>
    <span class="n">trig_inds_raw</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pl</span>
        <span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"trig_inds"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">})</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"trig_inds"</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">raw_start</span><span class="p">,</span> <span class="n">raw_stop</span><span class="p">))</span>
        <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
        <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">trig_inds_dec</span> <span class="o">=</span> <span class="p">(</span><span class="n">trig_inds_raw</span> <span class="o">-</span> <span class="n">raw_start</span><span class="p">)</span> <span class="o">//</span> <span class="n">decimate</span>
    <span class="c1"># clip to avoid indexing past n</span>
    <span class="n">trig_inds_dec</span> <span class="o">=</span> <span class="n">trig_inds_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="n">filt_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"trig_inds filt"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="n">data_dec</span><span class="p">[</span><span class="n">trig_inds_dec</span><span class="p">],</span> <span class="s2">"o"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"trig_inds data"</span><span class="p">)</span>

    <span class="c1"># labels</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">, trigger result debug plot"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"time with arb offset / s"</span> <span class="k">if</span> <span class="n">x_axis_time_s</span> <span class="k">else</span> <span class="s2">"sample number (decimated)"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"signal (arb)"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.truebq_bin.TriggerResult.to_channel_copy_to_memory">
<code class="highlight language-python"><span class="n">to_channel_copy_to_memory</span><span class="p">(</span><span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">npost</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a Channel object by copying pulse data into memory.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_channel_copy_to_memory</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">npost</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Channel object by copying pulse data into memory."""</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_noise</span><span class="p">(</span>
        <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">,</span>
        <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
        <span class="n">max_noise_triggers</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">npre</span> <span class="o">-</span> <span class="n">npost</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
    <span class="n">pulses</span> <span class="o">=</span> <span class="n">gather_pulses_from_inds_numpy_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="o">=</span><span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">pulses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="s2">"pulses and trig_inds must have the same length"</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
    <span class="n">ch_header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">channel_number</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="n">npre</span><span class="p">,</span>
        <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">header_df</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ch_header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">),</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ch</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.truebq_bin.TriggerResult.to_channel_mmap">
<code class="highlight language-python"><span class="n">to_channel_mmap</span><span class="p">(</span><span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">npost</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a Channel object by memory-mapping pulse data from disk.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_channel_mmap</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">npost</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a Channel object by memory-mapping pulse data from disk."""</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_noise</span><span class="p">(</span>
        <span class="n">noise_n_dead_samples_after_pulse_trigger</span><span class="p">,</span>
        <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
        <span class="n">max_noise_triggers</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trig_inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">]</span>  <span class="c1"># ensure all inds inbounds</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">npre</span> <span class="o">-</span> <span class="n">npost</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
    <span class="n">pulses</span> <span class="o">=</span> <span class="n">gather_pulses_from_inds_numpy_contiguous_mmap_with_cache</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">npre</span><span class="o">=</span><span class="n">npre</span><span class="p">,</span>
        <span class="n">nsamples</span><span class="o">=</span><span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span>
        <span class="n">bin_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"pulse"</span><span class="p">:</span> <span class="n">pulses</span><span class="p">,</span> <span class="s2">"framecount"</span><span class="p">:</span> <span class="n">inds</span><span class="p">})</span>
    <span class="n">ch_header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">channel_number</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="n">npre</span><span class="p">,</span>
        <span class="n">npre</span> <span class="o">+</span> <span class="n">npost</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">header_df</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ch_header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">),</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ch</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.TrueBqBin">
<code>TrueBqBin</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>Represents a binary data file from the True Bequerel project.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrueBqBin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Represents a binary data file from the True Bequerel project."""</span>

    <span class="n">bin_path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">channel_number</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">header_df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">voltage_scale</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="c1"># the bin file is a continuous data aqusition, untriggered</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bin_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"TrueBqBin"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a TrueBqBin object by memory-mapping the given binary file."""</span>
        <span class="n">bin_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># for when it's named like dev2_ai6</span>
            <span class="n">channel_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># for when it's named like 2A</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">bay2int</span><span class="p">(</span><span class="n">bay</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">                </span><span class="sd">"""Convert a bay name like '2A' to a channel number like 4."""</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bay</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="s2">"ABCD"</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bay</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

            <span class="n">channel_number</span> <span class="o">=</span> <span class="n">bay2int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem</span><span class="p">))</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"_"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="n">header_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sample_rate_hz</span> <span class="o">=</span> <span class="n">header_np</span><span class="p">[</span><span class="s2">"sample_rate_hz"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">header_np</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">68</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">bin_path</span><span class="p">,</span>
            <span class="n">desc</span><span class="p">,</span>
            <span class="n">channel_number</span><span class="p">,</span>
            <span class="n">header_df</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="n">sample_rate_hz</span><span class="p">,</span>
            <span class="n">header_np</span><span class="p">[</span><span class="s2">"voltage_scale"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limit_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriggerResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute trigger indices by applying the given filter and threshold to the data."""</span>
        <span class="k">if</span> <span class="n">limit_hours</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limit_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limit_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit_hours</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
        <span class="n">trig_inds</span> <span class="o">=</span> <span class="n">_fasttrig_filter_trigger_with_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">limit_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TriggerResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">trig_inds</span><span class="p">,</span> <span class="n">limit_samples</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.truebq_bin.TrueBqBin.load">
<code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a TrueBqBin object by memory-mapping the given binary file.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bin_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"TrueBqBin"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a TrueBqBin object by memory-mapping the given binary file."""</span>
    <span class="n">bin_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># for when it's named like dev2_ai6</span>
        <span class="n">channel_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># for when it's named like 2A</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">bay2int</span><span class="p">(</span><span class="n">bay</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Convert a bay name like '2A' to a channel number like 4."""</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bay</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="s2">"ABCD"</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bay</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="n">channel_number</span> <span class="o">=</span> <span class="n">bay2int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem</span><span class="p">))</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"_"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bin_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
    <span class="n">header_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sample_rate_hz</span> <span class="o">=</span> <span class="n">header_np</span><span class="p">[</span><span class="s2">"sample_rate_hz"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">header_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">header_np</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">68</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">bin_path</span><span class="p">,</span>
        <span class="n">desc</span><span class="p">,</span>
        <span class="n">channel_number</span><span class="p">,</span>
        <span class="n">header_df</span><span class="p">,</span>
        <span class="mi">1</span> <span class="o">/</span> <span class="n">sample_rate_hz</span><span class="p">,</span>
        <span class="n">header_np</span><span class="p">[</span><span class="s2">"voltage_scale"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">data</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.truebq_bin.TrueBqBin.trigger">
<code class="highlight language-python"><span class="n">trigger</span><span class="p">(</span><span class="n">filter_in</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">limit_hours</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute trigger indices by applying the given filter and threshold to the data.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limit_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriggerResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute trigger indices by applying the given filter and threshold to the data."""</span>
    <span class="k">if</span> <span class="n">limit_hours</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limit_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">limit_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit_hours</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
    <span class="n">trig_inds</span> <span class="o">=</span> <span class="n">_fasttrig_filter_trigger_with_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">limit_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TriggerResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">trig_inds</span><span class="p">,</span> <span class="n">limit_samples</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.fast_apply_filter">
<code class="highlight language-python"><span class="n">fast_apply_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Apply a filter to the data, returning the filter output.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fast_apply_filter</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply a filter to the data, returning the filter output."""</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_in</span><span class="p">))</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_in</span><span class="p">))</span>
    <span class="nb">filter</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">filter_in</span>
    <span class="n">filter_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
    <span class="n">filter_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">jmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">filter_len</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">jmax</span><span class="p">:</span>
        <span class="n">cache</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">filter_len</span><span class="p">)]</span>
        <span class="n">filter_out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">filter_out</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.fasttrig_filter_trigger">
<code class="highlight language-python"><span class="n">fasttrig_filter_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Apply a filter to the data and return trigger indices where the filter output crosses the threshold.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fasttrig_filter_trigger</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">filter_in</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply a filter to the data and return trigger indices where the filter output crosses the threshold."""</span>
    <span class="k">assert</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"algorithm assumes we trigger with positive threshold, change sign of filter_in to accomodate"</span>
    <span class="n">filter_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_in</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">filter_len</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># njit only likes float64s, so I'm trying to force float64 use without allocating a ton of memory</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_in</span><span class="p">))</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_in</span><span class="p">))</span>
    <span class="nb">filter</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">filter_in</span>
    <span class="c1"># intitalize a,b,c</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cache</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">filter_len</span><span class="p">)]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>  <span class="c1"># won't be used, just need same type</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cache</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">filter_len</span><span class="p">)]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">prog_step</span> <span class="o">=</span> <span class="n">jmax</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="n">prog_ticks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">jmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">%</span> <span class="n">prog_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prog_ticks</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"fasttrig_filter_trigger </span><span class="si">{</span><span class="n">prog_ticks</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="mi">100</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
        <span class="n">cache</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">filter_len</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">ready</span><span class="p">:</span>
            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># hold off on retriggering until we see opposite sign slope</span>
            <span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.filter_and_residual_rms">
<code class="highlight language-python"><span class="n">filter_and_residual_rms</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chosen_filter</span><span class="p">,</span> <span class="n">avg_pulse</span><span class="p">,</span> <span class="n">trig_inds</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">polarity</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Apply a filter to pulses extracted from data at the given trigger indices, returning filter values and residual RMS.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_and_residual_rms</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">chosen_filter</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">avg_pulse</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">trig_inds</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">polarity</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Apply a filter to pulses extracted from data at the given trigger indices, returning filter values and residual RMS."""</span>
    <span class="n">filt_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trig_inds</span><span class="p">))</span>
    <span class="n">residual_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trig_inds</span><span class="p">))</span>
    <span class="n">filt_value_template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trig_inds</span><span class="p">))</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">avg_pulse</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_pulse</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">template</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trig_inds</span><span class="p">)):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">trig_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">npre</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="n">npre</span><span class="p">]</span> <span class="o">*</span> <span class="n">polarity</span>
        <span class="n">pulse</span> <span class="o">-=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">filt_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">chosen_filter</span><span class="p">,</span> <span class="n">pulse</span><span class="p">)</span>
        <span class="n">filt_value_template</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">pulse</span><span class="p">)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">pulse</span> <span class="o">-</span> <span class="n">template</span> <span class="o">*</span> <span class="n">filt_value_template</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">residual_rms_val</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">root_mean_squared</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
        <span class="n">residual_rms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_rms_val</span>
    <span class="k">return</span> <span class="n">filt_value</span><span class="p">,</span> <span class="n">residual_rms</span><span class="p">,</span> <span class="n">filt_value_template</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.gather_pulses_from_inds_numpy_contiguous">
<code class="highlight language-python"><span class="n">gather_pulses_from_inds_numpy_contiguous</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Gather pulses from data at the given trigger indices, returning a contiguous numpy array.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gather_pulses_from_inds_numpy_contiguous</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inds</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Gather pulses from data at the given trigger indices, returning a contiguous numpy array."""</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">),</span> <span class="s2">"all inds must be greater than npre"</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">nsamples</span><span class="p">)),</span> <span class="s2">"all inds must be less than len(data) - nsamples"</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="n">inds</span> <span class="o">-</span> <span class="n">npre</span>  <span class="c1"># shift by npre to start at correct offset</span>
    <span class="n">pulses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">),</span> <span class="n">nsamples</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">offsets</span><span class="p">):</span>
        <span class="n">pulses</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">nsamples</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pulses</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.gather_pulses_from_inds_numpy_contiguous_mmap">
<code class="highlight language-python"><span class="n">gather_pulses_from_inds_numpy_contiguous_mmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">'.mmapped_pulses.npy'</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Gather pulses from data at the given trigger indices, returning a memory-mapped numpy array.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gather_pulses_from_inds_numpy_contiguous_mmap</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inds</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">".mmapped_pulses.npy"</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Gather pulses from data at the given trigger indices, returning a memory-mapped numpy array."""</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">),</span> <span class="s2">"all inds must be greater than npre"</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">nsamples</span><span class="p">)),</span> <span class="s2">"all inds must be less than len(data) - nsamples"</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="n">inds</span> <span class="o">-</span> <span class="n">npre</span>  <span class="c1"># shift by npre to start at correct offset</span>
    <span class="n">pulses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"w+"</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">),</span> <span class="n">nsamples</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">offsets</span><span class="p">):</span>
        <span class="n">pulses</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">nsamples</span><span class="p">]</span>
    <span class="n">pulses</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c1"># re-open the mmap to ensure it is read-only</span>
    <span class="k">del</span> <span class="n">pulses</span>
    <span class="n">pulses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">),</span> <span class="n">nsamples</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pulses</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.gather_pulses_from_inds_numpy_contiguous_mmap_with_cache">
<code class="highlight language-python"><span class="n">gather_pulses_from_inds_numpy_contiguous_mmap_with_cache</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">bin_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Gather pulses from data at the given trigger indices, returning a memory-mapped numpy array, using a cache.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gather_pulses_from_inds_numpy_contiguous_mmap_with_cache</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">npre</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inds</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">bin_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Gather pulses from data at the given trigger indices, returning a memory-mapped numpy array, using a cache."""</span>
    <span class="n">bin_full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&gt;</span> <span class="n">npre</span><span class="p">]</span>  <span class="c1"># ensure all inds inbounds</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">inds</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">nsamples</span><span class="p">)]</span>  <span class="c1"># ensure all inds inbounds</span>
    <span class="n">inds_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">inds</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">to_hash_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">npre</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bin_full_path</span><span class="p">)</span> <span class="o">+</span> <span class="n">inds_hash</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">to_hash_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">".</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.truebq_pulse_cache.npy"</span>
    <span class="n">cache_dir_path</span> <span class="o">=</span> <span class="n">bin_full_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">"_truebq_bin_cache"</span>
    <span class="n">cache_dir_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">cache_dir_path</span> <span class="o">/</span> <span class="n">fname</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="c1"># check if the file is the right size</span>
        <span class="n">Nbytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">*</span> <span class="n">nsamples</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># 2 bytes per int16</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">!=</span> <span class="n">Nbytes</span><span class="p">:</span>
            <span class="c1"># on windows the error if the file is the wrong size makes it sound like you don't have enough memory</span>
            <span class="c1"># and python doesn't seem to catch the exception, so we check the size here</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pulse cache is corrupted, re-gathering pulses for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">cache_hit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_hit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cache_hit</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">cache_hit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pulse cache hit for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="n">nsamples</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pulse cache miss for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gather_pulses_from_inds_numpy_contiguous_mmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">npre</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.get_noise_trigger_inds">
<code class="highlight language-python"><span class="n">get_noise_trigger_inds</span><span class="p">(</span><span class="n">pulse_trigger_inds</span><span class="p">,</span> <span class="n">n_dead_samples_after_previous_pulse</span><span class="p">,</span> <span class="n">n_record_samples</span><span class="p">,</span> <span class="n">max_noise_triggers</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Get trigger indices for noise periods, avoiding pulses.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_noise_trigger_inds</span><span class="p">(</span>
    <span class="n">pulse_trigger_inds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">n_dead_samples_after_previous_pulse</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_record_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_noise_triggers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Get trigger indices for noise periods, avoiding pulses."""</span>
    <span class="n">pulse_trigger_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pulse_trigger_inds</span><span class="p">)</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pulse_trigger_inds</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">diffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">n_dead_samples_after_previous_pulse</span><span class="p">:</span>
            <span class="n">n_make</span> <span class="o">=</span> <span class="p">(</span><span class="n">diffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_dead_samples_after_previous_pulse</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_record_samples</span>
            <span class="n">ind0</span> <span class="o">=</span> <span class="n">pulse_trigger_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_dead_samples_after_previous_pulse</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_make</span><span class="p">):</span>
                <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind0</span> <span class="o">+</span> <span class="n">n_record_samples</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_noise_triggers</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.truebq_bin.write_truebq_bin_file">
<code class="highlight language-python"><span class="n">write_truebq_bin_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sample_rate_hz</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">voltage_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">format_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">schema_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_reduction_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">acquisition_flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop_time</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Write a binary file that can be opened by TrueBqBin.load().</p>
<p>This function writes data efficiently without copying by using memory mapping
and direct file operations.</p>
<p>Args:
    path: Output file path
    data: Data array to write (will be converted to int16 if not already)
    sample_rate_hz: Sample rate in Hz
    voltage_scale: Voltage scaling factor
    format_version: File format version (default: 1)
    schema_version: Schema version (default: 1)
    data_reduction_factor: Data reduction factor (default: 1)
    acquisition_flags: Acquisition flags (default: 0)
    start_time: Start time as uint64 array of length 2 (optional)
    stop_time: Stop time as uint64 array of length 2 (optional)</p>
<details class="quote">
<summary>Source code in <code>mass2/core/truebq_bin.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_truebq_bin_file</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">sample_rate_hz</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>  <span class="c1"># force keyword only</span>
    <span class="n">voltage_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">format_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">schema_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">data_reduction_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">acquisition_flags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">stop_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Write a binary file that can be opened by TrueBqBin.load().</span>

<span class="sd">    This function writes data efficiently without copying by using memory mapping</span>
<span class="sd">    and direct file operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Output file path</span>
<span class="sd">        data: Data array to write (will be converted to int16 if not already)</span>
<span class="sd">        sample_rate_hz: Sample rate in Hz</span>
<span class="sd">        voltage_scale: Voltage scaling factor</span>
<span class="sd">        format_version: File format version (default: 1)</span>
<span class="sd">        schema_version: Schema version (default: 1)</span>
<span class="sd">        data_reduction_factor: Data reduction factor (default: 1)</span>
<span class="sd">        acquisition_flags: Acquisition flags (default: 0)</span>
<span class="sd">        start_time: Start time as uint64 array of length 2 (optional)</span>
<span class="sd">        stop_time: Stop time as uint64 array of length 2 (optional)</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Ensure data is int16 (convert if necessary, but avoid unnecessary copying)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s2">"safe"</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Warning: Converting data from </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> to int16 may cause data loss"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

    <span class="c1"># Prepare header</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Default time values if not provided</span>
    <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>

    <span class="c1"># Create header array</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">format_version</span><span class="p">,</span>
                <span class="n">schema_version</span><span class="p">,</span>
                <span class="n">sample_rate_hz</span><span class="p">,</span>
                <span class="n">data_reduction_factor</span><span class="p">,</span>
                <span class="n">voltage_scale</span><span class="p">,</span>
                <span class="n">acquisition_flags</span><span class="p">,</span>
                <span class="n">start_time</span><span class="p">,</span>
                <span class="n">stop_time</span><span class="p">,</span>
                <span class="n">num_samples</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create the file with the correct size</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Write header</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>

        <span class="c1"># For large data arrays, write in chunks to avoid memory issues</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 1MB chunks</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">&lt;=</span> <span class="n">chunk_size</span><span class="p">:</span>
            <span class="c1"># Small data, write directly</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Large data, write in chunks</span>
            <span class="n">data_flat</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>  <span class="c1"># Flatten without copying if possible</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_flat</span><span class="p">),</span> <span class="n">chunk_size</span> <span class="o">//</span> <span class="n">data</span><span class="o">.</span><span class="n">itemsize</span><span class="p">):</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">data_flat</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">//</span> <span class="n">data</span><span class="o">.</span><span class="n">itemsize</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.utilities"></a>
<div class="doc doc-contents first">
<p>Various utility functions and classes:</p>
<ul>
<li>MouseClickReader: a class to use as a callback for reading mouse click
    locations in matplotlib plots.</li>
<li>InlineUpdater: a class that loops over a generator and prints a message to
    the terminal each time it yields.</li>
</ul>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.utilities.InlineUpdater">
<code>InlineUpdater</code>
</h2>
<div class="doc doc-contents">
<p>A class to print progress updates to the terminal.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/utilities.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InlineUpdater</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A class to print progress updates to the terminal."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseString</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minElapseTimeForCalc</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseString</span> <span class="o">=</span> <span class="n">baseString</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"mass"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fracDone</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update the progress to the given fraction done."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span> <span class="o">=</span> <span class="n">fracDone</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\r</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseString</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100.0</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% done, estimated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeRemainingStr</span><span class="si">}</span><span class="s2"> left"</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fracDone</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseString</span><span class="si">}</span><span class="s2"> finished in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">elapsedTimeStr</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeRemaining</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Estimate of time remaining in seconds, or -1 if not enough information yet."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elapsedTimeSec</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minElapseTimeForCalc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fracRemaining</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">elapsedTimeSec</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fracRemaining</span> <span class="o">/</span> <span class="n">rate</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">timeRemainingStr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""String version of time-remaining estimate."""</span>
        <span class="n">timeRemaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeRemaining</span>
        <span class="k">if</span> <span class="n">timeRemaining</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"?"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"</span><span class="si">%.1f</span><span class="s2"> min"</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeRemaining</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">elapsedTimeSec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Elapsed time in seconds since the creation of this object."""</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">elapsedTimeStr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""String version of elapsed time."""</span>
        <span class="k">return</span> <span class="s2">"</span><span class="si">%.1f</span><span class="s2"> min"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elapsedTimeSec</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.utilities.InlineUpdater.elapsedTimeSec">
<code class="highlight language-python"><span class="n">elapsedTimeSec</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Elapsed time in seconds since the creation of this object.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.utilities.InlineUpdater.elapsedTimeStr">
<code class="highlight language-python"><span class="n">elapsedTimeStr</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>String version of elapsed time.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.utilities.InlineUpdater.timeRemaining">
<code class="highlight language-python"><span class="n">timeRemaining</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Estimate of time remaining in seconds, or -1 if not enough information yet.</p>
</div>
</div>
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.utilities.InlineUpdater.timeRemainingStr">
<code class="highlight language-python"><span class="n">timeRemainingStr</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>String version of time-remaining estimate.</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.utilities.InlineUpdater.update">
<code class="highlight language-python"><span class="n">update</span><span class="p">(</span><span class="n">fracDone</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Update the progress to the given fraction done.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/utilities.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fracDone</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Update the progress to the given fraction done."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span> <span class="o">=</span> <span class="n">fracDone</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\r</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseString</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fracDone</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100.0</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% done, estimated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeRemainingStr</span><span class="si">}</span><span class="s2"> left"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fracDone</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">baseString</span><span class="si">}</span><span class="s2"> finished in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">elapsedTimeStr</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.utilities.NullUpdater">
<code>NullUpdater</code>
</h2>
<div class="doc doc-contents">
<p>A do-nothing updater class with the same API as InlineUpdater.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/utilities.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NullUpdater</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A do-nothing updater class with the same API as InlineUpdater."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Do nothing."""</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.utilities.NullUpdater.update">
<code class="highlight language-python"><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Do nothing.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/utilities.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Do nothing."""</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.utilities.show_progress">
<code class="highlight language-python"><span class="n">show_progress</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>A decorator to show progress updates for another function.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/utilities.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_progress</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A decorator to show progress updates for another function."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""A decorator to show progress updates for another function."""</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">"""Update the progress of the wrapped function."""</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">"sphinx"</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>  <span class="c1"># supress output during doctests</span>
                    <span class="n">print_updater</span> <span class="o">=</span> <span class="n">NullUpdater</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_updater</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updater</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">print_updater</span> <span class="o">=</span> <span class="n">NullUpdater</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">print_updater</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span>

    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h2 id="other-docstrings">Other docstrings</h2>
<p>See also <a href="../docstrings2/">Other docstrings</a> for modules other than <code>mass2.core</code>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../LJHfiles/" class="btn btn-neutral float-left" title="LJH file format"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../docstrings2/" class="btn btn-neutral float-right" title="Other docstrings">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../LJHfiles/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../docstrings2/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
