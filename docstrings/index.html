<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://usnistgov.github.io/mass2/docstrings/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Docstrings - Mass2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Docstrings";
        var mkdocs_page_input_path = "docstrings.md";
        var mkdocs_page_url = "/mass2/docstrings/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Mass2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting_started/">Getting started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../demo_plot/">Demo plot</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../filtering/">Optimal filtering</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Fluorescence lines</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../fluorescence/">Atomic fluorescence</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../line_fitting/">Line fitting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hci_lines_from_asd/">Highly-charge ion lines</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../xray_efficiency_models/">X-ray efficiency models</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Digging deeper</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../LJHfiles/">LJH file format</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Docstrings</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channel">channel</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channel.Channel">Channel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.plot_hists">plot_hists</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.plot_summaries">plot_summaries</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_column_map_step">with_column_map_step</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_good_expr_below_nsigma_outlier_resistant">with_good_expr_below_nsigma_outlier_resistant</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_good_expr_nsigma_range_outlier_resistant">with_good_expr_nsigma_range_outlier_resistant</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channel.Channel.with_select_step">with_select_step</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channels">channels</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.channels.Channels">Channels</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.from_ljh_path_pairs">from_ljh_path_pairs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.plot_hists">plot_hists</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.channels.Channels.save_recipes">save_recipes</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms">analysis_algorithms</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.HistogramSmoother">HistogramSmoother</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.analysis_algorithms.HistogramSmoother.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.analysis_algorithms.HistogramSmoother.__init__">__init__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.compute_max_deriv">compute_max_deriv</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.correct_flux_jumps">correct_flux_jumps</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.correct_flux_jumps_original">correct_flux_jumps_original</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.drift_correct">drift_correct</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.estimateRiseTime">estimateRiseTime</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.filter_signal_lowpass">filter_signal_lowpass</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.make_smooth_histogram">make_smooth_histogram</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.nearest_arrivals">nearest_arrivals</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.time_drift_correct">time_drift_correct</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.analysis_algorithms.unwrap_n">unwrap_n</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe">recipe</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.ColumnAsNumpyMapStep">ColumnAsNumpyMapStep</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.Recipe">Recipe</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.calc_from_df">calc_from_df</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.Recipe.trim_dead_ends">trim_dead_ends</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.RecipeStep">RecipeStep</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.recipe.RecipeStep.drop_debug">drop_debug</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.recipe.SelectStep">SelectStep</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.drift_correction">drift_correction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.filter_steps">filter_steps</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering">optimal_filtering</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter">Filter</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.plot">plot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter.report">report</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag">Filter5Lag</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.Filter5Lag.filter_records">filter_records</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS">FilterATS</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS.is_arrival_time_safe">is_arrival_time_safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterATS.filter_records">filter_records</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker">FilterMaker</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_5lag">compute_5lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_5lag_noexp">compute_5lag_noexp</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_ats">compute_ats</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_constrained_5lag">compute_constrained_5lag</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.FilterMaker.compute_fourier">compute_fourier</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener">ToeplitzWhitener</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.W">W</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.__call__">__call__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.applyWT">applyWT</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.solveW">solveW</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.solveWT">solveWT</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mass2.core.optimal_filtering.ToeplitzWhitener.whiten">whiten</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.band_limit">band_limit</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mass2.core.optimal_filtering.bracketR">bracketR</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hci-lines">HCI lines</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">Testing</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mass2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Digging deeper</li>
      <li class="breadcrumb-item active">Docstrings</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="automatic-documentation-generated-from-docstrings">Automatic documentation generated from docstrings</h1>
<div class="doc doc-object doc-module">
<a id="mass2.core.channel"></a>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.channel.Channel">
<code>Channel</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PLR0904</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Channel</span><span class="p">:</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">ChannelHeader</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">npulses</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">subframediv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">noise</span><span class="p">:</span> <span class="n">NoiseChannel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">)</span>
    <span class="n">df_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">steps</span><span class="p">:</span> <span class="n">Recipe</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Recipe</span><span class="o">.</span><span class="n">new_empty</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">steps_elapsed_s</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shortname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mo_stepplots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">:</span>
        <span class="n">desc_ind</span> <span class="o">=</span> <span class="p">{</span><span class="n">step</span><span class="o">.</span><span class="n">description</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)}</span>
        <span class="n">first_non_summarize_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">SummarizeStep</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">first_non_summarize_step</span> <span class="o">=</span> <span class="n">step</span>
            <span class="k">break</span>
        <span class="n">mo_ui</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">(</span>
            <span class="n">desc_ind</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">first_non_summarize_step</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"choose step for ch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">Html</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mo_stepplots_explicit</span><span class="p">(</span><span class="n">mo_ui</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">step_ind</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mo_ui</span><span class="o">.</span><span class="n">value</span>

        <span class="n">mo_ui</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span>
        <span class="n">mo_ui</span><span class="o">.</span><span class="n">step_ind</span> <span class="o">=</span> <span class="n">step_ind</span>
        <span class="k">return</span> <span class="n">mo_ui</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mo_stepplots_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_ui</span><span class="p">:</span> <span class="n">mo</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">dropdown</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="n">Html</span><span class="p">:</span>
        <span class="n">step_ind</span> <span class="o">=</span> <span class="n">mo_ui</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_plot</span><span class="p">(</span><span class="n">step_ind</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mo</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">mo_ui</span><span class="p">,</span> <span class="n">misc</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># normalize the index to a positive index</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">step</span><span class="p">,</span> <span class="n">index</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
        <span class="n">step</span><span class="p">,</span> <span class="n">step_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step</span><span class="p">(</span><span class="n">step_ind</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step_ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_history</span><span class="p">):</span>
            <span class="n">df_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_history</span><span class="p">[</span><span class="n">step_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">step</span><span class="o">.</span><span class="n">dbg_plot</span><span class="p">(</span><span class="n">df_after</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
            <span class="c1"># so we special case True</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

        <span class="c1"># Group by the specified column and filter using good_expr</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="n">use_good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">)</span>

        <span class="c1"># Customize the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - col (str): The column name to plot.</span>
<span class="sd">        - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">        - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">        - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
            <span class="c1"># so we special case True</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

        <span class="c1"># Group by the specified column and filter using good_expr</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot a histogram for each group</span>
        <span class="n">counts_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Get the data for the column to plot</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
            <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
            <span class="n">group_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
            <span class="n">counts_dict</span><span class="p">[</span><span class="n">group_name_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group_name_str</span><span class="p">)</span>
            <span class="c1"># Plot the histogram for the current group</span>
            <span class="c1"># if group_name == "EBIT":</span>
            <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.9, color="k", label=group_name_str)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.5, label=group_name_str)</span>
            <span class="c1"># bin_centers, counts = misc.hist_of_series(values, bin_edges)</span>
            <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>
        <span class="c1"># Customize the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Add a legend to label the groups</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_scatter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">y_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">color_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>  <span class="c1"># set current axis so I can use plt api</span>
        <span class="k">if</span> <span class="n">use_good_expr</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">color_col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,),</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">color_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span> <span class="ow">and</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">y_col</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span>
                <span class="s2">"."</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_col</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_col</span><span class="p">))</span>
        <span class="n">title_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"""</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span><span class="si">}</span>
<span class="s2">        use_expr=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="si">}</span>
<span class="s2">        good_expr=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="si">}</span><span class="s2">"""</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">color_col</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">good_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">good_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rough_cal_combinatoric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_combinatoric</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">uncalibrated_col</span><span class="o">=</span><span class="n">uncalibrated_col</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">ph_smoothing_fwhm</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">,</span>
            <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rough_cal_combinatoric_height_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">line_heights_allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ph_smoothing_fwhm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_combinatoric_height_info</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">line_heights_allowed</span><span class="p">,</span>
            <span class="n">uncalibrated_col</span><span class="o">=</span><span class="n">uncalibrated_col</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">ph_smoothing_fwhm</span><span class="o">=</span><span class="n">ph_smoothing_fwhm</span><span class="p">,</span>
            <span class="n">n_extra</span><span class="o">=</span><span class="n">n_extra</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rough_cal</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">uncalibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"filtValue"</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">alwaysTrue</span><span class="p">),</span>
        <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">fwhm_pulse_height_units</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">75</span><span class="p">,</span>
        <span class="n">n_extra_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">acceptable_rms_residual_e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">RoughCalibrationStep</span><span class="o">.</span><span class="n">learn_3peak</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">uncalibrated_col</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="p">,</span>
            <span class="n">max_fractional_energy_error_3rd_assignment</span><span class="p">,</span>
            <span class="n">min_gain_fraction_at_ph_30k</span><span class="p">,</span>
            <span class="n">fwhm_pulse_height_units</span><span class="p">,</span>
            <span class="n">n_extra_peaks</span><span class="p">,</span>
            <span class="n">acceptable_rms_residual_e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">RecipeStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">elapsed_s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">df_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_history</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">],</span>
            <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
            <span class="n">steps_elapsed_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_elapsed_s</span> <span class="o">+</span> <span class="p">[</span><span class="n">elapsed_s</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="n">Recipe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="n">ch2</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="c1"># the default value of self.good_expr is pl.lit(True)</span>
        <span class="c1"># and_(True) will just add visual noise when looking at good_expr and not affect behavior</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span> <span class="ow">and</span> <span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_expr</span><span class="o">=</span><span class="n">good_expr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_column_map_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""f should take a numpy array and return a numpy array with the same number of elements"""</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">ColumnAsNumpyMapStep</span><span class="p">([</span><span class="n">input_col</span><span class="p">],</span> <span class="p">[</span><span class="n">output_col</span><span class="p">],</span> <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_pretrig_rms_and_postpeak_deriv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n_sigma_pretrig_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_sigma_postpeak_deriv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">max_postpeak_deriv</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"postpeak_deriv"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_postpeak_deriv</span>
        <span class="p">)</span>
        <span class="n">max_pretrig_rms</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"pretrig_rms"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_pretrig_rms</span><span class="p">)</span>
        <span class="n">good_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_postpeak_deriv</span><span class="p">)</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_pretrig_rms</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_range_around_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">range_up</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">range_down</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">med</span> <span class="o">-</span> <span class="n">range_down</span><span class="p">,</span> <span class="n">med</span> <span class="o">+</span> <span class="n">range_up</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_below_nsigma_outlier_resistant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        always sets lower limit at 0, don't use for values that can be negative</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
            <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
            <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_nsigma_range_outlier_resistant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        always sets lower limit at 0, don't use for values that can be negative</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
            <span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_range_from_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
            <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">typical_peak_ind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_pulses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">pretrigger_ignore_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">peak_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">peak_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peak_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">result_dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="c1"># mypy (incorrectly) thinks `out_names` might be None, and `list(None)` is forbidden. Assertion makes it happy again.</span>
        <span class="k">assert</span> <span class="n">out_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_names</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">SummarizeStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">frametime_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
            <span class="n">peak_index</span><span class="o">=</span><span class="n">peak_index</span><span class="p">,</span>
            <span class="n">pulse_col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">pretrigger_ignore_samples</span><span class="o">=</span><span class="n">pretrigger_ignore_samples</span><span class="p">,</span>
            <span class="n">n_presamples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
            <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct_pretrig_mean_jumps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="n">corrected</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"ptm_jf"</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">PretrigMeanJumpFixStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">uncorrected</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">corrected</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_select_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_expr_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</span>
<span class="sd">        """</span>
        <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">col_expr_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">SelectStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
            <span class="n">output</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">col_expr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">col_expr_dict</span><span class="o">=</span><span class="n">col_expr_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_categorize_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_condition_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">],</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"category"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="c1"># ensure the first condition is True, to be used as a fallback</span>
        <span class="n">first_expr</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_expr</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">category_condition_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"fallback"</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="o">**</span><span class="n">category_condition_dict</span><span class="p">}</span>
        <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">category_condition_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">CategorizeStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">output_col</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">category_condition_dict</span><span class="o">=</span><span class="n">category_condition_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter5lag</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pulse_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span>
        <span class="n">peak_y_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagy"</span><span class="p">,</span>
        <span class="n">peak_x_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagx"</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">25e3</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">avg_pulse</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pulse_col</span><span class="p">)</span>
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">avg_pulse</span> <span class="o">-=</span> <span class="n">avg_pulse</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
        <span class="n">spectrum5lag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">spectrum</span><span class="p">(</span><span class="n">trunc_front</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_back</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">filter_maker</span> <span class="o">=</span> <span class="n">FilterMaker</span><span class="p">(</span>
            <span class="n">signal_model</span><span class="o">=</span><span class="n">avg_pulse</span><span class="p">,</span>
            <span class="n">n_pretrigger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span>
            <span class="n">noise_psd</span><span class="o">=</span><span class="n">spectrum5lag</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span>
            <span class="n">noise_autocorr</span><span class="o">=</span><span class="n">spectrum5lag</span><span class="o">.</span><span class="n">autocorr_vec</span><span class="p">,</span>
            <span class="n">sample_time_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter5lag</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_5lag</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter5lag</span> <span class="o">=</span> <span class="n">filter_maker</span><span class="o">.</span><span class="n">compute_5lag_noexp</span><span class="p">(</span><span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="o">=</span><span class="n">time_constant_s_of_exp_to_be_orthogonal_to</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Filter5LagStep</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">"pulse"</span><span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">peak_x_col</span><span class="p">,</span> <span class="n">peak_y_col</span><span class="p">],</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">filter5lag</span><span class="p">,</span>
            <span class="n">spectrum</span><span class="o">=</span><span class="n">spectrum5lag</span><span class="p">,</span>
            <span class="n">filter_maker</span><span class="o">=</span><span class="n">filter_maker</span><span class="p">,</span>
            <span class="n">transform_raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_raw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">good_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">good_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">good_df</span> <span class="o">=</span> <span class="n">good_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">good_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bad_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">bad_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">not_</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bad_df</span> <span class="o">=</span> <span class="n">bad_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bad_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">good_serieses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_df</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">df2</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">driftcorrect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pretrig_mean"</span><span class="p">,</span>
        <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"5lagy"</span><span class="p">,</span>
        <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="c1"># by defining a seperate learn method that takes ch as an argument,</span>
        <span class="c1"># we can move all the code for the step outside of Channel</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">DriftCorrectStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
            <span class="n">ch</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">indicator_col</span><span class="o">=</span><span class="n">indicator_col</span><span class="p">,</span>
            <span class="n">uncorrected_col</span><span class="o">=</span><span class="n">uncorrected_col</span><span class="p">,</span>
            <span class="n">corrected_col</span><span class="o">=</span><span class="n">corrected_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linefit</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="n">GenericLineModel</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
        <span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pe</span> <span class="o">-</span> <span class="n">dlo</span><span class="p">,</span> <span class="n">pe</span> <span class="o">+</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_bin_edges</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"before update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_update</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"after update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">ds_shortname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
            <span class="n">attr_str</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">use_expr</span><span class="si">=}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_elapsed_s</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="c1"># only checks if the ids match, does not try to be equal if all contents are equal</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">noise_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_posix_usec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">transform_raw</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">noise_path</span><span class="p">:</span>
            <span class="n">noise_channel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">noise_channel</span> <span class="o">=</span> <span class="n">NoiseChannel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">noise_path</span><span class="p">)</span>
        <span class="n">ljh</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">LJHFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">header_df</span> <span class="o">=</span> <span class="n">ljh</span><span class="o">.</span><span class="n">to_polars</span><span class="p">(</span><span class="n">keep_posix_usec</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="o">.</span><span class="n">from_ljh_header_df</span><span class="p">(</span><span class="n">header_df</span><span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">npulses</span><span class="o">=</span><span class="n">ljh</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span> <span class="n">subframediv</span><span class="o">=</span><span class="n">ljh</span><span class="o">.</span><span class="n">subframediv</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise_channel</span><span class="p">,</span> <span class="n">transform_raw</span><span class="o">=</span><span class="n">transform_raw</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_off</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">off</span><span class="p">:</span> <span class="n">OffFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"ns"</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">df_header</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">df_header</span> <span class="o">=</span> <span class="n">df_header</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">"Filename"</span><span class="p">,</span> <span class="p">[</span><span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">]))</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ChannelHeader</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">off</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"ChannelNumberMatchingName"</span><span class="p">],</span>
            <span class="n">off</span><span class="o">.</span><span class="n">framePeriodSeconds</span><span class="p">,</span>
            <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"recordPreSamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">off</span><span class="o">.</span><span class="n">_mmap</span><span class="p">[</span><span class="s2">"recordSamples"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">df_header</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">off</span><span class="o">.</span><span class="n">nRecords</span><span class="p">,</span> <span class="n">subframediv</span><span class="o">=</span><span class="n">off</span><span class="o">.</span><span class="n">subframediv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_es</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">force_timestamp_monotonic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">is_sorted</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span><span class="o">.</span><span class="n">cum_max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)))</span>
            <span class="c1"># print("WARNING: in with_experiment_state_df, timestamp is not monotonic, forcing it to be")</span>
            <span class="c1"># print("This is likely a BUG in DASTARD.")</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_es</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"timestamp"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"backward"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_ext</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">subframecount</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"framecount"</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_ext</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"backward"</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"_prev_ext_trig"</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join_asof</span><span class="p">(</span><span class="n">df_ext</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">"subframecount"</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">"forward"</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">"_next_ext_trig"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_replacement_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">df3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">df3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">multifit_quadratic_gain_cal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">MultiFitQuadraticGainStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">multifit_spec</span><span class="o">=</span><span class="n">multifit</span><span class="p">,</span>
            <span class="n">previous_cal_step_index</span><span class="o">=</span><span class="n">previous_cal_step_index</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">multifit_mass_cal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multifit</span><span class="p">:</span> <span class="n">MultiFit</span><span class="p">,</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">calibrated_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">MultiFitMassCalibrationStep</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">multifit_spec</span><span class="o">=</span><span class="n">multifit</span><span class="p">,</span>
            <span class="n">previous_cal_step_index</span><span class="o">=</span><span class="n">previous_cal_step_index</span><span class="p">,</span>
            <span class="n">calibrated_col</span><span class="o">=</span><span class="n">calibrated_col</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="o">=</span><span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concat_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span>
            <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="p">,</span>
            <span class="n">subframediv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subframediv</span><span class="p">,</span>
            <span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span>
            <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># we won't copy over df_history and steps. I don't think you should use this when those are filled in?</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concat_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="s2">"Channel"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat_df</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">phase_correct_mass_specific_lines</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">indicator_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">uncorrected_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">line_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">previous_cal_step_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">corrected_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">corrected_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">corrected_col</span> <span class="o">=</span> <span class="n">uncorrected_col</span> <span class="o">+</span> <span class="s2">"_pc"</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">phase_correct_steps</span><span class="o">.</span><span class="n">phase_correct_mass_specific_lines</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">indicator_col</span><span class="p">,</span>
            <span class="n">uncorrected_col</span><span class="p">,</span>
            <span class="n">corrected_col</span><span class="p">,</span>
            <span class="n">previous_cal_step_index</span><span class="p">,</span>
            <span class="n">line_names</span><span class="p">,</span>
            <span class="n">use_expr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"BadChannel"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BadChannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_expr_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">downsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Plot a summary of the data set, including time series and histograms of key pulse properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_expr_in : pl.Expr | None, optional</span>
<span class="sd">            A polars expression to determine valid pulses, by default None. If None, use `self.good_expr`</span>
<span class="sd">        downsample : int | None, optional</span>
<span class="sd">            Plot only every one of `downsample` pulses in the scatter plots, by default None.</span>
<span class="sd">            If None, choose the smallest value so that no more than 10000 points appear</span>
<span class="sd">        log : bool, optional</span>
<span class="sd">            Whether to make the histograms have a logarithmic y-scale, by default False.</span>
<span class="sd">        """</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">tpi_microsec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
        <span class="n">plottables</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="s2">"Pulse RMS"</span><span class="p">,</span> <span class="s2">"#dd00ff"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pulse_average"</span><span class="p">,</span> <span class="s2">"Pulse Avg"</span><span class="p">,</span> <span class="s2">"purple"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"peak_value"</span><span class="p">,</span> <span class="s2">"Peak value"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">,</span> <span class="s2">"Pretrig RMS"</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="s2">"Pretrig Mean"</span><span class="p">,</span> <span class="s2">"#00ff26"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">,</span> <span class="s2">"Max PostPk deriv"</span><span class="p">,</span> <span class="s2">"gold"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">,</span> <span class="s2">"Rise time (s)"</span><span class="p">,</span> <span class="s2">"orange"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">,</span> <span class="s2">"Peak time (s)"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">use_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="k">if</span> <span class="n">use_expr_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">use_expr_in</span>

        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">//</span> <span class="mi">10000</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">downsample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">gather_every</span><span class="p">(</span><span class="n">downsample</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"peak_index"</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"rise_time"</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">))</span>
        <span class="n">existing_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
        <span class="n">preserve</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plottables</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">]</span>
        <span class="n">preserve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">preserve</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Plot timeseries relative to 0 = the last 00 UT during or before the run.</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">last_midnight</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"datetime64[D]"</span><span class="p">)</span>
        <span class="n">hour_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">last_midnight</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600e6</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plottables</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="c1"># Time series scatter plots (left-hand panels)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hour_rel</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Time since last UT midnight (hours)"</span><span class="p">)</span>

            <span class="c1"># Histogram (right-hand panels)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">contents</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">"stepfilled"</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">contents</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Plotting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="si">}</span><span class="s2"> data points"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">pulse_algorithms</span><span class="o">.</span><span class="n">fit_pulse_2exp_with_tail</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npre</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ch=</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pulse index=</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.plot_hists">
<code class="highlight language-python"><span class="n">plot_hists</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">skip_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plots histograms for the given column, grouped by the specified column.</p>
<p>Parameters:
- col (str): The column name to plot.
- bin_edges (array-like): The edges of the bins for the histogram.
- group_by_col (str): The column name to group by. This is required.
- axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - col (str): The column name to plot.</span>
<span class="sd">    - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">    - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">    - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

    <span class="k">if</span> <span class="n">use_good_expr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># True doesn't implement .and_, haven't found a exper literal equivalent that does</span>
        <span class="c1"># so we special case True</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_expr</span> <span class="o">=</span> <span class="n">use_expr</span>

    <span class="c1"># Group by the specified column and filter using good_expr</span>
    <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Plot a histogram for each group</span>
    <span class="n">counts_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get the data for the column to plot</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">midpoints_and_step_size</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">group_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="n">counts_dict</span><span class="p">[</span><span class="n">group_name_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">"mid"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group_name_str</span><span class="p">)</span>
        <span class="c1"># Plot the histogram for the current group</span>
        <span class="c1"># if group_name == "EBIT":</span>
        <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.9, color="k", label=group_name_str)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     ax.hist(values, bins=bin_edges, alpha=0.5, label=group_name_str)</span>
        <span class="c1"># bin_centers, counts = misc.hist_of_series(values, bin_edges)</span>
        <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>
    <span class="c1"># Customize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Counts per </span><span class="si">{</span><span class="n">step_size</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2"> unit bin"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Add a legend to label the groups</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts_dict</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.plot_summaries">
<code class="highlight language-python"><span class="n">plot_summaries</span><span class="p">(</span><span class="n">use_expr_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plot a summary of the data set, including time series and histograms of key pulse properties.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>use_expr_in</code></b>
                  (<code><span title="polars.Expr">Expr</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A polars expression to determine valid pulses, by default None. If None, use <code>self.good_expr</code></p>
</div>
</li>
<li>
<b><code>downsample</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>Plot only every one of <code>downsample</code> pulses in the scatter plots, by default None.
If None, choose the smallest value so that no more than 10000 points appear</p>
</div>
</li>
<li>
<b><code>log</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              
              <div class="doc-md-description">
<p>Whether to make the histograms have a logarithmic y-scale, by default False.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_expr_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">downsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Plot a summary of the data set, including time series and histograms of key pulse properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    use_expr_in : pl.Expr | None, optional</span>
<span class="sd">        A polars expression to determine valid pulses, by default None. If None, use `self.good_expr`</span>
<span class="sd">    downsample : int | None, optional</span>
<span class="sd">        Plot only every one of `downsample` pulses in the scatter plots, by default None.</span>
<span class="sd">        If None, choose the smallest value so that no more than 10000 points appear</span>
<span class="sd">    log : bool, optional</span>
<span class="sd">        Whether to make the histograms have a logarithmic y-scale, by default False.</span>
<span class="sd">    """</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">tpi_microsec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_peak_ind</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">)</span>
    <span class="n">plottables</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s2">"pulse_rms"</span><span class="p">,</span> <span class="s2">"Pulse RMS"</span><span class="p">,</span> <span class="s2">"#dd00ff"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"pulse_average"</span><span class="p">,</span> <span class="s2">"Pulse Avg"</span><span class="p">,</span> <span class="s2">"purple"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"peak_value"</span><span class="p">,</span> <span class="s2">"Peak value"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"pretrig_rms"</span><span class="p">,</span> <span class="s2">"Pretrig RMS"</span><span class="p">,</span> <span class="s2">"green"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">"pretrig_mean"</span><span class="p">,</span> <span class="s2">"Pretrig Mean"</span><span class="p">,</span> <span class="s2">"#00ff26"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"postpeak_deriv"</span><span class="p">,</span> <span class="s2">"Max PostPk deriv"</span><span class="p">,</span> <span class="s2">"gold"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">,</span> <span class="s2">"Rise time (s)"</span><span class="p">,</span> <span class="s2">"orange"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">,</span> <span class="s2">"Peak time (s)"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tpi_microsec</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="n">use_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span> <span class="k">if</span> <span class="n">use_expr_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">use_expr_in</span>

    <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npulses</span> <span class="o">//</span> <span class="mi">10000</span>
    <span class="n">downsample</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">downsample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">gather_every</span><span class="p">(</span><span class="n">downsample</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"peak_index"</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">n_presamples</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frametime_s</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"peak_time_s"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"rise_time"</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"rise_time_s"</span><span class="p">))</span>
    <span class="n">existing_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
    <span class="n">preserve</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plottables</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">]</span>
    <span class="n">preserve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">preserve</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Plot timeseries relative to 0 = the last 00 UT during or before the run.</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">"timestamp"</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">last_midnight</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"datetime64[D]"</span><span class="p">)</span>
    <span class="n">hour_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">last_midnight</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600e6</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plottables</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Time series scatter plots (left-hand panels)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hour_rel</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Time since last UT midnight (hours)"</span><span class="p">)</span>

        <span class="c1"># Histogram (right-hand panels)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plottables</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">contents</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">"stepfilled"</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">contents</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Plotting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npulses</span><span class="si">}</span><span class="s2"> data points"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_column_map_step">
<code class="highlight language-python"><span class="n">with_column_map_step</span><span class="p">(</span><span class="n">input_col</span><span class="p">,</span> <span class="n">output_col</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>f should take a numpy array and return a numpy array with the same number of elements</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_column_map_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""f should take a numpy array and return a numpy array with the same number of elements"""</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">ColumnAsNumpyMapStep</span><span class="p">([</span><span class="n">input_col</span><span class="p">],</span> <span class="p">[</span><span class="n">output_col</span><span class="p">],</span> <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_good_expr_below_nsigma_outlier_resistant">
<code class="highlight language-python"><span class="n">with_good_expr_below_nsigma_outlier_resistant</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>always sets lower limit at 0, don't use for values that can be negative</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_below_nsigma_outlier_resistant</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    always sets lower limit at 0, don't use for values that can be negative</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
        <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_above_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
        <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_good_expr_nsigma_range_outlier_resistant">
<code class="highlight language-python"><span class="n">with_good_expr_nsigma_range_outlier_resistant</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>always sets lower limit at 0, don't use for values that can be negative</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_good_expr_nsigma_range_outlier_resistant</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">col_nsigma_pairs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_prev_good_expr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    always sets lower limit at 0, don't use for values that can be negative</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">use_prev_good_expr</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">"pulse"</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nsigma_pairs</span><span class="p">):</span>
        <span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">outlier_resistant_nsigma_range_from_mid</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">nsigma</span><span class="p">)</span>
        <span class="n">this_iter_good_expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="n">min_for_col</span><span class="p">,</span> <span class="n">max_for_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">this_iter_good_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_expr</span> <span class="o">=</span> <span class="n">good_expr</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">this_iter_good_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_good_expr</span><span class="p">(</span><span class="n">good_expr</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channel.Channel.with_select_step">
<code class="highlight language-python"><span class="n">with_select_step</span><span class="p">(</span><span class="n">col_expr_dict</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channel.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_select_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_expr_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channel"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</span>
<span class="sd">    """</span>
    <span class="n">extract</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">extract_column_names_from_polars_expr</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">col_expr_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">SelectStep</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span>
        <span class="n">output</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">col_expr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">good_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">col_expr_dict</span><span class="o">=</span><span class="n">col_expr_dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.channels"></a>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.channels.Channels">
<code>Channels</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PLR0904</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Channels</span><span class="p">:</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">bad_channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">BadChannel</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ch0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"channels must be non-empty"</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pulse"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># return a dataframe containing good pulses from each channel,</span>
        <span class="c1"># exluding "pulse" by default</span>
        <span class="c1"># and including columns "key" (to be removed?) and "ch_num"</span>
        <span class="c1"># the more common call should be to wrap this in a convenient plotter</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>
            <span class="c1"># key_series = pl.Series("key", dtype=pl.Int64).extend_constant(key, len(df))</span>
            <span class="k">assert</span> <span class="n">ch_num</span> <span class="o">==</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span>
            <span class="n">ch_series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">"ch_num"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">extend_constant</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">ch_series</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linefit</span><span class="p">(</span>  <span class="c1"># noqa: PLR0917</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">SpectralLine</span> <span class="o">|</span> <span class="n">GenericLineModel</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">has_linear_background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">has_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">dlo</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">dhi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">params_update</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">has_linear_background</span><span class="o">=</span><span class="n">has_linear_background</span><span class="p">,</span> <span class="n">has_tails</span><span class="o">=</span><span class="n">has_tails</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">spect</span><span class="o">.</span><span class="n">peak_energy</span>
        <span class="n">_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pe</span> <span class="o">-</span> <span class="n">dlo</span><span class="p">,</span> <span class="n">pe</span> <span class="o">+</span> <span class="n">dhi</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_bin_edges</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dph_de</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"dph_de"</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"before update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params_update</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"after update </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bin_centers</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">minimum_bins_per_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">set_label_hints</span><span class="p">(</span>
            <span class="n">binsize</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">ds_shortname</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">unit_str</span><span class="o">=</span><span class="s2">"eV"</span><span class="p">,</span>
            <span class="n">attr_str</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">states_hint</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">use_expr</span><span class="si">=}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">cut_hint</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">plot_hist_of_series</span><span class="p">(</span><span class="n">df_small</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - col (str): The column name to plot.</span>
<span class="sd">        - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">        - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">        - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Plot a histogram for each group</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Get the data for the column to plot</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="c1"># Plot the histogram for the current group</span>
            <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">"EBIT"</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"k"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
            <span class="c1"># bin_centers, counts = mass2.misc.hist_of_series(values, bin_edges)</span>
            <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>

        <span class="c1"># Customize the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Frequency"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Coadded Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Add a legend to label the groups</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">allow_throw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">error_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">backtrace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">allow_throw</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">channel</span><span class="si">=}</span><span class="s2"> failed this step"</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">error_type</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">error_message</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">new_bad_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">as_bad</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">error_message</span><span class="p">,</span> <span class="n">backtrace</span><span class="p">)</span>
        <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">merge_dicts_ordered_by_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_channels</span><span class="p">,</span> <span class="n">new_bad_channels</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">new_bad_channels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">require_ch_num_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_bad_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">require_ch_num_exists</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ch_num</span><span class="si">}</span><span class="s2"> can't be set bad because it does not exist"</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ch_num</span><span class="p">:</span>
                <span class="n">new_bad_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">as_bad</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">bad_channels</span><span class="o">=</span><span class="n">new_bad_channels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">linefit_joblib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"threads"</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineModelResult</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">linefit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="n">parallel</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="n">prefer</span><span class="p">)</span>  <span class="c1"># its not clear if threads are better.... what blocks the gil?</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">work</span><span class="p">)(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># needed to make functools.cache work</span>
        <span class="c1"># if self or self.anything is mutated, assumptions will be broken</span>
        <span class="c1"># and we may get nonsense results</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_path_pairs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Create a :class:`Channels` instance from pairs of LJH files.</span>

<span class="sd">        Args:</span>
<span class="sd">            pulse_noise_pairs (List[Tuple[str, str]]):</span>
<span class="sd">                A list of `(pulse_path, noise_path)` tuples, where each entry contains</span>
<span class="sd">                the file path to a pulse LJH file and its corresponding noise LJH file.</span>
<span class="sd">            description (str):</span>
<span class="sd">                A human-readable description for the resulting Channels object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Channels:</span>
<span class="sd">                A Channels object with one :class:`Channel` per `(pulse_path, noise_path)` pair.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError:</span>
<span class="sd">                If two input files correspond to the same channel number.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Each channel is created via :meth:`Channel.from_ljh`.</span>
<span class="sd">            The channel number is taken from the LJH file header and used as the key</span>
<span class="sd">            in the returned Channels mapping.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; pairs = [</span>
<span class="sd">            ...     ("datadir/run0000_ch0000.ljh", "datadir/run0001_ch0000.ljh"),</span>
<span class="sd">            ...     ("datadir/run0000_ch0001.ljh", "datadir/run0001_ch0001.ljh"),</span>
<span class="sd">            ... ]</span>
<span class="sd">            &gt;&gt;&gt; channels = Channels.from_ljh_path_pairs(pairs, description="Test run")</span>
<span class="sd">            &gt;&gt;&gt; list(channels.keys())</span>
<span class="sd">            [0, 1]</span>
<span class="sd">        """</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span> <span class="ow">in</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_off_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">off_paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">off_paths</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_off</span><span class="p">(</span><span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">OffFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_folder</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">pulse_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">noise_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude_ch_nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
        <span class="k">if</span> <span class="n">exclude_ch_nums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude_ch_nums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">noise_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">find_ljh_files</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">path</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">noise_folder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">match_files_by_channel</span><span class="p">(</span><span class="n">pulse_folder</span><span class="p">,</span> <span class="n">noise_folder</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">exclude_ch_nums</span><span class="o">=</span><span class="n">exclude_ch_nums</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"from_ljh_folder </span><span class="si">{</span><span class="n">pulse_folder</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">noise_folder</span><span class="si">=}</span><span class="s2">"</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   from_ljh_folder has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_ljh_path_pairs</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   and the Channels obj has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_an_ljh_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_path_in_output_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">ljh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_an_ljh_path</span><span class="p">()</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_chan"</span><span class="p">)</span>
        <span class="n">date</span><span class="p">,</span> <span class="n">run_num</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_run"</span><span class="p">)</span>  <span class="c1"># timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ljh_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">run_num</span><span class="si">}</span><span class="s2">moss_output"</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">experiment_state_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ljh_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_an_ljh_path</span><span class="p">()</span>
            <span class="n">experiment_state_path</span> <span class="o">=</span> <span class="n">ljhutil</span><span class="o">.</span><span class="n">experiment_state_path_from_ljh_path</span><span class="p">(</span><span class="n">ljh_path</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="p">,</span> <span class="n">new_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="s2">"state_label"</span><span class="p">])</span>
        <span class="c1"># _col0, _col1 = df.columns</span>
        <span class="n">df_es</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">from_epoch</span><span class="p">(</span><span class="s2">"unixnano"</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">"ns"</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">cast_time_unit</span><span class="p">(</span><span class="s2">"us"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">))</span>
        <span class="c1"># strip whitespace from state_label column</span>
        <span class="n">sl_series</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">"state_label"</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip_chars</span><span class="p">())</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
        <span class="n">df_es</span> <span class="o">=</span> <span class="n">df_es</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">state_label</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">sl_series</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Categorical</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df_es</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_state_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="n">df_es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_state_df</span><span class="p">(</span><span class="n">experiment_state_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"cannot infer external trigger path yet"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">_f</span><span class="p">:</span>
            <span class="n">_header_line</span> <span class="o">=</span> <span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># read the one header line before opening the binary data</span>
            <span class="n">external_trigger_subframe_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">_f</span><span class="p">,</span> <span class="s2">"int64"</span><span class="p">)</span>
        <span class="n">df_ext</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"subframecount"</span><span class="p">:</span> <span class="n">external_trigger_subframe_count</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_external_trigger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_ext</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">with_etrig_df</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">with_external_trigger_df</span><span class="p">(</span><span class="n">df_ext</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">with_etrig_df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_experiment_state_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_es</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="c1"># this is not as performant as making use_exprs for states</span>
        <span class="c1"># and using .set_sorted on the timestamp column</span>
        <span class="n">ch2s</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ch2s</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">with_experiment_state_df</span><span class="p">(</span><span class="n">df_es</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">ch2s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_steps_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">load_recipes</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">steps_dict</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"steps dict did not contain steps for this ch_num"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">with_steps</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">load_recipes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Pickle a dictionary (one entry per channel) of Recipe objects.</span>

<span class="sd">        If you want to save a "recipe", a minimal series of steps required to reproduce the required field(s),</span>
<span class="sd">        then set `required_fields` to be a list/tuple/set of DataFrame column names (or a single column name)</span>
<span class="sd">        whose production from raw data should be possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Filename to store recipe in, typically of the form "*.pkl"</span>
<span class="sd">        required_fields : str | Iterable[str] | None</span>
<span class="sd">            The field (str) or fields (Iterable[str]) that the recipe should be able to generate from a raw LJH file.</span>
<span class="sd">            Drop all steps that do not lead (directly or indireactly) to producing this field or these fields.</span>
<span class="sd">            If None, then preserve all steps (default None).</span>
<span class="sd">        drop_debug: bool</span>
<span class="sd">            Whether to remove debugging-related data from each `RecipeStep`, if the subclass supports this (via the</span>
<span class="sd">            `RecipeStep.drop_debug() method).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with keys=channel numbers, values=the (possibly trimmed and debug-dropped) Recipe objects.</span>
<span class="sd">        """</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channum</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">steps</span><span class="p">[</span><span class="n">channum</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">trim_dead_ends</span><span class="p">(</span><span class="n">required_fields</span><span class="o">=</span><span class="n">required_fields</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="n">drop_debug</span><span class="p">)</span>
        <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">unpickle_object</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_steps_dict</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parent_folder_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
        <span class="n">parent_folder_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">"Filename"</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parent_folder_path</span><span class="si">=}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_folder_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concat_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_data</span><span class="p">:</span> <span class="s2">"Channels"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="c1"># sorting here to show intention, but I think set is sorted by insertion order as</span>
        <span class="c1"># an implementation detail so this may not do anything</span>
        <span class="n">ch_nums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span> <span class="ow">in</span> <span class="n">ch_nums</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">other_ch</span> <span class="o">=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span>
            <span class="n">combined_df</span> <span class="o">=</span> <span class="n">mass2</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">concat_dfs_with_concat_state</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">other_ch</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="n">new_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">with_replacement_df</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
            <span class="n">new_channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ch</span>
        <span class="k">return</span> <span class="n">mass2</span><span class="o">.</span><span class="n">Channels</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="n">other_data</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_df</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">df_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">frametime_s</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_presamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"from Channels.channels_from_df"</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
        <span class="c1"># requres a column named "ch_num" containing the channel number</span>
        <span class="n">keys_df</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">partition_by</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">"ch_num"</span><span class="p">],</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">df</span> <span class="k">for</span> <span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">keys_df</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ch_num</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">channels</span><span class="p">[</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">ChannelHeader</span><span class="p">(</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">"from df"</span><span class="p">,</span>
                    <span class="n">ch_num</span><span class="o">=</span><span class="n">ch_num</span><span class="p">,</span>
                    <span class="n">frametime_s</span><span class="o">=</span><span class="n">frametime_s</span><span class="p">,</span>
                    <span class="n">n_presamples</span><span class="o">=</span><span class="n">n_presamples</span><span class="p">,</span>
                    <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">npulses</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Channels</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.from_ljh_path_pairs">
<code class="highlight language-python"><span class="n">from_ljh_path_pairs</span><span class="p">(</span><span class="n">pulse_noise_pairs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Create a :class:<code>Channels</code> instance from pairs of LJH files.</p>
<p>Args:
    pulse_noise_pairs (List[Tuple[str, str]]):
        A list of <code>(pulse_path, noise_path)</code> tuples, where each entry contains
        the file path to a pulse LJH file and its corresponding noise LJH file.
    description (str):
        A human-readable description for the resulting Channels object.</p>
<p>Returns:
    Channels:
        A Channels object with one :class:<code>Channel</code> per <code>(pulse_path, noise_path)</code> pair.</p>
<p>Raises:
    AssertionError:
        If two input files correspond to the same channel number.</p>
<p>Notes:
    Each channel is created via :meth:<code>Channel.from_ljh</code>.
    The channel number is taken from the LJH file header and used as the key
    in the returned Channels mapping.</p>
<p>Examples:
    &gt;&gt;&gt; pairs = [
    ...     ("datadir/run0000_ch0000.ljh", "datadir/run0001_ch0000.ljh"),
    ...     ("datadir/run0000_ch0001.ljh", "datadir/run0001_ch0001.ljh"),
    ... ]
    &gt;&gt;&gt; channels = Channels.from_ljh_path_pairs(pairs, description="Test run")
    &gt;&gt;&gt; list(channels.keys())
    [0, 1]</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ljh_path_pairs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Channels"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a :class:`Channels` instance from pairs of LJH files.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_noise_pairs (List[Tuple[str, str]]):</span>
<span class="sd">            A list of `(pulse_path, noise_path)` tuples, where each entry contains</span>
<span class="sd">            the file path to a pulse LJH file and its corresponding noise LJH file.</span>
<span class="sd">        description (str):</span>
<span class="sd">            A human-readable description for the resulting Channels object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Channels:</span>
<span class="sd">            A Channels object with one :class:`Channel` per `(pulse_path, noise_path)` pair.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError:</span>
<span class="sd">            If two input files correspond to the same channel number.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Each channel is created via :meth:`Channel.from_ljh`.</span>
<span class="sd">        The channel number is taken from the LJH file header and used as the key</span>
<span class="sd">        in the returned Channels mapping.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; pairs = [</span>
<span class="sd">        ...     ("datadir/run0000_ch0000.ljh", "datadir/run0001_ch0000.ljh"),</span>
<span class="sd">        ...     ("datadir/run0000_ch0001.ljh", "datadir/run0001_ch0001.ljh"),</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; channels = Channels.from_ljh_path_pairs(pairs, description="Test run")</span>
<span class="sd">        &gt;&gt;&gt; list(channels.keys())</span>
<span class="sd">        [0, 1]</span>
<span class="sd">    """</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span> <span class="ow">in</span> <span class="n">pulse_noise_pairs</span><span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">from_ljh</span><span class="p">(</span><span class="n">pulse_path</span><span class="p">,</span> <span class="n">noise_path</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ch_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.plot_hists">
<code class="highlight language-python"><span class="n">plot_hists</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_expr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Plots histograms for the given column, grouped by the specified column.</p>
<p>Parameters:
- col (str): The column name to plot.
- bin_edges (array-like): The edges of the bins for the histogram.
- group_by_col (str): The column name to group by. This is required.
- axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_hists</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bin_edges</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">group_by_col</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Plots histograms for the given column, grouped by the specified column.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - col (str): The column name to plot.</span>
<span class="sd">    - bin_edges (array-like): The edges of the bins for the histogram.</span>
<span class="sd">    - group_by_col (str): The column name to group by. This is required.</span>
<span class="sd">    - axis (matplotlib.Axes, optional): The axis to plot on. If None, a new figure is created.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># Create a new figure if no axis is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

    <span class="k">if</span> <span class="n">use_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_small</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfg</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">use_expr</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">group_by_col</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Plot a histogram for each group</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,),</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="n">df_small</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">group_by_col</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip_none</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get the data for the column to plot</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="c1"># Plot the histogram for the current group</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">"EBIT"</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"k"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span>
        <span class="c1"># bin_centers, counts = mass2.misc.hist_of_series(values, bin_edges)</span>
        <span class="c1"># plt.plot(bin_centers, counts, label=group_name)</span>

    <span class="c1"># Customize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Frequency"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Coadded Histogram of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">group_by_col</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Add a legend to label the groups</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">group_by_col</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.channels.Channels.save_recipes">
<code class="highlight language-python"><span class="n">save_recipes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">required_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Pickle a dictionary (one entry per channel) of Recipe objects.</p>
<p>If you want to save a "recipe", a minimal series of steps required to reproduce the required field(s),
then set <code>required_fields</code> to be a list/tuple/set of DataFrame column names (or a single column name)
whose production from raw data should be possible.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>filename</code></b>
                  (<code><span title="str">str</span></code>)
              
              <div class="doc-md-description">
<p>Filename to store recipe in, typically of the form "*.pkl"</p>
</div>
</li>
<li>
<b><code>required_fields</code></b>
                  (<code><span title="str">str</span> | <span title="collections.abc.Iterable">Iterable</span>[<span title="str">str</span>] | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The field (str) or fields (Iterable[str]) that the recipe should be able to generate from a raw LJH file.
Drop all steps that do not lead (directly or indireactly) to producing this field or these fields.
If None, then preserve all steps (default None).</p>
</div>
</li>
<li>
<b><code>drop_debug</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              
              <div class="doc-md-description">
<p>Whether to remove debugging-related data from each <code>RecipeStep</code>, if the subclass supports this (via the
`RecipeStep.drop_debug() method).</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="dict">dict</span></code>
              
              <div class="doc-md-description">
<p>Dictionary with keys=channel numbers, values=the (possibly trimmed and debug-dropped) Recipe objects.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/channels.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_recipes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Recipe</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Pickle a dictionary (one entry per channel) of Recipe objects.</span>

<span class="sd">    If you want to save a "recipe", a minimal series of steps required to reproduce the required field(s),</span>
<span class="sd">    then set `required_fields` to be a list/tuple/set of DataFrame column names (or a single column name)</span>
<span class="sd">    whose production from raw data should be possible.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Filename to store recipe in, typically of the form "*.pkl"</span>
<span class="sd">    required_fields : str | Iterable[str] | None</span>
<span class="sd">        The field (str) or fields (Iterable[str]) that the recipe should be able to generate from a raw LJH file.</span>
<span class="sd">        Drop all steps that do not lead (directly or indireactly) to producing this field or these fields.</span>
<span class="sd">        If None, then preserve all steps (default None).</span>
<span class="sd">    drop_debug: bool</span>
<span class="sd">        Whether to remove debugging-related data from each `RecipeStep`, if the subclass supports this (via the</span>
<span class="sd">        `RecipeStep.drop_debug() method).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with keys=channel numbers, values=the (possibly trimmed and debug-dropped) Recipe objects.</span>
<span class="sd">    """</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">channum</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">steps</span><span class="p">[</span><span class="n">channum</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">trim_dead_ends</span><span class="p">(</span><span class="n">required_fields</span><span class="o">=</span><span class="n">required_fields</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="n">drop_debug</span><span class="p">)</span>
    <span class="n">mass2</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">pickle_object</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">steps</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.analysis_algorithms"></a>
<div class="doc doc-contents first">
<p>mass2.core.analysis_algorithms - main algorithms used in data analysis</p>
<p>Designed to abstract certain key algorithms out of the class <code>MicrocalDataSet</code>
and be able to run them fast.</p>
<p>Created on Jun 9, 2014</p>
<p>@author: fowlerj</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.HistogramSmoother">
<code>HistogramSmoother</code>
</h2>
<div class="doc doc-contents">
<p>Object that can repeatedly smooth histograms with the same bin count and
width to the same Gaussian width.  By pre-computing the smoothing kernel for
that histogram, we can smooth multiple histograms with the same geometry.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HistogramSmoother</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Object that can repeatedly smooth histograms with the same bin count and</span>
<span class="sd">    width to the same Gaussian width.  By pre-computing the smoothing kernel for</span>
<span class="sd">    that histogram, we can smooth multiple histograms with the same geometry.</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Give the smoothing Gaussian's width as &lt;smooth_sigma&gt; and the</span>
<span class="sd">        [lower,upper] histogram limits as &lt;limits&gt;."""</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span> <span class="o">=</span> <span class="n">smooth_sigma</span>

        <span class="c1"># Choose a reasonable # of bins, at least 1024 and a power of 2</span>
        <span class="n">stepsize</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">smooth_sigma</span>
        <span class="n">dlimits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nbins_guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dlimits</span> <span class="o">/</span> <span class="n">stepsize</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">min_nbins</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">max_nbins</span> <span class="o">=</span> <span class="mi">32768</span>  <span class="c1"># 32k bins, 2**15</span>

        <span class="c1"># Clamp nbins_guess to at least min_nbins</span>
        <span class="n">clamped_nbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">nbins_guess</span><span class="p">,</span> <span class="n">min_nbins</span><span class="p">,</span> <span class="n">max_nbins</span><span class="p">)</span>
        <span class="n">nbins_forced_to_power_of_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">clamped_nbins</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">nbins_forced_to_power_of_2</span> <span class="o">==</span> <span class="n">max_nbins</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Warning: HistogramSmoother (for drift correct) Limiting histogram bins to </span><span class="si">{</span><span class="n">max_nbins</span><span class="si">}</span><span class="s2"> (requested </span><span class="si">{</span><span class="n">nbins_guess</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins_forced_to_power_of_2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">=</span> <span class="n">dlimits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>

        <span class="c1"># Compute the Fourier-space smoothing kernel</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">kernel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Handle the negative frequencies</span>
        <span class="n">kernel</span> <span class="o">/=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a smoothed histogram of the data vector &lt;values&gt;"""</span>
        <span class="n">contents</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span>
        <span class="n">ftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="n">csmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">*</span> <span class="n">ftc</span><span class="p">)</span>
        <span class="n">csmooth</span><span class="p">[</span><span class="n">csmooth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">csmooth</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.analysis_algorithms.HistogramSmoother.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return a smoothed histogram of the data vector <values></values></p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return a smoothed histogram of the data vector &lt;values&gt;"""</span>
    <span class="n">contents</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">ftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="n">csmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">*</span> <span class="n">ftc</span><span class="p">)</span>
    <span class="n">csmooth</span><span class="p">[</span><span class="n">csmooth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">csmooth</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.analysis_algorithms.HistogramSmoother.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">smooth_sigma</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Give the smoothing Gaussian's width as <smooth_sigma> and the
[lower,upper] histogram limits as <limits>.</limits></smooth_sigma></p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Give the smoothing Gaussian's width as &lt;smooth_sigma&gt; and the</span>
<span class="sd">    [lower,upper] histogram limits as &lt;limits&gt;."""</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span> <span class="o">=</span> <span class="n">smooth_sigma</span>

    <span class="c1"># Choose a reasonable # of bins, at least 1024 and a power of 2</span>
    <span class="n">stepsize</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">smooth_sigma</span>
    <span class="n">dlimits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nbins_guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dlimits</span> <span class="o">/</span> <span class="n">stepsize</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">min_nbins</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">max_nbins</span> <span class="o">=</span> <span class="mi">32768</span>  <span class="c1"># 32k bins, 2**15</span>

    <span class="c1"># Clamp nbins_guess to at least min_nbins</span>
    <span class="n">clamped_nbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">nbins_guess</span><span class="p">,</span> <span class="n">min_nbins</span><span class="p">,</span> <span class="n">max_nbins</span><span class="p">)</span>
    <span class="n">nbins_forced_to_power_of_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">clamped_nbins</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">nbins_forced_to_power_of_2</span> <span class="o">==</span> <span class="n">max_nbins</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Warning: HistogramSmoother (for drift correct) Limiting histogram bins to </span><span class="si">{</span><span class="n">max_nbins</span><span class="si">}</span><span class="s2"> (requested </span><span class="si">{</span><span class="n">nbins_guess</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins_forced_to_power_of_2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">=</span> <span class="n">dlimits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span>

    <span class="c1"># Compute the Fourier-space smoothing kernel</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">kernel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Handle the negative frequencies</span>
    <span class="n">kernel</span> <span class="o">/=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.compute_max_deriv">
<code class="highlight language-python"><span class="n">compute_max_deriv</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="n">ignore_leading</span><span class="p">,</span> <span class="n">spike_reject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Computes the maximum derivative in timeseries <pulse_data>.
<pulse_data> can be a 2D array where each row is a different pulse record, in which case
the return value will be an array last long as the number of rows in <pulse_data>.</pulse_data></pulse_data></pulse_data></p>
<p>Args:
    pulse_data:
    ignore_leading:
    spike_reject: (default True)
    kernel: the linear filter against which the signals will be convolved
        (CONVOLED, not correlated, so reverse the filter as needed). If None,
        then the default kernel of [+.2 +.1 0 -.1 -.2] will be used. If
        "SG", then the cubic 5-point Savitzky-Golay filter will be used (see
        below). Otherwise, kernel needs to be a (short) array which will
        be converted to a 1xN 2-dimensional np.ndarray. (default None)</p>
<p>Returns:
    An np.ndarray, dimension 1: the value of the maximum derivative (units of <pulse_data units=""> per sample).</pulse_data></p>
<p>When kernel=="SG", then we estimate the derivative by Savitzky-Golay filtering
(with 1 point before/3 points after the point in question and fitting polynomial
of order 3).  Find the right general area by first doing a simple difference.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_max_deriv</span><span class="p">(</span>
    <span class="n">pulse_data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ignore_leading</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spike_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Computes the maximum derivative in timeseries &lt;pulse_data&gt;.</span>
<span class="sd">    &lt;pulse_data&gt; can be a 2D array where each row is a different pulse record, in which case</span>
<span class="sd">    the return value will be an array last long as the number of rows in &lt;pulse_data&gt;.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_data:</span>
<span class="sd">        ignore_leading:</span>
<span class="sd">        spike_reject: (default True)</span>
<span class="sd">        kernel: the linear filter against which the signals will be convolved</span>
<span class="sd">            (CONVOLED, not correlated, so reverse the filter as needed). If None,</span>
<span class="sd">            then the default kernel of [+.2 +.1 0 -.1 -.2] will be used. If</span>
<span class="sd">            "SG", then the cubic 5-point Savitzky-Golay filter will be used (see</span>
<span class="sd">            below). Otherwise, kernel needs to be a (short) array which will</span>
<span class="sd">            be converted to a 1xN 2-dimensional np.ndarray. (default None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        An np.ndarray, dimension 1: the value of the maximum derivative (units of &lt;pulse_data units&gt; per sample).</span>

<span class="sd">    When kernel=="SG", then we estimate the derivative by Savitzky-Golay filtering</span>
<span class="sd">    (with 1 point before/3 points after the point in question and fitting polynomial</span>
<span class="sd">    of order 3).  Find the right general area by first doing a simple difference.</span>
<span class="sd">    """</span>

    <span class="c1"># If pulse_data is a 1D array, turn it into 2</span>
    <span class="n">pulse_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"input pulse_data should be a 1d or 2d array."</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pulse_view</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="p">[:,</span> <span class="n">ignore_leading</span><span class="p">:]</span>
    <span class="n">NPulse</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">NSamp</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># The default filter:</span>
    <span class="n">filter_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s2">"SG"</span><span class="p">:</span>
        <span class="c1"># This filter is the Savitzky-Golay filter of n_L=1, n_R=3 and M=3, to use the</span>
        <span class="c1"># language of Numerical Recipes 3rd edition.  It amounts to least-squares fitting</span>
        <span class="c1"># of an M=3rd order polynomial to the five points [-1,+3] and</span>
        <span class="c1"># finding the slope of the polynomial at 0.</span>
        <span class="c1"># Note that we reverse the order of coefficients because convolution will re-reverse</span>
        <span class="n">filter_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.45238</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02381</span><span class="p">,</span> <span class="mf">0.28571</span><span class="p">,</span> <span class="mf">0.30952</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.11905</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span> <span class="o">=</span> <span class="n">filter_coef</span>

    <span class="n">max_deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NPulse</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spike_reject</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPulse</span><span class="p">):</span>
            <span class="n">pulses</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="n">t2</span> <span class="k">if</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="k">else</span> <span class="n">t0</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">NSamp</span><span class="p">):</span>
                <span class="n">t3</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">t3</span> <span class="k">if</span> <span class="n">t3</span> <span class="o">&lt;</span> <span class="n">t1</span> <span class="k">else</span> <span class="n">t1</span>
                <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span> <span class="n">t_max_deriv</span><span class="p">)</span>

                <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span>

            <span class="n">max_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max_deriv</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NPulse</span><span class="p">):</span>
            <span class="n">pulses</span> <span class="o">=</span> <span class="n">pulse_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="n">t0</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">NSamp</span><span class="p">):</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">f4</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">f3</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">pulses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">t_max_deriv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t_max_deriv</span><span class="p">)</span>
            <span class="n">max_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max_deriv</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">max_deriv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.correct_flux_jumps">
<code class="highlight language-python"><span class="n">correct_flux_jumps</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Remove 'flux' jumps' from pretrigger mean.</p>
<p>When using umux readout, if a pulse is recorded that has a very fast rising
edge (e.g. a cosmic ray), the readout system will "slip" an integer number
of flux quanta. This means that the baseline level returned to after the
pulse will different from the pretrigger value by an integer number of flux
quanta. This causes that pretrigger mean summary quantity to jump around in
a way that causes trouble for the rest of MASS. This function attempts to
correct these jumps.</p>
<p>Arguments:
vals -- array of values to correct
mask -- mask indentifying "good" pulses
flux_quant -- size of 1 flux quanta</p>
<p>Returns:
Array with values corrected</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_flux_jumps</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Remove 'flux' jumps' from pretrigger mean.</span>

<span class="sd">    When using umux readout, if a pulse is recorded that has a very fast rising</span>
<span class="sd">    edge (e.g. a cosmic ray), the readout system will "slip" an integer number</span>
<span class="sd">    of flux quanta. This means that the baseline level returned to after the</span>
<span class="sd">    pulse will different from the pretrigger value by an integer number of flux</span>
<span class="sd">    quanta. This causes that pretrigger mean summary quantity to jump around in</span>
<span class="sd">    a way that causes trouble for the rest of MASS. This function attempts to</span>
<span class="sd">    correct these jumps.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    vals -- array of values to correct</span>
<span class="sd">    mask -- mask indentifying "good" pulses</span>
<span class="sd">    flux_quant -- size of 1 flux quanta</span>

<span class="sd">    Returns:</span>
<span class="sd">    Array with values corrected</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">unwrap_n</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.correct_flux_jumps_original">
<code class="highlight language-python"><span class="n">correct_flux_jumps_original</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Remove 'flux' jumps' from pretrigger mean.</p>
<p>When using umux readout, if a pulse is recorded that has a very fast rising
edge (e.g. a cosmic ray), the readout system will "slip" an integer number
of flux quanta. This means that the baseline level returned to after the
pulse will different from the pretrigger value by an integer number of flux
quanta. This causes that pretrigger mean summary quantity to jump around in
a way that causes trouble for the rest of MASS. This function attempts to
correct these jumps.</p>
<p>Arguments:
vals -- array of values to correct
mask -- mask indentifying "good" pulses
flux_quant -- size of 1 flux quanta</p>
<p>Returns:
Array with values corrected</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">correct_flux_jumps_original</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">flux_quant</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Remove 'flux' jumps' from pretrigger mean.</span>

<span class="sd">    When using umux readout, if a pulse is recorded that has a very fast rising</span>
<span class="sd">    edge (e.g. a cosmic ray), the readout system will "slip" an integer number</span>
<span class="sd">    of flux quanta. This means that the baseline level returned to after the</span>
<span class="sd">    pulse will different from the pretrigger value by an integer number of flux</span>
<span class="sd">    quanta. This causes that pretrigger mean summary quantity to jump around in</span>
<span class="sd">    a way that causes trouble for the rest of MASS. This function attempts to</span>
<span class="sd">    correct these jumps.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    vals -- array of values to correct</span>
<span class="sd">    mask -- mask indentifying "good" pulses</span>
<span class="sd">    flux_quant -- size of 1 flux quanta</span>

<span class="sd">    Returns:</span>
<span class="sd">    Array with values corrected</span>
<span class="sd">    """</span>
    <span class="c1"># The naive thing is to simply replace each value with its value mod</span>
    <span class="c1"># the flux quantum. But of the baseline value turns out to fluctuate</span>
    <span class="c1"># about an integer number of flux quanta, this will introduce new</span>
    <span class="c1"># jumps. I don't know the best way to handle this in general. For now,</span>
    <span class="c1"># if there are still jumps after the mod, I add 1/4 of a flux quanta</span>
    <span class="c1"># before modding, then mod, then subtract the 1/4 flux quantum and then</span>
    <span class="c1"># *add* a single flux quantum so that the values never go negative.</span>
    <span class="c1">#</span>
    <span class="c1"># To determine whether there are "still jumps after the mod" I look at the</span>
    <span class="c1"># difference between the largest and smallest values for "good" pulses. If</span>
    <span class="c1"># you don't exclude "bad" pulses, this check can be tricked in cases where</span>
    <span class="c1"># the pretrigger section contains a (sufficiently large) tail.</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">flux_quant</span><span class="p">:</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">%</span> <span class="n">flux_quant</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">flux_quant</span><span class="p">:</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span> <span class="o">+</span> <span class="n">flux_quant</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">flux_quant</span><span class="p">)</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="n">corrected</span> <span class="o">-</span> <span class="n">flux_quant</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">flux_quant</span>
        <span class="n">corrected</span> <span class="o">-=</span> <span class="n">corrected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">corrected</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vals</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.drift_correct">
<code class="highlight language-python"><span class="n">drift_correct</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute a drift correction that minimizes the spectral entropy.</p>
<p>Args:
    indicator: The "x-axis", which indicates the size of the correction.
    uncorrected: A filtered pulse height vector. Same length as indicator.
        Assumed to have some gain that is linearly related to indicator.
    limit: The upper limit of uncorrected values over which entropy is
        computed (default None).</p>
<p>Generally indicator will be the pretrigger mean of the pulses, but you can
experiment with other choices.</p>
<p>The entropy will be computed on corrected values only in the range
[0, limit], so limit should be set to a characteristic large value of
uncorrected. If limit is None (the default), then in will be compute as
25% larger than the 99%ile point of uncorrected.</p>
<p>The model is that the filtered pulse height PH should be scaled by (1 +
a*PTM) where a is an arbitrary parameter computed here, and PTM is the
difference between each record's pretrigger mean and the median value of all
pretrigger means. (Or replace "pretrigger mean" with whatever quantity you
passed in as <indicator>.)</indicator></p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drift_correct</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a drift correction that minimizes the spectral entropy.</span>

<span class="sd">    Args:</span>
<span class="sd">        indicator: The "x-axis", which indicates the size of the correction.</span>
<span class="sd">        uncorrected: A filtered pulse height vector. Same length as indicator.</span>
<span class="sd">            Assumed to have some gain that is linearly related to indicator.</span>
<span class="sd">        limit: The upper limit of uncorrected values over which entropy is</span>
<span class="sd">            computed (default None).</span>

<span class="sd">    Generally indicator will be the pretrigger mean of the pulses, but you can</span>
<span class="sd">    experiment with other choices.</span>

<span class="sd">    The entropy will be computed on corrected values only in the range</span>
<span class="sd">    [0, limit], so limit should be set to a characteristic large value of</span>
<span class="sd">    uncorrected. If limit is None (the default), then in will be compute as</span>
<span class="sd">    25% larger than the 99%ile point of uncorrected.</span>

<span class="sd">    The model is that the filtered pulse height PH should be scaled by (1 +</span>
<span class="sd">    a*PTM) where a is an arbitrary parameter computed here, and PTM is the</span>
<span class="sd">    difference between each record's pretrigger mean and the median value of all</span>
<span class="sd">    pretrigger means. (Or replace "pretrigger mean" with whatever quantity you</span>
<span class="sd">    passed in as &lt;indicator&gt;.)</span>
<span class="sd">    """</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">)</span>
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>  <span class="c1"># make a copy</span>
    <span class="n">ptm_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
    <span class="n">indicator</span> <span class="o">-=</span> <span class="n">ptm_offset</span>

    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pct99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">pct99</span>

    <span class="n">smoother</span> <span class="o">=</span> <span class="n">HistogramSmoother</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">smoother</span><span class="o">.</span><span class="n">nbins</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">,</span> <span class="s2">"will be crazy slow, should not be possible"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">entropy</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">smoother</span><span class="p">:</span> <span class="n">HistogramSmoother</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">indicator</span> <span class="o">*</span> <span class="n">param</span><span class="p">)</span>
        <span class="n">hsmooth</span> <span class="o">=</span> <span class="n">smoother</span><span class="p">(</span><span class="n">corrected</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">hsmooth</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hsmooth</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">hsmooth</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">drift_corr_param</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brent</span><span class="p">(</span><span class="n">entropy</span><span class="p">,</span> <span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">smoother</span><span class="p">),</span> <span class="n">brack</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">])</span>

    <span class="n">drift_correct_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"ptmean_gain"</span><span class="p">,</span> <span class="s2">"slope"</span><span class="p">:</span> <span class="n">drift_corr_param</span><span class="p">,</span> <span class="s2">"median_pretrig_mean"</span><span class="p">:</span> <span class="n">ptm_offset</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">drift_corr_param</span><span class="p">,</span> <span class="n">drift_correct_info</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.estimateRiseTime">
<code class="highlight language-python"><span class="n">estimateRiseTime</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">,</span> <span class="n">timebase</span><span class="p">,</span> <span class="n">nPretrig</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Computes the rise time of timeseries <pulse_data>, where the time steps are <timebase>.
<pulse_data> can be a 2D array where each row is a different pulse record, in which case
the return value will be an array last long as the number of rows in <pulse_data>.</pulse_data></pulse_data></timebase></pulse_data></p>
<p>If nPretrig &gt;= 4, then the samples pulse_data[:nPretrig] are averaged to estimate
the baseline.  Otherwise, the minimum of pulse_data is assumed to be the baseline.</p>
<p>Specifically, take the first and last of the rising points in the range of
10% to 90% of the peak value, interpolate a line between the two, and use its
slope to find the time to rise from 0 to the peak.</p>
<p>Args:
    pulse_data: An np.ndarray of dimension 1 (a single pulse record) or 2 (an
        array with each row being a pulse record).
    timebase: The sampling time.
    nPretrig: The number of samples that are recorded before the trigger.</p>
<p>Returns:
    An ndarray of dimension 1, giving the rise times.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">estimateRiseTime</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">timebase</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">nPretrig</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Computes the rise time of timeseries &lt;pulse_data&gt;, where the time steps are &lt;timebase&gt;.</span>
<span class="sd">    &lt;pulse_data&gt; can be a 2D array where each row is a different pulse record, in which case</span>
<span class="sd">    the return value will be an array last long as the number of rows in &lt;pulse_data&gt;.</span>

<span class="sd">    If nPretrig &gt;= 4, then the samples pulse_data[:nPretrig] are averaged to estimate</span>
<span class="sd">    the baseline.  Otherwise, the minimum of pulse_data is assumed to be the baseline.</span>

<span class="sd">    Specifically, take the first and last of the rising points in the range of</span>
<span class="sd">    10% to 90% of the peak value, interpolate a line between the two, and use its</span>
<span class="sd">    slope to find the time to rise from 0 to the peak.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_data: An np.ndarray of dimension 1 (a single pulse record) or 2 (an</span>
<span class="sd">            array with each row being a pulse record).</span>
<span class="sd">        timebase: The sampling time.</span>
<span class="sd">        nPretrig: The number of samples that are recorded before the trigger.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An ndarray of dimension 1, giving the rise times.</span>
<span class="sd">    """</span>
    <span class="n">MINTHRESH</span><span class="p">,</span> <span class="n">MAXTHRESH</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span>

    <span class="c1"># If pulse_data is a 1D array, turn it into 2</span>
    <span class="n">pulse_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pulse_data</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"input pulse_data should be a 1d or 2d array."</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># The following requires a lot of numpy foo to read. Sorry!</span>
    <span class="k">if</span> <span class="n">nPretrig</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">baseline_value</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nPretrig</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">baseline_value</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nPretrig</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">value_at_peak</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">baseline_value</span>
    <span class="n">idx_last_pk</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">npulses</span> <span class="o">=</span> <span class="n">pulse_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rising_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">pulse_data</span><span class="p">[:,</span> <span class="n">nPretrig</span> <span class="p">:</span> <span class="n">idx_last_pk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline_value</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="n">value_at_peak</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1"># Find the last and first indices at which the data are in (0.1, 0.9] times the</span>
        <span class="c1"># peak value. Then make sure last is at least 1 past first.</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rising_data</span> <span class="o">&gt;</span> <span class="n">MAXTHRESH</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rising_data</span> <span class="o">&gt;</span> <span class="n">MINTHRESH</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_idx</span><span class="p">[</span><span class="n">last_idx</span> <span class="o">&lt;</span> <span class="n">first_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_idx</span><span class="p">[</span><span class="n">last_idx</span> <span class="o">&lt;</span> <span class="n">first_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">last_idx</span><span class="p">[</span><span class="n">last_idx</span> <span class="o">==</span> <span class="n">rising_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rising_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">pulsenum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npulses</span><span class="p">)</span>
        <span class="n">y_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rising_data</span><span class="p">[</span><span class="n">pulsenum</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">rising_data</span><span class="p">[</span><span class="n">pulsenum</span><span class="p">,</span> <span class="n">first_idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">y_diff</span><span class="p">[</span><span class="n">y_diff</span> <span class="o">&lt;</span> <span class="n">timebase</span><span class="p">]</span> <span class="o">=</span> <span class="n">timebase</span>
        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">timebase</span> <span class="o">*</span> <span class="p">(</span><span class="n">last_idx</span> <span class="o">-</span> <span class="n">first_idx</span><span class="p">)</span>
        <span class="n">rise_time</span> <span class="o">=</span> <span class="n">time_diff</span> <span class="o">/</span> <span class="n">y_diff</span>
        <span class="n">rise_time</span><span class="p">[</span><span class="n">y_diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.9e-6</span>
        <span class="k">return</span> <span class="n">rise_time</span>

    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">9.9e-6</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.filter_signal_lowpass">
<code class="highlight language-python"><span class="n">filter_signal_lowpass</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fcut</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Tophat lowpass filter using an FFT</p>
<p>Args:
    sig - the signal to be filtered
    fs - the sampling frequency of the signal
    fcut - the frequency at which to cutoff the signal</p>
<p>Returns:
    the filtered signal</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_signal_lowpass</span><span class="p">(</span><span class="n">sig</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">fs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fcut</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Tophat lowpass filter using an FFT</span>

<span class="sd">    Args:</span>
<span class="sd">        sig - the signal to be filtered</span>
<span class="sd">        fs - the sampling frequency of the signal</span>
<span class="sd">        fcut - the frequency at which to cutoff the signal</span>

<span class="sd">    Returns:</span>
<span class="sd">        the filtered signal</span>
<span class="sd">    """</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SIG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fs</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">SIG</span><span class="p">)</span>
    <span class="n">filt</span><span class="p">[</span><span class="n">freqs</span> <span class="o">&lt;</span> <span class="n">fcut</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">sig_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">SIG</span> <span class="o">*</span> <span class="n">filt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sig_filt</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.make_smooth_histogram">
<code class="highlight language-python"><span class="n">make_smooth_histogram</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Convert a vector of arbitrary <values> info a smoothed histogram by
histogramming it and smoothing.</values></p>
<p>This is a convenience function using the HistogramSmoother class.</p>
<p>Args:
    values: The vector of data to be histogrammed.
    smooth_sigma: The smoothing Gaussian's width (FWHM)
    limit, upper_limit: The histogram limits are [limit,upper_limit] or
        [0,limit] if upper_limit is None.</p>
<p>Returns:
    The smoothed histogram as an array.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_smooth_histogram</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">smooth_sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert a vector of arbitrary &lt;values&gt; info a smoothed histogram by</span>
<span class="sd">    histogramming it and smoothing.</span>

<span class="sd">    This is a convenience function using the HistogramSmoother class.</span>

<span class="sd">    Args:</span>
<span class="sd">        values: The vector of data to be histogrammed.</span>
<span class="sd">        smooth_sigma: The smoothing Gaussian's width (FWHM)</span>
<span class="sd">        limit, upper_limit: The histogram limits are [limit,upper_limit] or</span>
<span class="sd">            [0,limit] if upper_limit is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The smoothed histogram as an array.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">upper_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limit</span><span class="p">,</span> <span class="n">upper_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span>
    <span class="k">return</span> <span class="n">HistogramSmoother</span><span class="p">(</span><span class="n">smooth_sigma</span><span class="p">,</span> <span class="p">[</span><span class="n">limit</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">])(</span><span class="n">values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.nearest_arrivals">
<code class="highlight language-python"><span class="n">nearest_arrivals</span><span class="p">(</span><span class="n">reference_times</span><span class="p">,</span> <span class="n">other_times</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Find the external trigger time immediately before and after each pulse timestamp</p>
<p>Args:
    pulse_timestamps - 1d array of pulse timestamps whose nearest neighbors
        need to be found.
    external_trigger_timestamps - 1d array of possible nearest neighbors.</p>
<p>Returns:
    (before_times, after_times)</p>
<p>before_times is an ndarray of the same size as pulse_timestamps.
before_times[i] contains the difference between the closest lesser time
contained in external_trigger_timestamps and pulse_timestamps[i]  or inf if there was no
earlier time in other_times Note that before_times is always a positive
number even though the time difference it represents is negative.</p>
<p>after_times is an ndarray of the same size as pulse_timestamps.
after_times[i] contains the difference between pulse_timestamps[i] and the
closest greater time contained in other_times or a inf number if there was
no later time in external_trigger_timestamps.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">nearest_arrivals</span><span class="p">(</span><span class="n">reference_times</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">other_times</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the external trigger time immediately before and after each pulse timestamp</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse_timestamps - 1d array of pulse timestamps whose nearest neighbors</span>
<span class="sd">            need to be found.</span>
<span class="sd">        external_trigger_timestamps - 1d array of possible nearest neighbors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (before_times, after_times)</span>

<span class="sd">    before_times is an ndarray of the same size as pulse_timestamps.</span>
<span class="sd">    before_times[i] contains the difference between the closest lesser time</span>
<span class="sd">    contained in external_trigger_timestamps and pulse_timestamps[i]  or inf if there was no</span>
<span class="sd">    earlier time in other_times Note that before_times is always a positive</span>
<span class="sd">    number even though the time difference it represents is negative.</span>

<span class="sd">    after_times is an ndarray of the same size as pulse_timestamps.</span>
<span class="sd">    after_times[i] contains the difference between pulse_timestamps[i] and the</span>
<span class="sd">    closest greater time contained in other_times or a inf number if there was</span>
<span class="sd">    no later time in external_trigger_timestamps.</span>
<span class="sd">    """</span>
    <span class="n">other_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">other_times</span><span class="p">)</span>
    <span class="n">nearest_after_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">other_times</span><span class="p">,</span> <span class="n">reference_times</span><span class="p">)</span>
    <span class="c1"># because both sets of arrival times should be sorted, there are faster algorithms than searchsorted</span>
    <span class="c1"># for example: https://github.com/kwgoodman/bottleneck/issues/47</span>
    <span class="c1"># we could use one if performance becomes an issue</span>
    <span class="n">last_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">nearest_after_index</span><span class="p">,</span> <span class="n">other_times</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">"left"</span><span class="p">)</span>
    <span class="n">first_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">nearest_after_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">nearest_before_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nearest_after_index</span><span class="p">)</span>
    <span class="n">nearest_before_index</span><span class="p">[:</span><span class="n">first_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">nearest_before_index</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">before_times</span> <span class="o">=</span> <span class="n">reference_times</span> <span class="o">-</span> <span class="n">other_times</span><span class="p">[</span><span class="n">nearest_before_index</span><span class="p">]</span>
    <span class="n">before_times</span><span class="p">[:</span><span class="n">first_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">nearest_after_index</span><span class="p">[</span><span class="n">last_index</span><span class="p">:]</span> <span class="o">=</span> <span class="n">other_times</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">after_times</span> <span class="o">=</span> <span class="n">other_times</span><span class="p">[</span><span class="n">nearest_after_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_times</span>
    <span class="n">after_times</span><span class="p">[</span><span class="n">last_index</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">return</span> <span class="n">before_times</span><span class="p">,</span> <span class="n">after_times</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.time_drift_correct">
<code class="highlight language-python"><span class="n">time_drift_correct</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">sec_per_degree</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">pulses_per_degree</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">max_degrees</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ndeg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Compute a time-based drift correction that minimizes the spectral entropy.</p>
<p>Args:
    time: The "time-axis". Correction will be a low-order polynomial in this.
    uncorrected: A filtered pulse height vector. Same length as indicator.
        Assumed to have some gain that is linearly related to indicator.
    w: the kernel width for the Laplace KDE density estimator
    sec_per_degree: assign as many as one polynomial degree per this many seconds
    pulses_per_degree: assign as many as one polynomial degree per this many pulses
    max_degrees: never use more than this many degrees of Legendre polynomial.
    n_deg: If not None, use this many degrees, regardless of the values of
           sec_per_degree, pulses_per_degree, and max_degress. In this case, never downsample.
    limit: The [lower,upper] limit of uncorrected values over which entropy is
        computed (default None).</p>
<p>The entropy will be computed on corrected values only in the range
[limit[0], limit[1]], so limit should be set to a characteristic large value
of uncorrected. If limit is None (the default), then it will be computed as
25%% larger than the 99%%ile point of uncorrected.</p>
<p>Possible improvements in the future:
* Use Numba to speed up.
* Allow the parameters to be function arguments with defaults: photons per
  degree of freedom, seconds per degree of freedom, and max degrees of freedom.
* Figure out how to span the available time with more than one set of legendre
  polynomials, so that we can have more than 20 d.o.f. eventually, for long runs.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">time_drift_correct</span><span class="p">(</span>  <span class="c1"># noqa: PLR0914</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">uncorrected</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sec_per_degree</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">pulses_per_degree</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">max_degrees</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">ndeg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Compute a time-based drift correction that minimizes the spectral entropy.</span>

<span class="sd">    Args:</span>
<span class="sd">        time: The "time-axis". Correction will be a low-order polynomial in this.</span>
<span class="sd">        uncorrected: A filtered pulse height vector. Same length as indicator.</span>
<span class="sd">            Assumed to have some gain that is linearly related to indicator.</span>
<span class="sd">        w: the kernel width for the Laplace KDE density estimator</span>
<span class="sd">        sec_per_degree: assign as many as one polynomial degree per this many seconds</span>
<span class="sd">        pulses_per_degree: assign as many as one polynomial degree per this many pulses</span>
<span class="sd">        max_degrees: never use more than this many degrees of Legendre polynomial.</span>
<span class="sd">        n_deg: If not None, use this many degrees, regardless of the values of</span>
<span class="sd">               sec_per_degree, pulses_per_degree, and max_degress. In this case, never downsample.</span>
<span class="sd">        limit: The [lower,upper] limit of uncorrected values over which entropy is</span>
<span class="sd">            computed (default None).</span>

<span class="sd">    The entropy will be computed on corrected values only in the range</span>
<span class="sd">    [limit[0], limit[1]], so limit should be set to a characteristic large value</span>
<span class="sd">    of uncorrected. If limit is None (the default), then it will be computed as</span>
<span class="sd">    25%% larger than the 99%%ile point of uncorrected.</span>

<span class="sd">    Possible improvements in the future:</span>
<span class="sd">    * Use Numba to speed up.</span>
<span class="sd">    * Allow the parameters to be function arguments with defaults: photons per</span>
<span class="sd">      degree of freedom, seconds per degree of freedom, and max degrees of freedom.</span>
<span class="sd">    * Figure out how to span the available time with more than one set of legendre</span>
<span class="sd">      polynomials, so that we can have more than 20 d.o.f. eventually, for long runs.</span>
<span class="sd">    """</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pct99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">pct99</span><span class="p">)</span>

    <span class="n">use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">uncorrected</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uncorrected</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">use</span><span class="p">])</span>
    <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">[</span><span class="n">use</span><span class="p">])</span>

    <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">-</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"tmin"</span><span class="p">:</span> <span class="n">tmin</span><span class="p">,</span>
        <span class="s2">"tmax"</span><span class="p">:</span> <span class="n">tmax</span><span class="p">,</span>
        <span class="s2">"normalize"</span><span class="p">:</span> <span class="n">normalize</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">dtime</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">-</span> <span class="n">tmin</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndeg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ndeg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">dtime</span> <span class="o">/</span> <span class="n">sec_per_degree</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="n">pulses_per_degree</span><span class="p">))</span>
        <span class="n">ndeg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="n">max_degrees</span><span class="p">)</span>
        <span class="n">ndeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">phot_per_degree</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ndeg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phot_per_degree</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pulses_per_degree</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">phot_per_degree</span> <span class="o">/</span> <span class="n">pulses_per_degree</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[::</span><span class="n">downsample</span><span class="p">]</span>
            <span class="n">uncorrected</span> <span class="o">=</span> <span class="n">uncorrected</span><span class="p">[::</span><span class="n">downsample</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Using </span><span class="si">%2d</span><span class="s2"> degrees for </span><span class="si">%6d</span><span class="s2"> photons (after </span><span class="si">%d</span><span class="s2"> downsample)"</span><span class="p">,</span> <span class="n">ndeg</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">downsample</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"That's </span><span class="si">%6.1f</span><span class="s2"> photons per degree, and </span><span class="si">%6.1f</span><span class="s2"> seconds per degree."</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ndeg</span><span class="p">),</span> <span class="n">dtime</span> <span class="o">/</span> <span class="n">ndeg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">model1</span><span class="p">(</span><span class="n">pi</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">pcopy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">pcopy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pcopy</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cost1</span><span class="p">(</span><span class="n">pi</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">model1</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">xnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">legendre</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)(</span><span class="n">xnorm</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndeg</span><span class="p">)])</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">"coefficients"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndeg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndeg</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">_fval</span><span class="p">,</span> <span class="n">_iter</span><span class="p">,</span> <span class="n">funcalls</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">brent</span><span class="p">(</span>
            <span class="n">cost1</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">uncorrected</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">basis</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">fc</span> <span class="o">+=</span> <span class="n">funcalls</span>
        <span class="n">model</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">legendre</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">result</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">"coefficients"</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">"funccalls"</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span>

    <span class="n">xk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ndeg</span><span class="p">)</span>
    <span class="n">model2</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">xk</span><span class="p">,</span> <span class="n">model</span><span class="p">(</span><span class="n">xk</span><span class="p">))</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">uncorrected</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="p">(</span><span class="n">xnorm</span><span class="p">)),</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">H3</span> <span class="o">=</span> <span class="n">laplace_entropy</span><span class="p">(</span><span class="n">uncorrected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model2</span><span class="p">(</span><span class="n">xnorm</span><span class="p">)),</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">H2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">H2</span> <span class="o">-</span> <span class="n">H1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">H3</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">H3</span> <span class="o">-</span> <span class="n">H2</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model2</span>

    <span class="n">info</span><span class="p">[</span><span class="s2">"entropies"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">H1</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">H3</span><span class="p">)</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">"model"</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
    <span class="k">return</span> <span class="n">info</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.analysis_algorithms.unwrap_n">
<code class="highlight language-python"><span class="n">unwrap_n</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Unwrap data that has been restricted to a given period.</p>
<p>The algorithm iterates through each data point and compares
it to the average of the previous n data points. It then
offsets the data point by the multiple of the period that
will minimize the difference from that n-point running average.</p>
<p>For the first n data points, there are not enough preceding
points to average n of them, so the algorithm will average
fewer points.</p>
<p>This code was written by Thomas Baker; integrated into MASS by Dan
Becker. Sped up 300x by @njit.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>data</code></b>
                  (<code>array of data values</code>)
              
              <div class="doc-md-description">
</div>
</li>
<li>
<b><code>period</code></b>
                  (<code>the range over which the data loops</code>)
              
              <div class="doc-md-description">
</div>
</li>
<li>
<b><code>n</code></b>
                  (<code>how many preceding points to average</code>, default:
                      <code>3</code>
)
              
              <div class="doc-md-description">
</div>
</li>
<li>
<b><code>mask</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/analysis_algorithms.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unwrap_n</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">],</span> <span class="n">period</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Unwrap data that has been restricted to a given period.</span>

<span class="sd">    The algorithm iterates through each data point and compares</span>
<span class="sd">    it to the average of the previous n data points. It then</span>
<span class="sd">    offsets the data point by the multiple of the period that</span>
<span class="sd">    will minimize the difference from that n-point running average.</span>

<span class="sd">    For the first n data points, there are not enough preceding</span>
<span class="sd">    points to average n of them, so the algorithm will average</span>
<span class="sd">    fewer points.</span>

<span class="sd">    This code was written by Thomas Baker; integrated into MASS by Dan</span>
<span class="sd">    Becker. Sped up 300x by @njit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array of data values</span>
<span class="sd">    period : the range over which the data loops</span>
<span class="sd">    n : how many preceding points to average</span>
<span class="sd">    mask: mask indentifying "good" pulses</span>
<span class="sd">    """</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">udata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># make a copy for output</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">udata</span>

    <span class="c1"># Iterate through each data point and offset it by</span>
    <span class="c1"># an amount that will minimize the difference from the</span>
    <span class="c1"># rolling average</span>
    <span class="n">nprior</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">firstgoodidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">priorvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">udata</span><span class="p">[</span><span class="n">firstgoodidx</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="c1"># Take the average of the previous n data points (only those with mask[i]==True).</span>
        <span class="c1"># Offset the data point by the most reasonable multiple of period (make this point closest to the running average).</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">priorvalues</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nprior</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">priorvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">nprior</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">priorvalues</span><span class="p">[:</span><span class="n">nprior</span><span class="p">])</span>
        <span class="n">udata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">udata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">avg</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span> <span class="o">*</span> <span class="n">period</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">priorvalues</span><span class="p">[</span><span class="n">nprior</span> <span class="o">%</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">udata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nprior</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">udata</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.recipe"></a>
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.ColumnAsNumpyMapStep">
<code>ColumnAsNumpyMapStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>This step is meant for interactive exploration, it takes a column and applies a function to it,
and makes a new column with the result. It makes it easy to test functions on a column without
having to write a whole new step class,
while maintaining the benefit of being able to use the step in a Recipe chain, like replaying steps
on another channel.</p>
<p>example usage:</p>
<blockquote>
<blockquote>
<blockquote>
<p>def my_function(x):
...     return x * 2
step = ColumnAsNumpyMapStep(inputs=["my_column"], output=["my_new_column"], f=my_function)
ch2 = ch.with_step(step)</p>
</blockquote>
</blockquote>
</blockquote>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ColumnAsNumpyMapStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This step is meant for interactive exploration, it takes a column and applies a function to it,</span>
<span class="sd">    and makes a new column with the result. It makes it easy to test functions on a column without</span>
<span class="sd">    having to write a whole new step class,</span>
<span class="sd">    while maintaining the benefit of being able to use the step in a Recipe chain, like replaying steps</span>
<span class="sd">    on another channel.</span>

<span class="sd">    example usage:</span>
<span class="sd">    &gt;&gt;&gt; def my_function(x):</span>
<span class="sd">    ...     return x * 2</span>
<span class="sd">    &gt;&gt;&gt; step = ColumnAsNumpyMapStep(inputs=["my_column"], output=["my_new_column"], f=my_function)</span>
<span class="sd">    &gt;&gt;&gt; ch2 = ch.with_step(step)</span>
<span class="sd">    """</span>

    <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ColumnMapStep expects exactly one input"</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ColumnMapStep expects exactly one output"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"f must be a callable, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">output_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df_iter</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">iter_slices</span><span class="p">():</span>
            <span class="n">series1</span> <span class="o">=</span> <span class="n">df_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># Have to apply the function differently when series elements are arrays vs scalars</span>
            <span class="k">if</span> <span class="n">series1</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_type</span><span class="p">()</span> <span class="ow">is</span> <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
                <span class="n">output_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">series1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_numpy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">series1</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="n">this_output_segment</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span> <span class="n">output_numpy</span><span class="p">)</span>
            <span class="n">output_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_output_segment</span><span class="p">)</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">output_segments</span><span class="p">)</span>
        <span class="c1"># Put into a DataFrame with one column</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">output_col</span><span class="p">:</span> <span class="n">combined</span><span class="p">})</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.Recipe">
<code>Recipe</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a>]</code></p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Recipe</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]):</span>
    <span class="n">steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]</span>

    <span class="c1"># TODO: leaves many optimizations on the table, but is very simple</span>
    <span class="c1"># 1. we could calculate filt_value_5lag and filt_phase_5lag at the same time</span>
    <span class="c1"># 2. we could calculate intermediate quantities optionally and not materialize all of them</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="s2">"return a dataframe with all the newly calculated info"</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">([])</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecipeStep</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecipeStep</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RecipeStep</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">RecipeStep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
        <span class="c1"># return a new Recipe with the step added, no mutation!</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="p">[</span><span class="n">step</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trim_dead_ends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create a new Recipe object with all dead-end steps (and optionally also debug info) removed.</span>

<span class="sd">        The purpose is to replace the fully useful interactive Recipe with a trimmed-down object that can</span>
<span class="sd">        repeat the current steps as a "recipe" without having the extra information from which the recipe</span>
<span class="sd">        was first created. In one test, this method reduced the pickle file's size from 3.4 MB per channel</span>
<span class="sd">        to 30 kB per channel, or a 112x size reduction (with `drop_debug=True`).</span>

<span class="sd">        Dead-end steps are defined as any step that can be omitted without affecting the ability to</span>
<span class="sd">        compute any of the fields given in `required_fields`. The result of this method is to return</span>
<span class="sd">        a Recipe where any step is remove if it does not contribute to computing any of the `required_fields`</span>
<span class="sd">        (i.e., if it is a dead end).</span>

<span class="sd">        Examples of a dead end are typically steps used to prepare a tentative, intermediate calibration function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        required_fields : Iterable[str] | str | None</span>
<span class="sd">            Steps will be preserved if any of their outputs are among `required_fields`, or if their outputs are</span>
<span class="sd">            found recursively among the inputs to any such steps. If a string, treat as a list of that one string.</span>
<span class="sd">            If None, preserve all steps.</span>

<span class="sd">        drop_debug : bool</span>
<span class="sd">            Whether to run `step.drop_debug()` to remove debugging information from the preserved steps.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Recipe</span>
<span class="sd">            A copy of `self`, except that any steps not required to compute any of `required_fields` are omitted.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">required_fields</span><span class="p">]</span>

        <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">required</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># The easiest approach is to traverse the steps from last to first to build our list of required</span>
        <span class="c1"># fields, because necessarily no later step can produce the inputs needed by an earlier step.</span>
        <span class="k">if</span> <span class="n">required_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">required</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_fields_out</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">all_fields_out</span><span class="p">:</span>
                        <span class="n">required</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">all_fields_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">required</span><span class="p">):</span>
            <span class="c1"># If this error ever because a problem, where user _acutally_ wants an empty series of steps</span>
            <span class="c1"># to be a non-err, then add argument `error_on_empty_output=True` to this method.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"trim_dead_ends found no steps to be preserved"</span><span class="p">)</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">required</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">drop_debug</span><span class="p">:</span>
                    <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_debug</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.calc_from_df">
<code class="highlight language-python"><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>return a dataframe with all the newly calculated info</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s2">"return a dataframe with all the newly calculated info"</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">calc_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.Recipe.trim_dead_ends">
<code class="highlight language-python"><span class="n">trim_dead_ends</span><span class="p">(</span><span class="n">required_fields</span><span class="p">,</span> <span class="n">drop_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Create a new Recipe object with all dead-end steps (and optionally also debug info) removed.</p>
<p>The purpose is to replace the fully useful interactive Recipe with a trimmed-down object that can
repeat the current steps as a "recipe" without having the extra information from which the recipe
was first created. In one test, this method reduced the pickle file's size from 3.4 MB per channel
to 30 kB per channel, or a 112x size reduction (with <code>drop_debug=True</code>).</p>
<p>Dead-end steps are defined as any step that can be omitted without affecting the ability to
compute any of the fields given in <code>required_fields</code>. The result of this method is to return
a Recipe where any step is remove if it does not contribute to computing any of the <code>required_fields</code>
(i.e., if it is a dead end).</p>
<p>Examples of a dead end are typically steps used to prepare a tentative, intermediate calibration function.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>required_fields</code></b>
                  (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="str">str</span>] | <span title="str">str</span> | None</code>)
              
              <div class="doc-md-description">
<p>Steps will be preserved if any of their outputs are among <code>required_fields</code>, or if their outputs are
found recursively among the inputs to any such steps. If a string, treat as a list of that one string.
If None, preserve all steps.</p>
</div>
</li>
<li>
<b><code>drop_debug</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              
              <div class="doc-md-description">
<p>Whether to run <code>step.drop_debug()</code> to remove debugging information from the preserved steps.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Recipe


  
      dataclass
   (mass2.core.recipe.Recipe)" href="#mass2.core.recipe.Recipe">Recipe</a></code>
              
              <div class="doc-md-description">
<p>A copy of <code>self</code>, except that any steps not required to compute any of <code>required_fields</code> are omitted.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trim_dead_ends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Recipe"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create a new Recipe object with all dead-end steps (and optionally also debug info) removed.</span>

<span class="sd">    The purpose is to replace the fully useful interactive Recipe with a trimmed-down object that can</span>
<span class="sd">    repeat the current steps as a "recipe" without having the extra information from which the recipe</span>
<span class="sd">    was first created. In one test, this method reduced the pickle file's size from 3.4 MB per channel</span>
<span class="sd">    to 30 kB per channel, or a 112x size reduction (with `drop_debug=True`).</span>

<span class="sd">    Dead-end steps are defined as any step that can be omitted without affecting the ability to</span>
<span class="sd">    compute any of the fields given in `required_fields`. The result of this method is to return</span>
<span class="sd">    a Recipe where any step is remove if it does not contribute to computing any of the `required_fields`</span>
<span class="sd">    (i.e., if it is a dead end).</span>

<span class="sd">    Examples of a dead end are typically steps used to prepare a tentative, intermediate calibration function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    required_fields : Iterable[str] | str | None</span>
<span class="sd">        Steps will be preserved if any of their outputs are among `required_fields`, or if their outputs are</span>
<span class="sd">        found recursively among the inputs to any such steps. If a string, treat as a list of that one string.</span>
<span class="sd">        If None, preserve all steps.</span>

<span class="sd">    drop_debug : bool</span>
<span class="sd">        Whether to run `step.drop_debug()` to remove debugging information from the preserved steps.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Recipe</span>
<span class="sd">        A copy of `self`, except that any steps not required to compute any of `required_fields` are omitted.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">required_fields</span><span class="p">]</span>

    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># The easiest approach is to traverse the steps from last to first to build our list of required</span>
    <span class="c1"># fields, because necessarily no later step can produce the inputs needed by an earlier step.</span>
    <span class="k">if</span> <span class="n">required_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">required</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_fields_out</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_fields</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">all_fields_out</span><span class="p">:</span>
                    <span class="n">required</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">all_fields_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">required</span><span class="p">):</span>
        <span class="c1"># If this error ever because a problem, where user _acutally_ wants an empty series of steps</span>
        <span class="c1"># to be a non-err, then add argument `error_on_empty_output=True` to this method.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"trim_dead_ends found no steps to be preserved"</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">required</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">drop_debug</span><span class="p">:</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">drop_debug</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Recipe</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.RecipeStep">
<code>RecipeStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RecipeStep</span><span class="p">:</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">good_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>
    <span class="n">use_expr</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> inputs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="si">}</span><span class="s2"> outputs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: should this be an abstract method?</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_expr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_after</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
        <span class="c1"># this is a no-op, subclasses can override this to plot something</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"No plot defined for: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RecipeStep"</span><span class="p">:</span>
        <span class="s2">"Return self, or a copy of it with debug information removed"</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.recipe.RecipeStep.drop_debug">
<code class="highlight language-python"><span class="n">drop_debug</span><span class="p">()</span></code>
</h3>
<div class="doc doc-contents">
<p>Return self, or a copy of it with debug information removed</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">drop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RecipeStep"</span><span class="p">:</span>
    <span class="s2">"Return self, or a copy of it with debug information removed"</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.recipe.SelectStep">
<code>SelectStep</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="RecipeStep


  
      dataclass
   (mass2.core.recipe.RecipeStep)" href="#mass2.core.recipe.RecipeStep">RecipeStep</a></code></p>
<p>This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/recipe.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SelectStep</span><span class="p">(</span><span class="n">RecipeStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This step is meant for interactive exploration, it's basically like the df.select() method, but it's saved as a step.</span>

<span class="sd">    """</span>

    <span class="n">col_expr_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Expr</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">col_expr_dict</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.drift_correction"></a>
<div class="doc doc-contents first">
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.filter_steps"></a>
<div class="doc doc-contents first">
<div class="doc doc-children">
</div>
</div>
</div>
<div class="doc doc-object doc-module">
<a id="mass2.core.optimal_filtering"></a>
<div class="doc doc-contents first">
<p>Classes to create time-domain and Fourier-domain optimal filters.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter">
<code>Filter</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>
<p>A single optimal filter, possibly with optimal estimators of the Delta-t and of the DC level.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A set of optimal filter values.</p>
<p>These values are chosen with the following specifics:
* one model of the pulses and of the noise, including pulse record length,
* a first-order arrival-time detection filter is (optionally) computed
* filtering model (1-lag, or other odd # of lags),
* low-pass smoothing of the filter itself,
* a fixed number of samples "cut" (given zero weight) at the start and/or end of records.</p>
<p>The object also stores the pulse shape and (optionally) the delta-T shape used to generate it,
and the low-pass filter's fmax or f_3db (cutoff or rolloff) frequency.</p>
<p>It also stores the predicted <code>variance</code> due to noise and the resulting <code>predicted_v_over_dv</code>,
the ratio of the filtered pulse height to the (FWHM) noise, in pulse height units. Both
of these values assume pulses of the same size as that used to generate the filter: <code>nominal_peak</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A single optimal filter, possibly with optimal estimators of the Delta-t and of the DC level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A set of optimal filter values.</span>

<span class="sd">        These values are chosen with the following specifics:</span>
<span class="sd">        * one model of the pulses and of the noise, including pulse record length,</span>
<span class="sd">        * a first-order arrival-time detection filter is (optionally) computed</span>
<span class="sd">        * filtering model (1-lag, or other odd # of lags),</span>
<span class="sd">        * low-pass smoothing of the filter itself,</span>
<span class="sd">        * a fixed number of samples "cut" (given zero weight) at the start and/or end of records.</span>

<span class="sd">        The object also stores the pulse shape and (optionally) the delta-T shape used to generate it,</span>
<span class="sd">        and the low-pass filter's fmax or f_3db (cutoff or rolloff) frequency.</span>

<span class="sd">        It also stores the predicted `variance` due to noise and the resulting `predicted_v_over_dv`,</span>
<span class="sd">        the ratio of the filtered pulse height to the (FWHM) noise, in pulse height units. Both</span>
<span class="sd">        of these values assume pulses of the same size as that used to generate the filter: `nominal_peak`.</span>

<span class="sd">    """</span>

    <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">nominal_peak</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">variance</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">predicted_v_over_dv</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">dt_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">const_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">signal_model</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">dt_model</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">convolution_lags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"illegal: this is supposed to be an abstract base class"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a plot of the filter</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axis : plt.Axes, optional</span>
<span class="sd">            A pre-existing axis to plot on, by default None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"mass 5lag filter"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_type</span><span class="si">=}</span><span class="s2"> V/dV=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"filter value"</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Lag Time (s)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5898.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Report on estimated V/dV for the filter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        std_energy : float, optional</span>
<span class="sd">            Energy (in eV) of a "standard" pulse.  Resolution will be given in eV at this energy,</span>
<span class="sd">                assuming linear devices, by default 5898.8</span>
<span class="sd">        """</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span>
        <span class="n">v_dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span>
        <span class="n">fwhm_eV</span> <span class="o">=</span> <span class="n">std_energy</span> <span class="o">/</span> <span class="n">v_dv</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"v/</span><span class="se">\u03b4</span><span class="s2">v: </span><span class="si">{</span><span class="n">v_dv</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">, variance: </span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\u03b4</span><span class="s2">E: </span><span class="si">{</span><span class="n">fwhm_eV</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV (FWHM), assuming standard E=</span><span class="si">{</span><span class="n">std_energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.plot">
<code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Make a plot of the filter</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>axis</code></b>
                  (<code><span title="matplotlib.pylab.Axes">Axes</span></code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>A pre-existing axis to plot on, by default None</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Make a plot of the filter</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axis : plt.Axes, optional</span>
<span class="sd">        A pre-existing axis to plot on, by default None</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"mass 5lag filter"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_type</span><span class="si">=}</span><span class="s2"> V/dV=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"filter value"</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Lag Time (s)"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter.report">
<code class="highlight language-python"><span class="n">report</span><span class="p">(</span><span class="n">std_energy</span><span class="o">=</span><span class="mf">5898.8</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Report on estimated V/dV for the filter.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>std_energy</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>5898.8</code>
)
              
              <div class="doc-md-description">
<p>Energy (in eV) of a "standard" pulse.  Resolution will be given in eV at this energy,
    assuming linear devices, by default 5898.8</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5898.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Report on estimated V/dV for the filter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    std_energy : float, optional</span>
<span class="sd">        Energy (in eV) of a "standard" pulse.  Resolution will be given in eV at this energy,</span>
<span class="sd">            assuming linear devices, by default 5898.8</span>
<span class="sd">    """</span>
    <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span>
    <span class="n">v_dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicted_v_over_dv</span>
    <span class="n">fwhm_eV</span> <span class="o">=</span> <span class="n">std_energy</span> <span class="o">/</span> <span class="n">v_dv</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"v/</span><span class="se">\u03b4</span><span class="s2">v: </span><span class="si">{</span><span class="n">v_dv</span><span class="si">:</span><span class="s2"> .2f</span><span class="si">}</span><span class="s2">, variance: </span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\u03b4</span><span class="s2">E: </span><span class="si">{</span><span class="n">fwhm_eV</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV (FWHM), assuming standard E=</span><span class="si">{</span><span class="n">std_energy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag">
<code>Filter5Lag</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code></p>
<p>Represent an optimal filter, specifically one intended for 5-lag convolution with data</p>
<pre><code>The traditional 5-lag filter used by default until 2015.
</code></pre>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter5Lag


  
      dataclass
   (mass2.core.optimal_filtering.Filter5Lag)" href="#mass2.core.optimal_filtering.Filter5Lag">Filter5Lag</a></code>
              
              <div class="doc-md-description">
<p>An optimal filter, for convolution with data (at 5 lags, obviously)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Filter5Lag</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represent an optimal filter, specifically one intended for 5-lag convolution with data</span>

<span class="sd">        The traditional 5-lag filter used by default until 2015.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter5Lag</span>
<span class="sd">        An optimal filter, for convolution with data (at 5 lags, obviously)</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">5</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"5lag"</span>

    <span class="c1"># These parameters fit a parabola to any 5 evenly-spaced points</span>
    <span class="n">FIVELAG_FITTER</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="mf">70.0</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            A 1-d array, a single pulse record, or a 2-d array, where `x[i, :]` is pulse record number `i`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">            2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the input array is the wrong length</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">nrec</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span>
        <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">nrec</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlags</span><span class="p">,</span> <span class="n">nrec</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nlags</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">conv</span><span class="p">[</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Least-squares fit of 5 values to a parabola.</span>
        <span class="c1"># Order is row 0 = constant ... row 2 = quadratic coefficients.</span>
        <span class="k">if</span> <span class="n">nlags</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Currently require 5 lags to estimate peak x, y"</span><span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIVELAG_FITTER</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="n">peak_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">peak_y</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.Filter5Lag.filter_records">
<code class="highlight language-python"><span class="n">filter_records</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Filter one microcalorimeter record or an array of records.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 1-d array, a single pulse record, or a 2-d array, where <code>x[i, :]</code> is pulse record number <code>i</code>.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
              
              <div class="doc-md-description">
<ol>
<li>The optimally filtered value, or an array (one per row) if the input is a 2-d array.</li>
<li>The phase, or arrival-time estimate in samples. Same shape as the filtered value.</li>
</ol>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="AssertionError">AssertionError</span></code>
              
              <div class="doc-md-description">
<p>If the input array is the wrong length</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        A 1-d array, a single pulse record, or a 2-d array, where `x[i, :]` is pulse record number `i`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">        2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AssertionError</span>
<span class="sd">        If the input array is the wrong length</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">nrec</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span>
    <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nrec</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlags</span><span class="p">,</span> <span class="n">nrec</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nlags</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">conv</span><span class="p">[</span><span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">nlags</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Least-squares fit of 5 values to a parabola.</span>
    <span class="c1"># Order is row 0 = constant ... row 2 = quadratic coefficients.</span>
    <span class="k">if</span> <span class="n">nlags</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Currently require 5 lags to estimate peak x, y"</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIVELAG_FITTER</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
    <span class="n">peak_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">peak_y</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">peak_y</span><span class="p">,</span> <span class="n">peak_x</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS">
<code>FilterATS</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code></p>
<p>Represent an optimal filter according to the arrival-time-safe, single-lag design of 2015.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="FilterATS


  
      dataclass
   (mass2.core.optimal_filtering.FilterATS)" href="#mass2.core.optimal_filtering.FilterATS">FilterATS</a></code>
              
              <div class="doc-md-description">
<p>An optimal filter, for convolution with data (at 5 lags, obviously)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterATS</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Represent an optimal filter according to the arrival-time-safe, single-lag design of 2015.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FilterATS</span>
<span class="sd">        An optimal filter, for convolution with data (at 5 lags, obviously)</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolution_lags</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_arrival_time_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Is this an arrival-time-safe filter?"""</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"ats"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ArrayLike</span>
<span class="sd">            A 1-d array, a single pulse record, or a 2-d array, each row a pulse records.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">            2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the input array is the wrong length</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_filter_records_ats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-attribute">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS.is_arrival_time_safe">
<code class="highlight language-python"><span class="n">is_arrival_time_safe</span></code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-property"><code>property</code></small>
</span>
</h3>
<div class="doc doc-contents">
<p>Is this an arrival-time-safe filter?</p>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterATS.filter_records">
<code class="highlight language-python"><span class="n">filter_records</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Filter one microcalorimeter record or an array of records.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>x</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>A 1-d array, a single pulse record, or a 2-d array, each row a pulse records.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="tuple">tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
              
              <div class="doc-md-description">
<ol>
<li>The optimally filtered value, or an array (one per row) if the input is a 2-d array.</li>
<li>The phase, or arrival-time estimate in samples. Same shape as the filtered value.</li>
</ol>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="AssertionError">AssertionError</span></code>
              
              <div class="doc-md-description">
<p>If the input array is the wrong length</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Filter one microcalorimeter record or an array of records.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : ArrayLike</span>
<span class="sd">        A 1-d array, a single pulse record, or a 2-d array, each row a pulse records.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        1. The optimally filtered value, or an array (one per row) if the input is a 2-d array.</span>
<span class="sd">        2. The phase, or arrival-time estimate in samples. Same shape as the filtered value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AssertionError</span>
<span class="sd">        If the input array is the wrong length</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">nsamp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">assert</span> <span class="n">nsamp</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_filter_records_ats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker">
<code>FilterMaker</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An object capable of creating optimal filter based on a single signal and noise set.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>signal_model</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span></code>)
              
              <div class="doc-md-description">
<p>The average signal shape.  Filters will be rescaled so that the output
upon putting this signal into the filter equals the <em>peak value</em> of this
filter (that is, peak value relative to the baseline level).</p>
</div>
</li>
<li>
<b><code>n_pretrigger</code></b>
                  (<code><span title="int">int</span></code>)
              
              <div class="doc-md-description">
<p>The number of leading samples in the average signal that are considered
to be pre-trigger samples.  The avg_signal in this section is replaced by
its constant averaged value before creating filters.  Also, one filter
(filt_baseline_pretrig) is designed to infer the baseline using only
<code>n_pretrigger</code> samples at the start of a record.</p>
</div>
</li>
<li>
<b><code>noise_autocorr</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The autocorrelation function of the noise, where the lag spacing is
assumed to be the same as the sample period of <code>avg_signal</code>.</p>
</div>
</li>
<li>
<b><code>noise_psd</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The noise power spectral density.  If not None, then it must be of length (2N+1),
where N is the length of <code>avg_signal</code>, and its values are assumed to cover the
non-negative frequencies from 0, 1/Delta, 2/Delta,.... up to the Nyquist frequency.
If None, then method <code>compute_fourier()</code> will not work.</p>
</div>
</li>
<li>
<b><code>whitener</code></b>
                  (<code><span title="Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ToeplitzWhitener


  
      dataclass
   (mass2.core.optimal_filtering.ToeplitzWhitener)" href="#mass2.core.optimal_filtering.ToeplitzWhitener">ToeplitzWhitener</a>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>An optional function object which, when called, whitens a vector or the
columns of a matrix. Supersedes <code>noise_autocorr</code> if both are given.</p>
</div>
</li>
<li>
<b><code>sample_time_sec</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0</code>
)
              
              <div class="doc-md-description">
<p>The time step between samples in <code>avg_signal</code> and <code>noise_autocorr</code> (in seconds).
This must be given if <code>fmax</code> or <code>f_3db</code> are ever to be used.</p>
</div>
</li>
<li>
<b><code>peak</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0</code>
)
              
              <div class="doc-md-description">
<p>The peak amplitude of the standard signal</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="note" open="">
<summary>Notes</summary>
<ul>
<li>
<p>If both <code>noise_autocorr</code> and <code>whitener</code> are None, then methods <code>compute_5lag</code> and
<code>compute_ats</code> will both fail, as they require a time-domain characterization of the
noise.</p>
</li>
<li>
<p>The units of <code>noise_autocorr</code> are the square of the units used in <code>signal_model</code> and/or
<code>peak</code>. The units of <code>whitener</code> are the inverse of the signal units.  Any rescaling of the
noise autocorrelation or whitener does not affect any filter values, but only
the predicted signal/noise ratios.</p>
</li>
<li>
<p>The units of <code>noise_psd</code> are square signal units, per Hertz.</p>
</li>
</ul>
</details>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="FilterMaker


  
      dataclass
   (mass2.core.optimal_filtering.FilterMaker)" href="#mass2.core.optimal_filtering.FilterMaker">FilterMaker</a></code>
              
              <div class="doc-md-description">
<p>An object that can make a variety of optimal filters, assuming a single signal and noise analysis.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An object capable of creating optimal filter based on a single signal and noise set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    signal_model : ArrayLike</span>
<span class="sd">        The average signal shape.  Filters will be rescaled so that the output</span>
<span class="sd">        upon putting this signal into the filter equals the *peak value* of this</span>
<span class="sd">        filter (that is, peak value relative to the baseline level).</span>
<span class="sd">    n_pretrigger : int</span>
<span class="sd">        The number of leading samples in the average signal that are considered</span>
<span class="sd">        to be pre-trigger samples.  The avg_signal in this section is replaced by</span>
<span class="sd">        its constant averaged value before creating filters.  Also, one filter</span>
<span class="sd">        (filt_baseline_pretrig) is designed to infer the baseline using only</span>
<span class="sd">        `n_pretrigger` samples at the start of a record.</span>
<span class="sd">    noise_autocorr : Optional[ArrayLike]</span>
<span class="sd">        The autocorrelation function of the noise, where the lag spacing is</span>
<span class="sd">        assumed to be the same as the sample period of `avg_signal`.</span>
<span class="sd">    noise_psd : Optional[ArrayLike]</span>
<span class="sd">        The noise power spectral density.  If not None, then it must be of length (2N+1),</span>
<span class="sd">        where N is the length of `avg_signal`, and its values are assumed to cover the</span>
<span class="sd">        non-negative frequencies from 0, 1/Delta, 2/Delta,.... up to the Nyquist frequency.</span>
<span class="sd">        If None, then method `compute_fourier()` will not work.</span>
<span class="sd">    whitener : Optional[ToeplitzWhitener]</span>
<span class="sd">        An optional function object which, when called, whitens a vector or the</span>
<span class="sd">        columns of a matrix. Supersedes `noise_autocorr` if both are given.</span>
<span class="sd">    sample_time_sec : float</span>
<span class="sd">        The time step between samples in `avg_signal` and `noise_autocorr` (in seconds).</span>
<span class="sd">        This must be given if `fmax` or `f_3db` are ever to be used.</span>
<span class="sd">    peak : float</span>
<span class="sd">        The peak amplitude of the standard signal</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    * If both `noise_autocorr` and `whitener` are None, then methods `compute_5lag` and</span>
<span class="sd">    `compute_ats` will both fail, as they require a time-domain characterization of the</span>
<span class="sd">    noise.</span>

<span class="sd">    * The units of `noise_autocorr` are the square of the units used in `signal_model` and/or</span>
<span class="sd">    `peak`. The units of `whitener` are the inverse of the signal units.  Any rescaling of the</span>
<span class="sd">    noise autocorrelation or whitener does not affect any filter values, but only</span>
<span class="sd">    the predicted signal/noise ratios.</span>

<span class="sd">    * The units of `noise_psd` are square signal units, per Hertz.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FilterMaker</span>
<span class="sd">        An object that can make a variety of optimal filters, assuming a single signal and noise analysis.</span>
<span class="sd">    """</span>

    <span class="n">signal_model</span><span class="p">:</span> <span class="n">NDArray</span>
    <span class="n">n_pretrigger</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">noise_autocorr</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">noise_psd</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dt_model</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">whitener</span><span class="p">:</span> <span class="n">ToeplitzWhitener</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sample_time_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">peak</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_constrained_5lag</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">constraints</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints: ndarray, optional</span>
<span class="sd">            The vector or vectors to which the filter should be orthogonal. If a 2d array, each _row_</span>
<span class="sd">            is a constraint, and the number of columns should be equal to the len(self.signal_model)</span>
<span class="sd">            minus `(cut_pre+cut_post)`.</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate 5-lag filters"</span><span class="p">)</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># for 5-lag convolution</span>
        <span class="n">truncated_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">,</span> <span class="s2">"Noise autocorrelation vector is too short for signal size"</span>
        <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">truncated_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pulse_model</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span>

        <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Rinv_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pulse_model</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv_model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">all_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Rinv_model</span><span class="p">)</span>
        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">band_limit</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_corr</span><span class="p">)</span>

        <span class="c1"># Set weights in the cut_pre and cut_post windows to 0</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">),</span> <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_post</span><span class="p">)])</span>

        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
            <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">vdv</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag_noexp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">        weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exp_time_seconds: float</span>
<span class="sd">            Generate a filter orthogonal to decaying exponentials of this time constant (must be positive)</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">exp_time_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">log_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">/</span> <span class="n">exp_time_seconds</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_per_sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fourier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute a single Fourier-domain filter, with optional low-pass filtering, and with optional</span>
<span class="sd">        zero weights at the pre-trigger or post-trigger end of the filter. Fourier domain calculation</span>
<span class="sd">        implicitly assumes periodic boundary conditions.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            A 5-lag optimal filter, computed in the Fourier domain.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="c1"># Make sure we have either a noise PSD or an autocorrelation or a whitener</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_psd to generate a Fourier filter"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span><span class="p">)</span>

        <span class="c1"># Terminology: the `avg_signal` vector will be "shortened" by `shorten` _on each end.</span>
        <span class="c1"># That's to permit 5-lag filtering (where we step the filter by 2 lags either direction from 0 lag).</span>
        <span class="c1"># The `avg_signal` was already "reduced" in length by (cut_pre, cut_post), for a total</span>
        <span class="c1"># `reduction` of `2 * shorten + (cut_pre + cut_post)`.</span>
        <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># to use in 5-lag style</span>
        <span class="n">reduction</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span> <span class="o">+</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">truncated_avg_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
        <span class="n">len_reduced_psd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reduction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sig_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">truncated_avg_signal</span> <span class="o">*</span> <span class="n">window</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len_reduced_psd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"signal real DFT and noise PSD are not the same length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">len_reduced_psd</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

        <span class="c1"># Careful with PSD: "shorten" it by converting into a real space autocorrelation,</span>
        <span class="c1"># truncating the middle, and going back to Fourier space</span>
        <span class="k">if</span> <span class="n">reduction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span>
            <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">noise_autocorr</span><span class="p">[:</span> <span class="n">len_reduced_psd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">noise_autocorr</span><span class="p">[</span><span class="o">-</span><span class="n">len_reduced_psd</span><span class="p">:]))</span>
            <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">))</span>
        <span class="n">sig_ft_weighted</span> <span class="o">=</span> <span class="n">sig_ft</span> <span class="o">/</span> <span class="n">noise_psd</span>

        <span class="c1"># Band-limit</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_nyquist</span><span class="p">,</span> <span class="n">len_reduced_psd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sig_ft_weighted</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">f_3db</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">filt_fourier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">sig_ft_weighted</span><span class="p">)</span> <span class="o">/</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>

        <span class="c1"># How we compute the uncertainty depends on whether there's a noise autocorrelation result</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_ft_squared</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">*</span> <span class="n">noise_psd</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">noise_ft_squared</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">variance_fourier</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">kappa</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">noise_ft_squared</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span><span class="p">)[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">)]</span>
            <span class="n">variance_fourier</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_fourier</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
            <span class="n">filt_fourier</span><span class="p">,</span>
            <span class="n">peak</span><span class="p">,</span>
            <span class="n">variance_fourier</span><span class="p">,</span>
            <span class="n">vdv</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">truncated_avg_signal</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span>
            <span class="n">fmax</span><span class="p">,</span>
            <span class="n">f_3db</span><span class="p">,</span>
            <span class="n">cut_pre</span><span class="p">,</span>
            <span class="n">cut_post</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_ats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>  <span class="c1"># noqa: PLR0914</span>
<span class="w">        </span><span class="sd">"""Compute a single "arrival-time-safe" filter, with optional low-pass filtering,</span>
<span class="sd">        and with optional zero weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">        Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmax : Optional[float], optional</span>
<span class="sd">            The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">        f_3db : Optional[float], optional</span>
<span class="sd">            The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">        cut_pre : int</span>
<span class="sd">            The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">        cut_post : int</span>
<span class="sd">            The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Filter</span>
<span class="sd">            An arrival-time-safe optimal filter.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate ATS filters"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have dt_model to generate ATS filters"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>

        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
        <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cut_pre+cut_post = </span><span class="si">{</span><span class="n">cut_pre</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cut_post</span><span class="si">}</span><span class="s2"> but should be &lt; </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">MT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">avg_signal</span><span class="p">,</span> <span class="n">dt_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ns</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">WM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="p">(</span><span class="n">MT</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WM</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">WM</span><span class="p">)</span>
            <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">WtWM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">WM</span><span class="p">)</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">WtWM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ns</span>
            <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">ns</span><span class="p">]</span>
            <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">RinvM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">MT</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="n">RinvM</span><span class="p">)</span>
            <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">RinvM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">band_limit</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nfilt</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">filt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)])</span>

        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filt_dt</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filt_baseline</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_autocorr</span><span class="p">)</span>
        <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">return</span> <span class="n">FilterATS</span><span class="p">(</span>
            <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">vdv</span><span class="p">,</span> <span class="n">filt_dt</span><span class="p">,</span> <span class="n">filt_baseline</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">,</span> <span class="n">dt_model</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_autocorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the noise autocorrelation, if any, cut down by the requested number of values at the start and end.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cut_pre : int, optional</span>
<span class="sd">            How many samples to remove from the start of the each pulse record, by default 0</span>
<span class="sd">        cut_post : int, optional</span>
<span class="sd">            How many samples to remove from the end of the each pulse record, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The noise autocorrelation of the appropriate length. Or a length-0 array if not known.</span>
<span class="sd">        """</span>
        <span class="c1"># If there's an autocorrelation, cut it down to length.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span><span class="p">)[:</span> <span class="n">N</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Compute the normalized signal, peak value, and first-order arrival-time model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cut_pre : int, optional</span>
<span class="sd">            How many samples to remove from the start of the each pulse record, by default 0</span>
<span class="sd">        cut_post : int, optional</span>
<span class="sd">            How many samples to remove from the end of the each pulse record, by default 0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, float, np.ndarray]</span>
<span class="sd">            (sig, pk, dsig), where `sig` is the nominal signal model (normalized to have unit amplitude), `pk` is the</span>
<span class="sd">            peak values of the nominal signal, and `dsig` is the delta between `sig` that differ by one sample in</span>
<span class="sd">            arrival time. The `dsig` will be an empty array if no arrival-time model is known.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If negative numbers of samples are to be cut, or the entire record is to be cut.</span>
<span class="sd">        """</span>
        <span class="n">avg_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">)</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">pre_avg</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cut_pre+cut_post = </span><span class="si">{</span><span class="n">cut_pre</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cut_post</span><span class="si">}</span><span class="s2"> but should be &lt; </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Unless passed in, find the signal's peak value. This is normally peak=(max-pretrigger).</span>
        <span class="c1"># If signal is negative-going, however, then peak=(pretrigger-min).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">peak_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">is_negative</span> <span class="o">=</span> <span class="n">pre_avg</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">-</span> <span class="n">pre_avg</span>
            <span class="k">if</span> <span class="n">is_negative</span><span class="p">:</span>
                <span class="n">peak_signal</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">pre_avg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peak_signal</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">pre_avg</span>

        <span class="c1"># avg_signal: normalize to have unit peak</span>
        <span class="n">avg_signal</span> <span class="o">-=</span> <span class="n">pre_avg</span>

        <span class="n">rescale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">avg_signal</span> <span class="o">*=</span> <span class="n">rescale</span>
        <span class="n">avg_signal</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pretrigger</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">avg_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="o">*</span> <span class="n">rescale</span>
            <span class="n">dt_model</span> <span class="o">=</span> <span class="n">dt_model</span><span class="p">[</span><span class="n">cut_pre</span> <span class="p">:</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">cut_post</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak_signal</span><span class="p">,</span> <span class="n">dt_model</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_5lag_filter</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Rescale 5-lag filter `f` in-place so that it gives unit response to avg_signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : np.ndarray</span>
<span class="sd">            Optimal filter values, which need to be renormalized</span>
<span class="sd">        avg_signal : np.ndarray</span>
<span class="sd">            The signal to which filter `f` should give unit response</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">conv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fit_ctr</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fit_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">fit_ctr</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">fit_peak</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_filter</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Rescale single-lag filter `f` in-place so that it gives unit response to avg_signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : np.ndarray</span>
<span class="sd">            Optimal filter values, which need to be renormalized</span>
<span class="sd">        avg_signal : np.ndarray</span>
<span class="sd">            The signal to which filter `f` should give unit response</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_5lag">
<code class="highlight language-python"><span class="n">compute_5lag</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_5lag_noexp">
<code class="highlight language-python"><span class="n">compute_5lag_noexp</span><span class="p">(</span><span class="n">exp_time_seconds</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>exp_time_seconds</code></b>
                  (<code><span title="float">float</span></code>)
              
              <div class="doc-md-description">
<p>Generate a filter orthogonal to decaying exponentials of this time constant (must be positive)</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_5lag_noexp</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">exp_time_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp_time_seconds: float</span>
<span class="sd">        Generate a filter orthogonal to decaying exponentials of this time constant (must be positive)</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">exp_time_seconds</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_model</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">log_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">/</span> <span class="n">exp_time_seconds</span>
    <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_per_sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="n">cut_post</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_ats">
<code class="highlight language-python"><span class="n">compute_ats</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single "arrival-time-safe" filter, with optional low-pass filtering,
and with optional zero weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>An arrival-time-safe optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_ats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>  <span class="c1"># noqa: PLR0914</span>
<span class="w">    </span><span class="sd">"""Compute a single "arrival-time-safe" filter, with optional low-pass filtering,</span>
<span class="sd">    and with optional zero weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        An arrival-time-safe optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate ATS filters"</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have dt_model to generate ATS filters"</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>

    <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">dt_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avg_signal</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span> <span class="o">&gt;=</span> <span class="n">ns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cut_pre+cut_post = </span><span class="si">{</span><span class="n">cut_pre</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cut_post</span><span class="si">}</span><span class="s2"> but should be &lt; </span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">MT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">avg_signal</span><span class="p">,</span> <span class="n">dt_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ns</span><span class="p">)))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">WM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="p">(</span><span class="n">MT</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">WM</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">WM</span><span class="p">)</span>
        <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">WtWM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">WM</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">WtWM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ns</span>
        <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">ns</span><span class="p">]</span>
        <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">RinvM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">MT</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">MT</span><span class="p">,</span> <span class="n">RinvM</span><span class="p">)</span>
        <span class="n">Ainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ainv</span><span class="p">,</span> <span class="n">RinvM</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">band_limit</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nfilt</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">filt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)])</span>

    <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">filt_dt</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">filt_baseline</span> <span class="o">=</span> <span class="n">filt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_autocorr</span><span class="p">)</span>
    <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">FilterATS</span><span class="p">(</span>
        <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">vdv</span><span class="p">,</span> <span class="n">filt_dt</span><span class="p">,</span> <span class="n">filt_baseline</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">,</span> <span class="n">dt_model</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_constrained_5lag">
<code class="highlight language-python"><span class="n">compute_constrained_5lag</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero
weights at the pre-trigger or post-trigger end of the filter.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>constraints</code></b>
                  (<code><span title="numpy.typing.ArrayLike">ArrayLike</span> | None</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The vector or vectors to which the filter should be orthogonal. If a 2d array, each <em>row</em>
is a constraint, and the number of columns should be equal to the len(self.signal_model)
minus <code>(cut_pre+cut_post)</code>.</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_constrained_5lag</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single constrained optimal filter, with optional low-pass filtering, and with optional zero</span>
<span class="sd">    weights at the pre-trigger or post-trigger end of the filter.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    constraints: ndarray, optional</span>
<span class="sd">        The vector or vectors to which the filter should be orthogonal. If a 2d array, each _row_</span>
<span class="sd">        is a constraint, and the number of columns should be equal to the len(self.signal_model)</span>
<span class="sd">        minus `(cut_pre+cut_post)`.</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have a sample_time_sec if it's to be smoothed with fmax or f_3db"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_autocorr or whitener arguments to generate 5-lag filters"</span><span class="p">)</span>
    <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_autocorr</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># for 5-lag convolution</span>
    <span class="n">truncated_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">,</span> <span class="s2">"Noise autocorrelation vector is too short for signal size"</span>
    <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">truncated_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">truncated_signal</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pulse_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pulse_model</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span>

    <span class="n">noise_corr</span> <span class="o">=</span> <span class="n">noise_autocorr</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">TS</span> <span class="o">=</span> <span class="n">ToeplitzSolver</span><span class="p">(</span><span class="n">noise_corr</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Rinv_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">TS</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pulse_model</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">pulse_model</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rinv_model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">all_filters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Rinv_model</span><span class="p">)</span>
    <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">band_limit</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_noconst</span><span class="p">,</span> <span class="n">noise_corr</span><span class="p">)</span>

    <span class="c1"># Set weights in the cut_pre and cut_post windows to 0</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">filt_noconst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">),</span> <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cut_post</span><span class="p">)])</span>

    <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
        <span class="n">filt_noconst</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">vdv</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.FilterMaker.compute_fourier">
<code class="highlight language-python"><span class="n">compute_fourier</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Compute a single Fourier-domain filter, with optional low-pass filtering, and with optional
zero weights at the pre-trigger or post-trigger end of the filter. Fourier domain calculation
implicitly assumes periodic boundary conditions.</p>
<p>Either or both of <code>fmax</code> and <code>f_3db</code> are allowed.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The strict maximum frequency to be passed in all filters, by default None</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              
              <div class="doc-md-description">
<p>The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</p>
</div>
</li>
<li>
<b><code>cut_pre</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of initial samples to be given zero weight, by default 0</p>
</div>
</li>
<li>
<b><code>cut_post</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              
              <div class="doc-md-description">
<p>The number of samples at the end of a record to be given zero weight, by default 0</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="Filter


  
      dataclass
   (mass2.core.optimal_filtering.Filter)" href="#mass2.core.optimal_filtering.Filter">Filter</a></code>
              
              <div class="doc-md-description">
<p>A 5-lag optimal filter, computed in the Fourier domain.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>Under various conditions where arguments are inconsistent with the data</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_fourier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cut_pre</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Filter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a single Fourier-domain filter, with optional low-pass filtering, and with optional</span>
<span class="sd">    zero weights at the pre-trigger or post-trigger end of the filter. Fourier domain calculation</span>
<span class="sd">    implicitly assumes periodic boundary conditions.</span>

<span class="sd">    Either or both of `fmax` and `f_3db` are allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmax : Optional[float], optional</span>
<span class="sd">        The strict maximum frequency to be passed in all filters, by default None</span>
<span class="sd">    f_3db : Optional[float], optional</span>
<span class="sd">        The 3 dB point for a one-pole low-pass filter to be applied to all filters, by default None</span>
<span class="sd">    cut_pre : int</span>
<span class="sd">        The number of initial samples to be given zero weight, by default 0</span>
<span class="sd">    cut_post : int</span>
<span class="sd">        The number of samples at the end of a record to be given zero weight, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Filter</span>
<span class="sd">        A 5-lag optimal filter, computed in the Fourier domain.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Under various conditions where arguments are inconsistent with the data</span>
<span class="sd">    """</span>
    <span class="c1"># Make sure we have either a noise PSD or an autocorrelation or a whitener</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"FilterMaker must have noise_psd to generate a Fourier filter"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cut_pre</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cut_post</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(cut_pre,cut_post)=(</span><span class="si">{</span><span class="n">cut_pre</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cut_post</span><span class="si">}</span><span class="s2">), but neither can be negative"</span><span class="p">)</span>

    <span class="n">avg_signal</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_signal</span><span class="p">(</span><span class="n">cut_pre</span><span class="p">,</span> <span class="n">cut_post</span><span class="p">)</span>
    <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_psd</span><span class="p">)</span>

    <span class="c1"># Terminology: the `avg_signal` vector will be "shortened" by `shorten` _on each end.</span>
    <span class="c1"># That's to permit 5-lag filtering (where we step the filter by 2 lags either direction from 0 lag).</span>
    <span class="c1"># The `avg_signal` was already "reduced" in length by (cut_pre, cut_post), for a total</span>
    <span class="c1"># `reduction` of `2 * shorten + (cut_pre + cut_post)`.</span>
    <span class="n">shorten</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># to use in 5-lag style</span>
    <span class="n">reduction</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span> <span class="o">+</span> <span class="p">(</span><span class="n">cut_pre</span> <span class="o">+</span> <span class="n">cut_post</span><span class="p">)</span>

    <span class="n">truncated_avg_signal</span> <span class="o">=</span> <span class="n">avg_signal</span><span class="p">[</span><span class="n">shorten</span><span class="p">:</span><span class="o">-</span><span class="n">shorten</span><span class="p">]</span>
    <span class="n">len_reduced_psd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reduction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">window</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">sig_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">truncated_avg_signal</span> <span class="o">*</span> <span class="n">window</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len_reduced_psd</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"signal real DFT and noise PSD are not the same length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">len_reduced_psd</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

    <span class="c1"># Careful with PSD: "shorten" it by converting into a real space autocorrelation,</span>
    <span class="c1"># truncating the middle, and going back to Fourier space</span>
    <span class="k">if</span> <span class="n">reduction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span>
        <span class="n">noise_autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">noise_autocorr</span><span class="p">[:</span> <span class="n">len_reduced_psd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">noise_autocorr</span><span class="p">[</span><span class="o">-</span><span class="n">len_reduced_psd</span><span class="p">:]))</span>
        <span class="n">noise_psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">noise_autocorr</span><span class="p">))</span>
    <span class="n">sig_ft_weighted</span> <span class="o">=</span> <span class="n">sig_ft</span> <span class="o">/</span> <span class="n">noise_psd</span>

    <span class="c1"># Band-limit</span>
    <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f_nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_nyquist</span><span class="p">,</span> <span class="n">len_reduced_psd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig_ft_weighted</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">f_3db</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">sig_ft_weighted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">filt_fourier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">sig_ft_weighted</span><span class="p">)</span> <span class="o">/</span> <span class="n">window</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_5lag_filter</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">avg_signal</span><span class="p">)</span>

    <span class="c1"># How we compute the uncertainty depends on whether there's a noise autocorrelation result</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noise_ft_squared</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_psd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time_sec</span> <span class="o">*</span> <span class="n">noise_psd</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">noise_ft_squared</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">variance_fourier</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">kappa</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">noise_ft_squared</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_autocorr</span><span class="p">)[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">)]</span>
        <span class="n">variance_fourier</span> <span class="o">=</span> <span class="n">bracketR</span><span class="p">(</span><span class="n">filt_fourier</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>
    <span class="n">vdv</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_fourier</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">Filter5Lag</span><span class="p">(</span>
        <span class="n">filt_fourier</span><span class="p">,</span>
        <span class="n">peak</span><span class="p">,</span>
        <span class="n">variance_fourier</span><span class="p">,</span>
        <span class="n">vdv</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">truncated_avg_signal</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shorten</span><span class="p">,</span>
        <span class="n">fmax</span><span class="p">,</span>
        <span class="n">f_3db</span><span class="p">,</span>
        <span class="n">cut_pre</span><span class="p">,</span>
        <span class="n">cut_post</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-class">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener">
<code>ToeplitzWhitener</code>
<span class="doc doc-labels">
<small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
</span>
</h2>
<div class="doc doc-contents">
<p>An object that can perform approximate noise whitening.</p>
<p>For an ARMA(p,q) noise model, mutliply by (or solve) the matrix W (or its
transpose), where W is the Toeplitz approximation to the whitening matrix V.
A whitening matrix V means that if R is the ARMA noise covariance matrix,
then VRV' = I. While W only approximately satisfies this, it has some handy
properties that make it a useful replacement. (In particular, it has the
time-transpose property that if you zero-pad the beginning of vector v and
shift the remaining elements, then the same is done to Wv.)</p>
<p>The callable function object returns Wv or WM if called with
vector v or matrix M. Other methods:</p>
<ul>
<li><code>tw.whiten(v)</code> returns Wv; it is equivalent to <code>tw(v)</code></li>
<li><code>tw.solveWT(v)</code> returns inv(W')*v</li>
<li><code>tw.applyWT(v)</code> returns W'v</li>
<li><code>tw.solveW(v)</code> returns inv(W)*v</li>
</ul>
<details class="arguments" open="">
<summary>Arguments</summary>
<p>theta : np.ndarray
    The moving-average (MA) process coefficients
phi : np.ndarray
    The autoregressive (AR) process coefficients</p>
</details>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Returns:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><a class="autorefs autorefs-internal" title="ToeplitzWhitener


  
      dataclass
   (mass2.core.optimal_filtering.ToeplitzWhitener)" href="#mass2.core.optimal_filtering.ToeplitzWhitener">ToeplitzWhitener</a></code>
              
              <div class="doc-md-description">
<p>Object that can perform approximate, time-invariant noise whitening.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Raises:</th>
<td class="field-body">
<ul class="first simple">
<li>
<code><span title="ValueError">ValueError</span></code>
              
              <div class="doc-md-description">
<p>If the operative methods are passed an array of dimension higher than 2.</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToeplitzWhitener</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""An object that can perform approximate noise whitening.</span>

<span class="sd">    For an ARMA(p,q) noise model, mutliply by (or solve) the matrix W (or its</span>
<span class="sd">    transpose), where W is the Toeplitz approximation to the whitening matrix V.</span>
<span class="sd">    A whitening matrix V means that if R is the ARMA noise covariance matrix,</span>
<span class="sd">    then VRV' = I. While W only approximately satisfies this, it has some handy</span>
<span class="sd">    properties that make it a useful replacement. (In particular, it has the</span>
<span class="sd">    time-transpose property that if you zero-pad the beginning of vector v and</span>
<span class="sd">    shift the remaining elements, then the same is done to Wv.)</span>

<span class="sd">    The callable function object returns Wv or WM if called with</span>
<span class="sd">    vector v or matrix M. Other methods:</span>

<span class="sd">    * `tw.whiten(v)` returns Wv; it is equivalent to `tw(v)`</span>
<span class="sd">    * `tw.solveWT(v)` returns inv(W')*v</span>
<span class="sd">    * `tw.applyWT(v)` returns W'v</span>
<span class="sd">    * `tw.solveW(v)` returns inv(W)*v</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    theta : np.ndarray</span>
<span class="sd">        The moving-average (MA) process coefficients</span>
<span class="sd">    phi : np.ndarray</span>
<span class="sd">        The autoregressive (AR) process coefficients</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ToeplitzWhitener</span>
<span class="sd">        Object that can perform approximate, time-invariant noise whitening.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the operative methods are passed an array of dimension higher than 2.</span>
<span class="sd">    """</span>

    <span class="n">theta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">phi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be an array of dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">w</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">w</span>

        <span class="c1"># Multiply by the Toeplitz AR matrix to make the MA*w vector.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Second, solve the MA matrix (a banded, lower-triangular Toeplitz matrix with</span>
        <span class="c1"># q non-zero subdiagonals.)</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solveW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return unwhitened vector (or matrix of column vectors) inv(W)*v"</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveW</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="c1"># Multiply by the Toeplitz MA matrix to make the AR*w vector.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Second, solve the AR matrix (a banded, lower-triangular Toeplitz matrix with</span>
        <span class="c1"># p non-zero subdiagonals.)</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solveWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="s2">"Return vector (or matrix of column vectors) inv(W')*v"</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">applyWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return vector (or matrix of column vectors) W'v"""</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the full, approximate whitening matrix.</span>

<span class="sd">        Normally the full W is large and slow to use. But it's here so you can</span>
<span class="sd">        easily test that W(len(v))*v == whiten(v), and similar.</span>
<span class="sd">        """</span>
        <span class="n">AR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">MA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">AR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">MA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">MA</span><span class="p">,</span> <span class="n">AR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.W">
<code class="highlight language-python"><span class="n">W</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return the full, approximate whitening matrix.</p>
<p>Normally the full W is large and slow to use. But it's here so you can
easily test that W(len(v))*v == whiten(v), and similar.</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the full, approximate whitening matrix.</span>

<span class="sd">    Normally the full W is large and slow to use. But it's here so you can</span>
<span class="sd">    easily test that W(len(v))*v == whiten(v), and similar.</span>
<span class="sd">    """</span>
    <span class="n">AR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">MA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">AR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">MA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">MA</span><span class="p">,</span> <span class="n">AR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.__call__">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return whitened vector (or matrix of column vectors) Wv</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be an array of dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">w</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">w</span>

    <span class="c1"># Multiply by the Toeplitz AR matrix to make the MA*w vector.</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Second, solve the MA matrix (a banded, lower-triangular Toeplitz matrix with</span>
    <span class="c1"># q non-zero subdiagonals.)</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.applyWT">
<code class="highlight language-python"><span class="n">applyWT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return vector (or matrix of column vectors) W'v</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">applyWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return vector (or matrix of column vectors) W'v"""</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="p">:]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.solveW">
<code class="highlight language-python"><span class="n">solveW</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return unwhitened vector (or matrix of column vectors) inv(W)*v</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solveW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return unwhitened vector (or matrix of column vectors) inv(W)*v"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveW</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="c1"># Multiply by the Toeplitz MA matrix to make the AR*w vector.</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Second, solve the AR matrix (a banded, lower-triangular Toeplitz matrix with</span>
    <span class="c1"># p non-zero subdiagonals.)</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.solveWT">
<code class="highlight language-python"><span class="n">solveWT</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return vector (or matrix of column vectors) inv(W')*v</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solveWT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return vector (or matrix of column vectors) inv(W')*v"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"v must be dimension 1 or 2"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveWT</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">f</span><span class="p">])</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="p">:]</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="mass2.core.optimal_filtering.ToeplitzWhitener.whiten">
<code class="highlight language-python"><span class="n">whiten</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>
</h3>
<div class="doc doc-contents">
<p>Return whitened vector (or matrix of column vectors) Wv</p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="s2">"Return whitened vector (or matrix of column vectors) Wv"</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.band_limit">
<code class="highlight language-python"><span class="n">band_limit</span><span class="p">(</span><span class="n">modelmatrix</span><span class="p">,</span> <span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Band-limit the column-vectors in a model matrix with a hard and/or
1-pole low-pass filter. Change the input <code>modelmatrix</code> in-place.</p>
<p>No effect if both <code>fmax</code> and <code>f_3db</code> are <code>None</code>.</p>
<table class="field-list">
<colgroup>
<col class="field-name"/>
<col class="field-body"/>
</colgroup>
<tbody valign="top">
<tr class="field">
<th class="field-name">Parameters:</th>
<td class="field-body">
<ul class="first simple">
<li>
<b><code>modelmatrix</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              
              <div class="doc-md-description">
<p>The 1D or 2D array to band-limit. (If a 2D array, columns are independently band-limited.)</p>
</div>
</li>
<li>
<b><code>sample_time_sec</code></b>
                  (<code><span title="float">float</span></code>)
              
              <div class="doc-md-description">
<p>The sampling period, normally in seconds.</p>
</div>
</li>
<li>
<b><code>fmax</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>)
              
              <div class="doc-md-description">
<p>The hard maximum frequency (units are inverse of <code>sample_time_sec</code> units, or Hz)</p>
</div>
</li>
<li>
<b><code>f_3db</code></b>
                  (<code><span title="Optional">Optional</span>[<span title="float">float</span>]</code>)
              
              <div class="doc-md-description">
<p>The 1-pole low-pass filter's 3 dB point (same units as <code>fmax</code>)</p>
</div>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">band_limit</span><span class="p">(</span><span class="n">modelmatrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sample_time_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Band-limit the column-vectors in a model matrix with a hard and/or</span>
<span class="sd">    1-pole low-pass filter. Change the input `modelmatrix` in-place.</span>

<span class="sd">    No effect if both `fmax` and `f_3db` are `None`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    modelmatrix : np.ndarray</span>
<span class="sd">        The 1D or 2D array to band-limit. (If a 2D array, columns are independently band-limited.)</span>
<span class="sd">    sample_time_sec : float</span>
<span class="sd">        The sampling period, normally in seconds.</span>
<span class="sd">    fmax : Optional[float]</span>
<span class="sd">        The hard maximum frequency (units are inverse of `sample_time_sec` units, or Hz)</span>
<span class="sd">    f_3db : Optional[float]</span>
<span class="sd">        The 1-pole low-pass filter's 3 dB point (same units as `fmax`)</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Handle the 2D case by calling this function once per column.</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">modelmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">band_limit</span><span class="p">(</span><span class="n">modelmatrix</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">sample_time_sec</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">f_3db</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">vector</span> <span class="o">=</span> <span class="n">modelmatrix</span>
    <span class="n">filt_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">sig_ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">filt_length</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">sample_time_sec</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_ft</span><span class="p">[</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">fmax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">f_3db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sig_ft</span> <span class="o">/=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">freq</span> <span class="o">/</span> <span class="n">f_3db</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># n=filt_length is needed when filt_length is ODD</span>
    <span class="n">vector</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">sig_ft</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">filt_length</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h2 class="doc doc-heading" id="mass2.core.optimal_filtering.bracketR">
<code class="highlight language-python"><span class="n">bracketR</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span></code>
</h2>
<div class="doc doc-contents">
<p>Return the dot product (q^T R q) for vector <q> and matrix R constructed from
the vector <noise> by R_ij = noise_|i-j|.  We don't want to construct the full matrix
R because for records as long as 10,000 samples, the matrix will consist of 10^8 floats
(800 MB of memory).</noise></q></p>
<details class="quote">
<summary>Source code in <code>mass2/core/optimal_filtering.py</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bracketR</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the dot product (q^T R q) for vector &lt;q&gt; and matrix R constructed from</span>
<span class="sd">    the vector &lt;noise&gt; by R_ij = noise_|i-j|.  We don't want to construct the full matrix</span>
<span class="sd">    R because for records as long as 10,000 samples, the matrix will consist of 10^8 floats</span>
<span class="sd">    (800 MB of memory).</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Vector q (length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">) cannot be longer than the noise (length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">::</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">dot</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">dot</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dot</span>
</code></pre></div></td></tr></table></div>
</details>
</div>
</div>
</div>
</div>
</div><h2 id="hci-lines">HCI lines</h2>
<!-- ::: mass2.calibration:hci_models -->
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../LJHfiles/" class="btn btn-neutral float-left" title="LJH file format"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../tests/" class="btn btn-neutral float-right" title="Testing">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../LJHfiles/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../tests/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
